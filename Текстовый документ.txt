
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton, ReplyKeyboardMarkup, KeyboardButton, LabeledPrice, ReplyKeyboardRemove
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ConversationHandler, CallbackQueryHandler, ContextTypes,  ApplicationBuilder, PreCheckoutQueryHandler, MessageHandler
import sqlite3
import logging
from num2words import num2words
from datetime import datetime, timedelta
from telegram.ext import JobQueue
import google.generativeai as genai
from PIL import Image, ImageDraw, ImageFont
from passport_recognition_gemini import setup_gemini_api, parse_custom_deal_with_gemini, get_buyout_plans_with_gemini
from datetime import datetime
import pytz # <-- –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç
from expense_reporter import generate_expense_report
from database_manager import db_execute, db_fetch_one, db_fetch_all, db_execute_lastrowid
AWAIT_CLIENT_SIGNATURE = range(1)
# –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–∏ –¥–≤–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫ –≤–∞—à–µ–º—É —Å–ø–∏—Å–∫—É
AWAIT_BATTERY_COUNT, AWAIT_BATTERY_NUMS = range(600, 602)
from telegram.helpers import escape_markdown
from google.generativeai.types import HarmCategory, HarmBlockThreshold
import os
TEST_MODE = False# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è üìù
# –ó–∞–º–µ–Ω–∏—Ç–µ —Å—Ç–∞—Ä—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏–π –Ω–∞ —ç—Ç–æ—Ç, –±–æ–ª–µ–µ –ø–æ–ª–Ω—ã–π
# –í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –±–ª–æ–∫ –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞ –≤–º–µ—Å—Ç–æ –≤—Å–µ—Ö —Å—Ç–∞—Ä—ã—Ö –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π
(
    # –í–µ—Ç–∫–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –∞—Ä–µ–Ω–¥—ã
    AWAIT_BIKE_NUMBER_RENT,         # 500: –û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è –∞—Ä–µ–Ω–¥—ã
    AWAIT_BATTERY_COUNT,            # 501: –û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–ª-–≤–∞ –±–∞—Ç–∞—Ä–µ–π
    AWAIT_BATTERY_NUMS,             # 502: –û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–æ–≤ –±–∞—Ç–∞—Ä–µ–π

    # –í–µ—Ç–∫–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –≤—ã–∫—É–ø–∞
    AWAIT_BIKE_NUMBER_BUYOUT,       # 503: –û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è –≤—ã–∫—É–ø–∞

    # –í–µ—Ç–∫–∞ –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å–¥–µ–ª–∫–∏
    AWAIT_CUSTOM_DESC,              # 504: –û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –∫–æ–º–ø–ª–µ–∫—Ç–∞
    AWAIT_CUSTOM_RENT_PRICE,        # 505: –û–∂–∏–¥–∞–Ω–∏–µ —Ü–µ–Ω—ã –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –∞—Ä–µ–Ω–¥—ã
    AWAIT_CUSTOM_BUYOUT_PLAN,       # 506: –û–∂–∏–¥–∞–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –ø–ª–∞–Ω–∞ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –≤—ã–∫—É–ø–∞
    AWAIT_CUSTOM_CONFIRM,           # 507: –û–∂–∏–¥–∞–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å–¥–µ–ª–∫–∏
) = range(500, 508)

(EXP_SELECT_CATEGORY, EXP_SELECT_SUBCATEGORY, EXP_AWAIT_AMOUNT,
 EXP_AWAIT_ITEM_NAME, EXP_AWAIT_QUANTITY, EXP_AWAIT_COMMENT) = range(1000, 1006)

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞
AWAIT_EXPENSE_REPORT_DATES = range(1006, 1007)

# –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å –¥–ª—è –º–µ–Ω—é —Ä–∞—Å—Ö–æ–¥–æ–≤
EXPENSE_CATEGORIES = {
    'fixed': {
        'label': 'üè¢ –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã',
        'subcategories': {
            'rent': '–ê—Ä–µ–Ω–¥–∞ –ø–æ–º–µ—â–µ–Ω–∏—è',
            'salary': '–ó–∞—Ä–ø–ª–∞—Ç–∞',
            'taxes': '–ù–∞–ª–æ–≥–∏',
            'bot_maint': '–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –±–æ—Ç–∞',
            'gps_sub': '–ê–±–æ–Ω–µ–Ω—Ç–∫–∞ GPS',  # <-- –í–û–¢ –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê
            'other': {'label': '–î—Ä—É–≥–æ–µ', 'is_complex': True}
        }
    },
    'variable': {
        'label': 'üöö –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã',
        'subcategories': {
            'repair': '–†–µ–º–æ–Ω—Ç (–≤–Ω–µ—à–Ω–∏–π)', 'cleaning': '–ú–æ–π–∫–∞', 'ads': '–†–µ–∫–ª–∞–º–∞', 'taxi': '–¢–∞–∫—Å–∏/–õ–æ–≥–∏—Å—Ç–∏–∫–∞',
            'branding': '–ë—Ä–µ–Ω–¥–∏–Ω–≥', 'misc': '–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã',
            'other': {'label': '–î—Ä—É–≥–æ–µ', 'is_complex': True} # <-- –î–û–ë–ê–í–õ–ï–ù–û
        }
    },
    'inventory': {
        'label': 'üî© –ó–∞–∫—É–ø–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è',
        'subcategories': {
            'parts': {'label': '–ó–∞–ø—á–∞—Å—Ç–∏', 'is_complex': True},
            'accessories': {'label': '–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã', 'is_complex': True},
            'other': {'label': '–î—Ä—É–≥–æ–µ', 'is_complex': True} # <-- –î–û–ë–ê–í–õ–ï–ù–û
        }
    },
    'capital': {
        'label': 'üö≤ –ö—Ä—É–ø–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏',
        'subcategories': {
            'bike': '–í–µ–ª–æ—Å–∏–ø–µ–¥', 'battery': '–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä—ã', 'tracker': '–¢—Ä–µ–∫–µ—Ä—ã',
            'other': {'label': '–î—Ä—É–≥–æ–µ', 'is_complex': True} # <-- –î–û–ë–ê–í–õ–ï–ù–û
        }
    }
}
GEMINI_API_URL = "https://gemini-npxg.onrender.com"
DEAL_ENTER_BUYOUT_DESC = range(209, 210) # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
GEMINI_API_KEY = "AIzaSyAUay_xvRT_gcMYs3-7i8Pcli680Or5Zwk   "
from yookassa import Configuration, Payment
import uuid # –î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
SELECTING_DATE, SELECTING_TIME, CONFIRMING_BOOKING = range(3, 6) # –ù–∞—á–∏–Ω–∞–µ–º —Å 3, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞—Ç—å—Å—è —Å –¥—Ä—É–≥–∏–º–∏
# –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫ –≤–∞—à–µ–º—É —Å–ø–∏—Å–∫—É
CUSTOM_EXTENSION_DAYS, AWAIT_CUSTOM_PRICE = range(100, 102)
USER_AWAIT_CUSTOM_DAYS = range(300, 301) # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª—å—à–æ–µ —á–∏—Å–ª–æ, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞—Ç—å—Å—è —Å –¥—Ä—É–≥–∏–º–∏
# ...
# –í–ê–®–ò –ö–õ–Æ–ß–ò –ò–ó –õ–ò–ß–ù–û–ì–û –ö–ê–ë–ò–ù–ï–¢–ê –ÆKASSA
YOOKASSA_SHOP_ID = "1095349"      # –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à shopId
YOOKASSA_SECRET_KEY = "live_jv9Fmr_2NGwri_EE4std8wgRb_dURL0bwtYrqhal3M0" # –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á
# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SDK –ÆKassa
Configuration.account_id = YOOKASSA_SHOP_ID
Configuration.secret_key = YOOKASSA_SECRET_KEY
import os
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è üìù
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

# --- –ê–î–ê–ü–¢–ê–¶–ò–Ø –ü–£–¢–ï–ô –î–õ–Ø RAILWAY ---
VOLUME_PATH = os.environ.get('RAILWAY_VOLUME_MOUNT_PATH', '.')
DB_FILE = os.path.join(VOLUME_PATH, 'bikes.db')
PERSISTENCE_PATH = os.path.join(VOLUME_PATH, 'bot_persistence')
USER_PROFILES_PATH = os.path.join(VOLUME_PATH, 'user_profiles')
REPORTS_PATH = os.path.join(VOLUME_PATH, 'reports')
DOCUMENTS_PATH = os.path.join(VOLUME_PATH, 'user_documents') # <-- –î–æ–±–∞–≤–∏–ª –ø—É—Ç—å –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

# –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
os.makedirs(os.path.dirname(DB_FILE), exist_ok=True)
os.makedirs(os.path.dirname(PERSISTENCE_PATH), exist_ok=True)
os.makedirs(USER_PROFILES_PATH, exist_ok=True)
os.makedirs(REPORTS_PATH, exist_ok=True)
os.makedirs(DOCUMENTS_PATH, exist_ok=True) # <-- –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
# –°–ø–∏—Å–æ–∫ ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ üë®‚Äçüíº
ADMIN_IDS = [752012766, 7999671823]  # –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
MASTER_IDS = [752012766]
RENTAL_PRICES = {
    14: 6500,  # 2 –Ω–µ–¥–µ–ª–∏ = 6500 —Ä—É–±.
    30: 12600  # 30 –¥–Ω–µ–π = 15000 —Ä—É–±. (–∫–∞–∫ 4 –Ω–µ–¥–µ–ª–∏ –ø–æ —Å—Ç–∞—Ä–æ–º—É —Ç–∞—Ä–∏—Ñ—É)
}
SELECT_BUYOUT_PLAN, CONFIRM_BUYOUT = range(2)
# ### –ù–û–í–ê–Ø –ü–†–ê–í–ö–ê ### –¢–∞—Ä–∏—Ñ—ã –Ω–∞ –≤—ã–∫—É–ø
# ### –ù–û–í–ê–Ø, –£–õ–£–ß–®–ï–ù–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –¢–ê–†–ò–§–û–í ###
# short_label - –¥–ª—è –∫–Ω–æ–ø–æ–∫, full_label - –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
# ### –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ù–æ–≤–∞—è —Ç–∞—Ä–∏—Ñ–Ω–∞—è —Å–µ—Ç–∫–∞ –¥–ª—è –≤—ã–∫—É–ø–∞ ###
# ### –ù–û–í–ê–Ø, –£–õ–£–ß–®–ï–ù–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –¢–ê–†–ò–§–û–í ###
# short_label - –¥–ª—è –∫–Ω–æ–ø–æ–∫, full_label - –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
# –í–°–¢–ê–í–¨–¢–ï –≠–¢–û–¢ –ö–û–î –í –ë–õ–û–ö –° –ö–û–ù–°–¢–ê–ù–¢–ê–ú–ò

# --- –ù–û–í–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ –î–õ–Ø –¢–ò–ü–û–í –ü–†–û–î–£–ö–¢–û–í ---
# --- –°–¢–ê–†–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ (–æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
PRODUCT_TYPE_BIKE = 'bike'
PRODUCT_TYPE_BATTERY = 'battery'

# –®–ê–ì 1: –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–ò–¢–ï –°–¢–ê–†–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ –ù–ê –≠–¢–ò

# –¢–∞—Ä–∏—Ñ—ã –Ω–∞ –ê–†–ï–ù–î–£ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–Ω—ã–µ —Å—Ä–æ–∫–∏)
RENTAL_PRICES = {
    # –¶–µ–Ω—ã –∑–∞ –Ω–µ–¥–µ–ª—é (7 –¥–Ω–µ–π)
    'kugoo_jl_7': 3500,      # <-- –ö–ª—é—á –¥–ª—è Kugoo (–ø–æ 'JL' –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏)
    'liming_esm_7': 3500,    # <-- –ö–ª—é—á –¥–ª—è Liming (–ø–æ 'ESM' –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏)
    'kugoo_2akb_7': 4500,
    'wenbox_7': 5000,
    'akb_7': 1000,

    # –¶–µ–Ω—ã –∑–∞ 2 –Ω–µ–¥–µ–ª–∏ (14 –¥–Ω–µ–π)
    'kugoo_jl_14': 7000,
    'liming_esm_14': 7000,
    'kugoo_2akb_14': 9000,
    'wenbox_14': 10000,

    # –¶–µ–Ω—ã –∑–∞ 30 –¥–Ω–µ–π
    'kugoo_jl_30': 13000,
    'liming_esm_30': 13000,
    'kugoo_2akb_30': 15000,
    'wenbox_30': 19000,
}

# –¢–∞—Ä–∏—Ñ—ã –Ω–∞ –í–´–ö–£–ü
BUYOUT_PLANS = {
    'kugoo_jl_buyout': {      # <-- –ö–ª—é—á –¥–ª—è Kugoo
        "short_label": "15 –Ω–µ–¥. / 5000 ‚ÇΩ",
        "full_label": "Kugoo (JL): 15 –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ 5 000 ‚ÇΩ (—Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é)",
        "first_payment": 5000,
        "total_payments": 15,
        "period_days": 7
    },
    'liming_esm_buyout': {    # <-- –ö–ª—é—á –¥–ª—è Liming
        "short_label": "15 –Ω–µ–¥. / 5000 ‚ÇΩ",
        "full_label": "Liming (ESM): 15 –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ 5 000 ‚ÇΩ (—Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é)",
        "first_payment": 5000,
        "total_payments": 15,
        "period_days": 7
    },
    'kugoo_2akb_buyout': {
        "short_label": "15 –Ω–µ–¥. / 6000 ‚ÇΩ",
        "full_label": "Kugoo 2–ê–ö–ë: 15 –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ 6 000 ‚ÇΩ (—Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é)",
        "first_payment": 6000,
        "total_payments": 15,
        "period_days": 7
    },
    'wenbox_buyout': {
        "short_label": "20 –Ω–µ–¥. / 6000 ‚ÇΩ",
        "full_label": "Wenbox U3: 20 –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ 6 000 ‚ÇΩ (—Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é)",
        "first_payment": 6000,
        "total_payments": 20,
        "period_days": 7
    },
}

# –¢–∞—Ä–∏—Ñ—ã –Ω–∞ –ê–†–ï–ù–î–£ –ê–ö–ë
BATTERY_RENTAL_PRICES = {
    '60V21Ah': {
        'initial_months': 2,
        'initial_price': 3300 * 2,
        'monthly_price': 3300
    },
    '60V30Ah': {
        'initial_months': 2,
        'initial_price': 4500 * 2,
        'monthly_price': 4500
    }
}

# –¢–∞—Ä–∏—Ñ—ã –Ω–∞ –í–´–ö–£–ü (—Ä–∞—Å—Å—Ä–æ—á–∫—É) –ê–ö–ë
BATTERY_BUYOUT_PLANS = {
    '60V21Ah': {
        'initial_payment': 7000,
        'plans': {
            '1m_biweekly': {"label": "1 –º–µ—Å (2 –ø–ª. –ø–æ 6500—Ä)", "payment": 6500, "count": 2, "period_days": 14},
            '2m_monthly':  {"label": "2 –º–µ—Å (2 –ø–ª. –ø–æ 7300—Ä)", "payment": 7300, "count": 2, "period_days": 30},
            '3m_monthly':  {"label": "3 –º–µ—Å (3 –ø–ª. –ø–æ 5300—Ä)", "payment": 5300, "count": 3, "period_days": 30},
            '4m_monthly':  {"label": "4 –º–µ—Å (4 –ø–ª. –ø–æ 4300—Ä)", "payment": 4300, "count": 4, "period_days": 30},
            '5m_monthly':  {"label": "5 –º–µ—Å (5 –ø–ª. –ø–æ 3800—Ä)", "payment": 3800, "count": 5, "period_days": 30},
        }
    },
    '60V30Ah': {
        'initial_payment': 10000,
        'plans': {
            '1m_biweekly': {"label": "1 –º–µ—Å (2 –ø–ª. –ø–æ 8500—Ä)", "payment": 8500, "count": 2, "period_days": 14},
            '2m_monthly':  {"label": "2 –º–µ—Å (2 –ø–ª. –ø–æ 9500—Ä)", "payment": 9500, "count": 2, "period_days": 30},
            '3m_monthly':  {"label": "3 –º–µ—Å (3 –ø–ª. –ø–æ 7000—Ä)", "payment": 7000, "count": 3, "period_days": 30},
            '4m_monthly':  {"label": "4 –º–µ—Å (4 –ø–ª. –ø–æ 5500—Ä)", "payment": 5500, "count": 4, "period_days": 30},
            '5m_monthly':  {"label": "5 –º–µ—Å (5 –ø–ª. –ø–æ 4900—Ä)", "payment": 4900, "count": 5, "period_days": 30},
        }
    }
}
API_TOKEN = '7393557373:AAFB6NTTd551raYDASM7d1XhvP9wAFlVmpY'
PROVIDER_TOKEN = '381764678:TEST:128374'
SHOP_ID = '357190'  # –í–∞—à shop_id
CURRENCY = "RUB"
logging.basicConfig(level=logging.INFO)

class Config:
    def __init__(self, shop_id):
        self.provider_token = PROVIDER_TOKEN  # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ PROVIDER_TOKEN –æ–±—ä—è–≤–ª—ë–Ω
        self.shop_id = shop_id
try:
    if GEMINI_API_KEY:
        setup_gemini_api(GEMINI_API_KEY)
        logger.info("Gemini API —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞.")
    else:
        logger.critical("–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: GEMINI_API_KEY –Ω–µ —É–∫–∞–∑–∞–Ω.")
except Exception as e:
    logger.critical(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ Gemini API: {e}.")
# –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
config = Config(SHOP_ID)  # –ü–µ—Ä–µ–¥–∞–π—Ç–µ –≤–∞—à –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –º–∞–≥–∞–∑–∏–Ω–∞

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö üìö
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö üìö
def setup_database():
    try:
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()

        # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∑–∞–ø—á–∞—Å—Ç–µ–π
        cursor.execute('''CREATE TABLE IF NOT EXISTS parts (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        name TEXT,
                        description TEXT,
                        quantity REAL,
                        available INTEGER DEFAULT 1,
                        photo_url TEXT)''')
        cursor.execute('''CREATE TABLE IF NOT EXISTS discounts (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                admin_id INTEGER NOT NULL,
                percentage INTEGER NOT NULL,
                reason TEXT,
                expiry_date TEXT NOT NULL,
                is_used INTEGER DEFAULT 0, -- 0 = –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞, 1 = –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞
                created_at TEXT DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (user_id) REFERENCES users(id),
                FOREIGN KEY (admin_id) REFERENCES users(id)
                )''')

        # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤
        cursor.execute('''CREATE TABLE IF NOT EXISTS bikes (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    name TEXT,
                    description TEXT,
                    price REAL,
                    available INTEGER DEFAULT 1,
                    photo_url TEXT,
                    repair_status TEXT,
                    repair_reason TEXT,
                    repair_date TEXT,
                    reserved_date TEXT DEFAULT NULL,
                    reserved_by INTEGER DEFAULT NULL)''')

        # ### –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø ### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∫–æ–ª–æ–Ω–∫–æ–π is_new_user
        cursor.execute('''CREATE TABLE IF NOT EXISTS users (
         id INTEGER PRIMARY KEY,
         username TEXT,
         first_name TEXT,
         last_name TEXT,
         tg_username TEXT,
         phone_number TEXT,
         delivery_service TEXT,
         courier_app_screenshot TEXT,
         payment_plan TEXT,
         rental_period TEXT,
         experience TEXT,
         storage TEXT,
         passport_photo TEXT,
         source_of_info TEXT,
         verified INTEGER DEFAULT 0,
         is_new_user INTEGER DEFAULT 1,
         last_booking_date TEXT DEFAULT NULL,
         country TEXT,
         passport_data TEXT,  -- <--- –í–û–¢ –ó–î–ï–°–¨ –ù–£–ñ–ù–ê –ó–ê–ü–Ø–¢–ê–Ø
         last_booking_date TEXT DEFAULT NULL
)''')

        # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
        cursor.execute('''CREATE TABLE IF NOT EXISTS bookings (
                            id INTEGER PRIMARY KEY AUTOINCREMENT,
                            user_id INTEGER,
                            bike_id INTEGER,
                            booking_date TEXT,
                            end_date TEXT DEFAULT NULL,
                            status TEXT DEFAULT "pending",
                            booking_type TEXT DEFAULT "rent",
                            payment_plan_key TEXT,
                            payments_made INTEGER DEFAULT 0,
                            next_payment_date TEXT,
                            FOREIGN KEY(user_id) REFERENCES users(id),
                            FOREIGN KEY(bike_id) REFERENCES bikes(id))''')

        # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤
        cursor.execute('''CREATE TABLE IF NOT EXISTS questions (
                           id INTEGER PRIMARY KEY AUTOINCREMENT,
                           user_id INTEGER,
                           username TEXT,
                           question TEXT,
                           answer TEXT DEFAULT NULL,
                           FOREIGN KEY(user_id) REFERENCES users(id))''')

        cursor.execute('''CREATE TABLE IF NOT EXISTS notifications (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    message TEXT,
                    timestamp TEXT NOT NULL,
                    created_at TEXT DEFAULT CURRENT_TIMESTAMP)''')

        cursor.execute('''CREATE TABLE IF NOT EXISTS attendance (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id INTEGER,
                    timestamp TEXT,
                    status TEXT,
                    latitude REAL,
                    longitude REAL,
                    FOREIGN KEY(user_id) REFERENCES users(id))''')

        cursor.execute('''CREATE TABLE IF NOT EXISTS bike_history (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    bike_id INTEGER,
                    user_id INTEGER,
                    action TEXT,
                    timestamp TEXT,
                    details TEXT,
                    FOREIGN KEY(bike_id) REFERENCES bikes(id),
                    FOREIGN KEY(user_id) REFERENCES users(id))''')

        # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∑–∞—è–≤–æ–∫ –Ω–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ
        cursor.execute('''CREATE TABLE IF NOT EXISTS extension_requests (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    booking_id INTEGER,
                    photo TEXT,
                    created_at TEXT DEFAULT CURRENT_TIMESTAMP,
                    status TEXT DEFAULT NULL,
                    FOREIGN KEY(booking_id) REFERENCES bookings(id))''')

        cursor.execute('''CREATE TABLE IF NOT EXISTS queue (
                          id INTEGER PRIMARY KEY AUTOINCREMENT,
                          user_id INTEGER,
                          bike_id INTEGER,
                          queue INTEGER,
                          created_at TEXT DEFAULT CURRENT_TIMESTAMP,
                          status TEXT DEFAULT "pending",
                          FOREIGN KEY(user_id) REFERENCES users(id))''')

        cursor.execute('''
            CREATE TABLE IF NOT EXISTS repair_requests (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                bike_id INTEGER,
                description TEXT,
                status TEXT DEFAULT "ozhidaet",
                created_at TEXT DEFAULT CURRENT_TIMESTAMP,
                estimated_time TEXT DEFAULT NULL,
                estimated_price TEXT DEFAULT NULL,
                completed_at TEXT DEFAULT NULL,
                is_warranty INTEGER,
                delay_reason TEXT,
                left_at TEXT,
                expected_completion_date TEXT,
                FOREIGN KEY(user_id) REFERENCES users(id),
                FOREIGN KEY(bike_id) REFERENCES bikes(id)
            )''')

        cursor.execute('''
            CREATE TABLE IF NOT EXISTS repair_logs (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                bike_id INTEGER,
                repair_start_date TEXT,
                repair_end_date TEXT,
                repair_person TEXT,
                reason TEXT,
                is_warranty INTEGER,
                warranty_amount REAL,
                estimated_completion_date TEXT,
                delay_reason TEXT,
                FOREIGN KEY (bike_id) REFERENCES bikes(id)
            )''')

        cursor.execute('''
            CREATE TABLE IF NOT EXISTS fines (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER NOT NULL,
                admin_id INTEGER NOT NULL,
                amount REAL NOT NULL,
                reason TEXT NOT NULL,
                status TEXT CHECK(status IN ('unpaid', 'paid', 'disputed', 'cancelled')) DEFAULT 'unpaid',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                due_date TEXT,
                payment_date TEXT,
                dispute_photo TEXT,
                dispute_video TEXT,
                dispute_comment TEXT,
                dispute_status TEXT CHECK(dispute_status IN ('none', 'pending', 'approved', 'rejected')) DEFAULT 'none',
                FOREIGN KEY (user_id) REFERENCES users(id),
                FOREIGN KEY (admin_id) REFERENCES users(id)
            )''')

        # –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_user_id ON bookings (user_id);")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_bike_id ON bookings (bike_id);")
        cursor.execute("CREATE INDEX IF NOT EXISTS idx_username ON questions (username);")

        conn.commit()
        logger.info("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞.")
    except sqlite3.Error as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
    finally:
        if conn:
            conn.close()

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º üèÖ
def is_admin(user_id: int) -> bool:
    return user_id in ADMIN_IDS
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup
from telegram.ext import (
    ContextTypes,
    ConversationHandler,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    filters,
)
from datetime import datetime, timedelta
import sqlite3
import logging
(
    BEXP_AWAIT_BIKE_NAME,
    BEXP_AWAIT_EXPENSE_NAME,
    BEXP_AWAIT_AMOUNT,
    BEXP_AWAIT_COMMENT
) = range(1100, 1104)
# === –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê ===


async def start_bike_specific_expense(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 1 (–¥–ª—è –≤–µ–ª–∏–∫–∞): –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ/–Ω–æ–º–µ—Ä –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞."""
    query = update.callback_query
    await query.answer()
    await query.edit_message_text("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –Ω–æ–º–µ—Ä –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ú–æ–Ω—Å—Ç—Ä 312123213'):")
    return BEXP_AWAIT_BIKE_NAME

async def get_bike_name_for_expense(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 2 (–¥–ª—è –≤–µ–ª–∏–∫–∞): –ü–æ–ª—É—á–∞–µ—Ç –∏–º—è, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥."""
    context.user_data['bike_expense_bike_name'] = update.message.text
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ó–∞–º–µ–Ω–∞ —Ç–æ—Ä–º–æ–∑–æ–≤'):")
    return BEXP_AWAIT_EXPENSE_NAME

async def get_expense_name_for_bike(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 3 (–¥–ª—è –≤–µ–ª–∏–∫–∞): –ü–æ–ª—É—á–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å—É–º–º—É."""
    context.user_data['bike_expense_name'] = update.message.text
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Ä–∞—Å—Ö–æ–¥–∞ –≤ —Ä—É–±–ª—è—Ö:")
    return BEXP_AWAIT_AMOUNT

async def get_amount_for_bike_expense(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 4 (–¥–ª—è –≤–µ–ª–∏–∫–∞): –ü–æ–ª—É—á–∞–µ—Ç —Å—É–º–º—É, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π."""
    try:
        amount = float(update.message.text.replace(',', '.'))
        if amount <= 0: raise ValueError
        context.user_data['bike_expense_amount'] = amount
        keyboard = [[InlineKeyboardButton("–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å", callback_data="bexp_skip_comment")]]
        await update.message.reply_text(
            "–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –¥–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π. –ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å'.",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        return BEXP_AWAIT_COMMENT
    except ValueError:
        await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ).")
        return BEXP_AWAIT_AMOUNT

async def save_bike_specific_expense(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–§–∏–Ω–∞–ª—å–Ω—ã–π —à–∞–≥: –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –≤–º–µ—Å—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î, –Ω–µ –º–µ–Ω—è—è –µ—ë —Å—Ç—Ä—É–∫—Ç—É—Ä—É."""
    user_comment = update.message.text if update.message else ""
    data = context.user_data
    
    # --- –ì–õ–ê–í–ù–´–ô –§–û–ö–£–°: –ü–∏—Ö–∞–µ–º –∏–º—è –≤–µ–ª–∏–∫–∞ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ---
    final_comment = f"–í–µ–ª–æ—Å–∏–ø–µ–¥: {data['bike_expense_bike_name']}. {user_comment}".strip()

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ç–∞–±–ª–∏—Ü—É, –∏—Å–ø–æ–ª—å–∑—É—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            await conn.execute(
                """INSERT INTO expenses (admin_id, category, subcategory, item_name, amount, comment)
                   VALUES (?, ?, ?, ?, ?, ?)""",
                (
                    update.effective_user.id,
                    'variable',  # –õ–æ–≥–∏—á–Ω–æ, —á—Ç–æ —Ä–∞—Å—Ö–æ–¥ –Ω–∞ –≤–µ–ª–∏–∫ - –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–π
                    'repair',    # –ß–∞—â–µ –≤—Å–µ–≥–æ —ç—Ç–æ —Ä–µ–º–æ–Ω—Ç –∏–ª–∏ –∑–∞–ø—á–∞—Å—Ç–∏
                    data['bike_expense_name'],
                    data['bike_expense_amount'],
                    final_comment # –ó–¥–µ—Å—å –∏ –∏–º—è –≤–µ–ª–∏–∫–∞, –∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç –∞–¥–º–∏–Ω–∞
                )
            )
            await conn.commit()
        
        final_message = f"‚úÖ –†–∞—Å—Ö–æ–¥ –Ω–∞ —Å—É–º–º—É {data['bike_expense_amount']} ‚ÇΩ –¥–ª—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ '{data['bike_expense_bike_name']}' —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω!"
        if update.callback_query:
            await update.callback_query.edit_message_text(final_message)
        else:
            await update.message.reply_text(final_message)
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ –Ω–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥: {e}", exc_info=True)
        await update.effective_message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.")
    
    context.user_data.clear()
    return ConversationHandler.END
async def start_expense_logging(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 1: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤."""
    if not is_admin(update.message.from_user.id):
        await update.message.reply_text("üö´ –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.")
        return ConversationHandler.END

    context.user_data.clear()
    context.user_data['expense_data'] = {'admin_id': update.message.from_user.id}

    keyboard = [
        [InlineKeyboardButton(details['label'], callback_data=f"exp_cat_{cat}")]
        for cat, details in EXPENSE_CATEGORIES.items()
    ]
    keyboard.append([InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="exp_cancel")])

    await update.message.reply_text(
        "üí∞ *–£—á–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤*\n\n–í—ã–±–µ—Ä–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é:",
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )
    return EXP_SELECT_CATEGORY

async def select_main_category(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 2: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –≥–ª–∞–≤–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ò–õ–ò –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤–µ—Ç–∫—É –¥–ª—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤."""
    query = update.callback_query
    await query.answer()

    if query.data == "exp_cancel":
        await query.edit_message_text("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
        return ConversationHandler.END

    category_key = '_'.join(query.data.split('_')[2:])
    
    # <<< –í–û–¢ –≠–¢–ê –ü–†–û–í–ï–†–ö–ê >>>
    if category_key == 'bike_specific':
        # –ï—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ "–í–µ–ª–æ—Å–∏–ø–µ–¥—ã", –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–∞—à –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥
        return await start_bike_specific_expense(update, context)
    # <<< –ö–û–ù–ï–¶ –ü–†–û–í–ï–†–ö–ò >>>

    context.user_data['expense_data']['category'] = category_key
    category_info = EXPENSE_CATEGORIES[category_key]

    keyboard = []
    for sub_key, sub_details in category_info['subcategories'].items():
        label = sub_details['label'] if isinstance(sub_details, dict) else sub_details
        keyboard.append([InlineKeyboardButton(label, callback_data=f"exp_sub_{sub_key}")])

    keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="exp_back_to_main")])

    await query.edit_message_text(
        f"–í—ã–±—Ä–∞–Ω–æ: *{category_info['label']}*\n\n–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é:",
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )
    return EXP_SELECT_SUBCATEGORY
(
    EXP_SELECT_CATEGORY, EXP_SELECT_SUBCATEGORY, EXP_AWAIT_AMOUNT,
    EXP_AWAIT_ITEM_NAME, EXP_AWAIT_QUANTITY, EXP_AWAIT_COMMENT
) = range(1000, 1006)

(
    BEXP_AWAIT_BIKE_NAME,
    BEXP_AWAIT_EXPENSE_NAME,
    BEXP_AWAIT_AMOUNT,
    BEXP_AWAIT_COMMENT
) = range(1100, 1104)

# --- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å –Ω–æ–≤–æ–π –∫–Ω–æ–ø–∫–æ–π ---
EXPENSE_CATEGORIES = {
    'fixed': {
        'label': 'üè¢ –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã',
        'subcategories': { 'rent': '–ê—Ä–µ–Ω–¥–∞ –ø–æ–º–µ—â–µ–Ω–∏—è', 'salary': '–ó–∞—Ä–ø–ª–∞—Ç–∞', 'taxes': '–ù–∞–ª–æ–≥–∏', 'bot_maint': '–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –±–æ—Ç–∞', 'gps_sub': '–ê–±–æ–Ω–µ–Ω—Ç–∫–∞ GPS', 'other': {'label': '–î—Ä—É–≥–æ–µ', 'is_complex': True} }
    },
    'variable': {
        'label': 'üöö –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã',
        'subcategories': { 'repair': '–†–µ–º–æ–Ω—Ç (–≤–Ω–µ—à–Ω–∏–π)', 'cleaning': '–ú–æ–π–∫–∞', 'ads': '–†–µ–∫–ª–∞–º–∞', 'taxi': '–¢–∞–∫—Å–∏/–õ–æ–≥–∏—Å—Ç–∏–∫–∞', 'branding': '–ë—Ä–µ–Ω–¥–∏–Ω–≥', 'misc': '–ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã', 'other': {'label': '–î—Ä—É–≥–æ–µ', 'is_complex': True} }
    },
    'inventory': {
        'label': 'üî© –ó–∞–∫—É–ø–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è',
        'subcategories': { 'parts': {'label': '–ó–∞–ø—á–∞—Å—Ç–∏', 'is_complex': True}, 'accessories': {'label': '–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã', 'is_complex': True}, 'other': {'label': '–î—Ä—É–≥–æ–µ', 'is_complex': True} }
    },
    'capital': {
        'label': 'üö≤ –ö—Ä—É–ø–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏',
        'subcategories': { 'bike': '–í–µ–ª–æ—Å–∏–ø–µ–¥', 'battery': '–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä—ã', 'tracker': '–¢—Ä–µ–∫–µ—Ä—ã', 'other': {'label': '–î—Ä—É–≥–æ–µ', 'is_complex': True} }
    },
    'bike_specific': {
        'label': 'üö≤ –í–µ–ª–æ—Å–∏–ø–µ–¥—ã (—Ä–∞—Å—Ö–æ–¥—ã)',
        'subcategories': {} # –ü—É—Å—Ç–æ–π, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥–∞–ª—å—à–µ —Å–≤–æ—è –ª–æ–≥–∏–∫–∞
    }
}

# --- –û–ë–©–ò–ï –†–ê–°–•–û–î–´ (—Å—Ç–∞—Ä—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª) ---

async def start_expense_logging(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 1: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤."""
    if not is_admin(update.message.from_user.id):
        await update.message.reply_text("üö´ –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.")
        return ConversationHandler.END

    context.user_data.clear()
    context.user_data['expense_data'] = {'admin_id': update.message.from_user.id}

    keyboard = [
        [InlineKeyboardButton(details['label'], callback_data=f"exp_cat_{cat}")]
        for cat, details in EXPENSE_CATEGORIES.items()
    ]
    keyboard.append([InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="exp_cancel")])

    await update.message.reply_text(
        "üí∞ *–£—á–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤*\n\n–í—ã–±–µ—Ä–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é:",
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )
    return EXP_SELECT_CATEGORY

async def select_main_category(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 2: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –≥–ª–∞–≤–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ò–õ–ò –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤–µ—Ç–∫—É –¥–ª—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤."""
    query = update.callback_query
    await query.answer()

    if query.data == "exp_cancel":
        await query.edit_message_text("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
        return ConversationHandler.END

    category_key = '_'.join(query.data.split('_')[2:])
    
    # <<< –í–û–¢ –ì–õ–ê–í–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê >>>
    if category_key == 'bike_specific':
        return await start_bike_specific_expense(update, context)

    context.user_data['expense_data']['category'] = category_key
    category_info = EXPENSE_CATEGORIES[category_key]

    keyboard = []
    for sub_key, sub_details in category_info['subcategories'].items():
        label = sub_details['label'] if isinstance(sub_details, dict) else sub_details
        keyboard.append([InlineKeyboardButton(label, callback_data=f"exp_sub_{sub_key}")])
    keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="exp_back_to_main")])

    await query.edit_message_text(
        f"–í—ã–±—Ä–∞–Ω–æ: *{category_info['label']}*\n\n–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é:",
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )
    return EXP_SELECT_SUBCATEGORY

# ... (–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—â–∏—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤: select_subcategory, get_item_name, get_quantity, get_amount, save_expense) ...
# –í–ê–ñ–ù–û: –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Ç—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª –∏—Ö –∏–∑ —Å–≤–æ–µ–≥–æ —Å—Ç–∞—Ä–æ–≥–æ –∫–æ–¥–∞, –µ—Å–ª–∏ —É–¥–∞–ª–∏–ª. –ï—Å–ª–∏ –Ω–µ—Ç - –≤–æ—Ç –æ–Ω–∏:
async def select_subcategory(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()
    if query.data == "exp_back_to_main":
        await query.message.delete()
        return await start_expense_logging(query, context)
    subcategory_key = '_'.join(query.data.split('_')[2:])
    expense_data = context.user_data['expense_data']
    expense_data['subcategory'] = subcategory_key
    main_category = EXPENSE_CATEGORIES[expense_data['category']]
    subcategory_info = main_category['subcategories'][subcategory_key]
    is_complex = isinstance(subcategory_info, dict) and subcategory_info.get('is_complex', False)
    if is_complex:
        await query.edit_message_text("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞/—Ä–∞—Å—Ö–æ–¥–∞:")
        return EXP_AWAIT_ITEM_NAME
    else:
        await query.edit_message_text("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Ä–∞—Å—Ö–æ–¥–∞ –≤ —Ä—É–±–ª—è—Ö:")
        return EXP_AWAIT_AMOUNT
async def get_item_name(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    context.user_data['expense_data']['item_name'] = update.message.text
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (—à—Ç.):")
    return EXP_AWAIT_QUANTITY
async def get_quantity(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    try:
        context.user_data['expense_data']['quantity'] = int(update.message.text)
        await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –û–ë–©–£–Æ —Å—É–º–º—É:")
        return EXP_AWAIT_AMOUNT
    except ValueError:
        await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.")
        return EXP_AWAIT_QUANTITY
async def get_amount(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    try:
        context.user_data['expense_data']['amount'] = float(update.message.text.replace(',', '.'))
        keyboard = [[InlineKeyboardButton("–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å", callback_data="exp_skip_comment")]]
        await update.message.reply_text("–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–µ.", reply_markup=InlineKeyboardMarkup(keyboard))
        return EXP_AWAIT_COMMENT
    except ValueError:
        await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É.")
        return EXP_AWAIT_AMOUNT
async def save_expense(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    comment = update.message.text if update.message else None
    expense_data = context.user_data['expense_data']
    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            await conn.execute(
                "INSERT INTO expenses (admin_id, category, subcategory, item_name, quantity, amount, comment) VALUES (?, ?, ?, ?, ?, ?, ?)",
                (expense_data['admin_id'], expense_data['category'], expense_data['subcategory'], expense_data.get('item_name'), expense_data.get('quantity'), expense_data['amount'], comment)
            )
            await conn.commit()
        msg = f"‚úÖ –†–∞—Å—Ö–æ–¥ –Ω–∞ —Å—É–º–º—É {expense_data['amount']} ‚ÇΩ –∑–∞–ø–∏—Å–∞–Ω!"
        if update.callback_query: await update.callback_query.edit_message_text(msg)
        else: await update.message.reply_text(msg)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞: {e}")
        await update.effective_message.reply_text("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.")
    context.user_data.clear()
    return ConversationHandler.END

MOSCOW_TZ = pytz.timezone('Europe/Moscow')
# --- –†–ê–°–•–û–î–´ –ù–ê –ö–û–ù–ö–†–ï–¢–ù–´–ô –í–ï–õ–û–°–ò–ü–ï–î (–Ω–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª) ---

async def start_bike_specific_expense(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 1 (–¥–ª—è –≤–µ–ª–∏–∫–∞): –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ/–Ω–æ–º–µ—Ä –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞."""
    query = update.callback_query
    await query.answer()
    await query.edit_message_text("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –Ω–æ–º–µ—Ä –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ú–æ–Ω—Å—Ç—Ä 312123213'):")
    return BEXP_AWAIT_BIKE_NAME

async def get_bike_name_for_expense(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 2 (–¥–ª—è –≤–µ–ª–∏–∫–∞): –ü–æ–ª—É—á–∞–µ—Ç –∏–º—è, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥."""
    context.user_data['bike_expense_bike_name'] = update.message.text
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ó–∞–º–µ–Ω–∞ —Ç–æ—Ä–º–æ–∑–æ–≤'):")
    return BEXP_AWAIT_EXPENSE_NAME

async def get_expense_name_for_bike(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 3 (–¥–ª—è –≤–µ–ª–∏–∫–∞): –ü–æ–ª—É—á–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å—É–º–º—É."""
    context.user_data['bike_expense_name'] = update.message.text
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Ä–∞—Å—Ö–æ–¥–∞ –≤ —Ä—É–±–ª—è—Ö:")
    return BEXP_AWAIT_AMOUNT

async def get_amount_for_bike_expense(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 4 (–¥–ª—è –≤–µ–ª–∏–∫–∞): –ü–æ–ª—É—á–∞–µ—Ç —Å—É–º–º—É, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π."""
    try:
        amount = float(update.message.text.replace(',', '.'))
        if amount <= 0: raise ValueError
        context.user_data['bike_expense_amount'] = amount
        keyboard = [[InlineKeyboardButton("–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å", callback_data="bexp_skip_comment")]]
        await update.message.reply_text(
            "–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –¥–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π. –ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å'.",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        return BEXP_AWAIT_COMMENT
    except ValueError:
        await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ).")
        return BEXP_AWAIT_AMOUNT

async def save_bike_specific_expense(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–§–∏–Ω–∞–ª—å–Ω—ã–π —à–∞–≥: –°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ –≤–º–µ—Å—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î, –Ω–µ –º–µ–Ω—è—è –µ—ë —Å—Ç—Ä—É–∫—Ç—É—Ä—É."""
    user_comment = update.message.text if update.message else ""
    data = context.user_data
    
    # --- –ì–õ–ê–í–ù–´–ô –§–û–ö–£–°: –ü–∏—Ö–∞–µ–º –∏–º—è –≤–µ–ª–∏–∫–∞ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ---
    final_comment = f"–í–µ–ª–æ—Å–∏–ø–µ–¥: {data['bike_expense_bike_name']}. {user_comment}".strip()

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            await conn.execute(
                """INSERT INTO expenses (admin_id, category, subcategory, item_name, amount, comment)
                   VALUES (?, ?, ?, ?, ?, ?)""",
                (
                    update.effective_user.id,
                    'variable',  # –†–∞—Å—Ö–æ–¥ –Ω–∞ –≤–µ–ª–∏–∫ –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–π
                    'repair',    # –ß–∞—â–µ –≤—Å–µ–≥–æ —ç—Ç–æ —Ä–µ–º–æ–Ω—Ç –∏–ª–∏ –∑–∞–ø—á–∞—Å—Ç–∏
                    data['bike_expense_name'],
                    data['bike_expense_amount'],
                    final_comment
                )
            )
            await conn.commit()
        
        final_message = f"‚úÖ –†–∞—Å—Ö–æ–¥ {data['bike_expense_amount']} ‚ÇΩ –Ω–∞ '{data['bike_expense_bike_name']}' –∑–∞–ø–∏—Å–∞–Ω!"
        if update.callback_query:
            await update.callback_query.edit_message_text(final_message)
        else:
            await update.message.reply_text(final_message)
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞ –Ω–∞ –≤–µ–ª–∏–∫: {e}", exc_info=True)
        await update.effective_message.reply_text("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.")
    
    context.user_data.clear()
    return ConversationHandler.END
async def select_subcategory(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 3: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ —Ä–µ—à–∞–µ—Ç, —á—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞—Ç—å –¥–∞–ª—å—à–µ."""
    query = update.callback_query
    await query.answer()

    if query.data == "exp_back_to_main":
        # --- –ù–ê–ß–ê–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---
        # –ü—Ä–∞–≤–∏–ª—å–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤—ã–π —à–∞–≥, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—è —Å–æ–æ–±—â–µ–Ω–∏–µ
        context.user_data.pop('expense_data', None) # –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–π –≤—ã–±–æ—Ä
        context.user_data['expense_data'] = {'admin_id': query.from_user.id}

        keyboard = [
            [InlineKeyboardButton(details['label'], callback_data=f"exp_cat_{cat}")]
            for cat, details in EXPENSE_CATEGORIES.items()
        ]
        keyboard.append([InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="exp_cancel")])
        await query.edit_message_text(
            "üí∞ *–£—á–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤*\n\n–í—ã–±–µ—Ä–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é:",
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode="Markdown"
        )
        return EXP_SELECT_CATEGORY
        # --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ---

    subcategory_key = '_'.join(query.data.split('_')[2:])
    expense_data = context.user_data['expense_data']
    expense_data['subcategory'] = subcategory_key
    
    main_category = EXPENSE_CATEGORIES[expense_data['category']]
    subcategory_info = main_category['subcategories'][subcategory_key]
    is_complex = isinstance(subcategory_info, dict) and subcategory_info.get('is_complex', False)
    
    if is_complex:
        await query.edit_message_text("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞/—Ä–∞—Å—Ö–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ó–∞–º–æ–∫ Kryptonite' –∏–ª–∏ '–ö–∞–Ω—Ü—Ç–æ–≤–∞—Ä—ã'):")
        return EXP_AWAIT_ITEM_NAME
    else:
        await query.edit_message_text("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Ä–∞—Å—Ö–æ–¥–∞ –≤ —Ä—É–±–ª—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5000):")
        return EXP_AWAIT_AMOUNT

async def get_item_name(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 4 (–¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö): –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ."""
    context.user_data['expense_data']['item_name'] = update.message.text
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä, 10):")
    return EXP_AWAIT_QUANTITY

async def get_quantity(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 5 (–¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö): –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –û–ë–©–£–Æ —Å—É–º–º—É."""
    try:
        quantity = int(update.message.text)
        if quantity <= 0: raise ValueError
        context.user_data['expense_data']['quantity'] = quantity
        await update.message.reply_text(f"–í–≤–µ–¥–∏—Ç–µ –û–ë–©–£–Æ —Å—É–º–º—É –∑–∞ {quantity} —à—Ç.:")
        return EXP_AWAIT_AMOUNT
    except ValueError:
        await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (—Ü–µ–ª–æ–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ).")
        return EXP_AWAIT_QUANTITY

async def get_amount(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 6: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—É–º–º—É, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π."""
    try:
        amount = float(update.message.text.replace(',', '.'))
        if amount <= 0: raise ValueError
        context.user_data['expense_data']['amount'] = amount
        keyboard = [[InlineKeyboardButton("–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å", callback_data="exp_skip_comment")]]
        await update.message.reply_text(
            "–ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –¥–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π. –ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å'.",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        return EXP_AWAIT_COMMENT
    except ValueError:
        await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ).")
        return EXP_AWAIT_AMOUNT

async def save_expense(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–§–∏–Ω–∞–ª—å–Ω—ã–π —à–∞–≥: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –¥–∏–∞–ª–æ–≥."""
    comment = update.message.text if update.message else None
    expense_data = context.user_data['expense_data']
    
    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            await conn.execute(
                """INSERT INTO expenses (admin_id, category, subcategory, item_name, quantity, amount, comment)
                   VALUES (?, ?, ?, ?, ?, ?, ?)""",
                (
                    expense_data['admin_id'], expense_data['category'], expense_data['subcategory'],
                    expense_data.get('item_name'), expense_data.get('quantity'),
                    expense_data['amount'], comment
                )
            )
            await conn.commit()
        
        final_message = f"‚úÖ –†–∞—Å—Ö–æ–¥ –Ω–∞ —Å—É–º–º—É {expense_data['amount']} ‚ÇΩ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω!"
        if update.callback_query:
            await update.callback_query.edit_message_text(final_message)
        else:
            await update.message.reply_text(final_message)
            
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞: {e}", exc_info=True)
        await update.effective_message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.")
    
    context.user_data.clear()
    return ConversationHandler.END

# ==============================================================================
#           –ù–û–í–´–ô –ú–û–î–£–õ–¨: –ì–ï–ù–ï–†–ê–¶–ò–Ø –û–¢–ß–ï–¢–ê –ü–û –†–ê–°–•–û–î–ê–ú
# ==============================================================================

async def start_report_generation(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ù–∞—á–∏–Ω–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞, –∑–∞–ø—Ä–∞—à–∏–≤–∞—è –¥–∞—Ç—ã."""
    if not is_admin(update.message.from_user.id):
        await update.message.reply_text("üö´ –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.")
        return ConversationHandler.END

    # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π –æ—Ç–º–µ–Ω—ã ---
    cancel_keyboard = ReplyKeyboardMarkup([["‚ùå –û—Ç–º–µ–Ω–∞"]], resize_keyboard=True)

    await update.message.reply_text(
        "üìÖ *–û—Ç—á–µ—Ç –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º*\n\n"
        "–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –æ—Ç—á–µ—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `–î–î.–ú–ú.–ì–ì–ì–ì-–î–î.–ú–ú.–ì–ì–ì–ì`\n"
        "–ù–∞–ø—Ä–∏–º–µ—Ä: `01.05.2024-31.05.2024`\n\n"
        "–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ `—Å–µ–≥–æ–¥–Ω—è`, `–Ω–µ–¥–µ–ª—è`, `–º–µ—Å—è—Ü` –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç—á–µ—Ç–∞.",
        parse_mode="Markdown",
        reply_markup=cancel_keyboard  # <-- –î–æ–±–∞–≤–ª–µ–Ω–æ
    )
    return AWAIT_EXPENSE_REPORT_DATES

async def process_date_range_for_report(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–≤–æ–¥ –¥–∞—Ç, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á–µ—Ç."""
    user_input = update.message.text.strip().lower()
    today = datetime.now()
    start_date, end_date = None, None
    user_id = update.effective_user.id

    try:
        if user_input == '—Å–µ–≥–æ–¥–Ω—è':
            start_date = end_date = today
        elif user_input == '–Ω–µ–¥–µ–ª—è':
            start_date = today - timedelta(days=today.weekday())
            end_date = today
        elif user_input == '–º–µ—Å—è—Ü':
            start_date = today.replace(day=1)
            end_date = today
        else:
            start_str, end_str = user_input.split('-')
            start_date = datetime.strptime(start_str.strip(), '%d.%m.%Y')
            end_date = datetime.strptime(end_str.strip(), '%d.%m.%Y')
    except (ValueError, IndexError):
        await update.message.reply_text(
            "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `–î–î.–ú–ú.–ì–ì–ì–ì-–î–î.–ú–ú.–ì–ì–ì–ì` –∏–ª–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞."
        )
        return AWAIT_EXPENSE_REPORT_DATES

    status_message = await update.message.reply_text("‚è≥ –§–æ—Ä–º–∏—Ä—É—é –æ—Ç—á–µ—Ç, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...")

    report_filename = generate_expense_report(start_date, end_date)

    if report_filename and os.path.exists(report_filename):
        await status_message.delete()
        with open(report_filename, 'rb') as report_file:
            await update.message.reply_document(
                document=report_file,
                caption=f"üìä –û—Ç—á–µ—Ç –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º –∑–∞ –ø–µ—Ä–∏–æ–¥ —Å {start_date.strftime('%d.%m.%Y')} –ø–æ {end_date.strftime('%d.%m.%Y')}"
            )
        os.remove(report_filename)
    else:
        await status_message.edit_text("üòî –ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")

    # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é ---
    await update.message.reply_text(
        "–í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.",
        reply_markup=get_main_menu(user_id)
    )
    return ConversationHandler.END

def parse_bike_name_and_vin(full_name: str) -> dict:
    """
    –†–∞–∑–±–∏—Ä–∞–µ—Ç –ø–æ–ª–Ω–æ–µ –∏–º—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –Ω–∞ –º–æ–¥–µ–ª—å –∏ VIN.
    –ü—Ä–∏–º–µ—Ä: "Kugoo JL20241012781" -> {'model': 'Kugoo', 'vin': 'JL20241012781'}
    """
    vin_starters = ['JL', 'ESM', 'CNHC'] # –ü—Ä–µ—Ñ–∏–∫—Å—ã, —Å –∫–æ—Ç–æ—Ä—ã—Ö –º–æ–∂–µ—Ç –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è VIN
    model = full_name.strip()
    vin = '(–Ω–µ –ø—Ä–∏—Å–≤–æ–µ–Ω)'

    for prefix in vin_starters:
        if prefix in full_name:
            # –†–∞–∑–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ –ø–µ—Ä–≤–æ–º—É –≤—Ö–æ–∂–¥–µ–Ω–∏—é –ø—Ä–µ—Ñ–∏–∫—Å–∞
            parts = full_name.split(prefix, 1)
            model = parts[0].strip()
            vin = prefix + parts[1].strip()
            break # –ù–∞—à–ª–∏ VIN, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞
            
    return {'model': model, 'vin': vin}
# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
SELECT_USER_FOR_DISCOUNT, ENTER_DISCOUNT_PERCENT, ENTER_DISCOUNT_REASON, ENTER_DISCOUNT_DURATION = range(4)
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
# ### –ò–ó–ú–ï–ù–ï–ù–ò–ï: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏ ###
# –®–ê–ì 2: –í–°–¢–ê–í–¨–¢–ï –≠–¢–£ –ù–û–í–£–Æ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–£–Æ –§–£–ù–ö–¶–ò–Æ

# –®–ê–ì 1: –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–£ –§–£–ù–ö–¶–ò–Æ

import os

def select_document_template(deal_type: str, price: float) -> str | None:
    """
    –í—ã–±–∏—Ä–∞–µ—Ç –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É —à–∞–±–ª–æ–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–∏–ø–∞ —Å–¥–µ–ª–∫–∏ –∏ —Å—É–º–º—ã –ø–µ—Ä–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞.
    """
    template_dir = "contract_templates"
    filename = ""
    
    # –û–∫—Ä—É–≥–ª—è–µ–º —Ü–µ–Ω—É –¥–æ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    price_int = int(price)

    if deal_type == 'rent':
        filename = f"act_rent_{price_int}.docx"
    elif deal_type == 'buyout':
        filename = f"agreement_buyout_{price_int}.docx"
    else:
        # –ï—Å–ª–∏ —Ç–∏–ø —Å–¥–µ–ª–∫–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None
        return None

    full_path = os.path.join(template_dir, filename)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–∞–∫–æ–π —Ñ–∞–π–ª, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫
    if os.path.exists(full_path):
        return full_path
    else:
        # –ï—Å–ª–∏ —à–∞–±–ª–æ–Ω –¥–ª—è —Ç–∞–∫–æ–π —Ü–µ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None
        logging.error(f"–®–∞–±–ª–æ–Ω –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω: {full_path}")
        return None

def get_bike_model_key(bike_name: str) -> str | None:
    """
    –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–ª—é—á –º–æ–¥–µ–ª–∏, —É—á–∏—Ç—ã–≤–∞—è –∏–µ—Ä–∞—Ä—Ö–∏—é.
    """
    bike_name_lower = bike_name.lower()

    # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–∞–º—ã–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏

    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä –¥–ª—è –∞—Ä–µ–Ω–¥—ã
    if '–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–∫–±' in bike_name_lower:
        return 'akb'

    # 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ Wenbox
    if 'wenbox' in bike_name_lower or 'cnhc' in bike_name_lower:
        return 'wenbox'

    # 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ Kugoo —Å –î–í–£–ú–Ø –±–∞—Ç–∞—Ä–µ—è–º–∏. –≠—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ü–ï–†–ï–î
    #    –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ –æ–±—ã—á–Ω—ã–π Kugoo (JL), —Ç–∞–∫ –∫–∞–∫ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∏ '2-–∞–∫–±', –∏ 'jl'.
    if '2-–∞–∫–±' in bike_name_lower or '2 –∞–∫–±' in bike_name_lower:
        return 'kugoo_2akb'

    # 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ Liming –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É ESM
    if 'esm' in bike_name_lower:
        return 'liming_esm'

    # 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Kugoo –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É JL
    if 'jl' in bike_name_lower:
        return 'kugoo_jl'

    # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–¥–æ—à–ª–æ, –ª–æ–≥–∏—Ä—É–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None
    logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–ª—é—á –º–æ–¥–µ–ª–∏ –¥–ª—è: '{bike_name}'. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (Wenbox, CNHC, 2-–ê–ö–ë, ESM, JL).")
    return None
def apply_discount(original_price: float, discount_amount: float) -> float:
    """
    –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Å–∫–∏–¥–∫—É –≤ —Ä—É–±–ª—è—Ö –∫ —Ü–µ–Ω–µ.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—É—é —Ü–µ–Ω—É, –Ω–æ –Ω–µ –º–µ–Ω—å—à–µ 1.00 —Ä—É–±–ª—è.
    """
    if discount_amount <= 0:
        return original_price

    # –í—ã—á–∏—Ç–∞–µ–º —Å—É–º–º—É —Å–∫–∏–¥–∫–∏
    discounted_price = original_price - discount_amount

    # –¶–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ 1 —Ä—É–±–ª—è (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –º–Ω–æ–≥–∏—Ö –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º)
    return max(1.00, round(discounted_price, 2))
# ### –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Å–∫–∏–¥–æ–∫ –≤ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ ###
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
# ### –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Å–∫–∏–¥–æ–∫ –≤ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ ###
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
# ### –ù–û–í–ê–Ø, –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
# ### –ù–û–í–ê–Ø, –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ create_yookassa_payment –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

### –ù–û–í–ê–Ø, –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
async def create_yookassa_payment(amount: int, description: str, metadata: dict, items: list, customer_info: dict, payment_method: str | None = None, bot_username: str = "@BFbikebot") -> dict | None:
    try:
        user_id = metadata.get('user_id')
        original_amount = float(amount)
        final_amount_for_payment = original_amount

        if TEST_MODE:
            final_amount_for_payment = 1.00
            logger.warning(f"–¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú –ê–ö–¢–ò–í–ï–ù! –°—É–º–º–∞ {original_amount} –∑–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ {final_amount_for_payment} —Ä—É–±.")

        if user_id and not TEST_MODE:
            async with aiosqlite.connect(DB_FILE) as conn:
                cursor = await conn.execute(
                    "SELECT id, amount FROM discounts WHERE user_id = ? AND is_used = 0 AND expiry_date > date('now') ORDER BY created_at DESC LIMIT 1",
                    (user_id,)
                )
                active_discount = await cursor.fetchone()

            if active_discount:
                discount_id, discount_amount = active_discount
                final_amount_for_payment = apply_discount(original_amount, discount_amount)
                description += f" (—Å —É—á–µ—Ç–æ–º —Å–∫–∏–¥–∫–∏ {discount_amount} ‚ÇΩ)"
                metadata['discount_id'] = discount_id
                logger.info(f"–ü—Ä–∏–º–µ–Ω–µ–Ω–∞ —Å–∫–∏–¥–∫–∞ {discount_amount} ‚ÇΩ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}. –ù–æ–≤–∞—è —Å—É–º–º–∞: {final_amount_for_payment:.2f}")

        if items and len(items) > 0:
            items[0]['amount']['value'] = f"{final_amount_for_payment:.2f}"

            # <<< –ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ >>>
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ payment_subject, –∏ –µ—Å–ª–∏ –Ω–µ—Ç, –∏–ª–∏ –æ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π, —Å—Ç–∞–≤–∏–º "service" –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
            # –≠—Ç–æ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –∞—Ä–µ–Ω–¥—ã, —Ä–µ–º–æ–Ω—Ç–∞ –∏ —Ç.–¥.
            if 'payment_subject' not in items[0] or not items[0]['payment_subject']:
                items[0]['payment_subject'] = 'service'

            if 'payment_mode' not in items[0] or not items[0]['payment_mode']:
                 items[0]['payment_mode'] = 'full_payment'
            # <<< –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø >>>

        payment_data = {
            "amount": {"value": f"{final_amount_for_payment:.2f}", "currency": "RUB"},
            "confirmation": {"type": "redirect", "return_url": f"https://t.me/{bot_username}"},
            "capture": True,
            "description": description,
            "metadata": metadata,
            "receipt": {
                "customer": customer_info,
                "items": items,
                # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–¥ —Å–∏—Å—Ç–µ–º—ã –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤–∞—à–µ–º—É –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa
                # 1 - –û–°–ù, 2 - –£–°–ù –î–æ—Ö–æ–¥, 3 - –£–°–ù –î–æ—Ö–æ–¥-–†–∞—Å—Ö–æ–¥, 4 - –ï–°–•–ù, 5 - –ü–∞—Ç–µ–Ω—Ç
                "tax_system_code": 2
            }
        }
        if payment_method:
            payment_data["payment_method_data"] = {"type": payment_method}

        payment = Payment.create(payment_data, uuid.uuid4())

        return {
            "id": payment.id,
            "url": payment.confirmation.confirmation_url,
            "final_amount": final_amount_for_payment
        }

    except BadRequestError as e:
        # –õ–æ–≥–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –ÆKassa –¥–ª—è –ª–µ–≥–∫–æ–π –æ—Ç–ª–∞–¥–∫–∏
        logger.error(f"–û—à–∏–±–∫–∞ BadRequestError –æ—Ç –ÆKassa: {e.response_body}", exc_info=True)
        return None
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ –≤ –ÆKassa: {e}", exc_info=True)
        return None


async def start_discount_process(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –≤—ã–¥–∞—á–∏ —Å–∫–∏–¥–∫–∏. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–æ–π –≤ –º–µ–Ω—é."""
    admin_id = update.message.from_user.id
    if not is_admin(admin_id):
        await update.message.reply_text("üö´ –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.")
        return ConversationHandler.END

    context.user_data.clear()
    context.user_data['admin_id'] = admin_id
    context.user_data['discount_page'] = 0

    await show_users_for_discount(update, context)
    return SELECT_USER_FOR_DISCOUNT

async def show_users_for_discount(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π."""
    page = context.user_data.get('discount_page', 0)

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*) FROM users")
    total_users = cursor.fetchone()[0]

    cursor.execute("SELECT id, first_name, last_name FROM users ORDER BY last_name, first_name LIMIT 5 OFFSET ?", (page * 5,))
    users = cursor.fetchall()
    conn.close()

    if not users and page == 0:
        await update.effective_message.reply_text("–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")
        return ConversationHandler.END

    keyboard = [
        [InlineKeyboardButton(f"{last_name or ''} {first_name or ''} (ID:{user_id})", callback_data=f"discount_user_{user_id}")]
        for user_id, first_name, last_name in users
    ]

    pagination_buttons = []
    if page > 0:
        pagination_buttons.append(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="discount_prev_page"))
    if (page + 1) * 5 < total_users:
        pagination_buttons.append(InlineKeyboardButton("–í–ø–µ—Ä–µ–¥ ‚û°Ô∏è", callback_data="discount_next_page"))

    if pagination_buttons:
        keyboard.append(pagination_buttons)
    keyboard.append([InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="discount_cancel")])

    message_text = f"üéÅ –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≤—ã–¥–∞—á–∏ —Å–∫–∏–¥–∫–∏ (–°—Ç—Ä. {page + 1}):"

    if update.callback_query:
        await update.callback_query.edit_message_text(message_text, reply_markup=InlineKeyboardMarkup(keyboard))
    else:
        await update.message.reply_text(message_text, reply_markup=InlineKeyboardMarkup(keyboard))

    return SELECT_USER_FOR_DISCOUNT

async def handle_user_selection_for_discount(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏—é."""
    query = update.callback_query
    await query.answer()

    if query.data == "discount_prev_page":
        context.user_data['discount_page'] = context.user_data.get('discount_page', 1) - 1
        return await show_users_for_discount(update, context)

    if query.data == "discount_next_page":
        context.user_data['discount_page'] = context.user_data.get('discount_page', 0) + 1
        return await show_users_for_discount(update, context)

    if query.data == "discount_cancel":
        await query.edit_message_text("–í—ã–¥–∞—á–∞ —Å–∫–∏–¥–∫–∏ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
        context.user_data.clear()
        return ConversationHandler.END

    user_id = int(query.data.split('_')[-1])
    context.user_data['discount_user_id'] = user_id

    # ### –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ ###
    await query.edit_message_text(f"–í—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å ID {user_id}.\n\n–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Å–∫–∏–¥–∫–∏ –≤ —Ä—É–±–ª—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, 500):")
    return ENTER_DISCOUNT_PERCENT # –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–µ–º –∂–µ, –Ω–æ —Ç–µ–ø–µ—Ä—å –æ–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ —Å—É–º–º—ã

# ### –ò–ó–ú–ï–ù–ï–ù–ò–ï: –õ–æ–≥–∏–∫–∞ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω–µ–Ω–∞ ###
async def process_discount_percent(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–≤–æ–¥ —Å—É–º–º—ã —Å–∫–∏–¥–∫–∏ –≤ —Ä—É–±–ª—è—Ö."""
    try:
        # –ó–∞–º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—É—é –Ω–∞ —Ç–æ—á–∫—É –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ float
        amount = float(update.message.text.replace(',', '.'))
        if amount <= 0:
            raise ValueError
        context.user_data['discount_amount'] = amount # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—É–º–º—É
        await update.message.reply_text("–û—Ç–ª–∏—á–Ω–æ. –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –≤—ã–¥–∞—á–∏ —Å–∫–∏–¥–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ë–æ–Ω—É—Å –∑–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç—å'):")
        return ENTER_DISCOUNT_REASON
    except ValueError:
        await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä, 500 –∏–ª–∏ 250.5).")
        return ENTER_DISCOUNT_PERCENT

# –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
async def process_discount_reason(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–≤–æ–¥ –ø—Ä–∏—á–∏–Ω—ã."""
    reason = update.message.text.strip()
    if not reason:
        await update.message.reply_text("‚ùå –ü—Ä–∏—á–∏–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π.")
        return ENTER_DISCOUNT_REASON
    context.user_data['discount_reason'] = reason
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Å–∫–∏–¥–∫–∏ –≤ –¥–Ω—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, 7):")
    return ENTER_DISCOUNT_DURATION

# ### –ò–ó–ú–ï–ù–ï–ù–ò–ï: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î –∏ —Ç–µ–∫—Å—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ###
async def process_discount_duration(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–∫–∏–¥–∫—É –≤ —Ä—É–±–ª—è—Ö –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –¥–∏–∞–ª–æ–≥."""
    try:
        duration_days = int(update.message.text)
        if duration_days <= 0:
            raise ValueError
    except ValueError:
        await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ).")
        return ENTER_DISCOUNT_DURATION

    expiry_date = datetime.now() + timedelta(days=duration_days)
    expiry_date_str = expiry_date.strftime('%Y-%m-%d %H:%M:%S')

    user_id = context.user_data['discount_user_id']
    admin_id = context.user_data['admin_id']
    amount = context.user_data['discount_amount'] # –ò—Å–ø–æ–ª—å–∑—É–µ–º amount –≤–º–µ—Å—Ç–æ percentage
    reason = context.user_data['discount_reason']

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    # ### –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í—Å—Ç–∞–≤–ª—è–µ–º `amount` –≤–º–µ—Å—Ç–æ `percentage` ###
    cursor.execute("""
        INSERT INTO discounts (user_id, admin_id, amount, reason, expiry_date)
        VALUES (?, ?, ?, ?, ?)
    """, (user_id, admin_id, amount, reason, expiry_date_str))
    conn.commit()
    conn.close()

    # ### –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª–µ–Ω —Ç–µ–∫—Å—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ###
    await update.message.reply_text(
        f"‚úÖ –°–∫–∏–¥–∫–∞ –≤ —Ä–∞–∑–º–µ—Ä–µ {amount} ‚ÇΩ —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ID {user_id}!\n"
        f"–û–Ω–∞ –±—É–¥–µ—Ç –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å {duration_days} –¥–Ω–µ–π.",
        reply_markup=get_main_menu(update.message.from_user.id)
    )

    try:
        # ### –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª–µ–Ω —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ###
        await context.bot.send_message(
            chat_id=user_id,
            text=f"üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–∞ –µ–¥–∏–Ω–æ—Ä–∞–∑–æ–≤–∞—è —Å–∫–∏–¥–∫–∞ –Ω–∞ —Å—É–º–º—É **{amount} ‚ÇΩ**!\n\n"
                 f"**–ü—Ä–∏—á–∏–Ω–∞:** {reason}\n"
                 f"**–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è:** –¥–æ {expiry_date.strftime('%d.%m.%Y')}\n\n"
                 "–°–∫–∏–¥–∫–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ –≤–∞—à–µ–º—É —Å–ª–µ–¥—É—é—â–µ–º—É –ø–ª–∞—Ç–µ–∂—É.",
            parse_mode="Markdown"
        )
    except Exception as e:
        logging.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–∫–∏–¥–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")

    context.user_data.clear()
    return ConversationHandler.END

# –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
async def cancel_discount_process(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û—Ç–º–µ–Ω—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –≤—ã–¥–∞—á–∏ —Å–∫–∏–¥–∫–∏."""
    await update.message.reply_text(
        "–í—ã–¥–∞—á–∞ —Å–∫–∏–¥–∫–∏ –æ—Ç–º–µ–Ω–µ–Ω–∞.",
        reply_markup=get_main_menu(update.message.from_user.id)
    )
    context.user_data.clear()
    return ConversationHandler.END
def get_notifications_count() -> int:
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*) FROM notifications")
    count = cursor.fetchone()[0]
    conn.close()
    return count
# ### –ù–û–í–ê–Ø, –ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
import aiosqlite
### –ù–û–í–ê–Ø, –ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
async def log_bike_action(conn: aiosqlite.Connection, bike_id: int | None, user_id: int, action: str, details: str = None, amount: float = None):
    """
    –ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –î–õ–Ø –ó–ê–ü–ò–°–ò –í –ò–°–¢–û–†–ò–Æ –í –†–ê–ú–ö–ê–• –°–£–©–ï–°–¢–í–£–Æ–©–ï–ô –¢–†–ê–ù–ó–ê–ö–¶–ò–ò.
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è `conn` –∏ –Ω–µ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π.
    """
    try:
        details_text = details if details else ""
        if amount is not None:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–π –ø—Ä–æ–±–µ–ª –¥–ª—è —Ä—É–±–ª–µ–π
            details_text += f", —Å—É–º–º–∞: {amount:.2f}\u00A0‚ÇΩ"

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —Ç–æ—á–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')

        # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏, –Ω–µ –∫–æ–º–º–∏—Ç–∏–º –∑–¥–µ—Å—å
        await conn.execute(
            "INSERT INTO bike_history (bike_id, user_id, action, timestamp, details) VALUES (?, ?, ?, ?, ?)",
            (bike_id, user_id, action, timestamp, details_text) # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ø–µ—Ä–µ–¥–∞–µ–º details_text
        )
    except Exception as e:
        # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥–µ–π—Å—Ç–≤–∏—è –≤ bike_history (–≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏): {e}", exc_info=True)

# –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é üéõÔ∏è
# –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é üéõÔ∏è
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ get_main_menu –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ get_main_menu –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
def get_main_menu(user_id: int):
    """
    –§–ò–ù–ê–õ–¨–ù–ê–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø:
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ReplyKeyboardMarkup –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    if is_admin(user_id):
        notifications_count = get_notifications_count()
        keyboard = [
            ["üìã –í–µ–ª–æ—Å–∏–ø–µ–¥—ã", "üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"],
            # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ö–Ω–æ–ø–∫–∞ "–û—Ç—á–µ—Ç—ã –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º" —É–¥–∞–ª–µ–Ω–∞ –æ—Ç—Å—é–¥–∞ >>>
            ["üì© –í–æ–ø—Ä–æ—Å—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", "üì¢ –†–∞—Å—Å—ã–ª–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π"],
            ["üóìÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥–∞–º–∏", "üìà –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏"],
            ["üö¥‚Äç –°–¥–∞—Ç—å –≤ –∞—Ä–µ–Ω–¥—É –≤–µ–ª–æ—Å–∏–ø–µ–¥", "üí∞ –†–∞—Å—Ö–æ–¥—ã"],
            ["üõ†Ô∏è –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—è–≤–æ–∫", "üîß –†–µ–º–æ–Ω—Ç"],
            ["üí∞ –ù–∞–∑–Ω–∞—á–∏—Ç—å —à—Ç—Ä–∞—Ñ", "üìã –°–ø–∏—Å–æ–∫ —à—Ç—Ä–∞—Ñ–æ–≤"],
            ["üéÅ –í—ã–¥–∞—Ç—å —Å–∫–∏–¥–∫—É", "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"],
            ["üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –¥–µ–Ω—å"],
        ]
        notifications_button_text = f"üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ({notifications_count})"
        keyboard.append([notifications_button_text])
        return ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

    # --- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è —á–∞—Å—Ç—å (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    # ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    keyboard = [
        ["üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç", "üí∞–ê—Ä–µ–Ω–¥–∞/–í—ã–∫—É–ø"],
        ["üìã –¢–∞—Ä–∏—Ñ—ã", "üõ†Ô∏è –†–µ–º–æ–Ω—Ç"],
        ["üìú –ü—Ä–∞–≤–∏–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è", "üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã"]
    ]
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT id FROM users WHERE id=?", (user_id,))
    is_registered = cursor.fetchone() is not None
    conn.close()
    if not is_registered:
        keyboard.insert(0, ["üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è"])
    return ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö —Ä–∞–∑–¥–µ–ª–æ–≤ –º–µ–Ω—é ---
# <<< –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–ù–í–ï–°–¢–ò–¶–ò–Ø–ú–ò >>>
INV_SELECT_USER, INV_AWAIT_USER_SEARCH, INV_SELECT_BIKE, INV_AWAIT_BIKE_SEARCH = range(910, 914)
# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –¥–∏–∞–ª–æ–≥–∞
# ==============================================================================
#           –ú–û–î–£–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–ù–í–ï–°–¢–ò–¶–ò–Ø–ú–ò (–í–ï–†–°–ò–Ø 2.0)
# ==============================================================================

# --- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Ä–∞–∑–¥–µ–ª–∞ "–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏" ---
# –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ –í –í–ê–® –ö–û–î

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ show_daily_stats –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ show_daily_stats –ù–ê –≠–¢–£ –§–ò–ù–ê–õ–¨–ù–£–Æ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ show_daily_stats –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
async def show_daily_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–°–æ–±–∏—Ä–∞–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ —Å–µ–≥–æ–¥–Ω—è –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥—Ä—É–≥–æ–π –¥–∞—Ç—ã."""
    status_message = await update.message.reply_text("‚è≥ –°–æ–±–∏—Ä–∞—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ —Å–µ–≥–æ–¥–Ω—è, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...")
    
    def escape(text: str) -> str:
        return escape_markdown(str(text or ''), version=2)

    try:
        today_start_str = datetime.now().strftime('%Y-%m-%d 00:00:00')
        today = datetime.now().date()
        
        # --- –ë–ª–æ–∫ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            total_own = (await (await conn.execute("SELECT COUNT(*) FROM bikes WHERE investor_id IS NULL AND type='bike'")).fetchone())[0]
            total_investor = (await (await conn.execute("SELECT COUNT(*) FROM bikes WHERE investor_id IS NOT NULL AND type='bike'")).fetchone())[0]
            rented_own = (await (await conn.execute("SELECT COUNT(b.id) FROM bookings b JOIN bikes bk ON b.bike_id = bk.id WHERE b.status='rented' AND b.booking_type='rent' AND bk.investor_id IS NULL")).fetchone())[0]
            rented_investor = (await (await conn.execute("SELECT COUNT(b.id) FROM bookings b JOIN bikes bk ON b.bike_id = bk.id WHERE b.status='rented' AND b.booking_type='rent' AND bk.investor_id IS NOT NULL")).fetchone())[0]
            buyout_own = (await (await conn.execute("SELECT COUNT(b.id) FROM bookings b JOIN bikes bk ON b.bike_id = bk.id WHERE b.status='rented' AND b.booking_type='buyout' AND bk.investor_id IS NULL")).fetchone())[0]
            buyout_investor = (await (await conn.execute("SELECT COUNT(b.id) FROM bookings b JOIN bikes bk ON b.bike_id = bk.id WHERE b.status='rented' AND b.booking_type='buyout' AND bk.investor_id IS NOT NULL")).fetchone())[0]
            daily_activity = { "rent_own": 0, "rent_investor": 0, "buyout_own": 0, "buyout_investor": 0, "return_own": 0, "return_investor": 0, "income": 0.0 }
            cursor = await conn.execute("SELECT bh.action, bh.details, bk.investor_id FROM bike_history bh JOIN bikes bk ON bh.bike_id = bk.id WHERE bh.timestamp >= ?",(today_start_str,))
            async for row in cursor:
                is_investor = row['investor_id'] is not None
                if row['action'] in ('–û–ø–ª–∞—Ç–∞ –∞—Ä–µ–Ω–¥—ã', '–ê—Ä–µ–Ω–¥–∞', '–ê—Ä–µ–Ω–¥–∞ –¥–æ–ø. –ê–ö–ë'):
                    if is_investor: daily_activity['rent_investor'] += 1
                    else: daily_activity['rent_own'] += 1
                elif row['action'] == '–í—ã–∫—É–ø (1-–π –≤–∑–Ω–æ—Å)':
                    if is_investor: daily_activity['buyout_investor'] += 1
                    else: daily_activity['buyout_own'] += 1
                elif row['action'] == '–í–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏–Ω—è—Ç':
                    if is_investor: daily_activity['return_investor'] += 1
                    else: daily_activity['return_own'] += 1
                daily_activity['income'] += _get_income_from_details(row['details'])
            exp_cursor = await conn.execute("SELECT SUM(amount) FROM expenses WHERE created_at >= ?", (today_start_str,))
            daily_expenses = (await exp_cursor.fetchone())[0] or 0.0
            upcoming_payments = []
            cursor = await conn.execute("SELECT u.first_name, u.last_name, u.phone_number, u.username, b.end_date, b.next_payment_date, b.booking_type FROM bookings b JOIN users u ON b.user_id = u.id WHERE b.status='rented'")
            async for row in cursor:
                date_str = row['end_date'] if row['booking_type'] == 'rent' else row['next_payment_date']
                if not date_str: continue
                payment_date = datetime.strptime(date_str, "%d.%m.%Y").date()
                days_remaining = (payment_date - today).days
                if days_remaining <= 2:
                    upcoming_payments.append({**row, 'days_remaining': days_remaining})
        
        # --- –ë–ª–æ–∫ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è (–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
        message_parts = [f"üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ {escape(today.strftime('%d.%m.%Y'))}*"]
        message_parts.append(f"*–í–µ–ª–æ—Å–∏–ø–µ–¥—ã –≤ –∞—Ä–µ–Ω–¥–µ:*\n\\- –Ω–∞—à–∏ {rented_own}/{total_own}\n\\- –∏–Ω–≤–µ—Å—Ç–æ—Ä—Å–∫–∏–µ {rented_investor}/{total_investor}")
        message_parts.append(f"*–í–µ–ª–æ—Å–∏–ø–µ–¥—ã –≤ –≤—ã–∫—É–ø–µ:*\n\\- –Ω–∞—à–∏ {buyout_own}\n\\- –∏–Ω–≤–µ—Å—Ç–æ—Ä—Å–∫–∏–µ {buyout_investor}")
        message_parts.append(f"*–í—ã–¥–∞–Ω–æ –≤ –∞—Ä–µ–Ω–¥—É –∑–∞ –¥–µ–Ω—å:*\n\\- –Ω–∞—à–∏ {daily_activity['rent_own']}\n\\- –∏–Ω–≤–µ—Å—Ç–æ—Ä—Å–∫–∏–µ {daily_activity['rent_investor']}")
        message_parts.append(f"*–í—ã–¥–∞–Ω–æ –ø–æ–¥ –≤—ã–∫—É–ø –∑–∞ –¥–µ–Ω—å:*\n\\- –Ω–∞—à–∏ {daily_activity['buyout_own']}\n\\- –∏–Ω–≤–µ—Å—Ç–æ—Ä—Å–∫–∏–µ {daily_activity['buyout_investor']}")
        message_parts.append(f"*–í–µ—Ä–Ω—É–ª–∏ –∏–∑ –∞—Ä–µ–Ω–¥—ã:*\n\\- –Ω–∞—à–∏ {daily_activity['return_own']}\n\\- –∏–Ω–≤–µ—Å—Ç–æ—Ä—Å–∫–∏–µ {daily_activity['return_investor']}")
        income_str = f"{daily_activity['income']:,.2f}".replace(",", " "); expenses_str = f"{daily_expenses:,.2f}".replace(",", " ")
        message_parts.append(f"üí∞ *–î–æ—Ö–æ–¥ –∑–∞ –¥–µ–Ω—å:* `{escape(income_str)}` —Ä—É–±–ª–µ–π\nüí∏ *–†–∞—Å—Ö–æ–¥—ã –∑–∞ –¥–µ–Ω—å:* `{escape(expenses_str)}` —Ä—É–±–ª–µ–π")
        message_parts.append("*–ë–ª–∏–∂–∞–π—à–∏–µ –æ–ø–ª–∞—Ç—ã \\(–¥–æ 2 –¥–Ω–µ–π\\):*")
        if not upcoming_payments:
            message_parts.append("_–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –ø–æ–¥—Ö–æ–¥—è—â–∏–º —Å—Ä–æ–∫–æ–º –æ–ø–ª–∞—Ç—ã\\._")
        else:
            upcoming_payments.sort(key=lambda x: x['days_remaining'])
            def get_day_suffix(days):
                days = abs(days);
                if days % 10 == 1 and days % 100 != 11: return "–¥–µ–Ω—å"
                elif 2 <= days % 10 <= 4 and (days % 100 < 10 or days % 100 >= 20): return "–¥–Ω—è"
                return "–¥–Ω–µ–π"
            payment_list = []
            for p in upcoming_payments:
                days = p['days_remaining']; status = f"üî¥ *–ü—Ä–æ—Å—Ä–æ—á–∫–∞ {abs(days)} {escape(get_day_suffix(days))}*" if days < 0 else f"üü¢ –û—Å—Ç–∞–ª–æ—Å—å {days} {escape(get_day_suffix(days))}"
                client_name = escape(f"{p['first_name']} {p['last_name']}"); phone = escape(p['phone_number']); username = escape(p['username'])
                client_info = f"*{client_name}*\nüìû `{phone}` \\| @{username}\n–°—Ç–∞—Ç—É—Å: {status}"
                payment_list.append(client_info)
            message_parts.append("\n\n".join(payment_list))
        
        # <<< –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫—É –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
        keyboard = [[InlineKeyboardButton("üìà –î–æ—Ö–æ–¥/—Ä–∞—Å—Ö–æ–¥ –∑–∞ –¥—Ä—É–≥—É—é –¥–∞—Ç—É", callback_data="stats_date_select")]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await status_message.edit_text("\n\n".join(message_parts), parse_mode="MarkdownV2", reply_markup=reply_markup)
        # <<< –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ –¥–µ–Ω—å: {e}", exc_info=True)
        await status_message.edit_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}")

# –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ë–õ–û–ö –ö–û–î–ê –í –í–ê–® –û–°–ù–û–í–ù–û–ô –§–ê–ô–õ
import calendar

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
STATS_AWAIT_DATE = range(970, 971)

def _create_stats_calendar(year: int, month: int) -> InlineKeyboardMarkup:
    """–°–æ–∑–¥–∞–µ—Ç –∏–Ω–ª–∞–π–Ω-–∫–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã."""
    keyboard = []
    # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –º–µ—Å—è—Ü–∞ –∏ –≥–æ–¥–∞
    keyboard.append([InlineKeyboardButton(f"{calendar.month_name[month]} {year}", callback_data="noop")])
    # –î–Ω–∏ –Ω–µ–¥–µ–ª–∏
    keyboard.append([InlineKeyboardButton(day, callback_data="noop") for day in ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"]])

    month_calendar = calendar.monthcalendar(year, month)
    for week in month_calendar:
        row = [InlineKeyboardButton(str(day) if day != 0 else " ", callback_data=f"stats_date_{year}-{month:02d}-{day:02d}") for day in week]
        keyboard.append(row)
    
    # –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    prev_month = (datetime(year, month, 1) - timedelta(days=1)).strftime('%Y-%m')
    next_month = (datetime(year, month, 28) + timedelta(days=4)).strftime('%Y-%m')
    keyboard.append([
        InlineKeyboardButton("< –ù–∞–∑–∞–¥", callback_data=f"stats_nav_{prev_month}"),
        InlineKeyboardButton("–û—Ç–º–µ–Ω–∞", callback_data="stats_cancel"),
        InlineKeyboardButton("–í–ø–µ—Ä–µ–¥ >", callback_data=f"stats_nav_{next_month}")
    ])
    return InlineKeyboardMarkup(keyboard)

async def start_stats_date_selection(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 1: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã."""
    query = update.callback_query
    await query.answer()

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —ç—Ç–æ –ø–µ—Ä–≤—ã–π –≤—Ö–æ–¥ –∏–ª–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º
    if query.data.startswith("stats_nav_"):
        year, month = map(int, query.data.split('_')[-1].split('-'))
    else:
        today = datetime.now()
        year, month = today.year, today.month
    
    await query.edit_message_text(
        "üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤:",
        reply_markup=_create_stats_calendar(year, month)
    )
    return STATS_AWAIT_DATE

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ process_stats_date_selection –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
async def process_stats_date_selection(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 2: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–∞—Ç—É, —Å—á–∏—Ç–∞–µ—Ç —Ñ–∏–Ω–∞–Ω—Å—ã –∏ –≤—ã–≤–æ–¥–∏—Ç –ü–û–î–†–û–ë–ù–£–Æ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é."""
    query = update.callback_query
    await query.answer()

    if query.data == "stats_cancel":
        await query.edit_message_text("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
        return ConversationHandler.END

    def escape(text: str) -> str:
        return escape_markdown(str(text or ''), version=2)

    try:
        date_str = query.data.split('_')[-1]
        selected_date = datetime.strptime(date_str, '%Y-%m-%d')
        
        start_of_day = selected_date.strftime('%Y-%m-%d 00:00:00')
        end_of_day = selected_date.strftime('%Y-%m-%d 23:59:59')

        await query.edit_message_text(f"‚è≥ –°—á–∏—Ç–∞—é —Ñ–∏–Ω–∞–Ω—Å—ã –∏ –≥–æ—Ç–æ–≤–ª—é –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –∑–∞ {selected_date.strftime('%d.%m.%Y')}...")

        total_income = 0.0
        income_details = []
        total_expenses = 0.0
        expense_details = []

        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row

            # --- –°–±–æ—Ä –∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –î–û–•–û–î–û–í ---
            sql_income = """
                SELECT bh.action, bh.details, u.first_name, u.last_name, b.name as bike_name
                FROM bike_history bh
                JOIN users u ON bh.user_id = u.id
                JOIN bikes b ON bh.bike_id = b.id
                WHERE bh.timestamp BETWEEN ? AND ?
            """
            async with conn.execute(sql_income, (start_of_day, end_of_day)) as cursor:
                async for row in cursor:
                    income = _get_income_from_details(row['details'])
                    if income > 0:
                        total_income += income
                        client_name = escape(f"{row['first_name']} {row['last_name'] or ''}".strip())
                        action = escape(row['action'])
                        bike_name = escape(row['bike_name'])
                        income_details.append(f"\\- `{income:,.2f} ‚ÇΩ`: {action} \\({bike_name}\\) –æ—Ç {client_name}")

            # --- –°–±–æ—Ä –∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –†–ê–°–•–û–î–û–í ---
            sql_expenses = "SELECT item_name, amount, comment, category, subcategory FROM expenses WHERE created_at BETWEEN ? AND ?"
            async with conn.execute(sql_expenses, (start_of_day, end_of_day)) as cursor:
                async for row in cursor:
                    amount = row['amount']
                    total_expenses += amount
                    # –°–æ–±–∏—Ä–∞–µ–º –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞
                    item = row['item_name']
                    if not item:
                        try:
                            cat_details = EXPENSE_CATEGORIES[row['category']]
                            sub_details = cat_details['subcategories'][row['subcategory']]
                            item = sub_details['label'] if isinstance(sub_details, dict) else sub_details
                        except KeyError:
                            item = f"{row['category']}/{row['subcategory']}"
                    
                    expense_details.append(f"\\- `{amount:,.2f} ‚ÇΩ`: {escape(item)}")

        # --- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è ---
        message_parts = [
            f"üí∞ *–§–∏–Ω–∞–Ω—Å—ã –∑–∞ {escape(selected_date.strftime('%d.%m.%Y'))}*",
            f"üìà *–û–±—â–∏–π –¥–æ—Ö–æ–¥:* `{total_income:,.2f} ‚ÇΩ`".replace(",", " "),
            f"üìâ *–û–±—â–∏–π —Ä–∞—Å—Ö–æ–¥:* `{total_expenses:,.2f} ‚ÇΩ`".replace(",", " "),
            "\\- \\- \\- \\- \\- \\- \\- \\- \\- \\- \\- \\- \\- \\- \\- \\- \\- \\- \\- \\-",
            "*–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ—Ö–æ–¥–æ–≤:*"
        ]
        if income_details:
            message_parts.extend(income_details)
        else:
            message_parts.append("_–î–æ—Ö–æ–¥–æ–≤ –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ –±—ã–ª–æ\\._")
            
        message_parts.append("\n*–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤:*")
        if expense_details:
            message_parts.extend(expense_details)
        else:
            message_parts.append("_–†–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ –±—ã–ª–æ\\._")

        await query.edit_message_text(
            "\n".join(message_parts),
            parse_mode="MarkdownV2"
        )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å—á–µ—Ç–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤ –∑–∞ –¥–∞—Ç—É: {e}", exc_info=True)
        await query.edit_message_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞—Ç—ã.")
    
    return ConversationHandler.END

async def investment_main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–º–∏ —Å —Ç—Ä–µ–º—è –∫–Ω–æ–ø–∫–∞–º–∏."""
    keyboard = [
        [InlineKeyboardButton("üìä –°–ø–∏—Å–æ–∫ –ò–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ –∏ –∏—Ö –∞–∫—Ç–∏–≤—ã", callback_data="inv_list_investors_0")],
        [InlineKeyboardButton("‚ûï –ü—Ä–∏–≤—è–∑–∞—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥ –∫ –∏–Ω–≤–µ—Å—Ç–æ—Ä—É", callback_data="inv_assign_start")],
        [InlineKeyboardButton("üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="inv_show_stats")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    message_text = "üìà *–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–º–∏*\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    
    if update.callback_query:
        await update.callback_query.edit_message_text(message_text, reply_markup=reply_markup, parse_mode="Markdown")
    else:
        await update.message.reply_text(message_text, reply_markup=reply_markup, parse_mode="Markdown")

# --- 1. –§—É–Ω–∫—Ü–∏—è "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞" ---

async def show_investment_stats(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–°–æ–±–∏—Ä–∞–µ—Ç –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫—Ä–∞—Ç–∫—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º."""
    query = update.callback_query
    await query.answer()

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            cursor = await conn.execute("SELECT COUNT(DISTINCT investor_id) FROM bikes WHERE investor_id IS NOT NULL")
            total_investors = (await cursor.fetchone())[0]
            cursor = await conn.execute("SELECT COUNT(*) FROM bikes WHERE investor_id IS NOT NULL")
            total_investor_bikes = (await cursor.fetchone())[0]
            cursor = await conn.execute(
                """SELECT COUNT(b.id) FROM bikes b
                   JOIN bookings bk ON b.id = bk.bike_id
                   WHERE b.investor_id IS NOT NULL AND bk.status = 'rented'"""
            )
            rented_investor_bikes = (await cursor.fetchone())[0]
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–º: {e}", exc_info=True)
        await query.edit_message_text("‚ùå –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–±–æ—Ä–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.")
        return

    stats_text = (
        f"üìà *–ö—Ä–∞—Ç–∫–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–º:*\n\n"
        f"‚ñ™Ô∏è *–í—Å–µ–≥–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤:* {total_investors}\n"
        f"‚ñ™Ô∏è *–í—Å–µ–≥–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä—Å–∫–∏—Ö –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤:* {total_investor_bikes}\n"
        f"‚ñ™Ô∏è *–°–µ–π—á–∞—Å –≤ –∞—Ä–µ–Ω–¥–µ:* {rented_investor_bikes} –∏–∑ {total_investor_bikes}"
    )
    keyboard = [[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π", callback_data="inv_back_to_main")]]
    await query.edit_message_text(stats_text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode="Markdown")

# --- 2. –§—É–Ω–∫—Ü–∏—è "–°–ø–∏—Å–æ–∫ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤" ---

async def show_investor_list_details(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ –∏ –∏—Ö –∞–∫—Ç–∏–≤–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π."""
    query = update.callback_query
    await query.answer()

    page = int(query.data.split('_')[-1])
    PAGE_SIZE = 3  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ 3 –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ—Ö —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤
            cursor = await conn.execute("SELECT DISTINCT investor_id FROM bikes WHERE investor_id IS NOT NULL")
            investor_ids_rows = await cursor.fetchall()
            investor_ids = [row['investor_id'] for row in investor_ids_rows]

            if not investor_ids:
                await query.edit_message_text(
                    "–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞–º–∏.",
                    reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="inv_back_to_main")]])
                )
                return

            total_pages = (len(investor_ids) + PAGE_SIZE - 1) // PAGE_SIZE
            page = max(0, min(page, total_pages - 1))
            
            investors_on_page_ids = investor_ids[page * PAGE_SIZE : (page + 1) * PAGE_SIZE]
            
            message_parts = [f"üìä *–°–ø–∏—Å–æ–∫ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ –∏ –∏—Ö –∞–∫—Ç–∏–≤—ã (–°—Ç—Ä. {page + 1}/{total_pages})*\n"]
            
            for inv_id in investors_on_page_ids:
                # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞
                cursor = await conn.execute("SELECT first_name, last_name FROM users WHERE id = ?", (inv_id,))
                inv_info = await cursor.fetchone()
                inv_name = f"{inv_info['first_name'] or ''} {inv_info['last_name'] or ''}".strip()
                message_parts.append(f"\nüë§ *{inv_name} (ID: {inv_id})*")

                # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –µ–≥–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏—Ö –∞—Ä–µ–Ω–¥–µ
                cursor = await conn.execute(
                    """SELECT
                           b.name,
                           bk.end_date,
                           bk.booking_type,
                           u_rent.first_name as renter_fname,
                           u_rent.last_name as renter_lname
                       FROM bikes b
                       LEFT JOIN bookings bk ON b.id = bk.bike_id AND bk.status = 'rented'
                       LEFT JOIN users u_rent ON bk.user_id = u_rent.id
                       WHERE b.investor_id = ?""",
                    (inv_id,)
                )
                bikes = await cursor.fetchall()
                
                if not bikes:
                    message_parts.append("  _–ù–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤._")
                else:
                    for bike in bikes:
                        status_text = ""
                        if bike['end_date']: # –ï—Å–ª–∏ –µ—Å—Ç—å –∞—Ä–µ–Ω–¥–∞
                            renter_name = f"{bike['renter_fname'] or ''} {bike['renter_lname'] or ''}".strip()
                            status_text = f"->  rented by *{renter_name}* until {bike['end_date']}"
                        else:
                            status_text = "-> ‚úÖ *–°–≤–æ–±–æ–¥–µ–Ω*"
                        message_parts.append(f"  üö≤ `{bike['name']}` {status_text}")
            
            keyboard = []
            nav_row = []
            if page > 0:
                nav_row.append(InlineKeyboardButton("‚¨ÖÔ∏è", callback_data=f"inv_list_investors_{page - 1}"))
            if page < total_pages - 1:
                nav_row.append(InlineKeyboardButton("‚û°Ô∏è", callback_data=f"inv_list_investors_{page + 1}"))
            if nav_row:
                keyboard.append(nav_row)
            
            keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π", callback_data="inv_back_to_main")])

            await query.edit_message_text(
                "\n".join(message_parts),
                reply_markup=InlineKeyboardMarkup(keyboard),
                parse_mode="Markdown"
            )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ —Å–ø–∏—Å–∫–∞ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤: {e}", exc_info=True)
        await query.edit_message_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞.")

# --- 3. –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è "–ü—Ä–∏–≤—è–∑–∫–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –∫ –∏–Ω–≤–µ—Å—Ç–æ—Ä—É" (ConversationHandler) ---

async def assign_asset_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 1: –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–∏—Å–∫ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞."""
    query = update.callback_query
    await query.answer()
    context.user_data.clear()
    await query.edit_message_text("üîç *–®–∞–≥ 1/2: –í—ã–±–æ—Ä –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞*\n\n–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é –∏–ª–∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–∏—Å–∫–∞:")
    return INV_AWAIT_USER_SEARCH

async def search_user_for_assign(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."""
    search_term = update.message.text.strip()
    
    async with aiosqlite.connect(DB_FILE) as conn:
        cursor = await conn.execute(
            "SELECT id, first_name, last_name FROM users WHERE last_name LIKE ? OR id LIKE ?",
            (f"%{search_term}%", f"%{search_term}%")
        )
        users = await cursor.fetchall()

    if not users:
        await update.message.reply_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ /cancel –¥–ª—è –æ—Ç–º–µ–Ω—ã.")
        return INV_AWAIT_USER_SEARCH

    keyboard = [[InlineKeyboardButton(
        f"{user[2] or ''} {user[1] or ''} (ID: {user[0]})",
        callback_data=f"inv_assign_user_{user[0]}"
    )] for user in users]
    await update.message.reply_text("–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:", reply_markup=InlineKeyboardMarkup(keyboard))
    return INV_SELECT_USER

async def select_user_for_assign(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 2: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞ –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–∏—Å–∫ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞."""
    query = update.callback_query
    await query.answer()
    
    investor_id = int(query.data.split('_')[-1])
    context.user_data['assign_investor_id'] = investor_id
    
    await query.edit_message_text("‚úÖ –ò–Ω–≤–µ—Å—Ç–æ—Ä –≤—ã–±—Ä–∞–Ω.\n\n"
                                  "üîç *–®–∞–≥ 2/2: –í—ã–±–æ—Ä –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞*\n\n"
                                  "–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ VIN —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞:")
    return INV_AWAIT_BIKE_SEARCH

async def search_bike_for_assign(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Å–≤–æ–±–æ–¥–Ω—ã–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã."""
    search_term = update.message.text.strip()

    async with aiosqlite.connect(DB_FILE) as conn:
        cursor = await conn.execute(
            "SELECT id, name FROM bikes WHERE name LIKE ? AND investor_id IS NULL AND type = 'bike'",
            (f"%{search_term}%",)
        )
        bikes = await cursor.fetchall()
        
    if not bikes:
        await update.message.reply_text("‚ùå –°–≤–æ–±–æ–¥–Ω—ã–π –≤–µ–ª–æ—Å–∏–ø–µ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ /cancel –¥–ª—è –æ—Ç–º–µ–Ω—ã.")
        return INV_AWAIT_BIKE_SEARCH
        
    keyboard = [[InlineKeyboardButton(
        bike[1], callback_data=f"inv_assign_bike_{bike[0]}"
    )] for bike in bikes]
    await update.message.reply_text("–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å–≤–æ–±–æ–¥–Ω—ã–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã:", reply_markup=InlineKeyboardMarkup(keyboard))
    return INV_SELECT_BIKE

async def finalize_assign(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–§–∏–Ω–∞–ª: –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–µ–ª–æ—Å–∏–ø–µ–¥ –∫ –∏–Ω–≤–µ—Å—Ç–æ—Ä—É."""
    query = update.callback_query
    await query.answer()

    bike_id = int(query.data.split('_')[-1])
    investor_id = context.user_data['assign_investor_id']
    
    async with aiosqlite.connect(DB_FILE) as conn:
        conn.row_factory = aiosqlite.Row
        await conn.execute("UPDATE bikes SET investor_id = ? WHERE id = ?", (investor_id, bike_id))
        await conn.commit()
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–º–µ–Ω–∞ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        cursor = await conn.execute("SELECT name FROM bikes WHERE id = ?", (bike_id,))
        bike_name = (await cursor.fetchone())['name']
        cursor = await conn.execute("SELECT first_name, last_name FROM users WHERE id = ?", (investor_id,))
        inv_info = await cursor.fetchone()
        inv_name = f"{inv_info['first_name'] or ''} {inv_info['last_name'] or ''}".strip()

    await query.edit_message_text(f"‚úÖ –£—Å–ø–µ—à–Ω–æ!\n–í–µ–ª–æ—Å–∏–ø–µ–¥ ¬´{bike_name}¬ª –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∏–Ω–≤–µ—Å—Ç–æ—Ä—É ¬´{inv_name}¬ª.")
    
    context.user_data.clear()
    await investment_main_menu(update, context) # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π
    return ConversationHandler.END

async def cancel_assign(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û—Ç–º–µ–Ω—è–µ—Ç –¥–∏–∞–ª–æ–≥ –ø—Ä–∏–≤—è–∑–∫–∏."""
    context.user_data.clear()
    message = update.message or update.callback_query.message
    
    # –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    await context.bot.send_message(chat_id=message.chat_id, text="–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    
    # –ó–∞—Ç–µ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π
    if update.callback_query:
         update.callback_query.message.text = "" # —Ö–∞–∫, —á—Ç–æ–±—ã –º—ã –º–æ–≥–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await investment_main_menu(update, context)
    return ConversationHandler.END
    
# ==============================================================================
#           –ö–û–ù–ï–¶ –ú–û–î–£–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–ù–í–ï–°–¢–ò–¶–ò–Ø–ú–ò
# ==============================================================================



# <<< –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê >>>
async def show_tariffs(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã –Ω–∞ –∞—Ä–µ–Ω–¥—É –∏ –≤—ã–∫—É–ø."""
    text = """
üí∞ *–ù–∞—à–∏ —Ç–∞—Ä–∏—Ñ—ã*

*–ê–†–ï–ù–î–ê (—Ü–µ–Ω–∞ –∑–∞ –Ω–µ–¥–µ–ª—é):*
- Kugoo / Liming: *3 500 ‚ÇΩ*
- Kugoo —Å 2 –ê–ö–ë: *4 500 ‚ÇΩ*
- Wenbox: *5 000 ‚ÇΩ*
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ê–ö–ë: *1 000 ‚ÇΩ*

*–í–´–ö–£–ü (–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂):*
- Kugoo / Liming (1 –ê–ö–ë): *5 000 ‚ÇΩ / 15 –Ω–µ–¥–µ–ª—å*
- Kugoo (2 –ê–ö–ë): *6 000 ‚ÇΩ / 15 –Ω–µ–¥–µ–ª—å*
- Wenbox U3: *10 000 ‚ÇΩ / 12 –Ω–µ–¥–µ–ª—å*

üéÅ *–ê–∫—Ü–∏–∏:*
- ¬´–ü–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ –±–µ–∑ –∑–∞–ª–æ–≥–∞¬ª –¥–ª—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤.
- ¬´–ü—Ä–∏–≤–µ–¥–∏ –¥—Ä—É–≥–∞¬ª –∏ –ø–æ–ª—É—á–∏ 1 –¥–µ–Ω—å –∞—Ä–µ–Ω–¥—ã –±–µ—Å–ø–ª–∞—Ç–Ω–æ.

üîπ*–ö–∞–∫ –æ–ø–ª–∞—Ç–∏—Ç—å?*
- –û–ø–ª–∞—Ç–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –ø–æ –°–ë–ü.
    """
    await update.message.reply_text(text, parse_mode="Markdown")

async def show_rules(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–º."""
    text = """
üìú *–ü—Ä–∞–≤–∏–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è*

üìå *–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è:*
‚Ä¢ –ê—Ä–µ–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–∏—Ü —Å—Ç–∞—Ä—à–µ 18 –ª–µ—Ç.
‚Ä¢ –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Å–ø–æ—Ä—Ç (–¥–ª—è –≥—Ä–∞–∂–¥–∞–Ω –†–§/–°–ù–ì) –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç, —É–¥–æ—Å—Ç–æ–≤–µ—Ä—è—é—â–∏–π –ª–∏—á–Ω–æ—Å—Ç—å (–¥–ª—è –∏–Ω–æ—Å—Ç—Ä–∞–Ω—Ü–µ–≤).
‚Ä¢ –ó–∞–ª–æ–≥ 0 ‚ÇΩ –ø–æ –∞–∫—Ü–∏–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ (–ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏).

üìå *–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞:*
‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥ —Ç–æ–ª—å–∫–æ –≤ —Ä–∞–±–æ—á–∏—Ö —Ü–µ–ª—è—Ö (–¥–æ—Å—Ç–∞–≤–∫–∞).
‚Ä¢ –ù–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏.
‚Ä¢ –°–æ–æ–±—â–∞—Ç—å –æ –ø–æ–ª–æ–º–∫–∞—Ö –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤.

üìå *–í–æ–∑–≤—Ä–∞—Ç –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞:*
‚Ä¢ –í —á–∏—Å—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.
‚Ä¢ –ü—Ä–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è—Ö ‚Äî —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–º–æ–Ω—Ç–∞.

üìå *–°–∞–Ω–∫—Ü–∏–∏:*
‚Ä¢ –ü—Ä–∏ —É—Ç–µ—Ä–µ ‚Äî —à—Ç—Ä–∞—Ñ –≤ —Ä–∞–∑–º–µ—Ä–µ —Ä—ã–Ω–æ—á–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏.
‚Ä¢ –ü—Ä–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ —Å—Ä–æ–∫–æ–≤ –∞—Ä–µ–Ω–¥—ã ‚Äî 700 ‚ÇΩ –∑–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø—Ä–æ—Å—Ä–æ—á–∫–∏.
‚Ä¢ –ü–µ—Ä–µ–¥–∞—á–∞ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º –±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏ ‚Äî —à—Ç—Ä–∞—Ñ –≤ —Ä–∞–∑–º–µ—Ä–µ 10 000 ‚ÇΩ.
‚Ä¢ –ü—É–±–ª–∏—á–Ω–∞—è –æ—Ñ–µ—Ä—Ç–∞ - https://badfoxbike.ru/oferta.html
‚Ä¢ –ü–æ–ª–æ–∂–µ–Ω–∏–µ –æ–± –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö https://badfoxbike.ru/privacy-policy.html
    """
    # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∞ PDF —Å –æ—Ñ–µ—Ä—Ç–æ–π
    # keyboard = [[InlineKeyboardButton("–°–∫–∞—á–∞—Ç—å –ø—É–±–ª–∏—á–Ω—É—é –æ—Ñ–µ—Ä—Ç—É (PDF)", url="https://...")]]
    # await update.message.reply_text(text, parse_mode="Markdown", reply_markup=InlineKeyboardMarkup(keyboard))
    await update.message.reply_text(text, parse_mode="Markdown")


async def show_repair_info(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é, –∫–∞–∫ —Å–æ–æ–±—â–∏—Ç—å –æ –ø–æ–ª–æ–º–∫–µ."""
    text = """
üõ†Ô∏è *–ö–∞–∫ —Å–æ–æ–±—â–∏—Ç—å –æ –ø–æ–ª–æ–º–∫–µ –∏–ª–∏ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–∏:*

–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ: @BFbike

1. –£–∫–∞–∂–∏—Ç–µ –º–æ–¥–µ–ª—å –∏ VIN –Ω–æ–º–µ—Ä –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞.
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è.
3. –û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: ¬´–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ—Ä–º–æ–∑¬ª, ¬´–±—ã—Å—Ç—Ä–æ —Ä–∞–∑—Ä—è–∂–∞–µ—Ç—Å—è –±–∞—Ç–∞—Ä–µ—è¬ª).
    """
    await update.message.reply_text(text, parse_mode="Markdown")


async def show_contacts(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é."""
    text = """
üìû *–ù–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã*

üåê *–°–∞–π—Ç:* http://badfoxbike.ru/

üì≤ *–°–≤—è–∑—å:*
‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤: @BFbike (Telegram)
‚Ä¢ –ù–æ–≤–æ—Å—Ç–Ω–æ–π –∫–∞–Ω–∞–ª: @badfoxbike (Telegram)
‚Ä¢ –¢–µ–ª–µ—Ñ–æ–Ω: `+79175705479`

üìç *–ê–¥—Ä–µ—Å –ø—É–Ω–∫—Ç–∞ –≤—ã–¥–∞—á–∏:*
–ú–æ—Å–∫–≤–∞, –º. –ù–æ–≤–æ–∫–æ—Å–∏–Ω–æ, —É–ª. –°–∞–ª—Ç—ã–∫–æ–≤—Å–∫–∞—è, –¥. 53

üïí *–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã:*
‚Ä¢ –ü–Ω‚Äì–ü—Ç: 10:00‚Äì23:00
‚Ä¢ –°–±‚Äì–í—Å: 11:00‚Äì22:00

*–í–∞–∂–Ω–æ!*
- –ë—Ä–æ–Ω–∏—Ä—É–π—Ç–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥ –∑–∞—Ä–∞–Ω–µ–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞, —á—Ç–æ–±—ã –∑–∞–±—Ä–∞—Ç—å –µ–≥–æ –±–µ–∑ –æ—á–µ—Ä–µ–¥–∏.
- –î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞ –ø—Ä–∏ —Å–µ–±–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏–º–µ—Ç—å –ø–∞—Å–ø–æ—Ä—Ç.
    """
    await update.message.reply_text(text, parse_mode="Markdown")

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
notifications = []

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –º–µ—Å—è—Ü–µ–≤ –Ω–∞ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫
MONTHS_RU = {
    1: "—è–Ω–≤–∞—Ä—è",
    2: "—Ñ–µ–≤—Ä–∞–ª—è",
    3: "–º–∞—Ä—Ç–∞",
    4: "–∞–ø—Ä–µ–ª—è",
    5: "–º–∞—è",
    6: "–∏—é–Ω—è",
    7: "–∏—é–ª—è",
    8: "–∞–≤–≥—É—Å—Ç–∞",
    9: "—Å–µ–Ω—Ç—è–±—Ä—è",
    10: "–æ–∫—Ç—è–±—Ä—è",
    11: "–Ω–æ—è–±—Ä—è",
    12: "–¥–µ–∫–∞–±—Ä—è"
}
# –ü–æ–º–µ—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫ –≤ –Ω–∞—á–∞–ª–æ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞, –≥–¥–µ —É –≤–∞—Å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
PAYMENT_ANIMATIONS = [
    ["üö≤", "üí®", "üè¢", "‚úÖ"], # –í–µ–ª–æ—Å–∏–ø–µ–¥ –µ–¥–µ—Ç –∫ –∑–¥–∞–Ω–∏—é
    ["üíµ", "‚û°Ô∏è", "üè¶", "üëç"], # –î–µ–Ω—å–≥–∏ –∏–¥—É—Ç –≤ –±–∞–Ω–∫
    ["üìÑ", "‚úçÔ∏è", "‚û°Ô∏è", "üéâ"], # –î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è
    ["üîë", "‚û°Ô∏è", "üö≤", "ü§ù"]  # –ö–ª—é—á–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è
]

# ### –ù–û–í–ê–Ø, –ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
async def add_notification(message: str):
    """
    –ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –í–ï–†–°–ò–Ø: –î–æ–±–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, –Ω–µ –±–ª–æ–∫–∏—Ä—É—è –µ–µ.
    """
    now = datetime.now()
    day = now.day
    month = MONTHS_RU.get(now.month, "??") # –î–æ–±–∞–≤–∏–ª .get –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    time = now.strftime('%H:%M')
    timestamp = f"{day} {month} {time}"

    try:
        async with aiosqlite.connect(DB_FILE, timeout=10) as conn:
            await conn.execute(
                "INSERT INTO notifications (timestamp, message) VALUES (?, ?)",
                (timestamp, message)
            )
            await conn.commit()
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –ë–î: {e}", exc_info=True)

KEYWORD_CATEGORIES = {
    # –ö–∞—Ç–µ–≥–æ—Ä–∏—è: [—Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤]
    "–±—Ä–æ–Ω—å": ["–±—Ä–æ–Ω—å", "–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ", "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω", "–æ—Ç–º–µ–Ω–∞ –±—Ä–æ–Ω–∏"],
    "–∞—Ä–µ–Ω–¥–∞": ["–∞—Ä–µ–Ω–¥–∞", "–∞—Ä–µ–Ω–¥—É", "–∞—Ä–µ–Ω–¥—ã", "–æ–ø–ª–∞—Ç–∞ –∞—Ä–µ–Ω–¥—ã"],
    "—Ä–µ–º–æ–Ω—Ç": ["—Ä–µ–º–æ–Ω—Ç", "–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞", "–ø–æ—á–∏–Ω–∫–∞", "–ø—Ä–∏–Ω—è—Ç –≤ —Ä–∞–±–æ—Ç—É"],
    "—Å–æ–≥–ª–∞—Å–∏–µ": ["—Å–æ–≥–ª–∞—Å–∏–µ", "—É—Å–ª–æ–≤–∏—è –∞—Ä–µ–Ω–¥—ã", "–¥–æ–≥–æ–≤–æ—Ä"],
    "—Å–¥–∞—á–∞": ["—Å–¥–∞—á–∞", "–≤–æ–∑–≤—Ä–∞—Ç", "–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã"],
    '—à—Ç—Ä–∞—Ñ': ['—à—Ç—Ä–∞—Ñ', '–æ–ø–ª–∞—Ç–∞', '–Ω–∞–∑–Ω–∞—á–µ–Ω', '–ø–µ–Ω–∏', '—Å–∞–Ω–∫—Ü–∏—è'],
    "–ø—Ä–æ–¥–ª–µ–Ω–∏–µ": ["–ø—Ä–æ–¥–ª–µ–Ω–∏–µ", "–ø—Ä–æ–¥–ª–µ–Ω", "–∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ"]
}

SELECT_DATE, CHOOSE_HISTORY_TYPE = range(2)
INPUT_SURNAME, INPUT_BIKE_NAME = range(2, 4)
INPUT_KEYWORD = 4
async def search_by_keyword(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏
    help_text = """üîç *–ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º*\n
–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:
- –ë—Ä–æ–Ω—å (`–±—Ä–æ–Ω—å`, `–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ`, `–æ—Ç–º–µ–Ω–∞`)
- –ê—Ä–µ–Ω–¥–∞ (`–∞—Ä–µ–Ω–¥–∞`, `–æ–ø–ª–∞—Ç–∞`, `—Å–¥–∞—á–∞`)
- –†–µ–º–æ–Ω—Ç (`—Ä–µ–º–æ–Ω—Ç`, `–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞`)
- –ü—Ä–æ–¥–ª–µ–Ω–∏–µ (`–ø—Ä–æ–¥–ª–µ–Ω–∏–µ`, `–∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ`)
- –°–æ–≥–ª–∞—Å–∏–µ (`—Å–æ–≥–ª–∞—Å–∏–µ`, `–¥–æ–≥–æ–≤–æ—Ä`)

–ü—Ä–∏–º–µ—Ä—ã:
- `–∞—Ä–µ–Ω–¥–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ`
- `—Ä–µ–º–æ–Ω—Ç 15.07`
- `–±—Ä–æ–Ω—å –æ—Ç–º–µ–Ω–∞`"""

    await query.message.reply_text(help_text, parse_mode="Markdown")
    await query.message.reply_text("‚úèÔ∏è –í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å:")
    return INPUT_KEYWORD

class SearchLogger:
    @staticmethod
    async def log_search_context(context: dict, user_id: int):
        try:
            search_params = context.get('search_params', {})
            log_message = [
                f"üîç [Search Log] User: {user_id}",
                f"üìù Raw query: {context.get('search_keyword', '')}",
                f"üîë Keywords: {', '.join(search_params.get('keywords', []))}",
                f"üö≤ Bikes: {', '.join(search_params.get('bike_names', []))}",
                f"üë§ Surnames: {', '.join(search_params.get('surnames', []))}",
                f"üìÖ Date range: {search_params.get('date_from', 'N/A')} - {search_params.get('date_to', 'N/A')}",
                f"üî¢ Results: {len(context.get('search_results', []))} items"
            ]
            logger.info("\n".join(log_message))
        except Exception as e:
            logger.error(f"Error in search logging: {str(e)}")
import json
import re
from datetime import datetime, timedelta
import logging
from telegram import Update
from telegram.ext import ContextTypes
import json

logger = logging.getLogger(__name__)

async def execute_query(query, params):
    """–ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤."""
    # –í —Ä–µ–∞–ª—å–Ω–æ–º –∫–æ–¥–µ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    return []

import os
import logging
import sys
from datetime import datetime
from telegram import Update
from telegram.error import TelegramError
from telegram.ext import ContextTypes

# –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç—å –ø–æ–∏—Å–∫–∞ –º–æ–¥—É–ª–µ–π
current_dir = os.path.dirname(os.path.abspath(__file__))
if current_dir not in sys.path:
    sys.path.append(current_dir)

from admin_reports import generate_daily_report, is_admin

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logger = logging.getLogger(__name__)
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

import os
import logging
from datetime import datetime
from telegram import Update, BotCommand
from telegram.ext import Application, CommandHandler, ContextTypes
from admin_reports import generate_daily_report, is_admin

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logger = logging.getLogger(__name__)
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

async def generate_report_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /otchet –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞.
    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /otchet [DD.MM.YYYY]
    """
    user_id = update.effective_user.id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
    if not is_admin(user_id):
        await update.message.reply_text("‚õîÔ∏è –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
        return

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥—ã –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
    try:
        if context.args and len(context.args) > 0:
            report_date = datetime.strptime(context.args[0], '%d.%m.%Y').strftime('%d.%m.%Y')
        else:
            report_date = datetime.now().strftime('%d.%m.%Y')

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞
        status_message = await update.message.reply_text("‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞...")

        try:
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ reports
            reports_dir = os.path.join(os.path.dirname(__file__), 'reports')
            os.makedirs(reports_dir, exist_ok=True)

            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
            report_filename = generate_daily_report(report_date)
            excel_filename = report_filename.replace('.txt', '.xlsx')

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
            if not os.path.exists(report_filename):
                raise FileNotFoundError(f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ñ–∞–π–ª –æ—Ç—á–µ—Ç–∞: {report_filename}")
            if not os.path.exists(excel_filename):
                raise FileNotFoundError(f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ Excel —Ñ–∞–π–ª: {excel_filename}")

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Excel —Ñ–∞–π–ª
            with open(excel_filename, 'rb') as excel_file:
                await update.message.reply_document(
                    document=excel_file,
                    filename=f"report_{report_date.replace('.', '')}.xlsx",
                    caption=f"üìä –û—Ç—á–µ—Ç –∑–∞ {report_date}"
                )

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç
            with open(report_filename, 'rb') as text_file:
                await update.message.reply_document(
                    document=text_file,
                    filename=f"report_{report_date.replace('.', '')}.txt",
                    caption=f"üìù –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á–µ—Ç –∑–∞ {report_date}"
                )

            # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            await status_message.delete()

        except Exception as e:
            error_msg = f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞: {str(e)}"
            logger.error(error_msg)
            await status_message.edit_text(error_msg)

    except ValueError:
        await update.message.reply_text(
            "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç –î–î.–ú–ú.–ì–ì–ì–ì\n"
            "–ù–∞–ø—Ä–∏–º–µ—Ä: /otchet 18.02.2025"
        )

from datetime import datetime, timedelta
import re
import logging
from telegram import Update
from telegram.ext import ContextTypes, ConversationHandler
import json

logger = logging.getLogger(__name__)

from datetime import datetime, date  # –î–æ–±–∞–≤–ª—è–µ–º –∏–º–ø–æ—Ä—Ç date
import re
import logging
from telegram import Update
from telegram.ext import ContextTypes, ConversationHandler
import json

logger = logging.getLogger(__name__)

from datetime import datetime, date
import re
import logging

logger = logging.getLogger(__name__)

def parse_date(date_str: str) -> date:
    """
    –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞—Ç—ã –∏–∑ —Å—Ç—Ä–æ–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM[.YY[YY]].
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç date –∏–ª–∏ None, –µ—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞.
    """
    # –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∞ DD.MM[.YY[YY]]
    date_pattern = re.compile(r'^(\d{1,2})\.(\d{1,2})(?:\.(\d{2,4}))?$')
    match = date_pattern.match(date_str)

    if not match:
        logger.warning(f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã: {date_str}")
        return None

    try:
        # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–Ω—è, –º–µ—Å—è—Ü–∞ –∏ –≥–æ–¥–∞
        day = int(match.group(1))
        month = int(match.group(2))
        year_part = match.group(3)

        # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≥–æ–¥–∞
        if year_part:
            if len(year_part) == 2:
                # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–≤—É—Ö–∑–Ω–∞—á–Ω–æ–≥–æ –≥–æ–¥–∞ –≤ —á–µ—Ç—ã—Ä–µ—Ö–∑–Ω–∞—á–Ω—ã–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, 25 -> 2025)
                year = 2000 + int(year_part)
            else:
                # –ß–µ—Ç—ã—Ä–µ—Ö–∑–Ω–∞—á–Ω—ã–π –≥–æ–¥
                year = int(year_part)
        else:
            # –ï—Å–ª–∏ –≥–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π –≥–æ–¥
            year = datetime.now().year

        # –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ date
        return date(year, month, day)

    except ValueError as e:
        logger.warning(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç—ã {date_str}: {str(e)}")
        return None

import re
from datetime import datetime, timedelta
import json
from typing import Any


import re
from datetime import datetime, timedelta
import json
from typing import Any

# –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã


import re
from datetime import datetime, timedelta, date
import json
import logging
from typing import Any

logger = logging.getLogger(__name__)


async def handle_keyword_input(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    try:
        user = update.message.from_user
        raw_query = update.message.text.strip().lower()
        logger.info(f"üîé New search from {user.full_name} (ID: {user.id}): '{raw_query}'")

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–∏—Å–∫–∞
        search_params = {
            'keywords': [],
            'surnames': [],
            'bike_names': [],
            'date_from': None,
            'date_to': None
        }
        used_parts = set()

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –¥–∞—Ç —Å –ø—Ä–æ–±–µ–ª–∞–º–∏ –≤–æ–∫—Ä—É–≥ –¥–µ—Ñ–∏—Å–∞
        date_range_pattern = re.compile(
            r'(\d{1,2}\.\d{1,2}(?:\.\d{2,4})?)\s*-\s*(\d{1,2}\.\d{1,2}(?:\.\d{2,4})?)'
        )
        date_ranges = date_range_pattern.findall(raw_query)

        # –û—á–∏—â–∞–µ–º –∑–∞–ø—Ä–æ—Å –æ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ –¥–∞—Ç
        cleaned_query = date_range_pattern.sub('', raw_query).strip()

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤
        for start_str, end_str in date_ranges:
            start_date = parse_date(start_str)
            end_date = parse_date(end_str)
            if start_date and end_date:
                search_params['date_from'] = start_date
                search_params['date_to'] = end_date + timedelta(days=1)  # –í–∫–ª—é—á–∞–µ–º –∫–æ–Ω–µ—á–Ω—É—é –¥–∞—Ç—É

        # –†–∞–∑–±–∏–≤–∞–µ–º –û–ß–ò–©–ï–ù–ù–´–ô –∑–∞–ø—Ä–æ—Å –Ω–∞ —á–∞—Å—Ç–∏
        parts = re.split(r'\s+', cleaned_query)

        # –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç—ã
        date_pattern = re.compile(r'^\d{1,2}\.\d{1,2}(?:\.\d{2,4})?$')

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–∏–Ω–æ—á–Ω—ã—Ö –¥–∞—Ç (–µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å)
        for part in parts:
            if part in used_parts:
                continue
            if date_pattern.match(part):  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —á–∞—Å—Ç—å –¥–∞—Ç–æ–π
                current_date = parse_date(part)
                if current_date:
                    # –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–µ –¥–∞—Ç—ã
                    if not search_params['date_from']:
                        search_params['date_from'] = current_date
                        search_params['date_to'] = current_date + timedelta(days=1)
                    used_parts.add(part)
            else:
                logger.debug(f"‚ö†Ô∏è –ù–µ —è–≤–ª—è–µ—Ç—Å—è –¥–∞—Ç–æ–π: {part}")

        # –ü–æ–∏—Å–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤
        remaining_terms = [p for p in parts if p not in used_parts]
        if remaining_terms:
            bike_phrases = []
            # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º –≤—Å—é —Ñ—Ä–∞–∑—É —Ü–µ–ª–∏–∫–æ–º
            full_phrase = ' '.join(remaining_terms)
            bikes = await execute_query(
                "SELECT name FROM bikes WHERE LOWER(name) LIKE ?",
                (f"%{full_phrase}%",)
            )
            if bikes:
                search_params['bike_names'].append(full_phrase)
                used_parts.update(remaining_terms)
                bike_phrases.append(full_phrase)
            else:
                # –ò—â–µ–º –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ —Å–ª–æ–≤ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø–æ—Ä—è–¥–∫–∞
                max_terms = 3
                for length in range(len(remaining_terms), 0, -1):
                    for start in range(0, len(remaining_terms) - length + 1):
                        phrase = ' '.join(remaining_terms[start:start+length])
                        if any(term in used_parts for term in phrase.split()):
                            continue
                        bikes = await execute_query(
                            "SELECT name FROM bikes WHERE LOWER(name) LIKE ?",
                            (f"%{phrase}%",)
                        )
                        if bikes:
                            search_params['bike_names'].append(phrase)
                            used_parts.update(phrase.split())
                            bike_phrases.append(phrase)
                            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã
                            remaining_terms = [t for t in remaining_terms if t not in used_parts]
                            break

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–º–∏–ª–∏–π —Å —É—á–µ—Ç–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞
        original_parts = [p.strip() for p in update.message.text.split()]  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–≥–∏—Å—Ç—Ä
        for part in original_parts:
            if part.lower() in used_parts:
                continue
            part_lower = part.lower()
            if part_lower != '-' and len(part_lower) > 1:
                # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤–≤–æ–¥: "–ø–∞—Ç—Ä—É—à–µ–≤" -> "–ü–∞—Ç—Ä—É—à–µ–≤"
                capitalized_part = part.capitalize()

                # –ü–æ–∏—Å–∫ –ø–æ —Ç–æ—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é —Å —É—á–µ—Ç–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞
                surnames = await execute_query(
                    "SELECT last_name FROM users WHERE last_name = ?",
                    (capitalized_part,)
                )

                if surnames:
                    search_params['surnames'].append(capitalized_part)
                    used_parts.add(part_lower)
                    logger.debug(f"‚úÖ –ù–∞–π–¥–µ–Ω–∞ —Ñ–∞–º–∏–ª–∏—è: {capitalized_part}")

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
        for part in parts:
            if part in used_parts:
                continue
            for category, keywords in KEYWORD_CATEGORIES.items():
                if part in keywords or any(kw in part for kw in keywords):
                    search_params['keywords'].extend(keywords)
                    used_parts.add(part)
                    logger.debug(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ: {part}")
                    break

        # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø–æ–∏—Å–∫–∞
        logger.debug(f"Parsed search params: {json.dumps(search_params, default=str)}")

        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ SQL –∑–∞–ø—Ä–æ—Å–∞
        query_params = []
        conditions = []
        joins = []

        # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞
        if search_params['keywords']:
            keyword_conditions = []
            for keyword in set(search_params['keywords']):
                keyword_conditions.extend([
                    "LOWER(bh.action) LIKE ?",
                    "LOWER(bh.details) LIKE ?"
                ])
                query_params.extend([f"%{keyword}%", f"%{keyword}%"])
            conditions.append(f"({' OR '.join(keyword_conditions)})")

        # –ù–∞–∑–≤–∞–Ω–∏—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤
        if search_params['bike_names']:
            joins.append("JOIN bikes b ON bh.bike_id = b.id")
            bike_conditions = []
            for name in search_params['bike_names']:
                bike_conditions.append("LOWER(b.name) LIKE ?")
                query_params.append(f"%{name}%")
            conditions.append(f"({' OR '.join(bike_conditions)})")

        # –§–∞–º–∏–ª–∏–∏ (—Ä–µ–≥–∏—Å—Ç—Ä–æ–∑–∞–≤–∏—Å–∏–º—ã–π –ø–æ–∏—Å–∫)
        if search_params['surnames']:
            joins.append("JOIN users u ON bh.user_id = u.id")
            surname_conditions = []
            for surname in search_params['surnames']:
                surname_conditions.append("u.last_name LIKE ?")  # –†–µ–≥–∏—Å—Ç—Ä–æ–∑–∞–≤–∏—Å–∏–º—ã–π –ø–æ–∏—Å–∫
                query_params.append(f"%{surname}%")  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é (—Å –∑–∞–≥–ª–∞–≤–Ω–æ–π) —Ñ–∞–º–∏–ª–∏—é
            conditions.append(f"({' OR '.join(surname_conditions)})")

        # –î–∞—Ç—ã (—Å —É—á–µ—Ç–æ–º —Ñ–æ—Ä–º–∞—Ç–∞ DD.MM.YY)
        if search_params['date_from'] and search_params['date_to']:
            date_from_str = search_params['date_from'].strftime('%d.%m.%y')
            date_to_str = search_params['date_to'].strftime('%d.%m.%y')
            conditions.append(
                "bh.timestamp BETWEEN ? AND ?"
            )
            query_params.extend([date_from_str, date_to_str])

        # –°–±–æ—Ä–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
        base_query = f"""
            SELECT bh.id, bh.action, bh.details,
                    bh.timestamp as date,  -- –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç DD.MM.YY
                   bh.user_id, bh.bike_id
            FROM bike_history bh
            {' '.join(joins)}
            {f"WHERE {' AND '.join(conditions)}" if conditions else ""}
            ORDER BY
                 substr(bh.timestamp, 7, 2) ||  -- –ì–æ–¥ (YY)
                 substr(bh.timestamp, 4, 2) ||  -- –ú–µ—Å—è—Ü (MM)
                 substr(bh.timestamp, 1, 2) DESC  -- –î–µ–Ω—å (DD)
        """

        # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
        results = await execute_query(base_query, query_params)
        logger.debug(f"Found {len(results)} results")

        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        context.user_data.update({
            'search_results': results,
            'current_search_page': 0,
            'search_keyword': raw_query,
            'search_params': search_params
        })

        # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        await show_search_results(update, context, 'keyword')
        return ConversationHandler.END

    except Exception as e:
        logger.error(f"Error in handle_keyword_input: {str(e)}", exc_info=True)
        await update.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞")
        return ConversationHandler.END


async def show_action_details(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data

    def escape_md(text):
        return re.sub(r"([_*\[\]()~`>#+\-=|.!{}])", r"\\\1", str(text))

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏
    if data.startswith('full_history_page_'):
        page = int(data.split('_')[-1])
        results = context.user_data.get('search_results', [])
        page_size = 5
        total_pages = (len(results) + page_size - 1) // page_size
        start_idx = page * page_size
        end_idx = (page + 1) * page_size

        if page < 0 or start_idx >= len(results):
            await query.answer("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è")
            return

        message_text = (
            "üìú *–ü–û–õ–ù–ê–Ø –ò–°–¢–û–†–ò–Ø –î–ï–ô–°–¢–í–ò–ô*\n\n"
            "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n"
        )

        for action in results[start_idx:end_idx]:
            action_id, action_name, details, date, user_id, bike_id = action

            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ –ø—É—Å—Ç–æ—Ç—É
            user = await execute_query(
                "SELECT first_name, last_name FROM users WHERE id = ?",
                (user_id,)
            ) if user_id else None

            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω"
            if user and len(user) > 0:
                first_name = user[0][0] or ""
                last_name = user[0][1] or ""
                user_name = f"{first_name} {last_name}".strip()

            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ –ø—É—Å—Ç–æ—Ç—É
            bike_name = "‚Äì"
            if bike_id and bike_id != 0:
                bike = await execute_query(
                    "SELECT name FROM bikes WHERE id = ?",
                    (bike_id,)
                )
                if bike and len(bike) > 0:
                    bike_name = bike[0][0] or "‚Äì"

            entry = (
                f"‚ïë üÜî *ID –¥–µ–π—Å—Ç–≤–∏—è:* \\#{escape_md(action_id)}\n"
                f"‚ïë üè∑Ô∏è *–¢–∏–ø:* {escape_md(action_name)}\n"
                f"‚ïë üë§ *–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:* {escape_md(user_name)}\n"
                f"‚ïë üö¥ *–í–µ–ª–æ—Å–∏–ø–µ–¥:* {escape_md(bike_name)}\n"
                f"‚ïë üìÖ *–î–∞—Ç–∞:* `{escape_md(date)}`\n"
                f"‚ïë üìã *–î–µ—Ç–∞–ª–∏:*\n> `{escape_md(details) or '‚Äì'}`\n"
                f"‚ïü‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ï¢\n"
            )
            message_text += entry

        message_text = message_text.rstrip("‚ïü‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ï¢\n") + "\n‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        message_text += f"\n\nüìÉ –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page + 1} –∏–∑ {total_pages}"

        keyboard = []
        pagination = []
        if page > 0:
            pagination.append(InlineKeyboardButton("<", callback_data=f"full_history_page_{page-1}"))
        if end_idx < len(results):
            pagination.append(InlineKeyboardButton(">", callback_data=f"full_history_page_{page+1}"))

        if pagination:
            keyboard.append(pagination)

        keyboard.append([
            InlineKeyboardButton("üîô –û–±—Ä–∞—Ç–Ω–æ", callback_data="back_to_results"),
            InlineKeyboardButton("‚ùå –ó–∞–∫—Ä—ã—Ç—å", callback_data="close_details")
        ])

        await query.message.edit_text(
            message_text,
            parse_mode="MarkdownV2",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        return

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
    if data.startswith('action_detail_'):
        action_id = data.split('_')[-1]

        result = await execute_query(
            """SELECT action, details, timestamp, user_id, bike_id
               FROM bike_history
               WHERE id = ?""",
            (int(action_id),)
        )

        if not result:
            await query.message.reply_text("‚ö†Ô∏è –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
            return

        action, details, date, user_id, bike_id = result[0]

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
        user_name = "–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω"
        if user_id:
            user_info = await execute_query(
                "SELECT first_name, last_name FROM users WHERE id = ?",
                (user_id,)
            )
            if user_info and len(user_info) > 0:
                first_name = user_info[0][0] or ""
                last_name = user_info[0][1] or ""
                user_name = f"{first_name} {last_name}".strip()

        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
        bike_name = "‚Äì"
        if bike_id and bike_id != 0:
            bike_info = await execute_query(
                "SELECT name FROM bikes WHERE id = ?",
                (bike_id,)
            )
            if bike_info and len(bike_info) > 0:
                bike_name = bike_info[0][0] or "‚Äì"

        text = (
            f"üìÑ *–ü–û–î–†–û–ë–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –î–ï–ô–°–¢–í–ò–ò*\n\n"
            f"‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n"
            f"‚ïë üÜî *ID –¥–µ–π—Å—Ç–≤–∏—è:* \\#{escape_md(action_id)}\n"
            f"‚ïü‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ï¢\n"
            f"‚ïë üè∑Ô∏è *–¢–∏–ø –¥–µ–π—Å—Ç–≤–∏—è:*\n> `{escape_md(action)}`\n"
            f"‚ïü‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ï¢\n"
            f"‚ïë üë§ *–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:*\n> `{escape_md(user_name)}`\n"
            f"‚ïü‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ï¢\n"
            f"‚ïë üö≤ *–í–µ–ª–æ—Å–∏–ø–µ–¥:*\n> `{escape_md(bike_name)}`\n"
            f"‚ïü‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ï¢\n"
            f"‚ïë üìÖ *–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:*\n> `{escape_md(date)}`\n"
            f"‚ïü‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ï¢\n"
            f"‚ïë üìù *–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏:*\n> `{escape_md(details) or '–Ω–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏'}`\n"
            f"‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
        )

        keyboard = [[
            InlineKeyboardButton("üîô –ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º", callback_data="back_to_results"),
            InlineKeyboardButton("‚ùå –ó–∞–∫—Ä—ã—Ç—å", callback_data="close_details")
        ]]

        await query.message.reply_text(
            text,
            parse_mode="MarkdownV2",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
# –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
async def execute_query(query: str, params: tuple) -> list:
    try:
        with sqlite3.connect(DB_FILE) as conn:
            cursor = conn.cursor()
            cursor.execute(query, params)
            return cursor.fetchall()
    except Exception as e:
        logger.error(f"Database error: {e}")
        return []

def generate_history_menu(context: ContextTypes.DEFAULT_TYPE) -> tuple:
    # –¢–µ–∫—Å—Ç –º–µ–Ω—é –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º
    menu_text = "üìú –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É '–ü–æ–∏—Å–∫', —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –Ω—É–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é."

    # <<< –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï >>>
    # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –∫–Ω–æ–ø–∫—É "–ü–æ–∏—Å–∫"
    keyboard = [
        [InlineKeyboardButton("üîé –ü–æ–∏—Å–∫", callback_data="search_by_keyword")]
    ]
    # <<< –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø >>>

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –º–µ–Ω—é –∏ –Ω–æ–≤—É—é, —É—Ä–µ–∑–∞–Ω–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    return menu_text, InlineKeyboardMarkup(keyboard)

async def view_history_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    try:
        query = update.callback_query
        message = update.message if not query else query.message
        original_text = message.text if query else None
        original_markup = message.reply_markup if query else None

        if query:
            await query.answer()

        menu_text, reply_markup = generate_history_menu(context)

        if (menu_text != original_text) or (str(reply_markup) != str(original_markup)):
            if query:
                await message.edit_text(menu_text, reply_markup=reply_markup)
            else:
                await message.reply_text(menu_text, reply_markup=reply_markup)

    except BadRequest as e:
        if "Message is not modified" not in str(e):
            logger.error(f"Telegram API Error: {e}", exc_info=True)
    except Exception as e:
        logger.error(f"Error in view_history_menu: {e}", exc_info=True)
        if not query:
            await update.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–Ω—é")

# –û–±—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞
async def handle_search_request(update: Update, text: str, state: int) -> int:
    query = update.callback_query
    await query.answer()
    await query.message.reply_text(text)
    return state

async def search_by_surname(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    return await handle_search_request(update, "üîç –í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", INPUT_SURNAME)

async def search_by_bike(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    return await handle_search_request(update, "üö≤ –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞:", INPUT_BIKE_NAME)



# –û–±—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CallbackQueryHandler, ContextTypes
import re
import logging
from datetime import datetime

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è MarkdownV2
def escape_md(text):
    return re.sub(r"([_*\[\]()~`>#+\-=|.!{}])", r"\\\1", str(text))

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "‚ùå –ó–∞–∫—Ä—ã—Ç—å"
async def close_details(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    await query.message.delete()  # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "üîô –ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º"
async def back_to_results(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    search_params = context.user_data.get('search_params', {})
    result_type = context.user_data.get('result_type', 'default')  # –¢–∏–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    context.user_data["current_search_page"] = 0
    await show_search_results(update, context, result_type)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
async def show_search_results(update: Update, context: ContextTypes.DEFAULT_TYPE, result_type: str) -> None:
    try:
        query = update.callback_query
        message = update.message if not query else query.message

        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        results = context.user_data.get('search_results', [])
        page = context.user_data.get('current_search_page', 0)
        search_params = context.user_data.get('search_params', {})
        page_size = 5
        total_pages = (len(results) + page_size - 1) // page_size
        start_idx = page * page_size
        end_idx = (page + 1) * page_size

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        header = f"‚ú® *üîç –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–û–ò–°–ö–ê* ‚ú®\n‚ñ´Ô∏è‚ñ´Ô∏è‚ñ´Ô∏è\nü™Ñ –ù–∞–π–¥–µ–Ω–æ –¥–µ–π—Å—Ç–≤–∏–π: _{escape_md(len(results))}_\n"

        if search_params:
            header += "\nüìã *–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞:*\n"
            if search_params.get('keywords'):
                keywords = [f"üî∏ `{escape_md(kw)}`" for kw in set(search_params['keywords'])]
                header += f"üéØ –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:\n{', '.join(keywords)}\n"
            if search_params.get('surnames'):
                surnames = [f"üë§ `{escape_md(s)}`" for s in search_params['surnames']]
                header += f"\nüìá –§–∞–º–∏–ª–∏–∏:\n{', '.join(surnames)}\n"
            if search_params.get('date_from'):
                date_str = f"üìÜ `{escape_md(search_params['date_from'].strftime('%d.%m.%Y'))}"
                if search_params.get('date_to'):
                    date_str += f" ‚ûî {escape_md(search_params['date_to'].strftime('%d.%m.%Y'))}`"
                else:
                    date_str += "`"
                header += f"\n‚è≥ –ü–µ—Ä–∏–æ–¥:\n{date_str}\n"
            header += "‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ\n"

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–µ–π—Å—Ç–≤–∏–π
        actions_text = ""
        for idx, action in enumerate(results[start_idx:end_idx], start=1):
            action_id, action_name, details, date, user_id, bike_id = action
            emoji = "üîÑ"
            if "—Å–æ–∑–¥–∞–Ω" in action_name.lower(): emoji = "üÜï"
            elif "–∏–∑–º–µ–Ω–µ–Ω" in action_name.lower(): emoji = "‚úèÔ∏è"
            elif "—É–¥–∞–ª–µ–Ω" in action_name.lower(): emoji = "üóë"

            actions_text += (
                f"\n{emoji} *–î–µ–π—Å—Ç–≤–∏–µ \\#{escape_md(start_idx + idx)}*\n"
                f"‚ñ´Ô∏è *–¢–∏–ø:* `{escape_md(action_name)}`\n"
                f"‚ñ´Ô∏è *–î–∞—Ç–∞:* `{escape_md(date)}`\n"
                f"üìã *–î–µ—Ç–∞–ª–∏:*\n"
                f"> ‚àò `{escape_md(details) or '–±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤'}`\n"
                f"‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ"
            )

        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é
        pagination = []
        if page > 0:
            pagination.append(InlineKeyboardButton("‚è™ –ü—Ä–µ–¥—ã–¥—É—â–∏–µ", callback_data=f"search_{result_type}_page_{page-1}"))
        if len(results) > page_size:
            pagination.append(InlineKeyboardButton("üìú –í—Å—è –∏—Å—Ç–æ—Ä–∏—è", callback_data="full_history_page_0"))
        if end_idx < len(results):
            pagination.append(InlineKeyboardButton("–°–ª–µ–¥—É—é—â–∏–µ ‚è©", callback_data=f"search_{result_type}_page_{page+1}"))

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        keyboard = []
        if actions_text:
            keyboard.extend([[InlineKeyboardButton(f"üîç –ü–æ–¥—Ä–æ–±–Ω–æ (–î–µ–π—Å—Ç–≤–∏–µ {start_idx+i+1})",
                                                  callback_data=f"action_detail_{a[0]}")]
                             for i, a in enumerate(results[start_idx:end_idx])])
        if pagination:
            keyboard.append(pagination)
        keyboard.append([InlineKeyboardButton("‚ùå –ó–∞–∫—Ä—ã—Ç—å", callback_data="close_search")])

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        message_text = f"{header}\n{actions_text}" if actions_text else f"{header}\n\nüòî –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
        reply_markup = InlineKeyboardMarkup(keyboard)

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        if query:
            await message.edit_text(message_text,
                                   parse_mode="MarkdownV2",
                                   reply_markup=reply_markup)
        else:
            await message.reply_text(message_text,
                                    parse_mode="MarkdownV2",
                                    reply_markup=reply_markup)

    except Exception as e:
        logger.error(f"Error in show_search_results: {str(e)}")
        await update.message.reply_text("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤")

def get_matching_categories(keyword: str) -> list:
    return [cat for cat, keywords in KEYWORD_CATEGORIES.items() if any(kw in keyword for kw in keywords)]

def get_action_categories(action: str, details: str) -> list:
    found = []
    for category, keywords in KEYWORD_CATEGORIES.items():
        if any(kw in action.lower() or kw in details.lower() for kw in keywords):
            found.append(category)
    return found

def escape_sql_like(keyword: str) -> str:
    escape_char = '\\'
    special_chars = ['%', '_', '#', escape_char]
    return ''.join([f'{escape_char}{char}' if char in special_chars else char for char in keyword])

async def handle_surname_input(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    context.user_data.update({
        'search_results': await execute_query(
            "SELECT id, first_name, last_name FROM users WHERE LOWER(last_name) LIKE ? ORDER BY last_name",
            (f"%{update.message.text.strip().lower()}%",)
        ),
        'current_search_page': 0
    })
    await show_search_results(update, context, 'user')
    return ConversationHandler.END

async def handle_bike_name_input(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    context.user_data.update({
        'search_results': await execute_query(
            "SELECT id, name FROM bikes WHERE LOWER(name) LIKE ? ORDER BY name",
            (f"%{update.message.text.strip().lower()}%",)
        ),
        'current_search_page': 0
    })
    await show_search_results(update, context, 'bike')
    return ConversationHandler.END

# –û–±—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
async def handle_search_pagination(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    try:
        match = re.match(r"^search_(\w+)_page_(\d+)$", query.data)
        if not match:
            logger.error(f"Invalid callback data: {query.data}")
            return

        result_type = match.group(1)
        page = int(match.group(2))

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if page < 0:
            page = 0

        context.user_data['current_search_page'] = page
        await show_search_results(update, context, result_type)

    except Exception as e:
        logger.error(f"Pagination error: {str(e)}", exc_info=True)
        await query.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã")

async def select_day(update: Update, context) -> None:
    await update.callback_query.answer()
    await update.callback_query.message.reply_text("üìÖ –í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É (–î–î.–ú–ú –∏–ª–∏ –î–î.–ú–ú.–ì–ì–ì–ì):")
    return SELECT_DATE


async def handle_date_input(update: Update, context) -> None:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–≤–æ–¥ –¥–∞—Ç—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ—ë –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ."""
    user_input = update.message.text.strip()  # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è

    # –í–æ–∑–º–æ–∂–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞—Ç—ã
    date_formats = [
        ('%d.%m', False),  # –î–î.–ú–ú (–≥–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω)
        ('%d.%m.%y', True),  # –î–î.–ú–ú.–ì–ì
        ('%d.%m.%Y', True),  # –î–î.–ú–ú.–ì–ì–ì–ì
    ]

    parsed_date = None
    year_specified = False

    # –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –≤–≤–æ–¥ —Ä–∞–∑–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏
    for fmt, has_year in date_formats:
        try:
            parsed_date = datetime.strptime(user_input, fmt)
            year_specified = has_year
            break
        except ValueError:
            continue

    # –ï—Å–ª–∏ –¥–∞—Ç–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞
    if not parsed_date:
        await update.message.reply_text(
            "üö´ –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:\n"
            "‚Ä¢ 25.01\n‚Ä¢ 25.01.25\n‚Ä¢ 25.01.2025"
        )
        return SELECT_DATE  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –¥–∞—Ç—ã

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è –ë–î –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    if year_specified:
        db_date = parsed_date.strftime('%d.%m.%Y')  # –î–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ë–î
        display_date = parsed_date.strftime('%d.%m.%Y')  # –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    else:
        db_date = parsed_date.strftime('%d.%m')  # –î–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ë–î
        display_date = parsed_date.strftime('%d.%m')  # –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞—Ç—É –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
    context.user_data["selected_date"] = {
        "db_format": db_date,  # –î–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ë–î
        "year_specified": year_specified,  # –£–∫–∞–∑–∞–Ω –ª–∏ –≥–æ–¥
        "display_format": display_date,  # –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        "string": display_date  # –°—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ
    }

    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º —É—Å–ø–µ—à–Ω—ã–π –≤–≤–æ–¥
    await update.message.reply_text(f"üìÖ –§–∏–ª—å—Ç—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞: {display_date}")

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –∏—Å—Ç–æ—Ä–∏–∏
    await view_history_menu(update, context)
    return CHOOSE_HISTORY_TYPE

# –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –ø–æ—Å–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏ cancel()
async def clear_date_filter(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ñ–∏–ª—å—Ç—Ä
    had_date = "selected_date" in context.user_data

    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä –¥–∞—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
    context.user_data.pop("selected_date", None)

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –∏–∑ generate_history_menu
    menu_text, reply_markup = generate_history_menu(context)

    # –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ª–∏—á–∏—è —Ñ–∏–ª—å—Ç—Ä–∞
    status_message = "–§–∏–ª—å—Ç—Ä –¥–∞—Ç—ã —Å–±—Ä–æ—à–µ–Ω." if had_date else "–ú–µ–Ω—é –æ–±–Ω–æ–≤–ª–µ–Ω–æ."
    await query.edit_message_text(
        text=f"{status_message}\n{menu_text}",  # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫ —Ç–µ–∫—Å—Ç—É –º–µ–Ω—é
        reply_markup=reply_markup
    )

async def update_menu_message(query, context, text):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –º–µ–Ω—é –∏—Å—Ç–æ—Ä–∏–∏"""
    selected_date = context.user_data.get("selected_date")
    date_text = f"\nüìÖ –§–∏–ª—å—Ç—Ä: {selected_date['string']}" if selected_date else "\nüìÖ –§–∏–ª—å—Ç—Ä: –≤—Å–µ –≤—Ä–µ–º—è"

    keyboard = [
        [InlineKeyboardButton("üìú –ò—Å—Ç–æ—Ä–∏—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞", callback_data="history_bike")],
        [InlineKeyboardButton("üë§ –ò—Å—Ç–æ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", callback_data="history_user")],
        [InlineKeyboardButton("üìÖ –í—ã–±—Ä–∞—Ç—å –¥–µ–Ω—å", callback_data="select_day")]
    ]

    try:
        await query.edit_message_text(
            text=text + date_text,
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
    except BadRequest as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")

async def abort_operation(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    # –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    keys_to_remove = ["date_selected", "selected_date", "history_params"]
    for key in keys_to_remove:
        context.user_data.pop(key, None)

    await update.message.reply_text("üö´ –û–ø–µ—Ä–∞—Ü–∏—è –ø—Ä–µ—Ä–≤–∞–Ω–∞")
    return ConversationHandler.END

async def view_bike_history(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ '–ò—Å—Ç–æ—Ä–∏—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞'."""
    query = update.callback_query
    await query.answer()

    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    await show_bike_page(update, context)


async def show_bike_page(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞–º–∏."""
    query = update.callback_query
    await query.answer()

    # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑ callback_data
    try:
        page = int(query.data.split("_")[-1])  # –ü—Ä–∏–º–µ—Ä: "bike_page_2" ‚Üí 2
    except (IndexError, ValueError):
        page = 0  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É

    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT id, name FROM bikes ORDER BY id")
    bikes = cursor.fetchall()
    conn.close()

    # –ï—Å–ª–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ –Ω–µ—Ç
    if not bikes:
        await query.edit_message_text("üö´ –í–µ–ª–æ—Å–∏–ø–µ–¥—ã –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.")
        return

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    page_size = 5  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    total_pages = (len(bikes) + page_size - 1) // page_size  # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if page < 0 or page >= total_pages:
        await query.answer("‚ùå –≠—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞")
        return

    # –í—ã–±–∏—Ä–∞–µ–º –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    start = page * page_size
    end = start + page_size
    current_bikes = bikes[start:end]

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞–º–∏
    keyboard = [
        [InlineKeyboardButton(bike[1], callback_data=f"bike_history_{bike[0]}")]
        for bike in current_bikes
    ]

    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    pagination = []
    if page > 0:
        pagination.append(InlineKeyboardButton("<", callback_data=f"bike_page_{page-1}"))
    if end < len(bikes):
        pagination.append(InlineKeyboardButton(">", callback_data=f"bike_page_{page+1}"))

    if pagination:
        keyboard.append(pagination)

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    try:
        await query.edit_message_text(
            "üìú –í—ã–±–µ—Ä–∏—Ç–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏:",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ show_bike_page: {e}")

async def view_user_history(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ '–ò—Å—Ç–æ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'."""
    query = update.callback_query
    await query.answer()

    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    await show_user_page(update, context)


# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞ –µ—Å—Ç—å —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç
from telegram.ext import ContextTypes

async def show_user_page(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏."""
    query = update.callback_query
    await query.answer()

    # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑ callback_data
    try:
        page = int(query.data.split("_")[-1])  # –ü—Ä–∏–º–µ—Ä: "user_page_3" ‚Üí 3
    except (IndexError, ValueError):
        page = 0  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É

    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT id, first_name, last_name FROM users ORDER BY id")
    users = cursor.fetchall()
    conn.close()

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç
    if not users:
        await query.edit_message_text("üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.")
        return

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    page_size = 5  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    total_pages = (len(users) + page_size - 1) // page_size  # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if page < 0 or page >= total_pages:
        await query.answer("‚ùå –≠—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞")
        return

    # –í—ã–±–∏—Ä–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    start = page * page_size
    end = start + page_size
    current_users = users[start:end]

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
    keyboard = [
        [InlineKeyboardButton(f"{user[1]} {user[2]}", callback_data=f"user_history_{user[0]}")]
        for user in current_users
    ]

    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    pagination = []
    if page > 0:
        pagination.append(InlineKeyboardButton("<", callback_data=f"user_page_{page-1}"))
    if end < len(users):
        pagination.append(InlineKeyboardButton(">", callback_data=f"user_page_{page+1}"))

    if pagination:
        keyboard.append(pagination)

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    try:
        await query.edit_message_text(
            "üë§ –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏:",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ show_user_page: {e}")


import sqlite3
from datetime import datetime
from telegram import Update
from telegram.ext import ContextTypes, ConversationHandler

async def display_history(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()

    callback_data = query.data

    if callback_data.startswith("history_pagination_"):
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏: history_pagination_{type}_{id}_{page}
        parts = callback_data.split("_")
        if len(parts) != 5:
            logger.error(f"–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç callback_data: {callback_data}")
            await query.message.reply_text("üö´ –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞")
            return

        history_type = parts[2]
        entity_id = int(parts[3])
        page = int(parts[4])

    elif callback_data == "clear_date":
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞—Ç—É
        await clear_date_filter(update, context)
        return

    else:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞: bike_history_123 / user_history_456
        if callback_data.startswith("bike_history_"):
            history_type = "bike"
            entity_id = int(callback_data.split("_")[2])
        elif callback_data.startswith("user_history_"):
            history_type = "user"
            entity_id = int(callback_data.split("_")[2])
        else:
            await query.message.reply_text("üö´ –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –∏—Å—Ç–æ—Ä–∏–∏.")
            return
        page = 1

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    context.user_data.setdefault("history_params", {})
    context.user_data["history_params"] = {
        "history_type": history_type,
        "entity_id": entity_id,
        "current_page": page
    }

    # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
    history = await get_paginated_history(context, page)
    if not history:
        await query.message.reply_text("üì≠ –ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞")
        return

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    message = await format_history_message(context, history, page)
    keyboard = await build_pagination_keyboard(context, page)

    await safe_edit_message(
        query=query,
        text=message,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

from telegram.error import BadRequest




async def safe_edit_message(query, text, reply_markup=None):
    MAX_LENGTH = 4096
    try:
        if len(text) <= MAX_LENGTH:
            await query.edit_message_text(
                text=text,
                parse_mode='MarkdownV2',
                reply_markup=reply_markup
            )
        else:
            warning = escape_markdown("\n\n‚ö†Ô∏è –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–∫—Ä–∞—â–µ–Ω–æ –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª–∏–Ω—ã")
            await query.edit_message_text(
                text=escape_markdown(text[:MAX_LENGTH - len(warning)]) + warning,
                parse_mode='MarkdownV2',
                reply_markup=reply_markup
            )
    except BadRequest as e:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –∏ fallback –Ω–∞ plain text
        try:
            await query.edit_message_text(
                text=text[:MAX_LENGTH],
                reply_markup=reply_markup
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞: {e}")
            await query.message.reply_text("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏")

async def handle_critical_error(query):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫."""
    try:
        await query.message.reply_text(
            "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –ø–æ–ª–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É."
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ: {e}")

async def parse_and_format_time(timestamp_str: str) -> str:
    """–ü—Ä–∏–≤–æ–¥–∏—Ç timestamp –∫ –µ–¥–∏–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É."""
    try:
        input_formats = [
            "%d.%m.%Y %H:%M:%S",  # 25.01.2025 10:10:47
            "%d.%m.%y %H:%M:%S",  # 25.01.25 10:10:47
            "%d.%m.%Y",           # 25.01.2025
            "%d.%m.%y",           # 25.01.25
            "%Y-%m-%d %H:%M:%S",  # 2025-01-25 10:10:47
        ]

        # –ü–∞—Ä—Å–∏–º –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏
        for fmt in input_formats:
            try:
                dt = datetime.strptime(timestamp_str, fmt)
                # –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                if dt.hour == 0 and dt.minute == 0 and dt.second == 0:
                    return dt.strftime("%d.%m.%Y 00:00:00")
                return dt.strftime("%d.%m.%Y %H:%M:%S")
            except ValueError:
                continue

        # –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω —Ñ–æ—Ä–º–∞—Ç –Ω–µ –ø–æ–¥–æ—à–µ–ª
        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏: {timestamp_str}")
        return timestamp_str

    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—Ä–µ–º–µ–Ω–∏: {timestamp_str} - {e}")
        return timestamp_str

async def get_total_records(context):
    if not context.user_data or "history_params" not in context.user_data:
        logger.error("–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏—Å—Ç–æ—Ä–∏–∏ –≤ context.user_data")
        return 0

    params = context.user_data["history_params"]
    conn = sqlite3.connect(DB_FILE)
    try:
        cursor = conn.cursor()

        # –ë–∞–∑–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –∑–∞–ø—Ä–æ—Å–∞
        params_list = [params["entity_id"]]
        date_filter = ""

        # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –¥–∞—Ç—ã –µ—Å–ª–∏ –µ—Å—Ç—å
        selected_date = context.user_data.get("selected_date")
        if selected_date:
            db_date = selected_date["db_format"]
            year_specified = selected_date["year_specified"]

            if year_specified:
                date_filter = " AND substr(timestamp, 1, 10) = ?"
            else:
                date_filter = " AND substr(timestamp, 1, 5) = ?"

            params_list.append(db_date)

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∏—Å—Ç–æ—Ä–∏–∏
        if params["history_type"] == "bike":
            query = f"""
                SELECT COUNT(*)
                FROM bike_history
                WHERE bike_id = ?{date_filter}
            """
        else:
            query = f"""
                SELECT COUNT(*)
                FROM bike_history
                WHERE user_id = ?{date_filter}
            """

        cursor.execute(query, params_list)
        return cursor.fetchone()[0]

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å—á–µ—Ç–µ –∑–∞–ø–∏—Å–µ–π: {e}")
        return 0
    finally:
        conn.close()
# –û—Å–Ω–æ–≤–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã
import logging
from datetime import datetime
import sqlite3

# –ò–º–ø–æ—Ä—Ç—ã –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ python-telegram-bot
from telegram import (
    Update,
    InlineKeyboardButton,
    InlineKeyboardMarkup,
)
from telegram.ext import (
    ContextTypes,
    ConversationHandler,
)
from telegram.error import BadRequest
def escape_markdown(text: str) -> str:
    escape_chars = r'_*[]()~`>#+-=|{}.!'
    return ''.join(f'\\{char}' if char in escape_chars else char for char in str(text))

async def format_history_message(context, history, page):
    if not context.user_data or "history_params" not in context.user_data:
        logger.error("History params missing in context")
        return "üö´ –û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã."

    params = context.user_data["history_params"]
    total = await get_total_records(context)
    total_pages_val = total_pages(total)

    # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—É—â–Ω–æ—Å—Ç–∏
    entity_info = ""
    conn = sqlite3.connect(DB_FILE)
    try:
        cursor = conn.cursor()

        if params["history_type"] == "user":
            cursor.execute(
                "SELECT first_name, last_name, username FROM users WHERE id = ?",
                (params["entity_id"],)
            )
            user_data = cursor.fetchone()
            if user_data:
                entity_info = (
                    f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_data[0]} {user_data[1]}\n"
                    f"üÜî @{user_data[2] if user_data[2] else '–±–µ–∑ username'}\n"
                )
            else:
                entity_info = f"üÜî ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {params['entity_id']}\n"

        elif params["history_type"] == "bike":
            cursor.execute(
                "SELECT name, available FROM bikes WHERE id = ?",
                (params["entity_id"],)
            )
            bike_data = cursor.fetchone()
            if bike_data:
                status = "üü¢ –î–æ—Å—Ç—É–ø–µ–Ω" if bike_data[1] == 1 else "üî¥ –ó–∞–Ω—è—Ç"
                entity_info = (
                    f"üö¥ –í–µ–ª–æ—Å–∏–ø–µ–¥: {bike_data[0]}\n"
                    f"{status}\n"
                )
            else:
                entity_info = f"üÜî ID –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞: {params['entity_id']}\n"

    except Exception as e:
        logger.error(f"Database error: {e}")
        entity_info = f"üÜî ID –æ–±—ä–µ–∫—Ç–∞: {params['entity_id']}\n"
    finally:
        conn.close()

    # –§–∏–ª—å—Ç—Ä –¥–∞—Ç—ã
    date_filter = context.user_data.get("selected_date", {}).get("string", "–≤—Å–µ –≤—Ä–µ–º—è")

    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
    header = (
        f"üìã –ò–°–¢–û–†–ò–Ø {'–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø' if params['history_type'] == 'user' else '–í–ï–õ–û–°–ò–ü–ï–î–ê'}\n"
        "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"
        f"{entity_info.strip()}\n"
        f"üìÖ –§–∏–ª—å—Ç—Ä: {date_filter}\n"
        f"üìë –°—Ç—Ä–∞–Ω–∏—Ü–∞: {page}/{total_pages_val}\n"
        f"üî¢ –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {total}\n\n"
    )

    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    body = []
    for idx, record in enumerate(history, start=1):
        entry_number = (page - 1) * 3 + idx
        entry = [f"üî∏ –ó–∞–ø–∏—Å—å #{entry_number}"]

        try:
            if params["history_type"] == "bike":
                user_info = (
                    f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {record[0]} {record[1]}\n"
                    f"üÜî @{record[2] if record[2] else '–±–µ–∑ username'}"
                )
                time_action = (
                    f"‚è± –í—Ä–µ–º—è: {await parse_and_format_time(record[4])}\n"
                    f"üìå –î–µ–π—Å—Ç–≤–∏–µ: {record[3].capitalize()}"
                )
                details = f"üìÑ –î–µ—Ç–∞–ª–∏:\n{record[5]}" if record[5] else ""
            else:
                bike_info = f"üö¥ –í–µ–ª–æ—Å–∏–ø–µ–¥: {record[0]}"
                time_action = (
                    f"‚è± –í—Ä–µ–º—è: {await parse_and_format_time(record[2])}\n"
                    f"üìå –î–µ–π—Å—Ç–≤–∏–µ: {record[1].capitalize()}"
                )
                details = f"üìÑ –î–µ—Ç–∞–ª–∏:\n{record[3]}" if record[3] else ""

            entry.extend([
                user_info if params["history_type"] == "bike" else bike_info,
                time_action,
                details,
                "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
            ])

        except (IndexError, TypeError) as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∑–∞–ø–∏—Å–∏: {e}")
            entry.append("‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö")
            entry.append("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ")

        body.append("\n".join(filter(None, entry)))

    return header + "\n\n".join(body)

async def get_paginated_history(context, page):
    if not context.user_data or "history_params" not in context.user_data:
        logger.error("–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏—Å—Ç–æ—Ä–∏–∏ –≤ context.user_data")
        return None

    params = context.user_data["history_params"]
    per_page = 3
    offset = (page - 1) * per_page

    date_filter = ""
    params_list = [params["entity_id"]]  # bike_id –∏–ª–∏ user_id –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞

    # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
    selected_date = context.user_data.get("selected_date")
    if selected_date:
        db_date = selected_date["db_format"]
        year_specified = selected_date["year_specified"]

        if year_specified:
            date_filter = " AND substr(timestamp, 1, 10) = ?"
        else:
            date_filter = " AND substr(timestamp, 1, 5) = ?"

        params_list.append(db_date)

    params_list.extend([per_page, offset])

    conn = sqlite3.connect(DB_FILE)
    try:
        cursor = conn.cursor()

        if params["history_type"] == "bike":
            # –£—Ç–æ—á–Ω–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞
            query = f"""
                SELECT
                    u.first_name,
                    u.last_name,
                    u.username,
                    bh.action,
                    bh.timestamp,
                    bh.details
                FROM bike_history bh
                JOIN users u ON bh.user_id = u.id
                WHERE bh.bike_id = ?{date_filter}
                ORDER BY bh.timestamp DESC
                LIMIT ? OFFSET ?
            """
        else:
            # –ó–∞–ø—Ä–æ—Å –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            query = f"""
                SELECT
                    b.name,
                    bh.action,
                    bh.timestamp,
                    bh.details
                FROM bike_history bh
                JOIN bikes b ON bh.bike_id = b.id
                WHERE bh.user_id = ?{date_filter}
                ORDER BY bh.timestamp DESC
                LIMIT ? OFFSET ?
            """

        logger.info(f"–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å: {query}")
        logger.info(f"–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: {params_list}")
        cursor.execute(query, params_list)
        records = cursor.fetchall()

        if not records:
            logger.info("–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.")
            return None

        return records

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–∞: {e}")
        return None
    finally:
        conn.close()

def total_pages(total_records):
    return (total_records + 2) // 3  # –û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö –¥–ª—è 3 –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ

async def build_pagination_keyboard(context, current_page):
    if not context.user_data or "history_params" not in context.user_data:
        logger.error("–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏—Å—Ç–æ—Ä–∏–∏ –≤ context.user_data")
        return []

    params = context.user_data["history_params"]
    total = await get_total_records(context)
    total_pages_val = total_pages(total)

    # –°–æ–∑–¥–∞–µ–º —Ä—è–¥ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    pagination_buttons = []
    if current_page > 1:
        pagination_buttons.append(
            InlineKeyboardButton(
                "<",
                callback_data=f"history_pagination_{params['history_type']}_{params['entity_id']}_{current_page - 1}"
            )
        )
    if current_page < total_pages_val:
        pagination_buttons.append(
            InlineKeyboardButton(
                ">",
                callback_data=f"history_pagination_{params['history_type']}_{params['entity_id']}_{current_page + 1}"
            )
        )

    # –ö–Ω–æ–ø–∫–∞ "–í–µ—Ä–Ω—É—Ç—å—Å—è" –≤—Å–µ–≥–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
    return_button = [InlineKeyboardButton("üîÑ –í–µ—Ä–Ω—É—Ç—å—Å—è", callback_data="clear_date")]

    # –°–æ–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    keyboard = []
    if pagination_buttons:
        keyboard.append(pagination_buttons)
    keyboard.append(return_button)  # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ

    return keyboard




async def show_work_menu(update: Update, context) -> None:
    user_id = update.message.from_user.id
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–∞—Ç—É—Å —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è
    cursor.execute("SELECT status FROM attendance WHERE user_id=? ORDER BY timestamp DESC LIMIT 1", (user_id,))
    last_status = cursor.fetchone()

    conn.close()

    keyboard = []

    if last_status:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–∞—Ç—É—Å
        last_status = last_status[0]
        if last_status == 'start of work':
            keyboard.append(["üèÅ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å"])  # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è, –µ—Å–ª–∏ —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å –Ω–∞—á–∞—Ç
        elif last_status == 'end of work':
            keyboard.append(["üìù –û—Ç–º–µ—Ç–∏—Ç—å—Å—è –Ω–∞ —Ä–∞–±–æ—Ç–µ"])  # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–Ω–æ–ø–∫—É "–û—Ç–º–µ—Ç–∏—Ç—å—Å—è –Ω–∞ —Ä–∞–±–æ—Ç–µ", –µ—Å–ª–∏ —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å –∑–∞–≤–µ—Ä—à–µ–Ω
    else:
        keyboard.append(["üìù –û—Ç–º–µ—Ç–∏—Ç—å—Å—è –Ω–∞ —Ä–∞–±–æ—Ç–µ"])  # –ï—Å–ª–∏ –Ω–µ—Ç —Å—Ç–∞—Ç—É—Å–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –Ω–∞ —Ä–∞–±–æ—Ç–µ

    # –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –æ–∫–Ω–∞
    keyboard.append(["üìú –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–º–µ—Ç–æ–∫"])
    keyboard.append(["üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"])

    await update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True))

async def mark_attendance(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–®–∞–≥ 1 (–ù–∞—á–∞–ª–æ –¥–Ω—è): –ü—Ä–æ—Å–∏—Ç –ø—Ä–∏—Å–ª–∞—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –æ –Ω–∞—á–∞–ª–µ —Ä–∞–±–æ—Ç—ã."""
    user_id = update.message.from_user.id
    if not is_admin(user_id):
        await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.")
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã —Å–ª–µ–¥—É—é—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–Ω–∞–ª–∞, —á—Ç–æ –¥–µ–ª–∞—Ç—å
    context.user_data['attendance_action'] = 'start'
    
    await update.message.reply_text(
        "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à—É —Ç–µ–∫—É—â—É—é –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é.",
        reply_markup=ReplyKeyboardMarkup(
            [[KeyboardButton("üìç –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é", request_location=True)]],
            resize_keyboard=True, one_time_keyboard=True
        )
    )

async def request_attendance(update: Update, context) -> None:
    query = update.callback_query
    await query.answer()

    if query.data == "request_attendance":
        await query.message.reply_text("üìç –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–≤–æ—é –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é:", reply_markup=ReplyKeyboardMarkup(
            [[KeyboardButton("üìç –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é", request_location=True)]],
            resize_keyboard=True,
            one_time_keyboard=True))

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ view_attendance_history –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ view_attendance_history –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
async def view_attendance_history(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query if hasattr(update, 'callback_query') else None
    if query:
        await query.answer()
        user_id = query.from_user.id
    else:
        user_id = update.message.from_user.id

    # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    # <<< –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∏ username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è >>>
    cursor.execute("SELECT first_name, last_name, username FROM users WHERE id=?", (user_id,))
    user_info = cursor.fetchone()
    
    user_name_display = f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ID {user_id}" # –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    if user_info:
        full_name = f"{user_info[0] or ''} {user_info[1] or ''}".strip()
        username_part = f"(@{user_info[2]})" if user_info[2] else ""
        # –°–æ–±–∏—Ä–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç—Ä–æ–∫—É, —É–±–∏—Ä–∞—è –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
        user_name_display = f"{full_name} {username_part}".strip()
    # <<< –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>

    cursor.execute("SELECT timestamp, status, latitude, longitude FROM attendance WHERE user_id=? ORDER BY timestamp", (user_id,))
    records = cursor.fetchall()
    conn.close()

    if not records:
        await context.bot.send_message(chat_id=user_id, text=f"üö´ –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_name_display} –Ω–µ—Ç –æ—Ç–º–µ—Ç–æ–∫ –æ —Ä–∞–±–æ—Ç–µ.")
        return

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    sessions = []
    for i in range(0, len(records), 2):
        if i + 1 < len(records):
            start_record = records[i]
            end_record = records[i + 1]
            start_time = datetime.strptime(start_record[0], "%Y-%m-%d %H:%M:%S")
            end_time = datetime.strptime(end_record[0], "%Y-%m-%d %H:%M:%S")
            duration = end_time - start_time
            session_text = (
                f"üîµ –ù–∞—á–∞–ª–æ: {start_time.strftime('%H:%M')} "
                f"([–≥–µ–æ](https://www.google.com/maps?q={start_record[2]},{start_record[3]}))\n"
                f"üî¥ –ö–æ–Ω–µ—Ü: {end_time.strftime('%H:%M')} "
                f"([–≥–µ–æ](https://www.google.com/maps?q={end_record[2]},{end_record[3]}))\n"
                f"‚è≥ –í—Ä–µ–º—è: {duration.seconds // 3600} —á {(duration.seconds % 3600) // 60} –º\n\n"
            )
            sessions.append((session_text, duration))

    # –ü–∞–≥–∏–Ω–∞—Ü–∏—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    per_page = 7
    total_pages = (len(sessions) + per_page - 1) // per_page
    current_page = 0
    if query and query.data.startswith('attendance_page:'):
        try:
            current_page = int(query.data.split(':')[1])
        except (IndexError, ValueError):
            current_page = 0
    current_page = max(0, min(current_page, total_pages - 1))
    start_idx = current_page * per_page
    end_idx = start_idx + per_page
    page_sessions = sessions[start_idx:end_idx]

    # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –∏–º—è –∏ username –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫ >>>
    attendance_history = f"üìÖ *–ò—Å—Ç–æ—Ä–∏—è –æ—Ç–º–µ—Ç–æ–∫ –æ —Ä–∞–±–æ—Ç–µ: {user_name_display}*\n\n" + "".join([s[0] for s in page_sessions])

    page_duration = sum((s[1] for s in page_sessions), timedelta())
    attendance_history += (
        f"üïê *–û–±—â–µ–µ –≤—Ä–µ–º—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:* "
        f"{page_duration.days * 24 + page_duration.seconds // 3600} —á "
        f"{(page_duration.seconds % 3600) // 60} –º"
    )

    keyboard = []
    nav_row = []
    if current_page > 0:
        nav_row.append(InlineKeyboardButton("<", callback_data=f'attendance_page:{current_page - 1}'))
    if current_page < total_pages - 1:
        nav_row.append(InlineKeyboardButton(">", callback_data=f'attendance_page:{current_page + 1}'))
    if nav_row:
        keyboard.append(nav_row)

    reply_markup = InlineKeyboardMarkup(keyboard) if keyboard else None

    if query:
        await query.edit_message_text(
            text=attendance_history,
            parse_mode='Markdown',
            reply_markup=reply_markup
        )
    else:
        await context.bot.send_message(
            chat_id=user_id,
            text=attendance_history,
            parse_mode='Markdown',
            reply_markup=reply_markup
        )

async def start(update: Update, context) -> None:
    user_id = update.message.from_user.id
    context.user_data['user_id'] = user_id  # –°–æ—Ö—Ä–∞–Ω—è–µ–º user_id –≤ user_data

    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! üëã –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é –Ω–∏–∂–µ.",
        reply_markup=get_main_menu(user_id)
    )

MONTHS_RU = {
    1: "—è–Ω–≤–∞—Ä—è",
    2: "—Ñ–µ–≤—Ä–∞–ª—è",
    3: "–º–∞—Ä—Ç–∞",
    4: "–∞–ø—Ä–µ–ª—è",
    5: "–º–∞—è",
    6: "–∏—é–Ω—è",
    7: "–∏—é–ª—è",
    8: "–∞–≤–≥—É—Å—Ç–∞",
    9: "—Å–µ–Ω—Ç—è–±—Ä—è",
    10: "–æ–∫—Ç—è–±—Ä—è",
    11: "–Ω–æ—è–±—Ä—è",
    12: "–¥–µ–∫–∞–±—Ä—è"
}

def format_timestamp(timestamp: str) -> str:
    """
    –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é –º–µ—Ç–∫—É –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ '%Y-%m-%d %H:%M:%S' –≤ '20 —è–Ω–≤–∞—Ä—è 13:00'.
    """
    dt = datetime.strptime(timestamp, '%Y-%m-%d %H:%M:%S')
    day = dt.day
    month = MONTHS_RU[dt.month]
    time = dt.strftime('%H:%M')
    return f"{day} {month} {time}"

async def show_notifications(update: Update, context) -> None:
    user_id = update.message.from_user.id
    if not is_admin(user_id):
        await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.")
        return

    # –ü–æ–ª—É—á–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏–∑ –ë–î
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT message, created_at FROM notifications ORDER BY created_at DESC")
    notifications = cursor.fetchall()
    conn.close()

    if not notifications:
        await update.message.reply_text("üö´ –ù–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.")
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    context.user_data['notifications'] = notifications
    context.user_data['current_page'] = 0

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    await send_notification_page(update, context)

async def send_notification_page(update: Update, context, is_edit=False):
    notifications = context.user_data['notifications']
    current_page = context.user_data['current_page']
    items_per_page = 5

    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    total_pages = (len(notifications) + items_per_page - 1) // items_per_page
    start_idx = current_page * items_per_page
    page_data = notifications[start_idx : start_idx + items_per_page]

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
    header = f"üì¨ *–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è* (–°—Ç—Ä–∞–Ω–∏—Ü–∞ {current_page + 1}/{total_pages}):\n\n"
    formatted = [f"*{format_timestamp(ts)}*: {msg}\n---" for msg, ts in page_data]
    text = header + "\n".join(formatted)

    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    keyboard = []
    if current_page > 0:
        keyboard.append(InlineKeyboardButton("‚Üê –ù–∞–∑–∞–¥", callback_data="noti_prev"))
    if current_page < total_pages - 1:
        keyboard.append(InlineKeyboardButton("–í–ø–µ—Ä–µ–¥ ‚Üí", callback_data="noti_next"))
    keyboard.append(InlineKeyboardButton("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å—ë", callback_data="noti_delete"))

    reply_markup = InlineKeyboardMarkup([keyboard])

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    if is_edit:
        await update.callback_query.edit_message_text(
            text,
            parse_mode='Markdown',
            reply_markup=reply_markup
        )
    else:
        await update.message.reply_text(
            text,
            parse_mode='Markdown',
            reply_markup=reply_markup
        )

async def handle_noti_button(update: Update, context):
    query = update.callback_query
    data = query.data

    if data == "noti_prev":
        context.user_data['current_page'] -= 1
    elif data == "noti_next":
        context.user_data['current_page'] += 1
    elif data == "noti_delete":
        # –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –ë–î
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        cursor.execute("DELETE FROM notifications")
        conn.commit()
        conn.close()

        # –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        context.user_data.pop('notifications', None)
        await query.edit_message_text("‚úÖ –í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω—ã!")
        return

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
    await send_notification_page(update, context, is_edit=True)
    await query.answer()

from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import CallbackContext  # <-- –î–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç
import sqlite3
from datetime import datetime
import sqlite3
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CallbackContext, ConversationHandler, MessageHandler, filters, CallbackQueryHandler
from datetime import datetime, timedelta
import logging

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π
POISK_STATE = 1
RENTAL_REPAIR_REASON = 2
RENTAL_REPAIR_PERSON = 3
RENTAL_REPAIR_WARRANTY = 4
RENTAL_REPAIR_WARRANTY_AMOUNT = 5
RENTAL_REPAIR_ESTIMATED_DATE = 6
CUSTOM_EXTENSION = 7

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ manage_rentals –ù–ê –≠–¢–£
MANAGE_RENTALS_MENU, AWAITING_POISK_INPUT = range(20, 22) # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π, —Å–≤–æ–±–æ–¥–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω
async def manage_rentals(update: Update, context: CallbackContext) -> int:
    """
    –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –¥–∏–∞–ª–æ–≥ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥–∞–º–∏". –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞.
    """
    user_id = update.message.from_user.id
    if not is_admin(user_id):
        await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞—Ä–µ–Ω–¥–æ–π.")
        return ConversationHandler.END

    keyboard = [
        [InlineKeyboardButton("üö≤ –ö–ª–∏–µ–Ω—Ç—ã –Ω–∞ –Ω–∞—à–∏—Ö –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞—Ö", callback_data="rental_filter_own_0")],
        [InlineKeyboardButton("üíº –ö–ª–∏–µ–Ω—Ç—ã –Ω–∞ –∏–Ω–≤–µ—Å—Ç–æ—Ä—Å–∫–∏—Ö", callback_data="rental_filter_investor_0")],
        [InlineKeyboardButton("üåê –í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã —Å –∞—Ä–µ–Ω–¥–æ–π", callback_data="rental_filter_all_0")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        "üëá –í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫–∏—Ö –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–æ–≤ –ø–æ–∫–∞–∑–∞—Ç—å:",
        reply_markup=reply_markup
    )
    
    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–Ω—é —ç—Ç–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
    return MANAGE_RENTALS_MENU

async def poisk_start(update: Update, context: CallbackContext) -> int:
    """
    –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –¥–∏–∞–ª–æ–≥ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤–≤–æ–¥–∞.
    """
    query = update.callback_query
    await query.answer()
    await query.edit_message_text("üîç –í–≤–µ–¥–∏—Ç–µ –∏–º—è, —Ñ–∞–º–∏–ª–∏—é –∏–ª–∏ @username –¥–ª—è –ø–æ–∏—Å–∫–∞:")
    
    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞
    return AWAITING_POISK_INPUT

async def poisk_handle(update: Update, context: CallbackContext) -> int:
    """
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥, –∏—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
    """
    poisk_term = update.message.text.strip()
    search_pattern = f"%{poisk_term}%"

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    query = """
        SELECT DISTINCT u.id, u.first_name, u.last_name, u.username
        FROM users u JOIN bookings b ON u.id = b.user_id
        WHERE (u.first_name LIKE ? OR u.last_name LIKE ? OR u.username LIKE ?) AND b.status = 'rented'
    """
    cursor.execute(query, (search_pattern, search_pattern, search_pattern))
    users = cursor.fetchall()
    conn.close()

    if not users:
        await update.message.reply_text("üö´ –ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∞—Ä–µ–Ω–¥–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —ç—Ç–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
        await manage_rentals(update, context)
        return MANAGE_RENTALS_MENU

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–∞–π–¥–µ–Ω—ã, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
    context.user_data['all_users'] = users
    await show_users_page(update, context, page=0)
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–Ω—é, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–∏ –∫–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –∏ "–ù–æ–≤—ã–π –ø–æ–∏—Å–∫"
    return MANAGE_RENTALS_MENU

# –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ –í –í–ê–® –ö–û–î

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ show_filtered_rentals –ù–ê –≠–¢–£ –£–õ–£–ß–®–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ show_filtered_rentals –ù–ê –≠–¢–£ –£–õ–£–ß–®–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ

async def show_filtered_rentals(update: Update, context: CallbackContext) -> None:
    """
    –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø:
    - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤.
    - –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–∏–ø –µ–≥–æ –°–ê–ú–û–ô –°–†–û–ß–ù–û–ô —Å–¥–µ–ª–∫–∏ (–ê—Ä–µ–Ω–¥–∞ –∏–ª–∏ –í—ã–∫—É–ø).
    - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ –¥–∞—Ç–µ –æ–ø–ª–∞—Ç—ã (—Å–∞–º—ã–µ —Å—Ä–æ—á–Ω—ã–µ –≤–≤–µ—Ä—Ö—É).
    - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –¥–Ω–∏ –∏–ª–∏ —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—Å—Ä–æ—á–∫–∏.
    """
    query = update.callback_query
    await query.answer()

    # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–∫–ª–æ–Ω–µ–Ω–∏—è —Å–ª–æ–≤–∞ "–¥–µ–Ω—å"
    def get_day_suffix(days: int) -> str:
        days = abs(days)
        if days % 10 == 1 and days % 100 != 11:
            return "–¥–µ–Ω—å"
        elif 2 <= days % 10 <= 4 and (days % 100 < 10 or days % 100 >= 20):
            return "–¥–Ω—è"
        return "–¥–Ω–µ–π"

    try:
        parts = query.data.split('_')
        category = parts[2]
        page = int(parts[3])
    except (IndexError, ValueError):
        logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ callback_data: {query.data}")
        await query.edit_message_text("üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.")
        return

    PAGE_SIZE = 5
    
    # --- –®–ê–ì 1: –°–æ–±–∏—Ä–∞–µ–º SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –í–°–ï–• –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ---
    base_sql = """
        SELECT DISTINCT u.id, u.first_name, u.last_name
        FROM users u
        JOIN bookings b ON u.id = b.user_id
        JOIN bikes bk ON b.bike_id = bk.id
        WHERE b.status = 'rented'
    """
    if category == "own":
        filter_condition = " AND bk.investor_id IS NULL"
        title = "–ö–ª–∏–µ–Ω—Ç—ã –Ω–∞ –Ω–∞—à–∏—Ö –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞—Ö"
    elif category == "investor":
        filter_condition = " AND bk.investor_id IS NOT NULL"
        title = "–ö–ª–∏–µ–Ω—Ç—ã –Ω–∞ –∏–Ω–≤–µ—Å—Ç–æ—Ä—Å–∫–∏—Ö –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞—Ö"
    else:  # all
        filter_condition = ""
        title = "–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã —Å –∞—Ä–µ–Ω–¥–æ–π"

    final_query = base_sql + filter_condition
    
    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            cursor = await conn.execute(final_query)
            all_users = await cursor.fetchall()

            if not all_users:
                await query.edit_message_text(f"–í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ¬´{title}¬ª –Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ —Å–¥–µ–ª–∫–∞–º–∏.")
                return

            # --- –®–ê–ì 2: –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞—Ö–æ–¥–∏–º –µ–≥–æ —Å–∞–º—É—é —Å—Ä–æ—á–Ω—É—é —Å–¥–µ–ª–∫—É ---
            users_with_deal_info = []
            today = datetime.now(MOSCOW_TZ).date()

            for user in all_users:
                deals_cursor = await conn.execute(
                    "SELECT booking_type, end_date, next_payment_date FROM bookings WHERE user_id = ? AND status = 'rented'",
                    (user['id'],)
                )
                all_deals = await deals_cursor.fetchall()
                
                soonest_date = None
                deal_type = ""

                for deal in all_deals:
                    date_str = deal['end_date'] if deal['booking_type'] == 'rent' else deal['next_payment_date']
                    if date_str:
                        try:
                            current_date = datetime.strptime(date_str, "%d.%m.%Y").date()
                            if soonest_date is None or current_date < soonest_date:
                                soonest_date = current_date
                                deal_type = "–ê—Ä–µ–Ω–¥–∞" if deal['booking_type'] == 'rent' else "–í—ã–∫—É–ø"
                        except (ValueError, TypeError):
                            continue
                
                if soonest_date:
                    users_with_deal_info.append({**user, 'due_date': soonest_date, 'type': deal_type})

            # --- –®–ê–ì 3: –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –¥–∞—Ç–µ (—Å–∞–º—ã–µ —Å—Ä–æ—á–Ω—ã–µ –≤–≤–µ—Ä—Ö—É) ---
            sorted_users = sorted(users_with_deal_info, key=lambda u: u['due_date'])

            # --- –®–ê–ì 4: –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –∫ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É —Å–ø–∏—Å–∫—É ---
            total_items = len(sorted_users)
            total_pages = (total_items + PAGE_SIZE - 1) // PAGE_SIZE
            paginated_users = sorted_users[page * PAGE_SIZE : (page + 1) * PAGE_SIZE]

            # --- –®–ê–ì 5: –§–æ—Ä–º–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π ---
            keyboard = []
            for user_data in paginated_users:
                days_left = (user_data['due_date'] - today).days
                
                if days_left < 0:
                    status_str = f"üî¥ –ü—Ä–æ—Å—Ä–æ—á–∫–∞ {abs(days_left)} {get_day_suffix(days_left)}"
                elif days_left < 3:
                    status_str = f"üü° {days_left} {get_day_suffix(days_left)}"
                else:
                    status_str = f"üü¢ {days_left} {get_day_suffix(days_left)}"

                button_text = f"{user_data['first_name']} {user_data['last_name'] or ''} | {user_data['type']} ({status_str})"
                keyboard.append([InlineKeyboardButton(button_text, callback_data=f"view_rentals_{user_data['id']}")])

            # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
            pagination_row = []
            if page > 0:
                pagination_row.append(InlineKeyboardButton("‚¨ÖÔ∏è", callback_data=f"rental_filter_{category}_{page - 1}"))
            if page < total_pages - 1:
                pagination_row.append(InlineKeyboardButton("‚û°Ô∏è", callback_data=f"rental_filter_{category}_{page + 1}"))

            if pagination_row:
                keyboard.append(pagination_row)
            keyboard.append([InlineKeyboardButton("üîç –ù–æ–≤—ã–π –ø–æ–∏—Å–∫", callback_data="poisk_start")])
            
            message_text = f"üìã {title} (–°—Ç—Ä. {page + 1}/{total_pages}):"
            await query.edit_message_text(message_text, reply_markup=InlineKeyboardMarkup(keyboard))

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ë–î –≤ show_filtered_rentals: {e}", exc_info=True)
        await query.edit_message_text("üö´ –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.")

# –®–ê–ì 2.1: –í–°–¢–ê–í–¨–¢–ï –≠–¢–£ –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ

async def report_investor_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ—Ç—á–µ—Ç–∞ –ø–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º:
    - –°–ø–∏—Å–æ–∫ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞.
    - –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç—á–µ—Ç–∞ –ø–æ –≤—Å–µ–º —Å—Ä–∞–∑—É.
    """
    query = update.callback_query
    await query.answer()

    # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑ callback_data (–Ω–∞–ø—Ä–∏–º–µ—Ä, report_investor_list_0)
    page = int(query.data.split('_')[-1]) if query.data.startswith('report_investor_list_') else 0
    PAGE_SIZE = 5

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            # –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤
            count_cursor = await conn.execute(
                "SELECT COUNT(DISTINCT investor_id) FROM bikes WHERE investor_id IS NOT NULL"
            )
            total_items = (await count_cursor.fetchone())[0]

            if total_items == 0:
                await query.edit_message_text(
                    "–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞–º–∏.",
                    reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="report_back_to_main")]])
                )
                return

            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            cursor = await conn.execute(
                """SELECT DISTINCT b.investor_id, u.first_name, u.last_name
                   FROM bikes b JOIN users u ON b.investor_id = u.id
                   WHERE b.investor_id IS NOT NULL
                   ORDER BY u.last_name, u.first_name
                   LIMIT ? OFFSET ?""",
                (PAGE_SIZE, page * PAGE_SIZE)
            )
            investors = await cursor.fetchall()

        keyboard = [
            # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞ —Å—Ä–∞–∑—É –ø–æ –≤—Å–µ–º –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º
            [InlineKeyboardButton("üìä –û—Ç—á–µ—Ç –ø–æ –≤—Å–µ–º –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º", callback_data="report_generate_investor_all")],
        ]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        for inv in investors:
            keyboard.append([InlineKeyboardButton(
                f"{inv['first_name']} {inv['last_name'] or ''}",
                callback_data=f"report_generate_investor_{inv['investor_id']}"
            )])

        # –õ–æ–≥–∏–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
        total_pages = (total_items + PAGE_SIZE - 1) // PAGE_SIZE
        pagination_row = []
        if page > 0:
            pagination_row.append(InlineKeyboardButton("‚¨ÖÔ∏è", callback_data=f"report_investor_list_{page - 1}"))
        if page < total_pages - 1:
            pagination_row.append(InlineKeyboardButton("‚û°Ô∏è", callback_data=f"report_investor_list_{page + 1}"))
        
        if pagination_row:
            keyboard.append(pagination_row)
        
        # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞—Å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –æ—Ç—á–µ—Ç–æ–≤
        keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="report_back_to_main")])

        await query.edit_message_text(
            f"–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞ –¥–ª—è –æ—Ç—á–µ—Ç–∞ –∏–ª–∏ –∑–∞–ø—Ä–æ—Å–∏—Ç–µ –æ—Ç—á–µ—Ç –ø–æ –≤—Å–µ–º —Å—Ä–∞–∑—É (–°—Ç—Ä. {page + 1}/{total_pages}):",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ –¥–ª—è –æ—Ç—á–µ—Ç–∞: {e}", exc_info=True)
        await query.edit_message_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤.")


POISK_ARENDA_STATE, SHOWING_ARENDA_USERS_STATE = range(10, 12)

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ view_user_rentals –ù–ê –≠–¢–£ –ò–°–ü–†–ê–í–õ–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ view_user_rentals –ù–ê –≠–¢–£ –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–£–Æ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ view_user_rentals –ù–ê –≠–¢–£ –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–£–Æ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ view_user_rentals –ù–ê –≠–¢–£ –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–£–Æ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ view_user_rentals –ù–ê –≠–¢–£ –ù–û–í–£–Æ –í–ï–†–°–ò–Æ –° MARKDOWNV2

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ view_user_rentals –ù–ê –≠–¢–£ –ù–û–í–£–Æ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ view_user_rentals –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ –° –ù–û–í–´–ú–ò –ö–ù–û–ü–ö–ê–ú–ò

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ view_user_rentals –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ –° –ù–û–í–´–ú–ò –ö–ù–û–ü–ö–ê–ú–ò
import aiosqlite
import json
import logging
from datetime import datetime
import pytz # –í–∞–∂–Ω—ã–π –∏–º–ø–æ—Ä—Ç –¥–ª—è —á–∞—Å–æ–≤—ã—Ö –ø–æ—è—Å–æ–≤
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import CallbackContext
from telegram.helpers import escape_markdown
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ view_user_rentals –ù–ê –≠–¢–£ –ü–û–õ–ù–£–Æ –í–ï–†–°–ò—é
# ==============================================================================
# –ù–ê–ß–ê–õ–û –ë–õ–û–ö–ê 2: –ü–û–õ–ù–ê–Ø –ó–ê–ú–ï–ù–ê –§–£–ù–ö–¶–ò–ò –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –°–î–ï–õ–û–ö
# ==============================================================================
# ==============================================================================
# –ù–ê–ß–ê–õ–û –ë–õ–û–ö–ê: –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –°–î–ï–õ–û–ö (–§–ò–ö–° Markdown)
# ==============================================================================
# ==============================================================================
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
# ==============================================================================
OSCOW_TZ = pytz.timezone('Europe/Moscow')

def parse_bike_name_and_vin(full_name: str) -> dict:
    """
    "–£–º–Ω—ã–π" –ø–∞—Ä—Å–µ—Ä: –æ—Ç–¥–µ–ª—è–µ—Ç –º–æ–¥–µ–ª—å –æ—Ç VIN.
    """
    parts = full_name.strip().split(' ', 2)
    
    if len(parts) > 2:
        model = f"{parts[0]} {parts[1]}"
        vin = parts[2]
    elif len(parts) == 2:
        model = parts[0]
        vin = parts[1]
    else:
        vin_starters = ['JL', 'ESM', 'CNHC']
        model = full_name.strip()
        vin = '(–Ω–µ —É–∫–∞–∑–∞–Ω)'
        
        full_name_lower = full_name.lower()
        for prefix in vin_starters:
            prefix_lower = prefix.lower()
            if prefix_lower in full_name_lower:
                start_index = full_name_lower.find(prefix_lower)
                model = full_name[:start_index].strip()
                vin = full_name[start_index:].strip()
                if not model:
                    model = vin
                    vin = '(–Ω–µ —É–∫–∞–∑–∞–Ω)'
                break
                
    return {'model': model, 'vin': vin}

async def _get_deal_details_from_db(booking_id: int, conn: aiosqlite.Connection) -> dict | None:
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –¥–µ—Ç–∞–ª–µ–π —Å–¥–µ–ª–∫–∏ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º.
    """
    conn.row_factory = aiosqlite.Row
    cursor = await conn.execute("""
        SELECT 
            b.id as booking_id, b.booking_type, b.end_date, b.next_payment_date,
            b.payments_made, b.payment_plan_key,
            bk.id as bike_id, bk.name as bike_name,
            bk.buyout_total_payments, bk.buyout_payment_amount, bk.buyout_period_days,
            bk.rent_price_7d, bk.rent_price_14d, bk.rent_price_30d,
            u.id as user_id, u.first_name, u.last_name, u.username, u.phone_number
        FROM bookings b
        JOIN bikes bk ON b.bike_id = bk.id
        JOIN users u ON b.user_id = u.id
        WHERE b.id = ?
    """, (booking_id,))
    deal_data_raw = await cursor.fetchone()

    if not deal_data_raw:
        return None

    return dict(deal_data_raw)


# --- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ –∞—Ä–µ–Ω–¥ (–§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø) ---

# REPLACED FUNCTION (Step 1)
async def view_user_rentals(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –ü–û–õ–ù–ê–Ø –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø:
    - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è –∫–∞–∂–¥–æ–π –∞–∫—Ç–∏–≤–Ω–æ–π —Å–¥–µ–ª–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    - –í–∫–ª—é—á–∞–µ—Ç –≤ –∫–∞—Ä—Ç–æ—á–∫—É –§–ò–û, –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π –Ω–∏–∫–Ω–µ–π–º Telegram –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
    - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –¥–Ω–∏ –ø–æ –º–æ—Å–∫–æ–≤—Å–∫–æ–º—É –≤—Ä–µ–º–µ–Ω–∏.
    - –§–æ—Ä–º–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –∫–Ω–æ–ø–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Å–¥–µ–ª–∫–∏.
    - >>> –î–û–ë–ê–í–õ–ï–ù–ê –ö–ù–û–ü–ö–ê "–ò–ó–ú–ï–ù–ò–¢–¨ –î–ê–¢–£" <<<
    """
    query = update.callback_query
    await query.answer()
    user_id = int(query.data.split("_")[2])
    chat_id = query.message.chat.id

    # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    def escape_html(text: str) -> str:
        return str(text or '').replace("&", "&amp;").replace("<", "&lt;").replace(">", "&gt;")

    def get_day_suffix(days: int) -> str:
        days = abs(days)
        if days % 10 == 1 and days % 100 != 11: return "–¥–µ–Ω—å"
        elif 2 <= days % 10 <= 4 and (days % 100 < 10 or days % 100 >= 20): return "–¥–Ω—è"
        return "–¥–Ω–µ–π"

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            cursor = await conn.execute("SELECT id FROM bookings WHERE user_id = ? AND status = 'rented'", (user_id,))
            booking_ids = [row[0] for row in await cursor.fetchall()]

            if not booking_ids:
                await query.message.delete()
                await context.bot.send_message(chat_id=chat_id, text="üö´ –£ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π.")
                return
            
            user_deals = []
            for booking_id in booking_ids:
                deal_details = await _get_deal_details_from_db(booking_id, conn)
                if deal_details:
                    user_deals.append(deal_details)

        await query.message.delete()
        
        today = datetime.now(MOSCOW_TZ).date()

        for deal in user_deals:
            parsed_bike = parse_bike_name_and_vin(deal['bike_name'])
            
            full_name_display = f"{escape_html(deal['first_name'])} {escape_html(deal['last_name'])}"
            phone_display = deal.get('phone_number') or '–Ω–µ —É–∫–∞–∑–∞–Ω'
            
            card_parts = [
                f"üÜî <b>–°–¥–µ–ª–∫–∞:</b> <code>‚Ññ{escape_html(str(deal['booking_id']))}</code>",
                f"üë§ <b>–ö–ª–∏–µ–Ω—Ç:</b> <code>{full_name_display}</code>",
            ]

            if deal.get('username'):
                card_parts.append(f"üí¨ <b>–¢–µ–ª–µ–≥—Ä–∞–º:</b> @{escape_html(deal['username'])}")
            
            card_parts.extend([
                f"üìû <b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> <code>{escape_html(phone_display)}</code>",
                f"üö≤ <b>–ú–æ–¥–µ–ª—å:</b> <code>{escape_html(parsed_bike['model'])}</code>",
                f"üîß <b>VIN:</b> <code>{escape_html(deal['bike_name'])}</code>",
                "------------------------------",
            ])

            keyboard = []
            if deal['booking_type'] == 'rent':
                end_date_obj = datetime.strptime(deal['end_date'], "%d.%m.%Y").date()
                days_left = (end_date_obj - today).days

                if days_left < 0:
                    status_emoji, status_text = "üî¥", f"–ü—Ä–æ—Å—Ä–æ—á–∫–∞ {abs(days_left)} {get_day_suffix(days_left)}"
                elif days_left == 0:
                    status_emoji, status_text = "üü°", "–°–µ–≥–æ–¥–Ω—è"
                else:
                    status_emoji, status_text = "üü¢", f"{days_left} {get_day_suffix(days_left)}"
                
                card_parts.append(f"‚è≥ <b>–î–æ –æ–ø–ª–∞—Ç—ã:</b> {status_emoji} {status_text} ({escape_html(deal['end_date'])})")
                card_parts.append("------------------------------")
                
                keyboard.append([
                    InlineKeyboardButton("üîÑ –ü—Ä–æ–¥–ª–∏—Ç—å", callback_data=f"extend_rental_{deal['booking_id']}"),
                    InlineKeyboardButton("‚úÖ –ü—Ä–∏–Ω—è—Ç—å —Ç–æ–≤–∞—Ä", callback_data=f"accept_bike_{deal['booking_id']}")
                ])
                # <<< –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê –ó–î–ï–°–¨ (–¥–ª—è –∞—Ä–µ–Ω–¥—ã) >>>
                keyboard.append([InlineKeyboardButton("‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –æ–ø–ª–∞—Ç—ã", callback_data=f"edit_date_{deal['booking_id']}")])

            elif deal['booking_type'] == 'buyout':
                total_payments = deal.get('buyout_total_payments', 0)
                payments_made = deal.get('payments_made', 0)
                payment_amount = deal.get('buyout_payment_amount', 0)
                
                card_parts.extend([
                    f"üí∞ <b>–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞:</b> <code>{payment_amount:,.0f} ‚ÇΩ</code>".replace(",", " "),
                    f"üóìÔ∏è <b>–°–ª–µ–¥—É—é—â–∏–π –ø–ª–∞—Ç–µ–∂:</b> –¥–æ <code>{escape_html(deal.get('next_payment_date', '–Ω–µ –∑–∞–¥–∞–Ω–∞'))}</code>",
                    f"üìä <b>–ü—Ä–æ–≥—Ä–µ—Å—Å:</b> <code>({payments_made}/{total_payments})</code>",
                ])

                keyboard.append([
                    InlineKeyboardButton("‚öôÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –ø–ª–∞–Ω", callback_data=f"edit_buyout_{deal['booking_id']}"),
                    InlineKeyboardButton("‚úèÔ∏è +/- –ü–ª–∞—Ç–µ–∂", callback_data=f"edit_payments_{deal['booking_id']}"),
                ])
                # <<< –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê –ó–î–ï–°–¨ (–¥–ª—è –≤—ã–∫—É–ø–∞) >>>
                keyboard.append([InlineKeyboardButton("‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –æ–ø–ª–∞—Ç—ã", callback_data=f"edit_date_{deal['booking_id']}")])

            # –û–±—â–∏–µ –∫–Ω–æ–ø–∫–∏
            keyboard.append([
                InlineKeyboardButton("üí∞ –®—Ç—Ä–∞—Ñ", callback_data=f"admin_fine_{user_id}_{deal['booking_id']}"),
                InlineKeyboardButton("üìú –ò—Å—Ç–æ—Ä–∏—è –æ–ø–ª–∞—Ç—ã", callback_data=f"admin_payment_history_{user_id}")
            ])

            final_item_text = "\n".join(card_parts)
            await context.bot.send_message(
                chat_id=chat_id, text=final_item_text,
                reply_markup=InlineKeyboardMarkup(keyboard), parse_mode="HTML"
            )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ view_user_rentals: {e}", exc_info=True)
        await context.bot.send_message(chat_id=chat_id, text=f"üö´ –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö: {e}")
AWAIT_RENT_TARIFFS_FROM_CARD = range(760, 761)

# ADD THIS NEW CODE BLOCK (Step 2)

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –¥–∏–∞–ª–æ–≥–∞
AWAIT_NEW_DATE = range(962, 963) # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–≤–æ–±–æ–¥–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω

async def start_date_edit(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 1: –ù–∞—á–∏–Ω–∞–µ—Ç –¥–∏–∞–ª–æ–≥, –∑–∞–ø—Ä–∞—à–∏–≤–∞—è –Ω–æ–≤—É—é –¥–∞—Ç—É."""
    query = update.callback_query
    await query.answer()
    
    booking_id = int(query.data.split('_')[-1])
    context.user_data['booking_id_for_date_edit'] = booking_id
    
    await query.message.edit_text(
        f"‚úèÔ∏è *–ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã –¥–ª—è —Å–¥–µ–ª–∫–∏ #{booking_id}*\n\n"
        "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –¥–∞—Ç—É —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ *–î–î.–ú–ú.–ì–ì–ì–ì* (–Ω–∞–ø—Ä–∏–º–µ—Ä, `25.12.2024`)",
        parse_mode="Markdown"
    )
    return AWAIT_NEW_DATE

async def save_new_date(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—É—é –¥–∞—Ç—É –∏ —É–≤–µ–¥–æ–º–ª—è–µ—Ç –≤—Å–µ—Ö."""
    new_date_str = update.message.text.strip()
    booking_id = context.user_data.get('booking_id_for_date_edit')
    admin_id = update.message.from_user.id

    # 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç—ã
    try:
        datetime.strptime(new_date_str, "%d.%m.%Y")
    except ValueError:
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –∫–∞–∫ `–î–î.–ú–ú.–ì–ì–ì–ì`.")
        return AWAIT_NEW_DATE # –û—Å—Ç–∞–µ–º—Å—è –≤ —Ç–æ–º –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–∏

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            await conn.execute("BEGIN")
            
            # 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫—É—é –∫–æ–ª–æ–Ω–∫—É –æ–±–Ω–æ–≤–ª—è—Ç—å (end_date –∏–ª–∏ next_payment_date)
            cursor = await conn.execute("SELECT booking_type, user_id, bike_id FROM bookings WHERE id = ?", (booking_id,))
            booking_info = await cursor.fetchone()
            if not booking_info:
                raise ValueError("–°–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")

            column_to_update = 'end_date' if booking_info['booking_type'] == 'rent' else 'next_payment_date'
            
            # 3. –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –≤ –±–∞–∑–µ
            await conn.execute(f"UPDATE bookings SET {column_to_update} = ? WHERE id = ?", (new_date_str, booking_id))
            
            # 4. –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
            log_details = f"–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã –∏–∑–º–µ–Ω–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –Ω–∞ {new_date_str}"
            await log_bike_action(conn, booking_info['bike_id'], booking_info['user_id'], "–ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã –ø–ª–∞—Ç–µ–∂–∞", log_details)

            await conn.commit()
        
        # 5. –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        await update.message.reply_text(f"‚úÖ –î–∞—Ç–∞ –¥–ª—è —Å–¥–µ–ª–∫–∏ #{booking_id} —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ *{new_date_str}*.", parse_mode="Markdown")

        # 6. –£–≤–µ–¥–æ–º–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç–∞
        await context.bot.send_message(
            chat_id=booking_info['user_id'],
            text=f"üîî –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏–∑–º–µ–Ω–∏–ª –¥–∞—Ç—É –≤–∞—à–µ–≥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –Ω–∞ *{new_date_str}*.",
            parse_mode="Markdown"
        )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞—Ç—ã –ø–ª–∞—Ç–µ–∂–∞: {e}", exc_info=True)
        await update.message.reply_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
    finally:
        context.user_data.clear()
        return ConversationHandler.END
async def start_set_tariffs_from_card(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –®–∞–≥ 1: –ù–∞—á–∏–Ω–∞–µ—Ç –¥–∏–∞–ª–æ–≥, –ø–æ–ª—É—á–∞–µ—Ç ID –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –∏–∑ —Å–¥–µ–ª–∫–∏ –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ü–µ–Ω—ã.
    """
    query = update.callback_query
    await query.answer()

    booking_id = int(query.data.split('_')[-1])
    
    # –ü–æ–ª—É—á–∞–µ–º ID –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞, —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ —Å —ç—Ç–æ–π —Å–¥–µ–ª–∫–æ–π
    async with aiosqlite.connect(DB_FILE) as conn:
        cursor = await conn.execute("SELECT bike_id FROM bookings WHERE id = ?", (booking_id,))
        result = await cursor.fetchone()
    
    if not result:
        await query.edit_message_text("üö´ –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å–≤—è–∑–∞–Ω–Ω—É—é —Å–¥–µ–ª–∫—É.")
        return ConversationHandler.END

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–∞–º–æ–≥–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –µ–≥–æ —Ç–∞—Ä–∏—Ñ—ã
    context.user_data['editing_bike_id_from_card'] = result[0]
    
    await query.edit_message_text(
        "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–µ —Ü–µ–Ω—ã –¥–ª—è –∞—Ä–µ–Ω–¥—ã –Ω–∞ *7, 14 –∏ 30 –¥–Ω–µ–π* —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª.\n\n"
        "*–ü—Ä–∏–º–µ—Ä:* `3500 7000 13000`",
        parse_mode="Markdown"
    )
    return AWAIT_RENT_TARIFFS_FROM_CARD

async def save_rent_tariffs_from_card(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –®–∞–≥ 2: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—ã–µ —Ü–µ–Ω—ã –≤ –ë–î.
    """
    try:
        prices = [float(p) for p in update.message.text.split()]
        if len(prices) != 3: raise ValueError
    except ValueError:
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞. –í–≤–µ–¥–∏—Ç–µ *3 —á–∏—Å–ª–∞* —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return AWAIT_RENT_TARIFFS_FROM_CARD

    bike_id = context.user_data['editing_bike_id_from_card']

    async with aiosqlite.connect(DB_FILE) as conn:
        await conn.execute(
            "UPDATE bikes SET rent_price_7d = ?, rent_price_14d = ?, rent_price_30d = ? WHERE id = ?",
            (*prices, bike_id)
        )
        await conn.commit()
        
    await update.message.reply_text("‚úÖ –¢–∞—Ä–∏—Ñ—ã –∞—Ä–µ–Ω–¥—ã –¥–ª—è —ç—Ç–æ–≥–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!")
    
    # –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–∞–µ–º –¥–∏–∞–ª–æ–≥
    context.user_data.clear()
    return ConversationHandler.END
# ==============================================================================
# –ö–û–ù–ï–¶ –ë–õ–û–ö–ê
# ==============================================================================
# ==============================================================================
# –ö–û–ù–ï–¶ –ë–õ–û–ö–ê 2
# ==============================================================================

# <<< –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê >>>
AWAIT_NEW_PAYMENT_COUNT = range(960, 961)

async def edit_payments_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()
    booking_id = int(query.data.split('_')[-1])
    context.user_data['edit_payments_booking_id'] = booking_id
    
    await query.message.reply_text(f"‚úèÔ∏è –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –¥–ª—è —Å–¥–µ–ª–∫–∏ #{booking_id}.\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ —á–∏—Å–ª–æ —Å–æ–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π:")
    return AWAIT_NEW_PAYMENT_COUNT

async def save_new_payment_count(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    try:
        new_count = int(update.message.text)
        if new_count < 0: raise ValueError
    except ValueError:
        await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ (0 –∏–ª–∏ –±–æ–ª—å—à–µ).")
        return AWAIT_NEW_PAYMENT_COUNT

    booking_id = context.user_data['edit_payments_booking_id']
    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            await conn.execute("UPDATE bookings SET payments_made = ? WHERE id = ?", (new_count, booking_id))
            await conn.commit()
        await update.message.reply_text(f"‚úÖ –£—Å–ø–µ—à–Ω–æ! –î–ª—è —Å–¥–µ–ª–∫–∏ #{booking_id} —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ {new_count} —Å–æ–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π.")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–ª-–≤–∞ –ø–ª–∞—Ç–µ–∂–µ–π: {e}", exc_info=True)
        await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.")
    
    context.user_data.clear()
    return ConversationHandler.END


# --- –î–∏–∞–ª–æ–≥ –¥–ª—è –æ—Ç–º–µ–Ω—ã –≤—ã–∫—É–ø–∞ ---
CONFIRM_CANCEL_BUYOUT = range(961, 962)

async def cancel_buyout_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()
    booking_id = int(query.data.split('_')[-1])
    context.user_data['cancel_buyout_booking_id'] = booking_id
    
    keyboard = [
        [InlineKeyboardButton("–î–ê, –û–¢–ú–ï–ù–ò–¢–¨ –í–´–ö–£–ü", callback_data="confirm_cancel_buyout_yes")],
        [InlineKeyboardButton("–ù–µ—Ç, –æ—Å—Ç–∞–≤–∏—Ç—å", callback_data="confirm_cancel_buyout_no")]
    ]
    await query.message.reply_text(
        f"üö® –í–´ –£–í–ï–†–ï–ù–´?\n\n–û—Ç–º–µ–Ω–∞ –≤—ã–∫—É–ø–∞ –¥–ª—è —Å–¥–µ–ª–∫–∏ #{booking_id} –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ —Ç–æ–º—É, —á—Ç–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥ –≤–µ—Ä–Ω–µ—Ç—Å—è –≤ –ø–∞—Ä–∫, –∞ –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–ª–∏–µ–Ω—Ç–∞ –±—É–¥–µ—Ç —Å–±—Ä–æ—à–µ–Ω. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
    return CONFIRM_CANCEL_BUYOUT

async def cancel_buyout_confirm(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()

    if query.data == "confirm_cancel_buyout_no":
        await query.edit_message_text("–û—Ç–º–µ–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è.")
        context.user_data.clear()
        return ConversationHandler.END

    booking_id = context.user_data['cancel_buyout_booking_id']
    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            cursor = await conn.execute("SELECT bike_id, user_id FROM bookings WHERE id = ?", (booking_id,))
            booking_data = await cursor.fetchone()
            if not booking_data:
                await query.edit_message_text("‚ùå –°–¥–µ–ª–∫–∞ —É–∂–µ –±—ã–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∞.")
                return ConversationHandler.END
            
            bike_id, user_id = booking_data
            
            # 1. –£–¥–∞–ª—è–µ–º —Å–¥–µ–ª–∫—É
            await conn.execute("DELETE FROM bookings WHERE id = ?", (booking_id,))
            # 2. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–µ–ª–æ—Å–∏–ø–µ–¥ –≤ –ø–∞—Ä–∫
            await conn.execute("UPDATE bikes SET available = 1 WHERE id = ?", (bike_id,))
            
            log_details = f"–í—ã–∫—É–ø –ø–æ —Å–¥–µ–ª–∫–µ #{booking_id} –±—ã–ª –æ—Ç–º–µ–Ω–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º."
            await log_bike_action(conn, bike_id, user_id, "–û—Ç–º–µ–Ω–∞ –≤—ã–∫—É–ø–∞", log_details)
            
            await conn.commit()
        
        await query.edit_message_text(f"‚úÖ –í—ã–∫—É–ø –ø–æ —Å–¥–µ–ª–∫–µ #{booking_id} —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω. –í–µ–ª–æ—Å–∏–ø–µ–¥ ID {bike_id} –≤–æ–∑–≤—Ä–∞—â–µ–Ω –≤ –ø–∞—Ä–∫.")
        await context.bot.send_message(user_id, "üîî –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–º–µ–Ω–∏–ª –≤–∞—à—É —Å–¥–µ–ª–∫—É –ø–æ –≤—ã–∫—É–ø—É. –î–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –≤—ã–∫—É–ø–∞: {e}", exc_info=True)
        await query.edit_message_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –≤—ã–∫—É–ø–∞.")
    
    context.user_data.clear()
    return ConversationHandler.END
# --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –î–õ–Ø –ù–û–í–´–• –ê–î–ú–ò–ù–°–ö–ò–• –ö–ù–û–ü–û–ö ---

# 1. –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–î–æ–ø. –¥–µ–Ω—å"
async def admin_add_extra_day(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    booking_id = int(query.data.split('_')[-1])
    admin_id = query.from_user.id
    
    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            await conn.execute("BEGIN")
            cursor = await conn.execute("SELECT end_date, user_id, bike_id FROM bookings WHERE id=?", (booking_id,))
            booking = await cursor.fetchone()

            if not booking:
                await query.edit_message_text("üö´ –ê—Ä–µ–Ω–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
                return

            current_end_date = datetime.strptime(booking[0], '%d.%m.%Y')
            new_end_date = current_end_date + timedelta(days=1)
            new_end_date_str = new_end_date.strftime('%d.%m.%Y')

            await conn.execute("UPDATE bookings SET end_date=? WHERE id=?", (new_end_date_str, booking_id))
            
            log_details = f"–î–æ–±–∞–≤–ª–µ–Ω 1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –¥–µ–Ω—å. –ù–æ–≤—ã–π —Å—Ä–æ–∫: {new_end_date_str}"
            await log_bike_action(conn, booking[2], booking[1], "–î–æ–ø. –¥–µ–Ω—å (–±–æ–Ω—É—Å)", log_details)
            
            await conn.commit()

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, —Ç.–∫. —Å—Ç–∞—Ä–æ–µ –º–æ–≥–ª–æ –±—ã—Ç—å —É–¥–∞–ª–µ–Ω–æ
        await context.bot.send_message(chat_id=query.message.chat.id, text=f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–æ–±–∞–≤–ª–µ–Ω 1 –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–Ω—å –∞—Ä–µ–Ω–¥—ã. –ù–æ–≤—ã–π —Å—Ä–æ–∫: {new_end_date_str}")
        await context.bot.send_message(booking[1], f"üéâ –í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω –±–æ–Ω—É—Å–Ω—ã–π –¥–µ–Ω—å –∞—Ä–µ–Ω–¥—ã! –í–∞—à –Ω–æ–≤—ã–π —Å—Ä–æ–∫ –æ–∫–æ–Ω—á–∞–Ω–∏—è: *{new_end_date_str}*", parse_mode="Markdown")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –¥–æ–ø. –¥–Ω—è: {e}", exc_info=True)
        await context.bot.send_message(chat_id=query.message.chat.id, text="üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.")

# 2. –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ò—Å—Ç–æ—Ä–∏—è –æ–ø–ª–∞—Ç—ã"
# ==============================================================================
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ admin_show_payment_history –ù–ê –≠–¢–£ –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–£–Æ –í–ï–†–°–ò–Æ
# ==============================================================================

# ==============================================================================
# –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–ê–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø (–ó–ê–ú–ï–ù–ò–¢–ï –°–¢–ê–†–£–Æ)
# ==============================================================================
async def admin_show_payment_history(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –° –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï–ú –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø –î–ê–¢–´:
    - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞–¥–µ–∂–Ω—ã–π —Ä—É—á–Ω–æ–π –º–µ—Ç–æ–¥ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–±–æ–µ–≤ strftime.
    """
    query = update.callback_query
    await query.answer()
    user_id = int(query.data.split('_')[-1])
    chat_id = query.message.chat.id

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            cursor = await conn.execute(
                """SELECT action, details, timestamp 
                   FROM bike_history 
                   WHERE user_id=? AND (
                       action LIKE '–û–ø–ª–∞—Ç–∞%' OR action LIKE '–í—ã–∫—É–ø%' OR 
                       action LIKE '–ü—Ä–æ–¥–ª–µ–Ω–∏–µ%' OR action LIKE '–î–æ—Å—Ä–æ—á–Ω–æ–µ%' OR
                       action LIKE '–ü–ª–∞—Ç–µ–∂%' OR action LIKE '–ê—Ä–µ–Ω–¥–∞%'
                   ) 
                   ORDER BY timestamp DESC""",
                (user_id,)
            )
            payments = await cursor.fetchall()
        
        if not payments:
            await context.bot.send_message(chat_id=chat_id, text="–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—É—Å—Ç–∞.")
            return

        history_parts = ["üìú *–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π*:\n"]
        for payment in payments:
            amount_text = "–°—É–º–º–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞"
            if payment['details'] and "—Å—É–º–º–∞:" in payment['details']:
                try:
                    amount_str = payment['details'].split('—Å—É–º–º–∞:')[1].replace('\u00A0‚ÇΩ', '').strip()
                    amount_text = f"{float(amount_str):.2f} ‚ÇΩ"
                except (IndexError, ValueError):
                    pass
            
            payment_date_str = payment['timestamp']
            payment_date_formatted = "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"

            if payment_date_str and isinstance(payment_date_str, str):
                possible_formats = [
                    '%Y-%m-%d %H:%M:%S', '%d.%m.%Y %H:%M:%S', '%d.%m.%Y',
                    '%d.%m.%y %H:%M:%S', '%d.%m.%y'
                ]
                for fmt in possible_formats:
                    try:
                        dt_obj = datetime.strptime(payment_date_str.strip(), fmt)
                        
                        # --- –ù–ê–î–ï–ñ–ù–û–ï –†–£–ß–ù–û–ï –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –í–ú–ï–°–¢–û STRFTIME ---
                        payment_date_formatted = (
                            f"{dt_obj.day:02d}.{dt_obj.month:02d}.{dt_obj.year} –≤ "
                            f"{dt_obj.hour:02d}:{dt_obj.minute:02d}"
                        )
                        # --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---
                        break 
                    except (ValueError, TypeError):
                        continue
            
            history_parts.append(
                f"\nüìÖ *–î–∞—Ç–∞:* {payment_date_formatted}\n"
                f"üìù *–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:* {payment['action']}\n"
                f"üí∞ *–°—É–º–º–∞:* {amount_text}"
            )
        
        await context.bot.send_message(chat_id=chat_id, text="\n".join(history_parts), parse_mode="Markdown")

    except Exception as e:
        logging.error(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ 'admin_show_payment_history': {e}", exc_info=True)
        await context.bot.send_message(chat_id=chat_id, text="üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏.")

# 3. –ù–æ–≤—ã–µ ConversationHandlers –¥–ª—è "–®—Ç—Ä–∞—Ñ" –∏ "–°–∫–∏–¥–∫–∞"
# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
ADMIN_AWAIT_FINE_AMOUNT, ADMIN_AWAIT_FINE_REASON, ADMIN_AWAIT_FINE_DUE_DATE = range(810, 813)
ADMIN_AWAIT_DISCOUNT_AMOUNT, ADMIN_AWAIT_DISCOUNT_REASON, ADMIN_AWAIT_DISCOUNT_DURATION = range(813, 816)

# --- –î–∏–∞–ª–æ–≥ –¥–ª—è –®–¢–†–ê–§–ê ---
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –ò–°–ü–†–ê–í–õ–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ
# –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –ù–û–í–£–Æ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–£–Æ –§–£–ù–ö–¶–ò–Æ –í –í–ê–® –ö–û–î
def _get_plan_details(payment_plan_key: str, item_name: str, item_type: str) -> dict | None:
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –ø–ª–∞–Ω–∞ —Ä–∞—Å—Å—Ä–æ—á–∫–∏.
    –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ—Ç—Å—è —Ä–∞–∑–æ–±—Ä–∞—Ç—å –∫–ª—é—á –∫–∞–∫ –∫–∞—Å—Ç–æ–º–Ω—ã–π JSON.
    –ï—Å–ª–∏ –Ω–µ —É–¥–∞–µ—Ç—Å—è, –∏—â–µ—Ç –µ–≥–æ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —Å–ª–æ–≤–∞—Ä—è—Ö BUYOUT_PLANS.
    """
    if payment_plan_key and payment_plan_key.startswith('custom_'):
        try:
            # –ò–∑–≤–ª–µ–∫–∞–µ–º JSON-—á–∞—Å—Ç—å –∏ –ø–∞—Ä—Å–∏–º –µ–µ
            json_part = payment_plan_key.split('custom_', 1)[1]
            custom_plan = json.loads(json_part)
            # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–ª—é—á–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
            custom_plan['first_payment'] = custom_plan.get('payment_amount', 0)
            custom_plan['full_label'] = "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω"
            return custom_plan
        except (json.JSONDecodeError, IndexError):
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –∫–ª—é—á –ø–ª–∞–Ω–∞: {payment_plan_key}")
            return None

    # –ï—Å–ª–∏ –∫–ª—é—á –Ω–µ –∫–∞—Å—Ç–æ–º–Ω—ã–π, —Ä–∞–±–æ—Ç–∞–µ–º –ø–æ —Å—Ç–∞—Ä–æ–π –ª–æ–≥–∏–∫–µ
    if item_type == PRODUCT_TYPE_BIKE:
        return BUYOUT_PLANS.get(payment_plan_key)
    elif item_type == PRODUCT_TYPE_BATTERY:
        model_key = '60V21Ah' if '60V21Ah' in item_name else '60V30Ah'
        if model_key in BATTERY_BUYOUT_PLANS:
            return BATTERY_BUYOUT_PLANS[model_key]['plans'].get(payment_plan_key)

    return None

# –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ë–õ–û–ö –ö–û–î–ê –° –î–†–£–ì–ò–ú–ò ConversationHandler'–∞–º–∏

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
# ==============================================================================
# –ù–ê–ß–ê–õ–û –ë–õ–û–ö–ê 1: –ü–û–õ–ù–ê–Ø –ó–ê–ú–ï–ù–ê –î–ò–ê–õ–û–ì–ê "–ò–ó–ú–ï–ù–ò–¢–¨ –ü–õ–ê–ù"
# ==============================================================================

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ (–º–æ–≥—É—Ç –æ—Å—Ç–∞—Ç—å—Å—è –ø—Ä–µ–∂–Ω–∏–º–∏, –µ—Å–ª–∏ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç)
AWAIT_TOTAL_PAYMENTS, AWAIT_PAYMENT_AMOUNT, AWAIT_PERIOD_DAYS = range(950, 953)

async def edit_buyout_plan_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 1: –ù–∞—á–∏–Ω–∞–µ—Ç –¥–∏–∞–ª–æ–≥, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç ID —Å–¥–µ–ª–∫–∏."""
    query = update.callback_query
    await query.answer()
    booking_id = int(query.data.split('_')[-1])
    context.user_data['edit_buyout_booking_id'] = booking_id
    
    await query.message.edit_text(f"üìù –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –¥–ª—è —Å–¥–µ–ª–∫–∏ #{booking_id}.\n\n–í–≤–µ–¥–∏—Ç–µ –ù–û–í–û–ï –û–ë–©–ï–ï –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç–µ–∂–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, 15):")
    return AWAIT_TOTAL_PAYMENTS

async def get_new_total_payments(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 2: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª-–≤–æ –ø–ª–∞—Ç–µ–∂–µ–π."""
    try:
        total_payments = int(update.message.text)
        if total_payments <= 0: raise ValueError
        context.user_data['new_total_payments'] = total_payments
        await update.message.reply_text("–û—Ç–ª–∏—á–Ω–æ. –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –ù–û–í–£–Æ –°–£–ú–ú–£ –æ–¥–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5000):")
        return AWAIT_PAYMENT_AMOUNT
    except ValueError:
        await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ.")
        return AWAIT_TOTAL_PAYMENTS

async def get_new_payment_amount(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 3: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—É–º–º—É –ø–ª–∞—Ç–µ–∂–∞."""
    try:
        amount = float(update.message.text.replace(',', '.'))
        if amount <= 0: raise ValueError
        context.user_data['new_payment_amount'] = amount
        await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –ù–û–í–´–ô –ø–µ—Ä–∏–æ–¥ –º–µ–∂–¥—É –ø–ª–∞—Ç–µ–∂–∞–º–∏ –≤ –¥–Ω—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, 7 –¥–ª—è –Ω–µ–¥–µ–ª–∏):")
        return AWAIT_PERIOD_DAYS
    except ValueError:
        await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É.")
        return AWAIT_PAYMENT_AMOUNT

async def save_updated_buyout_plan(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –§–ò–ù–ê–õ: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–µ—Ä–∏–æ–¥, –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–∞—Ä–∏—Ñ—ã –≤ —Ç–∞–±–ª–∏—Ü–µ BIKES –∏ –¥–∞—Ç—É –ø–ª–∞—Ç–µ–∂–∞ –≤ BOOKINGS.
    """
    try:
        period_days = int(update.message.text)
        if period_days <= 0: raise ValueError
    except ValueError:
        await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–Ω–µ–π.")
        return AWAIT_PERIOD_DAYS

    booking_id = context.user_data['edit_buyout_booking_id']
    total_payments = context.user_data['new_total_payments']
    payment_amount = context.user_data['new_payment_amount']
    
    new_next_payment_date = (datetime.now() + timedelta(days=period_days)).strftime('%d.%m.%Y')
    
    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            # –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º ID –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –∏–∑ —Å–¥–µ–ª–∫–∏
            cursor = await conn.execute("SELECT bike_id, user_id FROM bookings WHERE id = ?", (booking_id,))
            result = await cursor.fetchone()
            if not result:
                await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞: —Å–¥–µ–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
                return ConversationHandler.END
            
            bike_id, user_id = result
            
            # 1. –û–ë–ù–û–í–õ–Ø–ï–ú –¢–ê–†–ò–§–´ –í –°–ê–ú–û–ú –í–ï–õ–û–°–ò–ü–ï–î–ï
            await conn.execute(
                """UPDATE bikes 
                   SET buyout_total_payments = ?, buyout_payment_amount = ?, buyout_period_days = ?
                   WHERE id = ?""",
                (total_payments, payment_amount, period_days, bike_id)
            )
            
            # 2. –û–ë–ù–û–í–õ–Ø–ï–ú –î–ê–¢–£ –ü–õ–ê–¢–ï–ñ–ê –í –°–î–ï–õ–ö–ï
            await conn.execute(
                "UPDATE bookings SET next_payment_date = ? WHERE id = ?",
                (new_next_payment_date, booking_id)
            )

            log_details = f"–ü–ª–∞–Ω –≤—ã–∫—É–ø–∞ –∏–∑–º–µ–Ω–µ–Ω. –ù–æ–≤—ã–µ —É—Å–ª–æ–≤–∏—è: {total_payments} –ø–ª. –ø–æ {payment_amount} —Ä—É–±. –∫–∞–∂–¥—ã–µ {period_days} –¥–Ω–µ–π."
            await log_bike_action(conn, bike_id, user_id, "–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –≤—ã–∫—É–ø–∞", log_details)
            
            await conn.commit()

        await update.message.reply_text(
            f"‚úÖ –ü–ª–∞–Ω –¥–ª—è —Å–¥–µ–ª–∫–∏ #{booking_id} —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω!\n"
            f"–ù–æ–≤–∞—è –¥–∞—Ç–∞ —Å–ª–µ–¥. –ø–ª–∞—Ç–µ–∂–∞: {new_next_payment_date}"
        )
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∞ –≤—ã–∫—É–ø–∞: {e}", exc_info=True)
        await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î.")

    context.user_data.clear()
    return ConversationHandler.END
# ==============================================================================
# –ö–û–ù–ï–¶ –ë–õ–û–ö–ê 1
# ==============================================================================
async def admin_start_fine(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()
    
    parts = query.data.split('_')
    user_id = int(parts[2])
    
    context.user_data.clear()
    context.user_data['fine_user_id'] = user_id
    context.user_data['admin_id'] = query.from_user.id
    
    # <<< –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ–≥–æ >>>
    await query.edit_message_text(
        text=f"üí∏ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —à—Ç—Ä–∞—Ñ–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID {user_id}.\n–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —à—Ç—Ä–∞—Ñ–∞ –≤ —Ä—É–±–ª—è—Ö:",
        reply_markup=None # –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–Ω–æ–ø–∫–∏
    )
    return ADMIN_AWAIT_FINE_AMOUNT

# --- –î–∏–∞–ª–æ–≥ –¥–ª—è –°–ö–ò–î–ö–ò ---
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –ò–°–ü–†–ê–í–õ–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ
async def admin_process_fine_amount(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    try:
        amount = float(update.message.text.replace(',', '.'))
        if amount <= 0: raise ValueError
        context.user_data['amount'] = amount
        await update.message.reply_text("üìù –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —à—Ç—Ä–∞—Ñ–∞:")
        return ADMIN_AWAIT_FINE_REASON # <-- –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ü–†–ê–í–ò–õ–¨–ù–û–ï —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    except ValueError:
        await update.message.reply_text("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞! –í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ:")
        return ADMIN_AWAIT_FINE_AMOUNT

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –ù–û–í–£–Æ –í–ï–†–°–ò–Æ

async def admin_process_fine_reason(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –®–∞–≥ 2 (–§–ò–ù–ê–õ): –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø—Ä–∏—á–∏–Ω—É, –°–†–ê–ó–£ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —à—Ç—Ä–∞—Ñ –≤ –ë–î –±–µ–∑ –¥–∞—Ç—ã –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –¥–∏–∞–ª–æ–≥.
    """
    reason = update.message.text.strip()
    if len(reason) < 5:
        await update.message.reply_text("‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ! –ú–∏–Ω–∏–º—É–º 5 —Å–∏–º–≤–æ–ª–æ–≤:")
        return ADMIN_AWAIT_FINE_REASON

    # <<< –ù–ê–ß–ê–õ–û –õ–û–ì–ò–ö–ò –°–û–•–†–ê–ù–ï–ù–ò–Ø (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –∏–∑ —Å—Ç–∞—Ä–æ–π —Ñ—É–Ω–∫—Ü–∏–∏) >>>
    try:
        user_id = context.user_data['fine_user_id']
        admin_id = context.user_data['admin_id']
        amount = context.user_data['amount']

        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            await conn.execute("BEGIN")
            
            await conn.execute(
                "INSERT INTO fines (user_id, admin_id, amount, reason, status) VALUES (?, ?, ?, ?, 'unpaid')",
                (user_id, admin_id, amount, reason)
            )
            
            cursor = await conn.execute("SELECT first_name, last_name, username FROM users WHERE id = ?", (user_id,))
            user_data = await cursor.fetchone()
            user_name = f"{user_data['first_name']} {user_data['last_name'] or ''} (@{user_data['username'] or 'N/A'})"
            
            await log_bike_action(conn, None, user_id, "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —à—Ç—Ä–∞—Ñ–∞", f"–°—É–º–º–∞: {amount}‚ÇΩ, –ü—Ä–∏—á–∏–Ω–∞: {reason}")
            
            await conn.commit()

        # –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É (–±–µ–∑ –¥–∞—Ç—ã)
        await update.message.reply_text(
            f"‚úÖ –®—Ç—Ä–∞—Ñ —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω!\n"
            f"‚ñ™Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_name}\n"
            f"‚ñ™Ô∏è –°—É–º–º–∞: {amount}‚ÇΩ\n"
            f"‚ñ™Ô∏è –ü—Ä–∏—á–∏–Ω–∞: {reason}"
        )
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        await context.bot.send_message(
            chat_id=user_id,
            text=(
                f"üö® –í–∞–º –Ω–∞–∑–Ω–∞—á–µ–Ω —à—Ç—Ä–∞—Ñ!\n\n"
                f"‚ñ™Ô∏è –°—É–º–º–∞: *{amount:.2f} ‚ÇΩ*\n"
                f"‚ñ™Ô∏è –ü—Ä–∏—á–∏–Ω–∞: _{reason}_\n\n"
                "–í—ã –º–æ–∂–µ—Ç–µ –æ–ø–ª–∞—Ç–∏—Ç—å –∏–ª–∏ –æ—Å–ø–æ—Ä–∏—Ç—å –µ–≥–æ –≤ –õ–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ."
            ),
            parse_mode="Markdown"
        )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —à—Ç—Ä–∞—Ñ–∞: {e}", exc_info=True)
        await update.message.reply_text(f"üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —à—Ç—Ä–∞—Ñ–∞: {e}")
    
    finally:
        context.user_data.clear()
        return ConversationHandler.END

async def admin_process_due_date(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    # –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–æ–≥–∏–∫—É process_due_date, –Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –¥–∏–∞–ª–æ–≥
    await process_due_date(update, context) # –í—ã–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î
    return ConversationHandler.END

# --- –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ –°–ö–ò–î–ö–ò –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ ---

async def admin_process_discount_amount(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    try:
        amount = float(update.message.text.replace(',', '.'))
        if amount <= 0: raise ValueError
        context.user_data['discount_amount'] = amount
        await update.message.reply_text("–û—Ç–ª–∏—á–Ω–æ. –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –≤—ã–¥–∞—á–∏ —Å–∫–∏–¥–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ë–æ–Ω—É—Å –∑–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç—å'):")
        return ADMIN_AWAIT_DISCOUNT_REASON # <-- –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ü–†–ê–í–ò–õ–¨–ù–û–ï —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    except ValueError:
        await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä, 500 –∏–ª–∏ 250.5).")
        return ADMIN_AWAIT_DISCOUNT_AMOUNT

async def admin_process_discount_reason(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    reason = update.message.text.strip()
    if not reason:
        await update.message.reply_text("‚ùå –ü—Ä–∏—á–∏–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π.")
        return ADMIN_AWAIT_DISCOUNT_REASON
    context.user_data['discount_reason'] = reason
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Å–∫–∏–¥–∫–∏ –≤ –¥–Ω—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, 7):")
    return ADMIN_AWAIT_DISCOUNT_DURATION # <-- –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ü–†–ê–í–ò–õ–¨–ù–û–ï —Å–æ—Å—Ç–æ—è–Ω–∏–µ

async def admin_process_discount_duration(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    # –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–æ–≥–∏–∫—É process_discount_duration, –Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –¥–∏–∞–ª–æ–≥
    await process_discount_duration(update, context) # –í—ã–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î
    return ConversationHandler.END
async def admin_start_discount(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()

    user_id = int(query.data.split('_')[2])
    
    context.user_data.clear()
    context.user_data['discount_user_id'] = user_id
    context.user_data['admin_id'] = query.from_user.id

    # <<< –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ–≥–æ >>>
    await query.edit_message_text(
        text=f"üéÅ –í—ã–¥–∞—á–∞ —Å–∫–∏–¥–∫–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID {user_id}.\n–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Å–∫–∏–¥–∫–∏ –≤ —Ä—É–±–ª—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, 500):",
        reply_markup=None # –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–Ω–æ–ø–∫–∏
    )
    return ADMIN_AWAIT_DISCOUNT_AMOUNT

# <<< –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê >>>

# –ù–ê–ô–î–ò–¢–ï –≠–¢–£ –§–£–ù–ö–¶–ò–Æ –ò –ó–ê–ú–ï–ù–ò–¢–ï –ï–Å

# –ù–ê–ô–î–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ extend_rental –ò –ó–ê–ú–ï–ù–ò–¢–ï –ï–ï –ù–ê –≠–¢–£:

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ extend_rental –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

async def extend_rental(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    await query.answer()

    booking_id = int(query.data.split("_")[2])

    # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞, —á—Ç–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∞—Ä–∏—Ñ—ã –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT name FROM bikes WHERE id = (SELECT bike_id FROM bookings WHERE id=?)", (booking_id,))
    bike_name_row = cursor.fetchone()
    conn.close()

    if not bike_name_row:
        await query.message.reply_text("üö´ –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω –≤–µ–ª–æ—Å–∏–ø–µ–¥ –¥–ª—è —ç—Ç–æ–π –∞—Ä–µ–Ω–¥—ã.")
        return

    bike_name = bike_name_row[0]
    model_key = get_bike_model_key(bike_name)
    
    keyboard = []
    if model_key:
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏
        for days in [7, 14, 30]:
            price_key = f"{model_key}_{days}"
            price = RENTAL_PRICES.get(price_key)
            if price:
                # –≠—Ç–∏ –∫–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è —Å—Ç–∞—Ä—ã–º —Ö–µ–Ω–¥–ª–µ—Ä–æ–º
                keyboard.append([InlineKeyboardButton(f"{days} –¥–Ω–µ–π - {price} —Ä—É–±", callback_data=f"extend_{days}_{booking_id}")])
    
    # --- –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï ---
    # –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –ø—Ä–æ–¥–ª–µ–Ω–∏—è. –û–Ω–∞ –∑–∞–ø—É—Å—Ç–∏—Ç –Ω–æ–≤—ã–π ConversationHandler.
    keyboard.append([InlineKeyboardButton("–î—Ä—É–≥–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)", callback_data=f"manual_ext_start_{booking_id}")])
    keyboard.append([InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_repair")]) # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –æ—Ç–º–µ–Ω—É

    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ, –Ω–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –ø—Ä–æ–¥–ª–∏—Ç—å –∞—Ä–µ–Ω–¥—É:", reply_markup=reply_markup)

# ==============================================================================
#           –ù–û–í–´–ô –ú–û–î–£–õ–¨ –î–õ–Ø –ë–ï–°–ü–õ–ê–¢–ù–û–ì–û –ü–†–û–î–õ–ï–ù–ò–Ø –ê–†–ï–ù–î–´ (–ê–î–ú–ò–ù)
# ==============================================================================

# --- –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ ---
AWAIT_MANUAL_DAYS = range(800, 801)

async def start_manual_extension(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 1: –ù–∞—á–∏–Ω–∞–µ—Ç –¥–∏–∞–ª–æ–≥, –∑–∞–ø—Ä–∞—à–∏–≤–∞—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π."""
    query = update.callback_query
    await query.answer()

    booking_id = int(query.data.split('_')[-1])
    context.user_data['manual_ext_booking_id'] = booking_id

    await query.edit_message_text("–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –ø—Ä–æ–¥–ª–µ–Ω–∏—è:")
    return AWAIT_MANUAL_DAYS

async def process_manual_extension_days(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 2: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–Ω–∏, –æ–±–Ω–æ–≤–ª—è–µ—Ç –ë–î –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –¥–∏–∞–ª–æ–≥."""
    try:
        days_to_add = int(update.message.text.strip())
        if days_to_add <= 0:
            raise ValueError("–î–Ω–µ–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±–æ–ª—å—à–µ –Ω—É–ª—è")
    except ValueError:
        await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–Ω–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, 3).")
        return AWAIT_MANUAL_DAYS

    booking_id = context.user_data.get('manual_ext_booking_id')
    admin_id = update.message.from_user.id

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            await conn.execute("BEGIN")
            
            cursor = await conn.execute(
                "SELECT b.end_date, b.user_id, b.bike_id, bk.name as bike_name "
                "FROM bookings b JOIN bikes bk ON b.bike_id = bk.id WHERE b.id=?",
                (booking_id,)
            )
            booking_info = await cursor.fetchone()

            if not booking_info:
                raise ValueError("–ê—Ä–µ–Ω–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")

            current_end_date = datetime.strptime(booking_info['end_date'], '%d.%m.%Y')
            new_end_date = current_end_date + timedelta(days=days_to_add)
            new_end_date_str = new_end_date.strftime('%d.%m.%Y')
            
            await conn.execute("UPDATE bookings SET end_date=? WHERE id=?", (new_end_date_str, booking_id))
            
            log_details = f"–ê—Ä–µ–Ω–¥–∞ –ø—Ä–æ–¥–ª–µ–Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ –Ω–∞ {days_to_add} –¥–Ω–µ–π. –ù–æ–≤—ã–π —Å—Ä–æ–∫: {new_end_date_str}"
            await log_bike_action(conn, booking_info['bike_id'], booking_info['user_id'], "–ü—Ä–æ–¥–ª–µ–Ω–∏–µ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)", log_details)
            
            await conn.commit()

        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
        await update.message.reply_text(
            f"‚úÖ –ê—Ä–µ–Ω–¥–∞ #{booking_id} –±–µ—Å–ø–ª–∞—Ç–Ω–æ –ø—Ä–æ–¥–ª–µ–Ω–∞ –Ω–∞ {days_to_add} –¥–Ω–µ–π.\n"
            f"–ù–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: {new_end_date_str}"
        )

        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        await context.bot.send_message(
            chat_id=booking_info['user_id'],
            text=(f"üéâ –í–∞—à–∞ –∞—Ä–µ–Ω–¥–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ *{booking_info['bike_name']}* –±—ã–ª–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ –ø—Ä–æ–¥–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!\n\n"
                  f"–ù–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: *{new_end_date_str}*")
            , parse_mode="Markdown"
        )
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ process_manual_extension_days: {e}", exc_info=True)
        await update.message.reply_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
    finally:
        context.user_data.clear()
        return ConversationHandler.END

async def cancel_manual_extension(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û—Ç–º–µ–Ω—è–µ—Ç –¥–∏–∞–ª–æ–≥ –∏ —É–¥–∞–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ."""
    await update.callback_query.answer()
    await update.callback_query.edit_message_text("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    context.user_data.clear()
    return ConversationHandler.END

# –î–û–ë–ê–í–¨–¢–ï –≠–¢–ò –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –í –í–ê–® –ö–û–î

async def handle_custom_extension_start(update: Update, context: CallbackContext) -> int:
    """–®–∞–≥ 1: –ù–∞—á–∏–Ω–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø—Ä–æ–¥–ª–µ–Ω–∏—è, –∑–∞–ø—Ä–∞—à–∏–≤–∞—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π."""
    query = update.callback_query
    await query.answer()

    # –ò–∑–≤–ª–µ–∫–∞–µ–º booking_id –∏–∑ callback_data –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    booking_id = int(query.data.split("_")[-1])
    context.user_data['extending_booking_id'] = booking_id

    await query.edit_message_text(
        "–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10):"
    )
    return CUSTOM_EXTENSION_DAYS

async def process_custom_extension_days(update: Update, context: CallbackContext) -> int:
    """–®–∞–≥ 2: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–±—â—É—é —Ü–µ–Ω—É."""
    try:
        days = int(update.message.text.strip())
        if days <= 0:
            raise ValueError
        context.user_data['custom_extension_days'] = days
        await update.message.reply_text("–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –û–ë–©–£–Æ —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ä–æ–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5000):")
        return AWAIT_CUSTOM_PRICE
    except ValueError:
        await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ (—Ü–µ–ª–æ–µ, –±–æ–ª—å—à–µ 0).")
        return CUSTOM_EXTENSION_DAYS

# main.py

# main.py

async def process_custom_price_and_pay(update: Update, context: CallbackContext) -> int:
    """
    –®–∞–≥ 3 (–§–ò–ù–ê–õ): –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ü–µ–Ω—É, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏,
    –∑–∞—Ç–µ–º –û–¢–î–ï–õ–¨–ù–´–ú —Å–æ–æ–±—â–µ–Ω–∏–µ–º –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç —Å—á–µ—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É.
    """
    try:
        price = float(update.message.text.strip().replace(',', '.'))
        if price <= 0:
            raise ValueError
    except ValueError:
        await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—É—é —Å—É–º–º—É (—á–∏—Å–ª–æ).")
        return AWAIT_CUSTOM_PRICE

    # 1. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –ë–î
    booking_id = context.user_data.get('extending_booking_id')
    days_to_extend = context.user_data.get('custom_extension_days')
    admin_id = update.message.from_user.id

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT b.user_id, b.bike_id, bk.name, u.phone_number
        FROM bookings b
        JOIN bikes bk ON b.bike_id = bk.id
        JOIN users u ON b.user_id = u.id
        WHERE b.id = ?
    """, (booking_id,))
    result = cursor.fetchone()
    conn.close()

    if not result:
        await update.message.reply_text("üö´ –û—à–∏–±–∫–∞: –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
        return ConversationHandler.END

    user_id, bike_id, bike_name, phone_number = result

    if not phone_number:
        await update.message.reply_text(f"üö´ –û—à–∏–±–∫–∞: —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID {user_id} –Ω–µ —É–∫–∞–∑–∞–Ω –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —á–µ–∫–∞.")
        return ConversationHandler.END

    # 2. –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–ª–∞—Ç–µ–∂–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    description = f"–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã '{bike_name}' –Ω–∞ {days_to_extend} –¥–Ω. (–∏–Ω–¥–∏–≤–∏–¥. —Ç–∞—Ä–∏—Ñ)"
    payload = f"prolong_{booking_id}_{days_to_extend}"
    metadata = {'internal_payload': payload, 'user_id': user_id, 'admin_id': admin_id}
    items_for_receipt = [{"description": description, "quantity": "1.00", "amount": {"value": f"{price:.2f}", "currency": "RUB"}, "vat_code": "1", "payment_subject": "service", "payment_mode": "full_payment"}]
    customer_info = {"phone": phone_number}

    # 3. –°–æ–∑–¥–∞–µ–º –ø–ª–∞—Ç–µ–∂ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    payment_info = await create_yookassa_payment(
        amount=price, description=description, metadata=metadata,
        items=items_for_receipt, customer_info=customer_info, payment_method='sbp'
    )

    if not (payment_info and payment_info.get('url')):
        await update.message.reply_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É –≤ –ÆKassa. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        return ConversationHandler.END

    # 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
    payment_url, payment_id, final_amount = payment_info['url'], payment_info['id'], payment_info['final_amount']

    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    async with aiosqlite.connect(DB_FILE) as conn_async:
        conn_async.row_factory = aiosqlite.Row
        user_name_formatted = await get_user_info_for_notification(user_id, conn_async)
    await update.message.reply_text(
        f"‚úÖ –°—á–µ—Ç –Ω–∞ —Å—É–º–º—É {final_amount:.2f} ‚ÇΩ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_name_formatted} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω."
    )

    # <<< –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>

    # –ü–ï–†–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏
    await context.bot.send_message(
        chat_id=user_id,
        text=f"‚úÖ –í–∞—à–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –Ω–∞ *{days_to_extend} –¥–Ω–µ–π* —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–æ! –ì–æ—Ç–æ–≤–∏–º —Å—á–µ—Ç...",
        parse_mode="Markdown"
    )

    # –í–¢–û–†–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ - —É–∂–µ —Å–∞–º —Å—á–µ—Ç
    user_invoice_message = f"–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã {final_amount:.2f} ‚ÇΩ"
    keyboard = [[InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å", url=payment_url)]]

    # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –Ω–∞ –≤—Ç–æ—Ä–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
    animated_message = await context.bot.send_message(
        chat_id=user_id,
        text=user_invoice_message,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

    # <<< –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>

    # 5. –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    if 'pending_payments' not in context.bot_data:
        context.bot_data['pending_payments'] = {}

    stop_animation_event = asyncio.Event()
    context.bot_data['pending_payments'][payment_id] = {
        'user_id': user_id, 'start_time': datetime.now(),
        'payload': metadata['internal_payload'], 'amount': final_amount,
        'animated_message_id': animated_message.message_id, 'url': payment_url,
        'animation_sequence': random.choice(PAYMENT_ANIMATIONS),
        'stop_animation_event': stop_animation_event
    }

    asyncio.create_task(animate_payment_message(context, payment_id))
    context.job_queue.run_repeating(
        callback=check_payment_status, interval=15, first=10,
        name=f"payment_{payment_id}", data={'yookassa_id': payment_id}
    )

    context.user_data.clear()
    return ConversationHandler.END

async def handle_custom_extension(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    await query.answer()

    booking_id = int(query.data.split("_")[2])
    context.user_data['extending_booking_id'] = booking_id

    await query.message.reply_text(
        "–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è (–æ—Ç 1 –¥–æ 30):"
    )
    return CUSTOM_EXTENSION

async def process_custom_extension(update: Update, context: CallbackContext) -> int:
    try:
        days = int(update.message.text.strip())
        if days < 1 or days > 30:
            await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 30.")
            return CUSTOM_EXTENSION

        booking_id = context.user_data.get('extending_booking_id')
        await process_extension(update, context, days, booking_id)
        return ConversationHandler.END
    except ValueError:
        await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ.")
        return CUSTOM_EXTENSION

async def handle_extension_choice(update: Update, context: CallbackContext):
    query = update.callback_query
    await query.answer()

    data_parts = query.data.split("_")

    if data_parts[1] == "custom":
        return await handle_custom_extension(update, context)

    days_to_extend = int(data_parts[1])
    booking_id = int(data_parts[2])

    await process_extension(update, context, days_to_extend, booking_id)

async def process_extension(update: Update, context: CallbackContext, days_to_extend: int, booking_id: int):
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π
    if days_to_extend <= 7:
        extension_price = 3750
    elif days_to_extend <= 14:
        extension_price = 7500
    else:
        extension_price = 15000

    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã
    keyboard = [
        [
            InlineKeyboardButton("‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞", callback_data=f"payment_yes_{booking_id}_{days_to_extend}_{extension_price}"),
            InlineKeyboardButton("‚ùå –û–ø–ª–∞—Ç—ã –Ω–µ—Ç", callback_data=f"payment_no_{booking_id}_{days_to_extend}")
        ]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    message = (
        f"–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –Ω–∞ {days_to_extend} –¥–Ω–µ–π\n"
        f"–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ: {extension_price} —Ä—É–±.\n\n"
        f"–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã:"
    )

    if isinstance(update, Update) and update.message:
        await update.message.reply_text(message, reply_markup=reply_markup)
    else:
        await update.callback_query.message.reply_text(message, reply_markup=reply_markup)

async def handle_payment_confirmation(update: Update, context: CallbackContext):
    query = update.callback_query
    await query.answer()

    data_parts = query.data.split("_")
    payment_received = data_parts[1] == "yes"
    booking_id = int(data_parts[2])
    days_to_extend = int(data_parts[3])

    # –ï—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞, —É –Ω–∞—Å –±—É–¥–µ—Ç —Å—É–º–º–∞ –≤ –∑–∞–ø—Ä–æ—Å–µ
    extension_price = int(data_parts[4]) if payment_received else None

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    try:
        cursor.execute("""
            SELECT b.end_date, b.user_id, bi.name, bi.id, b.status
            FROM bookings b
            JOIN bikes bi ON b.bike_id = bi.id
            WHERE b.id = ?
        """, (booking_id,))
        booking_info = cursor.fetchone()

        if not booking_info:
            await query.message.reply_text("üö´ –û—à–∏–±–∫–∞: –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
            return

        current_end_date, user_id, bike_name, bike_id, status = booking_info

        if status != 'rented':
            await query.message.reply_text("üö´ –û—à–∏–±–∫–∞: –∞—Ä–µ–Ω–¥–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞")
            return

        current_end_date_obj = datetime.strptime(current_end_date, '%d.%m.%Y')
        current_date = datetime.now()

        overdue_days = (current_date - current_end_date_obj).days if current_date > current_end_date_obj else 0
        effective_days = max(days_to_extend - overdue_days, 0)
        new_end_date = current_date + timedelta(days=effective_days) if overdue_days else current_end_date_obj + timedelta(days=days_to_extend)

        new_end_date_str = new_end_date.strftime('%d.%m.%Y')

        cursor.execute("UPDATE bookings SET end_date=? WHERE id=?", (new_end_date_str, booking_id))
        conn.commit()

        payment_status = "‚úÖ –û–ø–ª–∞—á–µ–Ω–æ" if payment_received else "‚ùå –ë–µ–∑ –æ–ø–ª–∞—Ç—ã"
        admin_msg = (
            f"üîÑ –ê—Ä–µ–Ω–¥–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ {bike_name} –ø—Ä–æ–¥–ª–µ–Ω–∞!\n"
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ID: {user_id}\n"
            f"üìÖ –ù–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: {new_end_date_str}\n"
            f"‚è≥ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–Ω–µ–π: {days_to_extend}\n"
            f"üö® –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –¥–Ω–µ–π: {overdue_days}\n"
            f"üí∞ –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã: {payment_status}"
        )

        if payment_received:
            admin_msg += f"\nüíµ –°—É–º–º–∞: {extension_price} —Ä—É–±."

        await query.message.reply_text(admin_msg)

        user_msg = (
            f"üö≤ –í–∞—à–∞ –∞—Ä–µ–Ω–¥–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ <b>{bike_name}</b> –ø—Ä–æ–¥–ª–µ–Ω–∞!\n\n"
            f"üìÖ –ù–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: <b>{new_end_date_str}</b>\n"
            f"‚è≥ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–Ω–µ–π: <b>{days_to_extend}</b>\n"
            f"üö® –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –¥–Ω–µ–π: <b>{overdue_days}</b>\n"
        )

        if payment_received:
            user_msg += f"üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –ø—Ä–æ–¥–ª–µ–Ω–∏—è: <b>{extension_price} —Ä—É–±.</b>\n\n"

        user_msg += "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø–æ–ª—å–∑—É–µ—Ç–µ—Å—å –Ω–∞—à–∏–º —Å–µ—Ä–≤–∏—Å–æ–º!"

        await context.bot.send_message(
            chat_id=user_id,
            text=user_msg,
            parse_mode="HTML"
        )

        # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—É—á–µ–Ω–∞ –æ–ø–ª–∞—Ç–∞
        if payment_received:
            log_bike_action(
                bike_id=bike_id,
                user_id=user_id,
                action="–ü—Ä–æ–¥–ª–µ–Ω–∏–µ (–æ–ø–ª–∞—á–µ–Ω–æ)",
                details=(
                    f"+{days_to_extend} –¥–Ω–µ–π\n"
                    f"–ù–æ–≤—ã–π —Å—Ä–æ–∫: {new_end_date_str}\n"
                    f"–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –¥–Ω–µ–π: {overdue_days}"
                ),
                amount=extension_price
            )
        else:
            # –ü—Ä–æ—Å—Ç–æ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ –±–µ–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            log_bike_action(
                bike_id=bike_id,
                user_id=user_id,
                action="–ü—Ä–æ–¥–ª–µ–Ω–∏–µ (–±–µ–∑ –æ–ø–ª–∞—Ç—ã)",
                details=(
                    f"+{days_to_extend} –¥–Ω–µ–π\n"
                    f"–ù–æ–≤—ã–π —Å—Ä–æ–∫: {new_end_date_str}\n"
                    f"–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ –¥–Ω–µ–π: {overdue_days}"
                )
            )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è: {e}")
        await query.message.reply_text("üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏ –∞—Ä–µ–Ω–¥—ã")

    finally:
        conn.close()

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ accept_rental –ù–ê –≠–¢–£

async def accept_rental(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    await query.answer()
    booking_id = int(query.data.split("_")[2])

    keyboard = [
        [
            InlineKeyboardButton("‚úÖ –ü—Ä–∏–Ω—è—Ç—å", callback_data=f"rental_accept_{booking_id}"),
            InlineKeyboardButton("üîß –í —Ä–µ–º–æ–Ω—Ç", callback_data=f"rental_repair_{booking_id}")
        ]
    ]

    # ### –ò–ó–ú–ï–ù–ï–ù–ò–ï: –¢–µ–∫—Å—Ç —Å—Ç–∞–ª –±–æ–ª–µ–µ –æ–±—â–∏–º ###
    await query.edit_message_text(
        text=(
            "–ù–∞–∂–∏–º–∞—è *‚úÖ –ü—Ä–∏–Ω—è—Ç—å*:\n"
            "- –í—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ –∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—å —Ç–æ–≤–∞—Ä–∞\n"
            "- –û—á–µ—Ä–µ–¥—å (–µ—Å–ª–∏ –µ—Å—Ç—å) –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞\n"
            "- –¢–æ–≤–∞—Ä —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∞—Ä–µ–Ω–¥—ã/–≤—ã–∫—É–ø–∞\n\n"
            "–ù–∞–∂–∏–º–∞—è *üîß –í —Ä–µ–º–æ–Ω—Ç*:\n"
            "- –¢–æ–≤–∞—Ä –±—É–¥–µ—Ç –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω\n"
            "- –û—á–µ—Ä–µ–¥—å (–µ—Å–ª–∏ –µ—Å—Ç—å) —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è\n"
            "- –í—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏ –Ω–∞ —ç—Ç—É –º–æ–¥–µ–ª—å –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã"
        ),
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )
async def mock_payment_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–¢–µ—Å—Ç–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞".
    –ò–º–∏—Ç–∏—Ä—É–µ—Ç —É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫.
    """
    query = update.callback_query
    await query.answer("‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –æ–ø–ª–∞—Ç–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!")
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π
    await query.message.delete()

    # –§–æ—Ä–º–∞—Ç callback_data: mock_payment_{original_payload}_{amount_in_rubles}
    # –ü—Ä–∏–º–µ—Ä: "mock_payment_rental_123_14_6500"

    # –û—Ç–¥–µ–ª—è–µ–º 'mock_payment_' –æ—Ç –æ—Å—Ç–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–∏
    data_parts = query.data.split('_', 2)
    payload_with_price = data_parts[2]

    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å—É–º–º—É –∏–∑ –∫–æ–Ω—Ü–∞ —Å—Ç—Ä–æ–∫–∏
    payload_parts = payload_with_price.rsplit('_', 1)
    original_payload = payload_parts[0]
    amount_rub = int(payload_parts[1])

    user_id = query.from_user.id

    # –í—ã–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –ø–µ—Ä–µ–¥–∞–≤–∞—è –µ–º—É "—Ñ–µ–π–∫–æ–≤—ã–π" update, –Ω–æ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    await process_successful_payment(update, context, user_id, original_payload, amount_rub)
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ handle_rental_decision –ù–ê –≠–¢–£

async def handle_rental_decision(update: Update, context: CallbackContext, accept: bool) -> None:
    query = update.callback_query
    if not query or not query.data:
        logger.error("–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç callback_query –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ")
        return

    try:
        await query.answer()
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞: {e}")
        return

    try:
        booking_id = int(query.data.split("_")[2])
    except (IndexError, ValueError) as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ booking_id: {e}")
        await query.message.reply_text("üö´ –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±—Ä–æ–Ω–∏")
        return

    conn = None
    try:
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        cursor.row_factory = sqlite3.Row # –î–ª—è —É–¥–æ–±—Å—Ç–≤–∞

        cursor.execute("SELECT bike_id, user_id FROM bookings WHERE id=?", (booking_id,))
        booking_info = cursor.fetchone()
        if not booking_info:
            await query.message.reply_text("üö´ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
            return

        bike_id, user_id = booking_info['bike_id'], booking_info['user_id']

        # –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ (–∏ –∞—Ä–µ–Ω–¥—ã, –∏ —Ä–∞—Å—Å—Ä–æ—á–∫–∏)
        cursor.execute("DELETE FROM bookings WHERE id=?", (booking_id,))

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞/–ê–ö–ë
        new_status = 1 if accept else 0
        cursor.execute("UPDATE bikes SET available=?, owner_id=NULL WHERE id=?", (new_status, bike_id))
        conn.commit()

        cursor.execute("SELECT name FROM bikes WHERE id=?", (bike_id,))
        item_name_row = cursor.fetchone()
        item_name = item_name_row['name'] if item_name_row else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ–≤–∞—Ä"

        try:
            status_text = "–ø—Ä–∏–Ω—è—Ç –≤ —Ä–∞–±–æ—Ç—É" if accept else "–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —Ä–µ–º–æ–Ω—Ç"
            emoji = "‚úÖ" if accept else "üîß"
            current_time = datetime.now().strftime("%d.%m.%Y %H:%M:%S")

            for admin_id in ADMIN_IDS:
                await context.bot.send_message(
                    admin_id,
                    f"{emoji} [{current_time}] –¢–æ–≤–∞—Ä '{item_name}' {status_text}\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_id}"
                )

            # ### –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ###
            await context.bot.send_message(
                user_id,
                f"{'üö≤ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω! –°–ø–∞—Å–∏–±–æ!' if accept else 'üîß –¢–æ–≤–∞—Ä –ø—Ä–∏–Ω—è—Ç –≤ —Ä–µ–º–æ–Ω—Ç. –ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é!'}"
            )

            if accept:
                cursor.execute("SELECT id, user_id, status FROM queue ORDER BY created_at ASC")
                queue = cursor.fetchall()
                if queue:
                    first_in_queue = queue[0]
                    cursor.execute("DELETE FROM queue WHERE id=?", (first_in_queue['id'],))
                    conn.commit()
                    await context.bot.send_message(first_in_queue['user_id'], f"üéâ –¢–æ–≤–∞—Ä, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –∂–¥–∞–ª–∏, —Å—Ç–∞–ª –¥–æ—Å—Ç—É–ø–µ–Ω! –ú–æ–∂–µ—Ç–µ –µ–≥–æ –∞—Ä–µ–Ω–¥–æ–≤–∞—Ç—å.")
                    logger.info(f"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–ª–µ–¥—É—é—â–µ–º—É –≤ –æ—á–µ—Ä–µ–¥–∏: user_id {first_in_queue['user_id']}")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—á–µ—Ä–µ–¥–∏ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (ID –±—Ä–æ–Ω–∏: {booking_id}): {e}", exc_info=True)

        action_text = "–ü—Ä–∏–Ω—è—Ç –≤ —Ä–∞–±–æ—Ç—É" if accept else "–í —Ä–µ–º–æ–Ω—Ç"
        details = f"–¢–æ–≤–∞—Ä {item_name} {action_text.lower()}"

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –µ—Å–ª–∏ log_bike_action –Ω–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π
        log_bike_action(bike_id, user_id, action_text, details)
        logger.info(f"[{current_time}] {action_text}: –¢–æ–≤–∞—Ä '{item_name}', –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_id}")

        # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∞ –æ–± —É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
        await query.message.edit_text(f"‚úÖ –¢–æ–≤–∞—Ä '{item_name}' —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–Ω—è—Ç –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.")

    except Exception as e:
        current_time = datetime.now().strftime("%d.%m.%Y %H:%M:%S")
        logger.error(f"[{current_time}] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ handle_rental_decision: {e}", exc_info=True)
        await query.message.reply_text("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ.")
    finally:
        if conn:
            conn.close()

async def process_accept_rental(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    await query.answer()
    booking_id = int(query.data.split("_")[2])
    await handle_rental_decision(update, context, accept=True)

async def process_start_repair(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    await query.answer()

    booking_id = int(query.data.split("_")[2])
    context.user_data['repair_booking_id'] = booking_id

    await query.edit_message_text(
        "üîß –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –≤ —Ä–µ–º–æ–Ω—Ç:\n"
        "–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Å–ª–æ–º–∞–ª–æ—Å—å –∏–ª–∏ —Ç—Ä–µ–±—É–µ—Ç —Ä–µ–º–æ–Ω—Ç–∞."
    )
    return RENTAL_REPAIR_REASON

async def handle_repair_reason(update: Update, context: CallbackContext) -> int:
    reason = update.message.text
    context.user_data['repair_reason'] = reason

    await update.message.reply_text("üë∑ –í–≤–µ–¥–∏—Ç–µ –∏–º—è –º–∞—Å—Ç–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–µ–ª–æ—Å–∏–ø–µ–¥ –≤ —Ä–µ–º–æ–Ω—Ç:")
    return RENTAL_REPAIR_PERSON

async def handle_repair_person(update: Update, context: CallbackContext) -> int:
    repair_person = update.message.text
    context.user_data['repair_person'] = repair_person

    keyboard = [
        [InlineKeyboardButton("–î–∞", callback_data="warranty_yes")],
        [InlineKeyboardButton("–ù–µ—Ç", callback_data="warranty_no")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text("üîß –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç?", reply_markup=reply_markup)
    return RENTAL_REPAIR_WARRANTY

# main.py

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ handle_warranty –ù–ê –≠–¢–£ –ò–°–ü–†–ê–í–õ–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ

async def handle_warranty(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø:
    - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —Ç–∏–ø–∞ —Ä–µ–º–æ–Ω—Ç–∞.
    - –ü—Ä–∏ –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω–æ–º —Ä–µ–º–æ–Ω—Ç–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ü–µ–Ω—É 0 –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –¥–∞—Ç–µ.
    - –ü—Ä–∏ –ù–ï–≥–∞—Ä–∞–Ω—Ç–∏–π–Ω–æ–º —Ä–µ–º–æ–Ω—Ç–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –¶–ï–ù–£.
    """
    query = update.callback_query
    await query.answer()

    # <<< –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>

    if query.data == "warranty_yes":
        # –ï—Å–ª–∏ —Ä–µ–º–æ–Ω—Ç –ì–ê–†–ê–ù–¢–ò–ô–ù–´–ô
        context.user_data['is_warranty'] = True
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–µ–Ω—É –≤ 0, —Ç–∞–∫ –∫–∞–∫ –æ–ø–ª–∞—Ç–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è
        context.user_data['warranty_amount'] = 0.0
        # –°—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∑–∞–ø—Ä–æ—Å—É –¥–∞—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        await query.edit_message_text("–ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç. –í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—É—é –¥–∞—Ç—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (—Ñ–æ—Ä–º–∞—Ç –î–î.–ú–ú.–ì–ì–ì–ì):")
        return RENTAL_REPAIR_ESTIMATED_DATE

    elif query.data == "warranty_no":
        # –ï—Å–ª–∏ —Ä–µ–º–æ–Ω—Ç –ù–ï –ì–ê–†–ê–ù–¢–ò–ô–ù–´–ô
        context.user_data['is_warranty'] = False
        # –¢–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—É–º–º—É —Ä–µ–º–æ–Ω—Ç–∞
        await query.edit_message_text("üí∞ –í–≤–µ–¥–∏—Ç–µ –°–¢–û–ò–ú–û–°–¢–¨ –Ω–µ–≥–∞—Ä–∞–Ω—Ç–∏–π–Ω–æ–≥–æ —Ä–µ–º–æ–Ω—Ç–∞ –≤ —Ä—É–±–ª—è—Ö:")
        # –ò –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è —Å—É–º–º—ã
        return RENTAL_REPAIR_WARRANTY_AMOUNT

    # <<< –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>

    # –ù–∞ —Å–ª—É—á–∞–π –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    return ConversationHandler.END

async def handle_warranty_amount(update: Update, context: CallbackContext) -> int:
    try:
        amount = float(update.message.text)
        context.user_data['warranty_amount'] = amount
    except ValueError:
        await update.message.reply_text("üö´ –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—É–º–º—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑:")
        return RENTAL_REPAIR_WARRANTY_AMOUNT

    await update.message.reply_text("üìÖ –í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—É—é –¥–∞—Ç—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–º–æ–Ω—Ç–∞ (—Ñ–æ—Ä–º–∞—Ç –î–î.–ú–ú.–ì–ì–ì–ì):")
    return RENTAL_REPAIR_ESTIMATED_DATE

# main.py

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞
import aiosqlite
from datetime import datetime
import asyncio
import random

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ handle_estimated_date –ù–ê –≠–¢–£ –£–õ–£–ß–®–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ
# main.py

# ... (–≤—Å–µ –≤–∞—à–∏ –∏–º–ø–æ—Ä—Ç—ã) ...

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ handle_estimated_date –ù–ê –≠–¢–£ –£–õ–£–ß–®–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ
# main.py

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞
import aiosqlite
from datetime import datetime
import asyncio
import random

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ handle_estimated_date –ù–ê –≠–¢–£ –ü–û–õ–ù–£–Æ –í–ï–†–°–ò–Æ
async def handle_estimated_date(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –§–ò–ù–ê–õ –î–ò–ê–õ–û–ì–ê –†–ï–ú–û–ù–¢–ê –° –£–õ–£–ß–®–ï–ù–ù–´–ú–ò –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø–ú–ò –ò –í–´–°–¢–ê–í–õ–ï–ù–ò–ï–ú –°–ß–ï–¢–ê:
    - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–¥–º–∏–Ω—É –§–ò–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç—É –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ä–µ–º–æ–Ω—Ç–µ –ü–ï–†–ï–î —Å—á–µ—Ç–æ–º.
    - –ï—Å–ª–∏ —Ä–µ–º–æ–Ω—Ç –ø–ª–∞—Ç–Ω—ã–π, –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç —Å—á–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.
    """
    date_str = update.message.text
    admin_chat_id = update.effective_chat.id
    try:
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç—ã
        datetime.strptime(date_str, "%d.%m.%Y")
        context.user_data['estimated_completion_date'] = date_str
    except ValueError:
        await update.message.reply_text("üö´ –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑:")
        return RENTAL_REPAIR_ESTIMATED_DATE

    # –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    booking_id = context.user_data.get('repair_booking_id')
    reason = context.user_data.get('repair_reason')
    repair_person = context.user_data.get('repair_person')
    is_warranty = context.user_data.get('is_warranty')
    price = context.user_data.get('warranty_amount', 0.0)
    estimated_completion_date = context.user_data['estimated_completion_date']
    current_date = datetime.now().strftime("%d.%m.%Y")

    if not booking_id:
        await update.message.reply_text("üö´ –û—à–∏–±–∫–∞ —Å–µ—Å—Å–∏–∏: –Ω–µ –Ω–∞–π–¥–µ–Ω ID –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.")
        return ConversationHandler.END

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            await conn.execute("BEGIN")

            # 1. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
            cursor = await conn.execute(
                "SELECT b.user_id, b.bike_id, u.first_name, u.last_name, u.phone_number, bk.name as bike_name "
                "FROM bookings b "
                "JOIN users u ON b.user_id = u.id "
                "JOIN bikes bk ON b.bike_id = bk.id "
                "WHERE b.id=?",
                (booking_id,)
            )
            data = await cursor.fetchone()
            if not data: raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–º–æ–Ω—Ç–∞.")
            user_id, bike_id, first_name, last_name, phone_number, bike_name = data

            # 2. –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∞—Ä–µ–Ω–¥—É
            await conn.execute("DELETE FROM bookings WHERE id=?", (booking_id,))

            # 3. –°–æ–∑–¥–∞–µ–º –∑–∞—è–≤–∫—É –Ω–∞ —Ä–µ–º–æ–Ω—Ç
            repair_status = 'completed' if not is_warranty and price > 0 else 'oplacheno'
            completed_at = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

            cursor = await conn.execute(
                "INSERT INTO repair_requests (user_id, bike_id, description, status, estimated_price, is_warranty, completed_at) VALUES (?, ?, ?, ?, ?, ?, ?)",
                (user_id, bike_id, reason, repair_status, price, 1 if is_warranty else 0, completed_at)
            )
            request_id = cursor.lastrowid

            # 4. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –∏ –ª–æ–≥–∏—Ä—É–µ–º
            await conn.execute("UPDATE bikes SET available=0, repair_status='in_repair', repair_reason=? WHERE id=?", (reason, bike_id))
            await log_bike_action(conn, bike_id, user_id, "–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ —Ä–µ–º–æ–Ω—Ç (—Å –≤–æ–∑–≤—Ä–∞—Ç–∞)", f"–ü—Ä–∏—á–∏–Ω–∞: {reason}", price)
            await conn.commit()

        # 5. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å –§–ò–û
        user_display_name = f"{first_name} {last_name}".strip() if first_name else f"ID: {user_id}"
        admin_msg = (
            f"üîß –í–µ–ª–æ—Å–∏–ø–µ–¥ '{bike_name}' –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —Ä–µ–º–æ–Ω—Ç\n"
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_display_name}\n"
            f"üë∑ –ú–∞—Å—Ç–µ—Ä: {repair_person}\n"
            f"üìù –ü—Ä–∏—á–∏–Ω–∞: {reason}\n"
            f"üìÖ –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞: {current_date}\n"
            f"üìÖ –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ: {estimated_completion_date}\n"
            f"{'üí∞ –ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç' if is_warranty else f'üí∞ –ù–µ–≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç, —Å—É–º–º–∞: {price:.2f} ‚ÇΩ'}"
        )
        await update.message.reply_text(admin_msg)

        # 6. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ —Å—á–µ—Ç –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
        if not is_warranty and price > 0:
            # –°–Ω–∞—á–∞–ª–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            user_info_message = (
                f"üõ†Ô∏è *–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —Ä–µ–º–æ–Ω—Ç—É –≤–∞—à–µ–≥–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ ¬´{bike_name}¬ª*\n\n"
                f"**–ü—Ä–∏—á–∏–Ω–∞:** {reason}\n"
                f"**–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–º–æ–Ω—Ç–∞:** {price:.2f} ‚ÇΩ\n\n"
                "–°–µ–π—á–∞—Å –º—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–º —Å—á–µ—Ç –¥–ª—è –æ–ø–ª–∞—Ç—ã."
            )
            await context.bot.send_message(user_id, user_info_message, parse_mode="Markdown")

            # –¢–µ–ø–µ—Ä—å –≤—ã—Å—Ç–∞–≤–ª—è–µ–º —Å—á–µ—Ç
            if not phone_number:
                await context.bot.send_message(admin_chat_id, f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—Å—Ç–∞–≤–∏—Ç—å —Å—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_display_name} (–Ω–µ—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞).")
            else:
                description = f"–û–ø–ª–∞—Ç–∞ —Ä–µ–º–æ–Ω—Ç–∞ '{bike_name}' (–∑–∞—è–≤–∫–∞ #{request_id})"
                payload = f"repair_payment_{request_id}"
                metadata = {'internal_payload': payload, 'user_id': user_id}
                items = [{"description": description, "quantity": "1.00", "amount": {"value": f"{price:.2f}", "currency": "RUB"}, "vat_code": "1"}]
                customer = {"phone": phone_number}

                payment_info = await create_yookassa_payment(price, description, metadata, items, customer, 'sbp')
                if not payment_info:
                    await context.bot.send_message(admin_chat_id, f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –∑–∞—è–≤–∫–∏ #{request_id}.")
                else:
                    payment_url, payment_id, final_amount = payment_info['url'], payment_info['id'], payment_info['final_amount']
                    keyboard = [[InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å", url=payment_url)]]

                    animated_message = await context.bot.send_message(
                        user_id,
                        f"–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã {final_amount:.2f} ‚ÇΩ",
                        reply_markup=InlineKeyboardMarkup(keyboard)
                    )

                    if 'pending_payments' not in context.bot_data: context.bot_data['pending_payments'] = {}
                    stop_animation_event = asyncio.Event()
                    context.bot_data['pending_payments'][payment_id] = {'user_id': user_id, 'start_time': datetime.now(),'payload': payload, 'amount': final_amount, 'animated_message_id': animated_message.message_id, 'url': payment_url, 'animation_sequence': random.choice(PAYMENT_ANIMATIONS), 'stop_animation_event': stop_animation_event}
                    asyncio.create_task(animate_payment_message(context, payment_id))
                    context.job_queue.run_repeating(callback=check_payment_status, interval=15, first=10, name=f"payment_{payment_id}", data={'yookassa_id': payment_id})

                    await context.bot.send_message(admin_chat_id, f"‚úÖ –°—á–µ—Ç –Ω–∞ {final_amount:.2f} ‚ÇΩ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É.")
        else: # –ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç
            user_info_message = (
                f"üõ†Ô∏è *–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —Ä–µ–º–æ–Ω—Ç—É –≤–∞—à–µ–≥–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ ¬´{bike_name}¬ª*\n\n"
                f"**–ü—Ä–∏—á–∏–Ω–∞:** {reason}\n"
                f"**–°—Ç–∞—Ç—É—Å:** –ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç\n\n"
                "–û–ø–ª–∞—Ç–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è. –ú—ã —Å–æ–æ–±—â–∏–º, –∫–æ–≥–¥–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤."
            )
            await context.bot.send_message(user_id, user_info_message, parse_mode="Markdown")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ —Ä–µ–º–æ–Ω—Ç: {e}", exc_info=True)
        await update.message.reply_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
    finally:
        context.user_data.clear()
        return ConversationHandler.END

async def cancel_repair(update: Update, context: CallbackContext) -> int:
    query = update.callback_query
    if query:
        await query.answer()
        await query.edit_message_text("‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞")
    else:
        await update.message.reply_text("‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞")
    return ConversationHandler.END

async def start(update: Update, context) -> None:
    user_id = update.message.from_user.id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*), passport_photo FROM users WHERE id=?", (user_id,))
    result = cursor.fetchone()
    is_registered = result[0] > 0
    passport_photo = result[1] if result else None
    conn.close()

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –º–∞—Å—Ç–µ—Ä
    if user_id ==  835886969:
        if not context.user_data.get('first_time_user'):
            # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ
            await update.message.reply_sticker("CAACAgIAAxkBAAELJLhnafG1kLqQn-ZhJw844LdDmRAbswACZSAAAoF_KUrc8uTuPScLhTYE")
            await update.message.reply_text(
                "üîß –ü—Ä–∏–≤–µ—Ç, –º–∞—Å—Ç–µ—Ä! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–º–æ–Ω—Ç–∞–º–∏.\n\n"
                "–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ:\n"
                "   - üõ†Ô∏è –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–º–æ–Ω—Ç\n"
                "   - üîß –í—ã–ø–æ–ª–Ω—è—Ç—å —Ä–µ–º–æ–Ω—Ç–Ω—ã–µ —Ä–∞–±–æ—Ç—ã\n\n"
                "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é –Ω–∏–∂–µ:",
                reply_markup=get_main_menu(user_id)
            )
            context.user_data['first_time_user'] = True
        else:
            # –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥ –º–∞—Å—Ç–µ—Ä–∞
            await update.message.reply_sticker("CAACAgIAAxkBAAELJLhnafG1kLqQn-ZhJw844LdDmRAbswACZSAAAoF_KUrc8uTuPScLhTYE")
            await update.message.reply_text(
                "üîß –ü—Ä–∏–≤–µ—Ç, –º–∞—Å—Ç–µ—Ä! –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é –Ω–∏–∂–µ:",
                reply_markup=get_main_menu(user_id)
            )
        return  # –ó–∞–≤–µ—Ä—à–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–≤—ã–π –ª–∏ —Ä–∞–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ö–æ–¥–∏—Ç –≤ –±–æ—Ç–∞
    if not context.user_data.get('first_time_user'):
        if is_admin(user_id):
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∏–∫–µ—Ä –∏ –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∞
            await update.message.reply_sticker("CAACAgIAAxkBAAELJLhnafG1kLqQn-ZhJw844LdDmRAbswACZSAAAoF_KUrc8uTuPScLhTYE")
            await update.message.reply_text(
                "–ü—Ä–∏–≤–µ—Ç! üëã –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é –Ω–∏–∂–µ.",
                reply_markup=get_main_menu(user_id)
            )
            context.user_data['first_time_user'] = True
        else:
            # –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            await update.message.reply_text(
                "üåü *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç–∞ –¥–ª—è –∞—Ä–µ–Ω–¥—ã —ç–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤!* üåü\n\n"
                "üö¥‚Äç‚ôÇÔ∏è –ú—ã —Ä–∞–¥—ã, —á—Ç–æ –≤—ã –≤—ã–±—Ä–∞–ª–∏ –Ω–∞—Å! –ó–¥–µ—Å—å –≤—ã –Ω–∞–π–¥–µ—Ç–µ –≤—Å–µ, —á—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —É–¥–æ–±–Ω–æ–π –∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π –∞—Ä–µ–Ω–¥—ã —ç–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤.\n\n"
                "‚ú® *–ß—Ç–æ –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –≤ –±–æ—Ç–µ?*\n"
                "   - üóìÔ∏è *–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∏ –∞—Ä–µ–Ω–¥–æ–≤–∞—Ç—å* —ç–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥—ã –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª–∏–∫–æ–≤.\n"
                "   - üë§ *–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç*: —É–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–∏–º–∏ –∞—Ä–µ–Ω–¥–∞–º–∏, –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –∏ —Å—Ç–∞—Ç—É—Å—ã.\n"
                "   - üõ†Ô∏è *–ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–º–æ–Ω—Ç*: –±—ã—Å—Ç—Ä–æ —Å–æ–æ–±—â–∞–π—Ç–µ –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –∏—Ö —Å—Ç–∞—Ç—É—Å.\n"
                "   - üí≥ *–û–ø–ª–∞—Ç–∞*: —É–¥–æ–±–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã –∞—Ä–µ–Ω–¥—ã –∏ —Ä–µ–º–æ–Ω—Ç–æ–≤.\n"
                "   - üìä *–ö–æ–Ω—Ç—Ä–æ–ª—å –∏ —É—á–µ—Ç*: –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã –∏ –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.\n"
                "üìù *–ß—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤—Å–µ–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.*\n"
                "üìÑ *–î–ª—è –∞—Ä–µ–Ω–¥—ã —ç–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–≤–æ—é –ª–∏—á–Ω–æ—Å—Ç—å.*\n"
                "   - –í—ã –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞, –æ—Ç–ø—Ä–∞–≤–∏–≤ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –ø–∞—Å–ø–æ—Ä—Ç–∞.\n"
                "   - –ò–ª–∏ –ª–∏—á–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: *—É–ª. –°–∞–ª—Ç—ã–∫–æ–≤—Å–∫–∞—è, –¥. 53*.\n\n"
                "üí¨ *–í—Å–µ –≤–æ–ø—Ä–æ—Å—ã –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏–ª–∏ –ª–∏—á–Ω–æ @BFbike*\n\n"
                "üê± *–ú—ã –∑–Ω–∞–µ–º, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç –∫—É—Ä—å–µ—Ä—ã, –∏ –≥–æ—Ç–æ–≤—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –ª—É—á—à–∏–µ —É—Å–ª–æ–≤–∏—è:*\n"
                "   - –£–¥–æ–±–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã –∏ –≥–∏–±–∫–∏–µ —É—Å–ª–æ–≤–∏—è –∞—Ä–µ–Ω–¥—ã.\n"
                "   - –í—Å–µ –ø—Ä–æ—Å—Ç–æ, —Å—É–ø–µ—Ä –∏ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ!\n\n"
                "üëá *–ß—Ç–æ–±—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è, –Ω–∞–∂–º–∏—Ç–µ 'üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è ' *",
                parse_mode="Markdown",
                reply_markup=get_main_menu(user_id)
            )
            await update.message.reply_sticker("CAACAgIAAxkBAAELvTpnjFi9lrKfoO35DH4g2hrLVE6raAACuyAAAgUQIEuQBtrjrbLKljYE")
            context.user_data['first_time_user'] = True
    else:
        # –õ–æ–≥–∏–∫–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—Ö–æ–¥–æ–≤
        if not is_registered and not is_admin(user_id):
            await update.message.reply_sticker("CAACAgIAAxkBAAELvTRnjFROmx-PvTO_EcbJ5aW7KkY3twACViEAAtTlIErBD_uZckfSpzYE")
            await update.message.reply_text(
                "üåü –ü—Ä–∏–≤–µ—Ç! –°–æ–≤–µ—Ç—É–µ–º –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è! –¢–∞–∫ –≤–∞–º –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –±–æ–ª—å—à–µ —Ñ—É–Ω–∫—Ü–∏–π. üåü\n\n"
                "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é –Ω–∏–∂–µ:",
                reply_markup=get_main_menu(user_id)
            )
        else:
            if not passport_photo and not is_admin(user_id):
                await update.message.reply_sticker("CAACAgIAAxkBAAELvTRnjFROmx-PvTO_EcbJ5aW7KkY3twACViEAAtTlIErBD_uZckfSpzYE")
                await update.message.reply_text(
                    "üåü –ü—Ä–∏–≤–µ—Ç! –°–æ–≤–µ—Ç—É–µ–º –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–≤–æ—é –ª–∏—á–Ω–æ—Å—Ç—å! –¢–∞–∫ –≤—ã —Å–º–æ–∂–µ—Ç–µ –∞—Ä–µ–Ω–¥–æ–≤–∞—Ç—å —ç–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥ –ø—Ä—è–º–æ –≤ –±–æ—Ç–µ. üåü\n\n"
                    "üê± –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é –Ω–∏–∂–µ:",
                    reply_markup=get_main_menu(user_id)
                )
            else:
                # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–ª–∏ –∞–¥–º–∏–Ω–æ–≤
                await update.message.reply_sticker("CAACAgIAAxkBAAELJLhnafG1kLqQn-ZhJw844LdDmRAbswACZSAAAoF_KUrc8uTuPScLhTYE")
                await update.message.reply_text(
                    "–ü—Ä–∏–≤–µ—Ç! üëã –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é –Ω–∏–∂–µ.",
                    reply_markup=get_main_menu(user_id)
                )



    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ user_data
    context.user_data['config'] = config

async def send_news(update: Update, context) -> int:
    user_id = update.message.from_user.id
    if not is_admin(user_id):
        await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π.")
        return ConversationHandler.END

    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ —Ä–∞—Å—Å—ã–ª–∞—Ç—å (–∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ):")
    return 1  # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É (–≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –Ω–æ–≤–æ—Å—Ç–∏ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ)

async def broadcast_news(update: Update, context) -> int:
    news_message = update.message.caption or update.message.text  # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è

    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT id FROM users")
    users = cursor.fetchall()
    conn.close()

    for user in users:
        user_id = user[0]
        try:
            # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —è–≤–ª—è–µ—Ç—Å—è —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–µ–π
            if update.message.photo:
                photo = update.message.photo[-1].file_id  # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Ñ–æ—Ç–æ
                await context.bot.send_photo(chat_id=user_id, photo=photo, caption=news_message)
            else:
                # –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                await context.bot.send_message(chat_id=user_id, text=news_message)
        except Exception as e:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")

    await update.message.reply_text("‚úÖ –ù–æ–≤–æ—Å—Ç—å —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–æ—Å–ª–∞–Ω–∞ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º!")
    return ConversationHandler.END
from datetime import datetime

import sqlite3
import logging
from datetime import datetime, timedelta
import pytz
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from telegram.helpers import escape_markdown
async def check_rental_reminders(context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã:
    - –£–≤–µ–¥–æ–º–ª—è–µ—Ç –∑–∞ 3 –¥–Ω—è –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è
    - –°–æ–æ–±—â–∞–µ—Ç –æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∞—Ä–µ–Ω–¥–∞—Ö
    - –õ–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é
    """
    logging.info("üîÑ –ó–ê–ü–£–°–ö –ü–†–û–í–ï–†–ö–ò –ê–†–ï–ù–î ===================================")

    def get_day_suffix(days: int) -> str:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Ñ–æ—Ä–º—É —Å–ª–æ–≤–∞ '–¥–µ–Ω—å' –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —è–∑—ã–∫–∞."""
        if days % 10 == 1 and days % 100 != 11:
            return "–¥–µ–Ω—å"
        elif 2 <= days % 10 <= 4 and (days % 100 < 10 or days % 100 >= 20):
            return "–¥–Ω—è"
        return "–¥–Ω–µ–π"

    try:
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()

        logging.info("üîé –ü–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—Ä–µ–Ω–¥...")
        cursor.execute("SELECT id, user_id, end_date, bike_id FROM bookings WHERE status = 'rented'")
        active_rentals = cursor.fetchall()
        logging.info(f"üìä –ù–∞–π–¥–µ–Ω–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—Ä–µ–Ω–¥: {len(active_rentals)}")

        soon_expired = 0
        overdue_rentals = 0
        notifications_sent = 0

        for booking_id, user_id, end_date_str, bike_id in active_rentals:
            try:
                logging.info(f"\nüîç –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—Ä–µ–Ω–¥—ã #{booking_id}:")
                logging.info(f"   üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_id}")
                logging.info(f"   üö≤ –í–µ–ª–æ—Å–∏–ø–µ–¥ ID: {bike_id}")
                logging.info(f"   üìÖ –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: {end_date_str}")

                end_date = datetime.strptime(end_date_str, "%d.%m.%Y").date()
                now_date = datetime.now().date()
                days_remaining = (end_date - now_date).days

                message = None
                log_action = None
                log_details = None

                # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞ 3 –¥–Ω—è
                if 0 <= days_remaining <= 3:
                    soon_expired += 1
                    time_left = f"{days_remaining} {get_day_suffix(days_remaining)}" if days_remaining != 0 else "—Å–µ–≥–æ–¥–Ω—è"

                    message = (
                        f"–í–Ω–∏–º–∞–Ω–∏–µ!\n"
                        f"–î–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã –æ—Å—Ç–∞–ª–æ—Å—å: {time_left}!\n"
                        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–¥–ª–µ–≤–∞–π—Ç–µ –∏–ª–∏ —Å–¥–∞–≤–∞–π—Ç–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥ –≤–æ–≤—Ä–µ–º—è."
                    )
                    log_action = "–ù–∞–ø–æ–º–∏–Ω–∞–ª–∫–∞"
                    log_details = f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —á—Ç–æ –¥–æ –∫–æ–Ω—Ü–∞ –∞—Ä–µ–Ω–¥—ã {time_left}"

                # –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–∞—è –∞—Ä–µ–Ω–¥–∞
                elif days_remaining < 0:
                    overdue_rentals += 1
                    overdue_days = -days_remaining
                    time_overdue = f"{overdue_days} {get_day_suffix(overdue_days)}"

                    message = (
                        f"üö®–°–†–û–ß–ù–û!\n"
                        f"üö®–ü—Ä–æ—Å—Ä–æ—á–∫–∞ –Ω–∞ {time_overdue}!\n"
                        "üö®–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!"
                    )
                    log_action = "–ü—Ä–æ—Å—Ä–æ—á–∫–∞"
                    log_details = f"üö®üö®üö®–ü—Ä–æ—Å—Ä–æ—á–∫–∞ {time_overdue}"

                else:
                    logging.info("   ‚úÖ –ê—Ä–µ–Ω–¥–∞ –∞–∫—Ç–∏–≤–Ω–∞ (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è)")
                    continue

                # –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
                if message:
                    try:
                        await context.bot.send_message(
                            chat_id=user_id,
                            text=message
                        )
                        notifications_sent += 1
                        logging.info(f"   üì® –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")

                        # –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
                        log_bike_action(
                            bike_id=bike_id,
                            user_id=user_id,
                            action=log_action,
                            details=log_details
                        )
                        logging.info(f"   üìù –ó–∞–ø–∏—Å—å –≤ –∏—Å—Ç–æ—Ä–∏–∏: {log_action} - {log_details}")

                    except Exception as e:
                        logging.error(f"   ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {str(e)}")

            except Exception as e:
                logging.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—Ä–µ–Ω–¥—ã #{booking_id}: {str(e)}")

        # –ò—Ç–æ–≥–æ–≤–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
        logging.info("\nüìä –ò–¢–û–ì–ò –ü–†–û–í–ï–†–ö–ò:")
        logging.info(f"‚Ä¢ –í—Å–µ–≥–æ –∞—Ä–µ–Ω–¥: {len(active_rentals)}")
        logging.info(f"‚Ä¢ –°–∫–æ—Ä–æ –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è (3 –¥–Ω—è): {soon_expired}")
        logging.info(f"‚Ä¢ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö: {overdue_rentals}")
        logging.info(f"‚Ä¢ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: {notifications_sent}")
        logging.info("‚úÖ –ü–†–û–í–ï–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê ================================\n")

        conn.close()
    except Exception as e:
        logging.error(f"‚õîÔ∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: {str(e)}")
        raise

import sqlite3
import logging
from datetime import datetime, timedelta
import pytz
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from telegram.helpers import escape_markdown
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£

# ### –ù–û–í–ê–Ø, –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
# ### –ù–û–í–ê–Ø, –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø manage_bike ###

async def manage_bike(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞–º–∏ –∏ –ê–ö–ë.
    - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –≤—Å–µ–º —Ç–∏–ø–∞–º —Ç–æ–≤–∞—Ä–æ–≤.
    - –§–æ—Ä–º–∏—Ä—É–µ—Ç –æ–¥–Ω—É –æ–±—â—É—é –∫–Ω–æ–ø–∫—É "–°–¥–∞—Ç—å —Ç–æ–≤–∞—Ä".
    """
    try:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–µ–ª –≤—ã–∑–æ–≤ (—Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –∫–Ω–æ–ø–∫–∞)
        user = update.effective_user
        if not user or user.is_bot: return

        user_id = user.id

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∏–∫–µ—Ä –æ–¥–∏–Ω —Ä–∞–∑ –≤ –Ω–∞—á–∞–ª–µ
        if update.message: # –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–Ω–æ–ø–∫–µ –∏–∑ –º–µ–Ω—é
            await context.bot.send_sticker(chat_id=user_id, sticker="CAACAgIAAxkBAAELWEpneCDwY-TzVoqeqlYgjWiuxTNZbwAC6BwAAvyDKUoY8WDBCRptzzYE")

        info_parts = []
        keyboard_buttons = []
        has_active_items = False # –§–ª–∞–≥ –Ω–∞–ª–∏—á–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤

        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row

            # –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º —Ç–æ–≤–∞—Ä—ã –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            cursor = await conn.execute("SELECT name FROM bikes WHERE owner_id = ?", (user_id,))
            owned_items = await cursor.fetchall()

            for (item_name,) in owned_items:
                info_parts.append(
                    f"üéâ *–í–∞—à —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä ¬´{escape_markdown(item_name, version=2)}¬ª*\n"
                    f"   ‚îî –ù–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å, –æ–Ω –í–ê–®\\!"
                )

            # –ò—â–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã –∏ —Ä–∞—Å—Å—Ä–æ—á–∫–∏
            cursor = await conn.execute("""
                SELECT
                    b.id, b.bike_id, bi.name, bi.type as item_type,
                    b.booking_type, b.booking_date, b.end_date,
                    b.payment_plan_key, b.payments_made, b.next_payment_date
                FROM bookings b
                JOIN bikes bi ON b.bike_id = bi.id
                WHERE b.user_id = ? AND b.status = 'rented'
            """, (user_id,))
            active_items = await cursor.fetchall()

        if not active_items and not owned_items:
            await context.bot.send_message(
                chat_id=user_id,
                text="üåü *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏\\!* üåü\n\nüö´ –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—Ä–µ–Ω–¥ –∏–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏\\.",
                parse_mode="MarkdownV2"
            )
            return

        # –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π —Ç–æ–≤–∞—Ä, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥
        if active_items:
            has_active_items = True

        for item in active_items:
            (booking_id, bike_id, item_name, item_type, booking_type,
             booking_date, end_date, plan_key, payments_made, next_payment_date) = item

            if booking_type == 'buyout':
                plan = None
                total_payments = 0
                plan_label = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–ª–∞–Ω"

                if item_type == PRODUCT_TYPE_BIKE:
                    if plan_key in BUYOUT_PLANS:
                        plan = BUYOUT_PLANS[plan_key]
                        total_payments = plan.get('total_payments', 0)
                        plan_label = plan.get('full_label', plan_label)

                elif item_type == PRODUCT_TYPE_BATTERY:
                    battery_model = '60V21Ah' if '60V21Ah' in item_name else '60V30Ah'
                    if battery_model in BATTERY_BUYOUT_PLANS and plan_key in BATTERY_BUYOUT_PLANS[battery_model]['plans']:
                        plan = BATTERY_BUYOUT_PLANS[battery_model]['plans'][plan_key]
                        total_payments = plan.get('count', 0)
                        plan_label = plan.get('label', plan_label)

                if plan:
                    info_parts.append(
                        f"üí∞ *–†–∞—Å—Å—Ä–æ—á–∫–∞ –Ω–∞ ¬´{escape_markdown(item_name, version=2)}¬ª*\n"
                        f"   \\- –ü–ª–∞–Ω: *{escape_markdown(plan_label, version=2)}*\n"
                        f"   \\- –í–Ω–µ—Å–µ–Ω–æ –ø–ª–∞—Ç–µ–∂–µ–π: *{payments_made} –∏–∑ {total_payments}*\n"
                        f"   \\- –°–ª–µ–¥—É—é—â–∏–π –ø–ª–∞—Ç–µ–∂ –¥–æ: *{escape_markdown(str(next_payment_date), version=2)}*"
                    )
                    keyboard_buttons.append([InlineKeyboardButton(f"üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —Å–ª–µ–¥. –ø–ª–∞—Ç–µ–∂ ({item_name[:15]})", callback_data=f"pay_next_{booking_id}")])
                    keyboard_buttons.append([InlineKeyboardButton(f"üíµ –ü–æ–≥–∞—Å–∏—Ç—å –¥–æ—Å—Ä–æ—á–Ω–æ ({item_name[:15]})", callback_data=f"pay_full_{booking_id}")])
                else:
                    info_parts.append(f"‚ö†Ô∏è –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–ª–∞–Ω —Ä–∞—Å—Å—Ä–æ—á–∫–∏ –¥–ª—è ¬´{escape_markdown(item_name, version=2)}¬ª\\.")

            elif booking_type == 'rent':
                try:
                    status_text = ""
                    if end_date:
                        end_date_obj = datetime.strptime(end_date, "%d.%m.%Y")
                        remaining_days = (end_date_obj.date() - datetime.now(MOSCOW_TZ).date()).days
                        status_text = f"üö® *–ü–†–û–°–†–û–ß–ï–ù–û –î–ù–ï–ô: {-remaining_days}*" if remaining_days < 0 else f"‚è≥ *–û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π: {remaining_days}*"

                    emoji = "üö≤" if item_type == PRODUCT_TYPE_BIKE else "üîã"
                    info_parts.append(
                        f"{emoji} *–ê—Ä–µ–Ω–¥–∞ ¬´{escape_markdown(item_name, version=2)}¬ª*\n"
                        f"   \\- {status_text}"
                    )
                    keyboard_buttons.append([InlineKeyboardButton(f"–ü—Ä–æ–¥–ª–∏—Ç—å –∞—Ä–µ–Ω–¥—É ({item_name[:15]})", callback_data=f"prolong_rental_{booking_id}")])
                except (ValueError, TypeError):
                    info_parts.append(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞—Ä–µ–Ω–¥—ã ¬´{escape_markdown(item_name, version=2)}¬ª\\.")

        # ### –ù–û–í–´–ô –ö–û–î: –î–æ–±–∞–≤–ª—è–µ–º –æ–¥–Ω—É –æ–±—â—É—é –∫–Ω–æ–ø–∫—É "–°–¥–∞—Ç—å —Ç–æ–≤–∞—Ä", –µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã ###
        if has_active_items:
            # –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –æ—Ç–¥–µ–ª–µ–Ω–∏—è
            if keyboard_buttons:
                 keyboard_buttons.append([InlineKeyboardButton("‚îÄ" * 20, callback_data="noop")])
            keyboard_buttons.append([InlineKeyboardButton("‚Ü©Ô∏è –°–¥–∞—Ç—å —Ç–æ–≤–∞—Ä", callback_data="return_bike_start")])

        welcome_text = "üåü *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∞—à–∏–º–∏ —Ç–æ–≤–∞—Ä–∞–º–∏\\!* üåü\n\n"
        full_message_body = "\n\n".join(info_parts)
        final_message = welcome_text + full_message_body

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å/–æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        message_to_send = None
        if update.message:
            message_to_send = update.message
        elif update.callback_query:
            message_to_send = update.callback_query.message

        if message_to_send:
            await message_to_send.reply_text( # –ò—Å–ø–æ–ª—å–∑—É–µ–º reply_text –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
                text=final_message,
                parse_mode="MarkdownV2",
                reply_markup=InlineKeyboardMarkup(keyboard_buttons) if keyboard_buttons else None
            )

    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –≤ manage_bike: {str(e)}", exc_info=True)
        chat_id_to_report = update.effective_chat.id if update and update.effective_chat else None
        if chat_id_to_report:
            await context.bot.send_message(
                chat_id=chat_id_to_report,
                text="‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            )



async def fines_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –ú–µ–Ω—é –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —à—Ç—Ä–∞—Ñ–∞–º–∏.
    """
    query = update.callback_query
    await query.answer()

    user_id = query.from_user.id

    # –ü–æ–ª—É—á–∞–µ–º —à—Ç—Ä–∞—Ñ—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    with sqlite3.connect(DB_FILE) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT id, amount, created_at, status
            FROM fines
            WHERE user_id = ? AND status != 'paid'
            ORDER BY created_at DESC
        """, (user_id,))
        fines = cursor.fetchall()

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –æ–ø—Ü–∏—è–º–∏
    keyboard = []

    # –ö–Ω–æ–ø–∫–∏ –¥–ª—è –æ–ø–ª–∞—Ç—ã —à—Ç—Ä–∞—Ñ–æ–≤
    for fine in fines:
        fine_id, amount, _, _ = fine
        keyboard.append([InlineKeyboardButton(
            f"üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —à—Ç—Ä–∞—Ñ #{fine_id} ({amount}‚ÇΩ)",
            callback_data=f"pay_fine_{fine_id}"
        )])

    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
    keyboard.append([InlineKeyboardButton("‚úã –û—Å–ø–æ—Ä–∏—Ç—å —à—Ç—Ä–∞—Ñ", callback_data="dispute_fine")])
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–µ–Ω—é —à—Ç—Ä–∞—Ñ–æ–≤
    await query.message.reply_text(
        "üìù –ú–µ–Ω—é —à—Ç—Ä–∞—Ñ–æ–≤. –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

SELECT_FINE, UPLOAD_MEDIA, ENTER_DISPUTE_COMMENT = range(3)

async def start_dispute(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ—Å–ø–∞—Ä–∏–≤–∞–Ω–∏—è —à—Ç—Ä–∞—Ñ–∞"""
    query = update.callback_query
    await query.answer()  # –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º callback

    user_id = query.from_user.id  # –ü–æ–ª—É—á–∞–µ–º user_id –∏–∑ callback_query

    with sqlite3.connect(DB_FILE) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT id, amount, reason, created_at
            FROM fines
            WHERE user_id = ? AND status = 'unpaid'
        """, (user_id,))
        fines = cursor.fetchall()

    if not fines:
        await query.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç —à—Ç—Ä–∞—Ñ–æ–≤ –¥–ª—è –æ—Å–ø–∞—Ä–∏–≤–∞–Ω–∏—è")
        return ConversationHandler.END

    buttons = [
        InlineKeyboardButton(
            f"–®—Ç—Ä–∞—Ñ #{f[0]} - {f[1]}‚ÇΩ ({f[3][:10]})",
            callback_data=f"dispute_{f[0]}"
        ) for f in fines
    ]

    await query.message.reply_text(  # –ò—Å–ø–æ–ª—å–∑—É–µ–º query.message –≤–º–µ—Å—Ç–æ update.message
        "–í—ã–±–µ—Ä–∏—Ç–µ —à—Ç—Ä–∞—Ñ –¥–ª—è –æ—Å–ø–∞—Ä–∏–≤–∞–Ω–∏—è:",
        reply_markup=InlineKeyboardMarkup([buttons])
    )
    return SELECT_FINE

async def select_fine_for_dispute(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —à—Ç—Ä–∞—Ñ–∞"""
    query = update.callback_query
    await query.answer()

    fine_id = int(query.data.split("_")[1])
    context.user_data["dispute_fine_id"] = fine_id

    await query.edit_message_text(f"‚û°Ô∏è –í—ã–±—Ä–∞–Ω —à—Ç—Ä–∞—Ñ ID: {fine_id}")
    await query.message.reply_text(
        "üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞:\n"
        "(–º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–∫ —Ñ–∞–π–ª –∏–ª–∏ —Ñ–æ—Ç–æ)"
    )
    return UPLOAD_MEDIA

async def handle_dispute_media(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–∏–∞-–¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤"""
    user_id = update.message.from_user.id
    fine_id = context.user_data["dispute_fine_id"]

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º file_id –º–µ–¥–∏–∞
    if update.message.photo:
        media_type = 'photo'
        file_id = update.message.photo[-1].file_id
    elif update.message.video:
        media_type = 'video'
        file_id = update.message.video.file_id
    else:
        await update.message.reply_text("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ")
        return UPLOAD_MEDIA

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
    with sqlite3.connect(DB_FILE) as conn:
        cursor = conn.cursor()
        if media_type == 'photo':
            cursor.execute("UPDATE fines SET dispute_photo = ? WHERE id = ?", (file_id, fine_id))
        else:
            cursor.execute("UPDATE fines SET dispute_video = ? WHERE id = ?", (file_id, fine_id))
        conn.commit()

    await update.message.reply_text("üìù –ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –æ—Å–ø–∞—Ä–∏–≤–∞–Ω–∏—é:")
    return ENTER_DISPUTE_COMMENT

async def save_dispute_comment(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è"""
    comment = update.message.text.strip()
    fine_id = context.user_data["dispute_fine_id"]

    if len(comment) < 10:
        await update.message.reply_text("‚ùå –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤")
        return ENTER_DISPUTE_COMMENT

    with sqlite3.connect(DB_FILE) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            UPDATE fines SET
                dispute_comment = ?,
                dispute_status = 'pending',
                status = 'disputed'
            WHERE id = ?
        """, (comment, fine_id))
        conn.commit()

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    await update.message.reply_text(
        "‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ –æ—Å–ø–∞—Ä–∏–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!\n"
        "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç –µ—ë –≤ —Ç–µ—á–µ–Ω–∏–µ 3 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π."
    )

    # –û–ø–æ–≤–µ—â–∞–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
    for admin_id in ADMIN_IDS:
        try:
            await context.bot.send_message(
                chat_id=admin_id,
                text=f"üö® –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –æ—Å–ø–∞—Ä–∏–≤–∞–Ω–∏–µ —à—Ç—Ä–∞—Ñ–∞ #{fine_id}"
            )
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ {admin_id}: {e}")

    context.user_data.clear()
    return ConversationHandler.END

from datetime import datetime

import sqlite3
import logging
from datetime import datetime, timedelta
import pytz
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from telegram.helpers import escape_markdown
async def test_reminder(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    await update.message.reply_text("üîç –ò—â—É –≤–∞—à–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã...")

    try:
        # 1. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞—Ä–µ–Ω–¥ –∏–∑ –ë–î
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        cursor.execute("""
            SELECT b.id, b.end_date
            FROM bookings b
            WHERE b.user_id = ? AND b.status = 'rented'
            ORDER BY b.end_date DESC
        """, (user_id,))

        rentals = cursor.fetchall()
        conn.close()

        if not rentals:
            await update.message.reply_text("‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—Ä–µ–Ω–¥ –¥–ª—è —Ç–µ—Å—Ç–∞")
            return

        # 2. –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∞—Ä–µ–Ω–¥—É
        booking_id, end_date = rentals[0]

        # 3. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Ç–µ—Å—Ç–∞
        async def setup_test_reminder(context: ContextTypes.DEFAULT_TYPE):
            job_name = f"TEST_AUTO_{user_id}_{booking_id}"

            # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∑–∞–¥–∞–Ω–∏–π
            current_jobs = context.job_queue.get_jobs_by_name(job_name)
            for job in current_jobs:
                job.schedule_removal()

            # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
            context.job_queue.run_repeating(
                callback=send_reminder,
                interval=10,  # –ò–Ω—Ç–µ—Ä–≤–∞–ª 10 —Å–µ–∫—É–Ω–¥
                first=5,      # –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                name=job_name,
                data={
                    'user_id': user_id,
                    'booking_id': booking_id,
                    'end_date': end_date
                }
            )

        # 4. –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç
        await setup_test_reminder(context)
        await update.message.reply_text(
            f"üõ† –¢–µ—Å—Ç –∑–∞–ø—É—â–µ–Ω!\n"
            f"‚Ä¢ –ê—Ä–µ–Ω–¥–∞: #{booking_id}\n"
            f"‚Ä¢ –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: {end_date}\n"
            f"–ü–µ—Ä–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥..."
        )

    except Exception as e:
        logging.error(f"Test reminder error: {e}")
        await update.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç–µ—Å—Ç–∞")


async def schedule_reminder(context: ContextTypes.DEFAULT_TYPE, user_id: int,
                          booking_id: int, end_date_str: str):
    job_name = f"reminder_{user_id}_{booking_id}"

    # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è —ç—Ç–æ–π –∞—Ä–µ–Ω–¥—ã
    current_jobs = context.job_queue.get_jobs_by_name(job_name)
    for job in current_jobs:
        job.schedule_removal()

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –ü–µ—Ä–º–∏ (UTC+5)
    tz = pytz.timezone('Asia/Yekaterinburg')
    now = datetime.now(tz)
    target_time = now.replace(hour=20, minute=0, second=0, microsecond=0)

    # –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
    if now > target_time:
        target_time += timedelta(days=1)

    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ
    context.job_queue.run_repeating(
        callback=send_reminder,
        interval=timedelta(days=1),
        first=target_time,
        name=job_name,
        data={
            'user_id': user_id,
            'booking_id': booking_id,
            'end_date': end_date_str
        }
    )

# === –ù–ê–ß–ê–õ–û –ë–õ–û–ö–ê 1 ===

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
STATS_AWAIT_DATE_RANGE = range(990, 991)

async def start_detailed_report_date_prompt(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 1: –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–µ—Ä–∏–æ–¥ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –æ—Ç—á–µ—Ç–∞."""
    query = update.callback_query
    await query.answer()

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º, –∫–∞–∫–æ–π –∏–º–µ–Ω–Ω–æ –æ—Ç—á–µ—Ç –∑–∞–ø—Ä–æ—Å–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    context.user_data['report_info'] = query.data
    
    message_text = (
        "üìÖ *–û—Ç—á–µ—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥*\n\n"
        "–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `–î–î.–ú–ú.–ì–ì–ì–ì-–î–î.–ú–ú.–ì–ì–ì–ì`\n"
        "–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã: `—Å–µ–≥–æ–¥–Ω—è`, `–Ω–µ–¥–µ–ª—è`, `–º–µ—Å—è—Ü`."
    )
    
    await query.edit_message_text(message_text, parse_mode="Markdown")
    return STATS_AWAIT_DATE_RANGE

async def process_detailed_report_dates_and_generate(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 2: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–∞—Ç—ã, –≤—ã–∑—ã–≤–∞–µ—Ç –Ω—É–∂–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á–µ—Ç."""
    user_input = update.message.text.strip().lower()
    today = datetime.now()
    start_date, end_date = None, None

    try:
        if user_input == '—Å–µ–≥–æ–¥–Ω—è':
            start_date = end_date = today
        elif user_input == '–Ω–µ–¥–µ–ª—è':
            start_date = today - timedelta(days=today.weekday())
            end_date = today
        elif user_input == '–º–µ—Å—è—Ü':
            start_date = today.replace(day=1)
            end_date = today
        else:
            start_str, end_str = user_input.split('-')
            start_date = datetime.strptime(start_str.strip(), '%d.%m.%Y')
            end_date = datetime.strptime(end_str.strip(), '%d.%m.%Y')
    except (ValueError, IndexError):
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
        return STATS_AWAIT_DATE_RANGE

    status_message = await update.message.reply_text("‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é Excel-–æ—Ç—á–µ—Ç, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ –º–∏–Ω—É—Ç—ã...")

    report_info = context.user_data.get('report_info', '')
    parts = report_info.split('_')
    report_type = parts[2]
    investor_id = int(parts[3]) if len(parts) > 3 and parts[3].isdigit() else None
    filename = None
    
    try:
        # –í—ã–∑—ã–≤–∞–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –¥–∞—Ç
        if report_type == 'expenses':
             filename = generate_expense_report(start_date, end_date)
        else:
             filename = await generate_unified_report(
                 report_type=report_type, 
                 start_date=start_date, 
                 end_date=end_date, 
                 investor_id=investor_id
             )

        if filename and os.path.exists(filename):
            with open(filename, 'rb') as file:
                await context.bot.send_document(
                    chat_id=update.effective_chat.id,
                    document=file,
                    caption=f"‚úÖ –í–∞—à –æ—Ç—á–µ—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥ —Å {start_date.strftime('%d.%m.%Y')} –ø–æ {end_date.strftime('%d.%m.%Y')} –≥–æ—Ç–æ–≤."
                )
            os.remove(filename)
            await status_message.delete()
        else:
            await status_message.edit_text("üòî –í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—á–µ—Ç–∞ –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞ –ø–æ –¥–∞—Ç–∞–º: {e}", exc_info=True)
        await status_message.edit_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")

    context.user_data.clear()
    return ConversationHandler.END
async def send_reminder(context: ContextTypes.DEFAULT_TYPE):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ —Å–∫–æ—Ä–æ–º –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –∞—Ä–µ–Ω–¥—ã.
    """
    job = context.job
    data = job.data
    user_id = data['user_id']
    booking_id = data['booking_id']
    end_date_str = data['end_date']
    conn = None

    try:
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã
        cursor.execute("""
            SELECT status, end_date
            FROM bookings
            WHERE id = ? AND user_id = ?
        """, (booking_id, user_id))
        result = cursor.fetchone()

        if not result or result[0] != 'rented':
            logging.info(f"–ê—Ä–µ–Ω–¥–∞ #{booking_id} –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
            return

        # –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã
        end_date = datetime.strptime(end_date_str, "%d.%m.%Y").date()
        today = datetime.now().date()
        remaining_days = (end_date - today).days

        # –ï—Å–ª–∏ –∞—Ä–µ–Ω–¥–∞ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
        if remaining_days < 0:
            logging.info(f"–ê—Ä–µ–Ω–¥–∞ #{booking_id} –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
            job.schedule_removal()
            return

        # –ï—Å–ª–∏ –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã 3 –¥–Ω—è –∏–ª–∏ –º–µ–Ω—å—à–µ
        if 0 <= remaining_days <= 3:
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–∫–ª–æ–Ω–µ–Ω–∏–µ –¥–ª—è —Å–ª–æ–≤–∞ "–¥–µ–Ω—å"
            if remaining_days == 1:
                days_text = "–¥–µ–Ω—å"
            elif 2 <= remaining_days <= 4:
                days_text = "–¥–Ω—è"
            else:
                days_text = "–¥–Ω–µ–π"

            # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –≤—Å–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —á–∞—Å—Ç–∏
            attention_escaped = escape_markdown("–í–Ω–∏–º–∞–Ω–∏–µ!", version=2)
            days_escaped = escape_markdown(str(remaining_days), version=2)
            days_text_escaped = escape_markdown(days_text, version=2)
            please_text = escape_markdown(
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–¥–ª–∏—Ç–µ –∞—Ä–µ–Ω–¥—É –∏–ª–∏ –ø–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ—Å—å –∫ –≤–æ–∑–≤—Ä–∞—Ç—É –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞.",
                version=2
            )
            manage_text = escape_markdown("–î–ª—è –¥–æ–ø –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–∞–∂–º–∏—Ç–µ: 'üóìÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–º' ", version=2)

            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏ —Ä–∞–∑–º–µ—Ç–∫–æ–π
            message = (
                f"‚ö†Ô∏è *{attention_escaped}* –î–æ –∫–æ–Ω—Ü–∞ –∞—Ä–µ–Ω–¥—ã –æ—Å—Ç–∞–ª–æ—Å—å\n"
                f"*{days_escaped}* {days_text_escaped}\\!\n\n"
                f"{please_text}\n"
                f"{manage_text}"
            )

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            await context.bot.send_message(
                chat_id=user_id,
                text=message,
                parse_mode='MarkdownV2'
            )
            logging.info(f"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")

    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}")
    finally:
        # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
        if conn:
            conn.close()


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–º–µ–Ω—ã –∑–∞—è–≤–∫–∏ –Ω–∞ —Å–¥–∞—á—É
async def cancel_return_request(update: Update, context) -> None:
    query = update.callback_query
    await query.answer()

    # –£–±–∏—Ä–∞–µ–º —Ñ–ª–∞–≥ –æ –ø–æ–¥–∞–Ω–Ω–æ–π –∑–∞—è–≤–∫–µ –Ω–∞ —Å–¥–∞—á—É
    context.user_data['return_request_submitted'] = False

    # –°–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ –∑–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞
    await query.edit_message_text("‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ —Å–¥–∞—á—É –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")

    # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–Ω–æ–≤–∞ –≤—ã–±—Ä–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ
    keyboard = [
        [InlineKeyboardButton("–ü—Ä–æ–¥–ª–∏—Ç—å –∞—Ä–µ–Ω–¥—É", callback_data=f"prolong_rental_{booking_id}")],
        [InlineKeyboardButton("–°–¥–∞—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥", callback_data="return_bike")]
    ]
    await query.message.reply_text(
        "–ß—Ç–æ –±—É–¥–µ—Ç–µ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ? üê±",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

async def handle_prolong_rental(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()

    # –ü–æ–ª—É—á–∞–µ–º booking_id –∏–∑ callback_data
    booking_id = int(query.data.split("_")[2])

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º booking_id –≤ context.user_data
    context.user_data['booking_id_for_extension'] = booking_id

    # –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é request_extension
    await request_extension(update, context)

# ### –ù–û–í–ê–Ø, –£–õ–£–ß–®–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø `return_bike` ###

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ return_bike –ù–ê –≠–¢–£

async def return_bike(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –®–∞–≥ 1: –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ –æ–±—â–µ–π –∫–Ω–æ–ø–∫–µ "–°–¥–∞—Ç—å —Ç–æ–≤–∞—Ä" –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤—ã–±–æ—Ä.
    """
    query = update.callback_query
    await query.answer()

    user_id = query.from_user.id

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    # –ò—â–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã (–∏ –∞—Ä–µ–Ω–¥—ã, –∏ —Ä–∞—Å—Å—Ä–æ—á–∫–∏)
    cursor.execute("""
        SELECT b.id, bk.name, b.booking_type
        FROM bookings b JOIN bikes bk ON b.bike_id = bk.id
        WHERE b.user_id = ? AND b.status = 'rented'
    """, (user_id,))
    active_items = cursor.fetchall()
    conn.close()

    if not active_items:
        await query.message.edit_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —Å–¥–∞—á–∏.")
        return

    keyboard = []
    for booking_id, item_name, booking_type in active_items:
        type_label = "–ê—Ä–µ–Ω–¥–∞" if booking_type == 'rent' else "–†–∞—Å—Å—Ä–æ—á–∫–∞"
        label = f"{type_label}: {item_name}"
        # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
        keyboard.append([InlineKeyboardButton(label, callback_data=f"confirm_return_{booking_id}")])

    keyboard.append([InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_return")])

    # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –ø–æ–∫–∞–∑—ã–≤–∞—è —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —Å–¥–∞—á–∏
    await query.message.edit_text(
        "–ö–∞–∫–æ–π –∏–∑ –≤–∞—à–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–∞—Ç—å?",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

# –ó–∞–º–µ–Ω–∏—Ç–µ –≤–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é confirm_return_item –Ω–∞ —ç—Ç—É
# main.py

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ confirm_return_item –ù–ê –≠–¢–£
# main.py

async def confirm_return_item(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è —Å–¥–∞—á–∏.
    –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞–¥–º–∏–Ω—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –¥–≤—É–º—è –∫–Ω–æ–ø–∫–∞–º–∏: "–ü—Ä–∏–Ω—è—Ç—å" –∏ "–í —Ä–µ–º–æ–Ω—Ç".
    """
    query = update.callback_query
    await query.answer()

    if query.data == "cancel_return":
        await query.edit_message_text("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
        return

    user = query.from_user
    user_id = user.id
    booking_id = int(query.data.split('_')[-1])

    async with aiosqlite.connect(DB_FILE) as conn:
        conn.row_factory = aiosqlite.Row
        cursor = await conn.execute(
            # –ü–æ–ª—É—á–∞–µ–º ID –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –≤–º–µ—Å—Ç–µ —Å –µ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏–µ–º
            "SELECT b.name, b.id as bike_id FROM bikes b JOIN bookings bo ON b.id = bo.bike_id WHERE bo.id = ?",
            (booking_id,)
        )
        item_data = await cursor.fetchone()

        if not item_data:
            await query.message.edit_text("üö´ –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —ç—Ç–æ–π –±—Ä–æ–Ω–∏.")
            return

        item_name = item_data['name']
        bike_id = item_data['bike_id'] # –ü–æ–ª—É—á–∞–µ–º ID —Å–∞–º–æ–≥–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞
        user_name_formatted = await get_user_info_for_notification(user_id, conn)

    await query.message.edit_text(
        f"‚úÖ –í–∞—à –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–¥–∞—á—É —Ç–æ–≤–∞—Ä–∞ ¬´*{item_name}*¬ª –ø—Ä–∏–Ω—è—Ç.\n"
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–π–¥–∏—Ç–µ –∫ –º–µ—Å—Ç—É, –æ—Ç–∫—É–¥–∞ –≤—ã –±—Ä–∞–ª–∏ —Ç–æ–≤–∞—Ä, –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –æ—Å–º–æ—Ç—Ä–∞.",
        parse_mode="Markdown"
    )

    # <<< –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –¥–≤—É–º—è –∫–Ω–æ–ø–∫–∞–º–∏
    keyboard = [[
        InlineKeyboardButton("‚úÖ –ü—Ä–∏–Ω—è—Ç—å", callback_data=f"rental_accept_{booking_id}"),
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º rental_repair, —Ç–∞–∫ –∫–∞–∫ –æ–Ω —É–∂–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç –Ω—É–∂–Ω—ã–π –¥–∏–∞–ª–æ–≥
        InlineKeyboardButton("üîß –í —Ä–µ–º–æ–Ω—Ç", callback_data=f"rental_repair_{booking_id}")
    ]]
    reply_markup = InlineKeyboardMarkup(keyboard)

    notification_message = (
        f"üîô –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name_formatted} —Å–¥–∞–µ—Ç —Ç–æ–≤–∞—Ä ¬´{item_name}¬ª (–±—Ä–æ–Ω—å #{booking_id}).\n\n"
        "–û—Å–º–æ—Ç—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    )

    for admin_id in ADMIN_IDS:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –Ω–æ–≤—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏
        await context.bot.send_message(admin_id, notification_message, reply_markup=reply_markup)
    # <<< –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>

    # –õ–æ–≥–∏—Ä—É–µ–º –∏–º–µ–Ω–Ω–æ —Ñ–∞–∫—Ç –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–∫–∏
    await log_bike_action(conn, bike_id, user_id, "–ó–∞—è–≤–∫–∞ –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç", f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∞–ª –∑–∞—è–≤–∫—É –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç —Ç–æ–≤–∞—Ä–∞ '{item_name}' (–±—Ä–æ–Ω—å #{booking_id})")

# main.py

# –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ
async def admin_accept_return(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ –∞–¥–º–∏–Ω–æ–º –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–Ω—è—Ç—å –∏ —Å–¥–µ–ª–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–º".
    –ó–∞–≤–µ—Ä—à–∞–µ—Ç –∞—Ä–µ–Ω–¥—É, –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç —Ç–æ–≤–∞—Ä, —É–≤–µ–¥–æ–º–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –æ—á–µ—Ä–µ–¥—å.
    """
    query = update.callback_query
    await query.answer()

    booking_id = int(query.data.split('_')[-1])

    async with aiosqlite.connect(DB_FILE) as conn:
        conn.row_factory = aiosqlite.Row
        await conn.execute("BEGIN")

        try:
            cursor = await conn.execute("SELECT bike_id, user_id FROM bookings WHERE id=?", (booking_id,))
            booking_info = await cursor.fetchone()

            if not booking_info:
                await query.edit_message_text("üö´ –û—à–∏–±–∫–∞: —ç—Ç–∞ –∞—Ä–µ–Ω–¥–∞ —É–∂–µ –±—ã–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
                await conn.rollback()
                return

            bike_id, user_id = booking_info['bike_id'], booking_info['user_id']
            cursor = await conn.execute("SELECT name, type FROM bikes WHERE id=?", (bike_id,))
            item_info = await cursor.fetchone()
            item_name = item_info['name']
            item_type_rus = "–í–µ–ª–æ—Å–∏–ø–µ–¥" if item_info['type'] == 'bike' else "–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä"

            # 1. –£–¥–∞–ª—è–µ–º –∞—Ä–µ–Ω–¥—É/—Ä–∞—Å—Å—Ä–æ—á–∫—É
            await conn.execute("DELETE FROM bookings WHERE id=?", (booking_id,))
            # 2. –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º —Ç–æ–≤–∞—Ä
            await conn.execute("UPDATE bikes SET available=1, owner_id=NULL WHERE id=?", (bike_id,))
            # 3. –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
            await log_bike_action(conn, bike_id, user_id, "–í–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏–Ω—è—Ç", f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–∏–Ω—è–ª —Ç–æ–≤–∞—Ä '{item_name}'")

            # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—á–µ—Ä–µ–¥—å (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤)
            if item_info['type'] == 'bike':
                cursor = await conn.execute("SELECT user_id FROM queue ORDER BY created_at ASC LIMIT 1")
                next_in_queue = await cursor.fetchone()
                if next_in_queue:
                    next_user_id = next_in_queue['user_id']
                    await conn.execute("DELETE FROM queue WHERE user_id = ?", (next_user_id,))
                    await context.bot.send_message(
                        chat_id=next_user_id,
                        text=f"üéâ –•–æ—Ä–æ—à–∏–µ –Ω–æ–≤–æ—Å—Ç–∏! {item_type_rus}, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –∂–¥–∞–ª–∏, —Å—Ç–∞–ª –¥–æ—Å—Ç—É–ø–µ–Ω! –í—ã –º–æ–∂–µ—Ç–µ –µ–≥–æ –∞—Ä–µ–Ω–¥–æ–≤–∞—Ç—å."
                    )

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            await conn.commit()

            # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            await context.bot.send_message(user_id, f"‚úÖ –í–∞—à –≤–æ–∑–≤—Ä–∞—Ç —Ç–æ–≤–∞—Ä–∞ ¬´{item_name}¬ª —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω. –°–ø–∞—Å–∏–±–æ!")
            await query.edit_message_text(f"‚úÖ –í–æ–∑–≤—Ä–∞—Ç —Ç–æ–≤–∞—Ä–∞ ¬´{item_name}¬ª –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID {user_id} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω. –¢–æ–≤–∞—Ä —Å–Ω–æ–≤–∞ –¥–æ—Å—Ç—É–ø–µ–Ω.")

        except Exception as e:
            await conn.rollback()
            logger.error(f"–û—à–∏–±–∫–∞ –≤ admin_accept_return –¥–ª—è booking_id {booking_id}: {e}", exc_info=True)
            await query.edit_message_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–æ–∑–≤—Ä–∞—Ç–∞: {e}")

# –ù–µ –∑–∞–±—É–¥—å—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `confirm_return_item` –≤ `main()`
# application.add_handler(CallbackQueryHandler(confirm_return_item, pattern=r"^confirm_return_"))



def get_month_name(month_number):
    """–ü–æ–ª—É—á–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞ –ø–æ –µ–≥–æ –Ω–æ–º–µ—Ä—É."""
    months = [
        "—è–Ω–≤–∞—Ä—è", "—Ñ–µ–≤—Ä–∞–ª—è", "–º–∞—Ä—Ç–∞", "–∞–ø—Ä–µ–ª—è",
        "–º–∞—è", "–∏—é–Ω—è", "–∏—é–ª—è", "–∞–≤–≥—É—Å—Ç–∞",
        "—Å–µ–Ω—Ç—è–±—Ä—è", "–æ–∫—Ç—è–±—Ä—è", "–Ω–æ—è–±—Ä—è", "–¥–µ–∫–∞–±—Ä—è"
    ]
    return months[month_number - 1]  # –ò–Ω–¥–µ–∫—Å–∏—Ä—É–µ–º —Å 0, –ø–æ—ç—Ç–æ–º—É -1


def create_calendar():
    """–°–æ–∑–¥–∞–µ—Ç –∫–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —Ç—Ä–µ—Ö –¥–Ω–µ–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–¥ –º–µ—Å—è—Ü."""
    today = datetime.now()

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç—Ä–µ—Ö —Å–ª–µ–¥—É—é—â–∏—Ö –¥–Ω–µ–π –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
    next_three_days = [(today + timedelta(days=i)) for i in range(3)]

    keyboard = [
        [InlineKeyboardButton(f"{day.day} {get_month_name(day.month)}", callback_data=f"select_date_{day.strftime('%Y-%m-%d')}")]
        for day in next_three_days
    ]

    return InlineKeyboardMarkup(keyboard)

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£


### –ù–û–í–ê–Ø, –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
### –ù–û–í–ê–Ø, –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£, –ß–¢–û–ë–´ –£–ë–ï–î–ò–¢–¨–°–Ø –í –ü–†–ê–í–ò–õ–¨–ù–û–°–¢–ò –í–´–ó–û–í–ê

async def calendar_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –¥–∞—Ç—ã. –®–∞–≥ 2: –í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏.
    """
    query = update.callback_query
    await query.answer()

    if not query.data.startswith('select_date_'):
        return SELECTING_DATE

    try:
        selected_date_str = query.data.split('_', 2)[2]
        selected_date = datetime.strptime(selected_date_str, '%Y-%m-%d')
        context.user_data['booking_date'] = selected_date

        # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –∑–∞–ø—Ä–∞—à–∏–≤–∞—è –≤—Ä–µ–º—è
        await query.message.edit_text(
            f"üóìÔ∏è –î–∞—Ç–∞: *{selected_date.strftime('%d %B %Y')}*\n\n"
            f"üïí *–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –≤–∏–∑–∏—Ç–∞:*",
            # –í–´–ó–´–í–ê–ï–ú –§–£–ù–ö–¶–ò–Æ –ë–ï–ó –ê–†–ì–£–ú–ï–ù–¢–û–í
            reply_markup=create_time_keyboard(),
            parse_mode="Markdown"
        )
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏
        return SELECTING_TIME

    except (ValueError, IndexError) as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ calendar_callback: {e} | data: {query.data}")
        await query.message.edit_text("üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –¥–∞—Ç—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.")
        return ConversationHandler.END


# –ó–ê–ú–ï–ù–ò–¢–ï –í–°–ï –í–ï–†–°–ò–ò –≠–¢–û–ô –§–£–ù–ö–¶–ò–ò –ù–ê –≠–¢–û–¢ –ö–û–î

def create_time_keyboard():
    """–°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ —Å 13:00 –¥–æ 22:00."""
    keyboard = []
    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è —á–∞—Å–æ–≤ —Å 13:00 –¥–æ 22:00
    for hour in range(13, 23):
        time_str = f"{hour}:00"
        # –ö–∞–∂–¥–∞—è –∫–Ω–æ–ø–∫–∞ –≤ —Å–≤–æ–µ–π —Å—Ç—Ä–æ–∫–µ, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –±–æ–ª—å—à–∏–º–∏ –∏ —É–¥–æ–±–Ω—ã–º–∏
        keyboard.append([InlineKeyboardButton(time_str, callback_data=f"select_time_{time_str}")])
    return InlineKeyboardMarkup(keyboard)
### –ù–û–í–ê–Ø, –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
async def time_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏. –®–∞–≥ 3: –§–∏–Ω–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.
    """
    query = update.callback_query
    await query.answer()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
    if not query.data.startswith('select_time_'):
        return 3

    try:
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Ä–µ–º—è –∏–∑ callback_data
        selected_time_str = query.data.split('_', 2)[2]
        context.user_data['booking_time'] = selected_time_str

        # –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        booking_date = context.user_data.get('booking_date')
        if not booking_date:
            raise ValueError("–î–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ")

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        final_datetime_str = f"{booking_date.strftime('%d.%m.%Y')} –≤ {selected_time_str}"

        await query.message.edit_text(
            f"‚úÖ *–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–∞!*\n\n"
            f"–í—ã —Ö–æ—Ç–∏—Ç–µ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥ –Ω–∞:\n"
            f"üìÖ *{final_datetime_str}*\n\n"
            f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–∞—à –≤—ã–±–æ—Ä.",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –±—Ä–æ–Ω—å", callback_data='accept_booking')],
                [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data='reject_booking')]
            ]),
            parse_mode="Markdown"
        )
        # –û—Å—Ç–∞–µ–º—Å—è –≤ —Ç–æ–º –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ (3), –Ω–æ –∂–¥–µ–º —É–∂–µ `accept_booking` –∏–ª–∏ `reject_booking`
        return CONFIRMING_BOOKING

    except (ValueError, IndexError) as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ time_callback: {e} | data: {query.data}")
        await query.message.edit_text("üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –≤—Ä–µ–º–µ–Ω–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.")
        return ConversationHandler.END


# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –∑–∞–ø—á–∞—Å—Ç–µ–π üõ†Ô∏è
async def list_parts(update: Update, context) -> None:
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    # –í—ã–±–∏—Ä–∞–µ–º —Ç–æ–ª—å–∫–æ id, name –∏ quantity
    cursor.execute("SELECT id, name, quantity FROM parts WHERE available=1")
    parts = cursor.fetchall()
    conn.close()

    if not parts:
        await update.message.reply_text("üö´ –ó–∞–ø—á–∞—Å—Ç–∏ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.")
        return

    keyboard = []
    for part in parts:
        part_id, part_name, part_quantity = part
        # –ò–∑–º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏—è –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—á–∞—Å—Ç–∏
        keyboard.append([InlineKeyboardButton(f"{part_name} (–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {part_quantity})", callback_data=f"part_info_{part_id}")])

    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text("üíº –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–ø—á–∞—Å—Ç–∏:", reply_markup=reply_markup)

# –ü–æ–∫–∞–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–ø—á–∞—Å—Ç–∏ üìÑ
async def part_info(update: Update, context) -> None:
    query = update.callback_query
    await query.answer()
    part_id = query.data.split("_")[2]

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    # –í—ã–±–∏—Ä–∞–µ–º –∏–º—è, –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—á–∞—Å—Ç–∏
    cursor.execute("SELECT name, description, photo_url, quantity FROM parts WHERE id=?", (part_id,))
    part = cursor.fetchone()
    conn.close()

    if part:
        name, description, photo_url, quantity = part
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
        await query.message.reply_photo(
            photo=photo_url,
            caption=f"{name}\n\n–û–ø–∏—Å–∞–Ω–∏–µ: {description or '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}\n–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {quantity} —à—Ç."
        )
    else:
        await query.message.reply_text("üö´ –û—à–∏–±–∫–∞: –∑–∞–ø—á–∞—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")

# ### –ù–û–í–´–ô –ö–û–î: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ ###

async def get_user_info_for_notification(user_id: int, conn: aiosqlite.Connection) -> str:
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–±—ä–µ–∫—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î.
    """
    try:
        cursor = await conn.execute("SELECT first_name, last_name, username FROM users WHERE id=?", (user_id,))
        user_data = await cursor.fetchone()

        if user_data:
            first_name = user_data['first_name'] or ""
            last_name = user_data['last_name'] or ""
            username = user_data['username'] or "–Ω–µ—Ç username"

            # –°–æ–±–∏—Ä–∞–µ–º –ø–æ–ª–Ω–æ–µ –∏–º—è, —É–±–∏—Ä–∞—è –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã, –µ—Å–ª–∏ —á–µ–≥–æ-—Ç–æ –Ω–µ—Ç
            full_name = f"{first_name} {last_name}".strip()

            return f"{full_name} (@{username})"
        else:
            return f"ID: {user_id} (–Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î)"
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ {user_id}: {e}")
        return f"ID: {user_id} (–æ—à–∏–±–∫–∞ –ë–î)"

# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ üö¥‚Äç‚ôÇÔ∏è
from telegram import InlineKeyboardButton, InlineKeyboardMarkup

def get_user_queue_position(user_id):
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –æ—á–µ—Ä–µ–¥–∏ —Å –∏—Ö —Å—Ç–∞—Ç—É—Å–∞–º–∏
    cursor.execute("SELECT user_id, status FROM queue WHERE status IN ('pending', 'first_user') ORDER BY created_at")
    queue = cursor.fetchall()

    # –ù–∞—Ö–æ–¥–∏–º –ø–æ–∑–∏—Ü–∏—é –∏ —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ—á–µ—Ä–µ–¥–∏
    for idx, (queued_user_id, status) in enumerate(queue, start=1):
        if queued_user_id == user_id:
            conn.close()
            return {"position": idx, "status": status}  # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∏ —Å—Ç–∞—Ç—É—Å

    conn.close()
    return {"position": -1, "status": None}  # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—á–µ—Ä–µ–¥–∏


async def handle_pagination(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()

    # –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑ callback_data
    page = int(query.data.split('_')[1])

    # –í—ã–∑—ã–≤–∞–µ–º list_bikes —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    await list_bikes(update, context, page=page)

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ list_bikes –ù–ê –≠–¢–£

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ list_bikes –ù–ê –≠–¢–£

# corrected_code.py

# corrected_code.py

# corrected_code.py

# corrected_code.py

# corrected_code.py

# corrected_code.py

# corrected_code.py

# corrected_code.py

# corrected_code.py

# DEBUGGING VERSION

import logging # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞

# –°–æ–∑–¥–∞–µ–º –ª–æ–≥–≥–µ—Ä, —á—Ç–æ–±—ã —Å–æ–æ–±—â–µ–Ω–∏—è –±—ã–ª–∏ –±–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω—ã–º–∏
logger = logging.getLogger(__name__)


# main.py

# main.py

# main.py

# main.py

# main.py
# <<< –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê >>>

# –ù–ê–•–û–î–ò–¢–°–Ø –í –†–ê–ô–û–ù–ï –°–¢–†–û–ö–ò 6176
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ show_filtered_bike_list –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
# ==============================================================================
# –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø show_filtered_bike_list (—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –æ—à–∏–±–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
# ==============================================================================
async def show_filtered_bike_list(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏.
    –ò–°–ü–†–ê–í–õ–ï–ù–û: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ñ–æ—Ç–æ, —É–¥–∞–ª—è—è –µ–≥–æ
    –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—è –Ω–æ–≤–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.
    """
    query = update.callback_query
    await query.answer()
    
    # <<< –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º chat_id –∏ —É–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ñ–æ—Ç–æ)
    chat_id = query.message.chat_id
    try:
        await query.message.delete()
    except Exception as e:
        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∫ —Å–ø–∏—Å–∫—É: {e}")
    # <<< –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>

    try:
        parts = query.data.split('_')
        category = parts[3]
        page = int(parts[4])
    except (IndexError, ValueError):
        logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ callback_data –≤ show_filtered_bike_list: {query.data}")
        await context.bot.send_message(chat_id, "üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.")
        return

    PAGE_SIZE = 5
    sql_where_clause = ""
    sql_params = ()
    title = ""

    if category == "own":
        sql_where_clause = "WHERE b.investor_id IS NULL"
        title = "üö≤ –ù–∞—à–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã"
    elif category == "investor":
        sql_where_clause = "WHERE b.investor_id IS NOT NULL"
        title = "üíº –ò–Ω–≤–µ—Å—Ç–æ—Ä—Å–∫–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã"
    elif category == "all":
        sql_where_clause = ""
        title = "üåê –í—Å–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã"

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            count_cursor = await conn.execute(f"SELECT COUNT(b.id) FROM bikes b {sql_where_clause}", sql_params)
            total_items = (await count_cursor.fetchone())[0]
            total_pages = (total_items + PAGE_SIZE - 1) // PAGE_SIZE

            offset = page * PAGE_SIZE
            
            cursor = await conn.execute(
                f"""SELECT 
                       b.id, b.name, b.investor_id, b.repair_status,
                       u.first_name, u.last_name,
                       bo.booking_type
                   FROM bikes b
                   LEFT JOIN users u ON b.investor_id = u.id
                   LEFT JOIN bookings bo ON b.id = bo.bike_id AND bo.status = 'rented'
                   {sql_where_clause}
                   ORDER BY b.name
                   LIMIT ? OFFSET ?""",
                sql_params + (PAGE_SIZE, offset)
            )
            bikes = await cursor.fetchall()

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ë–î –≤ show_filtered_bike_list: {e}", exc_info=True)
        await context.bot.send_message(chat_id, "üö´ –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.")
        return

    if not bikes and page == 0:
        await context.bot.send_message(
            chat_id,
            f"–í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ¬´{title}¬ª –Ω–µ—Ç –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤.",
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –∫–∞—Ç–µ–≥–æ—Ä–∏–∏", callback_data="back_to_main_bike_list")]])
        )
        return

    keyboard = []
    for bike in bikes:
        status_emoji = "‚úÖ" 
        if bike['repair_status'] == 'in_repair':
            status_emoji = "üîß"
        elif bike['booking_type'] == 'buyout':
            status_emoji = "üí∞"
        elif bike['booking_type'] == 'rent':
            status_emoji = "üö¥‚Äç‚ôÇÔ∏è"
        
        button_text = f"{status_emoji} {bike['name']}"

        if bike['investor_id']:
            investor_name = f"{bike['first_name'] or ''} {bike['last_name'] or ''}".strip()
            button_text += f" (–ò–Ω–≤–µ—Å—Ç–æ—Ä: {investor_name})"
        keyboard.append([InlineKeyboardButton(button_text, callback_data=f"info_{bike['id']}")])

    pagination_row = []
    if page > 0:
        pagination_row.append(InlineKeyboardButton("‚¨ÖÔ∏è", callback_data=f"list_bikes_category_{category}_{page - 1}"))
    if page < total_pages - 1:
        pagination_row.append(InlineKeyboardButton("‚û°Ô∏è", callback_data=f"list_bikes_category_{category}_{page + 1}"))

    if pagination_row:
        keyboard.append(pagination_row)

    keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –∫–∞—Ç–µ–≥–æ—Ä–∏–∏", callback_data="back_to_main_bike_list")])

    message_text = f"{title} (–°—Ç—Ä. {page + 1}/{total_pages}):"
    
    # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è >>>
    await context.bot.send_message(
        chat_id=chat_id,
        text=message_text,
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
# <<< –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê >>>
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ list_bikes –ù–ê –≠–¢–£

async def list_bikes(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø:
    - –î–ª—è –∞–¥–º–∏–Ω–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.
    - –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò —Å–æ–∑–¥–∞–µ—Ç –º–µ–Ω—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ –ë–î.
    """
    user_id = update.effective_user.id

    if is_admin(user_id):
        # –õ–æ–≥–∏–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        keyboard = [
            [InlineKeyboardButton("üö≤ –ù–∞—à–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã (–Ω–µ –∏–Ω–≤–µ—Å—Ç–æ—Ä—Å–∫–∏–µ)", callback_data="list_bikes_category_own_0")],
            [InlineKeyboardButton("üíº –ò–Ω–≤–µ—Å—Ç–æ—Ä—Å–∫–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã", callback_data="list_bikes_category_investor_0")],
            [InlineKeyboardButton("üåê –í—Å–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã", callback_data="list_bikes_category_all_0")]
        ]
        message_text = "üëá –í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã –ø–æ–∫–∞–∑–∞—Ç—å:"
    else:
        # --- –ù–û–í–ê–Ø –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ê–Ø –õ–û–ì–ò–ö–ê –î–õ–Ø –ö–õ–ò–ï–ù–¢–û–í ---
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        
        # SQL-–∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –∏–∑–≤–ª–µ–∫–∞–µ—Ç –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞
        # –∏ –≥—Ä—É–ø–ø–∏—Ä—É–µ—Ç –∏—Ö, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        cursor.execute("""
            SELECT DISTINCT
                CASE
                    WHEN INSTR(name, ' ') > 0 THEN SUBSTR(name, 1, INSTR(name, ' ') - 1)
                    ELSE name
                END as category
            FROM bikes
            WHERE type = 'bike' AND available = 1
        """)
        
        categories = cursor.fetchall()
        conn.close()

        keyboard = []
        if not categories:
            message_text = "üòî –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Å–µ–π—á–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ –¥–ª—è –∞—Ä–µ–Ω–¥—ã."
        else:
            # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞ –ª–µ—Ç—É –¥–ª—è –∫–∞–∂–¥–æ–π –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            for (category_name,) in categories:
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π", —á—Ç–æ–±—ã –æ–Ω –Ω–µ —Å–æ–∑–¥–∞–≤–∞–ª –æ—Ç–¥–µ–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É
                if '–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π' in category_name.lower():
                    continue
                keyboard.append([
                    InlineKeyboardButton(f"üö≤ {category_name}", callback_data=f"show_model_{category_name}_page_0")
                ])
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –ê–ö–ë –æ—Ç–¥–µ–ª—å–Ω–æ –∏ –≤—Ä—É—á–Ω—É—é
            keyboard.append([InlineKeyboardButton("üîã –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ê–ö–ë", callback_data="show_model_AKB_page_0")])
            message_text = "üëá –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â—É—é –≤–∞—Å –∫–∞—Ç–µ–≥–æ—Ä–∏—é:"

    reply_markup = InlineKeyboardMarkup(keyboard)

    # –û—Ç–ø—Ä–∞–≤–∫–∞/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    if update.callback_query:
        await update.callback_query.edit_message_text(message_text, reply_markup=reply_markup)
    else:
        await update.message.reply_text(message_text, reply_markup=reply_markup)

# –ù–ê–ô–î–ò–¢–ï –ò –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–ò–¢–ï –§–£–ù–ö–¶–ò–Æ list_bikes_by_model –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

# ==============================================================================
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
# ==============================================================================
async def _get_deal_details_from_db(booking_id: int, conn: aiosqlite.Connection) -> dict | None:
    """
    –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø:
    - –¢–µ–ø–µ—Ä—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã –Ω–∞ –∞—Ä–µ–Ω–¥—É (7, 14, 30 –¥–Ω–µ–π).
    - –û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –≤—ã–∫—É–ø–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.
    """
    logger.info(f"[–õ–û–ì] –ó–∞–ø—Ä–æ—Å –¥–µ—Ç–∞–ª–µ–π –¥–ª—è —Å–¥–µ–ª–∫–∏ #{booking_id}")
    conn.row_factory = aiosqlite.Row
    cursor = await conn.execute("""
        SELECT 
            b.id as booking_id, b.booking_type, b.end_date, b.next_payment_date,
            b.payments_made, b.payment_plan_key,
            bk.id as bike_id, bk.name as bike_name,
            bk.buyout_total_payments, bk.buyout_payment_amount, bk.buyout_period_days,
            
            -- <<< –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –î–û–ë–ê–í–õ–ï–ù–´ –≠–¢–ò –°–¢–†–û–ö–ò >>>
            bk.rent_price_7d, bk.rent_price_14d, bk.rent_price_30d,
            -- <<< –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>

            u.id as user_id, u.first_name, u.last_name, u.username, u.phone_number
        FROM bookings b
        JOIN bikes bk ON b.bike_id = bk.id
        JOIN users u ON b.user_id = u.id
        WHERE b.id = ?
    """, (booking_id,))
    deal_data_raw = await cursor.fetchone()
    if not deal_data_raw:
        logger.error(f"[–õ–û–ì] –°–¥–µ–ª–∫–∞ #{booking_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ë–î.")
        return None

    deal_data = dict(deal_data_raw)
    logging.info(f"[–õ–û–ì] –°–¥–µ–ª–∫–∞ #{booking_id}: –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î: {deal_data}")

    if deal_data['booking_type'] == 'buyout':
        individual_plan_payments = deal_data.get('buyout_total_payments')
        logger.info(f"[–õ–û–ì] –°–¥–µ–ª–∫–∞ #{booking_id}: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ –∏–∑ 'bikes'. –ù–∞–π–¥–µ–Ω–æ –ø–ª–∞—Ç–µ–∂–µ–π: {individual_plan_payments}")
        
        if not individual_plan_payments or individual_plan_payments <= 0:
            plan_key = deal_data.get('payment_plan_key')
            logger.warning(f"[–õ–û–ì] –°–¥–µ–ª–∫–∞ #{booking_id}: –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–ª–∞–Ω –ø–æ –∫–ª—é—á—É: '{plan_key}'")
            
            if plan_key and plan_key in BUYOUT_PLANS:
                plan = BUYOUT_PLANS[plan_key]
                deal_data['buyout_total_payments'] = plan.get('total_payments')
                deal_data['buyout_payment_amount'] = plan.get('first_payment')
                deal_data['buyout_period_days'] = plan.get('period_days')
                logger.info(f"[–õ–û–ì] –°–¥–µ–ª–∫–∞ #{booking_id}: –£—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–ª–∞–Ω '{plan_key}'.")
            else:
                logger.error(f"[–õ–û–ì] –°–¥–µ–ª–∫–∞ #{booking_id}: –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê! –ù–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π, –Ω–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–ª–∞–Ω –≤—ã–∫—É–ø–∞!")
        else:
            logger.info(f"[–õ–û–ì] –°–¥–µ–ª–∫–∞ #{booking_id}: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω, –∑–∞–¥–∞–Ω–Ω—ã–π –¥–ª—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ 'bikes'.")

    return deal_data

async def list_bikes_by_model(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø:
    - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏ Kugoo, –∏ Liming –≤–º–µ—Å—Ç–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "Kugoo".
    - –î–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–ê–ö–ë" –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ" –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä—ã,
      –∏–≥–Ω–æ—Ä–∏—Ä—É—è –∏—Ö –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å.
    """
    query = update.callback_query
    await query.answer()

    # –ü–∞—Ä—Å–∏–º callback_data: show_model_Kugoo_page_0
    try:
        parts = query.data.split('_')
        model_name_key = parts[2]
        page = int(parts[4])
    except (IndexError, ValueError):
        logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ callback_data –≤ list_bikes_by_model: {query.data}")
        await query.edit_message_text("üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return

    PAGE_SIZE = 6
    sql_query = ""
    sql_params = ()
    count_query = ""
    count_params = ()

    if model_name_key == "Kugoo":
        # –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –æ–±—â–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –∏—â–µ–º –∏ JL, –∏ ESM
        sql_query = "SELECT id, name FROM bikes WHERE (name LIKE ? OR name LIKE ?) AND available = 1 ORDER BY name LIMIT ? OFFSET ?"
        sql_params = ('%JL%', '%ESM%', PAGE_SIZE, page * PAGE_SIZE)
        count_query = "SELECT COUNT(*) FROM bikes WHERE (name LIKE ? OR name LIKE ?) AND available = 1"
        count_params = ('%JL%', '%ESM%')

    # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: –õ–æ–≥–∏–∫–∞ –¥–ª—è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ê–ö–ë ---
    elif model_name_key == "AKB":
        # –ú—ã –±–æ–ª—å—à–µ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º available=1.
        # –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –º—ã –∏—â–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã, –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –∫–∞–∫ "–±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ".
        # –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –æ–Ω–∏ –≤—Å–µ–≥–¥–∞ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ —Å–ø–∏—Å–∫–µ.
        search_pattern = "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ê–ö–ë%"
        sql_query = "SELECT id, name FROM bikes WHERE name LIKE ? AND is_unlimited = 1 ORDER BY name"
        # –ü–∞–≥–∏–Ω–∞—Ü–∏—è –∑–¥–µ—Å—å –Ω–µ –Ω—É–∂–Ω–∞, —Ç–∞–∫ –∫–∞–∫ —É –Ω–∞—Å –≤—Å–µ–≥–æ –¥–≤–∞ —Ç–∞–∫–∏—Ö —Ç–æ–≤–∞—Ä–∞
        sql_params = (search_pattern,)
        count_query = "SELECT COUNT(*) FROM bikes WHERE name LIKE ? AND is_unlimited = 1"
        count_params = (search_pattern,)
    # --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---

    else: # –î–ª—è Wenbox –∏ –¥—Ä—É–≥–∏—Ö
        search_pattern = f"%{model_name_key}%"
        sql_query = "SELECT id, name FROM bikes WHERE name LIKE ? AND available = 1 ORDER BY name LIMIT ? OFFSET ?"
        sql_params = (search_pattern, PAGE_SIZE, page * PAGE_SIZE)
        count_query = "SELECT COUNT(*) FROM bikes WHERE name LIKE ? AND available = 1"
        count_params = (search_pattern,)

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            count_cursor = await conn.execute(count_query, count_params)
            total_items = (await count_cursor.fetchone())[0]
            total_pages = (total_items + PAGE_SIZE - 1) // PAGE_SIZE

            cursor = await conn.execute(sql_query, sql_params)
            available_bikes = await cursor.fetchall()
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ë–î –≤ list_bikes_by_model: {e}", exc_info=True)
        await query.edit_message_text("üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")
        return

    if not available_bikes:
        await query.edit_message_text(
            "üö´ –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–µ–π—á–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤.",
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º", callback_data="back_to_categories")]])
        )
        return

    keyboard = []
    for bike_id, bike_name in available_bikes:
        keyboard.append([InlineKeyboardButton(bike_name, callback_data=f"info_{bike_id}")])

    # –ü–∞–≥–∏–Ω–∞—Ü–∏—è (–¥–ª—è –ê–ö–ë –æ–Ω–∞ –Ω–µ –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è, —Ç–∞–∫ –∫–∞–∫ total_pages –±—É–¥–µ—Ç <= 1)
    pagination_row = []
    if page > 0:
        pagination_row.append(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"show_model_{model_name_key}_page_{page - 1}"))
    if page < total_pages - 1:
        pagination_row.append(InlineKeyboardButton("–í–ø–µ—Ä–µ–¥ ‚û°Ô∏è", callback_data=f"show_model_{model_name_key}_page_{page + 1}"))
    if pagination_row:
        keyboard.append(pagination_row)

    keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º", callback_data="back_to_categories")])

    await query.edit_message_text(
        f"–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö (–°—Ç—Ä. {page + 1}/{total_pages}):",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )




async def handle_view_queue(update: Update, context) -> None:
    query = update.callback_query
    await query.answer()

    user_id = query.from_user.id  # ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –æ—á–µ—Ä–µ–¥—å (–≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –≤–∫–ª—é—á–∞—è first_user)
    cursor.execute("""
        SELECT q.user_id, q.created_at, q.status, u.first_name, u.last_name, u.username
        FROM queue q
        JOIN users u ON q.user_id = u.id
        ORDER BY q.created_at
    """)
    queue = cursor.fetchall()
    conn.close()

    if queue:
        # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫ –≤ –æ—á–µ—Ä–µ–¥–∏
        total_users = len(queue)

        # –ú–µ—Å—Ç–æ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ—á–µ—Ä–µ–¥–∏
        user_position = None
        queue_text = "üë• –û—á–µ—Ä–µ–¥—å:\n"
        for idx, (queued_user_id, created_at, status, first_name, last_name, username) in enumerate(queue, start=1):
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            user_info = f"{last_name} {first_name}"
            if username:
                user_info += f" (@{username})"

            # –í—ã–¥–µ–ª—è–µ–º –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å first_user)
            if status == 'first_user':
                queue_text += f"ü•á {idx}. {user_info} (–ø–µ—Ä–≤—ã–π –≤ –æ—á–µ—Ä–µ–¥–∏)\n"
            else:
                queue_text += f"{idx}. {user_info}\n"

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
            if queued_user_id == user_id:
                user_position = idx

        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if user_position is not None:
            queue_text += f"\nüìç –í—ã –Ω–∞ {user_position} –º–µ—Å—Ç–µ."
        else:
            queue_text += "\nüìç –í—ã –Ω–µ –≤ –æ—á–µ—Ä–µ–¥–∏."
    else:
        queue_text = "üë• –û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞."

    await query.edit_message_text(queue_text)

from datetime import datetime
# DEBUG FUNCTION - REMOVE LATER
async def debug_bikes(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–í—Ä–µ–º–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ –≤ –ë–î."""
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –í–°–ï–• –º–æ–Ω—Å—Ç—Ä–æ–≤ –∏ –∫–æ–ª—Ö–æ–∑–Ω–∏–∫–æ–≤, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∏—Ö —Å—Ç–∞—Ç—É—Å—ã
    cursor.execute("SELECT id, name, available FROM bikes WHERE name LIKE '–ú–æ–Ω—Å—Ç—Ä%' OR name LIKE '–ö–æ–ª—Ö–æ–∑–Ω–∏–∫%'")
    bikes = cursor.fetchall()
    conn.close()

    if not bikes:
        await update.message.reply_text("–í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è '–ú–æ–Ω—Å—Ç—Ä' –∏–ª–∏ '–ö–æ–ª—Ö–æ–∑–Ω–∏–∫'.")
        return

    message = "üîç –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:\n\n"
    for bike_id, name, available in bikes:
        status_emoji = "‚úÖ" if available == 1 else "‚ùå"
        message += f"ID: {bike_id}, –ò–º—è: {name}, –î–æ—Å—Ç—É–ø–µ–Ω: {status_emoji}\n"

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–∞—Å—Ç—è–º–∏, –µ—Å–ª–∏ –æ–Ω–æ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ
    for part in [message[i:i + 4000] for i in range(0, len(message), 4000)]:
        await update.message.reply_text(part)
async def handle_join_queue(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    await query.answer()

    user_id = query.from_user.id
    user_name = f"{query.from_user.first_name}"  # –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if query.from_user.last_name:  # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–º–∏–ª–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
        user_name += f" {query.from_user.last_name}"
    if query.from_user.username:  # –î–æ–±–∞–≤–ª—è–µ–º @username, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        user_name += f" (@{query.from_user.username})"

    conn = None
    try:
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ –æ—á–µ—Ä–µ–¥–∏
        cursor.execute("SELECT * FROM queue WHERE user_id = ?", (user_id,))
        if cursor.fetchone():
            await query.edit_message_text("üö´ –í—ã —É–∂–µ –≤ –æ—á–µ—Ä–µ–¥–∏.")
            return

        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—É—Å—Ç–∞ –ª–∏ –æ—á–µ—Ä–µ–¥—å
        cursor.execute("SELECT COUNT(*) FROM queue WHERE status = 'first_user'")
        first_user_count = cursor.fetchone()[0]

        if first_user_count == 0:
            # –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º first_user, —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø–µ—Ä–≤—ã–º
            cursor.execute(
                "INSERT INTO queue (user_id, status, created_at) VALUES (?, 'first_user', ?)",
                (user_id, current_time)
            )
            conn.commit()
            await query.edit_message_text("üéâ –í—ã –ø–µ—Ä–≤—ã–π –≤ –æ—á–µ—Ä–µ–¥–∏! –ö–∞–∫ —Ç–æ–ª—å–∫–æ –ø–æ—è–≤–∏—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–π –≤–µ–ª–æ—Å–∏–ø–µ–¥, –≤—ã —Å–º–æ–∂–µ—Ç–µ –µ–≥–æ –∞—Ä–µ–Ω–¥–æ–≤–∞—Ç—å.")

            # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
            notification_message = (
                f"üìù –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} –≤—Å—Ç–∞–ª –≤ –æ—á–µ—Ä–µ–¥—å.\n"
                f"–ú–µ—Å—Ç–æ –≤ –æ—á–µ—Ä–µ–¥–∏: 1"
            )
            for admin_id in ADMIN_IDS:
                await context.bot.send_message(admin_id, notification_message)
                add_notification(notification_message)  # –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

        else:
            # –ï—Å–ª–∏ –≤ –æ—á–µ—Ä–µ–¥–∏ –µ—Å—Ç—å first_user, –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Å—Ç–∞—Ç—É—Å–æ–º pending
            cursor.execute(
                "INSERT INTO queue (user_id, status, created_at) VALUES (?, 'pending', ?)",
                (user_id, current_time)
            )
            conn.commit()

            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ –≤ –æ—á–µ—Ä–µ–¥–∏
            cursor.execute("""
                SELECT COUNT(*)
                FROM queue
                WHERE created_at <= (SELECT created_at FROM queue WHERE user_id = ?)
            """, (user_id,))
            position = cursor.fetchone()[0]

            await query.edit_message_text(f"‚úÖ –í—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –æ—á–µ—Ä–µ–¥—å. –í–∞—à–µ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ: {position}. –ú—ã —É–≤–µ–¥–æ–º–∏–º –≤–∞—Å, –∫–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–π –≤–µ–ª–æ—Å–∏–ø–µ–¥.")

            # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
            notification_message = (
                f"üìù –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_name} –≤—Å—Ç–∞–ª –≤ –æ—á–µ—Ä–µ–¥—å.\n"
                f"–ú–µ—Å—Ç–æ –≤ –æ—á–µ—Ä–µ–¥–∏: {position}"
            )
            for admin_id in ADMIN_IDS:
                await context.bot.send_message(admin_id, notification_message)
                add_notification(notification_message)  # –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

    except sqlite3.Error as e:
        # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –∏ —É–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö: {e}")
        await query.edit_message_text("üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –æ—á–µ—Ä–µ–¥—å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
    finally:
        if conn:
            conn.close()

# –î–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ –¥–∏—Å–ø–µ—Ç—á–µ—Ä



async def join_queue(update: Update, context) -> None:
    user_id = update.message.from_user.id
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –≤ –æ—á–µ—Ä–µ–¥–∏
    cursor.execute("SELECT * FROM queue WHERE user_id = ?", (user_id,))
    if cursor.fetchone():
        await update.message.reply_text("üö´ –í—ã —É–∂–µ –≤ –æ—á–µ—Ä–µ–¥–∏.")
        conn.close()
        return

    # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ—á–µ—Ä–µ–¥—å
    cursor.execute("INSERT INTO queue (user_id, status) VALUES (?, 'pending')", (user_id,))
    conn.commit()
    conn.close()

    await update.message.reply_text("‚úÖ –í—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –æ—á–µ—Ä–µ–¥—å. –ú—ã —É–≤–µ–¥–æ–º–∏–º –≤–∞—Å, –∫–æ–≥–¥–∞ –ø–æ—è–≤–∏—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–π –≤–µ–ª–æ—Å–∏–ø–µ–¥.")




import sqlite3
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.helpers import escape_markdown
from telegram.ext import CallbackContext

import sqlite3
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.helpers import escape_markdown
from telegram.ext import CallbackContext
import sqlite3
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.helpers import escape_markdown
from telegram.ext import CallbackContext

# ### –ò–ó–ú–ï–ù–ï–ù–ò–ï ### –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–µ
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ bike_info –ù–ê –≠–¢–£ –ù–û–í–£–Æ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –°–£–©–ï–°–¢–í–£–Æ–©–£–Æ –§–£–ù–ö–¶–ò–Æ bike_info –ù–ê –≠–¢–£ –£–õ–£–ß–®–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ bike_info –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ bike_info –ù–ê –≠–¢–£ –ü–û–õ–ù–£–Æ –í–ï–†–°–ò–Æ

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞
import aiosqlite
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from telegram.helpers import escape_markdown

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞
import aiosqlite
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from telegram.helpers import escape_markdown

# --- –ü–û–õ–ù–ê–Ø, –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –ò –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ---

# –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ bike_info –ù–ê –≠–¢–£

# –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ bike_info –ù–ê –≠–¢–£

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞
import logging
import telegram # –Ω—É–∂–µ–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π
import aiosqlite
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes

# ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –≤–∞—à–∏ –∏–º–ø–æ—Ä—Ç—ã –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã, –≤–∫–ª—é—á–∞—è ADMIN_IDS, RENTAL_PRICES, get_bike_model_key –∏ —Ç.–¥.)

#logger = logging.getLogger(__name__) # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ª–æ–≥–≥–µ—Ä –æ–ø—Ä–µ–¥–µ–ª–µ–Ω

# ==============================================================================
# –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –§–£–ù–ö–¶–ò–ò bike_info (–ó–ê–ú–ï–ù–ò–¢–ï –°–¢–ê–†–£–Æ)
# ==============================================================================

# ==============================================================================
# –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –§–£–ù–ö–¶–ò–ò bike_info (—Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏)
# ==============================================================================
async def bike_info(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø:
    - –î–ª—è –æ–±—ã—á–Ω—ã—Ö –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –§–û–¢–û —Å –ø–æ–¥–ø–∏—Å—å—é –∏ —Ç–∞—Ä–∏—Ñ–∞–º–∏.
    - –î–ª—è –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¢–ï–ö–°–¢–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï —Å –∫–Ω–æ–ø–∫–∞–º–∏ –∞—Ä–µ–Ω–¥—ã/–≤—ã–∫—É–ø–∞.
    """
    query = update.callback_query
    await query.answer()
    user_id = query.from_user.id

    # –ù–∞–≤–∏–≥–∞—Ü–∏—è (–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    if query.data == "back_to_categories":
        await list_bikes(update, context)
        return
    if query.data.startswith("show_model_"):
        await list_bikes_by_model(update, context)
        return
    if query.data.startswith("list_bikes_category_"):
        await show_filtered_bike_list(update, context)
        return

    bike_id = int(query.data.split("_")[1])
    try:
        # –ü—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±—ã–ª —á–∏—â–µ
        await query.message.delete()
    except Exception:
        pass # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ —É–¥–∞–ª–µ–Ω–æ –∏–ª–∏ —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä–æ–µ

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            cursor = await conn.execute("SELECT * FROM bikes WHERE id=?", (bike_id,))
            bike_data = await cursor.fetchone()

        if not bike_data:
            await context.bot.send_message(user_id, "üö´ –û—à–∏–±–∫–∞: —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return

        is_unlimited_battery = bike_data['type'] == PRODUCT_TYPE_BATTERY and bike_data['is_unlimited'] == 1
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –±–∞–∑–æ–≤—ã–π —Ç–µ–∫—Å—Ç (–ø–æ–¥–ø–∏—Å—å –¥–ª—è —Ñ–æ—Ç–æ –∏–ª–∏ —Ç–µ–∫—Å—Ç –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è)
        final_text = f"*{bike_data['name']}*\n_{bike_data['description'] or '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}_"
        keyboard = []

        if is_unlimited_battery:
            # –î–ª—è –ê–ö–ë –ø—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏
            keyboard.append([InlineKeyboardButton("üîã –ê—Ä–µ–Ω–¥–æ–≤–∞—Ç—å –ê–ö–ë", callback_data=f"rent_battery_{bike_id}")])
            keyboard.append([InlineKeyboardButton("üí∞ –í—ã–∫—É–ø–∏—Ç—å –ê–ö–ë (—Ä–∞—Å—Å—Ä–æ—á–∫–∞)", callback_data=f"buyout_battery_{bike_id}")])
        else:
            # –î–ª—è –æ–±—ã—á–Ω—ã—Ö –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ –¥–æ–±–∞–≤–ª—è–µ–º —Ç–∞—Ä–∏—Ñ—ã –≤ —Ç–µ–∫—Å—Ç
            if bike_data['rent_price_7d'] is not None and bike_data['rent_price_7d'] > 0:
                final_text += "\n\n*–¢–∞—Ä–∏—Ñ—ã –Ω–∞ –∞—Ä–µ–Ω–¥—É:*"
                final_text += f"\n‚Ä¢ 7 –¥–Ω–µ–π: *{bike_data['rent_price_7d']} ‚ÇΩ*"
                final_text += f"\n‚Ä¢ 14 –¥–Ω–µ–π: *{bike_data['rent_price_14d']} ‚ÇΩ*"
                final_text += f"\n‚Ä¢ 30 –¥–Ω–µ–π: *{bike_data['rent_price_30d']} ‚ÇΩ*"
                keyboard.append([InlineKeyboardButton("üöÄ –ê—Ä–µ–Ω–¥–æ–≤–∞—Ç—å", callback_data=f"arenda_{bike_id}")])

            if bike_data['buyout_total_payments'] is not None and bike_data['buyout_total_payments'] > 0:
                final_text += "\n\n*–£—Å–ª–æ–≤–∏—è –≤—ã–∫—É–ø–∞ (—Ä–∞—Å—Å—Ä–æ—á–∫–∞):*"
                final_text += f"\n‚Ä¢ {bike_data['buyout_total_payments']} –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ *{bike_data['buyout_payment_amount']} ‚ÇΩ*"
                final_text += f"\n‚Ä¢ –ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å: *–∫–∞–∂–¥—ã–µ {bike_data['buyout_period_days']} –¥–Ω–µ–π*"
                keyboard.append([InlineKeyboardButton("üí∞ –í—ã–∫—É–ø–∏—Ç—å", callback_data=f"buyout_{bike_id}")])

        # –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        back_callback_data = "back_to_categories"
        if '–ê–ö–ë' in bike_data['name']:
             back_callback_data = "show_model_AKB_page_0"
        elif 'wenbox' in bike_data['name'].lower(): 
             back_callback_data = "show_model_Wenbox_page_0"
        elif 'jl' in bike_data['name'].lower() or 'esm' in bike_data['name'].lower(): 
             back_callback_data = "show_model_Kugoo_page_0"
        
        keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É", callback_data=back_callback_data)])
        
        # --- –†–ê–ó–î–ï–õ–ï–ù–ò–ï –õ–û–ì–ò–ö–ò –û–¢–ü–†–ê–í–ö–ò ---
        
        if is_unlimited_battery:
            # –ï—Å–ª–∏ —ç—Ç–æ –ê–ö–ë, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ—Å—Ç–æ–µ –¢–ï–ö–°–¢–û–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ
            await context.bot.send_message(
                chat_id=user_id,
                text=final_text,
                parse_mode='Markdown',
                reply_markup=InlineKeyboardMarkup(keyboard)
            )
        else:
            # –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ã—á–Ω—ã–π –≤–µ–ª–æ—Å–∏–ø–µ–¥, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –§–û–¢–û —Å –ø–æ–¥–ø–∏—Å—å—é
            await context.bot.send_photo(
                chat_id=user_id,
                photo=bike_data['photo_url'],
                caption=final_text,
                parse_mode='Markdown',
                reply_markup=InlineKeyboardMarkup(keyboard)
            )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ bike_info: {e}", exc_info=True)
        await context.bot.send_message(user_id, "üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞.")

# <<< –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê >>>

# <<< –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê >>>

async def handle_bike_list_pagination(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø:
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏—é, –ø—Ä–æ–≤–µ—Ä—è—è, –µ—Å—Ç—å –ª–∏ —Å–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞,
    —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å "–∑–∞–≤–∏—Å–∞–Ω–∏—è" –∏ –æ—à–∏–±–æ–∫.
    """
    query = update.callback_query
    await query.answer()

    current_page = context.user_data.get('edit_page', 0)
    bikes_per_page = 5

    # --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞ ---
    async with aiosqlite.connect(DB_FILE) as conn:
        cursor = await conn.execute("SELECT COUNT(*) FROM bikes")
        total_bikes = (await cursor.fetchone())[0]
        total_pages = (total_bikes + bikes_per_page - 1) // bikes_per_page

    new_page = current_page
    if "next" in query.data and (current_page + 1) < total_pages:
        new_page = current_page + 1
    elif "prev" in query.data and current_page > 0:
        new_page = current_page - 1
    
    # –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞–∂–∞–ª–∏ "–≤–ø–µ—Ä–µ–¥" –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π),
    # –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—è, —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫—É.
    if new_page == current_page:
        return EDIT_USER_MENU

    # –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –º–µ–Ω—é
    context.user_data['edit_page'] = new_page
    await show_bike_list_for_editing(update, context)

    return EDIT_USER_MENU

# <<< –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê >>>

# <<< –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê >>>
# –®–ê–ì 2: –í–°–¢–ê–í–¨–¢–ï –≠–¢–£ –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ
AWAITING_PHOTO_FOR_ID = range(1) # –ü—Ä–æ—Å—Ç–æ–µ —á–∏—Å–ª–æ, –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–µ–µ—Å—è —Å –¥—Ä—É–≥–∏–º–∏

# –ù–ê–ô–î–ò–¢–ï –§–£–ù–ö–¶–ò–Æ get_photo_id_start –ò –ó–ê–ú–ï–ù–ò–¢–ï –ï–ï –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

async def get_photo_id_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–ª—É—á–µ–Ω–∏—è file_id. –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É."""
    if not is_admin(update.effective_user.id):
        await update.message.reply_text("üö´ –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
        return ConversationHandler.END

    # –£–±–∏—Ä–∞–µ–º parse_mode, —Ç–∞–∫ –∫–∞–∫ —Å–ª–æ–∂–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–¥–µ—Å—å –Ω–µ –Ω—É–∂–Ω–æ
    await update.message.reply_text(
        "üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å file_id.\n\n"
        "–î–ª—è –æ—Ç–º–µ–Ω—ã –≤–≤–µ–¥–∏—Ç–µ /cancel."
        # –£–ë–†–ê–ù –ü–ê–†–ê–ú–ï–¢–†: parse_mode="MarkdownV2"
    )
    return AWAITING_PHOTO_FOR_ID

# –ù–ê–ô–î–ò–¢–ï –§–£–ù–ö–¶–ò–Æ receive_photo_for_id –ò –ó–ê–ú–ï–ù–ò–¢–ï –ï–ï –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

async def receive_photo_for_id(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ñ–æ—Ç–æ –∏ –≤ –æ—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ file_id."""
    photo_file_id = update.message.photo[-1].file_id

    # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Ç–æ—á–∫–∏ —Å –ø–æ–º–æ—â—å—é `\.`
    message_text = (
        f"‚úÖ `file_id` –ø–æ–ª—É—á–µ–Ω:\n\n`{photo_file_id}`\n\n"
        "‚òùÔ∏è –ù–∞–∂–º–∏—Ç–µ –Ω–∞ ID –≤—ã—à–µ, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ, –∞ –∑–∞—Ç–µ–º –≤—Å—Ç–∞–≤—å—Ç–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –≤ —Å—Ç–æ–ª–±–µ—Ü `photo_url` –¥–ª—è –Ω—É–∂–Ω–æ–≥–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞\\."
    )

    await update.message.reply_text(
        text=message_text,
        parse_mode="MarkdownV2" # –û—Å—Ç–∞–≤–ª—è–µ–º V2 –¥–ª—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏
    )

    return ConversationHandler.END

async def cancel_get_id(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û—Ç–º–µ–Ω—è–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏—é –ø–æ–ª—É—á–µ–Ω–∏—è file_id."""
    await update.message.reply_text("–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.")
    return ConversationHandler.END
async def quick_rent_akb_payment(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –°—Ä–∞–∑—É —Å–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ –¥–ª—è –∞—Ä–µ–Ω–¥—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ê–ö–ë –±–µ–∑ –¥–æ–≥–æ–≤–æ—Ä–∞.
    """
    query = update.callback_query
    await query.answer()
    
    # –†–∞–∑–±–∏—Ä–∞–µ–º callback_data: quick_rent_akb_{product_id}_{price}
    parts = query.data.split('_')
    product_id = int(parts[3])
    price = int(parts[4])
    user_id = query.from_user.id
    
    await query.message.edit_text("‚è≥ –ì–æ—Ç–æ–≤–ª—é —Å—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É –∞—Ä–µ–Ω–¥—ã –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞...")

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —á–µ–∫–∞ –∏ –æ–ø–∏—Å–∞–Ω–∏—è
            cursor = await conn.execute(
                "SELECT u.phone_number, b.name as item_name FROM users u, bikes b WHERE u.id=? AND b.id=?",
                (user_id, product_id)
            )
            data = await cursor.fetchone()

        if not data or not data['phone_number']:
            raise ValueError("–ù–µ –Ω–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–ª–∏ –µ–≥–æ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —á–µ–∫–∞.")

        # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è YooKassa
        description = f"–ê—Ä–µ–Ω–¥–∞: {data['item_name']} –Ω–∞ 7 –¥–Ω–µ–π"
        # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π payload –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ –ø–ª–∞—Ç–µ–∂–∞
        payload = f"quick_rent_akb_{product_id}" 
        
        metadata = {'internal_payload': payload, 'user_id': user_id}
        items_for_receipt = [{"description": description, "quantity": "1.00", "amount": { "value": f"{price:.2f}", "currency": "RUB" }, "vat_code": "1", "payment_subject": "service"}]
        payment_info = await create_yookassa_payment(amount=price, description=description, metadata=metadata, items=items_for_receipt, customer_info={"phone": data['phone_number']}, payment_method='sbp')
        
        if not payment_info:
            raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É.")

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—á–µ—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞)
        payment_url, payment_id, final_amount = payment_info['url'], payment_info['id'], payment_info['final_amount']
        
        keyboard = [[InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å", url=payment_url)]]
        animated_message = await query.message.edit_text(
            f"–î–ª—è –∞—Ä–µ–Ω–¥—ã –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–ª–∞—Ç–∏—Ç–µ {final_amount:.2f} ‚ÇΩ.",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )

        if 'pending_payments' not in context.bot_data: context.bot_data['pending_payments'] = {}
        stop_animation_event = asyncio.Event()
        context.bot_data['pending_payments'][payment_id] = {'user_id': user_id, 'start_time': datetime.now(), 'payload': payload, 'amount': final_amount, 'animated_message_id': animated_message.message_id, 'url': payment_url, 'animation_sequence': random.choice(PAYMENT_ANIMATIONS), 'stop_animation_event': stop_animation_event}
        asyncio.create_task(animate_payment_message(context, payment_id))
        context.job_queue.run_repeating(callback=check_payment_status, interval=15, first=10, name=f"payment_{payment_id}", data={'yookassa_id': payment_id})

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ quick_rent_akb_payment: {e}", exc_info=True)
        await query.message.edit_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
# –í–°–¢–ê–í–¨–¢–ï –≠–¢–û–¢ –ö–û–î –†–Ø–î–û–ú –° –î–†–£–ì–ò–ú–ò ConversationHandler'–∞–º–∏

# --- –ù–û–í–´–ô –î–ò–ê–õ–û–ì –î–õ–Ø –ê–†–ï–ù–î–´ –ê–ö–ö–£–ú–£–õ–Ø–¢–û–†–ê ---

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
(
    BATTERY_RENT_CONFIRMATION,
) = range(1)

async def start_battery_rent(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 1: –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ –∫–Ω–æ–ø–∫–µ '–ê—Ä–µ–Ω–¥–æ–≤–∞—Ç—å –ê–ö–ë'. –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —à–ª–µ—Ç –Ω–æ–≤–æ–µ."""
    query = update.callback_query
    await query.answer()

    product_id = int(query.data.split('_')[-1])

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT name FROM bikes WHERE id=?", (product_id,))
    name = cursor.fetchone()[0]
    conn.close()

    battery_model = '60V21Ah' if '60V21Ah' in name else '60V30Ah'
    rent_plan = BATTERY_RENTAL_PRICES.get(battery_model)

    if not rent_plan:
        await context.bot.send_message(chat_id=query.from_user.id, text="üö´ –û—à–∏–±–∫–∞: —Ç–∞—Ä–∏—Ñ—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")
        return ConversationHandler.END

    context.user_data['rent_battery_data'] = {
        'product_id': product_id, 'name': name, 'model': battery_model,
        'price': rent_plan['initial_price'],
        'description': f"–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂ –∑–∞ –∞—Ä–µ–Ω–¥—É –ê–ö–ë '{name}' ({rent_plan['initial_months']} –º–µ—Å.)"
    }

    text = (
        f"–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –∞—Ä–µ–Ω–¥–æ–≤–∞—Ç—å –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä *{name}*.\n\n"
        f"*–£—Å–ª–æ–≤–∏—è –∞—Ä–µ–Ω–¥—ã:*\n"
        f"–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂ –∑–∞ *{rent_plan['initial_months']} –º–µ—Å—è—Ü–∞* —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç *{rent_plan['initial_price']} —Ä—É–±.*\n"
        f"–î–∞–ª–µ–µ –∞—Ä–µ–Ω–¥–Ω–∞—è –ø–ª–∞—Ç–∞ —Å–æ—Å—Ç–∞–≤–∏—Ç *{rent_plan['monthly_price']} —Ä—É–±/–º–µ—Å.*\n\n"
        f"–ù–∞–∂–∏–º–∞—è '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å', –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –æ–ø–ª–∞—Ç–µ."
    )

    keyboard = [
        [InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å", callback_data="confirm_battery_rent")],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_battery_rent")]
    ]

    # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ ---
    await query.message.delete()
    await context.bot.send_message(
        chat_id=query.from_user.id,
        text=text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )
    return BATTERY_RENT_CONFIRMATION

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ process_battery_rent_payment –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

async def process_battery_rent_payment(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 2 (–ê–†–ï–ù–î–ê): –§–æ—Ä–º–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ YooKassa (–°–ë–ü) –ò –ó–ê–ü–£–°–ö–ê–ï–¢ –ü–†–û–í–ï–†–ö–£."""
    query = update.callback_query
    await query.answer()

    if query.data == "cancel_battery_rent":
        await query.message.edit_text("–ê—Ä–µ–Ω–¥–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
        return ConversationHandler.END

    user_id = query.from_user.id
    data = context.user_data.get('rent_battery_data')

    if not data:
        await query.message.edit_text("üö´ –û—à–∏–±–∫–∞ —Å–µ—Å—Å–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.")
        return ConversationHandler.END

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT phone_number FROM users WHERE id = ?", (user_id,))
    phone_number = (cursor.fetchone() or [None])[0]
    conn.close()

    if not phone_number:
        await query.message.edit_text("üö´ –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ–∫–∞.")
        return ConversationHandler.END

    amount = data['price']
    description = data['description']
    payload = f"rent_battery_{data['product_id']}_{amount}"

    metadata = {'internal_payload': payload, 'user_id': user_id}
    items_for_receipt = [{"description": description, "quantity": "1.00", "amount": {"value": f"{float(amount):.2f}", "currency": "RUB"}, "vat_code": "1", "payment_subject": "service", "payment_mode": "full_payment"}]
    customer_info = {"phone": phone_number}

    payment_info = await create_yookassa_payment(
        amount=amount, description=description, metadata=metadata,
        items=items_for_receipt, customer_info=customer_info, payment_method='sbp'
    )

    if not (payment_info and payment_info.get('url')):
        await query.message.edit_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        return ConversationHandler.END

    # --- –ù–ê–ß–ê–õ–û –ë–õ–û–ö–ê –ó–ê–ü–£–°–ö–ê –ü–†–û–í–ï–†–ö–ò ---
    payment_url, payment_id, final_amount = payment_info['url'], payment_info['id'], payment_info['final_amount']

    keyboard = [[InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å –ø–æ –°–ë–ü", url=payment_url)]]
    animated_message = await query.message.edit_text(
        f"–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞—Ä–µ–Ω–¥—ã, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–ª–∞—Ç–∏—Ç–µ {final_amount:.2f} ‚ÇΩ.",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    if 'pending_payments' not in context.bot_data:
        context.bot_data['pending_payments'] = {}

    stop_animation_event = asyncio.Event()
    context.bot_data['pending_payments'][payment_id] = {
        'user_id': user_id, 'start_time': datetime.now(),
        'payload': metadata['internal_payload'], 'amount': final_amount,
        'animated_message_id': animated_message.message_id, 'url': payment_url,
        'animation_sequence': random.choice(PAYMENT_ANIMATIONS),
        'stop_animation_event': stop_animation_event
    }

    # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∏ –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞
    asyncio.create_task(animate_payment_message(context, payment_id))
    context.job_queue.run_repeating(
        callback=check_payment_status,
        interval=15,
        first=10,
        name=f"payment_{payment_id}",
        data={'yookassa_id': payment_id}
    )
    # --- –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –ó–ê–ü–£–°–ö–ê –ü–†–û–í–ï–†–ö–ò ---

    return ConversationHandler.END


# --- –ù–û–í–´–ô –î–ò–ê–õ–û–ì –î–õ–Ø –í–´–ö–£–ü–ê –ê–ö–ö–£–ú–£–õ–Ø–¢–û–†–ê ---

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
(
    BATTERY_BUYOUT_SELECT_PLAN,
    BATTERY_BUYOUT_CONFIRMATION,
) = range(2)

async def start_battery_buyout(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 1: –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ –∫–Ω–æ–ø–∫–µ '–í—ã–∫—É–ø–∏—Ç—å –ê–ö–ë'. –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ —à–ª–µ—Ç –Ω–æ–≤–æ–µ."""
    query = update.callback_query
    await query.answer()

    product_id = int(query.data.split('_')[-1])

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT name FROM bikes WHERE id=?", (product_id,))
    name = cursor.fetchone()[0]
    conn.close()

    battery_model = '60V21Ah' if '60V21Ah' in name else '60V30Ah'
    buyout_info = BATTERY_BUYOUT_PLANS.get(battery_model)

    if not buyout_info:
        await context.bot.send_message(chat_id=query.from_user.id, text="üö´ –û—à–∏–±–∫–∞: —Ç–∞—Ä–∏—Ñ—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")
        return ConversationHandler.END

    context.user_data['buyout_battery_data'] = {
        'product_id': product_id, 'name': name, 'model': battery_model,
        'initial_payment': buyout_info['initial_payment']
    }

    keyboard = []
    for key, plan in buyout_info['plans'].items():
        keyboard.append([InlineKeyboardButton(plan['label'], callback_data=f"select_bb_plan_{key}")])

    keyboard.append([InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_battery_buyout")])

    # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ ---
    await query.message.delete()
    await context.bot.send_message(
        chat_id=query.from_user.id,
        text=(
            f"–í—ã –≤—ã–±—Ä–∞–ª–∏ —Ä–∞—Å—Å—Ä–æ—á–∫—É –Ω–∞ *{name}*.\n\n"
            f"–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤–∑–Ω–æ—Å: *{buyout_info['initial_payment']} —Ä—É–±.*\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π –¥–ª—è –≤–∞—Å –≥—Ä–∞—Ñ–∏–∫ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π:"
        ),
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )
    return BATTERY_BUYOUT_SELECT_PLAN

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ select_battery_buyout_plan –ù–ê –≠–¢–£

async def select_battery_buyout_plan(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø:
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏ –≤—ã–±–æ—Ä –ø–ª–∞–Ω–∞, –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –∏ –æ—Ç–º–µ–Ω—É.
    """
    query = update.callback_query
    await query.answer()

    data_parts = query.data.split('_')
    action = data_parts[1] # 'bb' (–¥–ª—è select_bb_plan) –∏–ª–∏ 'buyout' (–¥–ª—è confirm_battery_buyout)

    buyout_data = context.user_data.get('buyout_battery_data')
    if not buyout_data:
        await query.message.edit_text("üö´ –û—à–∏–±–∫–∞ —Å–µ—Å—Å–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.")
        return ConversationHandler.END

    # --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–ª–∞–Ω–∞ ---
    if action == 'bb':
        plan_key = query.data.split('select_bb_plan_')[-1]
        plan_details = BATTERY_BUYOUT_PLANS[buyout_data['model']]['plans'][plan_key]

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–ª—é—á –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
        buyout_data['plan_key'] = plan_key

        text = (
            f"**–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ä–∞—Å—Å—Ä–æ—á–∫–∏:**\n\n"
            f"–¢–æ–≤–∞—Ä: *{buyout_data['name']}*\n"
            f"–ü–ª–∞–Ω: *{plan_details['label']}*\n\n"
            f"–°—É–º–º–∞ –ø–µ—Ä–≤–æ–≥–æ –≤–∑–Ω–æ—Å–∞: *{buyout_data['initial_payment']} —Ä—É–±.*\n\n"
            "–ù–∞–∂–∏–º–∞—è '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å', –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –æ–ø–ª–∞—Ç–µ."
        )

        keyboard = [
            [InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å", callback_data="confirm_battery_buyout")],
            [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –ø–ª–∞–Ω–æ–≤", callback_data=f"buyout_battery_{buyout_data['product_id']}")]
        ]

        await query.message.edit_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode="Markdown")
        # –û—Å—Ç–∞–µ–º—Å—è –≤ —Ç–æ–º –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –ø—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∏ –∫–Ω–æ–ø–∫–∏
        return BATTERY_BUYOUT_SELECT_PLAN

    # --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã ---
    elif action == 'buyout' and data_parts[0] == 'confirm':
        # –≠—Ç–æ—Ç –∫–æ–¥ —Ç–µ–ø–µ—Ä—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ process_battery_buyout_payment,
        # —Ç–∞–∫ —á—Ç–æ –º—ã –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é
        return await process_battery_buyout_payment(update, context)

    # --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã ---
    elif action == 'buyout' and data_parts[0] == 'cancel':
        await query.message.edit_text("–†–∞—Å—Å—Ä–æ—á–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.")
        return ConversationHandler.END

    return ConversationHandler.END

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ process_battery_buyout_payment –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

async def process_battery_buyout_payment(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 3 (–í–´–ö–£–ü): –§–æ—Ä–º–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É (–°–ë–ü) –ò –ó–ê–ü–£–°–ö–ê–ï–¢ –ü–†–û–í–ï–†–ö–£."""
    query = update.callback_query
    await query.answer()

    if query.data.startswith("buyout_battery_"):
        return await start_battery_buyout(update, context)

    user_id = query.from_user.id
    data = context.user_data.get('buyout_battery_data')

    if not data:
        await query.message.edit_text("üö´ –û—à–∏–±–∫–∞ —Å–µ—Å—Å–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.")
        return ConversationHandler.END

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT phone_number FROM users WHERE id = ?", (user_id,))
    phone_number = (cursor.fetchone() or [None])[0]
    conn.close()

    if not phone_number:
        await query.message.edit_text("üö´ –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ–∫–∞.")
        return ConversationHandler.END

    amount = data['initial_payment']
    description = f"–ü–µ—Ä–≤—ã–π –≤–∑–Ω–æ—Å –∑–∞ —Ä–∞—Å—Å—Ä–æ—á–∫—É –Ω–∞ –ê–ö–ë '{data['name']}'"
    payload = f"buyout_battery_{data['product_id']}_{data['plan_key']}_{amount}"

    metadata = {'internal_payload': payload, 'user_id': user_id}
    items_for_receipt = [{"description": description, "quantity": "1.00", "amount": {"value": f"{float(amount):.2f}", "currency": "RUB"}, "vat_code": "1", "payment_subject": "service", "payment_mode": "full_payment"}]
    customer_info = {"phone": phone_number}

    payment_info = await create_yookassa_payment(
        amount=amount, description=description, metadata=metadata,
        items=items_for_receipt, customer_info=customer_info, payment_method='sbp'
    )

    if not (payment_info and payment_info.get('url')):
        await query.message.edit_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        return ConversationHandler.END

    # --- –ù–ê–ß–ê–õ–û –ë–õ–û–ö–ê –ó–ê–ü–£–°–ö–ê –ü–†–û–í–ï–†–ö–ò ---
    payment_url, payment_id, final_amount = payment_info['url'], payment_info['id'], payment_info['final_amount']

    keyboard = [[InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å –ø–æ –°–ë–ü", url=payment_url)]]
    animated_message = await query.message.edit_text(
        f"–î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è —Ä–∞—Å—Å—Ä–æ—á–∫–∏, –æ–ø–ª–∞—Ç–∏—Ç–µ –ø–µ—Ä–≤—ã–π –≤–∑–Ω–æ—Å: {final_amount:.2f} ‚ÇΩ.",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

    if 'pending_payments' not in context.bot_data:
        context.bot_data['pending_payments'] = {}

    stop_animation_event = asyncio.Event()
    context.bot_data['pending_payments'][payment_id] = {
        'user_id': user_id, 'start_time': datetime.now(),
        'payload': metadata['internal_payload'], 'amount': final_amount,
        'animated_message_id': animated_message.message_id, 'url': payment_url,
        'animation_sequence': random.choice(PAYMENT_ANIMATIONS),
        'stop_animation_event': stop_animation_event
    }

    asyncio.create_task(animate_payment_message(context, payment_id))
    context.job_queue.run_repeating(
        callback=check_payment_status,
        interval=15,
        first=10,
        name=f"payment_{payment_id}",
        data={'yookassa_id': payment_id}
    )
    # --- –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –ó–ê–ü–£–°–ö–ê –ü–†–û–í–ï–†–ö–ò ---

    return ConversationHandler.END


######## –ù–ê–ß–ê–õ–û –ê–†–ï–ù–î–´ ##########
######## –ù–ê–ß–ê–õ–û –ê–†–ï–ù–î–´ ##########
######## –ù–ê–ß–ê–õ–û –ê–†–ï–ù–î–´ ##########

# ==============================================================================
# –ü–û–õ–ù–ê–Ø –ò –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –§–£–ù–ö–¶–ò–ò start_buyout
# ==============================================================================
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ start_buyout –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

# –®–ê–ì 4: –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–ò–¢–ï –§–£–ù–ö–¶–ò–Æ start_buyout

async def start_buyout(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø:
    - –£–¥–∞–ª—è–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ñ–æ—Ç–æ.
    - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–ª–∞–Ω–æ–º –≤—ã–∫—É–ø–∞.
    """
    query = update.callback_query
    await query.answer()

    bike_id = int(query.data.split('_')[1])
    context.user_data['buyout_bike_id'] = bike_id

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–ª–∞–Ω–∞ –≤—ã–∫—É–ø–∞ –∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute(
        "SELECT name, buyout_total_payments, buyout_payment_amount, buyout_period_days FROM bikes WHERE id=?", 
        (bike_id,)
    )
    result = cursor.fetchone()
    conn.close()

    if not result or not result[1] or result[1] <= 0:
        # <<< –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>
        # –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await query.message.delete()
        # –ó–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
        await context.bot.send_message(
            chat_id=query.from_user.id,
            text="–î–ª—è —ç—Ç–æ–≥–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø–ª–∞–Ω –≤—ã–∫—É–ø–∞. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π."
        )
        # <<< –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>
        return ConversationHandler.END

    name, total_payments, payment_amount, period_days = result
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –ø–ª–∞–Ω–æ–º –≤—ã–∫—É–ø–∞
    plan_text = (
        f"üí∞ *–ü–ª–∞–Ω –≤—ã–∫—É–ø–∞ –¥–ª—è ¬´{name}¬ª*\n\n"
        f" ‚Ä¢ –í—Å–µ–≥–æ –ø–ª–∞—Ç–µ–∂–µ–π: *{total_payments}*\n"
        f" ‚Ä¢ –°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞: *{payment_amount} ‚ÇΩ*\n"
        f" ‚Ä¢ –ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å: *–∫–∞–∂–¥—ã–µ {period_days} –¥–Ω–µ–π*\n\n"
        "–ù–∞–∂–∏–º–∞—è '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å', –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å –¥–∞–Ω–Ω—ã–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏."
    )
    
    context.user_data['buyout_plan_key'] = f"buyout_bike_{bike_id}"
    
    keyboard = [
        [InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ —Å–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É", callback_data="confirm_buyout_payment")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"info_{bike_id}")]
    ]
    
    # <<< –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Å —Ñ–æ—Ç–æ)
    await query.message.delete()
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await context.bot.send_message(
        chat_id=query.from_user.id,
        text=plan_text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )
    # <<< –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>

    return CONFIRM_BUYOUT

async def select_buyout_plan(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –ø–ª–∞–Ω–∞ –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ."""
    query = update.callback_query
    await query.answer()

    plan_key = '_'.join(query.data.split('_')[2:])

    if plan_key not in BUYOUT_PLANS:
        logging.error(f"–ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á –ø–ª–∞–Ω–∞ –≤—ã–∫—É–ø–∞ –ø–æ–ª—É—á–µ–Ω: {plan_key}")
        await query.edit_message_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return SELECT_BUYOUT_PLAN

    plan = BUYOUT_PLANS[plan_key]
    context.user_data['buyout_plan_key'] = plan_key

    text = (
        f"üìù *–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –≤—ã–∫—É–ø–∞*\n\n"
        # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á 'full_label' –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è
        f"–í—ã –≤—ã–±—Ä–∞–ª–∏: *{plan['full_label']}*\n\n"
        f"–ü–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂ —Å–æ—Å—Ç–∞–≤–∏—Ç: *{plan['first_payment']} ‚ÇΩ*\n"
        f"–í—Å–µ–≥–æ –ø–ª–∞—Ç–µ–∂–µ–π: *{plan['total_payments']}*\n\n"
        "–ù–∞–∂–∏–º–∞—è '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å', –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ –æ—Ñ–µ—Ä—Ç—ã –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –æ–ø–ª–∞—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –≤–∑–Ω–æ—Å–∞."
    )

    keyboard = [
        [InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å", callback_data="confirm_buyout_payment")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É –ø–ª–∞–Ω–æ–≤", callback_data=f"buyout_{context.user_data['buyout_bike_id']}")]
    ]

    await query.edit_message_text(
        text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )
    return CONFIRM_BUYOUT

# –ó–∞–º–µ–Ω–∏—Ç–µ –≤–∞—à—É —Å—Ç–∞—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞ —ç—Ç—É
# –ó–ê–ú–ï–ù–ò–¢–ï –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ confirm_buyout_payment –ù–ê –≠–¢–£:
# –ó–ê–ú–ï–ù–ò–¢–ï –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ confirm_buyout_payment –ù–ê –≠–¢–£:
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ confirm_buyout_request –ù–ê –≠–¢–£

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ confirm_buyout_request –ù–ê –≠–¢–£

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ confirm_buyout_request –ù–ê –≠–¢–£

async def confirm_buyout_request(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø:
    - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–∫—É–ø –¥–ª—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ —Ç–∞—Ä–∏—Ñ–∞–º–∏ –∏–∑ –ë–î.
    """
    query = update.callback_query
    await query.answer()
    user_id = query.from_user.id

    plan_key = context.user_data.get('buyout_plan_key')
    bike_model_id = context.user_data.get('buyout_bike_id')

    if not all([plan_key, bike_model_id]):
        await context.bot.send_message(
            chat_id=user_id,
            text="üö´ –û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –æ –≤—ã–∫—É–ø–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ."
        )
        return ConversationHandler.END

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    try:
        start_date = datetime.now().strftime('%d.%m.%Y')
        cursor.execute(
            """INSERT INTO bookings (user_id, bike_id, booking_date, status, booking_type, payment_plan_key)
               VALUES (?, ?, ?, ?, ?, ?)""",
            (user_id, bike_model_id, start_date, 'paid_unassigned', 'buyout', plan_key)
        )
        booking_id = cursor.lastrowid
        conn.commit()

        try:
            await query.message.delete()
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")

        await context.bot.send_message(
            chat_id=user_id,
            text="‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞! –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –∏ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–∞. üïí"
        )

        cursor.execute("SELECT first_name, last_name, username FROM users WHERE id=?", (user_id,))
        user_info = cursor.fetchone()
        user_name_raw = f"{user_info[0]} {user_info[1] or ''} (@{user_info[2] or 'no_username'})" if user_info else f"ID {user_id}"

        cursor.execute("SELECT name FROM bikes WHERE id=?", (bike_model_id,))
        bike_name = cursor.fetchone()[0]

        plan_label = ""
        button_text = "‚úçÔ∏è –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞—è–≤–∫—É"

        # <<< –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>
        if plan_key == 'custom':
            plan_label = "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è"
            button_text = "‚úçÔ∏è –°–æ–∑–¥–∞—Ç—å —Å–¥–µ–ª–∫—É –≤—Ä—É—á–Ω—É—é"
        else:
            # –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫–∞—Å—Ç–æ–º–Ω–∞—è —Å–¥–µ–ª–∫–∞, –∑–Ω–∞—á–∏—Ç, —ç—Ç–æ –≤—ã–∫—É–ø —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º –ø–ª–∞–Ω–æ–º –∏–∑ –ë–î
            cursor.execute(
                "SELECT buyout_total_payments, buyout_payment_amount, buyout_period_days FROM bikes WHERE id=?",
                (bike_model_id,)
            )
            plan_details = cursor.fetchone()
            if plan_details:
                total_payments, payment_amount, period_days = plan_details
                plan_label = f"{total_payments} –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ {payment_amount} ‚ÇΩ (—Ä–∞–∑ –≤ {period_days} –¥–Ω–µ–π)"
                button_text = "‚úçÔ∏è –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤—ã–∫—É–ø"
            else:
                plan_label = "–ü–ª–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î!"
        # <<< –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>
        
        admin_notification = (
            f"üö® *–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –í–´–ö–£–ü\\!*\n\n"
            f"üë§ *–ö–ª–∏–µ–Ω—Ç:* {escape_markdown(user_name_raw, 2)}\n"
            f"üö≤ *–ú–æ–¥–µ–ª—å:* {escape_markdown(bike_name, 2)}\n"
            f"üìã *–ü–ª–∞–Ω:* {escape_markdown(plan_label, 2)}\n\n"
            f"–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞–∑–Ω–∞—á–∏—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥ –∏ –≤—ã—Å—Ç–∞–≤–∏—Ç—å —Å—á–µ—Ç:"
        )

        keyboard = [[InlineKeyboardButton(button_text, callback_data=f"assign_{booking_id}")]]

        for admin_id in ADMIN_IDS:
            await context.bot.send_message(
                admin_id, admin_notification,
                parse_mode="MarkdownV2",
                reply_markup=InlineKeyboardMarkup(keyboard)
            )

        add_notification(f"–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –í–´–ö–£–ü –æ—Ç {user_name_raw} ({plan_label})")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ confirm_buyout_request: {e}", exc_info=True)
        await context.bot.send_message(
            chat_id=user_id,
            text="‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π."
        )
    finally:
        if conn: conn.close()

    return ConversationHandler.END

async def arenda(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()

    bike_id = query.data.split("_")[1]
    
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT name, price FROM bikes WHERE id=?", (bike_id,))
    bike = cursor.fetchone()
    conn.close()

    if bike:
        # –í—ã–±–æ—Ä —Å—Ä–æ–∫–∞ –∞—Ä–µ–Ω–¥—ã —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º 7 –¥–Ω–µ–π
        keyboard = [
            # –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–∞ 7 –¥–Ω–µ–π
            [InlineKeyboardButton("–ù–∞ 7 –¥–Ω–µ–π", callback_data=f"prolong_7_{bike_id}")],
            [InlineKeyboardButton("–ù–∞ 14 –¥–Ω–µ–π", callback_data=f"prolong_14_{bike_id}")],
            [InlineKeyboardButton("–ù–∞ 30 –¥–Ω–µ–π", callback_data=f"prolong_30_{bike_id}")],
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ –∞—Ä–µ–Ω–¥—ã:", reply_markup=reply_markup)
    else:
        await query.message.reply_text("üö´ –û—à–∏–±–∫–∞: –≤–µ–ª–æ—Å–∏–ø–µ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω.")


# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ select_rental_period –ù–ê –≠–¢–£ –ò–°–ü–†–ê–í–õ–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ select_rental_period –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

# –®–ê–ì 3: –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–ò–¢–ï –§–£–ù–ö–¶–ò–Æ select_rental_period

import sqlite3
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes

async def select_rental_period(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø:
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —Å—Ä–æ–∫–∞ –∞—Ä–µ–Ω–¥—ã.
    1.  –ü–æ–ª—É—á–∞–µ—Ç —Ü–µ–Ω—É –∞—Ä–µ–Ω–¥—ã –∏–∑ –ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–´–• –ø–æ–ª–µ–π –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –≤ –ë–î.
    2.  –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é —Å–∫–∏–¥–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    3.  –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –∏—Ç–æ–≥–æ–≤–æ–π —Ü–µ–Ω–æ–π –∏ —É—Å–ª–æ–≤–∏—è–º–∏.
    """
    query = update.callback_query
    await query.answer()

    user_id = query.from_user.id
    
    # --- –®–∞–≥ 1: –†–∞–∑–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–Ω–æ–ø–∫–∏ ---
    try:
        # Callback –∏–º–µ–µ—Ç —Ñ–æ—Ä–º–∞—Ç: prolong_{days}_{bike_id}
        _, days_str, bike_id_str = query.data.split("_")
        days = int(days_str)
        bike_id = int(bike_id_str)
    except (ValueError, IndexError):
        await query.message.edit_text("üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥ –∑–∞–Ω–æ–≤–æ.")
        return

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    try:
        # --- –®–∞–≥ 2: –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –∏–∑ –Ω—É–∂–Ω–æ–π –∫–æ–ª–æ–Ω–∫–∏ –≤ –ë–î ---
        # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è –∫–æ–ª–æ–Ω–∫–∏ (rent_price_7d, rent_price_14d –∏ —Ç.–¥.)
        price_column = f"rent_price_{days}d"
        
        # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –∏ –µ–≥–æ –ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–£–Æ —Ü–µ–Ω—É –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å—Ä–æ–∫
        cursor.execute(f"SELECT name, {price_column} FROM bikes WHERE id=?", (bike_id,))
        result = cursor.fetchone()
        
        if not result:
            await query.message.edit_text("üö´ –û—à–∏–±–∫–∞: –≤–µ–ª–æ—Å–∏–ø–µ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")
            return

        bike_name, total_price = result
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ª–∏ —Ü–µ–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞
        if not total_price or total_price <= 0:
            await query.message.edit_text(f"üö´ –î–ª—è —ç—Ç–æ–≥–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Ü–µ–Ω–∞ –∞—Ä–µ–Ω–¥—ã –Ω–∞ {days} –¥–Ω–µ–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π —Å—Ä–æ–∫ –∏–ª–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥.")
            return

        # --- –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫—É ---
        final_price = float(total_price)
        discount_amount = 0
        cursor.execute("""
            SELECT amount FROM discounts
            WHERE user_id = ? AND is_used = 0 AND expiry_date > CURRENT_TIMESTAMP
            ORDER BY created_at DESC LIMIT 1
        """, (user_id,))
        active_discount = cursor.fetchone()
        if active_discount:
            discount_amount = active_discount[0]
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
            final_price = apply_discount(final_price, discount_amount)
        
        # --- –®–∞–≥ 4: –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞ ---
        context.user_data['rental_data'] = {
            'bike_id': bike_id,
            'days': days,
            'bike_name': bike_name,
            'total_price': final_price # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Ü–µ–Ω—É —Å–æ —Å–∫–∏–¥–∫–æ–π
        }

        # --- –®–∞–≥ 5: –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ---
        price_message = f"–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ: *{final_price:.2f} ‚ÇΩ*.\n"
        if discount_amount > 0:
            price_message += f"_(—Å —É—á–µ—Ç–æ–º –≤–∞—à–µ–π —Å–∫–∏–¥–∫–∏ –≤ {discount_amount} ‚ÇΩ, –æ–±—ã—á–Ω–∞—è —Ü–µ–Ω–∞: {total_price:.2f} ‚ÇΩ)_\n"

        keyboard = [[InlineKeyboardButton("‚úÖ –Ø —Å–æ–≥–ª–∞—Å–µ–Ω –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é", callback_data="confirm_agreement")]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        final_text = (
            f"–í—ã –≤—ã–±—Ä–∞–ª–∏ –∞—Ä–µ–Ω–¥—É '{bike_name}' –Ω–∞ {days} –¥–Ω–µ–π.\n\n"
            f"{price_message}\n"
            "‚ö†Ô∏è –ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É ¬´‚úÖ –Ø —Å–æ–≥–ª–∞—Å–µ–Ω –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é¬ª, –≤—ã:\n"
            "1. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ —Å–≤–æ–µ –ø–æ–ª–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏ "
            "[–ø—É–±–ª–∏—á–Ω–æ–π –æ—Ñ–µ—Ä—Ç—ã](https://badfoxbike.ru/oferta.html) –∏ [–ø–æ–ª–∏—Ç–∏–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö](https://badfoxbike.ru/privacy-policy.html).\n"
            "2. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ, —á—Ç–æ –æ–∑–Ω–∞–∫–æ–º–∏–ª–∏—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∞—Ä–µ–Ω–¥—ã –∏ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ –∏—Ö.\n\n"
            "–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:"
        )

        await query.message.edit_text(
            final_text,
            parse_mode='Markdown',
            disable_web_page_preview=True,
            reply_markup=reply_markup
        )
    
    except sqlite3.Error as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ë–î –≤ select_rental_period: {e}")
        await query.message.edit_text("üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ –¥–∞–Ω–Ω—ã–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
    finally:
        # –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
        conn.close()

from telegram import Update, LabeledPrice
from telegram.ext import ContextTypes, ApplicationBuilder  # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ ApplicationBuilder
from telegram import Update, LabeledPrice, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import ContextTypes
import sqlite3
from datetime import datetime

# main.py
# –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –±–æ—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, PythonApplication12.py)

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥

# –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –±–æ—Ç–∞

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞




async def cancel_processing(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û—Ç–º–µ–Ω—è–µ—Ç –¥–∏–∞–ª–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏."""
    query = update.callback_query
    await query.answer()

    # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–µ–ª, —á—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ
    await query.edit_message_text("–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞—è–≤–∫–∏ –æ—Ç–º–µ–Ω–µ–Ω–∞.")

    # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    context.user_data.clear()

    # –ó–∞–≤–µ—Ä—à–∞–µ–º –¥–∏–∞–ª–æ–≥
    return ConversationHandler.END


# –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –±–æ—Ç–∞
import fpdf # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
import fpdf
from fpdf.enums import XPos, YPos
import json
import os
from datetime import datetime
import locale
# –í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ assign_bike_by_number
# –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –î–ï–¢–ê–õ–¨–ù–û–ì–û –î–û–ì–û–í–û–†–ê –í PDF

# –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –î–û–ì–û–í–û–†–ê –í WORD (.DOCX)
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫—É: pip install python-docx
from docx import Document
from docx.shared import Pt, Cm
from docx.enum.text import WD_ALIGN_PARAGRAPH
from datetime import datetime
import locale
import sqlite3
import json
import os
import locale
from datetime import datetime

# –ò–º–ø–æ—Ä—Ç—ã –¥–ª—è python-telegram-bot
from telegram import Update, LabeledPrice
from telegram.ext import ContextTypes, ConversationHandler

# –ò–º–ø–æ—Ä—Ç—ã –¥–ª—è python-docx
from docx import Document
from docx.shared import Pt, Cm
from docx.enum.text import WD_ALIGN_PARAGRAPH
from docx.oxml.ns import qn

# --- –ö–û–ù–°–¢–ê–ù–¢–´ (—É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω–∏ —É –≤–∞—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã) ---
# PROCESS_APPLICATION_ENTER_NUMBER = range(1) # –í–∞—à–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
# DB_FILE = "your_database.db" # –ü—É—Ç—å –∫ –≤–∞—à–µ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
# PROVIDER_TOKEN = "YOUR_PAYMENT_PROVIDER_TOKEN" # –í–∞—à —Ç–æ–∫–µ–Ω –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π
# import logging
# logger = logging.getLogger(__name__)

# --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –°–û–ó–î–ê–ù–ò–Ø –ö–û–õ–û–ù–¢–ò–¢–£–õ–ê (–§–£–¢–ï–†–ê) ---
# --- –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ö–û–õ–û–ù–¢–ò–¢–£–õ–ê ---
# –ó–∞–º–µ–Ω–∏—Ç–µ –≤–∞—à—É —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ —ç—Ç—É
from docx.oxml import OxmlElement
from docx.oxml.ns import qn
# main.py

# --- –ö–û–î –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –î–û–ì–û–í–û–†–ê ---
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞: pip install python-docx

import locale
import json
import os
from datetime import datetime
from docx import Document
from docx.shared import Pt, Cm
from docx.enum.text import WD_ALIGN_PARAGRAPH
from docx.oxml import OxmlElement
from docx.oxml.ns import qn



# –®–ê–ì 3: –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–£ –§–£–ù–ö–¶–ò–Æ

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç:
# pip install python-docx
# pip install num2words

from docx import Document
from docx.shared import Pt, Cm
from docx.enum.text import WD_ALIGN_PARAGRAPH
from datetime import datetime
from num2words import num2words
import locale
import os

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:
# pip install python-docx
# pip install num2words

from docx import Document
from docx.shared import Pt, Cm
from docx.enum.text import WD_ALIGN_PARAGRAPH
from datetime import datetime
from num2words import num2words
import locale
import os

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:
# pip install python-docx
# pip install num2words

from docx import Document
from docx.shared import Pt, Cm
from docx.enum.text import WD_ALIGN_PARAGRAPH
from datetime import datetime
from num2words import num2words
import locale
import os

# ==============================================================================
# –ü–û–õ–ù–ê–Ø –ò –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –û–ë–û–ò–• –î–û–ì–û–í–û–†–û–í
# ==============================================================================
import locale
from docx import Document
from docx.shared import Pt
from docx.enum.text import WD_ALIGN_PARAGRAPH
from num2words import num2words
from datetime import datetime
import os

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä—É—Å—Å–∫—É—é –ª–æ–∫–∞–ª—å –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ—Å—è—Ü–µ–≤
try:
    locale.setlocale(locale.LC_TIME, 'ru_RU.UTF-8')
except locale.Error:
    logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å ru_RU.UTF-8. –ù–∞–∑–≤–∞–Ω–∏—è –º–µ—Å—è—Ü–µ–≤ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º.")

# ==============================================================================
# –ü–û–õ–ù–ê–Ø –ò –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –û–ë–û–ò–• –î–û–ì–û–í–û–†–û–í (–° –§–ò–ö–°–ê–ú–ò)
# ==============================================================================
import locale
from docx import Document
from docx.shared import Pt
from docx.enum.text import WD_ALIGN_PARAGRAPH
from num2words import num2words
from datetime import datetime
import os

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä—É—Å—Å–∫—É—é –ª–æ–∫–∞–ª—å –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ—Å—è—Ü–µ–≤
try:
    locale.setlocale(locale.LC_TIME, 'ru_RU.UTF-8')
except locale.Error:
    logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å ru_RU.UTF-8. –ù–∞–∑–≤–∞–Ω–∏—è –º–µ—Å—è—Ü–µ–≤ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º.")

# ==============================================================================
# –ü–û–õ–ù–ê–Ø –ò –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –û–ë–û–ò–• –î–û–ì–û–í–û–†–û–í
# ==============================================================================
import locale
from docx import Document
from docx.shared import Pt
from docx.enum.text import WD_ALIGN_PARAGRAPH
from num2words import num2words
from datetime import datetime
import os

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä—É—Å—Å–∫—É—é –ª–æ–∫–∞–ª—å –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ—Å—è—Ü–µ–≤
try:
    locale.setlocale(locale.LC_TIME, 'ru_RU.UTF-8')
except locale.Error:
    logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å ru_RU.UTF-8. –ù–∞–∑–≤–∞–Ω–∏—è –º–µ—Å—è—Ü–µ–≤ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º.")

# ==============================================================================
# –ü–û–õ–ù–ê–Ø –ò –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –û–ë–û–ò–• –î–û–ì–û–í–û–†–û–í
# ==============================================================================
import locale
from docx import Document
from docx.shared import Pt
from docx.enum.text import WD_ALIGN_PARAGRAPH
from num2words import num2words
from datetime import datetime
import os

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä—É—Å—Å–∫—É—é –ª–æ–∫–∞–ª—å –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ—Å—è—Ü–µ–≤
try:
    locale.setlocale(locale.LC_TIME, 'ru_RU.UTF-8')
except locale.Error:
    logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å ru_RU.UTF-8. –ù–∞–∑–≤–∞–Ω–∏—è –º–µ—Å—è—Ü–µ–≤ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º.")

# ==============================================================================
# –ü–û–õ–ù–ê–Ø –ò –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –û–ë–û–ò–• –î–û–ì–û–í–û–†–û–í (–° –§–ò–ö–°–ê–ú–ò)
# ==============================================================================
import locale
from docx import Document
from docx.shared import Pt, Cm
from docx.enum.text import WD_ALIGN_PARAGRAPH
from num2words import num2words
from datetime import datetime
import os

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä—É—Å—Å–∫—É—é –ª–æ–∫–∞–ª—å –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ—Å—è—Ü–µ–≤
try:
    locale.setlocale(locale.LC_TIME, 'ru_RU.UTF-8')
except locale.Error:
    logger.warning("–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–æ–∫–∞–ª—å ru_RU.UTF-8. –ù–∞–∑–≤–∞–Ω–∏—è –º–µ—Å—è—Ü–µ–≤ –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º.")

def generate_contract_docx(booking_id: int, deal_type: str, deal_data: dict, user_data: dict, bike_data: dict) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω—É–∂–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç (.docx) - –ê–∫—Ç –¥–ª—è –∞—Ä–µ–Ω–¥—ã –∏–ª–∏ –°–æ–≥–ª–∞—à–µ–Ω–∏–µ –¥–ª—è –≤—ã–∫—É–ø–∞.
    """
    doc = Document()
    
    # --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –≤—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ---
    style = doc.styles['Normal']
    font = style.font
    font.name = 'Times New Roman'
    font.size = Pt(11)

    # –£–º–µ–Ω—å—à–∞–µ–º –ø–æ–ª—è, —á—Ç–æ–±—ã –≤–ª–µ–∑–ª–æ –Ω–∞ 3 —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    section = doc.sections[0]
    section.left_margin = Cm(2.0)
    section.right_margin = Cm(1.0)
    section.top_margin = Cm(1.5)
    section.bottom_margin = Cm(1.5)

    now = datetime.now()
    month_names_ru = {
       1: "—è–Ω–≤–∞—Ä—è", 2: "—Ñ–µ–≤—Ä–∞–ª—è", 3: "–º–∞—Ä—Ç–∞", 4: "–∞–ø—Ä–µ–ª—è", 5: "–º–∞—è", 6: "–∏—é–Ω—è",
       7: "–∏—é–ª—è", 8: "–∞–≤–≥—É—Å—Ç–∞", 9: "—Å–µ–Ω—Ç—è–±—Ä—è", 10: "–æ–∫—Ç—è–±—Ä—è", 11: "–Ω–æ—è–±—Ä—è", 12: "–¥–µ–∫–∞–±—Ä—è"
    }
    date_str = f'¬´{now.day}¬ª {month_names_ru[now.month]} {now.year} –≥.'

    # =========================================================================
    # --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –ê–ö–¢–ê –ê–†–ï–ù–î–´ (deal_type == 'rent') ---
    # =========================================================================
    if deal_type == 'rent':
        doc.add_heading('–ê–ö–¢', level=1).alignment = WD_ALIGN_PARAGRAPH.CENTER
        doc.add_paragraph('–ø—Ä–∏–µ–º–∞-–ø–µ—Ä–µ–¥–∞—á–∏ –∫ –ü—É–±–ª–∏—á–Ω–æ–π –æ—Ñ–µ—Ä—Ç–µ –æ –∑–∞–∫–ª—é—á–µ–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ –∞—Ä–µ–Ω–¥—ã —ç–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –≤ —Ä–µ–¥–∞–∫—Ü–∏–∏ –æ—Ç 29.06.2025 –≥–æ–¥–∞').alignment = WD_ALIGN_PARAGRAPH.CENTER
        doc.add_paragraph(f'–≥. –ú–æ—Å–∫–≤–∞\t\t\t\t\t{date_str}')
        
        p_preamble = doc.add_paragraph()
        p_preamble.paragraph_format.space_after = Pt(6)
        run_user = p_preamble.add_run(user_data.get('full_name', '___________________________'))
        run_user.bold = True
        p_preamble.add_run(f", –∏–º–µ–Ω—É–µ–º—ã–π –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º ¬´–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä¬ª, —Å –æ–¥–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –∏\n") # –ü–æ–ª –≤—Å–µ–≥–¥–∞ –º—É–∂—Å–∫–æ–π
        run_owner = p_preamble.add_run('–ö—É–∑–Ω–µ—Ü–æ–≤ –í–ª–∞–¥–∏—Å–ª–∞–≤ –ò–≥–æ—Ä–µ–≤–∏—á')
        run_owner.bold = True
        p_preamble.add_run(', —è–≤–ª—è—é—â–∏–π—Å—è –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–æ–º –Ω–∞–ª–æ–≥–∞ –Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ —Å–ø—Ä–∞–≤–∫–∏ –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞ –Ω–∞–ª–æ–≥–∞ –Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥ –æ—Ç 26.05.2025 ‚Ññ 81914483, –∏–º–µ–Ω—É–µ–º—ã–π –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º ¬´–ê—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å¬ª —Å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, —Å–æ–≤–º–µ—Å—Ç–Ω–æ –∏–º–µ–Ω—É–µ–º—ã–µ ¬´–°—Ç–æ—Ä–æ–Ω—ã¬ª, –∞ –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏ ¬´–°—Ç–æ—Ä–æ–Ω–∞¬ª, —Å–æ—Å—Ç–∞–≤–∏–ª–∏ –Ω–∞—Å—Ç–æ—è—â–∏–π –∞–∫—Ç –ø—Ä–∏–µ–º–∞-–ø–µ—Ä–µ–¥–∞—á–∏ (–¥–∞–ª–µ–µ - –ê–∫—Ç) –æ —Å–ª–µ–¥—É—é—â–µ–º:')
        
        doc.add_paragraph('1. –í —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ü—É–±–ª–∏—á–Ω–æ–π –æ—Ñ–µ—Ä—Ç–æ–π –æ –∑–∞–∫–ª—é—á–µ–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ –∞—Ä–µ–Ω–¥—ã —ç–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –≤ —Ä–µ–¥–∞–∫—Ü–∏–∏ –æ—Ç 29.06.2025 –≥–æ–¥–∞ (–¥–∞–ª–µ–µ - –î–æ–≥–æ–≤–æ—Ä) –ê—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å –ø–µ—Ä–µ–¥–∞–ª, –∞ –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä –ø—Ä–∏–Ω—è–ª —Å–ª–µ–¥—É—é—â–µ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ (–¥–∞–ª–µ–µ - –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ):')
        doc.add_paragraph(f"- –º–∞—Ä–∫–∞, –º–æ–¥–µ–ª—å: {bike_data.get('model', '________________')} \tVIN: {bike_data.get('vin', '__________________________')};")
        
        # --- –í—Å—Ç–∞–≤–∫–∞ –Ω–æ–º–µ—Ä–æ–≤ –ê–ö–ë ---
        battery_nums = bike_data.get('battery_numbers', [])
        battery_count = bike_data.get('batteries_count', '___')
        if battery_nums:
            num_str = ", ".join([f"‚Ññ{num}" for num in battery_nums])
            doc.add_paragraph(f"- –±–∞—Ç–∞—Ä–µ–∏, —à—Ç.: {battery_count} ({num_str}).")
        else:
            doc.add_paragraph(f"- –±–∞—Ç–∞—Ä–µ–∏, —à—Ç.: {battery_count}.")
        
        doc.add_paragraph('2. –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–∞—â–µ–Ω–æ —Å–ª–µ–¥—É—é—â–∏–º —Å–µ—Ä–∏–π–Ω—ã–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º –∏ –∫–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–º–∏ –∏–∑–¥–µ–ª–∏—è–º–∏, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –∑–∞–≤–æ–¥–æ–º-–∏–∑–≥–æ—Ç–æ–≤–∏—Ç–µ–ª–µ–º, –∞ —Ç–∞–∫–∂–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ–º:\n- –†–µ–∑–∏–Ω–∫–∞ –¥–ª—è –±–∞–≥–∞–∂–Ω–∏–∫–∞;\n- –í–µ–ª–æ—Å–∏–ø–µ–¥–Ω—ã–π –∑–∞–º–æ–∫.')
        doc.add_paragraph('3. –ü—Ä–∏ –æ—Å–º–æ—Ç—Ä–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è –∏ —ç–∫—Å–ø–ª—É–∞—Ç–∞—Ü–∏–æ–Ω–Ω—ã—Ö –¥–µ—Ñ–µ–∫—Ç–æ–≤ –û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ, –Ω–∞—Ä—É—à–µ–Ω–∏—è –∫–æ–º–ø–ª–µ–∫—Ç–Ω–æ—Å—Ç–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.')
        
        price = deal_data.get('price', 0)
        price_in_words = num2words(int(price), lang='ru').capitalize()
        p4_text = (
            '4. –ù–∞—Å—Ç–æ—è—â–µ–µ –ê–ö–¢ –ø—Ä–∏–µ–º–∞-–ø–µ—Ä–µ–¥–∞—á–∏ –∫ –ü—É–±–ª–∏—á–Ω–æ–π –æ—Ñ–µ—Ä—Ç–µ –æ –∑–∞–∫–ª—é—á–µ–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ –∞—Ä–µ–Ω–¥—ã —ç–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –≤ —Ä–µ–¥–∞–∫—Ü–∏–∏ –æ—Ç 29.06.2025 (–¥–∞–ª–µ–µ ‚Äì–ê–ö–¢) –∑–∞–∫–ª—é—á–µ–Ω–æ –°—Ç–æ—Ä–æ–Ω–∞–º–∏ –¥–∏—Å—Ç–∞–Ω—Ü–∏–æ–Ω–Ω–æ –ø—É—Ç—ë–º —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–∏—Ö –∫–æ–Ω–∫–ª—é–¥–µ–Ω—Ç–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∏—Ö –Ω–∞–¥–ª–µ–∂–∞—â—É—é –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –°—Ç–æ—Ä–æ–Ω: –¥–ª—è –∑–∞–∫–ª—é—á–µ–Ω–∏—è –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –ê–ö–¢–∞ –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç —Å–æ —Å–≤–æ–µ–≥–æ –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á—ë—Ç–∞ –Ω–∞ –±–∞–Ω–∫–æ–≤—Å–∫–∏–π —Å—á—ë—Ç –ê—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—è –¥–µ–Ω–µ–∂–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –≤ —Ä–∞–∑–º–µ—Ä–µ '
            f'{price:,.0f} ({price_in_words}) —Ä—É–±–ª–µ–π. –ü–ª–∞—Ç–µ–∂ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–≤–µ—Ä—à–µ–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞, —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –≤ –Ω–∞—Å—Ç–æ—è—â–µ–º –ê–ö–¢–µ. –í —Ü–µ–ª—è—Ö –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π (–¥–µ–π—Å—Ç–≤—É—é—â–µ–π) —Ä–µ–¥–∞–∫—Ü–∏–∏ –ê–ö–¢–∞ –≤ —Å–ª—É—á–∞–µ –µ–≥–æ –æ–±—Å—É–∂–¥–µ–Ω–∏—è –°—Ç–æ—Ä–æ–Ω–∞–º–∏ –∫–∞–∂–¥–∞—è –Ω–æ–≤–∞—è —Ä–µ–¥–∞–∫—Ü–∏—è –ê–ö–¢–∞ –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç—Å—è –Ω–æ–≤—ã–º (—É–Ω–∏–∫–∞–ª—å–Ω—ã–º) –Ω–æ–º–µ—Ä–æ–º. '
            '–ê–ö–¢–∞ —è–≤–ª—è–µ—Ç—Å—è —Ä–µ–¥–∞–∫—Ü–∏—è, —É—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–∞—è –°—Ç–æ—Ä–æ–Ω–∞–º–∏ –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º –æ–±–º–µ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –ø–æ –ú–æ–±–∏–ª—å–Ω–æ–º—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é ‚Äî –ø—Ä–æ–≥—Ä–∞–º–º–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º (—Ç–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç) https://t.me/badfoxbikebot.'
        ).replace(",", " ")
        doc.add_paragraph(f'\n{p4_text}')

        doc.add_paragraph('\n5. –°–∫–æ—Ä –∞—Ä–µ–Ω–¥—ã –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä–æ–º —á–µ—Ä–µ–∑ –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Äî –ø—Ä–æ–≥—Ä–∞–º–º–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º (—Ç–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç) https://t.me/badfoxbikebot –≤ —Ä–∞–º–∫–∞—Ö –ü—É–±–ª–∏—á–Ω–æ–π –æ—Ñ–µ—Ä—Ç–µ –æ –∑–∞–∫–ª—é—á–µ–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ –∞—Ä–µ–Ω–¥—ã —ç–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –≤ —Ä–µ–¥–∞–∫—Ü–∏–∏ –æ—Ç 29.06.2025 –≥–æ–¥–∞.')
        doc.add_paragraph('\n6. –ù–∞—Å—Ç–æ—è—â–∏–π –ê–ö–¢ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω –≤ –¥–≤—É—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–∞—Ö, –∏–º–µ—é—â–∏—Ö –æ–¥–∏–Ω–∞–∫–æ–≤—É—é —é—Ä–∏–¥–∏—á–µ—Å–∫—É—é —Å–∏–ª—É, –ø–æ –æ–¥–Ω–æ–º—É —ç–∫–∑–µ–º–ø–ª—è—Ä—É –¥–ª—è –∫–∞–∂–¥–æ–π –°—Ç–æ—Ä–æ–Ω—ã.')
        
        output_filename = f"–ê–∫—Ç_‚Ññ{booking_id}_–æ—Ç_{now.strftime('%d-%m-%Y')}.docx"

    # =========================================================================
    # --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –°–û–ì–õ–ê–®–ï–ù–ò–Ø –û –í–´–ö–£–ü–ï (deal_type == 'buyout') ---
    # =========================================================================
    elif deal_type == 'buyout':
        plan_data = deal_data
        
        doc.add_heading(
            '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –∫ –ü—É–±–ª–∏—á–Ω–æ–π –æ—Ñ–µ—Ä—Ç–µ –æ –∑–∞–∫–ª—é—á–µ–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ –∞—Ä–µ–Ω–¥—ã\n'
            '—ç–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –≤ —Ä–µ–¥–∞–∫—Ü–∏–∏ –æ—Ç 29.06.2025\n'
            '–æ –≤—ã–∫—É–ø–µ –∞—Ä–µ–Ω–¥—É–µ–º–æ–≥–æ –∏–º—É—â–µ—Å—Ç–≤–∞',
            level=1
        ).alignment = WD_ALIGN_PARAGRAPH.CENTER
        
        doc.add_paragraph(f'–≥. –ú–æ—Å–∫–≤–∞\t\t\t\t\t{date_str}')

        p_preamble = doc.add_paragraph()
        p_preamble.paragraph_format.space_after = Pt(6)
        run_owner = p_preamble.add_run('–ö—É–∑–Ω–µ—Ü–æ–≤ –í–ª–∞–¥–∏—Å–ª–∞–≤ –ò–≥–æ—Ä–µ–≤–∏—á')
        run_owner.bold = True
        p_preamble.add_run(', —è–≤–ª—è—é—â–∏–π—Å—è –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–æ–º –Ω–∞–ª–æ–≥–∞ –Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ —Å–ø—Ä–∞–≤–∫–∏ –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞ –Ω–∞–ª–æ–≥–∞ –Ω–∞ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥ –æ—Ç 13.06.2025 ‚Ññ 83338912, –∏–º–µ–Ω—É–µ–º—ã–π –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º ¬´–ê—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å¬ª, —Å –æ–¥–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –∏\n')
        run_user = p_preamble.add_run(user_data.get('full_name', '_________________________________'))
        run_user.bold = True
        p_preamble.add_run(f", –∏–º–µ–Ω—É–µ–º—ã–π –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º ¬´–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä¬ª, —Å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, –∏–º–µ–Ω—É–µ–º—ã–µ –≤–º–µ—Å—Ç–µ ¬´–°—Ç–æ—Ä–æ–Ω—ã¬ª, –∞ –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏ ¬´–°—Ç–æ—Ä–æ–Ω–∞¬ª, –∑–∞–∫–ª—é—á–∏–ª–∏ –Ω–∞—Å—Ç–æ—è—â–µ–µ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –∫ –ü—É–±–ª–∏—á–Ω–æ–π –æ—Ñ–µ—Ä—Ç–µ –æ –∑–∞–∫–ª—é—á–µ–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ –∞—Ä–µ–Ω–¥—ã —ç–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –≤ —Ä–µ–¥–∞–∫—Ü–∏–∏ –æ—Ç 29.06.2025 (–¥–∞–ª–µ–µ - –°–æ–≥–ª–∞—à–µ–Ω–∏–µ) –æ –Ω–∏–∂–µ—Å–ª–µ–¥—É—é—â–µ–º:")
        
        doc.add_heading('1. –ü—Ä–µ–¥–º–µ—Ç –°–æ–≥–ª–∞—à–µ–Ω–∏—è', level=2,).alignment = WD_ALIGN_PARAGRAPH.CENTER
        doc.add_paragraph('1.1. –ù–∞—Å—Ç–æ—è—â–µ–µ –°–æ–≥–ª–∞—à–µ–Ω–∏–µ –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ø. 2 —Å—Ç. 624 –ì—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–≥–æ –∫–æ–¥–µ–∫—Å–∞ –†–æ—Å—Å–∏–π—Å–∫–æ–π –§–µ–¥–µ—Ä–∞—Ü–∏–∏.')
        doc.add_paragraph(f"1.2. –ê—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥–∞—Ç—å –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞ –∏–º—É—â–µ—Å—Ç–≤–æ:\n–≠–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥ –º–∞—Ä–∫–∏: {bike_data.get('model', '______________________')}, VIN {bike_data.get('vin', '_________________________')}\n–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ 1 —à—Ç.")
        doc.add_paragraph("–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã:\n–ó–∞—Ä—è–¥–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–ª—è –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞ 1 —à—Ç.,\n–ü—Ä–æ—Ç–∏–≤–æ—É–≥–æ–Ω–Ω—ã–π –∑–∞–º–æ–∫ 1 —à—Ç.,\n–ë–∞–≥–∞–∂–Ω–∏–∫ 1 —à—Ç.,\n–ù–∞–±–æ—Ä –∫–ª—é—á–µ–π (2 –∫–ª—é—á–∞ + –±—Ä–µ–ª–æ–∫ —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–∏),\n–†–µ–∑–∏–Ω–∫–∞ –¥–ª—è –±–∞–≥–∞–∂–Ω–∏–∫–∞ 1 —à—Ç.,\n–ó–µ—Ä–∫–∞–ª–∞ 2 —à—Ç.,")

        # --- –í—Å—Ç–∞–≤–∫–∞ –Ω–æ–º–µ—Ä–æ–≤ –ê–ö–ë ---
        battery_nums = bike_data.get('battery_numbers', [])
        battery_count = bike_data.get('batteries_count', '_')
        if battery_nums:
            num_str = ", ".join([f"‚Ññ{num}" for num in battery_nums])
            doc.add_paragraph(f"–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä–Ω–∞—è –±–∞—Ç–∞—Ä–µ—è {battery_count} —à—Ç. ({num_str})")
        else:
            doc.add_paragraph(f"–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä–Ω–∞—è –±–∞—Ç–∞—Ä–µ—è {battery_count} —à—Ç.")
        
        doc.add_paragraph('(–¥–∞–ª–µ–µ - –ò–º—É—â–µ—Å—Ç–≤–æ), –ø—Ä–∏ —É—Å–ª–æ–≤–∏–∏ –≤–Ω–µ—Å–µ–Ω–∏—è –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä–æ–º –≤—Å–µ–π –æ–±—É—Å–ª–æ–≤–ª–µ–Ω–Ω–æ–π –Ω–∞—Å—Ç–æ—è—â–∏–º –°–æ–≥–ª–∞—à–µ–Ω–∏–µ–º –≤—ã–∫—É–ø–Ω–æ–π —Ü–µ–Ω—ã), –∞ –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–∏–Ω—è—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å —ç—Ç–æ –ò–º—É—â–µ—Å—Ç–≤–æ –≤ –ø–æ—Ä—è–¥–∫–µ –∏ –≤ —Å—Ä–æ–∫–∏, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç–æ—è—â–∏–º –°–æ–≥–ª–∞—à–µ–Ω–∏–µ–º.')
        doc.add_paragraph('1.3. –ê—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º–æ–µ –ò–º—É—â–µ—Å—Ç–≤–æ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –µ–º—É –Ω–∞ –ø—Ä–∞–≤–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏, –≤ —Å–ø–æ—Ä–µ –∏–ª–∏ –ø–æ–¥ –∞—Ä–µ—Å—Ç–æ–º –Ω–µ —Å–æ—Å—Ç–æ–∏—Ç, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–µ–¥–º–µ—Ç–æ–º –∑–∞–ª–æ–≥–∞ –∏ –Ω–µ –æ–±—Ä–µ–º–µ–Ω–µ–Ω–æ –¥—Ä—É–≥–∏–º–∏ –ø—Ä–∞–≤–∞–º–∏ —Ç—Ä–µ—Ç—å–∏—Ö –ª–∏—Ü, –∫—Ä–æ–º–µ –∑–∞–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ –º–µ–∂–¥—É –Ω–∏–º –∏ –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä–æ–º –î–æ–≥–æ–≤–æ—Ä–∞ –∞—Ä–µ–Ω–¥—ã.')
        doc.add_paragraph('1.4. –ü—Ä–∞–≤–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –Ω–∞ –ò–º—É—â–µ—Å—Ç–≤–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä—É —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ–ª–Ω–æ–π –æ–ø–ª–∞—Ç—ã –≤—ã–∫—É–ø–Ω–æ–π —Ü–µ–Ω—ã –∏ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è –°—Ç–æ—Ä–æ–Ω–∞–º–∏ –ü–µ—Ä–µ–¥–∞—Ç–æ—á–Ω–æ–≥–æ –∞–∫—Ç–∞. –ü–æ–¥–ø–∏—Å–∞–Ω–∏–µ –ü–µ—Ä–µ–¥–∞—Ç–æ—á–Ω–æ–≥–æ –∞–∫—Ç–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –ø–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –≤—Å–µ–π —Å—É–º–º—ã –≤—ã–∫—É–ø–Ω–æ–π —Ü–µ–Ω—ã. –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–æ–≤ –ò–º—É—â–µ—Å—Ç–≤–∞, –≤ —Ç–æ–º —á–∏—Å–ª–µ —Å–∫—Ä—ã—Ç—ã—Ö.')
        
        doc.add_heading('2. –í—ã–∫—É–ø–Ω–∞—è —Ü–µ–Ω–∞ –∏ –ø–æ—Ä—è–¥–æ–∫ –æ–ø–ª–∞—Ç—ã', level=2).alignment = WD_ALIGN_PARAGRAPH.CENTER
        total_price = plan_data.get('total_price', 0)
        total_price_words = num2words(int(total_price), lang='ru').capitalize()
        doc.add_paragraph(f'2.1. –í—ã–∫—É–ø–Ω–∞—è —Ü–µ–Ω–∞ –ò–º—É—â–µ—Å—Ç–≤–∞ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç {total_price:,.0f} ({total_price_words}) —Ä—É–±–ª–µ–π, –ù–î–° –Ω–µ –æ–±–ª–∞–≥–∞–µ—Ç—Å—è.'.replace(",", " "))
        
        weekly_payment = plan_data.get('weekly_payment', 0)
        weeks_count = plan_data.get('weeks_count', 0)
        weekly_payment_words = num2words(int(weekly_payment), lang='ru').capitalize()
        
        weeks_count_text = num2words(weeks_count, lang='ru')
        doc.add_paragraph(f'2.2. –û–ø–ª–∞—Ç–∞ –≤—ã–∫—É–ø–Ω–æ–π —Ü–µ–Ω—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä–æ–º –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ –≤ —Ç–µ—á–µ–Ω–∏–µ {weeks_count_text} –Ω–µ–¥–µ–ª—å —Ä–∞–≤–Ω—ã–º–∏ –ø–ª–∞—Ç–µ–∂–∞–º–∏ –ø–æ {weekly_payment:,.0f} ({weekly_payment_words}) —Ä—É–±–ª–µ–π, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º–∏ —Å–ª–µ–¥—É—é—â–∏–º –æ–±—Ä–∞–∑–æ–º:'.replace(",", " "))
        
        for i in range(1, weeks_count + 1):
            p = doc.add_paragraph(f'{i}-—è –Ω–µ–¥–µ–ª—è –º–µ—Å—è—Ü–∞: {weekly_payment:,.0f} ({weekly_payment_words}) —Ä—É–±–ª–µ–π'.replace(",", " "))
            p.paragraph_format.space_after = Pt(0)
        doc.add_paragraph(f'–ü–ª–∞—Ç–µ–∂–∏ –≤–Ω–æ—Å—è—Ç—Å—è —Å—Ç—Ä–æ–≥–æ –≤ —Ç–µ—á–µ–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–π –Ω–µ–¥–µ–ª–∏ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫-–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ). –ü—Ä–∏ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏ –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –°–æ–≥–ª–∞—à–µ–Ω–∏—è –≤–Ω–æ—Å–∏—Ç—Å—è –ø–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂ –≤ —Ä–∞–∑–º–µ—Ä–µ {weekly_payment:,.0f} ({weekly_payment_words}) —Ä—É–±–ª–µ–π.'.replace(",", " "))

        doc.add_heading('3. –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –°—Ç–æ—Ä–æ–Ω', level=2).alignment = WD_ALIGN_PARAGRAPH.CENTER
        doc.add_paragraph('3.1. –ê—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –ø–æ –Ω–∞—Å—Ç–æ—è—â–µ–º—É –°–æ–≥–ª–∞—à–µ–Ω–∏—é –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –≤—ã–∫—É–ø–Ω–æ–π —Ü–µ–Ω—ã.')
        doc.add_paragraph('3.1.1. –í —Å–ª—É—á–∞–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è —Å—Ä–æ–∫–∞ –≤–Ω–µ—Å–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –ø. 2.2. –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä –≤—ã–ø–ª–∞—á–∏–≤–∞–µ—Ç –ê—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—é –Ω–µ—É—Å—Ç–æ–π–∫—É –≤ —Ä–∞–∑–º–µ—Ä–µ 0,5% –≤—ã–∫—É–ø–Ω–æ–π —Ü–µ–Ω—ã –ò–º—É—â–µ—Å—Ç–≤–∞ –∑–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø—Ä–æ—Å—Ä–æ—á–∫–∏.')
        doc.add_paragraph('3.2. –í —Å–ª—É—á–∞—è—Ö, –Ω–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç–æ—è—â–∏–º –°–æ–≥–ª–∞—à–µ–Ω–∏–µ–º, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –°—Ç–æ—Ä–æ–Ω –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ü—É–±–ª–∏—á–Ω–æ–π –æ—Ñ–µ—Ä—Ç–æ–π –æ –∑–∞–∫–ª—é—á–µ–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ –∞—Ä–µ–Ω–¥—ã —ç–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –≤ —Ä–µ–¥–∞–∫—Ü–∏–∏ –æ—Ç 29.06.2025.')
        
        doc.add_heading('4. –ü—Ä–æ—á–∏–µ —É—Å–ª–æ–≤–∏—è', level=2).alignment = WD_ALIGN_PARAGRAPH.CENTER
        doc.add_paragraph('4.1. –ò–∑–º–µ–Ω–µ–Ω–∏—è, –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –∫ –Ω–∞—Å—Ç–æ—è—â–µ–º—É –°–æ–≥–ª–∞—à–µ–Ω–∏—é –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã —Ç–æ–ª—å–∫–æ –≤ —Ç–æ–º —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ –ø–∏—Å—å–º–µ–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ –∏ –ø–æ–¥–ø–∏—Å–∞–Ω—ã —É–ø–æ–ª–Ω–æ–º–æ—á–µ–Ω–Ω—ã–º–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è–º–∏ –°—Ç–æ—Ä–æ–Ω.')
        doc.add_paragraph('4.2. –°–ø–æ—Ä—ã –∏ —Ä–∞–∑–Ω–æ–≥–ª–∞—Å–∏—è, –≤–æ–∑–Ω–∏–∫–∞—é—â–∏–µ –≤ —Å–≤—è–∑–∏ —Å –Ω–∞—Å—Ç–æ—è—â–∏–º –°–æ–≥–ª–∞—à–µ–Ω–∏–µ–º, –°—Ç–æ—Ä–æ–Ω—ã –ø–æ—Å—Ç–∞—Ä–∞—é—Ç—Å—è —É—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞—Ç—å –ø—É—Ç–µ–º –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤.')
        doc.add_paragraph('4.3. –í —Å–ª—É—á–∞–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É—Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–æ—Ä–æ–≤ –ø—É—Ç–µ–º –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤ –æ–Ω–∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –≤ —Å—É–¥–µ–±–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º –†–æ—Å—Å–∏–π—Å–∫–æ–π –§–µ–¥–µ—Ä–∞—Ü–∏–∏.')
        p4_4_text = ('4.4. –ù–∞—Å—Ç–æ—è—â–µ–µ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ –∫ –ü—É–±–ª–∏—á–Ω–æ–π –æ—Ñ–µ—Ä—Ç–µ –æ –∑–∞–∫–ª—é—á–µ–Ω–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞ –∞—Ä–µ–Ω–¥—ã —ç–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –≤ —Ä–µ–¥–∞–∫—Ü–∏–∏ –æ—Ç 29.06.2025 –æ –≤—ã–∫—É–ø–µ –∞—Ä–µ–Ω–¥—É–µ–º–æ–≥–æ –∏–º—É—â–µ—Å—Ç–≤–∞ (–¥–∞–ª–µ–µ ‚Äì –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ) –∑–∞–∫–ª—é—á–µ–Ω–æ –°—Ç–æ—Ä–æ–Ω–∞–º–∏ –¥–∏—Å—Ç–∞–Ω—Ü–∏–æ–Ω–Ω–æ –ø—É—Ç—ë–º —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–∏—Ö –∫–æ–Ω–∫–ª—é–¥–µ–Ω—Ç–Ω—ã—Ö –¥–µ–∏—Å—Ç–≤–∏–π, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∏—Ö –Ω–∞–¥–ª–µ–∂–∞—â—É—é –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –°—Ç–æ—Ä–æ–Ω: –¥–ª—è –∑–∞–∫–ª—é—á–µ–Ω–∏—è –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç —Å–æ —Å–≤–æ–µ–≥–æ –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á—ë—Ç–∞ –Ω–∞ –±–∞–Ω–∫–æ–≤—Å–∫–∏–π —Å—á—ë—Ç –ê—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—è –¥–µ–Ω–µ–∂–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥ –≤ —Ä–∞–∑–º–µ—Ä–µ '
                     f'{weekly_payment:,.0f} ({weekly_payment_words}) —Ä—É–±–ª–µ–π. –ü–ª–∞—Ç–µ–∂ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–≤–µ—Ä—à–µ–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä–∞, —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –≤ –Ω–∞—Å—Ç–æ—è—â–µ–º –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–º —Å–æ–≥–ª–∞—à–µ–Ω–∏–∏. –í —Ü–µ–ª—è—Ö –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π (–¥–µ–π—Å—Ç–≤—É—é—â–µ–π) —Ä–µ–¥–∞–∫—Ü–∏–∏ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è –≤ —Å–ª—É—á–∞–µ –µ–≥–æ –æ–±—Å—É–∂–¥–µ–Ω–∏—è –°—Ç–æ—Ä–æ–Ω–∞–º–∏ –∫–∞–∂–¥–∞—è –Ω–æ–≤–∞—è —Ä–µ–¥–∞–∫—Ü–∏—è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è –æ–±–æ–∑–Ω–∞—á–∞–µ—Ç—Å—è –Ω–æ–≤—ã–º (—É–Ω–∏–∫–∞–ª—å–Ω—ã–º) –Ω–æ–º–µ—Ä–æ–º. –ê–∫—Ç—É–∞–ª—å–Ω–æ–π (–¥–µ–π—Å—Ç–≤—É—é—â–µ–π) —Ä–µ–¥–∞–∫—Ü–∏–µ–π –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è —è–≤–ª—è–µ—Ç—Å—è —Ä–µ–¥–∞–∫—Ü–∏—è, —É—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–∞—è –°—Ç–æ—Ä–æ–Ω–∞–º–∏ –ø–æ—Å—Ä–µ–¥—Å—Ç–≤–æ–º –æ–±–º–µ–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –ø–æ –ú–æ–±–∏–ª—å–Ω–æ–º—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é ‚Äî –ø—Ä–æ–≥—Ä–∞–º–º–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º (—Ç–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç) https://t.me/badfoxbikebot.').replace(",", " ")
        doc.add_paragraph(p4_4_text)
        
        doc.add_heading('5. –ó–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å', level=2).alignment = WD_ALIGN_PARAGRAPH.CENTER
        doc.add_paragraph('5.1. –ù–∞—Å—Ç–æ—è—â–µ–µ –°–æ–≥–ª–∞—à–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –≤ –¥–≤—É—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–∞—Ö, –∏–º–µ—é—â–∏—Ö –æ–¥–∏–Ω–∞–∫–æ–≤—É—é —é—Ä–∏–¥–∏—á–µ—Å–∫—É—é —Å–∏–ª—É, –ø–æ –æ–¥–Ω–æ–º—É —ç–∫–∑–µ–º–ø–ª—è—Ä—É –¥–ª—è –∫–∞–∂–¥–æ–π –°—Ç–æ—Ä–æ–Ω—ã.')
        
        output_filename = f"–°–æ–≥–ª–∞—à–µ–Ω–∏–µ_–æ_–≤—ã–∫—É–ø–µ_‚Ññ{booking_id}_–æ—Ç_{now.strftime('%d-%m-%Y')}.docx"

    else:
        raise ValueError(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞: {deal_type}. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 'rent' –∏–ª–∏ 'buyout'.")

    # --- –û–±—â–∞—è —á–∞—Å—Ç—å: –¢–∞–±–ª–∏—Ü–∞ —Å —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º–∏ ---
    table = doc.add_table(rows=1, cols=2)
    table.style = 'Table Grid'
    
    cell_left = table.cell(0, 0)
    cell_left.paragraphs[0].add_run('–ê—Ä–µ–Ω–¥–æ–¥–∞—Ç–µ–ª—å').bold = True
    cell_left.add_paragraph('–ö—É–∑–Ω–µ—Ü–æ–≤ –í–ª–∞–¥–∏—Å–ª–∞–≤ –ò–≥–æ—Ä–µ–≤–∏—á\n–ü–∞—Å–ø–æ—Ä—Ç —Å–µ—Ä–∏—è: 0115 ‚Ññ127738 –≤—ã–¥–∞–Ω –û—Ç–¥–µ–ª–æ–º –£–§–ú–° –†–æ—Å—Å–∏–∏ –ø–æ –ê–ª—Ç–∞–π—Å–∫–æ–º—É –∫—Ä–∞—é –≤ –≥. –°–ª–∞–≤–≥–æ—Ä–æ–¥–µ 18.11.2015\n\n–ê–¥—Ä–µ—Å: –ú–û, –≥. –ë–∞–ª–∞—à–∏—Ö–∞, –º–∫—Ä. –ñ–µ–ª–µ–∑–Ω–æ–¥–æ—Ä–æ–∂–Ω—ã–π, —É–ª. –°–æ–≤–µ—Ç—Å–∫–∞—è, –¥. 10, –∫–≤. 139.\n\n–ò–ù–ù 221004234151\n–°–ø—Ä–∞–≤–∫–∞ –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞ –ù–ü–î ‚Ññ 83338912 –æ—Ç 13.06.2025\n–ù–æ–º–µ—Ä —Å—á—ë—Ç–∞: 40817810238068834312\n–ë–∞–Ω–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è: –ü–ê–û –°–±–µ—Ä–±–∞–Ω–∫')
    cell_left.add_paragraph('\n\n_____________________/–ö—É–∑–Ω–µ—Ü–æ–≤ –í.–ò.\n(–ø–æ–¥–ø–∏—Å—å)')
    
    cell_right = table.cell(0, 1)
    cell_right.paragraphs[0].add_run('–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä').bold = True
    passport_text = (
        f"–ü–∞—Å–ø–æ—Ä—Ç —Å–µ—Ä–∏—è: {user_data.get('passport_series', '___')} ‚Ññ {user_data.get('passport_number', '_______________')}\n"
        f"–≤—ã–¥–∞–Ω {user_data.get('passport_issued_by', '_________________________________')}\n"
        f"{user_data.get('passport_issue_date', '___________________________')}"
    )
    cell_right.add_paragraph(passport_text)
    cell_right.add_paragraph(f"\n–ê–¥—Ä–µ—Å: {user_data.get('address', '_____________________________')}")
    
    last_name = user_data.get('last_name', '____________').upper()
    cell_right.add_paragraph(f"\n\n_____________________/{last_name}\n(–ø–æ–¥–ø–∏—Å—å)")

    # --- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ ---
    output_path = os.path.join(DOCUMENTS_PATH, output_filename)
    doc.save(output_path)
    return output_path

# --- –ö–æ–Ω–µ—Ü –∫–æ–¥–∞ –¥–ª—è –∑–∞–º–µ–Ω—ã ---

# –ó–∞–º–µ–Ω–∏ —Å–≤–æ—é —Å—Ç–∞—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é assign_bike_by_number –Ω–∞ —ç—Ç—É
# --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø assign_bike_by_number ---
# –ü—Ä–æ—Å—Ç–æ –∑–∞–º–µ–Ω–∏—Ç–µ –≤–∞—à—É —Å—Ç–∞—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞ —ç—Ç—É
# –ó–∞–º–µ–Ω–∏—Ç–µ –≤–∞—à—É —Å—Ç–∞—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é –Ω–∞ —ç—Ç—É
import aiosqlite  # –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç
import sqlite3    # –°—Ç–∞—Ä—ã–π –∏–º–ø–æ—Ä—Ç –º–æ–∂–Ω–æ –ø–æ–∫–∞ –æ—Å—Ç–∞–≤–∏—Ç—å –∏–ª–∏ —É–±—Ä–∞—Ç—å
import json
import os
from datetime import datetime

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ assign_bike_by_number –ù–ê –≠–¢–£

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ assign_bike_by_number –ù–ê –≠–¢–£ –ò–°–ü–†–ê–í–õ–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ assign_bike_by_number –ù–ê –≠–¢–£ –ò–°–ü–†–ê–í–õ–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –ò–°–ü–†–ê–í–õ–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ
import random # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞
import asyncio
import random
import aiosqlite
from datetime import datetime
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import ContextTypes, ConversationHandler

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ assign_bike_by_number –ù–ê –≠–¢–£

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –ò–°–ü–†–ê–í–õ–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –ò–°–ü–†–ê–í–õ–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–£–Æ –í–ï–†–°–ò–Æ
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞
import asyncio
import random
import aiosqlite
import os
import json
from datetime import datetime
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton, LabeledPrice
from telegram.ext import ContextTypes, ConversationHandler

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–£–Æ –í–ï–†–°–ò–Æ
# ### –ù–û–í–ê–Ø, –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
# ### –§–ò–ù–ê–õ–¨–ù–ê–Ø, –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø ###
# ### –ù–û–í–ê–Ø, –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
# ### –§–ò–ù–ê–õ–¨–ù–ê–Ø, –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø ###
# main.py

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã —É –≤–∞—Å –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
import aiosqlite
import json
import os
from datetime import datetime
from telegram import Update, LabeledPrice, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes, ConversationHandler

# ... (–¥—Ä—É–≥–∏–µ –≤–∞—à–∏ –∏–º–ø–æ—Ä—Ç—ã –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã)


# ### –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ assign_bike_by_number –ù–ê –≠–¢–£ –ü–û–õ–ù–£–Æ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ assign_bike_by_number –ù–ê –≠–¢–£ –ü–û–õ–ù–£–Æ –ò –ò–°–ü–†–ê–í–õ–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ

# ### –ù–û–í–ê–Ø, –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞
import aiosqlite
import json
import os
from datetime import datetime
import asyncio
import random
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton, LabeledPrice
from telegram.ext import ContextTypes, ConversationHandler


# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —ç—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏:
# DB_FILE, ADMIN_IDS, BUYOUT_PLANS, RENTAL_PRICES
# log_bike_action, add_notification
import asyncio # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
import random  # –≠—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç —Ç–æ–∂–µ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è
# –®–ê–ì 1: –í–°–¢–ê–í–¨–¢–ï –≠–¢–£ –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–£–Æ –í–ï–†–°–ò–Æ

def parse_bike_name_and_vin(full_name: str) -> dict:
    """
    "–£–º–Ω—ã–π" –ø–∞—Ä—Å–µ—Ä: –æ—Ç–¥–µ–ª—è–µ—Ç –º–æ–¥–µ–ª—å –æ—Ç VIN.
    –ü—Ä–∏–º–µ—Ä: "Wenbox U5 12345" -> {'model': 'Wenbox U5', 'vin': '12345'}
    """
    parts = full_name.strip().split(' ', 2)
    
    if len(parts) > 2:
        # –ï—Å–ª–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –±–æ–ª—å—à–µ –¥–≤—É—Ö —Å–ª–æ–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä "Liming 2-–ê–ö–ë ESM123"
        model = f"{parts[0]} {parts[1]}"
        vin = parts[2]
    elif len(parts) == 2:
        # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ª—É—á–∞–π "–ú–æ–¥–µ–ª—å VIN"
        model = parts[0]
        vin = parts[1]
    else:
        # –ï—Å–ª–∏ –ø—Ä–æ–±–µ–ª–æ–≤ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ –ø–æ–∏—Å–∫–∞ –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤
        vin_starters = ['JL', 'ESM', 'CNHC']
        model = full_name.strip()
        vin = '(–Ω–µ —É–∫–∞–∑–∞–Ω)'
        
        full_name_lower = full_name.lower()
        for prefix in vin_starters:
            prefix_lower = prefix.lower()
            if prefix_lower in full_name_lower:
                start_index = full_name_lower.find(prefix_lower)
                model = full_name[:start_index].strip()
                vin = full_name[start_index:].strip()
                if not model:
                    model = vin
                    vin = '(–Ω–µ —É–∫–∞–∑–∞–Ω)'
                break
                
    return {'model': model, 'vin': vin}
# –í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤ –≤–∞—à –∫–æ–¥, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏ assign_bike_by_number
# ### –ù–û–í–´–ô –ö–û–î: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ–± –æ–ø–ª–∞—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º ###
async def send_admin_payment_notification(context: ContextTypes.DEFAULT_TYPE, user_name: str, amount: int, description: str, bike_name: str | None = None, owner_name: str | None = None):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —É—Å–ø–µ—à–Ω–æ–º –ø–ª–∞—Ç–µ–∂–µ –≤—Å–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º,
    –≤–∫–ª—é—á–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–µ –∏ –µ–≥–æ –≤–ª–∞–¥–µ–ª—å—Ü–µ.
    """
    user_name_escaped = escape_markdown(user_name, version=2)
    amount_escaped = escape_markdown(str(amount), version=2)
    description_escaped = escape_markdown(description, version=2)

    message_parts = [
        f"‚úÖ *–£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞*",
        f"üë§ *–ö–ª–∏–µ–Ω—Ç:* {user_name_escaped}",
        f"üí∞ *–°—É–º–º–∞:* {amount_escaped} ‚ÇΩ",
        f"üìù *–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:* {description_escaped}"
    ]

    if bike_name:
        parsed_bike = parse_bike_name_and_vin(bike_name)
        bike_info_str = f"üö≤ *–í–µ–ª–æ—Å–∏–ø–µ–¥:* {escape_markdown(parsed_bike['model'], 2)} \\({escape_markdown(parsed_bike['vin'], 2)}\\)"
        
        owner_display_name = "–ù–∞—à"
        if owner_name and owner_name != "–ö–æ–º–ø–∞–Ω–∏—è":
            owner_display_name = escape_markdown(owner_name, 2)
        
        owner_info_str = f"üè¢ *–í–ª–∞–¥–µ–ª–µ—Ü:* {owner_display_name}"
        
        message_parts.extend(["", bike_info_str, owner_info_str])

    final_message = "\n".join(message_parts)

    for admin_id in ADMIN_IDS:
        try:
            await context.bot.send_message(
                chat_id=admin_id,
                text=final_message,
                parse_mode="MarkdownV2"
            )
        except Exception as e:
            logging.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ–ø–ª–∞—Ç–µ –∞–¥–º–∏–Ω—É {admin_id}: {e}")


async def _get_bike_and_owner_info(conn: aiosqlite.Connection, bike_id: int) -> tuple[str | None, str | None]:
    """–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –∏ –µ–≥–æ –≤–ª–∞–¥–µ–ª—å—Ü–∞."""
    if not bike_id:
        return None, None
    cursor = await conn.execute(
        """SELECT b.name, u.first_name, u.last_name 
           FROM bikes b 
           LEFT JOIN users u ON b.investor_id = u.id 
           WHERE b.id = ?""",
        (bike_id,)
    )
    data = await cursor.fetchone()
    if not data:
        return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≤–µ–ª–æ—Å–∏–ø–µ–¥", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"
    
    bike_name = data['name']
    owner_name = "–ö–æ–º–ø–∞–Ω–∏—è"
    if data['first_name']:
        owner_name = f"{data['first_name']} {data['last_name'] or ''}".strip()
    
    return bike_name, owner_name
async def animate_payment_message(context: ContextTypes.DEFAULT_TYPE, payment_id: str):
    """
    –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∞–Ω–∏–º–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ–ø–ª–∞—Ç–æ–π, —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏ –º–µ–Ω—è—è —ç–º–æ–¥–∑–∏.
    –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ —Å–æ–±—ã—Ç–∏–µ stop_animation_event –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.
    """
    try:
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞
        payment_data = context.bot_data['pending_payments'].get(payment_id)
        if not payment_data:
            logging.warning(f"–ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è payment_id {payment_id} –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω–∞: –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")
            return

        chat_id = payment_data['user_id']
        message_id = payment_data['animated_message_id']
        animation_sequence = payment_data['animation_sequence']
        stop_event = payment_data['stop_animation_event']
        amount = payment_data['amount']

        # –ò–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–¥—Ä–∞ –∞–Ω–∏–º–∞—Ü–∏–∏
        frame_index = 0

        # –¶–∏–∫–ª —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–∫–∞ –Ω–µ –±—É–¥–µ—Ç –ø–æ–¥–∞–Ω —Å–∏–≥–Ω–∞–ª –∫ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
        while not stop_event.is_set():
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä (–Ω–∞–±–æ—Ä —ç–º–æ–¥–∑–∏) –∏ —Å–∫–ª–µ–∏–≤–∞–µ–º –≤ —Å—Ç—Ä–æ–∫—É
            current_frame_emojis = animation_sequence[frame_index]
            animation_text = " ".join(current_frame_emojis)

            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            message_text = f"–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã {amount} ‚ÇΩ\n\n{animation_text}"

            try:
                # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤—ã–π –∫–∞–¥—Ä
                await context.bot.edit_message_text(
                    chat_id=chat_id,
                    message_id=message_id,
                    text=message_text,
                    reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å", url=payment_data['url'])]])
                )
            except Exception as e:
                # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ (—É–¥–∞–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º), –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                logging.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ {message_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –æ—Å—Ç–∞–Ω–æ–≤–∫–∞. –û—à–∏–±–∫–∞: {e}")
                stop_event.set()
                break

            # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä, –∑–∞—Ü–∏–∫–ª–∏–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—é
            frame_index = (frame_index + 1) % len(animation_sequence)

            # –ü–∞—É–∑–∞ –º–µ–∂–¥—É –∫–∞–¥—Ä–∞–º–∏
            await asyncio.sleep(1.2) # 1.2 —Å–µ–∫—É–Ω–¥—ã

    except Exception as e:
        logging.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è payment_id {payment_id}: {e}", exc_info=True)
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ process_yookassa_success –ù–ê –≠–¢–£ –ù–û–í–£–Æ –í–ï–†–°–ò–Æ
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞
import logging
import sqlite3
from datetime import datetime, timedelta
from telegram import Update
from telegram.ext import ContextTypes

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ process_yookassa_success –ù–ê –≠–¢–£

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞
import logging
import sqlite3
from datetime import datetime, timedelta
from telegram import Update
from telegram.ext import ContextTypes

# --- –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ---

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –ê–°–ò–ù–•–†–û–ù–ù–£–Æ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –ê–°–ò–ù–•–†–û–ù–ù–£–Æ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –ü–û–õ–ù–û–°–¢–¨–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –ò–°–ü–†–ê–í–õ–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
# ### –ù–û–í–ê–Ø, –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
# ### –ù–û–í–ê–Ø, –ü–û–õ–ù–û–°–¢–¨–Æ –ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ process_successful_payment –ù–ê –≠–¢–£ –ü–û–õ–ù–û–°–¢–¨–Æ

import aiosqlite # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
# =============================================================================
# –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –£–°–ü–ï–®–ù–´–• –ü–õ–ê–¢–ï–ñ–ï–ô (–ó–ê–ú–ï–ù–ò–¢–ï –í–°–ï –°–¢–ê–†–´–ï –í–ï–†–°–ò–ò)
# =============================================================================
import aiosqlite
from datetime import datetime, timedelta

# =============================================================================
# –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –£–°–ü–ï–®–ù–´–• –ü–õ–ê–¢–ï–ñ–ï–ô (–ó–ê–ú–ï–ù–ò–¢–ï –í–°–ï –°–¢–ê–†–´–ï –í–ï–†–°–ò–ò)
# =============================================================================

# ### –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: process_successful_payment —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ ###

# ### –ü–û–õ–ù–ê–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø process_successful_payment ###

async def _get_bike_and_owner_info(conn, bike_id):
    """–ü–æ–ª—É—á–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –∏ –∏–º—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø–æ bike_id"""
    cursor = await conn.execute("""
        SELECT b.name as bike_name, 
               COALESCE(u.first_name || ' ' || u.last_name, u.username, '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü') as owner_name 
        FROM bikes b 
        LEFT JOIN users u ON b.owner_id = u.id 
        WHERE b.id = ?
    """, (bike_id,))
    result = await cursor.fetchone()
    if result:
        return result['bike_name'], result['owner_name']
    return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≤–µ–ª–æ—Å–∏–ø–µ–¥", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü"


import json
import time
from uuid import uuid4
from datetime import datetime, timedelta

import json
import time
from uuid import uuid4
from datetime import datetime, timedelta

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–ù–û–í–´–ï / –ò–ó–ú–ï–ù–Å–ù–ù–´–ï)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async def _is_unlimited_battery(conn, bike_id: int) -> bool:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä —Å –¥–∞–Ω–Ω—ã–º bike_id –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π (is_unlimited=1).
    –î–ª—è —Ç–∞–∫–∏—Ö –ê–ö–ë –º—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –º–µ–Ω—è–µ–º available/owner_id, —á—Ç–æ–±—ã –æ–Ω–∏ –≤—Å–µ–≥–¥–∞ –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ.
    """
    cur = await conn.execute("SELECT is_unlimited FROM bikes WHERE id=?", (bike_id,))
    row = await cur.fetchone()
    return bool(row and row["is_unlimited"])

def _battery_model_from_name(name: str) -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–æ–¥–µ–ª—å –ê–ö–ë –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é ('60V21Ah' –∏–ª–∏ '60V30Ah')."""
    return "60V21Ah" if "60V21Ah" in name else "60V30Ah"


# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –° –ü–û–î–†–û–ë–ù–´–ú –õ–û–ì–ò–†–û–í–ê–ù–ò–ï–ú –ò –ü–û–î–î–ï–†–ñ–ö–û–ô –ê–ö–ë-–ë–ï–ó–õ–ò–ú–ò–¢
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

async def process_successful_payment(
    context: ContextTypes.DEFAULT_TYPE,
    user_id: int,
    payload: str,
    amount_rub: int,
    discount_id_to_use: int | None = None,
    update: Update | None = None,
):
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –í–°–ï–• —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π:
    - –∞—Ä–µ–Ω–¥–∞/–≤—ã–∫—É–ø –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ –∏ –ê–ö–ë (–≤ —Ç.—á. –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã—Ö –¥–æ–ø –ê–ö–ë),
    - –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –≤–∑–Ω–æ—Å—ã/–¥–æ—Å—Ä–æ—á–Ω–æ–µ –ø–æ–≥–∞—à–µ–Ω–∏–µ,
    - –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã,
    - —Ä–µ–º–æ–Ω—Ç/—à—Ç—Ä–∞—Ñ—ã.
    –í–µ–∑–¥–µ –µ—Å—Ç—å commit(); –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏: –∫–µ–π—Å, —Å–Ω–∞–ø—à–æ—Ç—ã –¥–æ/–ø–æ—Å–ª–µ, –≤—ã—á–∏—Å–ª–µ–Ω–Ω—ã–µ –¥–∞—Ç—ã, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
    """

    pay_evt_id = str(uuid4())[:8]  # –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–π id –¥–ª—è –≤—Å–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
    t0 = time.time()

    def _log(level: str, msg: str, **kv):
        lvl = getattr(logging, level.upper(), logging.INFO)
        base = {
            "pay_evt_id": pay_evt_id,
            "user_id": user_id,
            "payload": payload,
            "amount_rub": amount_rub,
        }
        base.update(kv)
        logging.log(lvl, f"[pay={pay_evt_id}] {msg} :: {json.dumps(base, ensure_ascii=False, default=str)}")

    async def _fetch_one_dict(conn, query, params=()):
        cur = await conn.execute(query, params)
        row = await cur.fetchone()
        return dict(row) if row else None

    async def _snapshot(conn, table: str, id_field: str, id_value, columns: list[str] | None = None):
        cols = ", ".join(columns) if columns else "*"
        return await _fetch_one_dict(conn, f"SELECT {cols} FROM {table} WHERE {id_field}=?", (id_value,))

    async def send_response(text: str, **kwargs):
        try:
            if update and update.effective_message:
                await update.effective_message.reply_text(text, **kwargs)
            else:
                await context.bot.send_message(chat_id=user_id, text=text, **kwargs)
            _log("info", "message_to_user_sent", text=text)
        except Exception as e:
            _log("error", "message_to_user_failed", error=str(e), text=text)

    conn = None
    _log("info", "payment_processing_start")

    try:
        async with aiosqlite.connect(DB_FILE, timeout=20) as conn:
            conn.row_factory = aiosqlite.Row
            await conn.execute("BEGIN")
            _log("debug", "tx_begin")

            # 0) –°–∫–∏–¥–∫–∞ (–µ—Å–ª–∏ –±—ã–ª–∞)
            if discount_id_to_use:
                before = await _snapshot(conn, "discounts", "id", discount_id_to_use, ["id", "is_used"])
                await conn.execute("UPDATE discounts SET is_used=1 WHERE id=?", (discount_id_to_use,))
                after = await _snapshot(conn, "discounts", "id", discount_id_to_use, ["id", "is_used"])
                _log("info", "discount_consumed", before=before, after=after)

            user_name_formatted = await get_user_info_for_notification(user_id, conn)
            _log("debug", "loaded_user_for_notifications", user_name=user_name_formatted)

            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            # –ö–ï–ô–°–´
            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

            # 1) –ê—Ä–µ–Ω–¥–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞
            if payload.startswith("rental_payment_"):
                case = "rental_payment_bike"
                booking_id = int(payload.split("_")[2])
                _log("info", "case_detected", case=case, booking_id=booking_id)

                before_booking = await _snapshot(conn, "bookings", "id", booking_id)
                await conn.execute("UPDATE bookings SET status='rented' WHERE id=?", (booking_id,))
                after_booking = await _snapshot(conn, "bookings", "id", booking_id)

                cur = await conn.execute("SELECT bike_id FROM bookings WHERE id=?", (booking_id,))
                bike_id = (await cur.fetchone())["bike_id"]

                before_bike = await _snapshot(conn, "bikes", "id", bike_id, ["id", "available", "owner_id", "name"])
                # –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã –ù–ï –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ ‚Üí –¥–µ–ª–∞–µ–º –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º
                await conn.execute("UPDATE bikes SET available=0 WHERE id=?", (bike_id,))
                after_bike = await _snapshot(conn, "bikes", "id", bike_id, ["id", "available", "owner_id", "name"])

                bike_name, owner_name = await _get_bike_and_owner_info(conn, bike_id)
                await log_bike_action(conn, bike_id, user_id, "–û–ø–ª–∞—Ç–∞ –∞—Ä–µ–Ω–¥—ã", f"–ó–∞—è–≤–∫–∞ #{booking_id}", amount=amount_rub)

                await conn.commit()
                _log("info", "tx_commit", case=case,
                     booking_before=before_booking, booking_after=after_booking,
                     bike_before=before_bike, bike_after=after_bike)

                await send_response(f"‚úÖ –û–ø–ª–∞—Ç–∞ –∑–∞ –∞—Ä–µ–Ω–¥—É –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ ¬´{bike_name}¬ª –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!")
                try:
                    await send_admin_payment_notification(context, user_name_formatted, amount_rub, "–ê—Ä–µ–Ω–¥–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞",
                                                         bike_name=bike_name, owner_name=owner_name)
                except Exception as e:
                    _log("error", "admin_notification_failed", case=case, error=str(e))

            # 2) –í—ã–∫—É–ø –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ (–ø–µ—Ä–≤—ã–π –≤–∑–Ω–æ—Å)
            elif payload.startswith("buyout_payment_"):
                case = "buyout_bike_first"
                booking_id = int(payload.split("_")[2])
                _log("info", "case_detected", case=case, booking_id=booking_id)

                row = await _fetch_one_dict(conn, """
                    SELECT b.bike_id, bk.name AS bike_name, bk.buyout_period_days,
                           bk.buyout_total_payments, bk.buyout_payment_amount
                    FROM bookings b JOIN bikes bk ON b.bike_id=bk.id WHERE b.id=?
                """, (booking_id,))
                if not row:
                    raise ValueError(f"–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å–¥–µ–ª–∫–∞ #{booking_id}")
                bike_id = row["bike_id"]
                bike_name = row["bike_name"]
                period_days = int(row["buyout_period_days"] or 0)
                if period_days <= 0:
                    raise ValueError(f"–î–ª—è ¬´{bike_name}¬ª –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø–ª–∞–Ω –≤—ã–∫—É–ø–∞.")
                next_date = (datetime.now() + timedelta(days=period_days)).strftime("%d.%m.%Y")

                before_booking = await _snapshot(conn, "bookings", "id", booking_id)
                await conn.execute(
                    "UPDATE bookings SET status='rented', payments_made=1, next_payment_date=? WHERE id=?",
                    (next_date, booking_id),
                )
                after_booking = await _snapshot(conn, "bookings", "id", booking_id)

                before_bike = await _snapshot(conn, "bikes", "id", bike_id, ["id", "available"])
                await conn.execute("UPDATE bikes SET available=0 WHERE id=?", (bike_id,))
                after_bike = await _snapshot(conn, "bikes", "id", bike_id, ["id", "available"])

                await log_bike_action(
                    conn, bike_id, user_id, "–í—ã–∫—É–ø (1-–π –≤–∑–Ω–æ—Å)",
                    f"–ü–ª–∞–Ω: {row['buyout_total_payments']} –ø–ª. –ø–æ {row['buyout_payment_amount']} ‚ÇΩ",
                    amount=amount_rub
                )

                await conn.commit()
                _log("info", "tx_commit", case=case,
                     booking_before=before_booking, booking_after=after_booking,
                     bike_before=before_bike, bike_after=after_bike,
                     next_payment_date=next_date)

                _, owner_name = await _get_bike_and_owner_info(conn, bike_id)
                await send_response(f"‚úÖ –ü–µ—Ä–≤—ã–π –≤–∑–Ω–æ—Å –∑–∞ –≤—ã–∫—É–ø ¬´{bike_name}¬ª –ø—Ä–∏–Ω—è—Ç! –°–ª–µ–¥—É—é—â–∏–π –ø–ª–∞—Ç–µ–∂ –¥–æ {next_date}.")
                try:
                    await send_admin_payment_notification(context, user_name_formatted, amount_rub, "–ü–µ—Ä–≤—ã–π –≤–∑–Ω–æ—Å –∑–∞ –≤—ã–∫—É–ø",
                                                         bike_name=bike_name, owner_name=owner_name)
                except Exception as e:
                    _log("error", "admin_notification_failed", case=case, error=str(e))

            # 3) –ë—ã—Å—Ç—Ä–∞—è –∞—Ä–µ–Ω–¥–∞ –¥–æ–ø. –ê–ö–ë (7 –¥–Ω–µ–π, –±–µ–∑–ª–∏–º–∏—Ç –ø–æ–¥–¥–µ—Ä–∂–∞–Ω)
            elif payload.startswith("quick_rent_akb_"):
                case = "quick_rent_akb"
                product_id = int(payload.split("_")[3])
                _log("info", "case_detected", case=case, product_id=product_id)

                cur = await conn.execute("SELECT name FROM bikes WHERE id=?", (product_id,))
                name = (await cur.fetchone())["name"]

                start = datetime.now()
                end = start + timedelta(days=7)
                await conn.execute(
                    "INSERT INTO bookings (user_id, bike_id, booking_date, end_date, status, booking_type) "
                    "VALUES (?, ?, ?, ?, 'rented', 'rent')",
                    (user_id, product_id, start.strftime("%d.%m.%Y"), end.strftime("%d.%m.%Y")),
                )

                # –µ—Å–ª–∏ —ç—Ç–æ –ù–ï –±–µ–∑–ª–∏–º–∏—Ç–Ω–∞—è –ê–ö–ë ‚Äî –¥–µ–ª–∞–µ–º –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–π
                if not await _is_unlimited_battery(conn, product_id):
                    before_bike = await _snapshot(conn, "bikes", "id", product_id, ["id", "available"])
                    await conn.execute("UPDATE bikes SET available=0 WHERE id=?", (product_id,))
                    after_bike = await _snapshot(conn, "bikes", "id", product_id, ["id", "available"])
                else:
                    before_bike = after_bike = await _snapshot(conn, "bikes", "id", product_id, ["id", "available", "is_unlimited"])

                await log_bike_action(conn, product_id, user_id, "–ê—Ä–µ–Ω–¥–∞ –¥–æ–ø. –ê–ö–ë", "–°—Ä–æ–∫: 7 –¥–Ω–µ–π", amount=amount_rub)
                await conn.commit()
                _log("info", "tx_commit", case=case,
                     bike_before=before_bike, bike_after=after_bike,
                     rental_period={"from": start.strftime("%d.%m.%Y"), "to": end.strftime("%d.%m.%Y")})

                await send_response(f"‚úÖ –ê—Ä–µ–Ω–¥–∞ ¬´{name}¬ª –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞ –¥–æ {end.strftime('%d.%m.%Y')}!")
                try:
                    await send_admin_payment_notification(context, user_name_formatted, amount_rub, f"–ê—Ä–µ–Ω–¥–∞ –¥–æ–ø. –ê–ö–ë ¬´{name}¬ª")
                except Exception as e:
                    _log("error", "admin_notification_failed", case=case, error=str(e))

            # 4) –ê—Ä–µ–Ω–¥–∞ –ê–ö–ë (–ø–æ –ø—Ä–∞–π—Å—É, –±–µ–∑–ª–∏–º–∏—Ç –ø–æ–¥–¥–µ—Ä–∂–∞–Ω)
            elif payload.startswith("rent_battery_"):
                case = "rent_battery"
                product_id = int(payload.split("_")[2])
                _log("info", "case_detected", case=case, product_id=product_id)

                cur = await conn.execute("SELECT name FROM bikes WHERE id=?", (product_id,))
                name = (await cur.fetchone())["name"]
                model = _battery_model_from_name(name)
                plan = BATTERY_RENTAL_PRICES.get(model)
                start = datetime.now()
                end = start + timedelta(days=int(plan["initial_months"]) * 30)

                await conn.execute(
                    "INSERT INTO bookings (user_id, bike_id, booking_date, end_date, status, booking_type) "
                    "VALUES (?, ?, ?, ?, 'rented', 'rent')",
                    (user_id, product_id, start.strftime("%d.%m.%Y"), end.strftime("%d.%m.%Y")),
                )

                # –µ—Å–ª–∏ –ù–ï –±–µ–∑–ª–∏–º–∏—Ç ‚Äî –¥–µ–ª–∞–µ–º –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–π; –∏–Ω–∞—á–µ —Ç–æ–ª—å–∫–æ –≤—ã—Å—Ç–∞–≤–∏–º type='battery'
                if not await _is_unlimited_battery(conn, product_id):
                    before_bike = await _snapshot(conn, "bikes", "id", product_id, ["id", "available", "type"])
                    await conn.execute("UPDATE bikes SET available=0, type='battery' WHERE id=?", (product_id,))
                    after_bike = await _snapshot(conn, "bikes", "id", product_id, ["id", "available", "type"])
                else:
                    before_bike = await _snapshot(conn, "bikes", "id", product_id, ["id", "available", "type"])
                    await conn.execute("UPDATE bikes SET type='battery' WHERE id=?", (product_id,))
                    after_bike = await _snapshot(conn, "bikes", "id", product_id, ["id", "available", "type"])

                await log_bike_action(conn, product_id, user_id, "–ê—Ä–µ–Ω–¥–∞ –ê–ö–ë", "–ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç–µ–∂", amount=amount_rub)
                await conn.commit()
                _log("info", "tx_commit", case=case, bike_before=before_bike, bike_after=after_bike)

                await send_response(f"‚úÖ –ê—Ä–µ–Ω–¥–∞ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞ ¬´{name}¬ª –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞ –¥–æ {end.strftime('%d.%m.%Y')}!")
                try:
                    await send_admin_payment_notification(context, user_name_formatted, amount_rub, f"–ê—Ä–µ–Ω–¥–∞ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞ ¬´{name}¬ª")
                except Exception as e:
                    _log("error", "admin_notification_failed", case=case, error=str(e))

            # 5) –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã (–ª—é–±–æ–π —Ç–æ–≤–∞—Ä)
            elif payload.startswith("prolong_"):
                case = "prolong"
                _, booking_id_str, add_days_str = payload.split("_")
                booking_id, add_days = int(booking_id_str), int(add_days_str)
                _log("info", "case_detected", case=case, booking_id=booking_id, add_days=add_days)

                info = await _fetch_one_dict(conn, "SELECT end_date, bike_id FROM bookings WHERE id=?", (booking_id,))
                cur_end = datetime.strptime(info["end_date"], "%d.%m.%Y")
                new_end = (cur_end + timedelta(days=add_days)).strftime("%d.%m.%Y")

                before_booking = await _snapshot(conn, "bookings", "id", booking_id, ["id", "end_date"])
                await conn.execute("UPDATE bookings SET end_date=? WHERE id=?", (new_end, booking_id))
                after_booking = await _snapshot(conn, "bookings", "id", booking_id, ["id", "end_date"])

                bike_name, owner_name = await _get_bike_and_owner_info(conn, info["bike_id"])
                await log_bike_action(conn, info["bike_id"], user_id, "–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã", f"–°—Ä–æ–∫ +{add_days} –¥–Ω–µ–π", amount=amount_rub)
                await conn.commit()
                _log("info", "tx_commit", case=case, booking_before=before_booking, booking_after=after_booking)

                await send_response(f"‚úÖ –ê—Ä–µ–Ω–¥–∞ –ø—Ä–æ–¥–ª–µ–Ω–∞ –¥–æ {new_end}!")
                try:
                    await send_admin_payment_notification(context, user_name_formatted, amount_rub, f"–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã –Ω–∞ {add_days} –¥–Ω.",
                                                         bike_name=bike_name, owner_name=owner_name)
                except Exception as e:
                    _log("error", "admin_notification_failed", case=case, error=str(e))

            # 6) –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Å–¥–µ–ª–∫–∞
            elif payload.startswith("custom_payment_"):
                case = "custom_payment"
                booking_id = int(payload.split("_")[2])
                _log("info", "case_detected", case=case, booking_id=booking_id)

                row = await _fetch_one_dict(conn, "SELECT bike_id FROM bookings WHERE id=?", (booking_id,))
                bike_id = row["bike_id"]

                before_booking = await _snapshot(conn, "bookings", "id", booking_id, ["id", "status"])
                await conn.execute("UPDATE bookings SET status='rented' WHERE id=?", (booking_id,))
                after_booking = await _snapshot(conn, "bookings", "id", booking_id, ["id", "status"])

                # –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Å–¥–µ–ª–∫–∏ ‚Äî –ø–æ —Ñ–∞–∫—Ç—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç (–Ω–µ –±–µ–∑–ª–∏–º–∏—Ç)
                before_bike = await _snapshot(conn, "bikes", "id", bike_id, ["id", "available"])
                await conn.execute("UPDATE bikes SET available=0 WHERE id=?", (bike_id,))
                after_bike = await _snapshot(conn, "bikes", "id", bike_id, ["id", "available"])

                cur = await conn.execute("SELECT name FROM bikes WHERE id=?", (bike_id,))
                bike_name = (await cur.fetchone())["name"]

                await log_bike_action(conn, bike_id, user_id, "–û–ø–ª–∞—Ç–∞ (–∏–Ω–¥–∏–≤–∏–¥.)", f"–ó–∞—è–≤–∫–∞ #{booking_id}", amount=amount_rub)
                await conn.commit()
                _log("info", "tx_commit", case=case,
                     booking_before=before_booking, booking_after=after_booking,
                     bike_before=before_bike, bike_after=after_bike, bike_name=bike_name)

                await send_response(f"‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π —Å–¥–µ–ª–∫–µ –∑–∞ ¬´{bike_name}¬ª –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!")
                try:
                    await send_admin_payment_notification(context, user_name_formatted, amount_rub, f"–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Å–¥–µ–ª–∫–∞ ¬´{bike_name}¬ª")
                except Exception as e:
                    _log("error", "admin_notification_failed", case=case, error=str(e))

            # 7) –í—ã–∫—É–ø –ê–ö–ë (–ø–µ—Ä–≤—ã–π –≤–∑–Ω–æ—Å) ‚Äî —Ñ–∏–∫—Å–∏—Ä—É–µ–º –ø–ª–∞–Ω –≤ bikes, –Ω–æ –±–µ–∑–ª–∏–º–∏—Ç –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –ø–æ available/owner
            elif payload.startswith("buyout_battery_"):
                case = "buyout_battery_first"
                parts = payload.split("_")
                product_id = int(parts[2])
                plan_key = "_".join(parts[3:-1])
                _log("info", "case_detected", case=case, product_id=product_id, plan_key=plan_key)

                cur = await conn.execute("SELECT name FROM bikes WHERE id=?", (product_id,))
                name = (await cur.fetchone())["name"]
                model = _battery_model_from_name(name)
                plan = BATTERY_BUYOUT_PLANS[model]["plans"][plan_key]  # keys: payment, count, period_days

                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–ª–∞–Ω –Ω–∞ —Å–∞–º–æ–π –ê–ö–ë (–¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ JOIN –≤ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –ø–ª–∞—Ç–µ–∂–∞—Ö)
                # available —Å—Ç–∞–≤–∏–º 0 –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –Ω–µ –±–µ–∑–ª–∏–º–∏—Ç.
                before_bike = await _snapshot(conn, "bikes", "id", product_id,
                                              ["id", "type", "available", "is_unlimited",
                                               "buyout_total_payments", "buyout_payment_amount", "buyout_period_days"])

                await conn.execute("""
                  UPDATE bikes
                  SET type='battery',
                      buyout_total_payments=?,
                      buyout_payment_amount=?,
                      buyout_period_days=?,
                      available=CASE WHEN is_unlimited=1 THEN available ELSE 0 END
                  WHERE id=?""",
                  (int(plan["count"]), int(plan["payment"]), int(plan["period_days"]), product_id)
                )

                after_bike = await _snapshot(conn, "bikes", "id", product_id,
                                             ["id", "type", "available", "is_unlimited",
                                              "buyout_total_payments", "buyout_payment_amount", "buyout_period_days"])

                start = datetime.now()
                next_date = (start + timedelta(days=int(plan["period_days"]))).strftime("%d.%m.%Y")
                await conn.execute(
                    "INSERT INTO bookings (user_id, bike_id, booking_date, status, booking_type, payment_plan_key, payments_made, next_payment_date) "
                    "VALUES (?, ?, ?, 'rented', 'buyout', ?, 1, ?)",
                    (user_id, product_id, start.strftime("%d.%m.%Y"), plan_key, next_date),
                )

                await log_bike_action(conn, product_id, user_id, "–í—ã–∫—É–ø –ê–ö–ë (1-–π –≤–∑–Ω–æ—Å)", f"–ü–ª–∞–Ω: {plan['label']}", amount=amount_rub)
                await conn.commit()
                _log("info", "tx_commit", case=case, bike_before=before_bike, bike_after=after_bike, next_payment_date=next_date)

                await send_response(f"‚úÖ –†–∞—Å—Å—Ä–æ—á–∫–∞ –Ω–∞ –ê–ö–ë ¬´{name}¬ª –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞! –°–ª–µ–¥—É—é—â–∏–π –ø–ª–∞—Ç–µ–∂ –¥–æ {next_date}.")
                try:
                    await send_admin_payment_notification(context, user_name_formatted, amount_rub, f"–ü–µ—Ä–≤—ã–π –≤–∑–Ω–æ—Å –ø–æ –ê–ö–ë ¬´{name}¬ª")
                except Exception as e:
                    _log("error", "admin_notification_failed", case=case, error=str(e))

            # 8) –û–ø–ª–∞—Ç–∞ —Ä–µ–º–æ–Ω—Ç–∞
            elif payload.startswith("repair_payment_"):
                case = "repair_payment"
                request_id = int(payload.split("_")[2])
                _log("info", "case_detected", case=case, request_id=request_id)

                before = await _snapshot(conn, "repair_requests", "id", request_id, ["id", "status"])
                await conn.execute("UPDATE repair_requests SET status='oplacheno' WHERE id=?", (request_id,))
                after = await _snapshot(conn, "repair_requests", "id", request_id, ["id", "status"])

                cur = await conn.execute(
                    "SELECT rr.bike_id, b.name AS bike_name FROM repair_requests rr JOIN bikes b ON rr.bike_id=b.id WHERE rr.id=?",
                    (request_id,),
                )
                r = await cur.fetchone()
                bike_id = r["bike_id"] if r else None
                bike_name = r["bike_name"] if r else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

                await log_bike_action(conn, bike_id, user_id, "–û–ø–ª–∞—Ç–∞ —Ä–µ–º–æ–Ω—Ç–∞", f"–ó–∞—è–≤–∫–∞ #{request_id}", amount=amount_rub)
                await conn.commit()
                _log("info", "tx_commit", case=case, request_before=before, request_after=after, bike_id=bike_id)

                await send_response(f"‚úÖ –û–ø–ª–∞—Ç–∞ –∑–∞ —Ä–µ–º–æ–Ω—Ç (–∑–∞—è–≤–∫–∞ #{request_id}) –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!")
                try:
                    await send_admin_payment_notification(context, user_name_formatted, amount_rub, f"–û–ø–ª–∞—Ç–∞ —Ä–µ–º–æ–Ω—Ç–∞ ¬´{bike_name}¬ª (–∑–∞—è–≤–∫–∞ #{request_id})")
                except Exception as e:
                    _log("error", "admin_notification_failed", case=case, error=str(e))

            # 9) –û–ø–ª–∞—Ç–∞ —à—Ç—Ä–∞—Ñ–∞
            elif payload.startswith("fine_"):
                case = "fine_payment"
                fine_id = int(payload.split("_")[1])
                _log("info", "case_detected", case=case, fine_id=fine_id)

                payment_date = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                before = await _snapshot(conn, "fines", "id", fine_id, ["id", "status", "payment_date"])
                await conn.execute("UPDATE fines SET status='paid', payment_date=? WHERE id=?", (payment_date, fine_id))
                after = await _snapshot(conn, "fines", "id", fine_id, ["id", "status", "payment_date"])

                await log_bike_action(conn, None, user_id, "–û–ø–ª–∞—Ç–∞ —à—Ç—Ä–∞—Ñ–∞", f"–û–ø–ª–∞—á–µ–Ω —à—Ç—Ä–∞—Ñ #{fine_id}", amount=amount_rub)
                await conn.commit()
                _log("info", "tx_commit", case=case, fine_before=before, fine_after=after)

                await send_response(f"‚úÖ –®—Ç—Ä–∞—Ñ #{fine_id} –æ–ø–ª–∞—á–µ–Ω.")
                try:
                    await send_admin_payment_notification(context, user_name_formatted, amount_rub, f"–û–ø–ª–∞—Ç–∞ —à—Ç—Ä–∞—Ñ–∞ #{fine_id}")
                except Exception as e:
                    _log("error", "admin_notification_failed", case=case, error=str(e))

            # 10) –°–ª–µ–¥—É—é—â–∏–π –≤–∑–Ω–æ—Å / –ü–æ–ª–Ω—ã–π –≤—ã–∫—É–ø (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ –¥–ª—è –≤–µ–ª–æ –∏ –ê–ö–ë; —É—á–∏—Ç—ã–≤–∞–µ—Ç –±–µ–∑–ª–∏–º–∏—Ç)
            elif payload.startswith("installment_") or payload.startswith("full_buyout_"):
                is_full_buyout = payload.startswith("full_buyout_")
                case = "full_buyout" if is_full_buyout else "installment"
                booking_id = int(payload.split("_")[2 if is_full_buyout else 1])
                _log("info", "case_detected", case=case, booking_id=booking_id)

                d = await _fetch_one_dict(conn, """
                    SELECT b.bike_id, IFNULL(b.payments_made, 0) AS payments_made,
                           bk.name AS item_name, bk.type AS item_type, bk.is_unlimited,
                           bk.buyout_total_payments, bk.buyout_payment_amount, bk.buyout_period_days
                    FROM bookings b JOIN bikes bk ON b.bike_id=bk.id
                    WHERE b.id=?
                """, (booking_id,))
                if not d:
                    raise ValueError("–ó–∞–ø–∏—Å—å –æ —Ä–∞—Å—Å—Ä–æ—á–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")

                bike_id = d["bike_id"]
                payments_made = int(d["payments_made"] or 0)
                total_payments = int(d["buyout_total_payments"] or 0)
                period_days = int(d["buyout_period_days"] or 0)
                item_name = d["item_name"]
                plan_type_str = "–í–µ–ª–æ—Å–∏–ø–µ–¥" if d["item_type"] == "bike" else "–ê–ö–ë"
                is_unlimited = bool(d["is_unlimited"])

                if not (total_payments and period_days):
                    raise ValueError(f"–î–ª—è —Ç–æ–≤–∞—Ä–∞ ¬´{item_name}¬ª (ID {bike_id}) –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø–ª–∞–Ω –≤—ã–∫—É–ø–∞.")

                before_booking = await _snapshot(conn, "bookings", "id", booking_id,
                                                 ["id", "status", "payments_made", "next_payment_date"])
                before_bike = await _snapshot(conn, "bikes", "id", bike_id, ["id", "available", "owner_id", "is_unlimited"])

                if is_full_buyout:
                    await conn.execute("UPDATE bookings SET status='completed', next_payment_date=NULL WHERE id=?", (booking_id,))
                    if not is_unlimited:
                        await conn.execute("UPDATE bikes SET available=0, owner_id=? WHERE id=?", (user_id, bike_id))
                    action = "–î–æ—Å—Ä–æ—á–Ω–æ–µ –ø–æ–≥–∞—à–µ–Ω–∏–µ"
                    details = "–†–∞—Å—Å—Ä–æ—á–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≥–∞—à–µ–Ω–∞"
                else:
                    new_payments = payments_made + 1
                    if new_payments >= total_payments:
                        await conn.execute(
                            "UPDATE bookings SET status='completed', payments_made=?, next_payment_date=NULL WHERE id=?",
                            (new_payments, booking_id),
                        )
                        if not is_unlimited:
                            await conn.execute("UPDATE bikes SET available=0, owner_id=? WHERE id=?", (user_id, bike_id))
                        action = f"–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≤—ã–∫—É–ø–∞ ({plan_type_str})"
                        details = "–í–Ω–µ—Å–µ–Ω –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂"
                    else:
                        next_date = (datetime.now() + timedelta(days=period_days)).strftime("%d.%m.%Y")
                        await conn.execute(
                            "UPDATE bookings SET payments_made=?, next_payment_date=? WHERE id=?",
                            (new_payments, next_date, booking_id),
                        )
                        action = f"–ü–ª–∞—Ç–µ–∂ –ø–æ –≤—ã–∫—É–ø—É ({plan_type_str})"
                        details = f"–í–Ω–µ—Å–µ–Ω –ø–ª–∞—Ç–µ–∂ {new_payments}/{total_payments}"

                after_booking = await _snapshot(conn, "bookings", "id", booking_id,
                                                ["id", "status", "payments_made", "next_payment_date"])
                after_bike = await _snapshot(conn, "bikes", "id", bike_id, ["id", "available", "owner_id", "is_unlimited"])

                await log_bike_action(conn, bike_id, user_id, action, details, amount=amount_rub)
                await conn.commit()
                _log("info", "tx_commit", case=case,
                     booking_before=before_booking, booking_after=after_booking,
                     bike_before=before_bike, bike_after=after_bike,
                     action=action, details=details)

                bike_name, owner_name = await _get_bike_and_owner_info(conn, bike_id)
                # –û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
                if is_full_buyout:
                    await send_response("üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –¥–æ—Å—Ä–æ—á–Ω–æ –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–∫—É–ø–∏–ª–∏ —Ç–æ–≤–∞—Ä! –¢–µ–ø–µ—Ä—å –æ–Ω –≤–∞—à.")
                    note = f"–î–æ—Å—Ä–æ—á–Ω–æ–µ –ø–æ–≥–∞—à–µ–Ω–∏–µ –∑–∞ ¬´{item_name}¬ª (–í–´–ö–£–ü–õ–ï–ù)"
                else:
                    if after_booking["status"] == "completed":
                        await send_response(f"üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–∫—É–ø–∏–ª–∏ —Ç–æ–≤–∞—Ä ¬´{item_name}¬ª! –¢–µ–ø–µ—Ä—å –æ–Ω –≤–∞—à.")
                        note = f"–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂ –ø–æ —Ä–∞—Å—Å—Ä–æ—á–∫–µ –∑–∞ ¬´{item_name}¬ª (–í–´–ö–£–ü–õ–ï–ù)"
                    else:
                        await send_response(
                            f"‚úÖ –ü–ª–∞—Ç–µ–∂ –ø—Ä–∏–Ω—è—Ç! –í–Ω–µ—Å–µ–Ω–æ {after_booking['payments_made']} –∏–∑ {total_payments}. "
                            f"–°–ª–µ–¥—É—é—â–∏–π –ø–ª–∞—Ç–µ–∂ –¥–æ {after_booking['next_payment_date']}."
                        )
                        note = f"–ü–ª–∞—Ç–µ–∂ –ø–æ —Ä–∞—Å—Å—Ä–æ—á–∫–µ –∑–∞ ¬´{item_name}¬ª ({after_booking['payments_made']}/{total_payments})"

                try:
                    await send_admin_payment_notification(context, user_name_formatted, amount_rub, note,
                                                         bike_name=bike_name, owner_name=owner_name)
                except Exception as e:
                    _log("error", "admin_notification_failed", case=case, error=str(e))

            else:
                _log("warning", "unknown_payload_type")
                await conn.commit()
                await send_response("‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞. –¢–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –∫–∞–∫ –æ–±—â–∏–π –ø–ª–∞—Ç—ë–∂.")

    except Exception as e:
        _log("error", "critical_error", error=str(e))
        if conn:
            try:
                await conn.rollback()
                _log("info", "tx_rollback_done")
            except Exception as er:
                _log("error", "tx_rollback_failed", error=str(er))
        await send_response("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.")
    finally:
        _log("info", "payment_processing_end", elapsed_ms=int((time.time() - t0) * 1000))



# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ process_successful_payment –ù–ê –≠–¢–£ –ü–û–õ–ù–£–Æ –í–ï–†–°–ò–Æ

import aiosqlite # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ process_successful_payment –ù–ê –≠–¢–£ –ü–û–õ–ù–£–Æ –ò –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–£–Æ –í–ï–†–°–ò–Æ

import aiosqlite # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –ü–û–õ–ù–£–Æ –ò –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–£–Æ –í–ï–†–°–ò–Æ
import aiosqlite # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –ü–û–õ–ù–£–Æ –ò –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–£–Æ –í–ï–†–°–ò–Æ
import aiosqlite # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞



    # –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–ª–∞–≥–æ–¥–∞—Ä—è `with sqlite3.connect(...)`
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ confirm_agreement –ù–ê –≠–¢–£:
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ confirm_agreement –ù–ê –≠–¢–£:
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ confirm_agreement –ù–ê –≠–¢–£:

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ confirm_agreement –ù–ê –≠–¢–£:
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ confirm_agreement –ù–ê –≠–¢–£

# corrected_code.py

# main.py

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏–º–ø–æ—Ä—Ç aiosqlite —É –≤–∞—Å –µ—Å—Ç—å
import aiosqlite

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞
import aiosqlite
import asyncio
import logging
from datetime import datetime, timedelta
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from telegram.helpers import escape_markdown
import sqlite3 # –î–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–π

# ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –≤–∞—à–∏ –∏–º–ø–æ—Ä—Ç—ã –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã)

async def confirm_agreement(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –°–æ–∑–¥–∞–µ—Ç –∑–∞—è–≤–∫—É –Ω–∞ –∞—Ä–µ–Ω–¥—É.
    –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–¥–∏–Ω—É—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ë–î.
    """
    query = update.callback_query
    await query.answer()
    user_id = query.from_user.id

    rental_data = context.user_data.get('rental_data')
    if not rental_data:
        await query.message.edit_text("üö´ –û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.")
        return

    bike_id = rental_data['bike_id']
    is_custom_deal = (bike_id == 999) # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ 999 - —ç—Ç–æ ID –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å–¥–µ–ª–∫–∏
    
    try:
        # --- –ù–ê–ß–ê–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô ---
        # –û—Ç–∫—Ä—ã–≤–∞–µ–º –û–î–ù–û —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –í–°–ï–• –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ë–î –≤ —ç—Ç–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        async with aiosqlite.connect(DB_FILE, timeout=15) as conn:
            conn.row_factory = aiosqlite.Row
            
            # –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é, —á—Ç–æ–±—ã –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±—ã–ª–∏ –∞—Ç–æ–º–∞—Ä–Ω—ã–º–∏
            await conn.execute("BEGIN")

            start_date = datetime.now().strftime('%d.%m.%Y')
            end_date = (datetime.now() + timedelta(days=rental_data['days'])).strftime('%d.%m.%Y')

            # 1. –í—Å—Ç–∞–≤–ª—è–µ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ë–î
            cursor = await conn.execute(
                """INSERT INTO bookings (user_id, bike_id, booking_date, end_date, status, booking_type)
                   VALUES (?, ?, ?, ?, 'paid_unassigned', 'rent')""",
                (user_id, bike_id, start_date, end_date)
            )
            booking_id = cursor.lastrowid
            
            # 2. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–≤ —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
            user_cursor = await conn.execute("SELECT first_name, last_name, username FROM users WHERE id=?", (user_id,))
            user_db_info = await user_cursor.fetchone()
            
            # 3. –ó–∞–≤–µ—Ä—à–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
            await conn.commit()
        # --- –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô ---

        # –ï—Å–ª–∏ –º—ã –¥–æ—à–ª–∏ –¥–æ —Å—é–¥–∞, –∑–Ω–∞—á–∏—Ç –∑–∞–ø–∏—Å—å –≤ –ë–î –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
        
        await query.message.edit_text(
            "‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞!\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –∏ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–∞. üïí"
        )
        
        user_name_raw = f"{user_db_info['first_name']} {user_db_info['last_name'] or ''} (@{user_db_info['username'] or 'no_username'})"
        user_name_escaped = escape_markdown(user_name_raw, version=2)
        days_escaped = escape_markdown(str(rental_data['days']), version=2)

        # –§–æ—Ä–º–∏—Ä—É–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –∞–¥–º–∏–Ω–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º
        if is_custom_deal:
            admin_notification = (
                f"üö® *–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–£–Æ –ê–†–ï–ù–î–£\\!*\n\n"
                f"üë§ *–ö–ª–∏–µ–Ω—Ç:* {user_name_escaped}\n"
                f"‚è≥ *–ñ–µ–ª–∞–µ–º—ã–π —Å—Ä–æ–∫:* {days_escaped} –¥–Ω–µ–π\n\n"
                f"‚ùóÔ∏è*–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞\\!* –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Å–¥–µ–ª–∫—É –∏ –≤—ã—Å—Ç–∞–≤–∏—Ç—å —Å—á–µ—Ç\\."
            )
            keyboard = [[InlineKeyboardButton("‚úçÔ∏è –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—É—é –∑–∞—è–≤–∫—É", callback_data=f"assign_{booking_id}")]]
        else:
            bike_name_escaped = escape_markdown(rental_data['bike_name'], version=2)
            admin_notification = (
                f"üö® *–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ –ê–†–ï–ù–î–£\\!*\n\n"
                f"üë§ *–ö–ª–∏–µ–Ω—Ç:* {user_name_escaped}\n"
                f"üö≤ *–ú–æ–¥–µ–ª—å:* {bike_name_escaped}\n"
                f"‚è≥ *–°—Ä–æ–∫:* {days_escaped} –¥–Ω–µ–π\n\n"
                f"–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞–∑–Ω–∞—á–∏—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥ –∏ –≤—ã—Å—Ç–∞–≤–∏—Ç—å —Å—á–µ—Ç:"
            )
            keyboard = [[InlineKeyboardButton("‚úçÔ∏è –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞—è–≤–∫—É", callback_data=f"assign_{booking_id}")]]

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—Å–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
        for admin_id in ADMIN_IDS:
            try:
                await context.bot.send_message(
                    admin_id, admin_notification,
                    parse_mode="MarkdownV2",
                    reply_markup=InlineKeyboardMarkup(keyboard)
                )
            except Exception as e:
                logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É {admin_id}: {e}")

    except sqlite3.OperationalError as e:
        if "database is locked" in str(e):
            logger.error(f"–ë–ê–ó–ê –î–ê–ù–ù–´–• –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–ê –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –¥–ª—è user {user_id}. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞...")
            await query.message.edit_text("‚è≥ –°–µ—Ä–≤–µ—Ä –Ω–µ–º–Ω–æ–≥–æ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω, –ø–æ–≤—Ç–æ—Ä—è—é –≤–∞—à –∑–∞–ø—Ä–æ—Å...")
            await asyncio.sleep(1.5)  # –î–∞–µ–º –±–∞–∑–µ "–æ—Ç–¥—ã—à–∞—Ç—å—Å—è"
            await confirm_agreement(update, context) # –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
        else:
            logger.error(f"–û—à–∏–±–∫–∞ –ë–î –≤ confirm_agreement –¥–ª—è user {user_id}: {e}", exc_info=True)
            await query.message.edit_text("üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏.")
            
    except Exception as e:
        logger.error(f"–û–±—â–∞—è –æ—à–∏–±–∫–∞ –≤ confirm_agreement –¥–ª—è user {user_id}: {e}", exc_info=True)
        await query.message.edit_text("üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏.")
# –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ë–õ–û–ö –ö–û–î–ê –í –í–ê–® –ü–†–û–ï–ö–¢
# –û–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–∏–∞–ª–æ–≥–∞

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è




def get_buyout_plans_with_gemini(deal_description: str) -> dict | None:
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–ø–ª–µ–∫—Ç–∞ –≤ Gemini –∏ –ø—Ä–æ—Å–∏—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
    –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–ª–∞–Ω–æ–≤ —Ä–∞—Å—Å—Ä–æ—á–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.
    """
    try:
        model = genai.GenerativeModel('gemini-2.5-flash-lite')

        prompt = f"""
        –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–ø–ª–µ–∫—Ç–∞ –¥–ª—è –∫—É—Ä—å–µ—Ä–∞: "{deal_description}".
        –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —ç–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥, –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä—ã –∏–ª–∏ –∏ —Ç–æ, –∏ –¥—Ä—É–≥–æ–µ.
        –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Ä—ã–Ω–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–∞–∫–æ–≥–æ –∫–æ–º–ø–ª–µ–∫—Ç–∞ –æ–∫–æ–ª–æ 80,000 - 120,000 —Ä—É–±–ª–µ–π.

        –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 3-4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –ø–ª–∞–Ω–∞ —Ä–∞—Å—Å—Ä–æ—á–∫–∏ (–≤—ã–∫—É–ø–∞) –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–º–ø–ª–µ–∫—Ç–∞.
        –í–µ—Ä–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –°–¢–†–û–ì–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ–ª—å–∫–æ —á–∏—Å—Ç—ã–º JSON –æ–±—ä–µ–∫—Ç–æ–º,
        –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏–ª–∏ ```json ``` –æ–±–µ—Ä—Ç–æ–∫.

        –ö–ª—é—á–∞–º–∏ –≤ JSON –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, "plan_1", "plan_2"),
        –∞ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ - —Å–ª–æ–≤–∞—Ä–∏ —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –∫–ª—é—á–∞–º–∏:
        - "label": –ö–æ—Ä–æ—Ç–∫–æ–µ –∏ –ø–æ–Ω—è—Ç–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∫–Ω–æ–ø–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "3 –º–µ—Å / 16000 ‚ÇΩ").
        - "full_label": –ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "3 –º–µ—Å—è—Ü–∞: 7 –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ 16 000 ‚ÇΩ").
        - "first_payment": –°—É–º–º–∞ –ø–µ—Ä–≤–æ–≥–æ –≤–∑–Ω–æ—Å–∞ (—á–∏—Å–ª–æ).
        - "total_payments": –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç–µ–∂–µ–π (—á–∏—Å–ª–æ).
        - "period_days": –ü–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–µ–π –≤ –¥–Ω—è—Ö (30 –¥–ª—è –º–µ—Å—è—Ü–∞, 14 –¥–ª—è 2 –Ω–µ–¥–µ–ª—å).

        –ü—Ä–∏–º–µ—Ä —Ç–≤–æ–µ–≥–æ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:
        {{
            "plan_1": {{
                "label": "3 –º–µ—Å / 16000 ‚ÇΩ",
                "full_label": "3 –º–µ—Å—è—Ü–∞: 7 –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ 16 000 ‚ÇΩ (—Ä–∞–∑ –≤ 2 –Ω–µ–¥–µ–ª–∏)",
                "first_payment": 16000,
                "total_payments": 7,
                "period_days": 14
            }},
            "plan_2": {{
                "label": "4 –º–µ—Å / 21000 ‚ÇΩ",
                "full_label": "4 –º–µ—Å—è—Ü–∞: 5 –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ 21 000 ‚ÇΩ (—Ä–∞–∑ –≤ –º–µ—Å—è—Ü)",
                "first_payment": 21000,
                "total_payments": 5,
                "period_days": 30
            }}
        }}
        """

        response = model.generate_content(prompt, stream=False)
        response.resolve()

        cleaned_response_text = response.text.strip().replace("`", "")
        if cleaned_response_text.lower().startswith("json"):
             cleaned_response_text = cleaned_response_text[4:].strip()

        logger.info(f"–ü–æ–ª—É—á–µ–Ω—ã –ø–ª–∞–Ω—ã –≤—ã–∫—É–ø–∞ –æ—Ç Gemini: {cleaned_response_text}")
        data = json.loads(cleaned_response_text)

        if isinstance(data, dict) and all(isinstance(v, dict) for v in data.values()):
            return data
        else:
            logger.error(f"–û—Ç–≤–µ—Ç –æ—Ç Gemini (–ø–ª–∞–Ω—ã –≤—ã–∫—É–ø–∞) –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É: {data}")
            return None

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–ª–∞–Ω–æ–≤ –≤—ã–∫—É–ø–∞ —Å Gemini: {e}", exc_info=True)
        return None

# –ó–∞–º–µ–Ω–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –Ω–∞ —ç—Ç–æ—Ç –Ω–æ–≤—ã–π, –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—ã–π —Å–ø–∏—Å–æ–∫
from passport_recognition_gemini import get_buyout_plans_with_gemini

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
(
    DEAL_SELECT_USER, DEAL_ENTER_BIKE_DESC, DEAL_SELECT_BATTERY_COUNT,
    DEAL_ENTER_BATTERY_NUMS, DEAL_SELECT_TYPE,
    DEAL_RENT_DAYS, DEAL_RENT_PRICE,
    DEAL_SELECT_BUYOUT_PLAN,
    DEAL_CONFIRM
) = range(200, 209)

# ID "–≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ" —Ç–æ–≤–∞—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –º—ã —Å–æ–∑–¥–∞–ª–∏ –≤ –ë–î
VIRTUAL_BIKE_ID = 999


# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ –¥—Ä—É–≥–æ–≥–æ —Ñ–∞–π–ª–∞
from passport_recognition_gemini import get_buyout_plans_with_gemini



# ==============================================================================
# –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –ü–û–õ–ù–û–ô –ó–ê–ú–ï–ù–´
# ==============================================================================




# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞
import json
import os
import asyncio
import random
import aiosqlite
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, LabeledPrice
from telegram.ext import ContextTypes, ConversationHandler




async def electrobike_cancel_rental(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –û—Ç–º–µ–Ω–∞ –∞—Ä–µ–Ω–¥—ã –∏ –≤–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.
    """
    await update.message.reply_text(
        "–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.",
        reply_markup=get_main_menu(update.effective_user.id)
    )
    context.user_data.clear()
    return ConversationHandler.END

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ check_payment_status –ù–ê –≠–¢–£:
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
# ### –ù–û–í–ê–Ø, –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
async def check_payment_status(context: ContextTypes.DEFAULT_TYPE):
    """
    –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø:
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –≤ YooKassa –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
    –¢–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ–¥–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∫–∏–¥–∫–µ –¥–ª—è –ø–æ–≥–∞—à–µ–Ω–∏—è.
    """
    job = context.job
    if not job or not job.data or 'yookassa_id' not in job.data:
        logging.error(f"–ó–∞–¥–∞—á–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–∞ –∑–∞–ø—É—â–µ–Ω–∞ –±–µ–∑ yookassa_id. –£–¥–∞–ª—è—é.")
        if job: job.schedule_removal()
        return

    yookassa_id = job.data['yookassa_id']
    pending_payments = context.bot_data.get('pending_payments', {})
    payment_data = pending_payments.get(yookassa_id)

    if not payment_data:
        logging.warning(f"–î–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–∞ {yookassa_id} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞.")
        job.schedule_removal()
        return

    user_id = payment_data['user_id']
    animated_message_id = payment_data.get('animated_message_id')
    stop_animation_event = payment_data.get('stop_animation_event')

    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
    if stop_animation_event and not stop_animation_event.is_set():
        stop_animation_event.set()

    try:
        payment = Payment.find_one(yookassa_id)

        if payment.status == 'succeeded':
            logging.info(f"–ü–ª–∞—Ç–µ–∂ {yookassa_id} –¥–ª—è user_id {user_id} –£–°–ü–ï–®–ï–ù.")

            # –ò–∑–≤–ª–µ–∫–∞–µ–º ID —Å–∫–∏–¥–∫–∏ –∏–∑ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –æ–Ω —Ç–∞–º –±—ã–ª
            metadata = payment.metadata
            discount_id_to_use = metadata.get('discount_id') # –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å None

            # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π –∏ –∫–Ω–æ–ø–∫–æ–π –æ–ø–ª–∞—Ç—ã
            if animated_message_id:
                try:
                    await context.bot.delete_message(chat_id=user_id, message_id=animated_message_id)
                except Exception as e:
                    logging.info(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ {animated_message_id}: {e}")

            # –í—ã–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –æ–±—Ä–∞–±–æ—Ç–∫–∏, –ø–µ—Ä–µ–¥–∞–≤–∞—è –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
            await process_successful_payment(
                context=context,
                user_id=user_id,
                payload=metadata.get('internal_payload', ''),
                amount_rub=int(float(payment.amount.value)),
                discount_id_to_use=discount_id_to_use # –ü–µ—Ä–µ–¥–∞–µ–º ID —Å–∫–∏–¥–∫–∏
            )

        elif payment.status in ['canceled', 'failed']:
            logging.warning(f"–ü–ª–∞—Ç–µ–∂ {yookassa_id} –¥–ª—è user_id {user_id} –æ—Ç–º–µ–Ω–µ–Ω –∏–ª–∏ –Ω–µ—É–¥–∞—á–µ–Ω (—Å—Ç–∞—Ç—É—Å: {payment.status}).")
            if animated_message_id:
                try:
                    await context.bot.edit_message_text(
                        chat_id=user_id,
                        message_id=animated_message_id,
                        text="‚ùå –ü–ª–∞—Ç–µ–∂ –±—ã–ª –æ—Ç–º–µ–Ω–µ–Ω –∏–ª–∏ –Ω–µ —É–¥–∞–ª—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
                    )
                except Exception:
                     await context.bot.send_message(user_id, "‚ùå –ü–ª–∞—Ç–µ–∂ –±—ã–ª –æ—Ç–º–µ–Ω–µ–Ω –∏–ª–∏ –Ω–µ —É–¥–∞–ª—Å—è.")

        else: # –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å 'pending' –∏–ª–∏ 'waiting_for_capture'
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∑–∞–¥–∞—á–∏
            if datetime.now() - payment_data.get('start_time', datetime.now()) > timedelta(minutes=15):
                logging.warning(f"–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ {yookassa_id} –∏—Å—Ç–µ–∫–ª–æ.")
                if animated_message_id:
                     try:
                        await context.bot.edit_message_text(chat_id=user_id, message_id=animated_message_id, text="–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ–ø–ª–∞—Ç—ã –∏—Å—Ç–µ–∫–ª–æ.")
                     except Exception:
                        await context.bot.send_message(user_id, "–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ–ø–ª–∞—Ç—ã –∏—Å—Ç–µ–∫–ª–æ.")
                job.schedule_removal() # –£–¥–∞–ª—è–µ–º –∑–∞–¥–∞—á—É, –µ—Å–ª–∏ –≤—Ä–µ–º—è –≤—ã—à–ª–æ
                if yookassa_id in pending_payments: del pending_payments[yookassa_id]
            return # –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–µ –≤—ã—à–ª–æ, –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–º –∏ –∂–¥–µ–º —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

        # –ï—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ –∑–∞–≤–µ—Ä—à–µ–Ω (—É—Å–ø–µ—à–Ω–æ, –æ—Ç–º–µ–Ω–µ–Ω, –ø—Ä–æ–≤–∞–ª–µ–Ω), —É–¥–∞–ª—è–µ–º –∑–∞–¥–∞—á—É –∏ –¥–∞–Ω–Ω—ã–µ
        job.schedule_removal()
        if yookassa_id in pending_payments:
            del pending_payments[yookassa_id]

    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞ {yookassa_id}: {e}", exc_info=True)
        job.schedule_removal()
        if yookassa_id in pending_payments:
            del pending_payments[yookassa_id]

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
#========================================================================================
# –ù–ê–ß–ê–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ô –§–£–ù–ö–¶–ò–ò
#========================================================================================

#========================================================================================
# –ù–ê–ß–ê–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ô –§–£–ù–ö–¶–ò–ò
#========================================================================================




async def pre_checkout_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.pre_checkout_query
    await query.answer(ok=True)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ üìÖ
### –ù–û–í–ê–Ø, –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
async def book_bike(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è. –®–∞–≥ 1: –í—ã–±–æ—Ä –¥–∞—Ç—ã.
    """
    query = update.callback_query
    await query.answer()

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –º–æ–¥–µ–ª–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞
    try:
        context.user_data['booking_bike_id'] = int(query.data.split("_")[1])
    except (IndexError, ValueError):
        await query.edit_message_text("üö´ –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return ConversationHandler.END

    # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–µ, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø—É—Ç–∞–Ω–∏—Ü—ã
    await query.message.delete()

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–º
    await context.bot.send_message(
        chat_id=query.from_user.id,
        text="üìÖ *–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:*\n\n(–î–æ—Å—Ç—É–ø–Ω—ã –±–ª–∏–∂–∞–π—à–∏–µ 3 –¥–Ω—è)",
        reply_markup=create_calendar(),
        parse_mode="Markdown"
    )
    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏
    return SELECTING_DATE

# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è üìã
async def send_sticker(message, sticker_id: str) -> None:
    await message.reply_sticker(sticker_id)
# –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚úîÔ∏è‚ùå
logger = logging.getLogger(__name__)  # –°–æ–∑–¥–∞–µ–º –ª–æ–≥–≥–µ—Ä –Ω–∞ —É—Ä–æ–≤–Ω–µ –º–æ–¥—É–ª—è

### –ù–û–í–ê–Ø, –ü–û–õ–ù–û–°–¢–¨–Æ –ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –ò –ò–ù–§–û–†–ú–ê–¢–ò–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –ò–°–ü–†–ê–í–õ–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

async def finalize_booking(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –ó–∞–≤–µ—Ä—à–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –ë–î –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
    –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
    """
    query = update.callback_query
    await query.answer()

    if query.data == 'reject_booking':
        await query.edit_message_text("‚ùå –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
        context.user_data.clear()
        return ConversationHandler.END

    user_id = query.from_user.id
    user_data = context.user_data
    bike_id = user_data.get('booking_bike_id')
    booking_date = user_data.get('booking_date')
    booking_time = user_data.get('booking_time')

    if not all([bike_id, booking_date, booking_time]):
        await query.edit_message_text("üö´ –û—à–∏–±–∫–∞ —Å–µ—Å—Å–∏–∏. –î–∞–Ω–Ω—ã–µ —É—Ç–µ—Ä—è–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.")
        return ConversationHandler.END

    full_booking_datetime_str = f"{booking_date.strftime('%d.%m.%Y')} {booking_time}"

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            cursor = await conn.execute("SELECT first_name, last_name, username FROM users WHERE id=?", (user_id,))
            user_info = await cursor.fetchone()
            user_name_raw = f"{user_info[0]} {user_info[1] or ''} (@{user_info[2] or 'no_username'})" if user_info else f"ID {user_id}"

            cursor = await conn.execute("SELECT name FROM bikes WHERE id=?", (bike_id,))
            bike_name_row = await cursor.fetchone()
            bike_name = bike_name_row[0] if bike_name_row else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≤–µ–ª–æ—Å–∏–ø–µ–¥"

            await conn.execute(
                "INSERT INTO bookings (user_id, bike_id, booking_date, status) VALUES (?, ?, ?, 'pending')",
                (user_id, bike_id, full_booking_datetime_str)
            )

            cursor = await conn.execute("SELECT last_insert_rowid()")
            booking_id_row = await cursor.fetchone()
            booking_id = booking_id_row[0]

            await conn.commit()

        await query.edit_message_text("‚úÖ –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –±—Ä–æ–Ω—å –ø—Ä–∏–Ω—è—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É. –û–∂–∏–¥–∞–π—Ç–µ! üê±")

        user_name_escaped = escape_markdown(user_name_raw, version=2)
        bike_name_escaped = escape_markdown(bike_name, version=2)
        booking_datetime_escaped = escape_markdown(full_booking_datetime_str, version=2)

        notification_message = (
            f"üìù *–ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –±—Ä–æ–Ω—å\\!*\n\n"
            f"üë§ *–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:* {user_name_escaped}\n"
            f"üö≤ *–í–µ–ª–æ—Å–∏–ø–µ–¥:* {bike_name_escaped} \\(ID: {bike_id}\\)\n"
            f"üìÖ *–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:* {booking_datetime_escaped}\n"
            f"üÜî *ID –±—Ä–æ–Ω–∏:* `{booking_id}`"
        )

        keyboard = [[
            InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data=f"confirm_{booking_id}"),
            InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data=f"cancel_{booking_id}")
        ]]
        reply_markup = InlineKeyboardMarkup(keyboard)

        for admin_id in ADMIN_IDS:
            await context.bot.send_message(
                admin_id,
                notification_message,
                reply_markup=reply_markup,
                parse_mode="MarkdownV2"
            )

        # <<< –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º await >>>
        await add_notification(f"–ù–æ–≤–∞—è –±—Ä–æ–Ω—å –æ—Ç {user_name_raw} –Ω–∞ {bike_name}")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ finalize_booking: {e}", exc_info=True)
        await query.edit_message_text("üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –±—Ä–æ–Ω–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
    finally:
        context.user_data.clear()
        return ConversationHandler.END
QUANTITY_PROMPT = 5 # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ (–¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É) ‚ûï


EDIT_MENU, EDIT_NAME, EDIT_DESCRIPTION, EDIT_PRICE, EDIT_AVAILABLE, EDIT_SEARCH = range(6)
STATS_AWAIT_DATE_RANGE = range(990, 991)

async def start_detailed_report_date_prompt(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 1: –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–µ—Ä–∏–æ–¥ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞ –æ—Ç—á–µ—Ç–∞."""
    query = update.callback_query
    await query.answer()

    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–∏–ø –æ—Ç—á–µ—Ç–∞ –∏–∑ callback_data (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'own', 'investor', 'combined')
    # –§–æ—Ä–º–∞—Ç callback_data: stats_detailed_{report_type}_{optional_investor_id}
    report_type = query.data.split('_')[2]
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∏–ø –æ—Ç—á–µ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
    context.user_data['detailed_report_type'] = report_type
    
    # –ï—Å–ª–∏ —ç—Ç–æ –æ—Ç—á–µ—Ç –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –∏–Ω–≤–µ—Å—Ç–æ—Ä—É, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –µ–≥–æ ID
    if len(query.data.split('_')) > 3:
        context.user_data['detailed_report_investor_id'] = int(query.data.split('_')[3])

    message_text = (
        "üìÖ *–û—Ç—á–µ—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥*\n\n"
        "–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –æ—Ç—á–µ—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `–î–î.–ú–ú.–ì–ì–ì–ì-–î–î.–ú–ú.–ì–ì–ì–ì`\n"
        "–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã: `—Å–µ–≥–æ–¥–Ω—è`, `–Ω–µ–¥–µ–ª—è`, `–º–µ—Å—è—Ü`."
    )
    
    await query.edit_message_text(message_text, parse_mode="Markdown")
    return STATS_AWAIT_DATE_RANGE

async def process_detailed_report_dates(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –®–∞–≥ 2: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–∞—Ç—ã, –≤—ã–∑—ã–≤–∞–µ—Ç –Ω—É–∂–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á–µ—Ç.
    """
    user_input = update.message.text.strip().lower()
    today = datetime.now()
    start_date, end_date = None, None

    try:
        if user_input == '—Å–µ–≥–æ–¥–Ω—è':
            start_date = end_date = today
        elif user_input == '–Ω–µ–¥–µ–ª—è':
            start_date = today - timedelta(days=today.weekday())
            end_date = today
        elif user_input == '–º–µ—Å—è—Ü':
            start_date = today.replace(day=1)
            end_date = today
        else:
            start_str, end_str = user_input.split('-')
            start_date = datetime.strptime(start_str.strip(), '%d.%m.%Y')
            end_date = datetime.strptime(end_str.strip(), '%d.%m.%Y')
    except (ValueError, IndexError):
        await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
        return STATS_AWAIT_DATE_RANGE

    status_message = await update.message.reply_text("‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é Excel-–æ—Ç—á–µ—Ç, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ –º–∏–Ω—É—Ç—ã...")

    report_type = context.user_data.get('detailed_report_type')
    investor_id = context.user_data.get('detailed_report_investor_id')
    filename = None
    
    try:
        # <<< –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í–´–ó–´–í–ê–ï–ú –ù–û–í–£–Æ –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–£–Æ –§–£–ù–ö–¶–ò–Æ –° –î–ê–¢–ê–ú–ò >>>
        if report_type == 'expenses':
             filename = generate_expense_report(start_date, end_date)
        else:
             filename = await generate_unified_report(
                 report_type=report_type, 
                 start_date=start_date, 
                 end_date=end_date, 
                 investor_id=investor_id
             )

        if filename and os.path.exists(filename):
            with open(filename, 'rb') as file:
                await context.bot.send_document(
                    chat_id=update.effective_chat.id,
                    document=file,
                    caption=f"‚úÖ –í–∞—à –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –∑–∞ –ø–µ—Ä–∏–æ–¥ —Å {start_date.strftime('%d.%m.%Y')} –ø–æ {end_date.strftime('%d.%m.%Y')} –≥–æ—Ç–æ–≤."
                )
            os.remove(filename)
            await status_message.delete()
        else:
            await status_message.edit_text("üòî –í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—á–µ—Ç–∞ –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞ –ø–æ –¥–∞—Ç–∞–º: {e}", exc_info=True)
        await status_message.edit_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")

    context.user_data.clear()
    return ConversationHandler.END
# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
def generate_edit_bikes_keyboard(context):
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    search_query = context.user_data.get('search_query')
    if search_query:
        cursor.execute("SELECT id, name FROM bikes WHERE name LIKE ?", ('%' + search_query + '%',))
    else:
        cursor.execute("SELECT id, name FROM bikes")

    bikes = cursor.fetchall()
    conn.close()

    page = context.user_data.get('edit_page', 0)  # –¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
    items_per_page = 5  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    total_pages = (len(bikes) + items_per_page - 1) // items_per_page  # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü

    # –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –µ—Å–ª–∏ –æ–Ω –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –ø—Ä–µ–¥–µ–ª—ã
    page = max(0, min(page, total_pages - 1))

    # –í—ã–±–∏—Ä–∞–µ–º –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    start_idx = page * items_per_page
    end_idx = start_idx + items_per_page
    current_bikes = bikes[start_idx:end_idx]

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ —Å –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞–º–∏
    keyboard = [
        [InlineKeyboardButton(bike[1], callback_data=f"edit_{bike[0]}")]
        for bike in current_bikes
    ]

    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    pagination = []
    if page > 0:
        pagination.append(InlineKeyboardButton("<", callback_data="prev_edit_page"))
    if page < total_pages - 1:
        pagination.append(InlineKeyboardButton(">", callback_data="next_edit_page"))

    if pagination:
        keyboard.append(pagination)

    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ–∏—Å–∫–∞/—Å–±—Ä–æ—Å–∞
    search_buttons = []
    if context.user_data.get('search_query'):
        search_buttons.append(InlineKeyboardButton("‚ùå –°–±—Ä–æ—Å–∏—Ç—å –ø–æ–∏—Å–∫", callback_data="reset_search"))
    else:
        search_buttons.append(InlineKeyboardButton("üîç –ü–æ–∏—Å–∫", callback_data="start_search"))

    if search_buttons:
        keyboard.append(search_buttons)

    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
    keyboard.append([InlineKeyboardButton("üó° –ù–∞–∑–∞–¥", callback_data="cancel_edit")])

    # –¢–µ–∫—Å—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    text = f"üñäÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥ (–°—Ç—Ä–∞–Ω–∏—Ü–∞ {page + 1}/{total_pages}):"
    return text, InlineKeyboardMarkup(keyboard)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
async def edit_bikes(update: Update, context) -> None:
    """
    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
    """
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏ —Ç–µ–∫—Å—Ç–∞
    text, reply_markup = generate_edit_bikes_keyboard(context)

    # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    if update.message:
        await update.message.reply_text(text, reply_markup=reply_markup)
    else:
        await update.callback_query.edit_message_text(text, reply_markup=reply_markup)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
async def navigate_edit_pages(update: Update, context):
    query = update.callback_query
    await query.answer()

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∏—Å–∫–∞
    if query.data == "start_search":
        await query.message.reply_text("‚úèÔ∏è –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞:")
        return EDIT_SEARCH

    elif query.data == "reset_search":
        if 'search_query' in context.user_data:
            del context.user_data['search_query']
        context.user_data['edit_page'] = 0
        await edit_bikes(update, context)
        return ConversationHandler.END

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    current_page = context.user_data.get('edit_page', 0)
    if query.data == "prev_edit_page":
        current_page = max(0, current_page - 1)
    elif query.data == "next_edit_page":
        current_page += 1

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    context.user_data['edit_page'] = current_page

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    await edit_bikes(update, context)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
async def handle_search_input(update: Update, context):
    search_text = update.message.text
    context.user_data['search_query'] = search_text
    context.user_data['edit_page'] = 0
    await edit_bikes(update, context)
    return ConversationHandler.END

# –ù–∞—á–∞–ª–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞
async def start_editing_bike(update: Update, context) -> int:
    query = update.callback_query
    await query.answer()

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞
    context.user_data['prev_page'] = context.user_data.get('edit_page', 0)

    bike_id = query.data.split("_")[1]

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT id FROM bikes WHERE id=?", (bike_id,))
    if not cursor.fetchone():
        await query.message.reply_text("üö´ –í–µ–ª–æ—Å–∏–ø–µ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return ConversationHandler.END
    conn.close()

    context.user_data['editing_bike'] = bike_id
    return await show_edit_menu(update, context)

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ show_edit_menu –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
async def show_edit_menu(update: Update, context):
    keyboard = [
        [
            InlineKeyboardButton("‚úèÔ∏è –ù–∞–∑–≤–∞–Ω–∏–µ", callback_data="edit_name"),
            InlineKeyboardButton("üìù –û–ø–∏—Å–∞–Ω–∏–µ", callback_data="edit_description")
        ],
        [
            InlineKeyboardButton("üí∞ –¶–µ–Ω–∞", callback_data="edit_price"),
            InlineKeyboardButton("üîÑ –ù–∞–ª–∏—á–∏–µ", callback_data="edit_available")
        ],
        # <<< –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>
        [InlineKeyboardButton("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å", callback_data="edit_delete")],
        [InlineKeyboardButton("‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å", callback_data="edit_finish")]
        # <<< –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    if update.callback_query:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º message.reply_text –≤–º–µ—Å—Ç–æ edit_message_text, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫
        # –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∏–∑ –¥—Ä—É–≥–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
        await update.callback_query.message.reply_text(
            "üõ† –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:",
            reply_markup=reply_markup
        )
    else:
        await update.message.reply_text(
            "üõ† –í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:",
            reply_markup=reply_markup
        )
    return EDIT_MENU
# ADD THIS NEW CODE BLOCK
async def handle_delete_request(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 1 (–£–¥–∞–ª–µ–Ω–∏–µ): –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–≤–æ–±–æ–¥–µ–Ω –ª–∏ —Ç–æ–≤–∞—Ä, –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ."""
    query = update.callback_query
    await query.answer()
    
    bike_id = context.user_data.get('editing_bike')
    
    async with aiosqlite.connect(DB_FILE) as conn:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏
        cursor = await conn.execute("SELECT COUNT(*) FROM bookings WHERE bike_id = ? AND status = 'rented'", (bike_id,))
        active_deals_count = (await cursor.fetchone())[0]

    if active_deals_count > 0:
        await query.answer(
            f"üö´ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å! –≠—Ç–æ—Ç —Ç–æ–≤–∞—Ä –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ {active_deals_count} –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–∫–∞—Ö (–∞—Ä–µ–Ω–¥–∞/–≤—ã–∫—É–ø).",
            show_alert=True
        )
        return EDIT_MENU # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

    # –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä —Å–≤–æ–±–æ–¥–µ–Ω, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    keyboard = [
        [InlineKeyboardButton("–î–ê, –£–î–ê–õ–ò–¢–¨", callback_data="confirm_delete_bike_yes")],
        [InlineKeyboardButton("–ù–µ—Ç, –≤–µ—Ä–Ω—É—Ç—å—Å—è", callback_data="confirm_delete_bike_no")]
    ]
    await query.edit_message_text(
        "üö® –í–´ –£–í–ï–†–ï–ù–´?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ —É–¥–∞–ª–∏—Ç —Ç–æ–≤–∞—Ä –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
    return EDIT_CONFIRM_DELETE_BIKE

async def delete_bike_confirmed(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 2 (–£–¥–∞–ª–µ–Ω–∏–µ): –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ —É–¥–∞–ª—è–µ—Ç —Ç–æ–≤–∞—Ä."""
    query = update.callback_query
    await query.answer()

    if query.data == "confirm_delete_bike_no":
        # –ï—Å–ª–∏ –∞–¥–º–∏–Ω –ø–µ—Ä–µ–¥—É–º–∞–ª, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ –≤ –º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        return await show_editing_menu(query, context)

    bike_id = context.user_data.get('editing_bike')
    
    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            await conn.execute("DELETE FROM bikes WHERE id = ?", (bike_id,))
            await conn.commit()
        
        await query.edit_message_text("‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ {bike_id}: {e}", exc_info=True)
        await query.edit_message_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")

    # –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∞–¥–º–∏–Ω–∞ –∫ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–º—É —Å–ø–∏—Å–∫—É –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤
    await edit_bikes(update, context)
    return ConversationHandler.END
async def handle_delete_request(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 1 (–£–¥–∞–ª–µ–Ω–∏–µ): –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–≤–æ–±–æ–¥–µ–Ω –ª–∏ —Ç–æ–≤–∞—Ä, –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ."""
    query = update.callback_query
    await query.answer()
    
    bike_id = context.user_data.get('editing_bike')
    
    async with aiosqlite.connect(DB_FILE) as conn:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏
        cursor = await conn.execute("SELECT COUNT(*) FROM bookings WHERE bike_id = ? AND status = 'rented'", (bike_id,))
        active_deals_count = (await cursor.fetchone())[0]

    if active_deals_count > 0:
        await query.answer(
            f"üö´ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å! –≠—Ç–æ—Ç —Ç–æ–≤–∞—Ä –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ {active_deals_count} –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–∫–∞—Ö (–∞—Ä–µ–Ω–¥–∞/–≤—ã–∫—É–ø).",
            show_alert=True
        )
        return EDIT_MENU # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

    # –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä —Å–≤–æ–±–æ–¥–µ–Ω, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    keyboard = [
        [InlineKeyboardButton("–î–ê, –£–î–ê–õ–ò–¢–¨", callback_data="confirm_delete_bike_yes")],
        [InlineKeyboardButton("–ù–µ—Ç, –≤–µ—Ä–Ω—É—Ç—å—Å—è", callback_data="confirm_delete_bike_no")]
    ]
    await query.edit_message_text(
        "üö® –í–´ –£–í–ï–†–ï–ù–´?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ —É–¥–∞–ª–∏—Ç —Ç–æ–≤–∞—Ä –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
    return EDIT_CONFIRM_DELETE_BIKE

async def delete_bike_confirmed(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 2 (–£–¥–∞–ª–µ–Ω–∏–µ): –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ —É–¥–∞–ª—è–µ—Ç —Ç–æ–≤–∞—Ä."""
    query = update.callback_query
    await query.answer()

    if query.data == "confirm_delete_bike_no":
        # –ï—Å–ª–∏ –∞–¥–º–∏–Ω –ø–µ—Ä–µ–¥—É–º–∞–ª, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ –≤ –º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        return await show_editing_menu(query, context)

    bike_id = context.user_data.get('editing_bike')
    
    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            await conn.execute("DELETE FROM bikes WHERE id = ?", (bike_id,))
            await conn.commit()
        
        await query.edit_message_text("‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ {bike_id}: {e}", exc_info=True)
        await query.edit_message_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")

    # –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∞–¥–º–∏–Ω–∞ –∫ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–º—É —Å–ø–∏—Å–∫—É –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤
    await edit_bikes(update, context)
    return ConversationHandler.END

# –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ë–õ–û–ö –ö–û–î–ê –†–Ø–î–û–ú –° –î–†–£–ì–ò–ú–ò –§–£–ù–ö–¶–ò–Ø–ú–ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø

async def handle_delete_request(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 1 (–£–¥–∞–ª–µ–Ω–∏–µ): –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–≤–æ–±–æ–¥–µ–Ω –ª–∏ —Ç–æ–≤–∞—Ä, –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ."""
    query = update.callback_query
    await query.answer()
    
    bike_id = context.user_data.get('editing_bike')
    
    async with aiosqlite.connect(DB_FILE) as conn:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏
        cursor = await conn.execute("SELECT COUNT(*) FROM bookings WHERE bike_id = ? AND status = 'rented'", (bike_id,))
        active_deals_count = (await cursor.fetchone())[0]

    if active_deals_count > 0:
        await query.answer(
            f"üö´ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å! –≠—Ç–æ—Ç —Ç–æ–≤–∞—Ä –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ {active_deals_count} –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–∫–∞—Ö (–∞—Ä–µ–Ω–¥–∞/–≤—ã–∫—É–ø).",
            show_alert=True
        )
        return EDIT_MENU # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

    # –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä —Å–≤–æ–±–æ–¥–µ–Ω, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    keyboard = [
        [InlineKeyboardButton("–î–ê, –£–î–ê–õ–ò–¢–¨", callback_data="confirm_delete_bike_yes")],
        [InlineKeyboardButton("–ù–µ—Ç, –≤–µ—Ä–Ω—É—Ç—å—Å—è", callback_data="confirm_delete_bike_no")]
    ]
    await query.edit_message_text(
        "üö® –í–´ –£–í–ï–†–ï–ù–´?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ —É–¥–∞–ª–∏—Ç —Ç–æ–≤–∞—Ä –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
    return EDIT_CONFIRM_DELETE_BIKE

async def delete_bike_confirmed(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 2 (–£–¥–∞–ª–µ–Ω–∏–µ): –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ —É–¥–∞–ª—è–µ—Ç —Ç–æ–≤–∞—Ä."""
    query = update.callback_query
    await query.answer()

    if query.data == "confirm_delete_bike_no":
        # –ï—Å–ª–∏ –∞–¥–º–∏–Ω –ø–µ—Ä–µ–¥—É–º–∞–ª, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ –≤ –º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        return await show_editing_menu(query, context)

    bike_id = context.user_data.get('editing_bike')
    
    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            await conn.execute("DELETE FROM bikes WHERE id = ?", (bike_id,))
            await conn.commit()
        
        await query.edit_message_text("‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ {bike_id}: {e}", exc_info=True)
        await query.edit_message_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")

    # –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∞–¥–º–∏–Ω–∞ –∫ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–º—É —Å–ø–∏—Å–∫—É –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤
    await edit_bikes(update, context)
    return ConversationHandler.END

async def handle_edit_choice(update: Update, context):
    query = update.callback_query
    await query.answer()
    choice = query.data

    if choice == "edit_name":
        await query.message.reply_text(
            "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("‚Ü©Ô∏è –û—Ç–º–µ–Ω–∏—Ç—å –≤–≤–æ–¥", callback_data="cancel_input")]
            ])
        )
        return EDIT_NAME

    elif choice == "edit_description":
        await query.message.reply_text(
            "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("‚Ü©Ô∏è –û—Ç–º–µ–Ω–∏—Ç—å –≤–≤–æ–¥", callback_data="cancel_input")]
            ])
        )
        return EDIT_DESCRIPTION

    elif choice == "edit_price":
        await query.message.reply_text(
            "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Ü–µ–Ω—É (—Ä—É–±./–Ω–µ–¥–µ–ª—è):",
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton("‚Ü©Ô∏è –û—Ç–º–µ–Ω–∏—Ç—å –≤–≤–æ–¥", callback_data="cancel_input")]
            ])
        )
        return EDIT_PRICE

    elif choice == "edit_available":
        keyboard = [
            [
                InlineKeyboardButton("‚úÖ –í –Ω–∞–ª–∏—á–∏–∏", callback_data="set_available_1"),
                InlineKeyboardButton("‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏", callback_data="set_available_0")
            ],
            [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="back_to_menu")]
        ]
        await query.message.reply_text(
            "–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –Ω–∞–ª–∏—á–∏—è:",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        return EDIT_AVAILABLE

    elif choice == "edit_finish":
        await query.message.reply_text("‚úÖ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ")
        return ConversationHandler.END

    return EDIT_MENU

async def save_name(update: Update, context):
    if update.message:
        new_name = update.message.text
        bike_id = context.user_data['editing_bike']

        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        cursor.execute("UPDATE bikes SET name=? WHERE id=?", (new_name, bike_id))
        conn.commit()
        conn.close()

        await update.message.reply_text("‚úÖ –ù–∞–∑–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!")
    return await show_edit_menu(update, context)

async def save_description(update: Update, context):
    if update.message:
        new_desc = update.message.text
        bike_id = context.user_data['editing_bike']

        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        cursor.execute("UPDATE bikes SET description=? WHERE id=?", (new_desc, bike_id))
        conn.commit()
        conn.close()

        await update.message.reply_text("‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!")
    return await show_edit_menu(update, context)

async def save_price(update: Update, context):
    if update.message:
        try:
            new_price = float(update.message.text)
            bike_id = context.user_data['editing_bike']

            conn = sqlite3.connect(DB_FILE)
            cursor = conn.cursor()
            cursor.execute("UPDATE bikes SET price=? WHERE id=?", (new_price, bike_id))
            conn.commit()
            conn.close()

            await update.message.reply_text("‚úÖ –¶–µ–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!")
        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ü–µ–Ω—ã!")
    return await show_edit_menu(update, context)

async def set_availability(update: Update, context):
    query = update.callback_query
    await query.answer()
    available = query.data.split("_")[-1]
    bike_id = context.user_data['editing_bike']

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("UPDATE bikes SET available=? WHERE id=?", (available, bike_id))
    conn.commit()
    conn.close()

    await query.message.edit_text("‚úÖ –°—Ç–∞—Ç—É—Å –Ω–∞–ª–∏—á–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω!")
    return await show_edit_menu(update, context)

async def cancel_input(update: Update, context):
    query = update.callback_query
    await query.answer()
    await query.message.reply_text("‚ùå –í–≤–æ–¥ –æ—Ç–º–µ–Ω–µ–Ω")
    return await show_edit_menu(update, context)

async def cancel_edit(update: Update, context):
    await update.message.reply_text("‚úÖ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ")
    return ConversationHandler.END

import re



# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π
# –ó–∞–º–µ–Ω–∏ –≤–µ—Å—å –±–ª–æ–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –Ω–∞ —ç—Ç–æ—Ç:

# main.py

# ### –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏–Ω–æ—Å—Ç—Ä–∞–Ω—Ü–µ–≤ ###
# main.py

# ### –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–µ—Ä–µ–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ###
# main.py

# ### –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–µ—Ä–µ–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è ###
# --- –°–û–°–¢–û–Ø–ù–ò–Ø –ò –ö–û–ù–°–¢–ê–ù–¢–´ –î–õ–Ø –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò –ò –í–ï–†–ò–§–ò–ö–ê–¶–ò–ò ---

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ, –≥–∏–±–∫–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
# –°—Ç–∞—Ä—ã–π –∫–æ–¥ —Å –æ—à–∏–±–∫–æ–π
# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥
# –ó–ê–ú–ï–ù–ò–¢–ï –°–¢–ê–†–´–ô –ë–õ–û–ö –°–û–°–¢–û–Ø–ù–ò–ô
(
    REG_AWAIT_INPUT, REG_AWAIT_COUNTRY, REG_AWAIT_DOCS,
    REG_AWAIT_VERIFICATION,
    AWAIT_REWORK_REASON, AWAIT_REJECT_REASON,
    REG_AWAIT_LICENSE_CHOICE,   # <-- –ù–û–í–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
    REG_AWAIT_LICENSE_PHOTO     # <-- –ù–û–í–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
) = range(30, 38)



# –ö–ª—é—á–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ user_data
REG_FORM_DATA = 'reg_form_data'
CURRENT_REG_STEP = 'current_reg_step'
MEDIA_GROUP_CACHE = 'media_group_cache'  # <<< –î–û–ë–ê–í–õ–ï–ù–ê –≠–¢–ê –°–¢–†–û–ö–ê

# –®–∞–≥–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ "–º–∞—Å—Ç–µ—Ä–∞")
# –ò–ó–ú–ï–ù–ï–ù–ò–ï: –°–ø–∏—Å–æ–∫ —à–∞–≥–æ–≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–∫—Ä–∞—â–µ–Ω –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ–º
# –ó–ê–ú–ï–ù–ò–¢–ï –°–¢–ê–†–´–ô –°–ü–ò–°–û–ö
REGISTRATION_STEPS = [
    'terms', 'first_name', 'last_name', 'phone_number',
    'has_license', # <-- –ù–û–í–´–ô –®–ê–ì
    'delivery_service', 'select_country', 'documents'
]


(
    EDIT_USER_MENU,               # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ, —Ç–∞—Ä–∏—Ñ—ã)
    EDIT_AWAIT_NAME,              # –û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è
    EDIT_AWAIT_DESCRIPTION,       # –û–∂–∏–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è
    EDIT_TARIFFS_MENU,            # –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ (–ê—Ä–µ–Ω–¥–∞/–í—ã–∫—É–ø)
    AWAIT_RENT_PRICES,            # –û–∂–∏–¥–∞–Ω–∏–µ —Ü–µ–Ω –∞—Ä–µ–Ω–¥—ã (7, 14, 30 –¥–Ω–µ–π)
    AWAIT_BUYOUT_PAYMENTS,        # –û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–ª-–≤–∞ –ø–ª–∞—Ç–µ–∂–µ–π –≤—ã–∫—É–ø–∞
    AWAIT_BUYOUT_AMOUNT,          # –û–∂–∏–¥–∞–Ω–∏–µ —Å—É–º–º—ã –ø–ª–∞—Ç–µ–∂–∞ –≤—ã–∫—É–ø–∞
    AWAIT_BUYOUT_PERIOD,          # –û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–∏–æ–¥–∞ –ø–ª–∞—Ç–µ–∂–∞ –≤—ã–∫—É–ø–∞
    EDIT_AVAILABILITY,            # –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞–ª–∏—á–∏—è
    EDIT_CONFIRM_DELETE_BIKE      # <-- –í–ê–®–ï –ù–û–í–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
) = range(750, 760) # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –Ω–∞ 1

# --- –ì–õ–ê–í–ù–ê–Ø –¢–û–ß–ö–ê –í–•–û–î–ê ---
async def show_bike_list_for_editing(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π.
    –ò–°–ü–†–ê–í–õ–ï–ù–û: –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ "Message not modified".
    """
    page = context.user_data.get('edit_page', 0)
    bikes_per_page = 5
    offset = page * bikes_per_page

    async with aiosqlite.connect(DB_FILE) as conn:
        cursor = await conn.execute("SELECT COUNT(*) FROM bikes")
        total_bikes = (await cursor.fetchone())[0]
        
        cursor = await conn.execute(
            "SELECT id, name FROM bikes ORDER BY name LIMIT ? OFFSET ?",
            (bikes_per_page, offset)
        )
        bikes = await cursor.fetchall()

    keyboard = [[InlineKeyboardButton(b[1], callback_data=f"edit_bike_{b[0]}")] for b in bikes]

    nav = []
    total_pages = (total_bikes + bikes_per_page - 1) // bikes_per_page
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –Ω—É–∂–Ω—ã
    if page > 0: 
        nav.append(InlineKeyboardButton("‚¨ÖÔ∏è", callback_data="edit_page_prev"))
    if page < total_pages - 1: 
        nav.append(InlineKeyboardButton("‚û°Ô∏è", callback_data="edit_page_next"))

    if nav: 
        keyboard.append(nav)
    keyboard.append([InlineKeyboardButton("‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å", callback_data="edit_cancel")])

    text = f"–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–°—Ç—Ä. {page + 1}/{total_pages}):"
    reply_markup = InlineKeyboardMarkup(keyboard)

    # --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ ---
    try:
        if update.callback_query:
            await update.callback_query.edit_message_text(text, reply_markup=reply_markup)
        else:
            await update.message.reply_text(text, reply_markup=reply_markup)
    except telegram.error.BadRequest as e:
        if "Message is not modified" in str(e):
            # –ü—Ä–æ—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —ç—Ç—É –æ—à–∏–±–∫—É, –æ–Ω–∞ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞
            pass
        else:
            # –í—ã–≤–æ–¥–∏–º –≤ –ª–æ–≥ –¥—Ä—É–≥–∏–µ, –±–æ–ª–µ–µ —Å–µ—Ä—å–µ–∑–Ω—ã–µ –æ—à–∏–±–∫–∏
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è ConversationHandler
    return EDIT_USER_MENU

# --- –û–°–ù–û–í–ù–û–ï –ú–ï–ù–Æ –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ---
# REPLACED FUNCTION
async def show_main_edit_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –≤–∫–ª—é—á–∞—è —Å—Ç–∞—Ç—É—Å –Ω–∞–ª–∏—á–∏—è –∏ –∫–Ω–æ–ø–∫—É –¥–ª—è –µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è."""
    query = update.callback_query
    if query:
        await query.answer()
        if query.data.startswith("edit_bike_"):
            context.user_data['editing_bike_id'] = int(query.data.split('_')[-1])

    bike_id = context.user_data['editing_bike_id']
    async with aiosqlite.connect(DB_FILE) as conn:
        conn.row_factory = aiosqlite.Row
        cursor = await conn.execute("SELECT name, available FROM bikes WHERE id = ?", (bike_id,))
        bike = await cursor.fetchone()

    availability_text = "‚úÖ –í –Ω–∞–ª–∏—á–∏–∏" if bike['available'] else "‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏"
    
    text = (
        f"–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –¥–ª—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ *{bike['name']}*?\n\n"
        f"–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: *{availability_text}*"
    )
    # <<< –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô –í –ö–õ–ê–í–ò–ê–¢–£–†–ï >>>
    keyboard = [
        [InlineKeyboardButton("üìù –ù–∞–∑–≤–∞–Ω–∏–µ", callback_data="edit_field_name")],
        [InlineKeyboardButton("‚ÑπÔ∏è –û–ø–∏—Å–∞–Ω–∏–µ", callback_data="edit_field_description")],
        [InlineKeyboardButton("üí∞ –¢–∞—Ä–∏—Ñ—ã", callback_data="edit_field_tariffs")],
        [InlineKeyboardButton("üîÑ –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ", callback_data="edit_field_availability")],
        # –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
        [InlineKeyboardButton("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥", callback_data="edit_action_delete")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ö —Å–ø–∏—Å–∫—É –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤", callback_data="edit_back_to_list")]
    ]
    # <<< –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô –í –ö–õ–ê–í–ò–ê–¢–£–†–ï >>>
    
    message_to_use = query.message if query else update.message
    if hasattr(message_to_use, 'edit_text'):
        await message_to_use.edit_text(
            text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode="Markdown"
        )
    else:
        await context.bot.send_message(
            chat_id=update.effective_chat.id, text=text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode="Markdown"
        )

    return EDIT_USER_MENU

    # ADD THIS NEW CODE BLOCK
async def handle_delete_request(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 1 (–£–¥–∞–ª–µ–Ω–∏–µ): –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–≤–æ–±–æ–¥–µ–Ω –ª–∏ —Ç–æ–≤–∞—Ä, –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ."""
    query = update.callback_query
    await query.answer()
    
    bike_id = context.user_data.get('editing_bike_id')
    
    async with aiosqlite.connect(DB_FILE) as conn:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏ (–∞—Ä–µ–Ω–¥–∞ –∏–ª–∏ –≤—ã–∫—É–ø)
        cursor = await conn.execute("SELECT COUNT(*) FROM bookings WHERE bike_id = ? AND status = 'rented'", (bike_id,))
        active_deals_count = (await cursor.fetchone())[0]

    if active_deals_count > 0:
        await query.answer(
            f"üö´ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å! –≠—Ç–æ—Ç –≤–µ–ª–æ—Å–∏–ø–µ–¥ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ {active_deals_count} –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–∫–∞—Ö.",
            show_alert=True
        )
        return EDIT_USER_MENU # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

    # –ï—Å–ª–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥ —Å–≤–æ–±–æ–¥–µ–Ω, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    keyboard = [
        [InlineKeyboardButton("–î–ê, –£–î–ê–õ–ò–¢–¨", callback_data="confirm_delete_bike_yes")],
        [InlineKeyboardButton("–ù–µ—Ç, –≤–µ—Ä–Ω—É—Ç—å—Å—è", callback_data="confirm_delete_bike_no")]
    ]
    await query.edit_message_text(
        "üö® –í–´ –£–í–ï–†–ï–ù–´?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ —É–¥–∞–ª–∏—Ç –≤–µ–ª–æ—Å–∏–ø–µ–¥ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
    return EDIT_CONFIRM_DELETE_BIKE

async def delete_bike_confirmed(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 2 (–£–¥–∞–ª–µ–Ω–∏–µ): –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ —É–¥–∞–ª—è–µ—Ç —Ç–æ–≤–∞—Ä."""
    query = update.callback_query
    await query.answer()

    if query.data == "confirm_delete_bike_no":
        # –ï—Å–ª–∏ –∞–¥–º–∏–Ω –ø–µ—Ä–µ–¥—É–º–∞–ª, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ –≤ –º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ –∂–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞
        return await show_main_edit_menu(update, context)

    bike_id = context.user_data.get('editing_bike_id')
    
    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            await conn.execute("DELETE FROM bikes WHERE id = ?", (bike_id,))
            await conn.commit()
        
        await query.edit_message_text("‚úÖ –í–µ–ª–æ—Å–∏–ø–µ–¥ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ {bike_id}: {e}", exc_info=True)
        await query.edit_message_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")

    # –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∞–¥–º–∏–Ω–∞ –∫ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–º—É —Å–ø–∏—Å–∫—É –≤—Å–µ—Ö –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤
    await show_bike_list_for_editing(update, context)
    return ConversationHandler.END

# <<< –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê >>>

async def request_availability_change(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –®–∞–≥ 1 (–ù–∞–ª–∏—á–∏–µ): –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –Ω–∞–ª–∏—á–∏—è —É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
    """
    query = update.callback_query
    await query.answer()

    text = "–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –Ω–∞–ª–∏—á–∏—è:"
    keyboard = [
        [
            InlineKeyboardButton("‚úÖ –í –Ω–∞–ª–∏—á–∏–∏", callback_data="set_availability_1"),
            InlineKeyboardButton("‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏", callback_data="set_availability_0")
        ],
        # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –≤–µ—Ä–Ω–µ—Ç –Ω–∞—Å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_edit_menu")]
    ]
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
    
    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –≥–¥–µ –∂–¥–µ–º –Ω–∞–∂–∞—Ç–∏—è –æ–¥–Ω–æ–π –∏–∑ —ç—Ç–∏—Ö –∫–Ω–æ–ø–æ–∫
    return EDIT_AVAILABILITY

async def save_availability(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –®–∞–≥ 2 (–ù–∞–ª–∏—á–∏–µ): –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –≤ –ë–î –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
    """
    query = update.callback_query
    await query.answer()

    # –ï—Å–ª–∏ –∞–¥–º–∏–Ω –Ω–∞–∂–∞–ª "–ù–∞–∑–∞–¥", –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    if "back_to_edit_menu" in query.data:
        return await show_main_edit_menu(update, context)

    # –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å (1 –∏–ª–∏ 0) –∏–∑ callback_data
    new_status = int(query.data.split('_')[-1])
    bike_id = context.user_data['editing_bike_id']

    async with aiosqlite.connect(DB_FILE) as conn:
        await conn.execute("UPDATE bikes SET available = ? WHERE id = ?", (new_status, bike_id))
        await conn.commit()
    
    status_text = "‚úÖ –í –Ω–∞–ª–∏—á–∏–∏" if new_status else "‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏"
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    await query.answer(f"–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: {status_text}", show_alert=True)
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å
    return await show_main_edit_menu(update, context)

# <<< –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê >>>

# --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ù–ê–ó–í–ê–ù–ò–Ø –ò –û–ü–ò–°–ê–ù–ò–Ø ---
async def request_new_value(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—è."""
    query = update.callback_query
    await query.answer()
    field = query.data.split('_')[-1]
    context.user_data['editing_field'] = field
    
    prompt = "–Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" if field == "name" else "–Ω–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"
    await query.message.edit_text(f"–í–≤–µ–¥–∏—Ç–µ {prompt}:")
    
    return EDIT_AWAIT_NAME if field == "name" else EDIT_AWAIT_DESCRIPTION

async def save_text_value(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–æ–≤–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–∏–º—è/–æ–ø–∏—Å–∞–Ω–∏–µ)."""
    field = context.user_data.pop('editing_field')
    bike_id = context.user_data['editing_bike_id']
    new_value = update.message.text

    async with aiosqlite.connect(DB_FILE) as conn:
        await conn.execute(f"UPDATE bikes SET {field} = ? WHERE id = ?", (new_value, bike_id))
        await conn.commit()
    
    await update.message.reply_text(f"‚úÖ {field.capitalize()} —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!")
    return await show_main_edit_menu(update, context)

# --- –ú–ï–ù–Æ –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –¢–ê–†–ò–§–û–í ---
async def show_tariffs_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ —Ç–∞—Ä–∏—Ñ—ã –∏ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∏—Ö —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è."""
    query = update.callback_query
    await query.answer()
    
    bike_id = context.user_data['editing_bike_id']
    async with aiosqlite.connect(DB_FILE) as conn:
        conn.row_factory = aiosqlite.Row
        cursor = await conn.execute("SELECT * FROM bikes WHERE id = ?", (bike_id,))
        bike = await cursor.fetchone()

    text_parts = [
        f"üí∞ *–¢–µ–∫—É—â–∏–µ —Ç–∞—Ä–∏—Ñ—ã –¥–ª—è ¬´{bike['name']}¬ª*\n",
        "*–ê—Ä–µ–Ω–¥–∞:*",
        f" ‚Ä¢ 7 –¥–Ω–µ–π: *{bike['rent_price_7d']} ‚ÇΩ*",
        f" ‚Ä¢ 14 –¥–Ω–µ–π: *{bike['rent_price_14d']} ‚ÇΩ*",
        f" ‚Ä¢ 30 –¥–Ω–µ–π: *{bike['rent_price_30d']} ‚ÇΩ*\n",
        "*–í—ã–∫—É–ø:*",
        f" ‚Ä¢ –ü–ª–∞—Ç–µ–∂–µ–π: *{bike['buyout_total_payments']}*",
        f" ‚Ä¢ –°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞: *{bike['buyout_payment_amount']} ‚ÇΩ*",
        f" ‚Ä¢ –ü–µ—Ä–∏–æ–¥: *–∫–∞–∂–¥—ã–µ {bike['buyout_period_days']} –¥–Ω–µ–π*",
    ]
    
    keyboard = [
        [InlineKeyboardButton("‚úèÔ∏è –†–µ–¥. –ê—Ä–µ–Ω–¥—É", callback_data="tariffs_edit_rent")],
        [InlineKeyboardButton("‚úèÔ∏è –†–µ–¥. –í—ã–∫—É–ø", callback_data="tariffs_edit_buyout")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="tariffs_back_to_main")]
    ]

    await query.message.edit_text(
        "\n".join(text_parts),
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode="Markdown"
    )
    return EDIT_TARIFFS_MENU

# --- –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ê–†–ï–ù–î–´ ---
async def start_rent_edit(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()
    await query.message.edit_text("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–µ —Ü–µ–Ω—ã –¥–ª—è –∞—Ä–µ–Ω–¥—ã –Ω–∞ 7, 14 –∏ 30 –¥–Ω–µ–π —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª.\n\n*–ü—Ä–∏–º–µ—Ä:* `3500 6500 12000`")
    return AWAIT_RENT_PRICES

async def save_rent_prices(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    try:
        prices = [float(p) for p in update.message.text.split()]
        if len(prices) != 3: raise ValueError
    except ValueError:
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞. –í–≤–µ–¥–∏—Ç–µ 3 —á–∏—Å–ª–∞ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        return AWAIT_RENT_PRICES

    async with aiosqlite.connect(DB_FILE) as conn:
        await conn.execute(
            "UPDATE bikes SET rent_price_7d = ?, rent_price_14d = ?, rent_price_30d = ? WHERE id = ?",
            (*prices, context.user_data['editing_bike_id'])
        )
        await conn.commit()
        
    await update.message.reply_text("‚úÖ –¢–∞—Ä–∏—Ñ—ã –∞—Ä–µ–Ω–¥—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã!")
    return await show_tariffs_menu(update, context)

# --- –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –í–´–ö–£–ü–ê (–ø–æ—à–∞–≥–æ–≤—ã–π –≤–≤–æ–¥) ---
async def start_buyout_edit(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()
    await query.message.edit_text("–í–≤–µ–¥–∏—Ç–µ *–æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ* –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π –¥–ª—è –≤—ã–∫—É–ø–∞:")
    return AWAIT_BUYOUT_PAYMENTS

async def get_buyout_payments(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    try:
        context.user_data['new_buyout_payments'] = int(update.message.text)
        await update.message.reply_text("–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ *—Å—É–º–º—É –æ–¥–Ω–æ–≥–æ* –ø–ª–∞—Ç–µ–∂–∞:")
        return AWAIT_BUYOUT_AMOUNT
    except ValueError:
        await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ.")
        return AWAIT_BUYOUT_PAYMENTS

async def get_buyout_amount(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    try:
        context.user_data['new_buyout_amount'] = float(update.message.text)
        await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ *–ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å* –ø–ª–∞—Ç–µ–∂–µ–π –≤ –¥–Ω—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, 7 –¥–ª—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã—Ö):")
        return AWAIT_BUYOUT_PERIOD
    except ValueError:
        await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É.")
        return AWAIT_BUYOUT_AMOUNT

async def save_buyout_plan(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    try:
        period = int(update.message.text)
        bike_id = context.user_data['editing_bike_id']
        total_payments = context.user_data['new_buyout_payments']
        payment_amount = context.user_data['new_buyout_amount']

        async with aiosqlite.connect(DB_FILE) as conn:
            await conn.execute(
                "UPDATE bikes SET buyout_total_payments = ?, buyout_payment_amount = ?, buyout_period_days = ? WHERE id = ?",
                (total_payments, payment_amount, period, bike_id)
            )
            await conn.commit()

        await update.message.reply_text("‚úÖ –ü–ª–∞–Ω –≤—ã–∫—É–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω!")
        return await show_tariffs_menu(update, context)
    except ValueError:
        await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –¥–Ω–µ–π.")
        return AWAIT_BUYOUT_PERIOD

# --- –§–£–ù–ö–¶–ò–Ø –û–¢–ú–ï–ù–´ ---
async def cancel_edit_bike(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ó–∞–≤–µ—Ä—à–∞–µ—Ç –¥–∏–∞–ª–æ–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è."""
    query = update.callback_query
    await query.answer()
    await query.message.edit_text("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ.")
    context.user_data.clear()
    return ConversationHandler.END

async def handle_screenshot_input(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —à–∞–≥–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞.
    """
    step_key = 'courier_app_screenshot'
    form_data = context.user_data.setdefault(REG_FORM_DATA, {})

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º file_id —Ñ–æ—Ç–æ
    form_data[step_key] = update.message.photo[-1].file_id
    await update.message.reply_text("üëç –°–∫—Ä–∏–Ω—à–æ—Ç –ø—Ä–∏–Ω—è—Ç!")

    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
    current_step_index = REGISTRATION_STEPS.index(step_key)
    context.user_data[CURRENT_REG_STEP] = REGISTRATION_STEPS[current_step_index + 1]
    return await display_registration_step(update, context)
# --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –®–ê–ì–û–í ---
async def cancel_registration(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û—Ç–º–µ–Ω—è–µ—Ç –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –¥–∏–∞–ª–æ–≥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏."""
    user_id = update.effective_user.id
    if update.callback_query:
        await update.callback_query.answer()
        await update.callback_query.edit_message_text("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.")
    else:
        await update.message.reply_text("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.")

    context.user_data.clear()
    await context.bot.send_message(user_id, "–í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", reply_markup=get_main_menu(user_id))
    return ConversationHandler.END


async def cancel_admin_action(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–º–µ–Ω—ã –∞–¥–º–∏–Ω—Å–∫–∏—Ö –¥–∏–∞–ª–æ–≥–æ–≤ (–¥–æ—Ä–∞–±–æ—Ç–∫–∞/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ).
    """
    await update.effective_message.reply_text("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    context.user_data.clear()
    return ConversationHandler.END
# ==============================================================================
# –ü–û–õ–ù–ê–Ø –ò –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø display_registration_step (–ó–ê–ú–ï–ù–ò–¢–ï –°–¢–ê–†–£–Æ)
# ==============================================================================

# ==============================================================================
# –ü–û–õ–ù–ê–Ø –ò –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø display_registration_step (–ó–ê–ú–ï–ù–ò–¢–¨ –°–¢–ê–†–£–Æ)
# ==============================================================================

# ==============================================================================
# –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø display_registration_step (–ë–ï–ó –ù–£–ú–ï–†–ê–¶–ò–ò)
# ==============================================================================

async def display_registration_step(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —à–∞–≥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –±–µ–∑ –Ω—É–º–µ—Ä–∞—Ü–∏–∏ —à–∞–≥–æ–≤.
    """
    step_key = context.user_data.get(CURRENT_REG_STEP)
    message = update.effective_message
    chat_id = update.effective_chat.id

    text = ""
    keyboard_buttons = []
    use_reply_keyboard = False
    reply_markup = None

    # --- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ ---
    nav_buttons = []
    # –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥" –Ω–∞ –ø–µ—Ä–≤–æ–º —à–∞–≥–µ –∏ –ø–æ—Å–ª–µ –∑–∞–ø—Ä–æ—Å–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    if step_key not in ['terms', 'phone_number']:
        nav_buttons.append(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="reg_nav_back"))
    nav_buttons.append(InlineKeyboardButton("üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ", callback_data="reg_nav_restart"))

    # --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ (–±–µ–∑ –Ω—É–º–µ—Ä–∞—Ü–∏–∏) ---
    if step_key == 'terms':
        text = (
            "üîí *–°–æ–≥–ª–∞—Å–∏–µ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö*\n\n"
            "–ù–∞–∂–∏–º–∞—è ¬´‚úÖ –ü—Ä–∏–Ω–∏–º–∞—é —É—Å–ª–æ–≤–∏—è¬ª, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å [–æ–±—Ä–∞–±–æ—Ç–∫–æ–π –≤–∞—à–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö](https://badfoxbike.ru/privacy-policy.html) –∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ —Å–µ—Ä–≤–∏—Å–∞\\."
        )
        keyboard_buttons.append([InlineKeyboardButton("‚úÖ –ü—Ä–∏–Ω–∏–º–∞—é —É—Å–ª–æ–≤–∏—è", callback_data="reg_input_accept_terms")])

    elif step_key == 'first_name':
        text = "‚úçÔ∏è *–í–∞—à–µ –∏–º—è*\n\n–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è, –∫–∞–∫ –≤ –ø–∞—Å–ø–æ—Ä—Ç–µ \\(–Ω–∞–ø—Ä–∏–º–µ—Ä, _–ò–≤–∞–Ω_\\)\\."

    elif step_key == 'last_name':
        text = "‚úçÔ∏è *–í–∞—à–∞ —Ñ–∞–º–∏–ª–∏—è*\n\n–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ñ–∞–º–∏–ª–∏—é \\(–Ω–∞–ø—Ä–∏–º–µ—Ä, _–ò–≤–∞–Ω–æ–≤_\\)\\."

    elif step_key == 'phone_number':
        use_reply_keyboard = True
        text = "üì± *–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞*\n\n–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≤—Ä—É—á–Ω—É—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ `+7...`"
        reply_markup = ReplyKeyboardMarkup(
            [[KeyboardButton("üì≤ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–º", request_contact=True)]],
            resize_keyboard=True, one_time_keyboard=True
        )
    
    # --- –ù–û–í–´–ô –ë–õ–û–ö –î–õ–Ø –í–û–î–ò–¢–ï–õ–¨–°–ö–ò–• –ü–†–ê–í ---
    elif step_key == 'has_license':
        text = "üöô *–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∞*\n\n–ï—Å—Ç—å –ª–∏ —É –≤–∞—Å –≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∞?"
        keyboard_buttons.extend([
            [InlineKeyboardButton("‚úÖ –î–∞, –µ—Å—Ç—å", callback_data="reg_license_yes")],
            [InlineKeyboardButton("‚ùå –ù–µ—Ç", callback_data="reg_license_no")]
        ])
    # --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê ---

    elif step_key == 'delivery_service':
        text = "üöö *–ú–µ—Å—Ç–æ —Ä–∞–±–æ—Ç—ã*\n\n–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É —Å–ª—É–∂–±—É –¥–æ—Å—Ç–∞–≤–∫–∏:"
        keyboard_buttons.extend([
            [InlineKeyboardButton("üåø –í–∫—É—Å–í–∏–ª–ª", callback_data='reg_input_–í–∫—É—Å–í–∏–ª–ª')],
            [InlineKeyboardButton("üü° –Ø–Ω–¥–µ–∫—Å –ï–¥–∞/–õ–∞–≤–∫–∞", callback_data='reg_input_–Ø–Ω–¥–µ–∫—Å')],
            [InlineKeyboardButton("üî¥ –ú–∞–≥–Ω–∏—Ç –î–æ—Å—Ç–∞–≤–∫–∞", callback_data='reg_input_–ú–∞–≥–Ω–∏—Ç')],
            [InlineKeyboardButton("üçî –ë—É—Ä–≥–µ—Ä –ö–∏–Ω–≥ / KFC", callback_data='reg_input_–ë—É—Ä–≥–µ—Ä –ö–∏–Ω–≥/KFC')],
            [InlineKeyboardButton("üõ¥ –°–∞–º–æ–∫–∞—Ç", callback_data='reg_input_–°–∞–º–æ–∫–∞—Ç')],
            [InlineKeyboardButton("üçè –î—Ä—É–≥–æ–π –º–∞–≥–∞–∑–∏–Ω", callback_data='reg_input_–î—Ä—É–≥–æ–π –º–∞–≥–∞–∑–∏–Ω')],
            [InlineKeyboardButton("‚ùì –î—Ä—É–≥–∞—è —Å–ª—É–∂–±–∞", callback_data='reg_input_–î—Ä—É–≥–æ–µ')],
        ])

    elif step_key == 'select_country':
        text = "üåç *–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ*\n\n–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à–µ –≥—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ:"
        keyboard_buttons.extend([
            [InlineKeyboardButton("üá∑üá∫ –†–æ—Å—Å–∏–π—Å–∫–∞—è –§–µ–¥–µ—Ä–∞—Ü–∏—è", callback_data="reg_country_–†–§")],
            [InlineKeyboardButton("üåç –î—Ä—É–≥–∞—è —Å—Ç—Ä–∞–Ω–∞", callback_data="reg_country_–î—Ä—É–≥–∞—è")]
        ])

    elif step_key == 'documents':
        country = context.user_data.get(REG_FORM_DATA, {}).get('country')
        doc_list_raw = ""
        photos_count_text = ""
        if country == '–†–§':
            doc_list_raw = "1. –û—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–∑–≤–æ—Ä–æ—Ç –ø–∞—Å–ø–æ—Ä—Ç–∞.\n2. –†–∞–∑–≤–æ—Ä–æ—Ç —Å –ø—Ä–æ–ø–∏—Å–∫–æ–π."
            photos_count_text = "–æ—Ç–ø—Ä–∞–≤—å—Ç–µ *2 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏*"
        else:
            doc_list_raw = "1. –û—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–∑–≤–æ—Ä–æ—Ç –ø–∞—Å–ø–æ—Ä—Ç–∞.\n2. –î–æ–∫—É–º–µ–Ω—Ç –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ –†–§.\n3. –ü–∞—Ç–µ–Ω—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É."
            photos_count_text = "–æ—Ç–ø—Ä–∞–≤—å—Ç–µ *3 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏*"

        doc_list_escaped = escape_markdown(doc_list_raw, version=2)

        text = (
            f"üì∏ *–î–æ–∫—É–º–µ–Ω—Ç—ã*\n\n"
            f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, *–û–î–ù–ò–ú –°–û–û–ë–©–ï–ù–ò–ï–ú* {photos_count_text}:\n{doc_list_escaped}\n\n"
            f"üí° _–í—ã–¥–µ–ª–∏—Ç–µ –Ω—É–∂–Ω—ã–µ —Ñ–æ—Ç–æ –≤ –≥–∞–ª–µ—Ä–µ–µ –∏ –Ω–∞–∂–º–∏—Ç–µ '–û—Ç–ø—Ä–∞–≤–∏—Ç—å'_\\."
        )

    # --- –°–±–æ—Ä–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è ---
    if not use_reply_keyboard:
        if nav_buttons:
            keyboard_buttons.append(nav_buttons)
        if keyboard_buttons:
            reply_markup = InlineKeyboardMarkup(keyboard_buttons)

    try:
        if update.callback_query:
            await message.edit_text(text, reply_markup=reply_markup, parse_mode="MarkdownV2", disable_web_page_preview=True)
        else:
            # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å ReplyKeyboard, –µ—Å–ª–∏ –æ–Ω–æ –±—ã–ª–æ
            if step_key == 'has_license' and context.user_data.get('last_reply_message_id'):
                 try:
                     await context.bot.delete_message(chat_id, context.user_data.pop('last_reply_message_id'))
                 except: pass

            sent_message = await context.bot.send_message(chat_id, text, reply_markup=reply_markup, parse_mode="MarkdownV2", disable_web_page_preview=True)
            if use_reply_keyboard:
                context.user_data['last_reply_message_id'] = sent_message.message_id
    except Exception as e:
        if "Message is not modified" not in str(e):
            logger.error(f"–û—à–∏–±–∫–∞ –≤ display_registration_step: {e}")

    # --- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è ConversationHandler ---
    if step_key == 'select_country':
        return REG_AWAIT_COUNTRY
    if step_key == 'documents':
        return REG_AWAIT_DOCS
    if step_key == 'has_license':
        return REG_AWAIT_LICENSE_CHOICE
    else:
        return REG_AWAIT_INPUT
    
# –î–û–ë–ê–í–¨–¢–ï –≠–¢–ò –î–í–ï –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –í –í–ê–® –ö–û–î

async def handle_license_choice(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä '–î–∞/–ù–µ—Ç' –æ –Ω–∞–ª–∏—á–∏–∏ –≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–∞–≤."""
    query = update.callback_query
    await query.answer()

    choice = query.data.split('_')[-1] # yes –∏–ª–∏ no
    form_data = context.user_data.setdefault(REG_FORM_DATA, {})
    form_data['has_license'] = "–î–∞" if choice == "yes" else "–ù–µ—Ç"

    if choice == "yes":
        # –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–∞–≤–∞, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ñ–æ—Ç–æ
        await query.message.edit_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –≤–∞—à–∏—Ö –≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–∞–≤.")
        return REG_AWAIT_LICENSE_PHOTO
    else:
        # –ï—Å–ª–∏ –ø—Ä–∞–≤ –Ω–µ—Ç, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
        current_step_index = REGISTRATION_STEPS.index('has_license')
        context.user_data[CURRENT_REG_STEP] = REGISTRATION_STEPS[current_step_index + 1]
        return await display_registration_step(update, context)

async def handle_license_photo(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ñ–æ—Ç–æ –≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö –ø—Ä–∞–≤ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É."""
    if not update.message or not update.message.photo:
        await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–º–µ–Ω–Ω–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é.")
        return REG_AWAIT_LICENSE_PHOTO

    form_data = context.user_data.setdefault(REG_FORM_DATA, {})
    form_data['license_photo_file_id'] = update.message.photo[-1].file_id
    await update.message.reply_text("‚úÖ –§–æ—Ç–æ –ø—Ä–∞–≤ –ø—Ä–∏–Ω—è—Ç–æ!")

    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
    current_step_index = REGISTRATION_STEPS.index('has_license')
    context.user_data[CURRENT_REG_STEP] = REGISTRATION_STEPS[current_step_index + 1]
    return await display_registration_step(update, context)

# --- –¢–û–ß–ö–ò –í–•–û–î–ê –ò –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ---

async def register(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ù–∞—á–∏–Ω–∞–µ—Ç –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏."""
    context.user_data.clear()
    context.user_data[CURRENT_REG_STEP] = 'terms'
    context.user_data[REG_FORM_DATA] = {}
    return await display_registration_step(update, context)

async def handle_registration_nav(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏—é: –ù–∞–∑–∞–¥ –∏ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ."""
    query = update.callback_query
    await query.answer()
    action = query.data.split('_')[-1]

    if action == 'restart':
        await register(update, context) # –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å
        return REG_AWAIT_INPUT

    elif action == 'back':
        current_step_index = REGISTRATION_STEPS.index(context.user_data.get(CURRENT_REG_STEP))
        if current_step_index > 0:
            # –ü—Ä–æ—Å—Ç–æ —É–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ —à–∞–≥ –Ω–∞–∑–∞–¥
            last_step_key = REGISTRATION_STEPS[current_step_index - 1]
            context.user_data.get(REG_FORM_DATA, {}).pop(last_step_key, None)
            context.user_data[CURRENT_REG_STEP] = last_step_key

    return await display_registration_step(update, context)

async def handle_registration_input(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ª—é–±–æ–π –≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Ç–µ–∫—É—â–µ–º —à–∞–≥–µ."""
    step_key = context.user_data.get(CURRENT_REG_STEP)
    form_data = context.user_data.setdefault(REG_FORM_DATA, {})

    user_input = None
    if update.callback_query:
        await update.callback_query.answer()
        if update.callback_query.data.startswith("reg_input_"):
            user_input = update.callback_query.data.replace("reg_input_", "")
    elif update.message:
        if update.message.text: user_input = update.message.text.strip()
        elif update.message.contact:
            raw_phone = update.message.contact.phone_number
            user_input = '+' + re.sub(r"[^\d]", "", raw_phone)
        elif update.message.photo:
            user_input = update.message.photo[-1].file_id

    # –í–∞–ª–∏–¥–∞—Ü–∏—è
    # (–ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏, –∫–∞–∫ –≤ –≤–∞—à–∏—Ö —Å—Ç–∞—Ä—ã—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö)
    if user_input:
        form_data[step_key] = user_input
        if step_key == 'phone_number':
             await update.message.reply_text(f"‚úÖ –ù–æ–º–µ—Ä –ø—Ä–∏–Ω—è—Ç.", reply_markup=ReplyKeyboardRemove())
    else:
        # –ï—Å–ª–∏ –≤–≤–æ–¥ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–µ–∫—Å—Ç –≤–º–µ—Å—Ç–æ —Ñ–æ—Ç–æ), –ø—Ä–æ—Å—Ç–æ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        return REG_AWAIT_INPUT

    # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
    current_step_index = REGISTRATION_STEPS.index(step_key)
    context.user_data[CURRENT_REG_STEP] = REGISTRATION_STEPS[current_step_index + 1]
    return await display_registration_step(update, context)

# –ó–∞–º–µ–Ω–∏—Ç–µ –≤–∞—à—É —Å—Ç–∞—Ä—É—é —Ñ—É–Ω–∫—Ü–∏—é handle_country_selection –Ω–∞ —ç—Ç—É

# ==============================================================================
# –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø handle_country_selection
# ==============================================================================
async def handle_country_selection(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —Å—Ç—Ä–∞–Ω—ã.
    –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ "–î—Ä—É–≥–∞—è —Å—Ç—Ä–∞–Ω–∞", –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –ò–õ–ò –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å.
    """
    query = update.callback_query
    await query.answer()

    country = query.data.split('_')[-1]
    form_data = context.user_data.setdefault(REG_FORM_DATA, {})
    form_data['country'] = country

    # --- –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨ ---

    if country == '–†–§':
        # –î–ª—è –≥—Ä–∞–∂–¥–∞–Ω –†–§ —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –±–µ–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
        context.user_data[CURRENT_REG_STEP] = 'documents'
        return await display_registration_step(update, context)

    elif country == '–î—Ä—É–≥–∞—è':
        # –î–ª—è –∏–Ω–æ—Å—Ç—Ä–∞–Ω—Ü–µ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–π —ç–∫—Ä–∞–Ω —Å –≤—ã–±–æ—Ä–æ–º: –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å
        text = "üåç –í—ã –≤—ã–±—Ä–∞–ª–∏ '–î—Ä—É–≥–∞—è —Å—Ç—Ä–∞–Ω–∞'.\n\n–î–∞–ª—å–Ω–µ–π—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:"
        keyboard = [
            # –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            [InlineKeyboardButton("üì∏ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã", callback_data="reg_action_uploaddocs")],
            # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞
            [InlineKeyboardButton("‚è© –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç—Ç–æ—Ç —à–∞–≥", callback_data="reg_action_skipdocs")]
        ]
        await query.message.edit_text(text, reply_markup=InlineKeyboardMarkup(keyboard))

        # –ú—ã –æ—Å—Ç–∞–µ–º—Å—è –≤ —Ç–æ–º –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –Ω–æ –∂–¥–µ–º –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –æ–¥–Ω—É –∏–∑ –Ω–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫
        return REG_AWAIT_COUNTRY

# ==============================================================================
# –ù–û–í–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–õ–Ø –î–ï–ô–°–¢–í–ò–ô –ò–ù–û–°–¢–†–ê–ù–¶–ê
# ==============================================================================
async def handle_foreigner_doc_action(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω–æ–≥–æ –≥—Ä–∞–∂–¥–∞–Ω–∏–Ω–∞: –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å.
    """
    query = update.callback_query
    await query.answer()

    action = query.data.split('_')[-1] # uploaddocs –∏–ª–∏ skipdocs
    form_data = context.user_data.get(REG_FORM_DATA, {})

    if action == 'uploaddocs':
        # –ï—Å–ª–∏ —Ä–µ—à–∏–ª–∏ –∑–∞–≥—Ä—É–∂–∞—Ç—å, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —à–∞–≥ 'documents'
        context.user_data[CURRENT_REG_STEP] = 'documents'
        return await display_registration_step(update, context)

    elif action == 'skipdocs':
        # –ï—Å–ª–∏ —Ä–µ—à–∏–ª–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å, –≤—ã–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å –ø—É—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        await query.message.edit_text("‚úÖ –í—ã –ø—Ä–æ–ø—É—Å—Ç–∏–ª–∏ —à–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤. –ó–∞–≤–µ—Ä—à–∞—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é...")
        await finalize_registration_and_save(
            chat_id=query.message.chat_id,
            user_id=query.from_user.id,
            form_data=form_data,
            recognized_data={"—Å—Ç–∞—Ç—É—Å": "–î–æ–∫—É–º–µ–Ω—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã"},
            context=context
        )
        return ConversationHandler.END

# --- –û–ë–†–ê–ë–û–¢–ö–ê –ì–†–£–ü–ü–´ –§–û–¢–û ---
# –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤ –±–ª–æ–∫ —Å –¥—Ä—É–≥–∏–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

async def handle_verification_result(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ —Å–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å Gemini."""
    query = update.callback_query
    await query.answer()

    if query.data == 'reg_verify_ok':
        # –ï—Å–ª–∏ –≤—Å–µ –≤–µ—Ä–Ω–æ, –≤—ã–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        await query.message.edit_text("–û—Ç–ª–∏—á–Ω–æ! –°–æ—Ö—Ä–∞–Ω—è—é –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å...")
        # –ü–µ—Ä–µ–¥–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
        await finalize_registration_and_save(
            chat_id=query.message.chat_id,
            user_id=query.from_user.id,
            form_data=context.user_data.get(REG_FORM_DATA, {}),
            recognized_data=context.user_data.get('recognized_passport_data', {}),
            context=context
        )
        return ConversationHandler.END # –ó–∞–≤–µ—Ä—à–∞–µ–º –¥–∏–∞–ª–æ–≥

    elif query.data == 'reg_verify_retry':
        # –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–Ω–æ–≤–æ, –æ—á–∏—â–∞–µ–º –∫—ç—à —Ñ–æ—Ç–æ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ —à–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏
        context.user_data.pop(MEDIA_GROUP_CACHE, None)
        context.user_data[CURRENT_REG_STEP] = 'documents'
        return await display_registration_step(update, context)
# ==============================================================================
# –£–ü–†–û–©–ï–ù–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –§–û–¢–û (–ó–ê–ú–ï–ù–ò–¢–¨ –°–¢–ê–†–´–ô)
# ==============================================================================
# ==============================================================================
# –ü–û–õ–ù–ê–Ø –†–ê–ë–û–ß–ê–Ø –í–ï–†–°–ò–Ø handle_document_photos (–ó–ê–ú–ï–ù–ò–¢–¨ –°–¢–ê–†–£–Æ)
# ==============================================================================
# ==============================================================================
# –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø handle_document_photos (—Å —Ä–∞–∑–Ω—ã–º –∫–æ–ª-–≤–æ–º —Ñ–æ—Ç–æ)
# ==============================================================================
# ==============================================================================
# –§–ò–ù–ê–õ–¨–ù–ê–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø handle_document_photos
# ==============================================================================
# ==============================================================================
# –§–ò–ù–ê–õ–¨–ù–ê–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø handle_document_photos
# ==============================================================================
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ –≤–∞—à–µ–≥–æ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
from pathlib import Path
import os
import json
import google.generativeai as genai
from google.generativeai.types import HarmCategory, HarmBlockThreshold
from PIL import Image
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes

# ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –≤–∞—à–∏ –∏–º–ø–æ—Ä—Ç—ã –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã) ...

async def handle_document_photos(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –û–î–ù–£ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é, –∫—ç—à–∏—Ä—É–µ—Ç –µ–µ –∏, –µ—Å–ª–∏ –≤—Å–µ —Ñ–æ—Ç–æ —Å–æ–±—Ä–∞–Ω—ã,
    –∑–∞–ø—É—Å–∫–∞–µ—Ç Gemini, —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —à–∞–≥—É –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏.
    """
    message = update.message
    user_id = message.from_user.id

    if MEDIA_GROUP_CACHE not in context.user_data:
        context.user_data[MEDIA_GROUP_CACHE] = []

    context.user_data[MEDIA_GROUP_CACHE].append(message.photo[-1].file_id)
    photo_count = len(context.user_data[MEDIA_GROUP_CACHE])

    # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨ ---
    country = context.user_data.get(REG_FORM_DATA, {}).get('country')
    required_photos = 3 if country != '–†–§' else 2

    if photo_count < required_photos:
        await message.reply_text(f"‚úÖ –§–æ—Ç–æ {photo_count}/{required_photos} –ø—Ä–∏–Ω—è—Ç–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ.")
        return REG_AWAIT_DOCS
    # --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---

    await message.reply_text(f"‚úÖ –í—Å–µ {required_photos} —Ñ–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω—ã. –ó–∞–ø—É—Å–∫–∞—é —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 45 —Å–µ–∫—É–Ω–¥. üïí")

    photo_ids = context.user_data.pop(MEDIA_GROUP_CACHE)
    context.user_data[REG_FORM_DATA]['document_file_ids'] = photo_ids

    temp_dir = Path("temp_passport_photos")
    temp_dir.mkdir(exist_ok=True)
    paths = []

    try:
        for i, file_id in enumerate(photo_ids):
            photo_file = await context.bot.get_file(file_id)
            path = temp_dir / f"{user_id}_doc_{i+1}.jpg"
            await photo_file.download_to_drive(path)
            paths.append(str(path))

        recognized_data = {}

        safety_settings = {
            HarmCategory.HARM_CATEGORY_HARASSMENT: HarmBlockThreshold.BLOCK_NONE,
            HarmCategory.HARM_CATEGORY_HATE_SPEECH: HarmBlockThreshold.BLOCK_NONE,
            HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT: HarmBlockThreshold.BLOCK_NONE,
            HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT: HarmBlockThreshold.BLOCK_NONE,
        }
        model = genai.GenerativeModel('gemini-2.5-flash-lite', safety_settings=safety_settings)
        images_for_gemini = [Image.open(p) for p in paths]

        # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨ (–ü—Ä–æ–º–ø—Ç –¥–ª—è –∏–Ω–æ—Å—Ç—Ä–∞–Ω—Ü–µ–≤) ---
        if country == '–†–§':
            prompt = """
            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–∏ —Ç—Ä–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: –æ—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–∑–≤–æ—Ä–æ—Ç –ø–∞—Å–ø–æ—Ä—Ç–∞ –†–§, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –ø—Ä–æ–ø–∏—Å–∫–æ–π –∏ —Å–µ–ª—Ñ–∏ —Å –ø–∞—Å–ø–æ—Ä—Ç–æ–º.
            –ò–∑–≤–ª–µ–∫–∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ –≤–µ—Ä–Ω–∏ –∏—Ö –≤ –≤–∏–¥–µ –û–î–ù–û–ì–û –ø–ª–æ—Å–∫–æ–≥–æ JSON –æ–±—ä–µ–∫—Ç–∞.
            –ö–ª—é—á–∏: "–§–∞–º–∏–ª–∏—è", "–ò–º—è", "–û—Ç—á–µ—Å—Ç–≤–æ", "–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è", "–°–µ—Ä–∏—è –∏ –Ω–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞", "–ö–µ–º –≤—ã–¥–∞–Ω", "–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏", "–ê–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏".
            –ï—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π.
            –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ–ª—å–∫–æ —á–∏—Å—Ç—ã–º JSON.
            """
        else:
            prompt = """
            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–∏ —á–µ—Ç—ã—Ä–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: –ø–∞—Å–ø–æ—Ä—Ç –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω–æ–≥–æ –≥—Ä–∞–∂–¥–∞–Ω–∏–Ω–∞, —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –†–§, –ø–∞—Ç–µ–Ω—Ç –∏ —Å–µ–ª—Ñ–∏ —Å –ø–∞—Å–ø–æ—Ä—Ç–æ–º.
            –ò–∑–≤–ª–µ–∫–∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ –≤–µ—Ä–Ω–∏ –∏—Ö –≤ –≤–∏–¥–µ –û–î–ù–û–ì–û –ø–ª–æ—Å–∫–æ–≥–æ JSON –æ–±—ä–µ–∫—Ç–∞.
            –ö–ª—é—á–∏: "–§–ò–û", "–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ", "–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è", "–ù–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞", "–ê–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ –†–§", "–ù–æ–º–µ—Ä –ø–∞—Ç–µ–Ω—Ç–∞".
            –ï—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –∑–Ω–∞—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π.
            –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–æ–ª—å–∫–æ —á–∏—Å—Ç—ã–º JSON.
            """
        # --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---

        response = model.generate_content([prompt] + images_for_gemini, request_options={"timeout": 120})
        response.resolve()

        cleaned_text = response.text.strip().replace("`", "").lstrip("json").strip()
        recognized_data = json.loads(cleaned_text)

        if not recognized_data or not isinstance(recognized_data, dict):
            raise ValueError("Gemini –Ω–µ –≤–µ—Ä–Ω—É–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å.")

        context.user_data['recognized_passport_data'] = recognized_data

        verification_text = "ü§ñ **–î–∞–≤–∞–π—Ç–µ —Å–≤–µ—Ä–∏–º –¥–∞–Ω–Ω—ã–µ:**\n\n"
        for key, value in recognized_data.items():
            if value:
                verification_text += f"‚ñ™Ô∏è {escape_markdown(key, 2)}: `{escape_markdown(str(value), 2)}`\n"
        verification_text += "\n–í—Å–µ –ª–∏ –¥–∞–Ω–Ω—ã–µ –≤–µ—Ä–Ω—ã?"

        keyboard = [
            [InlineKeyboardButton("‚úÖ –î–∞, –≤—Å—ë –≤–µ—Ä–Ω–æ", callback_data="reg_verify_ok")],
            [InlineKeyboardButton("üîÑ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –∑–∞–Ω–æ–≤–æ", callback_data="reg_verify_retry")],
        ]

        await message.reply_text(verification_text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode="MarkdownV2")

        return REG_AWAIT_VERIFICATION

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è {user_id}: {e}", exc_info=True)
        await message.reply_text("üòî –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —Å –±–æ–ª–µ–µ —á–µ—Ç–∫–∏–º–∏ —Ñ–æ—Ç–æ. –ù–∞–∂–º–∏—Ç–µ '‚¨ÖÔ∏è –ù–∞–∑–∞–¥', —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —à–∞–≥—É –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.")
        context.user_data.pop(MEDIA_GROUP_CACHE, None)
        return REG_AWAIT_DOCS
    finally:
        for p in paths:
            if os.path.exists(p):
                try:
                    os.remove(p)
                except OSError as e:
                    logger.error(f"–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ {p}: {e}")




async def process_document_group(context: ContextTypes.DEFAULT_TYPE):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ, –∑–∞–ø—É—Å–∫–∞–µ—Ç Gemini –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏,
    –∏—Å–ø–æ–ª—å–∑—É—è –¥–∞–Ω–Ω—ã–µ, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∏–∑ JobQueue.
    """
    job = context.job
    # <<< –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ job.data
    chat_id = job.chat_id
    media_group_id = job.data['media_group_id']
    user_id = job.data['user_id']
    form_data = job.data['form_data']
    current_reg_step = job.data['current_reg_step']
    # <<< –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>

    media_group_data = context.bot_data.pop(media_group_id, None)
    if not media_group_data: return

    photo_ids = media_group_data['photos']

    if len(photo_ids) != 3:
        await context.bot.send_message(
            chat_id,
            f"‚ùå **–û—à–∏–±–∫–∞!** –í—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ {len(photo_ids)} —Ñ–æ—Ç–æ, –∞ –Ω—É–∂–Ω–æ —Ä–æ–≤–Ω–æ 3. "
            "–ù–∞–∂–º–∏—Ç–µ '‚¨ÖÔ∏è –ù–∞–∑–∞–¥', —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —à–∞–≥—É –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤."
        )
        return

    await context.bot.send_message(chat_id, "‚úÖ 3 —Ñ–æ—Ç–æ –ø–æ–ª—É—á–µ–Ω—ã. –ó–∞–ø—É—Å–∫–∞—é —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 45 —Å–µ–∫—É–Ω–¥. üïí")

    # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ú—ã —É–∂–µ –ø–æ–ª—É—á–∏–ª–∏ form_data, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–µ–≥–æ file_ids >>>
    form_data['document_file_ids'] = photo_ids

    # --- –õ–æ–≥–∏–∫–∞ Gemini ---
    temp_dir = Path("temp_passport_photos")
    temp_dir.mkdir(exist_ok=True)
    paths = []
    try:
        for i, file_id in enumerate(photo_ids):
            photo_file = await context.bot.get_file(file_id)
            path = temp_dir / f"{user_id}_doc_{i+1}.jpg"
            await photo_file.download_to_drive(path)
            paths.append(str(path))

        country = form_data.get('country')
        recognized_data = {}
        if country == '–†–§':
            recognized_data = get_passport_data_with_gemini(image_path=paths[0])
            reg_data = get_registration_data_with_gemini(image_path=paths[1])
            if reg_data: recognized_data.update(reg_data)
        else:
            recognized_data = get_foreign_documents_data_with_gemini(paths[0], paths[1], paths[2])

        if not recognized_data: raise ValueError("Gemini –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ.")

        # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í—ã–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –ø–µ—Ä–µ–¥–∞–≤–∞—è –µ–π –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —è–≤–Ω–æ >>>
        await finalize_registration_and_save(chat_id, user_id, form_data, recognized_data, context)

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è {chat_id}: {e}", exc_info=True)
        await context.bot.send_message(chat_id, "üòî –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —Å –±–æ–ª–µ–µ —á–µ—Ç–∫–∏–º–∏ —Ñ–æ—Ç–æ. –ù–∞–∂–º–∏—Ç–µ '‚¨ÖÔ∏è –ù–∞–∑–∞–¥'.")
    finally:
        for p in paths:
            if os.path.exists(p): os.remove(p)
# <<< –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê –î–õ–Ø –û–ë–†–ê–ë–û–¢–ö–ò –í–ï–†–ò–§–ò–ö–ê–¶–ò–ò >>>
# ==============================================================================
# –ü–û–õ–ù–ê–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø finalize_registration_and_save
# ==============================================================================

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

async def finalize_registration_and_save(chat_id: int, user_id: int, form_data: dict, recognized_data: dict, context: ContextTypes.DEFAULT_TYPE):
    """
    –§–∏–Ω–∞–ª—å–Ω–∞—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:
    1. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–æ—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–≤–∫–ª—é—á–∞—è –ø—Ä–∞–≤–∞) –≤ –ø–∞–ø–∫—É.
    2. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –ë–î.
    3. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†–ê–ú —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å —Ñ–æ—Ç–æ –∏ –∫–Ω–æ–ø–∫–∞–º–∏.
    """
    await context.bot.send_message(chat_id, "‚è≥ –°–æ—Ö—Ä–∞–Ω—è—é –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å, —ç—Ç–æ –∑–∞–π–º–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥...")

    if not form_data:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è user_id: {user_id}")
        await context.bot.send_message(chat_id, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ.")
        return ConversationHandler.END

    country = form_data.get('country', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')
    photo_ids = form_data.get('document_file_ids', [])
    license_photo_id = form_data.get('license_photo_file_id') # <-- –ü–û–õ–£–ß–ê–ï–ú ID –§–û–¢–û –ü–†–ê–í
    user_tg_username = (await context.bot.get_chat(user_id)).username

    # --- 1. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –Ω–∞ –¥–∏—Å–∫ ---
    passport_folder_path = None
    try:
        base_path = Path(DOCUMENTS_PATH)
        user_folder_name = f"{country}_{form_data.get('last_name', 'user')}_{user_id}"
        user_path = base_path / user_folder_name
        user_path.mkdir(parents=True, exist_ok=True)
        passport_folder_path = str(user_path)

        filenames = (
            ["1_main_passport.jpg", "2_registration_passport.jpg"]
            if country == '–†–§' else
            ["1_foreign_passport.jpg", "2_registration.jpg", "3_patent.jpg"]
        )

        for i, file_id in enumerate(photo_ids):
            if i < len(filenames):
                photo_file = await context.bot.get_file(file_id)
                await photo_file.download_to_drive(user_path / filenames[i])
        
        # <-- –°–û–•–†–ê–ù–Ø–ï–ú –§–û–¢–û –ü–†–ê–í, –ï–°–õ–ò –û–ù–û –ï–°–¢–¨ -->
        if license_photo_id:
            photo_file = await context.bot.get_file(license_photo_id)
            await photo_file.download_to_drive(user_path / "4_drivers_license.jpg")

        logger.info(f"–§–æ—Ç–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø–∞–ø–∫—É: {passport_folder_path}")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–æ—Ç–æ –¥–ª—è user_id {user_id}: {e}", exc_info=True)

    # --- 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î ---
    try:
        passport_data_json = json.dumps(recognized_data, ensure_ascii=False) if recognized_data else None

        async with aiosqlite.connect(DB_FILE) as conn:
            cursor = await conn.execute("SELECT id FROM users WHERE id = ?", (user_id,))
            exists = await cursor.fetchone()

            db_data = {
                "username": user_tg_username,
                "first_name": form_data.get('first_name'),
                "last_name": form_data.get('last_name'),
                "phone_number": form_data.get('phone_number'),
                "delivery_service": form_data.get('delivery_service'),
                "passport_photo": passport_folder_path,
                "verified": 0,
                "country": country,
                "passport_data": passport_data_json,
                "has_license": form_data.get('has_license'),      # <-- –ù–û–í–û–ï –ü–û–õ–ï
                "license_photo": license_photo_id,                # <-- –ù–û–í–û–ï –ü–û–õ–ï
            }

            if exists:
                set_clause = ", ".join([f"{key} = ?" for key in db_data.keys()])
                sql = f'UPDATE users SET {set_clause} WHERE id = ?'
                values = list(db_data.values()) + [user_id]
                await conn.execute(sql, values)
            else:
                db_data['id'] = user_id
                columns = ', '.join(db_data.keys())
                placeholders = ', '.join('?' * len(db_data))
                sql = f'INSERT INTO users ({columns}) VALUES ({placeholders})'
                await conn.execute(sql, tuple(db_data.values()))

            await conn.commit()
        logger.info(f"–î–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã/–æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤ –ë–î.")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –≤ –ë–î: {e}", exc_info=True)
        await context.bot.send_message(chat_id, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.")
        return ConversationHandler.END

    # --- 3. –§–∏–Ω–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ---
    try:
        notification_text = (
            f"üöÄ *–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é\\!* \n\n"
            f"**–§–ò–û:** {escape_markdown(form_data.get('first_name', ''), 2)} {escape_markdown(form_data.get('last_name', ''), 2)}\n"
            f"**ID:** `{user_id}`\n"
            f"**–¢–µ–ª–µ—Ñ–æ–Ω:** `{escape_markdown(form_data.get('phone_number', '–Ω–µ—Ç'), 2)}`\n"
            f"**–ì—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ:** {escape_markdown(country, 2)}\n"
            f"**–í–æ–¥\\. –ø—Ä–∞–≤–∞:** {escape_markdown(form_data.get('has_license', '–ù–µ—Ç'), 2)}\n\n" # <-- –ò–ù–§–û –û –ü–†–ê–í–ê–•
            f"*–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:*\n"
        )
        if recognized_data:
            for key, value in recognized_data.items():
                if value:
                    notification_text += f" ‚Ä¢ {escape_markdown(key, 2)}: `{escape_markdown(str(value), 2)}`\n"
        else:
             notification_text += "_–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–µ –ø—Ä–æ–≤–æ–¥–∏–ª–æ—Å—å\\._\n"


        # <-- –§–û–†–ú–ò–†–£–ï–ú –ì–†–£–ü–ü–£ –§–û–¢–û –î–õ–Ø –ê–î–ú–ò–ù–ê -->
        media_group = []
        if photo_ids:
            media_group.extend([InputMediaPhoto(media=file_id) for file_id in photo_ids])
        if license_photo_id:
            media_group.append(InputMediaPhoto(media=license_photo_id, caption="–í–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–µ –ø—Ä–∞–≤–∞"))

        keyboard = [
            [InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data=f"verify_{user_id}")],
            [InlineKeyboardButton("‚úèÔ∏è –ù–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É", callback_data=f"rework_{user_id}")],
            [InlineKeyboardButton("‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"reject_verification_{user_id}")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        for admin_id in ADMIN_IDS:
            if media_group:
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ —Ñ–æ—Ç–æ (–ø–∞—Å–ø–æ—Ä—Ç + –ø—Ä–∞–≤–∞) –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø–æ–π
                await context.bot.send_media_group(admin_id, media=media_group)
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å –∫–Ω–æ–ø–∫–∞–º–∏
            await context.bot.send_message(admin_id, notification_text, parse_mode="MarkdownV2", reply_markup=reply_markup)

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞–º –¥–ª—è user {user_id}: {e}")

    await context.bot.send_message(
        chat_id,
        "‚úÖ **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞\\!**\n\n–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É\\.",
        parse_mode="MarkdownV2",
        reply_markup=get_main_menu(user_id)
    )
    return ConversationHandler.END
# --- –û–ë–©–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –û–¢–ú–ï–ù–´ –î–ò–ê–õ–û–ì–û–í ---
async def cancel_verification_action(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û—Ç–º–µ–Ω—è–µ—Ç –¥–∏–∞–ª–æ–≥ –≤–≤–æ–¥–∞ –ø—Ä–∏—á–∏–Ω—ã –¥–æ—Ä–∞–±–æ—Ç–∫–∏/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è."""
    if update.callback_query:
        await update.callback_query.answer()
        await update.callback_query.edit_message_text("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    else:
        await update.message.reply_text("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    context.user_data.clear()
    return ConversationHandler.END

# --- –õ–û–ì–ò–ö–ê –î–õ–Ø –ö–ù–û–ü–ö–ò "–ù–ê –î–û–†–ê–ë–û–¢–ö–£" ---

async def cancel_verification_action(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û—Ç–º–µ–Ω—è–µ—Ç –¥–∏–∞–ª–æ–≥ –≤–≤–æ–¥–∞ –ø—Ä–∏—á–∏–Ω—ã –¥–æ—Ä–∞–±–æ—Ç–∫–∏/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è."""
    if update.callback_query:
        await update.callback_query.answer()
        await update.callback_query.edit_message_text("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    else:
        await update.message.reply_text("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    context.user_data.clear()
    return ConversationHandler.END

# --- –õ–û–ì–ò–ö–ê –î–õ–Ø –ö–ù–û–ü–ö–ò "–ù–ê –î–û–†–ê–ë–û–¢–ö–£" ---

async def start_rework_verification(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 1 (–î–æ—Ä–∞–±–æ—Ç–∫–∞): –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É –∞–¥–º–∏–Ω–∞ –ø—Ä–∏—á–∏–Ω—É –¥–ª—è –¥–æ—Ä–∞–±–æ—Ç–∫–∏."""
    query = update.callback_query
    await query.answer()

    user_id_to_rework = int(query.data.split('_')[1])
    context.user_data['user_id_for_action'] = user_id_to_rework

    # –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π
    await query.edit_message_reply_markup(reply_markup=None)

    await query.message.reply_text(
        f"‚úçÔ∏è –í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É, –ø–æ –∫–æ—Ç–æ—Ä–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ID {user_id_to_rework} –Ω—É–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞—è–≤–∫—É.\n"
        "–≠—Ç–æ—Ç —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é."
    )
    return AWAIT_REWORK_REASON


async def send_rework_reason(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –®–∞–≥ 2 (–î–æ—Ä–∞–±–æ—Ç–∫–∞): –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –£–î–ê–õ–Ø–ï–¢ –µ–≥–æ –∑–∞–ø–∏—Å—å –∏–∑ –ë–î
    –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –¥–∏–∞–ª–æ–≥.
    """
    rework_reason = update.message.text
    user_id = context.user_data.get('user_id_for_action')
    admin_user = update.message.from_user

    if not user_id:
        await update.message.reply_text("üö´ –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.")
        return ConversationHandler.END

    try:
        # 1. –°–Ω–∞—á–∞–ª–∞ —É–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_message = (
            f"‚ö†Ô∏è **–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏.**\n\n"
            f"**–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:**\n_{rework_reason}_\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—á–µ—Ç—ã –∏ –ø—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ, –Ω–∞–∂–∞–≤ –Ω–∞ –∫–Ω–æ–ø–∫—É 'üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è' –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é."
        )
        await context.bot.send_message(chat_id=user_id, text=user_message, parse_mode="Markdown")

        # <<< –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î >>>
        # –≠—Ç–æ –∑–∞—Å—Ç–∞–≤–∏—Ç –µ–≥–æ –ø—Ä–æ–π—Ç–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —Å –Ω—É–ª—è.
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        cursor.execute("DELETE FROM users WHERE id = ?", (user_id,))
        conn.commit()
        conn.close()
        # <<< –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø >>>

        # 2. –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ–± —É—Å–ø–µ—Ö–µ
        await update.message.reply_text(f"‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ –¥–æ—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID {user_id} —Å–±—Ä–æ—à–µ–Ω –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.")

        # 3. –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
        log_bike_action(None, user_id, "–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è: –¥–æ—Ä–∞–±–æ—Ç–∫–∞", f"–ê–¥–º–∏–Ω {admin_user.full_name} –æ—Ç–ø—Ä–∞–≤–∏–ª –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É. –ü—Ä–∏—á–∏–Ω–∞: {rework_reason}")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ send_rework_reason –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")
        await update.message.reply_text(f"üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")

    context.user_data.clear()
    return ConversationHandler.END

# --- –õ–û–ì–ò–ö–ê –î–õ–Ø –ö–ù–û–ü–ö–ò "–û–¢–ö–õ–û–ù–ò–¢–¨" ---

async def start_reject_verification(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 1 (–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ): –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É –∞–¥–º–∏–Ω–∞ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è."""
    query = update.callback_query
    await query.answer()

    user_id_to_reject = int(query.data.split('_')[2])
    context.user_data['user_id_for_action'] = user_id_to_reject

    await query.edit_message_reply_markup(reply_markup=None)
    await query.message.reply_text(
        f"‚úçÔ∏è –í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID {user_id_to_reject}.\n"
        "–≠—Ç–æ—Ç —Ç–µ–∫—Å—Ç –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é."
    )
    return AWAIT_REJECT_REASON


async def send_reject_reason(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 2 (–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ): –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏ —É–¥–∞–ª—è–µ—Ç –µ–≥–æ –∏–∑ –ë–î."""
    reject_reason = update.message.text
    user_id = context.user_data.get('user_id_for_action')
    admin_user = update.message.from_user

    if not user_id:
        await update.message.reply_text("üö´ –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.")
        return ConversationHandler.END

    try:
        # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_message = (
            f"‚ùå **–í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –±—ã–ª–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞.**\n\n"
            f"**–ü—Ä–∏—á–∏–Ω–∞:**\n_{reject_reason}_\n\n"
            "–ï—Å–ª–∏ –≤—ã —Å—á–∏—Ç–∞–µ—Ç–µ, —á—Ç–æ —ç—Ç–æ –æ—à–∏–±–∫–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π."
        )
        await context.bot.send_message(chat_id=user_id, text=user_message, parse_mode="Markdown")

        # –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        cursor.execute("DELETE FROM users WHERE id = ?", (user_id,))
        conn.commit()
        conn.close()

        await update.message.reply_text(f"‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID {user_id} –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω –∏ —É–¥–∞–ª–µ–Ω –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.")
        log_bike_action(None, user_id, "–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è: –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞", f"–ê–¥–º–∏–Ω {admin_user.full_name} –æ—Ç–∫–ª–æ–Ω–∏–ª –∑–∞—è–≤–∫—É. –ü—Ä–∏—á–∏–Ω–∞: {reject_reason}")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")
        await update.message.reply_text(f"üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")

    context.user_data.clear()
    return ConversationHandler.END

# <<< –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê >>>
# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é (–∑–∞–≥–ª—É—à–∫–∞)


from PIL import Image, ImageDraw, ImageFont

from datetime import datetime

import os
from datetime import datetime
from PIL import Image, ImageDraw, ImageFont
import sqlite3

import os
from datetime import datetime
from PIL import Image, ImageDraw, ImageFont
import sqlite3

def create_apple_style_profile_image(user_data):
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ users
    users_dir = r"C:\Users\Kerpat\source\repos\PythonApplication12\PythonApplication12\users"

    # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    os.makedirs(users_dir, exist_ok=True)

    # –ü—É—Ç—å –∫ —à—Ä–∏—Ñ—Ç–∞–º
    font_path_bold = r"C:\Users\Kerpat\Downloads\sf-ui-display-black.ttf"  # –î–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    font_path_italic = r"C:\Users\Kerpat\Downloads\sf-ui-text-heavy-italic.ttf"  # –î–ª—è –∑–Ω–∞—á–µ–Ω–∏–π (–∫—É—Ä—Å–∏–≤)

    # –ü—É—Ç—å –∫ —Ñ–æ–Ω–æ–≤–æ–º—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
    background_image_path = "apple.png"

    # –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ–Ω–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    try:
        background = Image.open(background_image_path).convert('RGB')
        background = background.resize((1280, 720))  # –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    except IOError:
        print("–§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ–¥–Ω–æ—Ç–æ–Ω–Ω—ã–π —Ñ–æ–Ω.")
        background = Image.new('RGB', (1280, 720), color=(240, 240, 240))  # –ó–∞–ø–∞—Å–Ω–æ–π —Ñ–æ–Ω

    image_width, image_height = background.size

    # –†–∞–∑–º–µ—Ä—ã —à—Ä–∏—Ñ—Ç–æ–≤
    name_font_size = int(image_width * 0.06)  # –ö—Ä—É–ø–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è –∏–º–µ–Ω–∏ –∏ —Ñ–∞–º–∏–ª–∏–∏
    text_font_size = int(image_width * 0.025)  # –†–∞–∑–º–µ—Ä –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏ –∑–Ω–∞—á–µ–Ω–∏–π

    # –û—Ç—Å—Ç—É–ø—ã
    margin_x = int(image_width * 0.05)  # –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π –æ—Ç—Å—Ç—É–ø –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
    margin_y = int(image_height * 0.05)  # –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É

    # –®–∞–≥ –¥–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Å–º–µ—â–µ–Ω–∏—è
    y_offset_increment = int(image_height * 0.03)  # –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —à–∞–≥ –¥–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Å–º–µ—â–µ–Ω–∏—è

    draw = ImageDraw.Draw(background)

    # –ó–∞–≥—Ä—É–∑–∫–∞ —à—Ä–∏—Ñ—Ç–æ–≤
    try:
        name_font = ImageFont.truetype(font_path_bold, name_font_size)  # –®—Ä–∏—Ñ—Ç –¥–ª—è –∏–º–µ–Ω–∏ –∏ —Ñ–∞–º–∏–ª–∏–∏
        header_font = ImageFont.truetype(font_path_bold, text_font_size)  # –®—Ä–∏—Ñ—Ç –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
        value_font = ImageFont.truetype(font_path_italic, text_font_size)  # –®—Ä–∏—Ñ—Ç –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏–π (–∫—É—Ä—Å–∏–≤)
    except IOError:
        print("–®—Ä–∏—Ñ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã.")
        name_font = ImageFont.load_default()
        header_font = ImageFont.load_default()
        value_font = ImageFont.load_default()

    # –ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è (–∫—Ä—É–ø–Ω—ã–π —à—Ä–∏—Ñ—Ç)
    name = f"{user_data.get('first_name', '')} {user_data.get('last_name', '')}"
    name_bbox = draw.textbbox((0, 0), name, font=name_font)
    name_width = name_bbox[2] - name_bbox[0]
    name_height = name_bbox[3] - name_bbox[1]

    # –ü–æ–∑–∏—Ü–∏—è –∏–º–µ–Ω–∏ –∏ —Ñ–∞–º–∏–ª–∏–∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É
    x_center = (image_width - name_width) // 2  # –¶–µ–Ω—Ç—Ä –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏
    y_offset = margin_y  # –û—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É
    draw.text((x_center, y_offset), name, font=name_font, fill=(255, 255, 255))  # –ë–µ–ª—ã–π —Ç–µ–∫—Å—Ç

    # –û—Ç—Å—Ç—É–ø –ø–æ—Å–ª–µ –∏–º–µ–Ω–∏ –∏ —Ñ–∞–º–∏–ª–∏–∏
    y_offset += name_height + y_offset_increment * 2  # –ë–æ–ª—å—à–µ –æ—Ç—Å—Ç—É–ø –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞

    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å—ã –∞—Ä–µ–Ω–¥—ã –∏ –æ—á–µ—Ä–µ–¥–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    cursor.execute("""
        SELECT status, booking_date, end_date
        FROM bookings
        WHERE user_id = ?
        ORDER BY booking_date DESC
        LIMIT 1
    """, (user_data['id'],))
    last_booking = cursor.fetchone()

    # –ü–æ–ª—É—á–∞–µ–º –º–µ—Å—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ—á–µ—Ä–µ–¥–∏
    cursor.execute("""
        SELECT q.user_id, q.created_at, q.status, u.first_name, u.last_name
        FROM queue q
        JOIN users u ON q.user_id = u.id
        ORDER BY q.created_at
    """)
    queue = cursor.fetchall()

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ—á–µ—Ä–µ–¥–∏
    user_position = None
    queue_pending = False
    is_first_user = False  # –§–ª–∞–≥ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ first_user
    if queue:
        for idx, (queued_user_id, created_at, status, first_name, last_name) in enumerate(queue, start=1):
            if queued_user_id == user_data['id']:
                user_position = idx
                if status == "pending":
                    queue_pending = True
                if status == "first_user":
                    is_first_user = True
                break

    conn.close()

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏
    status_info = []
    if last_booking:
        status, booking_date, end_date = last_booking
        if status == "pending":
            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º booking_date –≤ —Ñ–æ—Ä–º–∞—Ç –¥–¥.–º–º.–≥–≥–≥–≥
            try:
                booking_date_obj = datetime.strptime(booking_date, "%Y-%m-%d %H:%M:%S")
                formatted_date = booking_date_obj.strftime("%d.%m.%Y")
                status_info.append(f"–û–∂–∏–¥–∞–µ—Ç ({formatted_date})")
            except ValueError:
                status_info.append("–û–∂–∏–¥–∞–µ—Ç (–¥–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞)")
        elif status == "confirmed":
            status_info.append(f"–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –Ω–∞ {booking_date}")
        elif status == "rented":
            status_info.append(f"–ê—Ä–µ–Ω–¥–æ–≤–∞–Ω–æ —Å {booking_date} –ø–æ {end_date}")
        # –°—Ç–∞—Ç—É—Å—ã canceled –∏ returned –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º

    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Å—Ç–µ –≤ –æ—á–µ—Ä–µ–¥–∏
    if is_first_user:
        status_info.append("–ü–µ—Ä–≤–æ–µ –º–µ—Å—Ç–æ –≤ –æ—á–µ—Ä–µ–¥–∏")  # –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–≤—ã–π
    elif queue_pending and user_position is not None:
        status_info.append(f"–í –æ—á–µ—Ä–µ–¥–∏ –Ω–∞ {user_position} –º–µ—Å—Ç–µ")

    # –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤"
    if not status_info:
        status_info.append("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤")

    # –ë–ª–æ–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    info_blocks = [
        ("—Ç–µ–ª–µ—Ñ–æ–Ω", user_data.get('phone_number', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')),
        ("–¥–æ—Å—Ç–∞–≤–∫–∞", user_data.get('delivery_service', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')),  # –†–∞–∑–¥–µ–ª–µ–Ω–æ: –¥–æ—Å—Ç–∞–≤–∫–∞
        ("–ø–ª–∞–Ω –æ–ø–ª–∞—Ç—ã", user_data.get('payment_plan', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')),  # –†–∞–∑–¥–µ–ª–µ–Ω–æ: –ø–ª–∞–Ω –æ–ø–ª–∞—Ç—ã
        ("–æ–ø—ã—Ç", user_data.get('experience', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')),  # –†–∞–∑–¥–µ–ª–µ–Ω–æ: –æ–ø—ã—Ç
        ("—Ö—Ä–∞–Ω–µ–Ω–∏–µ", user_data.get('storage', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')),  # –†–∞–∑–¥–µ–ª–µ–Ω–æ: —Ö—Ä–∞–Ω–µ–Ω–∏–µ
        ("–∏—Å—Ç–æ—á–Ω–∏–∫", user_data.get('source_of_info', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')),
        ("–ø–∞—Å–ø–æ—Ä—Ç", "–∑–∞–≥—Ä—É–∂–µ–Ω" if user_data.get('passport_photo') else "–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"),  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–æ—Ç–æ –ø–∞—Å–ø–æ—Ä—Ç–∞
        ("—Å—Ç–∞—Ç—É—Å", ", ".join(status_info)),  # –í—Å–µ —Å—Ç–∞—Ç—É—Å—ã
        ("–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è", "–≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω" if user_data.get('verified', 0) else "–Ω–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω"),  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
        ("–æ–∂–∏–¥–∞–Ω–∏–µ", user_data.get('rental_period', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')),
    ]

    # –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –±–ª–æ–∫–æ–≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    for label, value in info_blocks:
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫ (—Å –¥–≤–æ–µ—Ç–æ—á–∏–µ–º)
        header_text = f"{label}:"
        header_bbox = draw.textbbox((0, 0), header_text, font=header_font)
        header_height = header_bbox[3] - header_bbox[1]
        draw.text((margin_x, y_offset), header_text, font=header_font, fill=(255, 255, 255))  # –ë–µ–ª—ã–π —Ç–µ–∫—Å—Ç

        # –ó–Ω–∞—á–µ–Ω–∏–µ (–∫—É—Ä—Å–∏–≤)
        value_bbox = draw.textbbox((0, 0), value, font=value_font)
        value_height = value_bbox[3] - value_bbox[1]
        draw.text((margin_x + int(image_width * 0.3), y_offset), value, font=value_font, fill=(200, 200, 200))  # –°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π —Ç–µ–∫—Å—Ç

        # –°–º–µ—â–µ–Ω–∏–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –±–ª–æ–∫–∞
        y_offset += max(header_height, value_height) + y_offset_increment

    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ø–∞–ø–∫—É users
    image_name = f"user_{user_data['id']}_apple_style_profile.png"
    image_path = os.path.join(users_dir, image_name)  # –ü–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
    background.save(image_path)
    print(f"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {image_path}")

    return image_path


from datetime import datetime, timedelta

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–ª–æ–Ω–µ–Ω–∏—è —Å–ª–æ–≤–∞ "—Ä—É–±–ª—å"
def format_rubles(amount):
    if isinstance(amount, str):
        amount = int(''.join(filter(str.isdigit, amount)))  # –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ –∏–∑ —Å—Ç—Ä–æ–∫–∏
    last_digit = amount % 10
    last_two_digits = amount % 100

    if last_two_digits in [11, 12, 13, 14]:
        return f"{amount} —Ä—É–±–ª–µ–π"
    elif last_digit == 1:
        return f"{amount} —Ä—É–±–ª—å"
    elif last_digit in [2, 3, 4]:
        return f"{amount} —Ä—É–±–ª—è"
    else:
        return f"{amount} —Ä—É–±–ª–µ–π"

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ show_profile –ù–ê –≠–¢–£ –ü–û–õ–ù–£–Æ –ò –ò–°–ü–†–ê–í–õ–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ show_profile –ù–ê –≠–¢–£ –ü–û–õ–ù–£–Æ –ò –ò–°–ü–†–ê–í–õ–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ show_profile –ù–ê –≠–¢–£ –ü–û–õ–ù–£–Æ –ò –ò–°–ü–†–ê–í–õ–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ show_profile –ù–ê –≠–¢–£ –ü–û–õ–ù–£–Æ –ò –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–£–Æ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ show_profile –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ show_profile –ù–ê –≠–¢–£ –£–õ–£–ß–®–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ

### –ù–û–í–ê–Ø –í–ï–†–°–ò–Ø —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Ä–µ–º–æ–Ω—Ç–∞ –∫ –æ–ø–ª–∞—Ç–µ –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º –∫ –ë–î ###
### –ù–û–í–ê–Ø –í–ï–†–°–ò–Ø —Å –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï–ú –¢–ò–ü–û–í –î–ê–ù–ù–´–• –∏ –ü–û–õ–ù–û–ô –õ–û–ì–ò–ö–û–ô ###
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ show_profile –ù–ê –≠–¢–£ –ü–û–õ–ù–£–Æ –ò –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–£–Æ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ show_profile –ù–ê –≠–¢–£ –ü–û–õ–ù–£–Æ –ò –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–£–Æ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ show_profile –ù–ê –≠–¢–£ –ü–û–õ–ù–£–Æ –ò –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–£–Æ –í–ï–†–°–ò–Æ

from datetime import datetime
from telegram.helpers import escape_markdown
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
import aiosqlite
import logging

# –ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, —É –≤–∞—Å –µ—Å—Ç—å —ç—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≥–¥–µ-—Ç–æ –≤ –∫–æ–¥–µ
# logger = logging.getLogger(__name__)
# DB_FILE = "your_db.sqlite"
# PRODUCT_TYPE_BIKE = 'bike'
# PRODUCT_TYPE_BATTERY = 'battery'
# BUYOUT_PLANS = {} # –í–∞—à–∏ –ø–ª–∞–Ω—ã —Ä–∞—Å—Å—Ä–æ—á–µ–∫
# BATTERY_BUYOUT_PLANS = {} # –í–∞—à–∏ –ø–ª–∞–Ω—ã —Ä–∞—Å—Å—Ä–æ—á–µ–∫ –Ω–∞ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä—ã


import aiosqlite
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from telegram.helpers import escape_markdown
from datetime import datetime

import aiosqlite
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
from telegram.helpers import escape_markdown
from datetime import datetime

async def show_profile(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –ü–û–õ–ù–ê–Ø –ò –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø:
    - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ –∞—Ä–µ–Ω–¥–∞–º, –≤—ã–∫—É–ø–∞–º, —Ä–µ–º–æ–Ω—Ç–∞–º, —à—Ç—Ä–∞—Ñ–∞–º –∏ —Å–∫–∏–¥–∫–∞–º.
    - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–Ω–æ–ø–∫–∏: "–ü—Ä–æ–¥–ª–∏—Ç—å", "–û–ø–ª–∞—Ç–∏—Ç—å", "–°–¥–∞—Ç—å —Ç–æ–≤–∞—Ä" –∏ —Ç.–¥.
    - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã –≤—ã–∫—É–ø–∞ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `bikes`.
    """
    user_id = update.message.from_user.id

    def escape(text: any) -> str:
        return escape_markdown(str(text or ''), version=2)

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row

            # 1. –ü–æ–ª—É—á–∞–µ–º –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            cursor = await conn.execute("SELECT first_name, last_name, verified, passport_photo FROM users WHERE id=?", (user_id,))
            user_base_info = await cursor.fetchone()

            if not user_base_info:
                await update.message.reply_text("üö´ –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.")
                return

            first_name = user_base_info['first_name']
            last_name = user_base_info['last_name']
            verified = user_base_info['verified']
            passport_photo = user_base_info['passport_photo']

            profile_parts = [
                f"üåº *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {escape(first_name)}\! –≠—Ç–æ –≤–∞—à –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç*\!\n",
                f"üìõ *–§–ò–û:* {escape(first_name)} {escape(last_name)}",
                f"üü¢ *–°—Ç–∞—Ç—É—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏:* {'‚úÖ –í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω' if verified else 'üö´ –ù–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω'}"
            ]
            keyboard = []

            if not passport_photo:
                profile_parts.append("üìÑ *–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –ø–∞—Å–ø–æ—Ä—Ç–∞*: –ù–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞\\.")
                keyboard.append([InlineKeyboardButton("–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –ø–∞—Å–ø–æ—Ä—Ç–∞", callback_data='send_passport')])

            # 2. –ò—â–µ–º —Ç–æ–≤–∞—Ä—ã –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
            cursor = await conn.execute("SELECT name, type FROM bikes WHERE owner_id = ?", (user_id,))
            owned_items = await cursor.fetchall()
            if owned_items:
                profile_parts.append("\nüéâ *–í –≤–∞—à–µ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:*")
                for item in owned_items:
                    emoji = "üö≤" if item['type'] == 'bike' else "üîã"
                    profile_parts.append(f"‚Ä¢ {emoji} {escape(item['name'])}")

            # 3. –ò—â–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã –∏ —Ä–∞—Å—Å—Ä–æ—á–∫–∏
            cursor = await conn.execute("""
                SELECT b.id, bk.name, bk.type, b.booking_type, b.end_date,
                       b.payments_made, b.next_payment_date,
                       bk.buyout_total_payments, bk.buyout_payment_amount
                FROM bookings b
                JOIN bikes bk ON b.bike_id = bk.id
                WHERE b.user_id = ? AND b.status = 'rented'
            """, (user_id,))
            active_bookings = await cursor.fetchall()
            
            # <<< –≠–¢–û –°–ê–ú–ê–Ø –í–ê–ñ–ù–ê–Ø –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–ê–Ø –ß–ê–°–¢–¨ >>>
            rentals_part = []
            buyouts_part = []
            has_active_items = bool(active_bookings)

            if active_bookings:
                for booking in active_bookings:
                    booking_id = booking['id']
                    name, item_type = booking['name'], booking['type']
                    emoji = "üö≤" if item_type == 'bike' else "üîã"

                    if booking['booking_type'] == 'rent':
                        end_date = booking['end_date']
                        status = " \\(–¥–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞\\)"
                        if end_date:
                            try:
                                end_date_obj = datetime.strptime(end_date, '%d.%m.%Y')
                                remaining_days = (end_date_obj.date() - datetime.now().date()).days
                                status = f" \\(–æ—Å—Ç–∞–ª–æ—Å—å {remaining_days} –¥–Ω\\.\\)" if remaining_days >= 0 else f" \\(–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ {-remaining_days} –¥–Ω\\!\\)"
                            except (ValueError, TypeError):
                                status = " \\(–æ—à–∏–±–∫–∞ –≤ –¥–∞—Ç–µ\\)"
                        rentals_part.append(f"‚Ä¢ {emoji} *{escape(name)}*{status}")
                        keyboard.append([InlineKeyboardButton(f"üóìÔ∏è –ü—Ä–æ–¥–ª–∏—Ç—å –∞—Ä–µ–Ω–¥—É ({name[:15]}...)", callback_data=f"auto_prolong_7_{booking_id}")])

                    elif booking['booking_type'] == 'buyout':
                        payments_made = booking['payments_made']
                        next_payment_date = booking['next_payment_date']
                        total_payments = booking['buyout_total_payments']
                        payment_amount = booking['buyout_payment_amount']
                        
                        plan_info_str = f"{total_payments} –ø–ª\\. –ø–æ {payment_amount:,.0f} ‚ÇΩ".replace(",", " ")

                        buyouts_part.append(
                            f"\n‚Ä¢ {emoji} *{escape(name)}*\n"
                            f"  ‚î£ –ü–ª–∞–Ω: {escape(plan_info_str)}\n"
                            f"  ‚î£ –í–Ω–µ—Å–µ–Ω–æ: {payments_made} –∏–∑ {total_payments} –ø–ª–∞—Ç–µ–∂–µ–π\n"
                            f"  ‚îó –°–ª–µ–¥—É—é—â–∏–π –ø–ª–∞—Ç–µ–∂: *–¥–æ {escape(next_payment_date)}*"
                        )
                        keyboard.append([InlineKeyboardButton(f"üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —Å–ª–µ–¥. –ø–ª–∞—Ç–µ–∂ ({name[:15]}...)", callback_data=f"pay_next_{booking_id}")])
                        keyboard.append([InlineKeyboardButton(f"üíµ –ü–æ–≥–∞—Å–∏—Ç—å –¥–æ—Å—Ä–æ—á–Ω–æ ({name[:15]}...)", callback_data=f"pay_full_{booking_id}")])

            if rentals_part:
                profile_parts.append("\n*–í–∞—à–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã:*")
                profile_parts.extend(rentals_part)
            if buyouts_part:
                profile_parts.append("\n*–í–∞—à–∏ —Ä–∞—Å—Å—Ä–æ—á–∫–∏:*")
                profile_parts.extend(buyouts_part)
            # <<< –ö–û–ù–ï–¶ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–û–ô –ß–ê–°–¢–ò >>>

            # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ —Ä–µ–º–æ–Ω—Ç—ã
            cursor = await conn.execute("SELECT rr.id, rr.estimated_price, b.name as bike_name FROM repair_requests rr JOIN bikes b ON rr.bike_id = b.id WHERE rr.user_id = ? AND rr.status = 'completed'", (user_id,))
            unpaid_repairs = await cursor.fetchall()
            if unpaid_repairs:
                profile_parts.append("\n*–†–µ–º–æ–Ω—Ç –∫ –æ–ø–ª–∞—Ç–µ:*")
                for repair in unpaid_repairs:
                    price = float(repair['estimated_price'] or 0)
                    if price > 0:
                        price_str = f"{price:.2f}"
                        profile_parts.append(f"‚Ä¢ üõ†Ô∏è {escape(repair['bike_name'])} \\- *{escape(price_str)} ‚ÇΩ*")
                        keyboard.append([InlineKeyboardButton(f"üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —Ä–µ–º–æ–Ω—Ç ({repair['bike_name'][:15]}...)", callback_data=f"pay_repair_{repair['id']}")])

            # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ —à—Ç—Ä–∞—Ñ—ã
            cursor = await conn.execute("SELECT id, amount, reason FROM fines WHERE user_id = ? AND status = 'unpaid'", (user_id,))
            unpaid_fines = await cursor.fetchall()
            if unpaid_fines:
                profile_parts.append("\nüö® *–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ —à—Ç—Ä–∞—Ñ—ã:*")
                for fine in unpaid_fines:
                    amount_str = f"{fine['amount']:.2f}"
                    profile_parts.append(f"‚Ä¢ –®—Ç—Ä–∞—Ñ ‚Ññ{fine['id']}: *{escape(amount_str)} ‚ÇΩ* \\(–ü—Ä–∏—á–∏–Ω–∞: _{escape(fine['reason'])}_\\)")
                    keyboard.append([InlineKeyboardButton(f"üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —à—Ç—Ä–∞—Ñ ‚Ññ{fine['id']}", callback_data=f"pay_fine_{fine['id']}")])

            # 6. –ö–Ω–æ–ø–∫–∞ "–°–¥–∞—Ç—å —Ç–æ–≤–∞—Ä"
            if has_active_items:
                if keyboard: keyboard.append([InlineKeyboardButton("‚îÄ" * 20, callback_data="noop")])
                keyboard.append([InlineKeyboardButton("‚Ü©Ô∏è –°–¥–∞—Ç—å —Ç–æ–≤–∞—Ä", callback_data="return_bike_start")])

            # 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–∫–∏–¥–∫–∏
            cursor = await conn.execute("SELECT amount, reason FROM discounts WHERE user_id = ? AND is_used = 0 AND expiry_date > CURRENT_TIMESTAMP LIMIT 1", (user_id,))
            discount = await cursor.fetchone()
            if discount:
                profile_parts.append(f"\nüéÅ *–£ –≤–∞—Å –µ—Å—Ç—å —Å–∫–∏–¥–∫–∞ –Ω–∞ {discount['amount']} ‚ÇΩ \\({escape(discount['reason'])}\\)\\!*")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è user {user_id}: {e}", exc_info=True)
        await update.message.reply_text("üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è.")
        return

    final_message = "\n".join(profile_parts)
    reply_markup = InlineKeyboardMarkup(keyboard) if keyboard else None

    await update.message.reply_text(final_message, parse_mode='MarkdownV2', reply_markup=reply_markup)

# <<< –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê >>>

async def start_fine_payment_user(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–û–ø–ª–∞—Ç–∏—Ç—å —à—Ç—Ä–∞—Ñ" –≤ –õ–ö.
    –§–æ—Ä–º–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ –ÆKassa.
    """
    query = update.callback_query
    await query.answer()

    fine_id = int(query.data.split("_")[2])
    user_id = query.from_user.id

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —à—Ç—Ä–∞—Ñ–µ –∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —á–µ–∫–∞
            cursor = await conn.execute("""
                SELECT f.amount, f.reason, u.phone_number
                FROM fines f
                JOIN users u ON f.user_id = u.id
                WHERE f.id=? AND f.user_id=?
            """, (fine_id, user_id))
            data = await cursor.fetchone()

        if not data:
            await query.message.edit_text("üö´ –û—à–∏–±–∫–∞: —à—Ç—Ä–∞—Ñ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –æ–ø–ª–∞—á–µ–Ω.")
            return

        price = float(data['amount'])
        if not data['phone_number']:
            await query.message.edit_text("üö´ –û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ –≤–∞—à–µ–º –ø—Ä–æ—Ñ–∏–ª–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ–∫–∞.")
            return

        # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–ª–∞—Ç–µ–∂–∞
        description = f"–û–ø–ª–∞—Ç–∞ —à—Ç—Ä–∞—Ñ–∞ ‚Ññ{fine_id}"
        payload = f"fine_{fine_id}" # –≠—Ç–æ—Ç payload —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤–∞—à–µ–π —Ñ—É–Ω–∫—Ü–∏–µ–π process_successful_payment
        metadata = {'internal_payload': payload, 'user_id': user_id}
        items = [{"description": description, "quantity": "1.00", "amount": {"value": f"{price:.2f}", "currency": "RUB"}, "vat_code": "1"}]
        customer = {"phone": data['phone_number']}

        payment_info = await create_yookassa_payment(price, description, metadata, items, customer, 'sbp')
        if not payment_info:
            await query.message.edit_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
            return
            
        await query.message.delete()

        # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∏ –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞
        payment_url, payment_id, final_amount = payment_info['url'], payment_info['id'], payment_info['final_amount']
        keyboard = [[InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —à—Ç—Ä–∞—Ñ", url=payment_url)]]
        animated_message = await context.bot.send_message(
            user_id,
            f"üö® –î–ª—è –æ–ø–ª–∞—Ç—ã —à—Ç—Ä–∞—Ñ–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–ª–∞—Ç–∏—Ç–µ {final_amount:.2f} ‚ÇΩ.",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )

        if 'pending_payments' not in context.bot_data:
            context.bot_data['pending_payments'] = {}
        stop_animation_event = asyncio.Event()
        context.bot_data['pending_payments'][payment_id] = {
            'user_id': user_id, 'start_time': datetime.now(),
            'payload': payload, 'amount': final_amount,
            'animated_message_id': animated_message.message_id, 'url': payment_url,
            'animation_sequence': random.choice(PAYMENT_ANIMATIONS),
            'stop_animation_event': stop_animation_event
        }

        asyncio.create_task(animate_payment_message(context, payment_id))
        context.job_queue.run_repeating(
            callback=check_payment_status, interval=15, first=10,
            name=f"payment_{payment_id}", data={'yookassa_id': payment_id}
        )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ start_fine_payment_user –¥–ª—è —à—Ç—Ä–∞—Ñ–∞ #{fine_id}: {e}", exc_info=True)
        await query.message.reply_text("üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É.")

# <<< –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê >>>
# –®–ê–ì 3: –í–°–¢–ê–í–¨–¢–ï –≠–¢–£ –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ –í –í–ê–® –ö–û–î

async def auto_prolong_rental(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø:
    –ü—Ä–æ–¥–ª–µ–≤–∞–µ—Ç –∞—Ä–µ–Ω–¥—É, –ø–æ–ª—É—á–∞—è —Ü–µ–Ω—É –∏–∑ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ —Ç–∞—Ä–∏—Ñ–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –≤ –ë–î.
    """
    query = update.callback_query
    await query.answer()

    # –†–∞–∑–±–∏—Ä–∞–µ–º callback_data: auto_prolong_7_{booking_id}
    parts = query.data.split('_')
    days_to_extend = int(parts[2])
    booking_id = int(parts[3])
    user_id = query.from_user.id

    await query.message.edit_text("‚è≥ –ì–æ—Ç–æ–≤–ª—é —Å—á–µ—Ç –Ω–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã...")

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            # --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã bikes ---
            # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è –∫–æ–ª–æ–Ω–∫–∏ —Å —Ü–µ–Ω–æ–π
            price_column_name = f"rent_price_{days_to_extend}d"
            
            cursor = await conn.execute(
                f"""SELECT u.phone_number, b.name as bike_name, b.{price_column_name} as price
                   FROM bookings bo
                   JOIN users u ON bo.user_id = u.id
                   JOIN bikes b ON bo.bike_id = b.id
                   WHERE bo.id=?
                """,
                (booking_id,)
            )
            data = await cursor.fetchone()
        # --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô ---

        if not data:
            raise ValueError("–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –∞—Ä–µ–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è.")
        if not data['phone_number']:
            raise ValueError("–ù–µ –Ω–∞–π–¥–µ–Ω –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —á–µ–∫–∞.")

        bike_name = data['bike_name']
        
        # <<< –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ë–µ—Ä–µ–º —Ü–µ–Ω—É –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞ >>>
        price = data['price']
        if price is None or price <= 0:
            # –≠—Ç–∞ –æ—à–∏–±–∫–∞ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, –µ—Å–ª–∏ –¥–ª—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –≤ –ë–î –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Ü–µ–Ω–∞ –Ω–∞ –Ω—É–∂–Ω—ã–π —Å—Ä–æ–∫
            raise ValueError(f"–î–ª—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ '{bike_name}' –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ç–∞—Ä–∏—Ñ –∞—Ä–µ–Ω–¥—ã –Ω–∞ {days_to_extend} –¥–Ω–µ–π.")
        # <<< –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø >>>

        # --- –î–∞–ª—å–Ω–µ–π—à–∏–π –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, —Ç–∞–∫ –∫–∞–∫ –æ–Ω —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é 'price' ---
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è YooKassa
        description = f"–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã '{bike_name}' –Ω–∞ {days_to_extend} –¥–Ω–µ–π"
        payload = f"prolong_{booking_id}_{days_to_extend}"
        
        metadata = {'internal_payload': payload, 'user_id': user_id}
        items_for_receipt = [{"description": description, "quantity": "1.00", "amount": { "value": f"{float(price):.2f}", "currency": "RUB" }, "vat_code": "1", "payment_subject": "service"}]
        
        payment_info = await create_yookassa_payment(
            amount=price, 
            description=description, 
            metadata=metadata, 
            items=items_for_receipt, 
            customer_info={"phone": data['phone_number']}, 
            payment_method='sbp'
        )
        
        if not payment_info:
            raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É.")

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—á–µ—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É
        payment_url, payment_id, final_amount = payment_info['url'], payment_info['id'], payment_info['final_amount']
        
        keyboard = [[InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å –ø—Ä–æ–¥–ª–µ–Ω–∏–µ", url=payment_url)]]
        animated_message = await query.message.edit_text(
            f"–î–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è –∞—Ä–µ–Ω–¥—ã –Ω–∞ {days_to_extend} –¥–Ω–µ–π, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–ª–∞—Ç–∏—Ç–µ {final_amount:.2f} ‚ÇΩ.",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )

        if 'pending_payments' not in context.bot_data: 
            context.bot_data['pending_payments'] = {}
            
        stop_animation_event = asyncio.Event()
        context.bot_data['pending_payments'][payment_id] = {
            'user_id': user_id, 
            'start_time': datetime.now(), 
            'payload': payload, 
            'amount': final_amount, 
            'animated_message_id': animated_message.message_id, 
            'url': payment_url, 
            'animation_sequence': random.choice(PAYMENT_ANIMATIONS), 
            'stop_animation_event': stop_animation_event
        }
        
        asyncio.create_task(animate_payment_message(context, payment_id))
        context.job_queue.run_repeating(
            callback=check_payment_status, 
            interval=15, 
            first=10, 
            name=f"payment_{payment_id}", 
            data={'yookassa_id': payment_id}
        )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ auto_prolong_rental: {e}", exc_info=True)
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        await query.message.edit_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
### –ù–û–í–ê–Ø –í–ï–†–°–ò–Ø –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –∫–Ω–æ–ø–∫–∏ "–û–ø–ª–∞—Ç–∏—Ç—å —Ä–µ–º–æ–Ω—Ç" ###
async def start_complete_repair_user(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –í—ã–∑—ã–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É "–û–ø–ª–∞—Ç–∏—Ç—å —Ä–µ–º–æ–Ω—Ç" –≤ –õ–ö.
    –°—Ä–∞–∑—É —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É.
    """
    query = update.callback_query
    await query.answer()

    request_id = int(query.data.split("_")[2])
    user_id = query.from_user.id

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            cursor = await conn.execute("""
                SELECT rr.estimated_price, rr.bike_id, u.phone_number, b.name as bike_name
                FROM repair_requests rr
                JOIN users u ON rr.user_id = u.id
                JOIN bikes b ON rr.bike_id = b.id
                WHERE rr.id=? AND rr.user_id=?
            """, (request_id, user_id))
            data = await cursor.fetchone()

        if not data or not data['estimated_price'] or float(data['estimated_price']) <= 0:
            await query.message.reply_text("üö´ –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—É–º–º–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã –∏–ª–∏ —Ä–µ–º–æ–Ω—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π.")
            return

        price = float(data['estimated_price'])

        if not data['phone_number']:
            await query.message.reply_text("üö´ –û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ –≤–∞—à–µ–º –ø—Ä–æ—Ñ–∏–ª–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ–∫–∞.")
            return

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–ª–∞—Ç–µ–∂
        description = f"–û–ø–ª–∞—Ç–∞ —Ä–µ–º–æ–Ω—Ç–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ '{data['bike_name']}' (–∑–∞—è–≤–∫–∞ #{request_id})"
        payload = f"repair_payment_{request_id}"
        metadata = {'internal_payload': payload, 'user_id': user_id}
        items = [{"description": description, "quantity": "1.00", "amount": {"value": f"{price:.2f}", "currency": "RUB"}, "vat_code": "1"}]
        customer = {"phone": data['phone_number']}

        payment_info = await create_yookassa_payment(price, description, metadata, items, customer, 'sbp')
        if not payment_info:
            await query.message.reply_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
            return

        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –¥—É–±–ª–µ–π
        await query.message.delete()

        # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∏ –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞
        payment_url, payment_id, final_amount = payment_info['url'], payment_info['id'], payment_info['final_amount']
        keyboard = [[InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —Ä–µ–º–æ–Ω—Ç", url=payment_url)]]
        animated_message = await context.bot.send_message(
            user_id,
            f"üõ†Ô∏è –î–ª—è –æ–ø–ª–∞—Ç—ã —Ä–µ–º–æ–Ω—Ç–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–ª–∞—Ç–∏—Ç–µ {final_amount:.2f} ‚ÇΩ.",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )

        if 'pending_payments' not in context.bot_data:
            context.bot_data['pending_payments'] = {}
        stop_animation_event = asyncio.Event()
        context.bot_data['pending_payments'][payment_id] = {
            'user_id': user_id, 'start_time': datetime.now(),
            'payload': payload, 'amount': final_amount,
            'animated_message_id': animated_message.message_id, 'url': payment_url,
            'animation_sequence': random.choice(PAYMENT_ANIMATIONS),
            'stop_animation_event': stop_animation_event
        }

        asyncio.create_task(animate_payment_message(context, payment_id))
        context.job_queue.run_repeating(
            callback=check_payment_status, interval=15, first=10,
            name=f"payment_{payment_id}", data={'yookassa_id': payment_id}
        )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ start_complete_repair_user –¥–ª—è –∑–∞—è–≤–∫–∏ #{request_id}: {e}", exc_info=True)
        await query.message.reply_text("üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É.")
    # ### –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–±–∏—Ä–∞–µ–º –∫–æ—Ç–∞ –∏ –∑–º–µ–π–∫—É ###
    # snake_text = "–ï—Å–ª–∏ –≤–∞–º —Å–∫—É—á–Ω–æ –Ω–∞ —Ä–∞–±–æ—Ç–µ –∏–ª–∏ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤, —Ç–æ –º–æ–∂–µ—Ç–µ –ø–æ–∏–≥—Ä–∞—Ç—å –≤ –∑–º–µ–π–∫—É :)\n/snake"
    # await update.message.reply_text(snake_text)
    # await update.message.reply_sticker("CAACAgIAAxkBAAEMt4tntcpyCUvi-YuNEGexnPmrq6Y_ZQACPyYAAgSZiUrBETgwCwOM1jYE")

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
# ### –ù–û–í–ê–Ø, –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
# ### –ù–û–í–ê–Ø, –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
import aiosqlite
import asyncio
import random
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ –≤–∞—à–µ–º –∫–æ–¥–µ:
# async def _get_deal_details_from_db(booking_id: int, conn: aiosqlite.Connection) -> dict | None: ...
# async def create_yookassa_payment(...) -> dict | None: ...
# async def animate_payment_message(context: ContextTypes.DEFAULT_TYPE, payment_id: str): ...
# async def check_payment_status(context: ContextTypes.DEFAULT_TYPE): ...

async def pay_next_installment(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø:
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–ø–ª–∞—Ç—É –æ—á–µ—Ä–µ–¥–Ω–æ–≥–æ –≤–∑–Ω–æ—Å–∞ –ø–æ —Ä–∞—Å—Å—Ä–æ—á–∫–µ (–≤—ã–∫—É–ø—É).
    1.  –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –¥–µ—Ç–∞–ª–∏ —Å–¥–µ–ª–∫–∏, –≤–∫–ª—é—á–∞—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π —Ç–∞—Ä–∏—Ñ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞, –∏–∑ –ë–î.
    2.  –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —á–µ–∫–∞.
    3.  –§–æ—Ä–º–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É —á–µ—Ä–µ–∑ –ÆKassa.
    4.  –ó–∞–ø—É—Å–∫–∞–µ—Ç —Ñ–æ–Ω–æ–≤—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞.
    """
    query = update.callback_query
    await query.answer()

    # –ò–∑–≤–ª–µ–∫–∞–µ–º ID –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑ callback_data (–Ω–∞–ø—Ä–∏–º–µ—Ä, "pay_next_123")
    booking_id = int(query.data.split('_')[2])
    user_id = query.from_user.id

    await query.message.edit_text("‚è≥ –ì–æ—Ç–æ–≤–ª—é —Å—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É...")

    try:
        # --- –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏ —Å–¥–µ–ª–∫–∏ –∏–∑ –ë–î ---
        async with aiosqlite.connect(DB_FILE) as conn:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
            deal_data = await _get_deal_details_from_db(booking_id, conn)

        if not deal_data:
            await query.message.edit_text("‚ùå –†–∞—Å—Å—Ä–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
            return

        # --- –®–∞–≥ 2: –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–ª–∞—Ç–µ–∂–∞ ---
        price = deal_data.get('buyout_payment_amount')
        phone_number = deal_data.get('phone_number')
        item_name = deal_data.get('bike_name')
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –º–µ—Å—Ç–µ
        if not price or price <= 0:
            await query.message.edit_text("‚ùå –û—à–∏–±–∫–∞: –¥–ª—è —ç—Ç–æ–π —Å–¥–µ–ª–∫–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.")
            return
        if not phone_number:
            await query.message.edit_text("üö´ –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –µ–≥–æ.")
            return

        # --- –®–∞–≥ 3: –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—á–µ—Ç —á–µ—Ä–µ–∑ –ÆKassa ---
        description = f"–û—á–µ—Ä–µ–¥–Ω–æ–π –≤–∑–Ω–æ—Å –ø–æ —Ä–∞—Å—Å—Ä–æ—á–∫–µ –∑–∞ {item_name}"
        payload = f"installment_{booking_id}"
        metadata = {'internal_payload': payload, 'user_id': user_id}
        customer_data = {"phone": phone_number}
        items_for_receipt = [{
            "description": description,
            "quantity": "1.00",
            "amount": {"value": f"{price:.2f}", "currency": "RUB"},
            "vat_code": "1",
            "payment_subject": "service",
            "payment_mode": "full_payment"
        }]

        # –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞, –∫–æ—Ç–æ—Ä–∞—è —É–∂–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Å–∫–∏–¥–∫–∏
        payment_info = await create_yookassa_payment(
            amount=price, 
            description=description, 
            metadata=metadata, 
            items=items_for_receipt, 
            customer_info=customer_data, 
            payment_method='sbp'
        )

        if not payment_info:
            await query.message.edit_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
            return

        payment_url = payment_info['url']
        payment_id = payment_info['id']
        final_amount = payment_info['final_amount']
        
        # --- –®–∞–≥ 4: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø–ª–∞—Ç–µ–∂–∞ ---
        keyboard = [[InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å –≤–∑–Ω–æ—Å", url=payment_url)]]
        animated_message = await query.message.edit_text(
            f"–¢—Ä–µ–±—É–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞ –æ—á–µ—Ä–µ–¥–Ω–æ–≥–æ –≤–∑–Ω–æ—Å–∞: {final_amount:.2f} ‚ÇΩ. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –æ–ø–ª–∞—Ç–µ.",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )

        if 'pending_payments' not in context.bot_data:
            context.bot_data['pending_payments'] = {}
            
        stop_animation_event = asyncio.Event()
        context.bot_data['pending_payments'][payment_id] = {
            'user_id': user_id, 
            'start_time': datetime.now(), 
            'payload': metadata['internal_payload'], 
            'amount': final_amount, 
            'animated_message_id': animated_message.message_id, 
            'url': payment_url, 
            'animation_sequence': random.choice(PAYMENT_ANIMATIONS), 
            'stop_animation_event': stop_animation_event 
        }
        
        asyncio.create_task(animate_payment_message(context, payment_id))
        
        context.job_queue.run_repeating(
            callback=check_payment_status, 
            interval=15, 
            first=10, 
            name=f"payment_{payment_id}", 
            data={'yookassa_id': payment_id}
        )

    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ pay_next_installment –¥–ª—è booking_id={booking_id}: {e}", exc_info=True)
        await query.message.edit_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.")

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ pay_full_amount –ù–ê –≠–¢–£

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
# ### –ù–û–í–ê–Ø, –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
# ### –ù–û–í–ê–Ø, –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
async def pay_full_amount(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø:
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏ –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç —Å—á–µ—Ç –Ω–∞ –¥–æ—Å—Ä–æ—á–Ω–æ–µ –ø–æ–≥–∞—à–µ–Ω–∏–µ,
    –∏—Å–ø–æ–ª—å–∑—É—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –≤—ã–∫—É–ø–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
    """
    query = update.callback_query
    await query.answer()
    booking_id = int(query.data.split('_')[2])
    user_id = query.from_user.id

    try:
        # --- –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏ —Å–¥–µ–ª–∫–∏ –∏–∑ –ë–î ---
        async with aiosqlite.connect(DB_FILE) as conn:
            deal_data = await _get_deal_details_from_db(booking_id, conn)

        if not deal_data:
            await query.message.reply_text("‚ùå –†–∞—Å—Å—Ä–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")
            return
        
        # --- –®–∞–≥ 2: –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Å—Ç–∞—Ç–æ–∫ –¥–æ–ª–≥–∞ ---
        total_payments = deal_data.get('buyout_total_payments', 0)
        payment_amount = deal_data.get('buyout_payment_amount', 0)
        payments_made = deal_data.get('payments_made', 0)
        
        if total_payments <= 0 or payment_amount <= 0:
            await query.message.reply_text("‚ùå –û—à–∏–±–∫–∞: –¥–ª—è —ç—Ç–æ–π —Å–¥–µ–ª–∫–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø–ª–∞–Ω –≤—ã–∫—É–ø–∞. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.")
            return

        payments_left = total_payments - payments_made
        remaining_amount = payments_left * payment_amount

        if remaining_amount <= 0:
            await query.message.reply_text("‚úÖ –†–∞—Å—Å—Ä–æ—á–∫–∞ —É–∂–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–≥–∞—à–µ–Ω–∞!")
            return

        # --- –®–∞–≥ 3: –§–æ—Ä–º–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—á–µ—Ç (–ª–æ–≥–∏–∫–∞ —Ç–∞ –∂–µ, –Ω–æ —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏) ---
        item_name = deal_data.get('bike_name')
        phone_number = deal_data.get('phone_number')

        if not phone_number:
            await query.message.reply_text("üö´ –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ–∫–∞.")
            return

        description = f"–ü–æ–ª–Ω–æ–µ –¥–æ—Å—Ä–æ—á–Ω–æ–µ –ø–æ–≥–∞—à–µ–Ω–∏–µ —Ä–∞—Å—Å—Ä–æ—á–∫–∏ –∑–∞ {item_name}"
        metadata = {'internal_payload': f"full_buyout_{booking_id}", 'user_id': user_id}
        # ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ YooKassa)
        
        customer_data = {"phone": phone_number}
        items_for_receipt = [{"description": description, "quantity": "1.00", "amount": {"value": str(float(remaining_amount)), "currency": "RUB"}, "vat_code": "1", "payment_subject": "service", "payment_mode": "full_payment"}]

        payment_info = await create_yookassa_payment(amount=remaining_amount, description=description, metadata=metadata, items=items_for_receipt, customer_info=customer_data, payment_method='sbp')

        if not payment_info:
            await query.message.reply_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É.")
            return

        payment_url, payment_id, final_amount = payment_info['url'], payment_info['id'], payment_info['final_amount']

        # ... (–∫–æ–¥ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–æ–π –∏ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏)
        keyboard = [[InlineKeyboardButton("üí≥ –ü–æ–≥–∞—Å–∏—Ç—å –¥–æ—Å—Ä–æ—á–Ω–æ", url=payment_url)]]
        animated_message = await query.message.reply_text(
            f"–°—É–º–º–∞ –¥–ª—è –¥–æ—Å—Ä–æ—á–Ω–æ–≥–æ –ø–æ–≥–∞—à–µ–Ω–∏—è: {final_amount:.2f} ‚ÇΩ. –ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –æ–ø–ª–∞—Ç–µ.",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )

        if 'pending_payments' not in context.bot_data: context.bot_data['pending_payments'] = {}
        stop_animation_event = asyncio.Event()
        context.bot_data['pending_payments'][payment_id] = {'user_id': user_id, 'start_time': datetime.now(), 'payload': metadata['internal_payload'], 'amount': final_amount, 'animated_message_id': animated_message.message_id, 'url': payment_url, 'animation_sequence': random.choice(PAYMENT_ANIMATIONS), 'stop_animation_event': stop_animation_event }
        asyncio.create_task(animate_payment_message(context, payment_id))
        context.job_queue.run_repeating(callback=check_payment_status, interval=15, first=10, name=f"payment_{payment_id}", data={'yookassa_id': payment_id})

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ pay_full_amount: {e}", exc_info=True)
        await query.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞.")


from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes

# –°–ª–æ–≤–∞—Ä–∏ –¥–ª—è –º–µ—Ç–æ–∫
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    filters,
    ConversationHandler,
    ContextTypes,
)

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes, CallbackQueryHandler, MessageHandler, CommandHandler, ConversationHandler, filters
from datetime import datetime
import sqlite3
import os

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏–π
MAIN_MENU, FILTERS_MENU, SORT_MENU, AWAITING_INPUT, SHOW_RESULTS, SHOW_REGISTERED_USERS = range(6)

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
SORT_LABELS = {
    'last_name': '–§–∞–º–∏–ª–∏–∏', 'first_name': '–ò–º–µ–Ω–∏', 'end_date': '–î–∞—Ç–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã'
}
# --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ó–∞–º–µ–Ω–µ–Ω–∞ 'pending' –Ω–∞ 'no_rental' ---
FILTER_LABELS = {
    'rented': '‚úÖ –ê—Ä–µ–Ω–¥–∞',
    'overdue': 'üî¥ –ü—Ä–æ—Å—Ä–æ—á–∫–∞',
    'no_rental': 'üö´ –ù–µ—Ç –∞—Ä–µ–Ω–¥—ã' # –ó–∞–º–µ–Ω–∏–ª–∏ '–û—á–µ—Ä–µ–¥—å' –Ω–∞ '–ù–µ—Ç –∞—Ä–µ–Ω–¥—ã'
}






# --- –ù–û–í–´–ô –ë–õ–û–ö: –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ---

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
USER_SEARCH_MENU, AWAITING_SEARCH_INPUT = range(2)

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
SORT_LABELS = {
    'last_name': '–§–∞–º–∏–ª–∏–∏', 'first_name': '–ò–º–µ–Ω–∏', 'end_date': '–î–∞—Ç–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã'
}
FILTER_LABELS = {
    'rented': '‚úÖ –ê—Ä–µ–Ω–¥–∞', 'overdue': 'üî¥ –ü—Ä–æ—Å—Ä–æ—á–∫–∞', 'pending': '‚è≥ –û—á–µ—Ä–µ–¥—å'
}
from typing import Tuple
### –ù–û–í–ê–Ø –í–ï–†–°–ò–Ø - —Å—Ç—Ä–æ–∏—Ç –º–µ–Ω—é –ø–æ–∏—Å–∫–∞ ###
### –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø - —Å—Ç—Ä–æ–∏—Ç –º–µ–Ω—é –ø–æ–∏—Å–∫–∞ ###
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
def build_user_search_menu(context: ContextTypes.DEFAULT_TYPE) -> Tuple[str, InlineKeyboardMarkup]:
    """–°—Ç—Ä–æ–∏—Ç —Ç–µ–∫—Å—Ç –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é –ø–æ–∏—Å–∫–∞."""
    filters = context.user_data.get('user_filters', set())
    search_term = context.user_data.get('user_search_term')

    filters_text = ""
    if search_term:
        filters_text = f"–ø–æ–∏—Å–∫ –ø–æ —Ñ–∞–º–∏–ª–∏–∏: '{search_term}'"
    elif filters:
        filters_text = ", ".join(FILTER_LABELS.get(f, f) for f in filters)
    else:
        filters_text = "–Ω–µ –≤—ã–±—Ä–∞–Ω—ã"

    text = (
        f"‚öôÔ∏è *–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π*\n\n"
        f"–¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:\n"
        f"‚î£ –§–∏–ª—å—Ç—Ä—ã: *{filters_text}*\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    )

    # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ó–∞–º–µ–Ω–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ '–û—á–µ—Ä–µ–¥—å' –Ω–∞ '–ù–µ—Ç –∞—Ä–µ–Ω–¥—ã' ---
    keyboard = [
        [InlineKeyboardButton(f"{'‚úÖ' if f in filters else '‚òëÔ∏è'} {label}", callback_data=f"user_filter_{f}") for f, label in [('rented', '–ê—Ä–µ–Ω–¥–∞'), ('overdue', '–ü—Ä–æ—Å—Ä–æ—á–∫–∞'), ('no_rental', '–ù–µ—Ç –∞—Ä–µ–Ω–¥—ã')]],
        [
            InlineKeyboardButton("üîç –í–≤–µ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å", callback_data="user_search_prompt"),
            InlineKeyboardButton("üöÄ –ü–æ–∫–∞–∑–∞—Ç—å", callback_data="user_show_results")
        ],
        [InlineKeyboardButton("üîÑ –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ", callback_data="user_reset_all")]
    ]
    return text, InlineKeyboardMarkup(keyboard)


async def search_users(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ù–∞—á–∏–Ω–∞–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–∏–∞–ª–æ–≥ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."""
    query = update.callback_query
    if query:
        await query.answer()

    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤—ã–π –≤—Ö–æ–¥
    if update.message:
        context.user_data.clear()

    text, reply_markup = build_user_search_menu(context)

    if query and query.message:
        await query.edit_message_text(text, reply_markup=reply_markup, parse_mode="Markdown")
    else:
        await update.message.reply_text(text, reply_markup=reply_markup, parse_mode="Markdown")

    return USER_SEARCH_MENU

### –ù–û–í–ê–Ø –í–ï–†–°–ò–Ø - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –º–µ–Ω—é –ø–æ–∏—Å–∫–∞ ###
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
async def handle_user_search_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–æ–∫ –≤ –º–µ–Ω—é –ø–æ–∏—Å–∫–∞."""
    query = update.callback_query
    await query.answer()

    action, _, value = query.data.partition('_')

    if action == 'user':
        sub_action, _, val = value.partition('_')

        if sub_action == 'filter':
            # –ü—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∏–ª—å—Ç—Ä–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∏—Å–∫ –ø–æ —Ñ–∞–º–∏–ª–∏–∏
            context.user_data.pop('user_search_term', None)
            filters = context.user_data.setdefault('user_filters', set())
            if val in filters:
                filters.remove(val)
            else:
                filters.add(val)

        elif sub_action == 'search': # prompt
            # –ü—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –Ω–∞ –ø–æ–∏—Å–∫ –ø–æ —Ñ–∞–º–∏–ª–∏–∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã
            context.user_data.pop('user_filters', None)
            context.user_data['user_sort_by'] = 'last_name'
            await query.message.reply_text("–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é –¥–ª—è –ø–æ–∏—Å–∫–∞:")
            return AWAITING_SEARCH_INPUT

        elif sub_action == 'show':
            await show_user_search_results(update, context)
            # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ ---
            # –ú—ã —É–∂–µ –ø–æ–∫–∞–∑–∞–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö.
            # –ù–µ –Ω—É–∂–Ω–æ –ø—ã—Ç–∞—Ç—å—Å—è –∑–∞–Ω–æ–≤–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ö–æ–¥–Ω–æ–µ –º–µ–Ω—é, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å.
            # –ü—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–µ–º—Å—è –≤ —Ç–æ–º –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–∏, —á—Ç–æ–±—ã –º–µ–Ω—é –ø—Ä–æ–¥–æ–ª–∂–∞–ª–æ —Ä–∞–±–æ—Ç–∞—Ç—å.
            return USER_SEARCH_MENU

        elif sub_action == 'reset':
            context.user_data.clear()

    # –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –º–µ–Ω—é —Å –Ω–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
    text, reply_markup = build_user_search_menu(context)
    try:
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ "Message not modified"
        # –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ —Ç–æ—Ç –∂–µ —Ñ–∏–ª—å—Ç—Ä
        await query.message.delete()
        await context.bot.send_message(
            chat_id=query.from_user.id,
            text=text,
            reply_markup=reply_markup,
            parse_mode="Markdown"
        )
    except Exception as e:
        # –ï—Å–ª–∏ —É–¥–∞–ª–∏—Ç—å –Ω–µ —É–¥–∞–ª–æ—Å—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä–æ–µ), –ø—Ä–æ—Å—Ç–æ –ø—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ.
        if "message to delete not found" in str(e).lower():
             await context.bot.send_message(
                chat_id=query.from_user.id,
                text=text,
                reply_markup=reply_markup,
                parse_mode="Markdown"
            )
        else:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å/–æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")

    return USER_SEARCH_MENU

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£

async def handle_user_search_input(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ñ–∞–º–∏–ª–∏—é, –ù–ï–ú–ï–î–õ–ï–ù–ù–û –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã,
    –∞ –∑–∞—Ç–µ–º –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –º–µ–Ω—é –ø–æ–∏—Å–∫–∞.
    """
    search_term = update.message.text.strip()

    # 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    # –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—â–µ—Ç –ø–æ —Ñ–∞–º–∏–ª–∏–∏, –º—ã —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã
    context.user_data.pop('user_filters', None)
    context.user_data['user_search_term'] = search_term
    context.user_data['user_sort_by'] = 'last_name' # –ñ–µ—Å—Ç–∫–æ –∑–∞–¥–∞–µ–º –ø–æ–∏—Å–∫ –ø–æ —Ñ–∞–º–∏–ª–∏–∏

    # <<< –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï >>>
    # 2. –°—Ä–∞–∑—É –∂–µ –≤—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    await show_user_search_results(update, context)

    # 3. –ü–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, —Å–Ω–æ–≤–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –º–µ–Ω—é –ø–æ–∏—Å–∫–∞ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π
    await search_users(update, context)

    # 4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–Ω—é –ø–æ–∏—Å–∫–∞
    return USER_SEARCH_MENU


# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –ü–û–õ–ù–û–°–¢–¨–Æ
async def show_user_search_results(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ –ë–î, –Ω–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –µ–¥–∏–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É."""
    message = update.effective_message

    filters = context.user_data.get('user_filters', set())
    search_term = context.user_data.get('user_search_term')

    # --- –≠–¢–ê–ü 1: –ù–∞–π—Ç–∏ –£–ù–ò–ö–ê–õ–¨–ù–´–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –ø–æ–¥ –∫—Ä–∏—Ç–µ—Ä–∏–∏ ---
    # –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—Ç–æ–ª–±–µ—Ü 'username' –≤–º–µ—Å—Ç–æ 'tg_username'
    user_query_parts = ["SELECT DISTINCT u.id, u.first_name, u.last_name, u.username, u.phone_number FROM users u"]
    user_conditions = []
    user_params = []

    if 'rented' in filters or 'overdue' in filters:
        user_query_parts.append("JOIN bookings b ON u.id = b.user_id")

    if 'rented' in filters:
        user_conditions.append("b.status = 'rented'")
    if 'overdue' in filters:
        user_conditions.append("(b.status = 'rented' AND DATE(SUBSTR(b.end_date, 7, 4) || '-' || SUBSTR(b.end_date, 4, 2) || '-' || SUBSTR(b.end_date, 1, 2)) < DATE('now'))")
    
    if 'no_rental' in filters:
        user_conditions.append("NOT EXISTS (SELECT 1 FROM bookings b WHERE b.user_id = u.id AND b.status = 'rented')")

    if search_term:
        user_conditions.append("u.last_name LIKE ?")
        user_params.append(f"%{search_term}%")

    if user_conditions:
        user_query_parts.append("WHERE " + " AND ".join(user_conditions))

    user_query_parts.append("ORDER BY u.last_name, u.first_name")
    final_user_query = " ".join(user_query_parts)

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            user_cursor = await conn.execute(final_user_query, user_params)
            users = await user_cursor.fetchall()

            if not users:
                await context.bot.send_message(message.chat.id, "üö´ –ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
                return

            await context.bot.send_message(message.chat.id, f"‚úÖ –ù–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(users)}. –§–æ—Ä–º–∏—Ä—É—é –∫–∞—Ä—Ç–æ—á–∫–∏...")

            for user in users:
                user_id = user['id']

                booking_cursor = await conn.execute("""
                    SELECT b.booking_type, b.end_date, bk.name as bike_name, b.payments_made, b.payment_plan_key
                    FROM bookings b
                    JOIN bikes bk ON b.bike_id = bk.id
                    WHERE b.user_id = ? AND b.status = 'rented'
                """, (user_id,))
                bookings = await booking_cursor.fetchall()

                # –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º 'username' –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∏–∫–∞
                caption_parts = [
                    f"üë§ *{user['first_name']} {user['last_name']}*",
                    f"   - ID: `{user_id}`",
                    f"   - –ù–∏–∫ TG: `@{user['username'] or 'N/A'}`", # <-- –ò–°–ü–†–ê–í–õ–ï–ù–û –ó–î–ï–°–¨
                    f"   - –¢–µ–ª–µ—Ñ–æ–Ω: `{user['phone_number'] or '–ù–µ —É–∫–∞–∑–∞–Ω'}`",
                    "---"
                ]

                if not bookings:
                    caption_parts.append("_–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—Ä–µ–Ω–¥ –∏–ª–∏ –≤—ã–∫—É–ø–æ–≤._")
                else:
                    for booking in bookings:
                        if booking['booking_type'] == 'rent':
                            is_overdue = False
                            if booking['end_date']:
                                try:
                                    end_date_obj = datetime.strptime(booking['end_date'], "%d.%m.%Y").date()
                                    if end_date_obj < datetime.now().date():
                                        is_overdue = True
                                except ValueError: pass
                            status_emoji = "üî¥" if is_overdue else "üü¢"
                            caption_parts.append(f"{status_emoji} –ê—Ä–µ–Ω–¥–∞: `{booking['bike_name']}` –¥–æ `{booking['end_date'] or '??'}`")
                        elif booking['booking_type'] == 'buyout':
                            plan = BUYOUT_PLANS.get(booking['payment_plan_key'])
                            if plan:
                                total_payments = plan.get('total_payments', '?')
                                caption_parts.append(f"üí∞ –í—ã–∫—É–ø: `{booking['bike_name']}` ({booking['payments_made']}/{total_payments} –ø–ª.)")

                await context.bot.send_message(message.chat.id, "\n".join(caption_parts), parse_mode="Markdown")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ show_user_search_results: {e}", exc_info=True)
        await message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î: {e}")
async def universal_cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Universally cancels and ends the conversation, returning to the main menu."""
    user_id = update.effective_user.id
    await update.message.reply_text(
        "–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ. –í–æ–∑–≤—Ä–∞—â–∞—é –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.",
        reply_markup=get_main_menu(user_id)
    )
    context.user_data.clear()
    return ConversationHandler.END
# –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚úÖ
from telegram import InputMediaPhoto # –ù–µ –∑–∞–±—É–¥—å—Ç–µ —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç

import os # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
from telegram import InputMediaPhoto, InlineKeyboardButton, InlineKeyboardMarkup


import os # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
from telegram import InputMediaPhoto, InlineKeyboardButton, InlineKeyboardMarkup

async def verify_user(update: Update, context) -> None:
    admin_id = update.message.from_user.id
    if not is_admin(admin_id):
        await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")
        return

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï 1: –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ "country" –≤ –∑–∞–ø—Ä–æ—Å >>>
    cursor.execute("SELECT id, first_name, last_name, passport_photo, username, country FROM users WHERE verified=0")
    users_to_verify = cursor.fetchall()
    conn.close()

    if not users_to_verify:
        await update.message.reply_text("üö´ –ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏.")
        return

    await update.message.reply_text("‚è≥ –ó–∞—è–≤–∫–∏ –Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é:")

    for user_data in users_to_verify:
        # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï 2: –ü–æ–ª—É—á–∞–µ–º "country" –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞ >>>
        (user_id_to_verify, first_name, last_name, passport_folder_path, username, country) = user_data

        info_caption = (
            f"–ò–º—è: {first_name} {last_name or ''}\n"
            f"ID: {user_id_to_verify}\n"
            f"@{username if username else '–ù–µ—Ç username'}"
        )

        if not (passport_folder_path and os.path.isdir(passport_folder_path)):
            caption_no_photo = f"{info_caption}\n\n‚ö†Ô∏è –§–æ—Ç–æ –ø–∞—Å–ø–æ—Ä—Ç–∞ –Ω–µ –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º."
            # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï 3: –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É, –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ >>>
            keyboard = [[InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å (–±–µ–∑ —Ñ–æ—Ç–æ)", callback_data=f"verify_{user_id_to_verify}")]]
            await update.message.reply_text(text=caption_no_photo, reply_markup=InlineKeyboardMarkup(keyboard))
            continue # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

        try:
            media_group = []

            # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï 4: –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤–æ –∏ –∏—â–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã >>>
            if country == '–†–§':
                # –§–∞–π–ª—ã –¥–ª—è –≥—Ä–∞–∂–¥–∞–Ω –†–§
                paths_to_check = {
                    "–û—Å–Ω–æ–≤–Ω–æ–π —Ä–∞–∑–≤–æ—Ä–æ—Ç": os.path.join(passport_folder_path, "1_main_passport.jpg"),
                    "–ü—Ä–æ–ø–∏—Å–∫–∞": os.path.join(passport_folder_path, "2_registration_passport.jpg"),
                    "–°–µ–ª—Ñ–∏ —Å –ø–∞—Å–ø–æ—Ä—Ç–æ–º": os.path.join(passport_folder_path, "3_selfie_with_passport.jpg"),
                }
            else: # –î–ª—è –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã—Ö –≥—Ä–∞–∂–¥–∞–Ω
                paths_to_check = {
                    "–ü–∞—Å–ø–æ—Ä—Ç": os.path.join(passport_folder_path, "1_foreign_passport.jpg"),
                    "–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è": os.path.join(passport_folder_path, "2_registration.jpg"),
                    "–ü–∞—Ç–µ–Ω—Ç": os.path.join(passport_folder_path, "3_patent.jpg"),
                }

            # –°–æ–±–∏—Ä–∞–µ–º –º–µ–¥–∏–∞ –≥—Ä—É–ø–ø—É –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤
            for caption, path in paths_to_check.items():
                if os.path.exists(path):
                    # –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª –≤ –±–∏–Ω–∞—Ä–Ω–æ–º —Ä–µ–∂–∏–º–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                    media_group.append(InputMediaPhoto(media=open(path, 'rb'), caption=caption))

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            if media_group:
                await context.bot.send_media_group(chat_id=admin_id, media=media_group)

                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –∫–Ω–æ–ø–∫—É
                keyboard = [[InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é", callback_data=f"verify_{user_id_to_verify}")]]
                await context.bot.send_message(
                    chat_id=admin_id,
                    text=f"–ó–∞—è–≤–∫–∞ –Ω–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é:\n{info_caption}",
                    reply_markup=InlineKeyboardMarkup(keyboard)
                )
            else:
                # –ï—Å–ª–∏ –ø–∞–ø–∫–∞ –µ—Å—Ç—å, –Ω–æ —Ñ–æ—Ç–æ –≤ –Ω–µ–π –Ω–µ—Ç
                caption_no_photo = f"{info_caption}\n\n‚ö†Ô∏è –ü–∞–ø–∫–∞ —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –ø—É—Å—Ç–∞."
                keyboard = [[InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å (–±–µ–∑ —Ñ–æ—Ç–æ)", callback_data=f"verify_{user_id_to_verify}")]]
                await update.message.reply_text(text=caption_no_photo, reply_markup=InlineKeyboardMarkup(keyboard))

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ç–æ –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ user {user_id_to_verify}: {e}")
            # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ —Å –∫–Ω–æ–ø–∫–æ–π
            keyboard = [[InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å (–Ω–µ—Å–º–æ—Ç—Ä—è –Ω–∞ –æ—à–∏–±–∫—É)", callback_data=f"verify_{user_id_to_verify}")]]
            await context.bot.send_message(
                chat_id=admin_id,
                text=f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ –¥–ª—è –∑–∞—è–≤–∫–∏:\n{info_caption}\n–û—à–∏–±–∫–∞: {e}",
                reply_markup=InlineKeyboardMarkup(keyboard)
            )


# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è üü¢
async def confirm_user_verification(update: Update, context) -> None:
    query = update.callback_query
    await query.answer()

    # –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞—è–≤–∫–æ–π
    try:
        await context.bot.delete_message(
            chat_id=query.message.chat_id,
            message_id=query.message.message_id
        )
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")

    user_id = int(query.data.split('_')[1])

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("UPDATE users SET verified=1 WHERE id=?", (user_id,))
    conn.commit()
    conn.close()

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
    await query.message.reply_text("‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω!")

    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await context.bot.send_message(
        chat_id=user_id,
        text="–í–∞—à–∞ —É—á–µ—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å –±—ã–ª–∞ —É—Å–ø–µ—à–Ω–æ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!"
    )
from telegram.helpers import escape_markdown


from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import CallbackContext
import sqlite3
from telegram.helpers import escape_markdown




# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
# –£–î–ê–õ–ò–¢–ï –°–¢–ê–†–´–ï –§–£–ù–ö–¶–ò–ò: show_booking_status, send_paginated_section, pagibron
# –ò –í–°–¢–ê–í–¨–¢–ï –í–ú–ï–°–¢–û –ù–ò–• –≠–¢–£ –û–î–ù–£ –§–£–ù–ö–¶–ò–Æ

# –ù–ê–ô–î–ò–¢–ï –≠–¢–£ –§–£–ù–ö–¶–ò–Æ –ò –í–ù–ï–°–ò–¢–ï –ò–ó–ú–ï–ù–ï–ù–ò–Ø

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

async def manage_bookings_panel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –°–æ–∑–¥–∞–µ—Ç –µ–¥–∏–Ω—É—é –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ–º–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏.
    """
    user = update.effective_user
    if not is_admin(user.id):
        await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
        return

    if update.callback_query:
        await update.callback_query.answer()

    message = update.message or update.callback_query.message

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï ‚Ññ1: –î–æ–±–∞–≤–ª—è–µ–º b.booking_date –≤ SELECT >>>
            cursor = await conn.execute("""
                SELECT b.id, b.status, u.first_name, u.last_name, u.username,
                       bk.name as bike_name, b.booking_date
                FROM bookings b
                JOIN users u ON b.user_id = u.id
                JOIN bikes bk ON b.bike_id = bk.id
                WHERE b.status IN ('pending', 'confirmed')
                ORDER BY CASE b.status
                    WHEN 'pending' THEN 1
                    WHEN 'confirmed' THEN 2
                    ELSE 3
                END, b.booking_date DESC
            """)
            all_requests = await cursor.fetchall()

        if not all_requests:
            await message.reply_text("‚úÖ –í—Å–µ –∑–∞—è–≤–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã, –Ω–æ–≤—ã—Ö –Ω–µ—Ç.")
            return

        requests_by_status = {
            'pending': [],
            'confirmed': []
        }
        for req in all_requests:
            if req['status'] in requests_by_status:
                requests_by_status[req['status']].append(req)

        message_parts = ["*üõ†Ô∏è –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏*\n"]
        keyboard = []

        if requests_by_status['pending']:
            message_parts.append("\n*–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ (–æ–∂–∏–¥–∞—é—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è):*")
            for req in requests_by_status['pending']:
                # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï ‚Ññ2: –ò–∑–≤–ª–µ–∫–∞–µ–º –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è >>>
                booking_time_str = req['booking_date'].split(' ')[1] # –ü–æ–ª—É—á–∞–µ–º "19:00" –∏–∑ "02.07.2025 19:00"
                user_display = f"{req['first_name']} {req['last_name'] or ''}"
                message_parts.append(f"‚Ä¢ ID {req['id']}: `{req['bike_name']}` –æ—Ç *{user_display}* –Ω–∞ *{booking_time_str}*")
                keyboard.append([
                    InlineKeyboardButton(f"‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å #{req['id']}", callback_data=f"confirm_{req['id']}"),
                    InlineKeyboardButton(f"‚ùå –û—Ç–º–µ–Ω–∏—Ç—å #{req['id']}", callback_data=f"cancel_{req['id']}")
                ])

        if requests_by_status['confirmed']:
            message_parts.append("\n*–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ (–æ–∂–∏–¥–∞—é—Ç –≤—ã–¥–∞—á–∏):*")
            for req in requests_by_status['confirmed']:
                # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï ‚Ññ3: –¢–æ –∂–µ —Å–∞–º–æ–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö –±—Ä–æ–Ω–µ–π >>>
                booking_time_str = req['booking_date'].split(' ')[1]
                user_display = f"{req['first_name']} {req['last_name'] or ''}"
                message_parts.append(f"‚Ä¢ ID {req['id']}: `{req['bike_name']}` –æ—Ç *{user_display}* –Ω–∞ *{booking_time_str}*")

                # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï ‚Ññ4: –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É –∫–æ—Ä–æ—Ç–∫–æ–π –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–π >>>
                button_text = f"üö´ –û—Ç–º–µ–Ω–∏—Ç—å ({req['last_name']} {booking_time_str})"
                keyboard.append([InlineKeyboardButton(button_text, callback_data=f"cancel_{req['id']}")])

        keyboard.append([InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="refresh_bookings_panel")])

        final_message = "\n".join(message_parts)
        reply_markup = InlineKeyboardMarkup(keyboard)

        if update.callback_query:
            await message.edit_text(final_message, reply_markup=reply_markup, parse_mode="Markdown")
        else:
            await message.reply_text(final_message, reply_markup=reply_markup, parse_mode="Markdown")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ manage_bookings_panel: {e}", exc_info=True)
        await message.reply_text("üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–∞–Ω–µ–ª–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π.")
# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞

# –£–¥–∞–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º üóëÔ∏è
async def delete_booking(update: Update, context) -> None:
    query = update.callback_query
    await query.answer()
    booking_id = query.data.split("_")[1]

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º bike_id –∏ user_id –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    cursor.execute("SELECT bike_id, user_id FROM bookings WHERE id=?", (booking_id,))
    booking_info = cursor.fetchone()

    if booking_info:
        bike_id, user_id = booking_info

        # –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
        cursor.execute("DELETE FROM bookings WHERE id=?", (booking_id,))

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –Ω–∞ "–≤ –Ω–∞–ª–∏—á–∏–∏" –∏ —É–¥–∞–ª—è–µ–º reserved_by
        cursor.execute("UPDATE bikes SET available=1, reserved_date=NULL, reserved_by=NULL WHERE id=?", (bike_id,))

        conn.commit()

        # –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
        log_bike_action(bike_id, user_id, "–ë—Ä–æ–Ω—å –æ—Ç–º–µ–Ω–µ–Ω–∞.")

        await query.message.reply_text("‚úÖ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω–æ –∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥ —Å—Ç–∞–ª –¥–æ—Å—Ç—É–ø–µ–Ω!")

        # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–± –æ—Ç–º–µ–Ω–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        await context.bot.send_message(chat_id=user_id, text="üîî –í–∞—à–∞ –±—Ä–æ–Ω—å –±—ã–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.")
    else:
        await query.message.reply_text("üö´ –û—à–∏–±–∫–∞: –±—Ä–æ–Ω—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")

    conn.close()

# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º ‚úîÔ∏è
### –ù–û–í–ê–Ø, –ü–û–õ–ù–û–°–¢–¨–Æ –ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –ò –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
async def confirm_booking_admin(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –ë–î,
    —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫.
    """
    query = update.callback_query
    await query.answer()
    booking_id = int(query.data.split("_")[1])

    try:
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        async with aiosqlite.connect(DB_FILE, timeout=10) as conn:
            # –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é, —á—Ç–æ–±—ã –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±—ã–ª–∏ –µ–¥–∏–Ω—ã–º —Ü–µ–ª—ã–º
            await conn.execute('BEGIN')

            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
            cursor = await conn.execute("""
                SELECT b.bike_id, b.booking_date, b.user_id, u.first_name, u.last_name, u.username
                FROM bookings b
                JOIN users u ON b.user_id = u.id
                WHERE b.id=?
            """, (booking_id,))
            booking_info = await cursor.fetchone()

            if not booking_info:
                await query.message.reply_text("üö´ –û—à–∏–±–∫–∞: –±—Ä–æ–Ω—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
                await conn.rollback() # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                return

            bike_id, booking_date, user_id, first_name, last_name, username = booking_info

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å 'confirmed' –¥–ª—è —Ç–µ–∫—É—â–µ–π –±—Ä–æ–Ω–∏
            await conn.execute("UPDATE bookings SET status='confirmed' WHERE id=?", (booking_id,))

            # –î–µ–ª–∞–µ–º –≤–µ–ª–æ—Å–∏–ø–µ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º
            await conn.execute("UPDATE bikes SET available=0, reserved_date=? WHERE id=?", (booking_date, bike_id))

            # –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ, –ø–µ—Ä–µ–¥–∞–≤–∞—è –æ–±—ä–µ–∫—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            await log_bike_action(conn, bike_id, user_id, "–ë—Ä–æ–Ω—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.")

            # –ï—Å–ª–∏ –≤—Å–µ —É—Å–ø–µ—à–Ω–æ, —Ñ–∏–∫—Å–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ë–î
            await conn.commit()

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫—Ä–∞—Å–∏–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        user_name = f"{first_name} {last_name or ''}".strip()
        user_mention = f"(@{username})" if username else ""
        notification_text = (
            f"‚úÖ –í–∞—à–∞ –±—Ä–æ–Ω—å –Ω–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!\n\n"
            f"üìÖ **–î–∞—Ç–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:** {booking_date}\n\n"
            f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–π–¥–∏—Ç–µ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∞—Ä–µ–Ω–¥—ã."
        )

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        await context.bot.send_message(
            chat_id=user_id,
            text=notification_text,
            parse_mode="Markdown"
        )

        # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –∏ –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        await query.edit_message_text(f"‚úÖ –ë—Ä–æ–Ω—å –¥–ª—è {user_name} {user_mention} –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω.")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è #{booking_id}: {e}", exc_info=True)
        # –ï—Å–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é (–≤ async with —ç—Ç–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏)
        await query.message.reply_text("üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –±—Ä–æ–Ω–∏. –°–º. –ª–æ–≥–∏.")


# –û—Ç–º–µ–Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º ‚ùå
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –ê–°–ò–ù–•–†–û–ù–ù–£–Æ –í–ï–†–°–ò–Æ

async def cancel_booking_admin(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()
    booking_id = int(query.data.split("_")[1])

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            await conn.execute('BEGIN')

            # –ü–æ–ª—É—á–∞–µ–º bike_id –∏ user_id –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
            cursor = await conn.execute("SELECT bike_id, user_id FROM bookings WHERE id=?", (booking_id,))
            booking_info = await cursor.fetchone()

            if not booking_info:
                await query.message.reply_text("üö´ –û—à–∏–±–∫–∞: –±—Ä–æ–Ω—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
                await conn.rollback()
                return

            bike_id, user_id = booking_info

            # –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
            await conn.execute("DELETE FROM bookings WHERE id=?", (booking_id,))

            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –Ω–∞ "–¥–æ—Å—Ç—É–ø–µ–Ω"
            await conn.execute("UPDATE bikes SET available=1, reserved_date=NULL, reserved_by=NULL WHERE id=?", (bike_id,))

            # <<< –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –í–´–ó–û–í –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø >>>
            await log_bike_action(conn, bike_id, user_id, action="–û—Ç–º–µ–Ω–∞ –±—Ä–æ–Ω–∏ (–∞–¥–º–∏–Ω)")

            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ (–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π)
            # ... (–∑–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –æ—á–µ—Ä–µ–¥–∏, –µ—Å–ª–∏ –æ–Ω–∞ –Ω—É–∂–Ω–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ)

            await conn.commit()

        await query.message.edit_text("‚ùå –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ!")
        await context.bot.send_message(chat_id=user_id, text="üîî –í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±—ã–ª–æ –æ—Ç–º–µ–Ω–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∞–¥–º–∏–Ω–æ–º #{booking_id}: {e}", exc_info=True)
        await query.message.reply_text("üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –±—Ä–æ–Ω–∏.")

async def cancel_booking_command(update: Update, context) -> None:
    user_id = update.message.from_user.id

    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –ë–î –∏ –∏—â–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT id, bike_id FROM bookings WHERE user_id=? AND status='pending'", (user_id,))
    active_bookings = cursor.fetchall()
    conn.close()

    # –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    if active_bookings:
        # –°–ø—Ä–∞—à–∏–≤–∞–µ–º, –∫–∞–∫—É—é –±—Ä–æ–Ω—å –æ—Ç–º–µ–Ω–∏—Ç—å
        keyboard = [[InlineKeyboardButton(f"–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ID: {booking[0]}", callback_data=f"cancel_booking_{booking[0]}")] for booking in active_bookings]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–æ–Ω—å –¥–ª—è –æ—Ç–º–µ–Ω—ã:", reply_markup=reply_markup)
    else:
        await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–µ–π –¥–ª—è –æ—Ç–º–µ–Ω—ã.")


async def cancel_booking(update: Update, context) -> None:
    query = update.callback_query
    await query.answer()
    booking_id = query.data.split("_")[2]

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º bike_id –∏ user_id –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    cursor.execute("SELECT bike_id, user_id FROM bookings WHERE id=?", (booking_id,))
    booking_info = cursor.fetchone()

    if booking_info:
        bike_id, user_id = booking_info

        # –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
        cursor.execute("DELETE FROM bookings WHERE id=?", (booking_id,))

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –Ω–∞ "–¥–æ—Å—Ç—É–ø–µ–Ω" –∏ —É–¥–∞–ª—è–µ–º reserved_by
        cursor.execute("UPDATE bikes SET available=1, reserved_date=NULL, reserved_by=NULL WHERE id=?", (bike_id,))

        # –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–º–µ–Ω—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        log_bike_action(bike_id, user_id, "–ë—Ä–æ–Ω—å —É–¥–∞–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.")

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏
        cursor.execute("SELECT id, user_id, status FROM queue ORDER BY created_at ASC")
        queue = cursor.fetchall()

        if queue:
            first_user_id = queue[0][1]  # –ü–æ–ª—É—á–∞–µ–º user_id –ø–µ—Ä–≤–æ–≥–æ –≤ –æ—á–µ—Ä–µ–¥–∏
            first_user_status = queue[0][2]  # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–≤–æ–≥–æ –≤ –æ—á–µ—Ä–µ–¥–∏

            if first_user_status == 'pending':
                # –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 'pending', –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ —Å—Ç–∞—Ç—É—Å –Ω–∞ 'first_user'
                cursor.execute("UPDATE queue SET status='first_user' WHERE user_id = ?", (first_user_id,))
                await context.bot.send_message(chat_id=first_user_id, text="üéâ –í–∞–º –¥–æ—Å—Ç—É–ø–µ–Ω –≤–µ–ª–æ—Å–∏–ø–µ–¥! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∞—Ä–µ–Ω–¥—É.")

            elif first_user_status == 'first_user':
                # –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 'first_user', —É–¥–∞–ª—è–µ–º –µ–≥–æ –∏–∑ –æ—á–µ—Ä–µ–¥–∏
                cursor.execute("DELETE FROM queue WHERE user_id = ?", (first_user_id,))

                if len(queue) > 1:
                    # –ï—Å–ª–∏ –≤ –æ—á–µ—Ä–µ–¥–∏ –µ—Å—Ç—å –¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, —Å–¥–≤–∏–≥–∞–µ–º –∏—Ö
                    for idx, (queue_id, queued_user_id, _) in enumerate(queue[1:], start=1):
                        cursor.execute("UPDATE queue SET created_at = ? WHERE id = ?", (idx, queue_id))

                    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–æ–≤–æ–≥–æ –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ 'first_user'
                    new_first_user_id = queue[1][1]
                    cursor.execute("UPDATE queue SET status='first_user' WHERE user_id = ?", (new_first_user_id,))
                    await context.bot.send_message(chat_id=new_first_user_id, text="üéâ –í–∞–º –¥–æ—Å—Ç—É–ø–µ–Ω –≤–µ–ª–æ—Å–∏–ø–µ–¥! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∞—Ä–µ–Ω–¥—É.")

        conn.commit()
        await query.message.reply_text("‚ùå –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ!")

        # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–± –æ—Ç–º–µ–Ω–µ
        await context.bot.send_message(chat_id=user_id, text="üîî –í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±—ã–ª–æ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    else:
        await query.message.reply_text("üö´ –û—à–∏–±–∫–∞: –±—Ä–æ–Ω—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")

    conn.close()

SELECT_USER, ENTER_AMOUNT, ENTER_REASON, ENTER_DUE_DATE = range(4)

(VIEW_FINES_MENU, VIEW_FINES_CATEGORY, REJECT_REASON) = range(3)

async def view_fines_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —à—Ç—Ä–∞—Ñ–æ–≤"""
    if not is_admin(update.message.from_user.id):
        await update.message.reply_text("‚ùå –ù–µ—Ç –ø—Ä–∞–≤!")
        return ConversationHandler.END

    keyboard = [
        [
            InlineKeyboardButton("üö´ –ù–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ", callback_data="view_unpaid"),
            InlineKeyboardButton("‚úÖ –û–ø–ª–∞—á–µ–Ω–Ω—ã–µ", callback_data="view_paid")
        ],
        [
            InlineKeyboardButton("üìù –ó–∞—è–≤–∫–∏", callback_data="view_disputed"),
            InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="view_cancel")
        ]
    ]

    await update.message.reply_text(
        "üìã –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —à—Ç—Ä–∞—Ñ–æ–≤:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
    return VIEW_FINES_CATEGORY

async def show_fines_category(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏."""
    query = update.callback_query
    await query.answer()

    status_map = {
        "view_unpaid": "unpaid",
        "view_paid": "paid",
        "view_disputed": "disputed"
    }

    if query.data == "view_cancel":
        await query.edit_message_text("üö´ –ü—Ä–æ—Å–º–æ—Ç—Ä —à—Ç—Ä–∞—Ñ–æ–≤ –æ—Ç–º–µ–Ω–µ–Ω")
        return ConversationHandler.END

    status = status_map.get(query.data)
    if not status:
        await query.edit_message_text("‚ùå –û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏!")
        return ConversationHandler.END

    # –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∫–∞–∑–∞ —à—Ç—Ä–∞—Ñ–æ–≤ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π (–Ω–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
    await show_fines_by_status(update, context, status, page=0)
    return ConversationHandler.END
from telegram import InputMediaPhoto, InputMediaVideo
from telegram.helpers import escape_markdown
async def show_fines_by_status(update: Update, context: ContextTypes.DEFAULT_TYPE, status: str, page: int = 0) -> None:
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —à—Ç—Ä–∞—Ñ—ã —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π –∏ —Ä–∞–∑–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º"""
    ITEMS_PER_PAGE = 1 if status == 'disputed' else 5

    status_names = {
        'unpaid': ('üö´ –ù–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ —à—Ç—Ä–∞—Ñ—ã', '–ù–µ–æ–ø–ª–∞—á–µ–Ω'),
        'paid': ('‚úÖ –û–ø–ª–∞—á–µ–Ω–Ω—ã–µ —à—Ç—Ä–∞—Ñ—ã', '–û–ø–ª–∞—á–µ–Ω'),
        'disputed': ('üìù –ó–∞—è–≤–∫–∏ –Ω–∞ –æ—Å–ø–∞—Ä–∏–≤–∞–Ω–∏–µ', '–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏')
    }

    title, rus_status = status_names[status]
    chat_id = update.effective_chat.id

    with sqlite3.connect(DB_FILE) as conn:
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
        if status == 'unpaid':
            cursor.execute('SELECT COUNT(*) FROM fines WHERE status IN ("unpaid", "disputed")')
        else:
            cursor.execute('SELECT COUNT(*) FROM fines WHERE status = ?', (status,))
        total_items = cursor.fetchone()[0]

        if total_items == 0:
            await context.bot.send_message(chat_id, "üì≠ –®—Ç—Ä–∞—Ñ—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç")
            return

        total_pages = (total_items + ITEMS_PER_PAGE - 1) // ITEMS_PER_PAGE

        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        offset = page * ITEMS_PER_PAGE
        query = '''
            SELECT
                f.id, u.first_name, u.last_name, u.username,
                f.amount, f.reason, f.created_at,
                f.dispute_comment, f.dispute_photo, f.dispute_video
            FROM fines f
            JOIN users u ON f.user_id = u.id
        '''
        query += ' WHERE f.status IN ("unpaid", "disputed")' if status == 'unpaid' else ' WHERE f.status = ?'
        query += ' ORDER BY f.created_at DESC LIMIT ? OFFSET ?'

        params = (status,) if status != 'unpaid' else ()
        params += (ITEMS_PER_PAGE, offset)

        cursor.execute(query, params)
        fines = cursor.fetchall()

    if not fines:
        await context.bot.send_message(chat_id, "üì≠ –®—Ç—Ä–∞—Ñ—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç")
        return

    # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–±–µ–∑ —Ä—É—á–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ—á–µ–∫)
    def escape(text: str) -> str:
        return escape_markdown(str(text), version=2)

    # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    message_parts = []
    if status == 'disputed':
        fine = fines[0]
        name = escape(f"{fine[1]} {fine[2]}" if fine[1] and fine[2] else "–ù–µ —É–∫–∞–∑–∞–Ω–æ")
        username = escape(f"@{fine[3]}" if fine[3] else "–Ω–µ—Ç username")
        reason = escape(fine[5])
        amount = escape(f"{fine[4]:.2f}")
        date = escape(datetime.strptime(fine[6], "%Y-%m-%d %H:%M:%S").strftime("%d.%m.%Y") if '-' in fine[6] else fine[6])
        comment = escape(fine[7]) if fine[7] else ""

        message_parts.extend([
            f"{title}\n",
            f"‚ñ´Ô∏è *{name}* \\({username}\\)",
            f"üî∏ –ü—Ä–∏—á–∏–Ω–∞: {reason}",
            f"üî∏ –°—É–º–º–∞: {amount}‚ÇΩ",
            f"üî∏ –î–∞—Ç–∞: {date}",
            f"üî∏ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {comment}" if comment else "",
            f"üÜî ID: `{fine[0]}`",
            f"üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page + 1}/{total_pages}"
        ])

        media = None
        if fine[8]:
            media = InputMediaPhoto(media=fine[8], caption='\n'.join(message_parts).strip(), parse_mode='MarkdownV2')
        elif fine[9]:
            media = InputMediaVideo(media=fine[9], caption='\n'.join(message_parts).strip(), parse_mode='MarkdownV2')
    else:
        message_parts.append(f"{title}\n")
        for idx, fine in enumerate(fines, 1):
            name = escape(f"{fine[1]} {fine[2]}" if fine[1] and fine[2] else "–ù–µ —É–∫–∞–∑–∞–Ω–æ")
            username = escape(f"@{fine[3]}" if fine[3] else "–Ω–µ—Ç username")
            reason = escape(fine[5])
            amount = escape(f"{fine[4]:.2f}")
            date = escape(datetime.strptime(fine[6], "%Y-%m-%d %H:%M:%S").strftime("%d.%m.%Y") if '-' in fine[6] else fine[6])

            # –†—É—á–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏ —Ç–æ–ª—å–∫–æ –≤ –Ω—É–º–µ—Ä–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞
            message_parts.extend([
                f"{escape(str(idx))}\\. *{name}* \\({username}\\)",  # –¢–æ—á–∫–∞ –ø–æ—Å–ª–µ –Ω–æ–º–µ—Ä–∞
                f"   –ü—Ä–∏—á–∏–Ω–∞: {reason}",
                f"   –°—É–º–º–∞: {amount}‚ÇΩ",
                f"   –î–∞—Ç–∞: {date}",
                f"   üÜî ID: `{fine[0]}`\n"
            ])
        message_parts.append(f"üìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page + 1}/{total_pages}")

    # –°–±–æ—Ä–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    final_message = '\n'.join([p for p in message_parts if p])

    # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ (–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    keyboard = []
    if status == 'disputed':
        keyboard.append([
            InlineKeyboardButton("‚úÖ –ü—Ä–∏–Ω—è—Ç—å", callback_data=f"accept_{fine[0]}"),
            InlineKeyboardButton("‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"reject_{fine[0]}")
        ])

    pagination = []
    if page > 0:
        pagination.append(InlineKeyboardButton("<", callback_data=f"page:{status}:{page-1}"))
    if page < total_pages - 1:
        pagination.append(InlineKeyboardButton(">", callback_data=f"page:{status}:{page+1}"))

    if pagination:
        keyboard.append(pagination)

    keyboard.append([InlineKeyboardButton("üîô –ó–∞–∫—Ä—ã—Ç—å", callback_data="close_pagination")])

    try:
        if update.callback_query:
            if status == 'disputed' and media:
                await update.callback_query.edit_message_media(
                    media=media,
                    reply_markup=InlineKeyboardMarkup(keyboard)
                )
            else:
                await update.callback_query.edit_message_text(
                    text=final_message,
                    parse_mode='MarkdownV2',
                    reply_markup=InlineKeyboardMarkup(keyboard)
                )
        else:
            if status == 'disputed' and media:
                await context.bot.send_photo(
                    chat_id=chat_id,
                    photo=media.media,
                    caption=media.caption,
                    parse_mode='MarkdownV2',
                    reply_markup=InlineKeyboardMarkup(keyboard)
                )
            else:
                await context.bot.send_message(
                    chat_id=chat_id,
                    text=final_message,
                    parse_mode='MarkdownV2',
                    reply_markup=InlineKeyboardMarkup(keyboard)
                )
    except BadRequest as e:
        print(f"–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}\n–°–æ–æ–±—â–µ–Ω–∏–µ: {final_message}")

async def shtrafpagi(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏"""
    query = update.callback_query
    await query.answer()

    if query.data.startswith("page:"):
        _, status, page = query.data.split(':')
        await show_fines_by_status(update, context, status, int(page))
    elif query.data == "close_pagination":
        await query.delete_message()
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–∏–Ω—è—Ç—å"
async def handle_accept(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()
    fine_id = int(query.data.split("_")[1])  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å

    # –£–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
    await query.edit_message_reply_markup(reply_markup=None)

    with sqlite3.connect(DB_FILE) as conn:
        cursor = conn.cursor()
        try:
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —à—Ç—Ä–∞—Ñ–µ –∏ username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            cursor.execute('''
                SELECT u.first_name, u.last_name, u.username, f.amount, f.reason, f.user_id
                FROM fines f
                JOIN users u ON f.user_id = u.id
                WHERE f.id = ?
            ''', (fine_id,))

            fine_data = cursor.fetchone()

            if fine_data:
                first_name, last_name, username, amount, reason, user_id = fine_data

                # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                name = f"{first_name} {last_name}" if first_name and last_name else "–ù–µ —É–∫–∞–∑–∞–Ω–æ"
                username = f"@{username}" if username else "–Ω–µ—Ç username"

                # –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ —Å –∏–º–µ–Ω–µ–º –∏ username –∏–∑ –ë–î
                log_details = (
                    f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {name} ({username})\n"
                    f"üí∞ –°—É–º–º–∞: {amount}‚ÇΩ\n"
                    f"üìù –ü—Ä–∏—á–∏–Ω–∞: {reason}"
                )

                # –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                log_bike_action(
                    user_id=user_id,
                    action="–ü—Ä–∏–Ω—è—Ç–∏–µ —à—Ç—Ä–∞—Ñ–∞",
                    details=f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª:\n{log_details}",
                    bike_id=None  # –î–æ–±–∞–≤—å—Ç–µ bike_id –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
                )

                # –£–¥–∞–ª—è–µ–º —à—Ç—Ä–∞—Ñ –∏–∑ –ë–î
                cursor.execute("DELETE FROM fines WHERE id = ?", (fine_id,))
                conn.commit()

                await context.bot.send_message(
                    chat_id=query.message.chat_id,
                    text=f"‚úÖ –®—Ç—Ä–∞—Ñ #{fine_id} –æ—Ç {name} ({username}) –ø—Ä–∏–Ω—è—Ç –∏ —É–¥–∞–ª—ë–Ω."
                )

        except sqlite3.Error as e:
            print(f"–û—à–∏–±–∫–∞ –ë–î: {e}")
            await context.bot.send_message(
                chat_id=query.message.chat_id,
                text="‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞."
            )

# –ù–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è —à—Ç—Ä–∞—Ñ–∞
async def start_reject(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()

    fine_id = int(query.data.split("_")[1])

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ context
    context.user_data['reject_fine_id'] = fine_id

    # –£–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    await query.edit_message_reply_markup(reply_markup=None)

    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–∏—á–∏–Ω—É
    await query.message.reply_text("üìù –í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è:")

    return REJECT_REASON

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –ø—Ä–∏—á–∏–Ω—ã –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
async def handle_reject_reason(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    reason = update.message.text
    fine_id = context.user_data.get('reject_fine_id')

    if not fine_id:
        await update.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞: —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞")
        return ConversationHandler.END

    try:
        with sqlite3.connect(DB_FILE) as conn:
            cursor = conn.cursor()

            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
            cursor.execute('''
                UPDATE fines
                SET status = 'unpaid', dispute_comment = ?
                WHERE id = ?
            ''', (reason, fine_id))

            # –ü–æ–ª—É—á–∞–µ–º user_id –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            cursor.execute("SELECT user_id FROM fines WHERE id = ?", (fine_id,))
            user_id = cursor.fetchone()[0]

            conn.commit()

        # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        await update.message.reply_text(f"‚ùå –®—Ç—Ä–∞—Ñ #{fine_id} –æ—Ç–∫–ª–æ–Ω–µ–Ω")

        # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try:
            await context.bot.send_message(
                chat_id=user_id,
                text=f"üö´ –í–∞—à —à—Ç—Ä–∞—Ñ #{fine_id} –æ—Ç–∫–ª–æ–Ω–µ–Ω. –ü—Ä–∏—á–∏–Ω–∞: {reason}"
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ —à—Ç—Ä–∞—Ñ–∞: {e}")
        await update.message.reply_text("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ")

    finally:
        # –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
        context.user_data.clear()

    return ConversationHandler.END

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await update.message.reply_text("‚ùå –û—Ç–º–µ–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è")
    context.user_data.clear()
    return ConversationHandler.END

async def assign_fine_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —à—Ç—Ä–∞—Ñ–∞"""
    if not is_admin(update.message.from_user.id):
        await update.message.reply_text("‚ùå –ù–µ—Ç –ø—Ä–∞–≤!")
        return ConversationHandler.END
    context.user_data.clear()
    context.user_data["admin_id"] = update.message.from_user.id
    context.user_data["page"] = 0  # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã

    with sqlite3.connect(DB_FILE) as conn:
        cursor = conn.cursor()
        cursor.execute("SELECT id, last_name, first_name FROM users")  # –ò—Å–ø–æ–ª—å–∑—É–µ–º last_name –∏ first_name
        users = cursor.fetchall()

    context.user_data["users"] = users  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
    return await display_users_page(update, context)

async def display_users_page(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ"""
    page_size = 5
    current_page = context.user_data.get("page", 0)
    users = context.user_data.get("users", [])
    start_index = current_page * page_size
    end_index = start_index + page_size
    paginated_users = users[start_index:end_index]

    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ (–∫–∞–∂–¥–∞—è –∫–Ω–æ–ø–∫–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –º–∞—Å—Å–∏–≤–µ)
    buttons = [
        [InlineKeyboardButton(
            f"{last_name or '‚Äî'} {first_name or '‚Äî'} (ID: {user_id})",
            callback_data=f"fine_user_{user_id}"
        )] for user_id, last_name, first_name in paginated_users
    ]

    # –ö–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    pagination_buttons = []
    if current_page > 0:
        pagination_buttons.append(
            InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="fine_pagination_prev")
        )
    if end_index < len(users):
        pagination_buttons.append(
            InlineKeyboardButton("‚û°Ô∏è –í–ø–µ—Ä–µ–¥", callback_data="fine_pagination_next")
        )

    # –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–æ–∫—É
    if pagination_buttons:
        buttons.append(pagination_buttons)

    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    reply_markup = InlineKeyboardMarkup(buttons)

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ
    if update.message:
        await update.message.reply_text(
            f"üîç –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —à—Ç—Ä–∞—Ñ–∞ (–°—Ç—Ä–∞–Ω–∏—Ü–∞ {current_page + 1}):",
            reply_markup=reply_markup
        )
    else:
        await update.callback_query.message.edit_text(
            f"üîç –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —à—Ç—Ä–∞—Ñ–∞ (–°—Ç—Ä–∞–Ω–∏—Ü–∞ {current_page + 1}):",
            reply_markup=reply_markup
        )

    return SELECT_USER

async def select_user_for_fine(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏"""
    query = update.callback_query
    await query.answer()
    data = query.data

    if data == "fine_pagination_prev":
        context.user_data["page"] -= 1
    elif data == "fine_pagination_next":
        context.user_data["page"] += 1
    else:
        user_id = int(data.split("_")[-1])
        context.user_data["fine_user_id"] = user_id
        await query.message.edit_text(f"‚û°Ô∏è –í—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ID: {user_id}")
        await query.message.reply_text("üí∏ –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —à—Ç—Ä–∞—Ñ–∞ –≤ —Ä—É–±–ª—è—Ö:")
        return ENTER_AMOUNT

    return await display_users_page(update, context)

async def process_fine_amount(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—É–º–º—ã —à—Ç—Ä–∞—Ñ–∞"""
    try:
        amount = float(update.message.text.replace(',', '.'))
        if amount <= 0:
            raise ValueError
        context.user_data['amount'] = amount
    except ValueError:
        await update.message.reply_text("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞! –í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ:")
        return ENTER_AMOUNT

    await update.message.reply_text("üìù –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —à—Ç—Ä–∞—Ñ–∞:")
    return ENTER_REASON

async def process_fine_reason(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏—á–∏–Ω—ã —à—Ç—Ä–∞—Ñ–∞"""
    reason = update.message.text.strip()
    if len(reason) < 5:
        await update.message.reply_text("‚ùå –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ! –ú–∏–Ω–∏–º—É–º 5 —Å–∏–º–≤–æ–ª–æ–≤:")
        return ENTER_REASON

    context.user_data['reason'] = reason
    await update.message.reply_text("üìÖ –í–≤–µ–¥–∏—Ç–µ —Å—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì:")
    return ENTER_DUE_DATE

async def process_due_date(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ä–æ–∫–∞ –æ–ø–ª–∞—Ç—ã"""
    try:
        # –ü–∞—Ä—Å–∏–º –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì
        due_date = datetime.strptime(update.message.text, "%d.%m.%y").date()
        if due_date < datetime.now().date():
            raise ValueError
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì
        context.user_data['due_date'] = due_date.strftime("%d.%m.%y")
    except ValueError:
        await update.message.reply_text("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞! –í–≤–µ–¥–∏—Ç–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì:")
        return ENTER_DUE_DATE

    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö (–æ—Å—Ç–∞–ª—å–Ω–æ–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    with sqlite3.connect(DB_FILE) as conn:
        cursor = conn.cursor()

        cursor.execute('''
            INSERT INTO fines (
                user_id,
                admin_id,
                amount,
                reason,
                due_date,
                status
            ) VALUES (?, ?, ?, ?, ?, ?)
        ''', (
            context.user_data['fine_user_id'],
            context.user_data['admin_id'],
            context.user_data['amount'],
            context.user_data['reason'],
            context.user_data['due_date'],  # —É–∂–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì
            'unpaid'
        ))

        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ª–æ–≥–∞
        cursor.execute(
            "SELECT first_name, last_name, username FROM users WHERE id = ?",
            (context.user_data['fine_user_id'],)
        )
        user_data = cursor.fetchone()
        user_name = f"{user_data[0]} {user_data[1]}" if user_data[1] else user_data[0]
        if user_data[2]:
            user_name += f" (@{user_data[2]})"
        conn.commit()

    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è (—Ñ–æ—Ä–º–∞—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)
    log_bike_action(
        user_id=context.user_data['fine_user_id'],
        action="–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —à—Ç—Ä–∞—Ñ–∞",
        details=(
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_name}\n"
            f"üí∞ –°—É–º–º–∞: {context.user_data['amount']}‚ÇΩ\n"
            f"üìù –ü—Ä–∏—á–∏–Ω–∞: {context.user_data['reason']}"
        ),
        bike_id=context.user_data.get('bike_id')
    )

    # –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (—Ñ–æ—Ä–º–∞—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)
    await update.message.reply_text(
        f"‚úÖ –®—Ç—Ä–∞—Ñ —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω!\n"
        f"‚ñ™Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_name}\n"
        f"‚ñ™Ô∏è –°—É–º–º–∞: {context.user_data['amount']}‚ÇΩ\n"
        f"‚ñ™Ô∏è –ü—Ä–∏—á–∏–Ω–∞: {context.user_data['reason']}\n"
        f"‚ñ™Ô∏è –°—Ä–æ–∫ –æ–ø–ª–∞—Ç—ã: {context.user_data['due_date']}"  # –î–î.–ú–ú.–ì–ì
    )

    context.user_data.clear()
    return ConversationHandler.END

async def cancel_fine(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û—Ç–º–µ–Ω–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —à—Ç—Ä–∞—Ñ–∞"""
    context.user_data.clear()
    await update.message.reply_text("üö´ –ü—Ä–æ—Ü–µ—Å—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —à—Ç—Ä–∞—Ñ–∞ –æ—Ç–º–µ–Ω–µ–Ω")
    return ConversationHandler.END


# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∏–∑ –º–µ–Ω—é üçΩÔ∏è
# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –∏–∑ –º–µ–Ω—é üçΩÔ∏è
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ menu_handler –ù–ê –≠–¢–£ –ë–ï–ó–û–ü–ê–°–ù–£–Æ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ menu_handler –ù–ê –≠–¢–£ –ü–û–õ–ù–£–Æ –ò –°–¢–ê–ë–ò–õ–¨–ù–£–Æ –í–ï–†–°–ò–Æ

async def menu_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∫–æ–º–∞–Ω–¥ –∏–∑ Reply-–º–µ–Ω—é.
    –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã, –∞ –∑–∞—Ç–µ–º - –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–∞—Ö.
    """
    user_id = update.message.from_user.id
    text = update.message.text.strip()
    is_user_admin = user_id in ADMIN_IDS

    # --- "–ë–ï–õ–´–ô –°–ü–ò–°–û–ö" –ì–õ–ê–í–ù–´–• –ö–û–ú–ê–ù–î –ú–ï–ù–Æ ---
    MAIN_REPLY_COMMANDS = {
        # –ê–¥–º–∏–Ω-–º–µ–Ω—é (–≤–µ—Ä—Ö–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å)
        "üìã –í–µ–ª–æ—Å–∏–ø–µ–¥—ã", "üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", "üî© –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç—è–º–∏",
        "üì© –í–æ–ø—Ä–æ—Å—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", "üì¢ –†–∞—Å—Å—ã–ª–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π", "üóìÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥–∞–º–∏",
        "üíº –†–∞–±–æ—Ç–∞", "üö¥‚Äç –°–¥–∞—Ç—å –≤ –∞—Ä–µ–Ω–¥—É –≤–µ–ª–æ—Å–∏–ø–µ–¥", "üë• –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—á–µ—Ä–µ–¥–∏",
        "üõ†Ô∏è –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—è–≤–æ–∫", "üîß –†–µ–º–æ–Ω—Ç", "üí∞ –ù–∞–∑–Ω–∞—á–∏—Ç—å —à—Ç—Ä–∞—Ñ",
        "üìã –°–ø–∏—Å–æ–∫ —à—Ç—Ä–∞—Ñ–æ–≤", "üéÅ –í—ã–¥–∞—Ç—å —Å–∫–∏–¥–∫—É", "üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
        "üìà –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏", "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", # <-- –ö–æ–º–∞–Ω–¥—ã —É–∂–µ –∑–¥–µ—Å—å

        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –º–µ–Ω—é
        "üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç", "üí∞–ê—Ä–µ–Ω–¥–∞/–í—ã–∫—É–ø", "üìã –¢–∞—Ä–∏—Ñ—ã", "üõ†Ô∏è –†–µ–º–æ–Ω—Ç",
        "üìú –ü—Ä–∞–≤–∏–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è", "üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã", "üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è", "üì© –ü–æ–¥–¥–µ—Ä–∂–∫–∞",

        # –í–ª–æ–∂–µ–Ω–Ω—ã–µ –∞–¥–º–∏–Ω—Å–∫–∏–µ –º–µ–Ω—é
        "‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥", "üõ†Ô∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã", "üìã –°–ø–∏—Å–æ–∫ –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤",
        "‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", "üë• –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
        "üìÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏",
        "‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—á–∞—Å—Ç—å", "üîß –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—á–∞—Å—Ç–∏", "üì© –°–ø–∏—Å–æ–∫ –∑–∞–ø—á–∞—Å—Ç–µ–π",
        "üìù –û—Ç–º–µ—Ç–∏—Ç—å—Å—è –Ω–∞ —Ä–∞–±–æ—Ç–µ", "üìú –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–º–µ—Ç–æ–∫", "üèÅ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å",
        "üîß –í–µ–ª–æ—Å–∏–ø–µ–¥—ã –≤ —Ä–µ–º–æ–Ω—Ç–µ", "üö≤ –†–∞–±–æ—á–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã", "‚ö†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º",
        "üìä –û—Ç—á–µ—Ç –∑–∞ —Å–µ–≥–æ–¥–Ω—è", "üìä –û—Ç—á–µ—Ç –∑–∞ –¥—Ä—É–≥—É—é –¥–∞—Ç—É",
        # –ö–æ–º–∞–Ω–¥—ã —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ —Å—á–µ—Ç—á–∏–∫–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –±—É–¥–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ
        "üÜï –ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏", "üõ†Ô∏è –í —Ä–∞–±–æ—Ç–µ", "üí≥ –û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã", "‚úÖ –û–ø–ª–∞—á–µ–Ω–Ω—ã–µ",
        "üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è", "üìä –û—Ç—á–µ—Ç—ã –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º", "üí∞ –†–∞—Å—Ö–æ–¥—ã"
    }

    # --- –ü–†–ò–û–†–ò–¢–ï–¢–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê –ö–û–ú–ê–ù–î –ò–ó –ú–ï–ù–Æ ---
    # –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê:
    is_main_command = (text in MAIN_REPLY_COMMANDS or
                       text.startswith("üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è") or
                       text.startswith("üÜï –ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏") or
                       text.startswith("üõ†Ô∏è –í —Ä–∞–±–æ—Ç–µ") or
                       text.startswith("üí≥ –û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã") or
                       text.startswith("‚úÖ –û–ø–ª–∞—á–µ–Ω–Ω—ã–µ"))

    if is_main_command:
        # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –æ—Ç —Å—Ç–∞—Ä—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤, —á—Ç–æ–±—ã "—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å" –±–æ—Ç–∞
        for key in list(context.user_data.keys()):
            if key.startswith('edit_') or key in ['choosing_user_to_edit', 'selecting_field', 'entering_value', 'after_edit', 'expecting_repair_status', 'search_mode', 'waiting_for_report_date']:
                context.user_data.pop(key, None)
        
        # --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–ù–û–ü–û–ö ---

        # –û–±—â–∏–µ/–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ
        if text == "üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è": await register(update, context)
        elif text == "üí∞–ê—Ä–µ–Ω–¥–∞/–í—ã–∫—É–ø": await list_bikes(update, context)
        elif text == "üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç": await show_profile(update, context)
        elif text == "üìã –¢–∞—Ä–∏—Ñ—ã": await show_tariffs(update, context)
        elif text == "üìú –ü—Ä–∞–≤–∏–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è": await show_rules(update, context)
        elif text == "üõ†Ô∏è –†–µ–º–æ–Ω—Ç": await request_repair(update, context)
        elif text == "üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã": await show_contacts(update, context)
        elif text == "üì© –ü–æ–¥–¥–µ—Ä–∂–∫–∞": await ask_support(update, context)
        elif text in ["üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"]: await start(update, context)
        
        # –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
        elif is_user_admin:
            if text == "üìã –í–µ–ª–æ—Å–∏–ø–µ–¥—ã":
                keyboard = [["‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥"], ["üõ†Ô∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã"], ["üìã –°–ø–∏—Å–æ–∫ –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤"], ["üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"]]
                await update.message.reply_text("üîç –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞–º–∏:", reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True))
            elif text == "‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥": await start_add_product(update, context)
            elif text == "üõ†Ô∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã": await edit_bikes(update, context)
            elif text == "üìã –°–ø–∏—Å–æ–∫ –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤": await list_bikes(update, context)
            
            elif text == "üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏":
                keyboard = [["‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"], ["üë• –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"],["üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"]]
                await update.message.reply_text("üîç –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏:", reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True))
            elif text == "‚úÖ –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π": await verify_user(update, context)
            elif text == "üë• –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏": await search_users(update, context)
            
            elif text == "üî© –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç—è–º–∏":
                keyboard = [["‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—á–∞—Å—Ç—å"], ["üîß –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—á–∞—Å—Ç–∏"], ["üì© –°–ø–∏—Å–æ–∫ –∑–∞–ø—á–∞—Å—Ç–µ–π"], ["üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"]]
                await update.message.reply_text("üîç –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å –∑–∞–ø—á–∞—Å—Ç—è–º–∏:", reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True))
            elif text == "‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—á–∞—Å—Ç—å": await add_part(update, context)
            elif text == "üîß –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—á–∞—Å—Ç–∏": await edit_parts(update, context)
            elif text == "üì© –°–ø–∏—Å–æ–∫ –∑–∞–ø—á–∞—Å—Ç–µ–π": await list_parts(update, context)
            
            elif text == "üîß –†–µ–º–æ–Ω—Ç": await repair_menu(update, context)
            elif text == "üîß –í–µ–ª–æ—Å–∏–ø–µ–¥—ã –≤ —Ä–µ–º–æ–Ω—Ç–µ": await show_bikes_by_status(update, context, 'in_repair')
            elif text == "üö≤ –†–∞–±–æ—á–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã": await show_bikes_by_status(update, context, 'working')
            elif text == "‚ö†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º": await show_bike_list(update, context)
            elif text == "üõ†Ô∏è –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—è–≤–æ–∫": await repair_dashboard_menu(update, context)
            elif text.startswith("üÜï –ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏"): await view_repair_requests_by_status(update, context, 'ozhidaet')
            elif text.startswith("üõ†Ô∏è –í —Ä–∞–±–æ—Ç–µ"): await view_repair_requests_by_status(update, context, 'accepted')
            elif text.startswith("üí≥ –û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã"): await view_repair_requests_by_status(update, context, 'completed')
            elif text.startswith("‚úÖ –û–ø–ª–∞—á–µ–Ω–Ω—ã–µ"): await view_repair_requests_by_status(update, context, 'oplacheno')
            elif text == "üí∞ –†–∞—Å—Ö–æ–¥—ã":
                await start_expense_logging(update, context)
                return # –í–æ–∑–≤—Ä–∞—â–∞–µ–º, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ ConversationHandler
            elif text == "üìä –û—Ç—á–µ—Ç—ã –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º":
                await start_report_generation(update, context)
                return # –ò —ç—Ç–æ —Ç–æ–∂–µ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
            elif text == "üíº –†–∞–±–æ—Ç–∞": await show_work_menu(update, context)
            elif text == "üìù –û—Ç–º–µ—Ç–∏—Ç—å—Å—è –Ω–∞ —Ä–∞–±–æ—Ç–µ": await mark_attendance(update, context)
            elif text == "üìú –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–º–µ—Ç–æ–∫": await view_attendance_history(update, context)
            elif text == "üèÅ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å": await finish_attendance(update, context)
            
            elif text == "üóìÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥–∞–º–∏": await manage_rentals(update, context)
            elif text == "üìÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏": await manage_bookings_panel(update, context)
            elif text == "üë• –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—á–µ—Ä–µ–¥–∏": await handle_admin_view_queue(update, context)
            elif text == "üö¥‚Äç –°–¥–∞—Ç—å –≤ –∞—Ä–µ–Ω–¥—É –≤–µ–ª–æ—Å–∏–ø–µ–¥": await electrobike_rent_start(update, context)

            elif text.startswith("üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"): await show_notifications(update, context)
            elif text == "üì© –í–æ–ø—Ä–æ—Å—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π": await view_questions(update, context)
            elif text == "üì¢ –†–∞—Å—Å—ã–ª–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π": await send_news(update, context)
            elif text == "üí∞ –ù–∞–∑–Ω–∞—á–∏—Ç—å —à—Ç—Ä–∞—Ñ": await assign_fine_start(update, context)
            elif text == "üìã –°–ø–∏—Å–æ–∫ —à—Ç—Ä–∞—Ñ–æ–≤": await view_fines_menu(update, context)
            elif text == "üéÅ –í—ã–¥–∞—Ç—å —Å–∫–∏–¥–∫—É": await start_discount_process(update, context)
            elif text == "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞": await statistics_menu(update, context)
            elif text == "üìà –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏": await investment_main_menu(update, context)
            
        return # –í–∞–∂–Ω–æ –≤—ã–π—Ç–∏ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã –º–µ–Ω—é

    # --- –û–ë–†–ê–ë–û–¢–ö–ê –í–í–û–î–ê –î–ê–ù–ù–´–• –í –ê–ö–¢–ò–í–ù–´–• –î–ò–ê–õ–û–ì–ê–• ---
    # –≠—Ç–æ—Ç –±–ª–æ–∫ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π –∏–∑ –º–µ–Ω—é.
    
    # –î–∏–∞–ª–æ–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ –Ω–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è)
    if is_user_admin and context.user_data.get('entering_value'):
        await handle_new_value_for_edit(update, context)
        return

    # –î–∏–∞–ª–æ–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Ä–µ–º–æ–Ω—Ç–∞ (—Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞)
    if is_user_admin and context.user_data.get('expecting_repair_status'):
        try:
            parts = text.split(maxsplit=2)
            bike_id = int(parts[0])
            status = parts[1]
            reason = parts[2] if len(parts) > 2 else None
            conn = sqlite3.connect(DB_FILE)
            cursor = conn.cursor()
            if status == 'in_repair':
                if not reason:
                    await update.message.reply_text("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —Ä–µ–º–æ–Ω—Ç–∞")
                    return
                cursor.execute('''UPDATE bikes SET repair_status = ?, repair_reason = ?, available = 0 WHERE id = ?''', (status, reason, bike_id))
            elif status == 'working':
                cursor.execute('''UPDATE bikes SET repair_status = ?, repair_reason = NULL, available = 1 WHERE id = ?''', (status, bike_id))
            conn.commit()
            conn.close()
            await update.message.reply_text(f"‚úÖ –°—Ç–∞—Ç—É—Å –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ {bike_id} –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ {status}")
            context.user_data.pop('expecting_repair_status', None)
        except (ValueError, IndexError):
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: <id> <—Å—Ç–∞—Ç—É—Å> <–ø—Ä–∏—á–∏–Ω–∞>")
        except sqlite3.Error as e:
            await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {str(e)}")
        return
        
    # --- –ï–°–õ–ò –ù–ò–ß–ï–ì–û –ù–ï –ü–û–î–û–®–õ–û ---
    await update.message.reply_text("‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π –≤–≤–æ–¥. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é. –î–ª—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –≤–≤–µ–¥–∏—Ç–µ /start")


# <<< –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê >>>

async def view_repair_requests_by_status(update: Update, context: ContextTypes.DEFAULT_TYPE, status: str):
    """
    –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ –Ω–∞ —Ä–µ–º–æ–Ω—Ç –ø–æ —Å—Ç–∞—Ç—É—Å—É.
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞–∂–¥—É—é –∑–∞—è–≤–∫—É –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏.
    –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω—ã –∏–∑ —Å—Ç—Ä–æ–∫–∏ –≤ —á–∏—Å–ª–æ –ø–µ—Ä–µ–¥ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º.
    """
    message = update.message or update.callback_query.message

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            cursor = await conn.execute("""
                SELECT rr.id, u.first_name, u.last_name, u.username, b.name as bike_name, rr.description, rr.estimated_price
                FROM repair_requests rr
                JOIN users u ON rr.user_id = u.id
                JOIN bikes b ON rr.bike_id = b.id
                WHERE rr.status = ?
                ORDER BY rr.created_at DESC
            """, (status,))
            requests = await cursor.fetchall()
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º '{status}': {e}", exc_info=True)
        await message.reply_text("üö´ –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")
        return

    status_titles = {
        'ozhidaet': 'üÜï –ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏',
        'accepted': 'üõ†Ô∏è –ó–∞—è–≤–∫–∏ –≤ —Ä–∞–±–æ—Ç–µ',
        'completed': 'üí≥ –ó–∞—è–≤–∫–∏, –æ–∂–∏–¥–∞—é—â–∏–µ –æ–ø–ª–∞—Ç—ã',
        'oplacheno': '‚úÖ –û–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏'
    }

    if not requests:
        await message.reply_text(f"‚úÖ –í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ '{status_titles.get(status)}' –ø—É—Å—Ç–æ.")
        return

    await message.reply_text(f"üëá {status_titles.get(status)} ({len(requests)} —à—Ç.):")

    for req in requests:
        info_parts = [
            f"üìå *ID –∑–∞—è–≤–∫–∏: {req['id']}*",
            f"üë§ *–ö–ª–∏–µ–Ω—Ç:* {req['first_name']} {req['last_name'] or ''} (@{req['username'] or 'N/A'})",
            f"üö≤ *–í–µ–ª–æ—Å–∏–ø–µ–¥:* {req['bike_name']}",
            f"üìù *–ü—Ä–æ–±–ª–µ–º–∞:* _{req['description']}_"
        ]

        keyboard = []

        # <<< –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>
        try:
            # –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å —Ü–µ–Ω—É –≤ —á–∏—Å–ª–æ.
            # –ï—Å–ª–∏ —Ü–µ–Ω–∞ None –∏–ª–∏ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞, —Å—á–∏—Ç–∞–µ–º –µ–µ —Ä–∞–≤–Ω–æ–π 0.
            price = float(req['estimated_price']) if req['estimated_price'] else 0.0
        except (ValueError, TypeError):
            # –ï—Å–ª–∏ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å, —Ç–∞–∫–∂–µ —Å—á–∏—Ç–∞–µ–º —Ü–µ–Ω—É —Ä–∞–≤–Ω–æ–π 0 –∏ –ª–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ.
            price = 0.0
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å —Ü–µ–Ω—É '{req['estimated_price']}' –≤ —á–∏—Å–ª–æ –¥–ª—è –∑–∞—è–≤–∫–∏ #{req['id']}")

        if price > 0:
            if status == 'completed':
                info_parts.append(f"üí∞ *–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ: {price:.2f} ‚ÇΩ*")
            elif status == 'oplacheno':
                info_parts.append(f"üí∞ *–û–ø–ª–∞—á–µ–Ω–æ: {price:.2f} ‚ÇΩ*")
        # <<< –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>

        # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
        if status == 'ozhidaet':
            keyboard.append([
                InlineKeyboardButton("‚úÖ –ü—Ä–∏–Ω—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É", callback_data=f"accept_repair_{req['id']}"),
                InlineKeyboardButton("üóëÔ∏è –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"otmena_repair_{req['id']}")
            ])
        elif status == 'accepted':
            keyboard.append([
                InlineKeyboardButton("‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–º–æ–Ω—Ç", callback_data=f"complete_repair_{req['id']}")
            ])
        elif status == 'completed':
            keyboard.append([
                InlineKeyboardButton("üí∞ –û—Ç–º–µ—Ç–∏—Ç—å –æ–ø–ª–∞—á–µ–Ω–Ω–æ–π", callback_data=f"paid_{req['id']}")
            ])

        final_message = "\n".join(info_parts)
        reply_markup = InlineKeyboardMarkup(keyboard) if keyboard else None

        await context.bot.send_message(
            chat_id=message.chat.id,
            text=final_message,
            parse_mode="Markdown",
            reply_markup=reply_markup
        )

# ==============================================================================
#           –ù–û–í–´–ô –ú–û–î–£–õ–¨ –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô –ü–û –ö–û–ú–ê–ù–î–ï /edit_user
# ==============================================================================
from typing import Tuple
import json
import aiosqlite
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardRemove
from telegram.ext import ContextTypes, ConversationHandler

# --- –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ ---
EDIT_SELECT_USER, EDIT_SELECT_FIELD, EDIT_AWAIT_VALUE, EDIT_CONFIRM_DELETE = range(710, 714)

# --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---

async def build_user_list_for_edit(context: ContextTypes.DEFAULT_TYPE) -> (str, InlineKeyboardMarkup):
    """–°—Ç—Ä–æ–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å–ø–∏—Å–∫–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∫–Ω–æ–ø–∫–∞–º–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏."""
    page = context.user_data.get('edit_page', 0)
    users_per_page = 5
    offset = page * users_per_page

    async with aiosqlite.connect(DB_FILE) as conn:
        cursor = await conn.execute("SELECT COUNT(*) FROM users")
        total_users = (await cursor.fetchone())[0]
        
        cursor = await conn.execute(
            "SELECT id, first_name, last_name, verified FROM users ORDER BY id LIMIT ? OFFSET ?",
            (users_per_page, offset)
        )
        users = await cursor.fetchall()

    if not users:
        return "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.", None

    keyboard = []
    for user_id, first_name, last_name, verified in users:
        status_emoji = "‚úÖ" if verified else "‚ùå"
        display_name = f"{first_name or ''} {last_name or ''}".strip() or f"User {user_id}"
        keyboard.append([InlineKeyboardButton(
            f"{status_emoji} | {display_name} (ID: {user_id})",
            callback_data=f"edit_select_user_{user_id}"
        )])

    nav_buttons = []
    if page > 0:
        nav_buttons.append(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="edit_page_prev"))
    total_pages = (total_users + users_per_page - 1) // users_per_page
    if page < total_pages - 1:
        nav_buttons.append(InlineKeyboardButton("–í–ø–µ—Ä–µ–¥ ‚û°Ô∏è", callback_data="edit_page_next"))

    if nav_buttons:
        keyboard.append(nav_buttons)
    keyboard.append([InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="edit_cancel")])
    
    text = f"üìã –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ {page + 1} –∏–∑ {total_pages}):\n–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"
    return text, InlineKeyboardMarkup(keyboard)

async def build_profile_for_edit(context: ContextTypes.DEFAULT_TYPE) -> (str, InlineKeyboardMarkup):
    """–°—Ç—Ä–æ–∏—Ç –∫—Ä–∞—Å–∏–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–æ—Ñ–∏–ª–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∫–Ω–æ–ø–∫–∞–º–∏ –ø–æ–ª–µ–π."""
    user_id = context.user_data.get('edit_user_id')
    async with aiosqlite.connect(DB_FILE) as conn:
        conn.row_factory = aiosqlite.Row
        cursor = await conn.execute("SELECT * FROM users WHERE id = ?", (user_id,))
        user = await cursor.fetchone()

    if not user:
        return "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.", None

    passport_data = json.loads(user['passport_data']) if user['passport_data'] else {}
    
    profile_text = (
        f"üë§ *–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è*\n\n"
        f"‚ñ™Ô∏è *–ò–º—è:* `{user['first_name'] or '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}`\n"
        f"‚ñ™Ô∏è *–§–∞–º–∏–ª–∏—è:* `{user['last_name'] or '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}`\n"
        f"‚ñ™Ô∏è *–¢–µ–ª–µ—Ñ–æ–Ω:* `{user['phone_number'] or '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}`\n\n"
        f"üìÑ *–ü–∞—Å–ø–æ—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:*\n"
        f"   - *–°–µ—Ä–∏—è –∏ –Ω–æ–º–µ—Ä:* `{passport_data.get('–°–µ—Ä–∏—è –∏ –Ω–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}`\n"
        f"   - *–ö–µ–º –≤—ã–¥–∞–Ω:* `{passport_data.get('–ö–µ–º –≤—ã–¥–∞–Ω', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}`\n"
        f"   - *–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏:* `{passport_data.get('–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}`\n"
        f"   - *–ê–¥—Ä–µ—Å:* `{passport_data.get('–ê–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', '–Ω–µ —É–∫–∞–∑–∞–Ω–æ')}`\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:"
    )

    # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" >>>
    keyboard = [
        [
            InlineKeyboardButton("–ò–º—è", callback_data="edit_field_first_name"),
            InlineKeyboardButton("–§–∞–º–∏–ª–∏—è", callback_data="edit_field_last_name"),
            InlineKeyboardButton("–¢–µ–ª–µ—Ñ–æ–Ω", callback_data="edit_field_phone_number"),
        ],
        [InlineKeyboardButton("–ü–∞—Å–ø–æ—Ä—Ç: –°–µ—Ä–∏—è/–ù–æ–º–µ—Ä", callback_data="edit_field_passport_series_number")],
        [InlineKeyboardButton("–ü–∞—Å–ø–æ—Ä—Ç: –ö–µ–º –≤—ã–¥–∞–Ω", callback_data="edit_field_passport_issued_by")],
        [InlineKeyboardButton("–ü–∞—Å–ø–æ—Ä—Ç: –î–∞—Ç–∞ –≤—ã–¥–∞—á–∏", callback_data="edit_field_passport_issue_date")],
        [InlineKeyboardButton("–ü–∞—Å–ø–æ—Ä—Ç: –ê–¥—Ä–µ—Å", callback_data="edit_field_passport_address")],
        # –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
        [InlineKeyboardButton("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", callback_data="edit_action_delete")],
        [
            InlineKeyboardButton("‚¨ÖÔ∏è –ö —Å–ø–∏—Å–∫—É", callback_data="edit_back_to_list"),
            InlineKeyboardButton("‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å", callback_data="edit_cancel"),
        ]
    ]
    return profile_text, InlineKeyboardMarkup(keyboard)

# --- –§—É–Ω–∫—Ü–∏–∏-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π ---

async def edit_user(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –¥–∏–∞–ª–æ–≥ –ø–æ –∫–æ–º–∞–Ω–¥–µ /edit_user. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π."""
    if not is_admin(update.message.from_user.id):
        await update.message.reply_text("üö´ –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
        return ConversationHandler.END

    context.user_data.clear()
    context.user_data['edit_page'] = 0
    await update.message.reply_text("–ó–∞–≥—Ä—É–∂–∞—é —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...", reply_markup=ReplyKeyboardRemove())
    text, reply_markup = await build_user_list_for_edit(context)
    await update.message.reply_text(text, reply_markup=reply_markup)
    return EDIT_SELECT_USER

async def edit_user_handle_user_selection(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏—é."""
    query = update.callback_query
    await query.answer()
    
    if query.data == "edit_page_prev":
        context.user_data['edit_page'] = max(0, context.user_data.get('edit_page', 0) - 1)
        text, markup = await build_user_list_for_edit(context)
        await query.edit_message_text(text, reply_markup=markup)
        return EDIT_SELECT_USER
        
    elif query.data == "edit_page_next":
        context.user_data['edit_page'] += 1
        text, markup = await build_user_list_for_edit(context)
        await query.edit_message_text(text, reply_markup=markup)
        return EDIT_SELECT_USER
        
    elif query.data.startswith("edit_select_user_"):
        user_id = int(query.data.split('_')[-1])
        context.user_data['edit_user_id'] = user_id
        text, markup = await build_profile_for_edit(context)
        await query.edit_message_text(text, reply_markup=markup, parse_mode='Markdown')
        return EDIT_SELECT_FIELD

    return EDIT_SELECT_USER

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ edit_user_handle_field_selection –ù–ê –≠–¢–£

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ edit_user_handle_field_selection –ù–ê –≠–¢–£

async def edit_user_handle_field_selection(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä –ø–æ–ª—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ò–õ–ò –¥–µ–π—Å—Ç–≤–∏—è (—É–¥–∞–ª–µ–Ω–∏–µ)."""
    query = update.callback_query
    await query.answer()

    # --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ ---
    if query.data == "edit_back_to_list":
        context.user_data.pop('edit_user_id', None)
        text, markup = await build_user_list_for_edit(context)
        await query.edit_message_text(text, reply_markup=markup)
        return EDIT_SELECT_USER

    if query.data == "edit_cancel":
        return await edit_user_cancel(update, context)

    # <<< –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ë–õ–û–ö–ê: –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è >>>
    if query.data == "edit_action_delete":
        user_id = context.user_data.get('edit_user_id')
        
        async with aiosqlite.connect(DB_FILE) as conn:
            cursor = await conn.execute("SELECT first_name, last_name FROM users WHERE id = ?", (user_id,))
            user = await cursor.fetchone()
        user_name = f"{user[0] or ''} {user[1] or ''}".strip() or f"ID {user_id}"

        text = (
            f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è *{user_name}* (ID: `{user_id}`)?"
            f"\n\n**–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!**"
        )
        keyboard = [
            [InlineKeyboardButton("‚ùå –î–ê, –£–î–ê–õ–ò–¢–¨", callback_data="edit_confirm_delete_yes")],
            # –ò–°–ü–û–õ–¨–ó–£–ï–ú –ù–û–í–´–ô, –£–ù–ò–ö–ê–õ–¨–ù–´–ô callback_data
            [InlineKeyboardButton("‚úÖ –ù–µ—Ç, –≤–µ—Ä–Ω—É—Ç—å—Å—è", callback_data="edit_back_to_profile")]
        ]
        await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode="Markdown")
        return EDIT_CONFIRM_DELETE
    # <<< –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê >>>

    # --- –°—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª–µ–π ---
    field_key = query.data.split('edit_field_')[-1]
    context.user_data['edit_field_key'] = field_key
    field_map = {
        "first_name": "–ò–º—è", "last_name": "–§–∞–º–∏–ª–∏—è", "phone_number": "–¢–µ–ª–µ—Ñ–æ–Ω",
        "passport_series_number": "–ü–∞—Å–ø–æ—Ä—Ç: –°–µ—Ä–∏—è/–ù–æ–º–µ—Ä", "passport_issued_by": "–ü–∞—Å–ø–æ—Ä—Ç: –ö–µ–º –≤—ã–¥–∞–Ω",
        "passport_issue_date": "–ü–∞—Å–ø–æ—Ä—Ç: –î–∞—Ç–∞ –≤—ã–¥–∞—á–∏", "passport_address": "–ü–∞—Å–ø–æ—Ä—Ç: –ê–¥—Ä–µ—Å"
    }
    await query.edit_message_text(f"‚úçÔ∏è –í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—è *'{field_map.get(field_key)}'*:", parse_mode='Markdown')
    return EDIT_AWAIT_VALUE

# <<< –ù–ê–ß–ê–õ–û –ù–û–í–û–ô –§–£–ù–ö–¶–ò–ò >>>
async def edit_user_delete_confirmed(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—Ä–µ–Ω–¥ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º.
    """
    query = update.callback_query
    await query.answer()
    
    user_id = context.user_data.get('edit_user_id')

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–∫—Ç–∏–≤–Ω–∞—è –∞—Ä–µ–Ω–¥–∞?
            cursor = await conn.execute(
                "SELECT COUNT(*) FROM bookings WHERE user_id = ? AND status = 'rented'",
                (user_id,)
            )
            active_rentals = (await cursor.fetchone())[0]

            if active_rentals > 0:
                await query.edit_message_text(
                    f"üö´ **–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å!**\n–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å {active_rentals} –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—Ä–µ–Ω–¥/—Ä–∞—Å—Å—Ä–æ—á–µ–∫. "
                    "–°–Ω–∞—á–∞–ª–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å –≤—Å–µ —Å–¥–µ–ª–∫–∏.",
                    parse_mode="Markdown"
                )
                # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —á—Ç–æ–±—ã –∞–¥–º–∏–Ω –º–æ–≥ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–≥–æ
                text, markup = await build_user_list_for_edit(context)
                await context.bot.send_message(query.message.chat.id, text, reply_markup=markup)
                return EDIT_SELECT_USER

            # 2. –ü–æ–ª—É—á–∞–µ–º –∏–º—è –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ü–ï–†–ï–î —É–¥–∞–ª–µ–Ω–∏–µ–º
            cursor = await conn.execute("SELECT first_name, last_name FROM users WHERE id = ?", (user_id,))
            user = await cursor.fetchone()
            user_name = f"{user[0] or ''} {user[1] or ''}".strip() or f"ID {user_id}"

            # 3. –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await conn.execute("DELETE FROM users WHERE id = ?", (user_id,))
            await conn.commit()
            
            await query.edit_message_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å *{user_name}* —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω.", parse_mode="Markdown")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}", exc_info=True)
        await query.edit_message_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: {e}")

    # –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–º—É —Å–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    context.user_data.pop('edit_user_id', None)
    text, markup = await build_user_list_for_edit(context)
    await context.bot.send_message(query.message.chat.id, text, reply_markup=markup)
    return EDIT_SELECT_USER
# <<< –ö–û–ù–ï–¶ –ù–û–í–û–ô –§–£–ù–ö–¶–ò–ò >>>

async def edit_user_handle_new_value(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ü—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –æ–±–Ω–æ–≤–ª—è–µ—Ç –ë–î –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫ –ø—Ä–æ—Ñ–∏–ª—é."""
    new_value = update.message.text
    field_key = context.user_data.get('edit_field_key')
    user_id = context.user_data.get('edit_user_id')

    async with aiosqlite.connect(DB_FILE) as conn:
        if not field_key.startswith('passport_'):
            await conn.execute(f"UPDATE users SET {field_key} = ? WHERE id = ?", (new_value, user_id))
        else:
            cursor = await conn.execute("SELECT passport_data FROM users WHERE id = ?", (user_id,))
            result = await cursor.fetchone()
            passport_data = json.loads(result[0]) if result and result[0] else {}
            
            passport_field_map = {
                "passport_series_number": "–°–µ—Ä–∏—è –∏ –Ω–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞", "passport_issued_by": "–ö–µ–º –≤—ã–¥–∞–Ω",
                "passport_issue_date": "–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏", "passport_address": "–ê–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"
            }
            passport_key = passport_field_map.get(field_key)
            if passport_key:
                passport_data[passport_key] = new_value
                await conn.execute("UPDATE users SET passport_data = ? WHERE id = ?", (json.dumps(passport_data, ensure_ascii=False), user_id))
        
        await conn.commit()
    
    await update.message.reply_text("‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!")

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é –ø—Ä–æ—Ñ–∏–ª—è
    text, markup = await build_profile_for_edit(context)
    await update.message.reply_text(text, reply_markup=markup, parse_mode='Markdown')
    return EDIT_SELECT_FIELD

async def edit_user_cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ó–∞–≤–µ—Ä—à–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é."""
    context.user_data.clear()
    if update.callback_query:
        await update.callback_query.answer()
        await update.callback_query.edit_message_text("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    else:
        await update.message.reply_text("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
        
    await context.bot.send_message(
        chat_id=update.effective_chat.id,
        text="–í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.",
        reply_markup=get_main_menu(update.effective_user.id)
    )
    return ConversationHandler.END

# ==============================================================================
#           –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ú–û–î–£–õ–Ø
# ==============================================================================

ELECTROBIKE_SELECT_USER, ELECTROBIKE_SELECT_BIKE, ELECTROBIKE_SELECT_DAYS, ELECTROBIKE_YANDEX_PRO = range(4)

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –¶–µ–Ω—ã –∑–∞ –∞—Ä–µ–Ω–¥—É
PRICE_FOR_PERIOD = {
    7: 3750,
    8: 3750,
    14: 7500,
    28: 14000,
    30: 15000
}
ELECTROBIKE_SELECT_USER, ELECTROBIKE_SELECT_BIKE, ELECTROBIKE_SELECT_DAYS, ELECTROBIKE_YANDEX_PRO = range(4)

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –¶–µ–Ω—ã –∑–∞ –∞—Ä–µ–Ω–¥—É
PRICE_FOR_PERIOD = {
    7: 3750,
    8: 3750,
    14: 7500,
    28: 14000,
    30: 15000
}
BASE_PRICE_PER_DAY = 500  # –ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –∑–∞ –¥–µ–Ω—å

# ---------- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /rent_bike ----------
async def electrobike_rent_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞—Ä–µ–Ω–¥—ã.
    """
    try:
        context.user_data.clear()
        # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨ ---
        # –î–æ–±–∞–≤–ª—è–µ–º —ç–º–æ–¥–∑–∏ –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –≥–ª–∞–≤–Ω–æ–º—É –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É –º–µ–Ω—é
        return_keyboard = ReplyKeyboardMarkup([["üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"]], resize_keyboard=True)
        # --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---

        if update.message:
            await update.message.reply_text(
                "üö¥ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞—Ä–µ–Ω–¥—ã...",
                reply_markup=return_keyboard
            )
            await electrobike_show_users_page(update, context, page=1)
        elif update.callback_query:
            await context.bot.send_message(
                chat_id=update.effective_chat.id,
                text="üö¥ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞—Ä–µ–Ω–¥—ã...",
                reply_markup=return_keyboard
            )
            await electrobike_show_users_page(update, context, page=1)
        else:
            logger.error("–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è –¥–ª—è –Ω–∞—á–∞–ª–∞ –∞—Ä–µ–Ω–¥—ã")
            return ConversationHandler.END

        logger.info(f"–ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞—Ä–µ–Ω–¥—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {update.effective_user.id}")
        return ELECTROBIKE_SELECT_USER

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∞—Ä–µ–Ω–¥—ã: {str(e)}")
        error_message = "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∞—Ä–µ–Ω–¥—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        if update.message:
            await update.message.reply_text(error_message)
        elif update.callback_query:
            await update.callback_query.edit_message_text(error_message)
        return ConversationHandler.END

# ---------- –û—Ç–º–µ–Ω–∞ –∞—Ä–µ–Ω–¥—ã ----------
async def electrobike_cancel_rental(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –û—Ç–º–µ–Ω–∞ –∞—Ä–µ–Ω–¥—ã –∏ –≤–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.
    """
    await update.message.reply_text(
        "–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.",
        reply_markup=get_main_menu(update.effective_user.id)
    )
    context.user_data.clear()
    return ConversationHandler.END


async def show_users_page(update: Update, context: CallbackContext, page: int = 0):
    """
    –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –∫–Ω–æ–ø–∫–∞–º–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≤ context.user_data['all_users'].
    """
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    all_users = context.user_data.get('all_users', [])
    if not all_users:
        await update.message.reply_text("üö´ –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—É—Å—Ç –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    PAGE_SIZE = 5
    total_items = len(all_users)
    total_pages = (total_items + PAGE_SIZE - 1) // PAGE_SIZE

    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–∑ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    offset = page * PAGE_SIZE
    paginated_users = all_users[offset : offset + PAGE_SIZE]

    keyboard = []
    for user_id, first_name, last_name, username in paginated_users:
        button_text = f"{first_name} {last_name or ''} (@{username or 'N/A'})"
        # –≠—Ç–∞ callback_data –¥–æ–ª–∂–Ω–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –≤–∞—à–∏–º —Ö–µ–Ω–¥–ª–µ—Ä–æ–º view_user_rentals
        keyboard.append([InlineKeyboardButton(button_text, callback_data=f"view_rentals_{user_id}")])

    # –ö–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    pagination_row = []
    if page > 0:
        # –í–∞–∂–Ω–æ: callback_data –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –ø–æ–∏—Å–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ–π
        pagination_row.append(InlineKeyboardButton("‚¨ÖÔ∏è", callback_data=f"search_page_{page - 1}"))
    if page < total_pages - 1:
        pagination_row.append(InlineKeyboardButton("‚û°Ô∏è", callback_data=f"search_page_{page + 1}"))

    if pagination_row:
        keyboard.append(pagination_row)
        
    # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ –Ω–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞
    keyboard.append([InlineKeyboardButton("üîç –ù–æ–≤—ã–π –ø–æ–∏—Å–∫", callback_data="poisk_start")])

    message_text = f"üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ (–°—Ç—Ä. {page + 1}/{total_pages}):"
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–æ–≤–æ–µ
    if update.callback_query:
        await update.callback_query.edit_message_text(message_text, reply_markup=InlineKeyboardMarkup(keyboard))
    else:
        await update.message.reply_text(message_text, reply_markup=InlineKeyboardMarkup(keyboard))

async def handle_search_pagination(update: Update, context: CallbackContext) -> int:
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–æ–∫ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞."""
    query = update.callback_query
    await query.answer()

    page = int(query.data.split('_')[-1])
    # –ü—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –Ω–æ–≤—ã–º –Ω–æ–º–µ—Ä–æ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    await show_users_page(update, context, page=page)

    # –û—Å—Ç–∞–µ–º—Å—è –≤ —Ç–æ–º –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–∏, —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å
    return MANAGE_RENTALS_MENU
# ---------- –ü–æ–∫–∞–∑ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ----------
async def electrobike_show_users_page(update: Update, context: ContextTypes.DEFAULT_TYPE, page: int):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏.
    """
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT id, first_name, last_name FROM users LIMIT 5 OFFSET ?", ((page - 1) * 5,))
    users = cursor.fetchall()
    cursor.execute("SELECT COUNT(*) FROM users")
    total_users = cursor.fetchone()[0]
    conn.close()

    keyboard = [
        [InlineKeyboardButton(f"{user[1]} {user[2]}", callback_data=f"electrobike_select_user_{user[0]}")]
        for user in users
    ]

    pagination = []
    if page > 1:
        pagination.append(InlineKeyboardButton("‚¨ÖÔ∏è", callback_data=f"electrobike_user_page_prev_{page}"))
    pagination.append(InlineKeyboardButton("üîç –ü–æ–∏—Å–∫", callback_data="electrobike_search_user"))
    if total_users > page * 5:
        pagination.append(InlineKeyboardButton("‚û°Ô∏è", callback_data=f"electrobike_user_page_next_{page}"))
    if pagination:
        keyboard.append(pagination)

    if update.callback_query:
        await update.callback_query.edit_message_text(
            "üìã –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
    else:
        await update.message.reply_text(
            "üìã –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )

# ---------- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è SELECT_USER ----------
async def electrobike_user_state_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    """
    if update.callback_query:
        query = update.callback_query
        await query.answer()
        data = query.data

        if data.startswith("electrobike_user_page_"):
            action, current_page = data.split("_")[3:]
            new_page = int(current_page) + 1 if action == "next" else int(current_page) - 1
            new_page = max(1, new_page)
            await electrobike_show_users_page(update, context, new_page)
            return ELECTROBIKE_SELECT_USER

        elif data.startswith("electrobike_select_user_"):
            user_id = int(data.split("_")[3])
            context.user_data['selected_user_id'] = user_id
            await electrobike_show_bikes_page(update, context, page=1)
            return ELECTROBIKE_SELECT_BIKE

        elif data == "electrobike_search_user":
            await query.edit_message_text("üîç –í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–ª–∏ —Ñ–∞–º–∏–ª–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:")
            context.user_data['search_mode'] = 'user'
            return ELECTROBIKE_SELECT_USER

    elif update.message and context.user_data.get('search_mode') == 'user':
        search_term = update.message.text.strip()
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        cursor.execute(
            "SELECT id, first_name, last_name FROM users WHERE first_name LIKE ? OR last_name LIKE ? LIMIT 10",
            (f'%{search_term}%', f'%{search_term}%')
        )
        users = cursor.fetchall()
        conn.close()

        if not users:
            await update.message.reply_text("‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
            return ELECTROBIKE_SELECT_USER

        keyboard = [
            [InlineKeyboardButton(f"{user[1]} {user[2]}", callback_data=f"electrobike_select_user_{user[0]}")]
            for user in users
        ]
        await update.message.reply_text(
            "üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        del context.user_data['search_mode']
        return ELECTROBIKE_SELECT_USER

    return ELECTROBIKE_SELECT_USER

# ---------- –ü–æ–∫–∞–∑ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ ----------
async def electrobike_show_bikes_page(update: Update, context: ContextTypes.DEFAULT_TYPE, page: int):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞–º–∏:
    - –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å confirmed –±—Ä–æ–Ω—å, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–µ–ª–æ—Å–∏–ø–µ–¥.
    - –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è rented –∞—Ä–µ–Ω–¥–∞, –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–µ–∫—É—â–µ–π –∞—Ä–µ–Ω–¥–µ.
    - –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –±—Ä–æ–Ω–∏ –Ω–µ—Ç, –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π.
    """
    try:
        user_id = context.user_data['selected_user_id']
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()

        # –õ–æ–≥–∏—Ä—É–µ–º –æ–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–∞–∑—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        cursor.execute("SELECT COUNT(*) FROM bikes WHERE available = 1")
        available_bikes_count = cursor.fetchone()[0]
        logger.info(f"–í—Å–µ–≥–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ —Å available=1: {available_bikes_count}")

        cursor.execute("SELECT COUNT(*) FROM bookings WHERE status IN ('confirmed', 'rented')")
        active_bookings_count = cursor.fetchone()[0]
        logger.info(f"–ê–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π/–∞—Ä–µ–Ω–¥: {active_bookings_count}")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏ –∏–ª–∏ –∞—Ä–µ–Ω–¥—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        cursor.execute("""
            SELECT bike_id, status
            FROM bookings
            WHERE user_id = ?
            AND status IN ('confirmed', 'rented')
        """, (user_id,))
        active_booking = cursor.fetchone()

        if active_booking:
            bike_id, status = active_booking

            if status == 'rented':
                # –°–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–µ–∫—É—â–µ–π –∞—Ä–µ–Ω–¥–µ
                cursor.execute("SELECT id, name FROM bikes WHERE id = ?", (bike_id,))
                bike = cursor.fetchone()
                message_text = (
                    f"üö≤ –£ –≤–∞—Å —É–∂–µ –∞—Ä–µ–Ω–¥–æ–≤–∞–Ω –≤–µ–ª–æ—Å–∏–ø–µ–¥:\n\n"
                    f"ID: {bike[0]}\n"
                    f"–ú–æ–¥–µ–ª—å: {bike[1]}\n"
                    f"–î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ä–æ–∫–∞ –∞—Ä–µ–Ω–¥—ã –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
                )
                keyboard = [[InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å", callback_data="refresh_status")]]
                conn.close()

                if update.callback_query:
                    await update.callback_query.edit_message_text(
                        message_text, reply_markup=InlineKeyboardMarkup(keyboard)
                    )
                else:
                    await update.message.reply_text(
                        message_text, reply_markup=InlineKeyboardMarkup(keyboard)
                    )
                return

            elif status == 'confirmed':
                # –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–µ–ª–æ—Å–∏–ø–µ–¥
                cursor.execute("SELECT id, name FROM bikes WHERE id = ?", (bike_id,))
                bike = cursor.fetchone()
                message_text = (
                    f"üö≤ –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–∞—è –±—Ä–æ–Ω—å:\n\n"
                    f"ID: {bike[0]}\n"
                    f"–ú–æ–¥–µ–ª—å: {bike[1]}"
                )
                keyboard = [[
                    InlineKeyboardButton(
                        "üìÖ –í—ã–±—Ä–∞—Ç—å —Å—Ä–æ–∫ –∞—Ä–µ–Ω–¥—ã",
                        callback_data=f"electrobike_select_bike_{bike_id}"
                    )
                ]]
                conn.close()

                if update.callback_query:
                    await update.callback_query.edit_message_text(
                        message_text, reply_markup=InlineKeyboardMarkup(keyboard)
                    )
                else:
                    await update.message.reply_text(
                        message_text, reply_markup=InlineKeyboardMarkup(keyboard)
                    )
                return

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã
        cursor.execute("""
            SELECT id, name
            FROM bikes
            WHERE available = 1
            AND id NOT IN (
                SELECT bike_id
                FROM bookings
                WHERE status IN ('confirmed', 'rented')
                AND bike_id IS NOT NULL
            )
            LIMIT 5 OFFSET ?
        """, ((page - 1) * 5,))
        bikes = cursor.fetchall()
        logger.info(f"–ù–∞–π–¥–µ–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ {page}: {len(bikes)}")

        cursor.execute("""
            SELECT COUNT(*)
            FROM bikes
            WHERE available = 1
            AND id NOT IN (
                SELECT bike_id
                FROM bookings
                WHERE status IN ('confirmed', 'rented')
                AND bike_id IS NOT NULL
            )
        """)
        total_bikes = cursor.fetchone()[0]
        logger.info(f"–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤: {total_bikes}")

        conn.close()

        if not bikes:
            message_text = "‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ –¥–ª—è –∞—Ä–µ–Ω–¥—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É."
            keyboard = []
        else:
            message_text = "üö¥‚Äç‚ôÇÔ∏è –î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã:\n\n" + "\n".join(
                [f"{bike[1]} (ID: {bike[0]})" for bike in bikes]
            )
            keyboard = [
                [InlineKeyboardButton(bike[1], callback_data=f"electrobike_select_bike_{bike[0]}")]
                for bike in bikes
            ]

            # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
            pagination = []
            pagination.append(InlineKeyboardButton("üîç –ü–æ–∏—Å–∫", callback_data="electrobike_search_bike"))
            if page > 1:
                pagination.append(InlineKeyboardButton("<", callback_data=f"electrobike_bike_page_prev_{page}"))
            if total_bikes > page * 5:
                pagination.append(InlineKeyboardButton(">", callback_data=f"electrobike_bike_page_next_{page}"))
            if pagination:
                keyboard.append(pagination)

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        if update.callback_query:
            await update.callback_query.edit_message_text(
                message_text, reply_markup=InlineKeyboardMarkup(keyboard)
            )
        else:
            await update.message.reply_text(
                message_text, reply_markup=InlineKeyboardMarkup(keyboard)
            )

    except sqlite3.Error as db_error:
        logger.error(f"–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {str(db_error)}")
        await update.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞: {str(e)}")
        await update.message.reply_text("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

# ---------- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Å—Ç–æ—è–Ω–∏—è SELECT_BIKE ----------
async def electrobike_bike_state_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –≤—ã–±–æ—Ä–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞.
    """
    if update.callback_query:
        query = update.callback_query
        await query.answer()
        data = query.data

        if data.startswith("electrobike_bike_page_"):
            action, current_page = data.split("_")[3:]
            new_page = int(current_page) + 1 if action == "next" else int(current_page) - 1
            new_page = max(1, new_page)
            await electrobike_show_bikes_page(update, context, new_page)
            return ELECTROBIKE_SELECT_BIKE

        elif data.startswith("electrobike_select_bike_"):
            bike_id = int(data.split("_")[3])
            context.user_data['selected_bike_id'] = bike_id
            await query.edit_message_text(
                "üìÖ –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ –∞—Ä–µ–Ω–¥—ã:",
                reply_markup=electrobike_create_rental_days_keyboard()
            )
            return ELECTROBIKE_SELECT_DAYS

        elif data == "electrobike_search_bike":
            await query.edit_message_text("üîç –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞:")
            context.user_data['search_mode'] = 'bike'
            return ELECTROBIKE_SELECT_BIKE

    elif update.message and context.user_data.get('search_mode') == 'bike':
        search_term = update.message.text.strip()
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        cursor.execute(
            "SELECT id, name FROM bikes WHERE name LIKE ? AND available=1 LIMIT 10",
            (f'%{search_term}%',)
        )
        bikes = cursor.fetchall()
        conn.close()

        if not bikes:
            await update.message.reply_text("‚ùå –í–µ–ª–æ—Å–∏–ø–µ–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
            return ELECTROBIKE_SELECT_BIKE

        keyboard = [
            [InlineKeyboardButton(bike[1], callback_data=f"electrobike_select_bike_{bike[0]}")]
            for bike in bikes
        ]
        await update.message.reply_text(
            "üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞:",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        del context.user_data['search_mode']
        return ELECTROBIKE_SELECT_BIKE

    return ELECTROBIKE_SELECT_BIKE

# ---------- –°–æ–∑–¥–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ä–æ–∫–∞ –∞—Ä–µ–Ω–¥—ã ----------
def electrobike_create_rental_days_keyboard():
    """
    –°–æ–∑–¥–∞–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ä–æ–∫–∞ –∞—Ä–µ–Ω–¥—ã.
    """
    keyboard = []
    row = []
    for i in range(1, 32):
        row.append(InlineKeyboardButton(str(i), callback_data=f"electrobike_rental_days_{i}"))
        if i % 5 == 0:
            keyboard.append(row)
            row = []
    if row:
        keyboard.append(row)
    return InlineKeyboardMarkup(keyboard)

# ---------- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Å—Ä–æ–∫–∞ –∞—Ä–µ–Ω–¥—ã ----------
async def electrobike_select_rental_days(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —Å—Ä–æ–∫–∞ –∞—Ä–µ–Ω–¥—ã –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∫—É—Ä—å–µ—Ä–∞ –Ø–Ω–¥–µ–∫—Å –ü—Ä–æ.
    """
    query = update.callback_query
    await query.answer()

    rental_days = int(query.data.split("_")[3])
    context.user_data['rental_days'] = rental_days

    keyboard = [
        [InlineKeyboardButton("–î–∞, –∫—É—Ä—å–µ—Ä –Ø–Ω–¥–µ–∫—Å –ü—Ä–æ", callback_data="yandex_pro_yes")],
        [InlineKeyboardButton("–ù–µ—Ç", callback_data="yandex_pro_no")]
    ]

    await query.edit_message_text(
        "–ö—É—Ä—å–µ—Ä —è–≤–ª—è–µ—Ç—Å—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º –Ø–Ω–¥–µ–∫—Å –ü–†–û?",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

    return ELECTROBIKE_YANDEX_PRO

# ---------- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ç–∞—Ç—É—Å–∞ –Ø–Ω–¥–µ–∫—Å –ü—Ä–æ ----------
# corrected_code.py

import aiosqlite # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
async def electrobike_yandex_pro_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –ü–û–õ–ù–û–°–¢–¨–Æ –ê–°–ò–ù–•–†–û–ù–ù–ê–Ø –í–ï–†–°–ò–Ø:
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –∫—É—Ä—å–µ—Ä–∞ –Ø–Ω–¥–µ–∫—Å –ü—Ä–æ –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç aiosqlite –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –ë–î.
    """
    query = update.callback_query
    await query.answer()

    try:
        is_yandex_pro = 1 if query.data == "yandex_pro_yes" else 0
        bike_id = context.user_data['selected_bike_id']
        user_id = context.user_data['selected_user_id']
        rental_days = context.user_data['rental_days']
        rental_price = calculate_rental_price(rental_days)

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
        async with aiosqlite.connect('bikes.db') as conn:
            conn.row_factory = aiosqlite.Row
            # –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
            await conn.execute("BEGIN")

            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ø–Ω–¥–µ–∫—Å –ü—Ä–æ
            await conn.execute("UPDATE users SET yandexpro = ? WHERE id = ?", (is_yandex_pro, user_id))

            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–µ–∫—É—â–µ–π –∞—Ä–µ–Ω–¥—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
            cursor = await conn.execute("""
                SELECT booking_date, end_date
                FROM bookings WHERE user_id = ? AND bike_id = ? AND status = 'rented'
            """, (user_id, bike_id))
            existing_booking = await cursor.fetchone()

            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—ã –∞—Ä–µ–Ω–¥—ã
            if existing_booking and existing_booking['booking_date']:
                start_date = datetime.strptime(existing_booking['booking_date'], '%d.%m.%Y')
                new_end_date = datetime.strptime(existing_booking['end_date'], '%d.%m.%Y') + timedelta(days=rental_days)
            else:
                start_date = datetime.now()
                new_end_date = start_date + timedelta(days=rental_days)

            # –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –±—Ä–æ–Ω–∏
            await conn.execute("DELETE FROM bookings WHERE user_id = ? AND bike_id = ?", (user_id, bike_id))

            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å –∞—Ä–µ–Ω–¥—ã
            await conn.execute("""
                INSERT INTO bookings (user_id, bike_id, booking_date, end_date, status)
                VALUES (?, ?, ?, ?, 'rented')
            """, (user_id, bike_id, start_date.strftime('%d.%m.%Y'), new_end_date.strftime('%d.%m.%Y')))

            # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞
            await conn.execute("UPDATE bikes SET available = 0 WHERE id = ?", (bike_id,))

            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–∏—Å–ø–æ–ª—å–∑—É—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é)
            log_details = (
                f"–ê—Ä–µ–Ω–¥–∞ –Ω–∞ {rental_days} –¥–Ω–µ–π. "
                f"–ü–µ—Ä–∏–æ–¥: {start_date.strftime('%d.%m.%Y')}-{new_end_date.strftime('%d.%m.%Y')}"
                f"{' (–ö—É—Ä—å–µ—Ä –Ø–Ω–¥–µ–∫—Å –ü—Ä–æ)' if is_yandex_pro else ''}"
            )
            await log_bike_action(conn, bike_id, user_id, "–ê—Ä–µ–Ω–¥–∞", log_details, rental_price)

            # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            user_cursor = await conn.execute("SELECT first_name, last_name FROM users WHERE id = ?", (user_id,))
            user_record = await user_cursor.fetchone()
            user_name = f"{user_record['first_name']} {user_record['last_name']}" if user_record else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

            bike_cursor = await conn.execute("SELECT name FROM bikes WHERE id = ?", (bike_id,))
            bike_name = (await bike_cursor.fetchone())['name']

            # –ó–∞–≤–µ—Ä—à–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
            await conn.commit()

        # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
        period_message = (
            f"üìÖ –°—Ä–æ–∫ –∞—Ä–µ–Ω–¥—ã: {rental_days} –¥–Ω–µ–π\n"
            f"üìÜ –ü–µ—Ä–∏–æ–¥: —Å {start_date.strftime('%d.%m.%Y')} "
            f"–ø–æ {new_end_date.strftime('%d.%m.%Y')}"
        )
        yandex_pro_status = "‚úÖ –ö—É—Ä—å–µ—Ä –Ø–Ω–¥–µ–∫—Å –ü—Ä–æ" if is_yandex_pro else "‚ùå –ù–µ –∫—É—Ä—å–µ—Ä –Ø–Ω–¥–µ–∫—Å –ü—Ä–æ"

        # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        await query.edit_message_text(
            f"‚úÖ –ê—Ä–µ–Ω–¥–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞!\n"
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_name}\n"
            f"üö≤ –í–µ–ª–æ—Å–∏–ø–µ–¥: {bike_name}\n"
            f"üí≥ –°—Ç–æ–∏–º–æ—Å—Ç—å: {rental_price} —Ä—É–±.\n"
            f"{period_message}\n"
            f"{yandex_pro_status}"
        )

        user_msg = (
            f"‚úÖ –í–∞–º –±—ã–ª —Å–¥–∞–Ω —ç–ª–µ–∫—Ç—Ä–æ–≤–µ–ª–æ—Å–∏–ø–µ–¥!\n"
            f"üö≤ –í–µ–ª–æ—Å–∏–ø–µ–¥: {bike_name}\n"
            f"{period_message}\n"
        )
        await context.bot.send_message(chat_id=user_id, text=user_msg)

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞—Ä–µ–Ω–¥–µ: {str(e)}", exc_info=True)
        # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ —Å–ª—É—á–∞–µ –ª—é–±–æ–π –æ—à–∏–±–∫–∏
        if 'conn' in locals() and conn.is_connected():
            await conn.rollback()
        await query.edit_message_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∞—Ä–µ–Ω–¥—ã")

    finally:
        context.user_data.clear()
        await context.bot.send_message(
            chat_id=update.effective_chat.id,
            text="–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:",
            reply_markup=get_main_menu(update.effective_user.id)
        )

    return ConversationHandler.END

# ---------- –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ ----------
async def electrobike_return_bike(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –ó–∞–≤–µ—Ä—à–∞–µ—Ç –∞—Ä–µ–Ω–¥—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–µ–ª–æ—Å–∏–ø–µ–¥ –≤ –¥–æ—Å—Ç—É–ø–Ω—ã–µ.
    """
    try:
        user_id = context.user_data.get('selected_user_id')
        if not user_id:
            await update.message.reply_text("‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤—ã–±—Ä–∞–Ω. –ù–∞—á–Ω–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –∞—Ä–µ–Ω–¥—ã –∑–∞–Ω–æ–≤–æ.")
            return ConversationHandler.END

        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∞—Ä–µ–Ω–¥—É
        cursor.execute("""
            SELECT bike_id
            FROM bookings
            WHERE user_id = ? AND status = 'rented'
        """, (user_id,))
        booking = cursor.fetchone()

        if not booking:
            await update.message.reply_text("‚ùå –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∞—Ä–µ–Ω–¥—ã.")
            conn.close()
            return ConversationHandler.END

        bike_id = booking[0]

        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞
        cursor.execute("UPDATE bikes SET available = 1 WHERE id = ?", (bike_id,))

        # –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ–± –∞—Ä–µ–Ω–¥–µ
        cursor.execute("DELETE FROM bookings WHERE user_id = ? AND bike_id = ? AND status = 'rented'",
                      (user_id, bike_id))

        # –õ–æ–≥–∏—Ä—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
        cursor.execute("SELECT name FROM bikes WHERE id = ?", (bike_id,))
        bike_name = cursor.fetchone()[0]
        log_bike_action(
            bike_id=bike_id,
            user_id=user_id,
            action="–í–æ–∑–≤—Ä–∞—Ç",
            details=f"–í–µ–ª–æ—Å–∏–ø–µ–¥ {bike_name} –≤–æ–∑–≤—Ä–∞—â–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}",
            amount=0
        )

        conn.commit()
        conn.close()

        await update.message.reply_text(
            f"‚úÖ –í–µ–ª–æ—Å–∏–ø–µ–¥ {bike_name} —É—Å–ø–µ—à–Ω–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω!",
            reply_markup=get_main_menu(update.effective_user.id)
        )
        context.user_data.clear()
        return ConversationHandler.END

    except sqlite3.Error as db_error:
        logger.error(f"–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ: {str(db_error)}")
        await update.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        return ConversationHandler.END
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ: {str(e)}")
        await update.message.reply_text("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        return ConversationHandler.END




# ---------- –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Ü–µ–Ω—ã ----------
def calculate_rental_price(rental_days: int) -> int:
    return PRICE_FOR_PERIOD.get(rental_days, rental_days * BASE_PRICE_PER_DAY)


async def add_part(update: Update, context) -> int:
    user_id = update.message.from_user.id
    if not is_admin(user_id):
        await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø—á–∞—Å—Ç–µ–π.")
        return ConversationHandler.END  # –ó–∞–≤–µ—Ä—à–∞–µ—Ç –¥–∏–∞–ª–æ–≥, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–¥–º–∏–Ω

    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–∏:")
    return 1  # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–æ—Å—Ç–æ—è–Ω–∏—é –≤–≤–æ–¥–∞ –Ω–∞–∑–≤–∞–Ω–∏—è

async def set_part_name(update: Update, context) -> int:
    context.user_data['part_name'] = update.message.text
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–∏ (–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏—Ç–µ '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å'):")
    return 2  # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É (–æ–ø–∏—Å–∞–Ω–∏–µ)

async def set_part_description(update: Update, context) -> int:
    description = update.message.text.strip()

    # –ï—Å–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ, –º–æ–∂–µ–º –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –µ–≥–æ
    if description:
        context.user_data['part_description'] = description

    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (—à—Ç.):")
    return 3  # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)

async def set_part_quantity(update: Update, context) -> int:
    quantity = update.message.text.strip()

    try:
        quantity = int(quantity)  # –ü—Ä–æ–±—É–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ —á–∏—Å–ª–æ
        context.user_data['part_quantity'] = quantity  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
    except ValueError:
        await update.message.reply_text("üö´ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ.")
        return 3  # –û—Å—Ç–∞—ë–º—Å—è –Ω–∞ —à–∞–≥–µ –≤–≤–æ–¥–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞

    await update.message.reply_text("–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –∑–∞–ø—á–∞—Å—Ç–∏:")
    return 4  # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ

async def work_menu_handler(update: Update, context) -> None:
    text = update.message.text

    if text == "üìù –û—Ç–º–µ—Ç–∏—Ç—å—Å—è –Ω–∞ —Ä–∞–±–æ—Ç–µ":
        await mark_attendance(update, context)  # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ –Ω–∞ —Ä–∞–±–æ—Ç–µ
    elif text == "üìú –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–º–µ—Ç–æ–∫":
        await view_attendance_history(update, context)  # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –æ—Ç–º–µ—Ç–æ–∫
    elif text == "üèÅ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å":
        await finish_attendance(update, context)  # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è
    elif text == "üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é":
        await start(update, context)  # –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

async def set_part_photo(update: Update, context) -> int:
    if update.message.photo:
        photo = update.message.photo[-1]
        context.user_data['part_photo_url'] = photo.file_id

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–ø—á–∞—Å—Ç–∏ –≤ –±–∞–∑—É
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        cursor.execute('''INSERT INTO parts (name, description, available, photo_url, quantity)
                          VALUES (?, ?, ?, ?, ?)''', (
                              context.user_data['part_name'],
                              context.user_data.get('part_description', ""),  # –ü–µ—Ä–µ–¥–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–µ —É–∫–∞–∑–∞–Ω–æ
                              1,  # –°—Ç–∞—Ç—É—Å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
                              context.user_data['part_photo_url'],
                              context.user_data['part_quantity'],  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
                          ))
        conn.commit()
        conn.close()

        await update.message.reply_text(f"üéâ –ó–∞–ø—á–∞—Å—Ç—å '{context.user_data['part_name']}' —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º {context.user_data['part_quantity']} —à—Ç—É–∫!")
        return ConversationHandler.END
    else:
        await update.message.reply_text("üö´ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –∑–∞–ø—á–∞—Å—Ç–∏.")
        return 4  # –û—Å—Ç–∞–µ–º—Å—è –Ω–∞ —à–∞–≥–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ

# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—á–∞—Å—Ç–µ–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ üîß
async def edit_parts(update: Update, context) -> None:
    user_id = update.message.from_user.id
    if not is_admin(user_id):
        await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—á–∞—Å—Ç–µ–π.")
        return

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT id, name FROM parts")
    parts = cursor.fetchall()
    conn.close()

    if not parts:
        await update.message.reply_text("üö´ –ó–∞–ø—á–∞—Å—Ç–∏ –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.")
        return

    keyboard = [[InlineKeyboardButton(part[1], callback_data=f"edit_part_{part[0]}")] for part in parts]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text("üñäÔ∏è –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–ø—á–∞—Å—Ç—å –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:", reply_markup=reply_markup)

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è ConversationHandler
EDITING_MENU, CHANGE_STATUS, CHANGE_QUANTITY = range(3)

async def start_editing_part(update: Update, context) -> int:
    query = update.callback_query
    await query.answer()
    part_id = query.data.split("_")[2]

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT name, description, available, quantity FROM parts WHERE id=?", (part_id,))
    part = cursor.fetchone()
    conn.close()

    if not part:
        await query.message.reply_text("üö´ –ó–∞–ø—á–∞—Å—Ç—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        return ConversationHandler.END

    context.user_data.update({
        'editing_part': {
            'id': part_id,
            'name': part[0],
            'description': part[1],
            'available': part[2],
            'quantity': part[3]
        },
        'original_data': {
            'available': part[2],
            'quantity': part[3]
        }
    })

    return await show_editing_menu(query.message, context)

async def show_editing_menu(message, context):
    part = context.user_data['editing_part']
    text = (
        f"üõ† –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—á–∞—Å—Ç–∏:\n\n"
        f"‚ñ´Ô∏è –ù–∞–∑–≤–∞–Ω–∏–µ: {part['name']}\n"
        f"‚ñ´Ô∏è –û–ø–∏—Å–∞–Ω–∏–µ: {part['description'] or '–Ω–µ—Ç'}\n"
        f"‚ñ´Ô∏è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {part['quantity']} —à—Ç.\n"
        f"‚ñ´Ô∏è –°—Ç–∞—Ç—É—Å: {'‚úÖ –í –Ω–∞–ª–∏—á–∏–∏' if part['available'] else '‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'}"
    )

    keyboard = [
        [
            InlineKeyboardButton("üîÑ –°—Ç–∞—Ç—É—Å", callback_data="change_status"),
            InlineKeyboardButton("üî¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", callback_data="change_quantity")
        ],
        [InlineKeyboardButton("‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å", callback_data="save_changes")]
    ]

    await message.edit_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
    return EDITING_MENU

async def handle_editing_menu(update: Update, context) -> int:
    query = update.callback_query
    await query.answer()

    if query.data == "change_status":
        keyboard = [
            [
                InlineKeyboardButton("‚úÖ –í –Ω–∞–ª–∏—á–∏–∏", callback_data="set_available_1"),
                InlineKeyboardButton("‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏", callback_data="set_available_0")
            ],
            [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="back")]
        ]
        await query.edit_message_text("–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å:", reply_markup=InlineKeyboardMarkup(keyboard))
        return CHANGE_STATUS

    elif query.data == "change_quantity":
        keyboard = [
            [
                InlineKeyboardButton("‚ûï1", callback_data="add_1"),
                InlineKeyboardButton("‚ûñ1", callback_data="remove_1")
            ],
            [InlineKeyboardButton("üéØ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å 10", callback_data="set_10")],
            [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="back")]
        ]
        await query.edit_message_text(
            f"–¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: {context.user_data['editing_part']['quantity']}\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        return CHANGE_QUANTITY

    elif query.data == "save_changes":
        return await save_changes(update, context)

    elif query.data == "back":
        return await show_editing_menu(query.message, context)

async def handle_status_change(update: Update, context) -> int:
    query = update.callback_query
    await query.answer()

    if query.data.startswith("set_available_"):
        new_status = int(query.data.split("_")[2])
        context.user_data['editing_part']['available'] = new_status
        await query.answer("–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!")

    return await show_editing_menu(query.message, context)

async def handle_quantity_change(update: Update, context) -> int:
    query = update.callback_query
    await query.answer()
    current = context.user_data['editing_part']['quantity']

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    if query.data == "add_1":
        new_qty = current + 1
    elif query.data == "remove_1":
        new_qty = max(0, current - 1)
    elif query.data == "set_10":
        new_qty = 10
    else:
        return await show_editing_menu(query.message, context)

    # –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç–∏
    context.user_data['editing_part']['quantity'] = new_qty

    # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é
    keyboard = [
        [
            InlineKeyboardButton("‚ûï1", callback_data="add_1"),
            InlineKeyboardButton("‚ûñ1", callback_data="remove_1")
        ],
        [InlineKeyboardButton("üéØ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å 10", callback_data="set_10")],
        [InlineKeyboardButton("‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="back")]
    ]

    await query.edit_message_text(
        f"–¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: {new_qty}\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )

    # –û—Å—Ç–∞—ë–º—Å—è –≤ —Ç–æ–º –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    return CHANGE_QUANTITY

async def save_changes(update: Update, context) -> int:
    query = update.callback_query
    await query.answer()

    part_data = context.user_data['editing_part']
    original_data = context.user_data['original_data']
    changes = []

    conn = sqlite3.connect(DB_FILE)
    try:
        cursor = conn.cursor()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        if part_data['available'] != original_data['available']:
            cursor.execute(
                "UPDATE parts SET available = ? WHERE id = ?",
                (part_data['available'], part_data['id'])
            )
            changes.append("—Å—Ç–∞—Ç—É—Å")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        if part_data['quantity'] != original_data['quantity']:
            cursor.execute(
                "UPDATE parts SET quantity = ? WHERE id = ?",
                (part_data['quantity'], part_data['id'])
            )
            changes.append("–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ")

        conn.commit()

        if changes:
            # –î–æ–±–∞–≤—å—Ç–µ –≤–∞—à—É —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é log_action
            await query.message.reply_text("‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!")
        else:
            await query.message.reply_text("‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è")

    except Exception as e:
        await query.message.reply_text(f"üö´ –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: {str(e)}")
    finally:
        conn.close()

    return ConversationHandler.END
# –ù–æ–≤—ã–π –ø—É–Ω–∫—Ç: –≤–æ–ø—Ä–æ—Å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É

common_questions = [
    "üìú –ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è",
    "üö¥‚Äç‚ôÇÔ∏è –ê—Ä–µ–Ω–¥–∞",
    "üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç",
    "üîã –ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä",
    "üí≥ –¶–µ–Ω—ã",
    "üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã",
    "üè† –ê–¥—Ä–µ—Å",
    "üõ†Ô∏è –ü–æ–ª–æ–º–∫–∞",
    "‚ùì –î—Ä—É–≥–æ–µ"
]

# –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏
def get_support_keyboard():
    keyboard = [
        common_questions[:2],  # –ü–µ—Ä–≤—ã–µ –¥–≤–∞ –≤–æ–ø—Ä–æ—Å–∞
        common_questions[2:4],  # –°–ª–µ–¥—É—é—â–∏–µ –¥–≤–∞ –≤–æ–ø—Ä–æ—Å–∞
        common_questions[4:6],  # –°–ª–µ–¥—É—é—â–∏–µ –¥–≤–∞ –≤–æ–ø—Ä–æ—Å–∞
        common_questions[6:8],  # –°–ª–µ–¥—É—é—â–∏–µ –¥–≤–∞ –≤–æ–ø—Ä–æ—Å–∞
        [common_questions[8]]  # –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–æ–ø—Ä–æ—Å ("‚ùì –î—Ä—É–≥–æ–µ")
    ]
    return ReplyKeyboardMarkup(keyboard, one_time_keyboard=True, resize_keyboard=True)


async def ask_support(update: Update, context) -> int:
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏
    reply_markup = get_support_keyboard()
    await update.message.reply_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π –≤–∞—Å –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ '–î—Ä—É–≥–æ–µ':",
        reply_markup=reply_markup
    )
    return 1  # –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é

async def save_question(update: Update, context) -> int:
    user_id = update.message.from_user.id
    username = update.message.from_user.username
    question = update.message.text

    if question == "‚ùì –î—Ä—É–≥–æ–µ":
        await update.message.reply_text(
            "‚úçÔ∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏:",
            reply_markup=ReplyKeyboardRemove()
        )
        return 1

    faq_responses = {
        "üìú –ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è": (
            "üìú *–ü—Ä–∞–≤–∏–ª–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:*\n\n"
            "1. üö¥‚Äç‚ôÇÔ∏è –í–µ–ª–æ—Å–∏–ø–µ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–æ–∑–≤—Ä–∞—â–µ–Ω –≤ –∏—Å–ø—Ä–∞–≤–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.\n"
            "2. ‚ö†Ô∏è –í —Å–ª—É—á–∞–µ –ø–æ–ª–æ–º–∫–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.\n"
            "3. üõ†Ô∏è –ó–∞–ø—Ä–µ—â–∞–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥ –≤ –Ω–µ–±–ª–∞–≥–æ–ø—Ä–∏—è—Ç–Ω—ã—Ö –ø–æ–≥–æ–¥–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö."
        ),
        "üö¥‚Äç‚ôÇÔ∏è –ê—Ä–µ–Ω–¥–∞": (
            "üö¥‚Äç‚ôÇÔ∏è *–ê—Ä–µ–Ω–¥–∞:*\n\n"
            "1. üìÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ä–æ–∫ –∞—Ä–µ–Ω–¥—ã ‚Äî *2 –Ω–µ–¥–µ–ª–∏*.\n"
            "2. üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã –∑–∞ 2 –Ω–µ–¥–µ–ª–∏ ‚Äî *6500 —Ä—É–±–ª–µ–π*, –∑–∞ 1 –º–µ—Å—è—Ü ‚Äî *12600 —Ä—É–±–ª–µ–π*. –ó–∞–ª–æ–≥ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.\n"
            "3. üìù –î–ª—è –∞—Ä–µ–Ω–¥—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ª–∏—á–Ω–æ—Å—Ç—å. –≠—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:\n"
            "   - –í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.\n"
            "   - –õ–∏—á–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: *–ú–æ—Å–∫–≤–∞,  —É–ª. –°–∞–ª—Ç—ã–∫–æ–≤—Å–∫–∞—è, –¥. 53*."
        ),
        "üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç": (
            "üë§ *–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç:*\n\n"
            "–ü—Ä–∏ –≤—Ö–æ–¥–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –≤—ã —É–≤–∏–¥–∏—Ç–µ:\n"
            "1. ‚úÖ –°–ø–∏—Å–æ–∫ –≤–∞—à–∏—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—Ä–µ–Ω–¥.\n"
            "2. üõ†Ô∏è –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —Ä–µ–º–æ–Ω—Ç."
        ),
        "üîã –ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä": (
            "üîã *–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä:*\n\n"
            "1. ‚ö° –ó–∞—Ä—è–∂–∞–π—Ç–µ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä —Ç–æ–ª—å–∫–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º –∑–∞—Ä—è–¥–Ω—ã–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º.\n"
            "2. üïí –í—Ä–µ–º—è –∑–∞—Ä—è–¥–∫–∏: *4-6 —á–∞—Å–æ–≤*.\n"
            "3. ‚ö†Ô∏è *–í–ê–ñ–ù–û!* –•—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∑–∞—Ä—è–¥–∫–∞ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞ **–¢–û–õ–¨–ö–û** –≤ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –æ—Ç–≤–µ–¥–µ–Ω–Ω—ã—Ö –∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–Ω—ã—Ö –¥–ª—è —ç—Ç–æ–≥–æ –º–µ—Å—Ç–∞—Ö. **–ó–∞—Ä—è–¥–∫–∞ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ–º–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã!**\n"
            "4. ‚ùÑÔ∏è –ù–µ –æ—Å—Ç–∞–≤–ª—è–π—Ç–µ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä –Ω–∞ –º–æ—Ä–æ–∑–µ."
        ),
        "üí≥ –¶–µ–Ω—ã": (
            "üí≥ *–¶–µ–Ω—ã:*\n\n"
            "1. üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å –∞—Ä–µ–Ω–¥—ã –Ω–∞ 2 –Ω–µ–¥–µ–ª–∏ ‚Äî *6500 —Ä—É–±–ª–µ–π*, –Ω–∞ 1 –º–µ—Å—è—Ü ‚Äî *12600 —Ä—É–±–ª–µ–π*.\n"
            "2. üõ†Ô∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ (—Ä–µ–º–æ–Ω—Ç, –∑–∞–º–µ–Ω–∞ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞) –æ–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ."
        ),
        "üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã": (
            "üìû *–ö–æ–Ω—Ç–∞–∫—Ç—ã:*\n\n"
            "1. üë§ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤ Telegram: @BFbike\n"
            "2. üè† –ê–¥—Ä–µ—Å: *–ú–æ—Å–∫–≤–∞,  —É–ª. –°–∞–ª—Ç—ã–∫–æ–≤—Å–∫–∞—è, –¥. 53*."
        ),
        "üè† –ê–¥—Ä–µ—Å": (
            "üè† *–ê–¥—Ä–µ—Å:*\n\n"
            "–ù–∞—à –æ—Ñ–∏—Å –∏ –ø—É–Ω–∫—Ç –≤—ã–¥–∞—á–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ –∞–¥—Ä–µ—Å—É:\n"
            "*–ú–æ—Å–∫–≤–∞, —É–ª.  —É–ª. –°–∞–ª—Ç—ã–∫–æ–≤—Å–∫–∞—è, –¥. 53*."
        ),
        "üõ†Ô∏è –ü–æ–ª–æ–º–∫–∞": (
            "üõ†Ô∏è *–ü–æ–ª–æ–º–∫–∞:*\n\n"
            "1. ‚ö†Ô∏è –ï—Å–ª–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥ —Å–ª–æ–º–∞–ª—Å—è, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.\n"
            "2. üîß –ú—ã –æ—Ä–≥–∞–Ω–∏–∑—É–µ–º —Ä–µ–º–æ–Ω—Ç –∏–ª–∏ –∑–∞–º–µ–Ω—É –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞.\n"
            "3. üí∏ –°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–º–æ–Ω—Ç–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∞ –ø–æ–ª–æ–º–∫–∏."
        )
    }

    if question in faq_responses:
        await update.message.reply_text(
            faq_responses[question],
            parse_mode="Markdown",
            reply_markup=get_main_menu(user_id)
        )
        await update.message.reply_sticker("CAACAgIAAxkBAAELJLpnafJf41vdO_aBH9vqRqObj_qseAACdx4AAhZXMUoZXzrQO2igmzYE")
        return ConversationHandler.END

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    try:
        cursor.execute("INSERT INTO questions (user_id, username, question) VALUES (?, ?, ?)", (user_id, username, question))
        conn.commit()
        logger.info("–í–æ–ø—Ä–æ—Å —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")
        await update.message.reply_text(
            "‚úÖ –í–∞—à –≤–æ–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∏—Ç –≤–∞–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.",
            parse_mode="Markdown"
        )
        notification_message = f"üì© –ù–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è @{username}:\n{question}"
        for admin_id in ADMIN_IDS:
            await context.bot.send_message(admin_id, notification_message, parse_mode="Markdown")
            add_notification(notification_message)
        await update.message.reply_sticker("CAACAgIAAxkBAAELJLpnafJf41vdO_aBH9vqRqObj_qseAACdx4AAhZXMUoZXzrQO2igmzYE")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–∞: {e}")
        await update.message.reply_text(
            "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤–∞—à–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.",
            parse_mode="Markdown"
        )
    finally:
        conn.close()

    await update.message.reply_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –∏–∑ –º–µ–Ω—é –Ω–∏–∂–µ:",
        reply_markup=get_main_menu(user_id)
    )
    return ConversationHandler.END

async def view_questions(update: Update, context) -> None:
    if not is_admin(update.message.from_user.id):
        await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É —Ä–∞–∑–¥–µ–ª—É.")
        return

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT id, username, question FROM questions")
    questions = cursor.fetchall()
    conn.close()

    if not questions:
        await update.message.reply_text("–ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.")
        return

    for question_id, username, question in questions:
        keyboard = [[InlineKeyboardButton("–û—Ç–≤–µ—Ç–∏—Ç—å", callback_data=f"answer_{question_id}")]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await update.message.reply_text(f"‚ùì –í–æ–ø—Ä–æ—Å –æ—Ç @{username}:\n{question}", reply_markup=reply_markup)

async def answer_question(update: Update, context) -> int:
    query = update.callback_query
    await query.answer()
    question_id = int(query.data.split("_")[1])
    context.user_data['question_id'] = question_id

    await query.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å:")
    return 1

async def send_answer(update: Update, context) -> int:
    question_id = context.user_data['question_id']
    answer = update.message.text

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT user_id FROM questions WHERE id=?", (question_id,))
    user_id = cursor.fetchone()[0]

    cursor.execute("DELETE FROM questions WHERE id=?", (question_id,))
    conn.commit()
    conn.close()

    await context.bot.send_message(chat_id=user_id, text=f"–û—Ç–≤–µ—Ç –Ω–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å:\n{answer}")
    await update.message.reply_text("–û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, –≤–æ–ø—Ä–æ—Å —É–¥–∞–ª–µ–Ω.")
    return ConversationHandler.END

async def finish_attendance(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–®–∞–≥ 1 (–ö–æ–Ω–µ—Ü –¥–Ω—è): –ü—Ä–æ—Å–∏—Ç –ø—Ä–∏—Å–ª–∞—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã."""
    user_id = update.message.from_user.id
    context.user_data['attendance_action'] = 'end'
    
    await update.message.reply_text(
        "–ß—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à—É –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é.",
        reply_markup=ReplyKeyboardMarkup(
            [[KeyboardButton("üìç –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é", request_location=True)]],
            resize_keyboard=True, one_time_keyboard=True
        )
    )

async def receive_location(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –®–∞–≥ 2 (–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π): –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é –∏, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–µ–π—Å—Ç–≤–∏—è,
    —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–º–µ—Ç–∫—É –æ –Ω–∞—á–∞–ª–µ –∏–ª–∏ –∫–æ–Ω—Ü–µ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è.
    """
    user_id = update.message.from_user.id
    location = update.message.location
    action = context.user_data.pop('attendance_action', None) # –ü–æ–ª—É—á–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Ñ–ª–∞–≥ –¥–µ–π—Å—Ç–≤–∏—è

    if not action:
        return # –ï—Å–ª–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è –ø—Ä–∏—à–ª–∞ —Å–ª—É—á–∞–π–Ω–æ, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º

    status_text = 'start of work' if action == 'start' else 'end of work'
    
    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            await conn.execute(
                "INSERT INTO attendance (user_id, timestamp, status, latitude, longitude) VALUES (?, ?, ?, ?, ?)",
                (user_id, datetime.now().strftime('%Y-%m-%d %H:%M:%S'), status_text, location.latitude, location.longitude)
            )
            await conn.commit()

        if action == 'start':
            await update.message.reply_text(
                "‚úÖ –û—Ç–ª–∏—á–Ω–æ! –í–∞—à —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å –Ω–∞—á–∞—Ç. –£–¥–∞—á–Ω–æ–π —Å–º–µ–Ω—ã!",
                reply_markup=get_main_menu(user_id)
            )
        else:
            await update.message.reply_text(
                "‚úÖ –†–∞–±–æ—á–∏–π –¥–µ–Ω—å –∑–∞–≤–µ—Ä—à–µ–Ω. –°–ø–∞—Å–∏–±–æ –∑–∞ —Ä–∞–±–æ—Ç—É!",
                reply_markup=get_main_menu(user_id)
            )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –¥–ª—è {user_id}: {e}", exc_info=True)
        await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.", reply_markup=get_main_menu(user_id))

async def status(update: Update, context) -> None:
    user_id = update.message.from_user.id
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è
    cursor.execute("SELECT status, timestamp FROM attendance WHERE user_id=?", (user_id,))
    attendance_records = cursor.fetchall()

    # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    cursor.execute("SELECT booking_date, end_date, status FROM bookings WHERE user_id=?", (user_id,))
    bookings = cursor.fetchall()

    conn.close()

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è
    attendance_status = []
    for record in attendance_records:
        status, timestamp = record
        attendance_status.append(f"–°—Ç–∞—Ç—É—Å: {status}, –í—Ä–µ–º—è: {timestamp}")

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
    booking_status = []
    for booking in bookings:
        booking_date, end_date, status = booking
        booking_status.append(f"–î–∞—Ç–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: {booking_date}, –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: {end_date}, –°—Ç–∞—Ç—É—Å: {status}")

    # –°–æ–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    status_message = "üìä –í–∞—à —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:\n\n"

    if attendance_status:
        status_message += "üïí –û—Ç–º–µ—Ç–∫–∏ –æ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏:\n" + "\n".join(attendance_status) + "\n\n"
    else:
        status_message += "üö´ –£ –≤–∞—Å –Ω–µ—Ç –æ—Ç–º–µ—Ç–æ–∫ –æ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏.\n\n"

    if booking_status:
        status_message += "üìÖ –í–∞—à–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:\n" + "\n".join(booking_status)
    else:
        status_message += "üö´ –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π."

    await update.message.reply_text(status_message)

############# –ü–†–û–î–õ–ï–ù–ò–ï –ê–†–ï–ù–î–´ #############
############# –ü–†–û–î–õ–ï–ù–ò–ï –ê–†–ï–ù–î–´ #############
############# –ü–†–û–î–õ–ï–ù–ò–ï –ê–†–ï–ù–î–´ #############

# –ù–ê–ô–î–ò–¢–ï –§–£–ù–ö–¶–ò–Æ request_extension –ò –ó–ê–ú–ï–ù–ò–¢–ï –ï–ï –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

# main.py

# main.py

async def request_extension(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø:
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –¢–û–ß–ù–´–ô booking_id –æ—Ç –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–∏ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø—Ä–æ–¥–ª–µ–Ω–∏—è
    –∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞, –∞ –Ω–µ –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ.
    """
    query = update.callback_query
    await query.answer()

    try:
        # --- –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–æ–ª—É—á–∞–µ–º ID –±—Ä–æ–Ω–∏ –∏–∑ callback_data ---
        # –§–æ—Ä–º–∞—Ç callback_data: auto_prolong_7_{booking_id}
        # –ù–∞–º –Ω–µ –≤–∞–∂–Ω—ã –ø–µ—Ä–≤—ã–µ —Ç—Ä–∏ —á–∞—Å—Ç–∏, –Ω—É–∂–µ–Ω —Ç–æ–ª—å–∫–æ ID –≤ –∫–æ–Ω—Ü–µ.
        booking_id = int(query.data.split('_')[-1])
    except (ValueError, IndexError):
        await query.message.edit_text("‚ùå –û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –∫–∞–∫—É—é –∞—Ä–µ–Ω–¥—É –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–ª–∏—Ç—å.")
        return

    # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç)
    await query.message.delete()

    # --- –õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π, –Ω–æ —Ç–µ–ø–µ—Ä—å –æ–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π booking_id ---
    keyboard = [
        [InlineKeyboardButton("–ù–∞ 7 –¥–Ω–µ–π", callback_data=f"accept_extension_7_{booking_id}")],
        [InlineKeyboardButton("–ù–∞ 14 –¥–Ω–µ–π", callback_data=f"accept_extension_14_{booking_id}")],
        [InlineKeyboardButton("–ù–∞ 30 –¥–Ω–µ–π", callback_data=f"accept_extension_30_{booking_id}")],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_prolong")]
    ]

    await context.bot.send_message(
        chat_id=query.from_user.id,
        text="üìÖ –í—ã–±–µ—Ä–∏—Ç–µ, –Ω–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–ª–∏—Ç—å –∞—Ä–µ–Ω–¥—É:",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
# –î–û–ë–ê–í–¨–¢–ï –≠–¢–ò –î–í–ï –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –í –í–ê–® –ö–û–î

# –¢–í–û–Ø –ù–ï–ü–†–ê–í–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø
# –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
async def start_user_custom_extension(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –®–∞–≥ 1 (–¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞): –ù–∞—á–∏–Ω–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø—Ä–æ–¥–ª–µ–Ω–∏—è.
    –£–¥–∞–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞.
    """
    query = update.callback_query
    await query.answer()

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –±—Ä–æ–Ω–∏ –∏–∑ callback_data
    booking_id = int(query.data.split("_")[-1])
    context.user_data['user_extending_booking_id'] = booking_id

    # <<< –ù–ê–ß–ê–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø >>>
    # –í–º–µ—Å—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –º—ã –µ–≥–æ —É–¥–∞–ª—è–µ–º
    try:
        await query.message.delete()
    except Exception as e:
        # –õ–æ–≥–∏—Ä—É–µ–º, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä–æ–µ)
        # –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø—Ä–æ–¥–ª–µ–Ω–∏—è: {e}")

    # –ò –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ, —á–∏—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–ø—Ä–æ—Å–æ–º
    await context.bot.send_message(
        chat_id=query.from_user.id,
        text="–í–≤–µ–¥–∏—Ç–µ –∂–µ–ª–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: 5 –∏–ª–∏ 20):"
    )
    # <<< –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø >>>

    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    return USER_AWAIT_CUSTOM_DAYS

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

async def process_user_custom_extension(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 2 (–¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞): –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–Ω–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞—è–≤–∫—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π."""
    try:
        days = int(update.message.text.strip())
        if days <= 0:
            raise ValueError
    except ValueError:
        await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –¥–Ω–µ–π.")
        return USER_AWAIT_CUSTOM_DAYS

    booking_id = context.user_data.get('user_extending_booking_id')
    user = update.message.from_user
    user_id = user.id

    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    async with aiosqlite.connect(DB_FILE) as conn:
        conn.row_factory = aiosqlite.Row
        user_name_formatted = await get_user_info_for_notification(user_id, conn)
        bike_cursor = await conn.execute("SELECT name FROM bikes WHERE id = (SELECT bike_id FROM bookings WHERE id=?)", (booking_id,))
        bike_name_row = await bike_cursor.fetchone()
        bike_name = bike_name_row['name'] if bike_name_row else "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≤–µ–ª–æ—Å–∏–ø–µ–¥"

    admin_notification = (
        f"üîî –ó–∞–ø—Ä–æ—Å –Ω–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ!\n\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_name_formatted}\n"
        f"üö≤ –í–µ–ª–æ—Å–∏–ø–µ–¥: {bike_name} (–±—Ä–æ–Ω—å #{booking_id})\n"
        f"‚è≥ –ñ–µ–ª–∞–µ–º—ã–π —Å—Ä–æ–∫: {days} –¥–Ω–µ–π\n\n"
        "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É –∏ –≤—ã—Å—Ç–∞–≤–∏—Ç—å —Å—á–µ—Ç."
    )

    # –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–¥–∞–µ—Ç –≤ callback_data –∏ ID –±—Ä–æ–Ω–∏, –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π
    keyboard = [[
        InlineKeyboardButton("‚úçÔ∏è –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–æ–¥–ª–µ–Ω–∏–µ", callback_data=f"extend_custom_start_{booking_id}_{days}")
    ]]
    reply_markup = InlineKeyboardMarkup(keyboard)

    for admin_id in ADMIN_IDS:
        await context.bot.send_message(admin_id, admin_notification, reply_markup=reply_markup)

    await update.message.reply_text(
        "‚úÖ –í–∞—à –∑–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É. –û–Ω —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏. –°–ø–∞—Å–∏–±–æ!"
    )
    context.user_data.clear()
    return ConversationHandler.END

async def handle_custom_extension_start(update: Update, context: CallbackContext) -> int:
    """–®–∞–≥ 1 (–¥–ª—è –∞–¥–º–∏–Ω–∞): –ù–∞—á–∏–Ω–∞–µ—Ç –¥–∏–∞–ª–æ–≥, –∑–∞–ø—Ä–∞—à–∏–≤–∞—è —Ü–µ–Ω—É."""
    query = update.callback_query
    await query.answer()

    # –†–∞–∑–±–∏—Ä–∞–µ–º callback_data: extend_custom_start_{booking_id}_{days}
    parts = query.data.split('_')
    booking_id = int(parts[3])
    days_to_extend = int(parts[4])

    context.user_data['extending_booking_id'] = booking_id
    context.user_data['custom_extension_days'] = days_to_extend

    await query.edit_message_text(
        f"–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –Ω–∞ *{days_to_extend} –¥–Ω–µ–π*.\n"
        "–í–≤–µ–¥–∏—Ç–µ –û–ë–©–£–Æ —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–ª—è —ç—Ç–æ–≥–æ —Å—Ä–æ–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5000):",
        parse_mode="Markdown"
    )
    return AWAIT_CUSTOM_PRICE # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –æ–∂–∏–¥–∞–Ω–∏—é —Ü–µ–Ω—ã


# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ accept_extension –ù–ê –≠–¢–£:
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ accept_extension –ù–ê –≠–¢–£:

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ accept_extension –ù–ê –≠–¢–£:
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ accept_extension –ù–ê –≠–¢–£

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
# ### –ù–û–í–ê–Ø, –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
async def accept_extension(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –®–∞–≥ 2 (–ü—Ä–æ–¥–ª–µ–Ω–∏–µ): –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –≤—ã–±–æ—Ä —Å—Ä–æ–∫–∞, –ø–æ–ª—É—á–∞–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –∏–∑ –ë–î –∏ –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç —Å—á–µ—Ç.
    –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –Ω–æ–≤–æ–≥–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏.
    """
    query = update.callback_query
    await query.answer()
    
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –≤—ã–±–æ—Ä–∞ —Å—Ä–æ–∫–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—É—Ç–∞–Ω–∏—Ü—ã
    await query.message.delete()

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã
    if query.data == "cancel_prolong":
        await context.bot.send_message(chat_id=query.from_user.id, text="–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
        return

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ —Å—á–µ—Ç–∞
    status_message = await context.bot.send_message(chat_id=query.from_user.id, text="‚è≥ –ì–æ—Ç–æ–≤–ª—é —Å—á–µ—Ç –Ω–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã...")

    try:
        # –†–∞–∑–±–∏—Ä–∞–µ–º callback_data: accept_extension_{days}_{booking_id}
        parts = query.data.split('_')
        days_to_extend = int(parts[2])
        booking_id = int(parts[3])
        user_id = query.from_user.id
        
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            price_column_name = f"rent_price_{days_to_extend}d"
            
            cursor = await conn.execute(
                f"""SELECT u.phone_number, b.name as bike_name, b.{price_column_name} as price
                   FROM bookings bo
                   JOIN users u ON bo.user_id = u.id
                   JOIN bikes b ON bo.bike_id = b.id
                   WHERE bo.id=?
                """,
                (booking_id,)
            )
            data = await cursor.fetchone()

        if not data:
            raise ValueError("–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –∞—Ä–µ–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è.")
        if not data['phone_number']:
            raise ValueError("–ù–µ –Ω–∞–π–¥–µ–Ω –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è —á–µ–∫–∞.")

        bike_name = data['bike_name']
        price = data['price']
        
        if price is None or price <= 0:
            raise ValueError(f"–î–ª—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ '{bike_name}' –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ç–∞—Ä–∏—Ñ –Ω–∞ {days_to_extend} –¥–Ω–µ–π.")

        # --- –î–∞–ª—å–Ω–µ–π—à–∏–π –∫–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ---
        description = f"–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã '{bike_name}' –Ω–∞ {days_to_extend} –¥–Ω–µ–π"
        payload = f"prolong_{booking_id}_{days_to_extend}"
        
        metadata = {'internal_payload': payload, 'user_id': user_id}
        items_for_receipt = [{"description": description, "quantity": "1.00", "amount": { "value": f"{float(price):.2f}", "currency": "RUB" }, "vat_code": "1", "payment_subject": "service"}]
        
        payment_info = await create_yookassa_payment(
            amount=price, 
            description=description, 
            metadata=metadata, 
            items=items_for_receipt, 
            customer_info={"phone": data['phone_number']}, 
            payment_method='sbp'
        )
        
        if not payment_info:
            raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É.")

        payment_url, payment_id, final_amount = payment_info['url'], payment_info['id'], payment_info['final_amount']
        
        keyboard = [[InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å –ø—Ä–æ–¥–ª–µ–Ω–∏–µ", url=payment_url)]]
        # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –º—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–ª–∏ ("–ì–æ—Ç–æ–≤–ª—é —Å—á–µ—Ç...")
        animated_message = await status_message.edit_text(
            f"–î–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è –∞—Ä–µ–Ω–¥—ã –Ω–∞ {days_to_extend} –¥–Ω–µ–π, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–ª–∞—Ç–∏—Ç–µ {final_amount:.2f} ‚ÇΩ.",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )

        if 'pending_payments' not in context.bot_data: 
            context.bot_data['pending_payments'] = {}
            
        stop_animation_event = asyncio.Event()
        context.bot_data['pending_payments'][payment_id] = {
            'user_id': user_id, 
            'start_time': datetime.now(), 
            'payload': payload, 
            'amount': final_amount, 
            'animated_message_id': animated_message.message_id, 
            'url': payment_url, 
            'animation_sequence': random.choice(PAYMENT_ANIMATIONS), 
            'stop_animation_event': stop_animation_event
        }
        
        asyncio.create_task(animate_payment_message(context, payment_id))
        context.job_queue.run_repeating(
            callback=check_payment_status, 
            interval=15, 
            first=10, 
            name=f"payment_{payment_id}", 
            data={'yookassa_id': payment_id}
        )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ accept_extension: {e}", exc_info=True)
        # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –Ω–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ "–ì–æ—Ç–æ–≤–ª—é —Å—á–µ—Ç...", —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        await status_message.edit_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")

import locale
from datetime import datetime

async def show_receipts(update: Update, context) -> None:
    user_id = update.message.from_user.id  # –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ–∫–æ–≤

    month_names = {
        1: "–Ø–ù–í–ê–†–¨",
        2: "–§–ï–í–†–ê–õ–¨",
        3: "–ú–ê–†–¢",
        4: "–ê–ü–†–ï–õ–¨",
        5: "–ú–ê–ô",
        6: "–ò–Æ–ù–¨",
        7: "–ò–Æ–õ–¨",
        8: "–ê–í–ì–£–°–¢",
        9: "–°–ï–ù–¢–Ø–ë–†–¨",
        10: "–û–ö–¢–Ø–ë–†–¨",
        11: "–ù–û–Ø–ë–†–¨",
        12: "–î–ï–ö–ê–ë–†–¨"
    }

    with sqlite3.connect(DB_FILE) as conn:
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏–∑ –∑–∞—è–≤–æ–∫ –Ω–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –ø—Ä–∏–Ω—è—Ç—ã
        cursor.execute("""
            SELECT er.photo, bk.id, u.first_name, u.last_name, u.username, er.created_at
            FROM extension_requests er
            JOIN bookings bk ON er.booking_id = bk.id
            JOIN users u ON bk.user_id = u.id
            WHERE er.status='accepted'
        """)
        accepted_photos = cursor.fetchall()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–∏–Ω—è—Ç—ã–µ –∑–∞—è–≤–∫–∏
    if not accepted_photos:
        await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∏–Ω—è—Ç—ã—Ö —á–µ–∫–æ–≤ –Ω–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ.")
        return

    # –ò–Ω—Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ —á–µ–∫–∞—Ö
    await update.message.reply_text("üì∏ –í–æ—Ç –≤–∞—à–∏ –ø—Ä–∏–Ω—è—Ç—ã–µ —á–µ–∫–∏:")

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ –ø—Ä–∏–Ω—è—Ç—ã–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
    for photo, booking_id, first_name, last_name, username, created_at in accepted_photos:
        month = datetime.strptime(created_at, "%Y-%m-%d %H:%M:%S").month  # –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä –º–µ—Å—è—Ü–∞
        month_name = month_names[month]  # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞

        formatted_date = datetime.strptime(created_at, "%Y-%m-%d %H:%M:%S").strftime('%d.%m.%Y')  # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–º–∞–π–ª–∏–∫ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è
        caption = (f"{month_name}\n"  # –ú–µ—Å—è—Ü
                   f"üö® –ü–†–û–î–õ–ï–ù–ò–ï –ê–†–ï–ù–î–´ üö®\n"  # –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏ —Å —Å–º–∞–π–ª–∏–∫–∞–º–∏
                   f"{last_name} {first_name} @{username}\n"  # –§–∞–º–∏–ª–∏—è, –∏–º—è –∏ username
                   f"–î–∞—Ç–∞: {formatted_date}")  # –î–∞—Ç–∞

        await context.bot.send_photo(chat_id=user_id, photo=photo, caption=caption)

from collections import defaultdict

# –°–ª–æ–≤–∞—Ä—å –∫–æ–º–∞–Ω–¥ —Å –∏—Ö —Å–∏–Ω–æ–Ω–∏–º–∞–º–∏
from collections import defaultdict

# –°–ª–æ–≤–∞—Ä—å –∫–æ–º–∞–Ω–¥ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —Å–∏–Ω–æ–Ω–∏–º–æ–≤ –∏ –∫—Ä–∞—Ç–∫–∏–º–∏ —Ñ–æ—Ä–º–∞–º–∏
commands = defaultdict(list, {
    "—á–µ–∫–∏": ["—á–µ–∫–∏", "—á–µ–∫", "—á–µ–∫—ã", "—á–µ–∫–æ–≤", "—á–µ–∫–æ–≤—ã–π"],
    "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏": ["–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å", "–ø–æ–ª—å–∑", "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", "–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"],
    "–≤–µ–ª–æ—Å–∏–ø–µ–¥—ã": ["–≤–µ–ª–æ—Å–∏–ø–µ–¥—ã", "–≤–µ–ª", "–≤–µ–ª–∏–∫–∏", "–≤–µ–ª–æ—Å–∏–ø–µ–¥—ã", "–≤–µ–ª–∏–∫–∏–µ"],
    "–∑–∞—è–≤–∫–∏ –Ω–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ": ["–∑–∞—è–≤–∫–∏ –Ω–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ", "–ø—Ä–æ–¥–ª–µ–Ω–∏–µ", "–∑–∞—è–≤–∫–∞ –Ω–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ", "–∑–∞—è–≤–ª–µ–Ω–∏–µ –Ω–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ"],
    "—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è": ["—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è", "–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è", "—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç–æ—Ä"],
    "–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç": ["–ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç", "–∫–∞–±–∏–Ω–µ—Ç", "–ª–∏—á–Ω—ã–π"],
    "—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–º": ["—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–º", "—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ–ª–æ–º", "–≤–µ–ª—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", "—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–º"],
    "–æ—Ç–º–µ—Ç–∏—Ç—å—Å—è –Ω–∞ —Ä–∞–±–æ—Ç–µ": ["–æ—Ç–º–µ—Ç–∏—Ç—å—Å—è –Ω–∞ —Ä–∞–±–æ—Ç–µ", "–æ—Ç–º–µ—Ç–∏—Ç—å—Å—è", "–ø—Ä–∏–π—Ç–∏ –Ω–∞ —Ä–∞–±–æ—Ç—É"],
    "–¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—á–∞—Å—Ç—å": ["–¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—á–∞—Å—Ç—å", "–¥–æ–±–∞–≤—å –∑–∞–ø—á–∞—Å—Ç—å", "–¥–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å", "–≤—Å—Ç–∞–≤–∏—Ç—å –∑–∞–ø—á–∞—Å—Ç—å"],
    "—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—á–∞—Å—Ç–∏": ["—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—á–∞—Å—Ç–∏", "—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", "–∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—á–∞—Å—Ç–∏"],
    "—Å–ø–∏—Å–æ–∫ –∑–∞–ø—á–∞—Å—Ç–µ–π": ["—Å–ø–∏—Å–æ–∫ –∑–∞–ø—á–∞—Å—Ç–µ–π", "–∑–∞–ø—á–∞—Å—Ç–∏", "–∑–∞–ø—á–∞—Å—Ç—å", "–ø–µ—Ä–µ—á–µ–Ω—å –∑–∞–ø—á–∞—Å—Ç–µ–π"],
    "–≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é": ["–≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "–≤–µ—Ä–Ω—É—Ç—å—Å—è", "–Ω–∞–∑–∞–¥"],
    "–ø–æ–¥–¥–µ—Ä–∂–∫–∞": ["–ø–æ–¥–¥–µ—Ä–∂–∫–∞", "—Å–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏", "–ø–æ–º–æ—â—å"],
    "–≤–æ–ø—Ä–æ—Å—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π": ["–≤–æ–ø—Ä–æ—Å—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", "–≤–æ–ø—Ä–æ—Å—ã", "–≤–æ–ø—Ä–æ—Å", "–≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"],
    "—Å—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è": ["—Å—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è", "—Å—Ç–∞—Ç—É—Å", "–∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å", "–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"],
    "–æ–∂–∏–¥–∞—é—â–∏–µ –±—Ä–æ–Ω—å": ["–æ–∂–∏–¥–∞—é—â–∏–µ –±—Ä–æ–Ω—å", "–æ–∂–∏–¥–∞—é—â–∏–µ", "–æ–∂–∏–¥–∞–Ω–∏—è"],
    "–∏—Å—Ç–æ—Ä–∏—è –æ—Ç–º–µ—Ç–æ–∫": ["–∏—Å—Ç–æ—Ä–∏—è –æ—Ç–º–µ—Ç–æ–∫", "–∏—Å—Ç–æ—Ä–∏—è", "–æ—Ç–º–µ—Ç–∫–∏"],
    "–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏": ["–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", "–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ", "—É—á–µ—Ç"],
    "–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π": ["–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", "–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è", "–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ", "–≤–µ—Ä"],
    "–∏—Å—Ç–æ—Ä–∏—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞": ["–∏—Å—Ç–æ—Ä–∏—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞", "–∏—Å—Ç–æ—Ä–∏—è –≤–µ–ª–∏–∫–∞", "–≤–µ–ª –∏—Å—Ç–æ—Ä–∏—è"],
    "–∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å": ["–∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å", "–∑–∞–≤–µ—Ä—à–∏—Ç—å", "–∑–∞–∫–æ–Ω—á–∏—Ç—å –¥–µ–Ω—å", "–∫–æ–Ω—á–∏—Ç—å —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å"],
    "—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥–∞–º–∏": ["—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥–∞–º–∏", "–∞—Ä–µ–Ω–¥–∞", "—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"],
    "–ø—Ä–æ–¥–ª–∏—Ç—å –∞—Ä–µ–Ω–¥—É": ["–ø—Ä–æ–¥–ª–∏—Ç—å –∞—Ä–µ–Ω–¥—É", "–ø—Ä–æ–¥–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã", "–ø—Ä–æ–¥–ª–∏—Ç—å"],
    "–ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è": ["–ø–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è", "—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è", "–ø–æ–∫–∞–∑–∞—Ç—å –∏–∑–≤–µ—â–µ–Ω–∏—è", "—É–≤–µ–¥—ã"],
})

# –ö–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
def execute_command(user_input):
    for command, synonyms in commands.items():
        if user_input in synonyms:
            return command  # –í–µ—Ä–Ω—É—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∫–æ–º–∞–Ω–¥—É
    return None  # –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

import sqlite3
from telegram import Update
from telegram.ext import ContextTypes



def generate_next_three_days():
    today = datetime.now()
    return [(today + timedelta(days=i)).strftime('%Y-%m-%d') for i in range(3)]

async def pre_checkout_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.pre_checkout_query
    await query.answer(ok=True)


import logging
import sqlite3
from datetime import datetime, timedelta
from telegram import Update
from telegram.ext import ContextTypes

#

VIRTUAL_BIKE_ID = 999





async def handle_payment(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –†–ï–ê–õ–¨–ù–´–ô —É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂ –æ—Ç –ÆKassa.
    """
    payment = update.message.successful_payment
    user_id = update.message.from_user.id
    payload = payment.invoice_payload
    amount_rub = payment.total_amount // 100

    await process_successful_payment(update, context, user_id, payload, amount_rub)
from datetime import datetime

import sqlite3
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import CallbackContext

async def handle_admin_view_queue(update: Update, context: CallbackContext, page=None) -> None:
    per_page = 10  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö query –∏ chat_id
    query = None
    chat_id = None

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ callback_query
    if update.callback_query:
        query = update.callback_query
        await query.answer()
        chat_id = query.message.chat_id
    else:
        chat_id = update.message.chat_id

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if page is None:
        if query and query.data.startswith('wowwow_page_'):
            page = int(query.data.split('_')[-1])
        else:
            page = 1
    else:
        # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ –±—É–¥–µ—Ç –ø–æ–∑–∂–µ)
        pass

    conn = None
    try:
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()

        # –ü–æ–ª—É—á–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
        cursor.execute("SELECT COUNT(*) FROM queue")
        total = cursor.fetchone()[0]
        total_pages = (total + per_page - 1) // per_page
        page = max(1, min(page, total_pages))

        # –ü–æ–ª—É—á–∞–µ–º –∑–∞–ø–∏—Å–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        cursor.execute("""
            SELECT q.id, q.user_id, q.created_at, q.status, u.first_name, u.last_name, u.username
            FROM queue q
            JOIN users u ON q.user_id = u.id
            ORDER BY q.created_at
            LIMIT ? OFFSET ?
        """, (per_page, (page - 1) * per_page))
        queue = cursor.fetchall()

        if queue:
            queue_text = f"üë• –û—á–µ—Ä–µ–¥—å (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä) - –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page}/{total_pages}:\n"
            keyboard = []
            for idx, row in enumerate(queue, start=1):
                queue_id, user_id, created_at, status, first_name, last_name, username = row
                # –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
                try:
                    created_at_dt = datetime.strptime(created_at, "%Y-%m-%d %H:%M:%S")
                except (ValueError, TypeError):
                    created_at_dt = datetime.now()
                time_in_queue = datetime.now() - created_at_dt
                hours, remainder = divmod(time_in_queue.seconds, 3600)
                minutes, _ = divmod(remainder, 60)
                time_str = f"{hours} —á {minutes} –º–∏–Ω" if hours > 0 else f"{minutes} –º–∏–Ω"
                user_info = f"{last_name} {first_name}"
                if username:
                    user_info += f" (@{username})"
                user_info += f" (–≤ –æ—á–µ—Ä–µ–¥–∏ {time_str})"
                # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
                button_text = f"üóëÔ∏è –£–¥–∞–ª–∏—Ç—å {last_name} {first_name}"
                if status == 'first_user':
                    queue_text += f"ü•á {idx}. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_info}\n"
                    button_text += f" (ü•á –º–µ—Å—Ç–æ {idx})"
                else:
                    queue_text += f"{idx}. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_info}\n"
                    button_text += f" (–º–µ—Å—Ç–æ {idx})"
                callback_data = f"wowwow_remove_{queue_id}_{page}"
                keyboard.append([InlineKeyboardButton(button_text, callback_data=callback_data)])

            # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
            pagination_buttons = []
            if page > 1:
                pagination_buttons.append(
                    InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"wowwow_page_{page - 1}")
                )
            if page < total_pages:
                pagination_buttons.append(
                    InlineKeyboardButton("–í–ø–µ—Ä–µ–¥ ‚û°Ô∏è", callback_data=f"wowwow_page_{page + 1}")
                )
            if pagination_buttons:
                keyboard.append(pagination_buttons)

            reply_markup = InlineKeyboardMarkup(keyboard)
            if query:
                await query.edit_message_text(queue_text, reply_markup=reply_markup)
            else:
                await context.bot.send_message(chat_id, queue_text, reply_markup=reply_markup)
        else:
            message = "üë• –û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞."
            if query:
                await query.edit_message_text(message)
            else:
                await context.bot.send_message(chat_id, message)

    except sqlite3.Error as e:
        error_message = "üö´ –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö."
        if query:
            await query.edit_message_text(error_message)
        else:
            await context.bot.send_message(chat_id, error_message)
        print(f"Database error: {e}")
    finally:
        if conn:
            conn.close()

async def handle_admin_remove_user(update: Update, context: CallbackContext) -> None:
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ callback_query
    if not update.callback_query:
        await context.bot.send_message(
            chat_id=update.effective_chat.id,
            text="üö´ –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏."
        )
        return

    query = update.callback_query
    await query.answer()

    conn = None  # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é conn
    try:
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ callback_query
        data = query.data.split('_')
        if len(data) < 3:
            raise ValueError("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç callback_data")

        queue_id = int(data[2])
        current_page = int(data[3]) if len(data) > 3 else 1

        # –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()

        # –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        cursor.execute("SELECT user_id, status FROM queue WHERE id=?", (queue_id,))
        queue_info = cursor.fetchone()
        if not queue_info:
            await query.edit_message_text("üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
            return

        user_id, status = queue_info
        cursor.execute("DELETE FROM queue WHERE id=?", (queue_id,))

        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        cursor.execute("SELECT id, user_id, status FROM queue ORDER BY created_at ASC")
        queue = cursor.fetchall()
        if queue:
            first_user_id = queue[0][1]
            first_user_status = queue[0][2]
            if first_user_status == 'pending':
                cursor.execute("UPDATE queue SET status='first_user' WHERE user_id=?", (first_user_id,))

        conn.commit()

        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        await handle_admin_view_queue(update, context, page=current_page)

    except ValueError as ve:
        await query.edit_message_text(f"üö´ –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö: {str(ve)}")
        print(f"ValueError: {ve}")
    except sqlite3.Error as dbe:
        await query.edit_message_text("üö´ –û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.")
        print(f"Database error: {dbe}")
    except Exception as e:
        await query.edit_message_text("üö´ –ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞.")
        print(f"Unexpected error: {e}")
    finally:
        if conn:
            conn.close()

import sqlite3
from datetime import datetime, timedelta
import pytz
from telegram import Update, ReplyKeyboardMarkup, ReplyKeyboardRemove, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes, ConversationHandler, CommandHandler, MessageHandler, CallbackQueryHandler, filters

# –û–±—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
common_problems = [
    "–°–ø—É—Å—Ç–∏–ª–æ –∫–æ–ª–µ—Å–æ.",
    "–ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç –∫–æ–ª–µ—Å–æ.",
    "–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ä—É–ª–µ–º.",
    "–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ç–æ—Ä–º–æ–∑–∞–º–∏.",
    "–î—Ä—É–≥–æ–µ..üòî"
]

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤
WAITING_FOR_PROBLEM, WAITING_FOR_CUSTOM_PROBLEM = range(1, 3)
WAITING_FOR_TIME, WAITING_FOR_PRICE = range(2)
CHOOSE_WARRANTY_TYPE, ENTER_DELAY_REASON = range(2)  # –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∏ –∑–∞–¥–µ—Ä–∂–∫–∏

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–∑–±–∏–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
def split_text(text, max_length=2000):
    return [text[i:i + max_length] for i in range(0, len(text), max_length)]






# –û–±—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
common_problems = [
    "–°–ø—É—Å—Ç–∏–ª–æ –∫–æ–ª–µ—Å–æ.",
    "–ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç –∫–æ–ª–µ—Å–æ.",
    "–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ä—É–ª–µ–º.",
    "–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ç–æ—Ä–º–æ–∑–∞–º–∏.",
    "–î—Ä—É–≥–æ–µ..üòî"
]

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤
WAITING_FOR_PROBLEM, WAITING_FOR_CUSTOM_PROBLEM = range(1, 3)
WAITING_FOR_TIME, WAITING_FOR_PRICE = range(2)
CHOOSE_WARRANTY_TYPE, ENTER_DELAY_REASON = range(2)  # –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∏ –∑–∞–¥–µ—Ä–∂–∫–∏

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–∑–±–∏–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
def split_text(text, max_length=2000):
    return [text[i:i + max_length] for i in range(0, len(text), max_length)]

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—á–∞–ª–∞ –¥–∏–∞–ª–æ–≥–∞




# --- –ù–û–í–ê–Ø, –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –î–õ–Ø –ó–ê–Ø–í–û–ö –ù–ê –†–ï–ú–û–ù–¢ ---

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –¥–∏–∞–ª–æ–≥–∞
WAITING_FOR_PROBLEM, WAITING_FOR_CUSTOM_PROBLEM = range(1, 3)


async def request_repair(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –®–∞–≥ 1: –ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–º–æ–Ω—Ç.
    """
    user_id = update.message.from_user.id

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–∫—Ç–∏–≤–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã
            cursor = await conn.execute("SELECT id, bike_id FROM bookings WHERE user_id=? AND status='rented' LIMIT 1", (user_id,))
            active_rental = await cursor.fetchone()

        if not active_rental:
            await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—Ä–µ–Ω–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–º–æ–Ω—Ç.")
            return ConversationHandler.END

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
        context.user_data['repair_bike_id'] = active_rental[1]

        keyboard = [
            [InlineKeyboardButton("–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ç–æ—Ä–º–æ–∑–∞–º–∏", callback_data="repair_–¢–æ—Ä–º–æ–∑–∞")],
            [InlineKeyboardButton("–°–ø—É—Å—Ç–∏–ª–æ/–ø—Ä–æ–±–∏–ª–æ –∫–æ–ª–µ—Å–æ", callback_data="repair_–ö–æ–ª–µ—Å–æ")],
            [InlineKeyboardButton("–ü—Ä–æ–±–ª–µ–º—ã —Å —Ä—É–ª–µ–º/—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º", callback_data="repair_–†—É–ª—å")],
            [InlineKeyboardButton("–î—Ä—É–≥–æ–µ (–æ–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–º)", callback_data="repair_–î—Ä—É–≥–æ–µ")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await update.message.reply_text(
            "üîß *–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–º–æ–Ω—Ç*\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–æ–±–ª–µ–º—ã –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ –∏–ª–∏ –æ–ø–∏—à–∏—Ç–µ –µ–µ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ, –Ω–∞–∂–∞–≤ '–î—Ä—É–≥–æ–µ'.",
            reply_markup=reply_markup,
            parse_mode="Markdown"
        )
        return WAITING_FOR_PROBLEM

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ request_repair: {e}", exc_info=True)
        await update.message.reply_text("üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
        return ConversationHandler.END


async def handle_problem_selection(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –®–∞–≥ 2: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–±–æ—Ä —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –ø—Ä–æ–±–ª–µ–º—ã –∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Ä—É—á–Ω–æ–º—É –≤–≤–æ–¥—É.
    """
    query = update.callback_query
    await query.answer()
    problem = query.data.split('_', 1)[1]

    if problem == "–î—Ä—É–≥–æ–µ":
        await query.message.edit_text(
            "‚úçÔ∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É —Å –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–º:"
        )
        return WAITING_FOR_CUSTOM_PROBLEM
    else:
        # –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞, —Å—Ä–∞–∑—É –≤—ã–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
        await finalize_repair_request(update, context, description=problem)
        return ConversationHandler.END


async def save_custom_problem(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –®–∞–≥ 2.1: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –≤—ã–∑—ã–≤–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é.
    """
    description = update.message.text
    await finalize_repair_request(update, context, description=description)
    return ConversationHandler.END


### –ù–û–í–ê–Ø –í–ï–†–°–ò–Ø —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π ###
async def finalize_repair_request(update: Update, context: ContextTypes.DEFAULT_TYPE, description: str):
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–º–æ–Ω—Ç,
    –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –±–µ–∑ –¥—É–±–ª–µ–π.
    """
    user_id = update.effective_user.id
    bike_id = context.user_data.get('repair_bike_id')
    user_data_copy = context.user_data.copy()

    message_sender = update.effective_message

    try:
        perm_tz = pytz.timezone('Asia/Yekaterinburg')
        current_time_str = datetime.now(perm_tz).strftime("%Y-%m-%d %H:%M:%S")

        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            await conn.execute('BEGIN')

            cursor = await conn.execute(
                "INSERT INTO repair_requests (user_id, bike_id, description, created_at, status) VALUES (?, ?, ?, ?, 'ozhidaet')",
                (user_id, bike_id, description, current_time_str)
            )
            request_id = cursor.lastrowid

            user_info_cursor = await conn.execute("SELECT first_name, last_name, username FROM users WHERE id=?", (user_id,))
            user_info = await user_info_cursor.fetchone()
            user_name_raw = f"{user_info['first_name']} {user_info['last_name'] or ''} (@{user_info['username'] or 'no_username'})" if user_info else f"ID {user_id}"

            bike_info_cursor = await conn.execute("SELECT name FROM bikes WHERE id=?", (bike_id,))
            bike_name = (await bike_info_cursor.fetchone() or ["–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≤–µ–ª–æ—Å–∏–ø–µ–¥"])['name']

            log_details = f"–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç –¥–ª—è '{bike_name}'. –ü—Ä–æ–±–ª–µ–º–∞: {description}"
            await log_bike_action(conn, bike_id, user_id, "–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç", log_details)

            await conn.commit()

        user_name_escaped = escape_markdown(user_name_raw, version=2)
        bike_name_escaped = escape_markdown(bike_name, version=2)
        description_escaped = escape_markdown(description, version=2)

        notification_message = (
            f"üõ†Ô∏è *–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç \\(ID: {request_id}\\)*\n\n"
            f"üë§ *–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:* {user_name_escaped}\n"
            f"üö≤ *–í–µ–ª–æ—Å–∏–ø–µ–¥:* {bike_name_escaped}\n"
            f"üìù *–ü—Ä–æ–±–ª–µ–º–∞:* {description_escaped}"
        )
        admin_keyboard = [[
            InlineKeyboardButton("‚úÖ –ü—Ä–∏–Ω—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É", callback_data=f"accept_repair_{request_id}"),
            InlineKeyboardButton("üóëÔ∏è –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"otmena_repair_{request_id}")
        ]]

        # <<< –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –±–µ–∑ –¥—É–±–ª–µ–π >>>
        all_recipients = set(ADMIN_IDS + MASTER_IDS)

        for recipient_id in all_recipients:
            try:
                await context.bot.send_message(
                    recipient_id,
                    notification_message,
                    parse_mode="MarkdownV2",
                    reply_markup=InlineKeyboardMarkup(admin_keyboard)
                )
            except Exception as e:
                logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–º–æ–Ω—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—é {recipient_id}: {e}")

        add_notification(f"–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç –æ—Ç {user_name_raw}")

        user_reply_text = (
            "‚úÖ *–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç –ø—Ä–∏–Ω—è—Ç–∞!*\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Å—Ç–∞–≤—å—Ç–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥ –ø–æ –∞–¥—Ä–µ—Å—É: ** —É–ª. –°–∞–ª—Ç—ã–∫–æ–≤—Å–∫–∞—è, –¥. 53**.\n\n"
            "–ö–∞–∫ —Ç–æ–ª—å–∫–æ –≤—ã –æ—Å—Ç–∞–≤–∏—Ç–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã —É–≤–µ–¥–æ–º–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞."
        )
        user_keyboard = [[InlineKeyboardButton("üö≤ –Ø –æ—Å—Ç–∞–≤–∏–ª(–∞) –≤–µ–ª–æ—Å–∏–ø–µ–¥ –Ω–∞ —Å–∫–ª–∞–¥–µ", callback_data=f"leave_bike_{request_id}")]]

        if isinstance(update, Update) and update.callback_query:
            await message_sender.edit_text(user_reply_text, reply_markup=InlineKeyboardMarkup(user_keyboard), parse_mode="Markdown")
        else:
            await message_sender.reply_text(user_reply_text, reply_markup=InlineKeyboardMarkup(user_keyboard), parse_mode="Markdown")

        await context.bot.send_sticker(chat_id=user_id, sticker="CAACAgIAAxkBAAELuUBni4NIbVWW023ZB_0uZ4-bcj-fDgAC9T8AAsWoIUriJJxWQR9CtzYE")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ finalize_repair_request: {e}", exc_info=True)
        await message_sender.reply_text("üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏.")
    finally:
        context.user_data.clear()


async def leave_bike(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ "–Ø –æ—Å—Ç–∞–≤–∏–ª(–∞) –≤–µ–ª–æ—Å–∏–ø–µ–¥ –Ω–∞ —Å–∫–ª–∞–¥–µ".
    """
    query = update.callback_query
    await query.answer()

    request_id = int(query.data.split("_")[2])
    user_id = query.from_user.id

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            cursor = await conn.execute("SELECT user_id, left_at FROM repair_requests WHERE id=?", (request_id,))
            result = await cursor.fetchone()

            if result and result['user_id'] == user_id and result['left_at'] is None:
                current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                await conn.execute("UPDATE repair_requests SET left_at=? WHERE id=?", (current_time, request_id))
                await conn.commit()

                left_date = datetime.strptime(current_time, "%Y-%m-%d %H:%M:%S").strftime("%d.%m.%Y")
                await query.edit_message_text(f"‚úÖ –í—ã –æ—Ç–º–µ—Ç–∏–ª–∏, —á—Ç–æ –æ—Å—Ç–∞–≤–∏–ª–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥ –Ω–∞ —Å–∫–ª–∞–¥–µ {left_date}.")

                # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
                cursor = await conn.execute("""
                    SELECT u.first_name, u.last_name, u.username, b.name
                    FROM repair_requests rr
                    JOIN users u ON rr.user_id = u.id
                    JOIN bikes b ON rr.bike_id = b.id
                    WHERE rr.id=?
                """, (request_id,))
                notify_data = await cursor.fetchone()
                user_name = f"{notify_data['first_name']} {notify_data['last_name'] or ''} (@{notify_data['username'] or 'no_username'})"

                notification_message = (
                    f"üöö *–í–µ–ª–æ—Å–∏–ø–µ–¥ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ —Å–∫–ª–∞–¥!*\n\n"
                    f"üë§ *–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:* {escape_markdown(user_name, 2)}\n"
                    f"üö≤ *–í–µ–ª–æ—Å–∏–ø–µ–¥:* {escape_markdown(notify_data['name'], 2)}\n"
                    f"üìå *ID –∑–∞—è–≤–∫–∏:* `{request_id}`"
                )
                for admin_id in ADMIN_IDS + MASTER_IDS:
                    await context.bot.send_message(admin_id, notification_message, parse_mode="MarkdownV2")

            elif result and result['left_at'] is not None:
                await query.answer("–í—ã —É–∂–µ –æ—Ç–º–µ—á–∞–ª–∏, —á—Ç–æ –æ—Å—Ç–∞–≤–∏–ª–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥.", show_alert=True)
            else:
                await query.answer("üö´ –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ.", show_alert=True)

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ leave_bike: {e}", exc_info=True)
        await query.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.", show_alert=True)

### –ù–û–í–ê–Ø –í–ï–†–°–ò–Ø –° –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ú –§–ò–õ–¨–¢–†–û–ú ###
async def view_completed_repairs(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ä–µ–º–æ–Ω—Ç–æ–≤, –æ–∂–∏–¥–∞—é—â–∏—Ö –æ–ø–ª–∞—Ç—ã."""
    user = update.effective_user
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
    if not (is_admin(user.id) or user.id in MASTER_IDS):
        await (update.message or update.callback_query.message).reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤.")
        return

    page = 0
    if update.callback_query and update.callback_query.data.startswith('paginate_completed_'):
        page = int(update.callback_query.data.split('_')[-1])

    # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î
    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row

            # <<< –ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ >>>
            # –ò—â–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –∑–∞—è–≤–∫–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö —Å—Ç–∞—Ç—É—Å 'completed'
            cursor = await conn.execute("""
                SELECT rr.id, u.first_name, u.last_name, u.username, b.name, rr.description,
                       rr.status, rr.created_at, rr.completed_at, rr.estimated_price, rr.is_warranty, rr.delay_reason
                FROM repair_requests rr
                JOIN users u ON rr.user_id = u.id
                JOIN bikes b ON rr.bike_id = b.id
                WHERE rr.status = 'completed'
                ORDER BY rr.created_at DESC
            """)
            all_requests = await cursor.fetchall()

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ä–µ–º–æ–Ω—Ç–æ–≤ –∏–∑ –ë–î: {e}", exc_info=True)
        await (update.message or update.callback_query.message).reply_text("üö´ –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.")
        return

    if not all_requests:
        await (update.message or update.callback_query.message).reply_text("üö´ –ù–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫, –æ–∂–∏–¥–∞—é—â–∏—Ö –æ–ø–ª–∞—Ç—ã.")
        return

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±—â–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
    await (update.message or update.callback_query.message).reply_text("üí≥ –ó–∞—è–≤–∫–∏, –æ–∂–∏–¥–∞—é—â–∏–µ –æ–ø–ª–∞—Ç—ã:")

    # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
    items_per_page = 5
    total_pages = (len(all_requests) + items_per_page - 1) // items_per_page
    start = page * items_per_page
    end = start + items_per_page
    current_requests = all_requests[start:end]

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∂–¥—É—é –∑–∞—è–≤–∫—É –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
    for request in current_requests:
        formatted_price = format_rubles(request['estimated_price']) if request['estimated_price'] else "0 —Ä—É–±–ª–µ–π (–≥–∞—Ä–∞–Ω—Ç–∏—è)"
        completed_date = datetime.strptime(request['completed_at'], "%Y-%m-%d %H:%M:%S").strftime("%d.%m.%Y %H:%M") if request['completed_at'] else "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"

        warranty_info = "üõ°Ô∏è –ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç" if request['is_warranty'] else "üí∞ –ù–µ –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç"
        delay_info = f"\n‚ö†Ô∏è –ü—Ä–∏—á–∏–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∏: {request['delay_reason']}" if request['delay_reason'] else ""

        message_text = (
            f"üìå *ID:* {request['id']}\n"
            f"üë§ *–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:* {request['first_name']} {request['last_name']} (@{request['username']})\n"
            f"üö≤ *–í–µ–ª–æ—Å–∏–ø–µ–¥:* {request['name']}\n"
            f"üìÖ *–ó–∞–≤–µ—Ä—à–µ–Ω–æ:* {completed_date}\n"
            f"üíµ *–°—É–º–º–∞:* {formatted_price}\n"
            f"{warranty_info}{delay_info}"
        )

        keyboard = [[InlineKeyboardButton(f"‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –æ–ø–ª–∞—á–µ–Ω–Ω–æ–π (ID: {request['id']})", callback_data=f"paid_{request['id']}")]]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await context.bot.send_message(
            chat_id=update.effective_chat.id,
            text=message_text,
            parse_mode="Markdown",
            reply_markup=reply_markup
        )

    # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    if total_pages > 1:
        pagination_buttons = []
        if page > 0:
            pagination_buttons.append(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"paginate_completed_{page-1}"))
        if page < total_pages - 1:
            pagination_buttons.append(InlineKeyboardButton("–í–ø–µ—Ä–µ–¥ ‚û°Ô∏è", callback_data=f"paginate_completed_{page+1}"))

        if pagination_buttons:
            pagination_markup = InlineKeyboardMarkup([pagination_buttons])
            await context.bot.send_message(
                chat_id=update.effective_chat.id,
                text=f"üìÉ –°—Ç—Ä–∞–Ω–∏—Ü–∞ {page + 1} –∏–∑ {total_pages}",
                reply_markup=pagination_markup
            )

async def view_accepted_repairs(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user = update.effective_user
    if not (is_admin(user.id) or user.id in MASTER_IDS):
        await (update.message or update.callback_query.message).reply_text("üö´ –ù–µ—Ç –ø—Ä–∞–≤.")
        return

    page = 0
    if update.callback_query and update.callback_query.data.startswith('paginate_accepted_'):
        page = int(update.callback_query.data.split('_')[-1])

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("""
        SELECT rr.id, u.first_name, u.last_name, b.name, rr.description,
               rr.status, rr.created_at, rr.estimated_time
        FROM repair_requests rr
        JOIN users u ON rr.user_id = u.id
        JOIN bikes b ON rr.bike_id = b.id
        WHERE rr.status='accepted'
        ORDER BY rr.created_at DESC
    """)
    all_requests = cursor.fetchall()
    conn.close()

    items_per_page = 5
    total_pages = (len(all_requests) + items_per_page - 1) // items_per_page
    start = page * items_per_page
    end = start + items_per_page
    current_requests = all_requests[start:end]

    if not current_requests:
        await (update.message or update.callback_query.message).reply_text("üö´ –ù–µ—Ç –∑–∞—è–≤–æ–∫ –≤ —Ä–∞–±–æ—Ç–µ.")
        return

    message_text = "üõ†Ô∏è –ó–∞—è–≤–∫–∏ –≤ —Ä–∞–±–æ—Ç–µ:\n\n"
    for request in current_requests:
        request_id, first_name, last_name, bike_name, description, status, created_at, estimated_time = request
        message_text += (
            f"üìå ID: {request_id}\n"
            f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {first_name} {last_name}\n"
            f"üö≤ –í–µ–ª–æ—Å–∏–ø–µ–¥: {bike_name}\n"
            f"üìù –û–ø–∏—Å–∞–Ω–∏–µ: {description}\n\n"
        )

    keyboard = [
        [InlineKeyboardButton(f"‚úÖ –ì–æ—Ç–æ–≤–æ (ID: {req[0]})", callback_data=f"complete_repair_{req[0]}")]
        for req in current_requests
    ]

    pagination_buttons = []
    if page > 0:
        pagination_buttons.append(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data=f"paginate_accepted_{page-1}"))
    if page < total_pages - 1:
        pagination_buttons.append(InlineKeyboardButton("–í–ø–µ—Ä–µ–¥ ‚û°Ô∏è", callback_data=f"paginate_accepted_{page+1}"))
    if pagination_buttons:
        keyboard.append(pagination_buttons)

    reply_markup = InlineKeyboardMarkup(keyboard)

    if update.callback_query:
        await update.callback_query.edit_message_text(message_text, reply_markup=reply_markup)
    else:
        await (update.message or update.callback_query.message).reply_text(message_text, reply_markup=reply_markup)

### –ù–û–í–ê–Ø –í–ï–†–°–ò–Ø view_repair_requests - –ü—Ä–∏–±–æ—Ä–Ω–∞—è –ø–∞–Ω–µ–ª—å —Ä–µ–º–æ–Ω—Ç–æ–≤ ###
### –ù–û–í–ê–Ø –í–ï–†–°–ò–Ø view_repair_requests - –ü—Ä–∏–±–æ—Ä–Ω–∞—è –ø–∞–Ω–µ–ª—å —Ä–µ–º–æ–Ω—Ç–æ–≤ ###
async def view_repair_requests(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user = update.effective_user
    if not (is_admin(user.id) or user.id in MASTER_IDS):
        message = update.message or update.callback_query.message
        await message.reply_text("üö´ –ù–µ—Ç –ø—Ä–∞–≤.")
        return

    message = update.message or update.callback_query.message

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row

            # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–∏–ª–∏ rr.description –≤ –∑–∞–ø—Ä–æ—Å >>>
            cursor = await conn.execute("""
                SELECT rr.id, rr.status, u.first_name, u.last_name, b.name as bike_name, rr.description
                FROM repair_requests rr
                JOIN users u ON rr.user_id = u.id
                JOIN bikes b ON rr.bike_id = b.id
                WHERE rr.status != 'oplacheno'
                ORDER BY CASE rr.status
                    WHEN 'ozhidaet' THEN 1
                    WHEN 'accepted' THEN 2
                    WHEN 'completed' THEN 3
                    ELSE 4
                END, rr.created_at DESC
            """)
            all_requests = await cursor.fetchall()

        if not all_requests:
            await message.reply_text("‚úÖ –í—Å–µ –∑–∞—è–≤–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã, –Ω–æ–≤—ã—Ö –Ω–µ—Ç.")
            return

        requests_by_status = {
            'ozhidaet': [],
            'accepted': [],
            'completed': []
        }
        for req in all_requests:
            if req['status'] in requests_by_status:
                requests_by_status[req['status']].append(req)

        message_parts = ["*üõ†Ô∏è –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–º–æ–Ω—Ç–∞–º–∏*\n"]
        keyboard = []

        # <<< –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ —Ç–µ–∫—Å—Ç >>>
        if requests_by_status['ozhidaet']:
            message_parts.append("\n*–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ (–æ–∂–∏–¥–∞—é—Ç –ø—Ä–∏–Ω—è—Ç–∏—è):*")
            for req in requests_by_status['ozhidaet']:
                message_parts.append(f"‚Ä¢ ID {req['id']}: {req['bike_name']} –æ—Ç {req['first_name']} `({req['description']})`")
                keyboard.append([
                    InlineKeyboardButton(f"üëÄ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞—è–≤–∫—É #{req['id']}", callback_data=f"view_repair_{req['id']}")
                ])

        if requests_by_status['accepted']:
            message_parts.append("\n*–í —Ä–∞–±–æ—Ç–µ:*")
            for req in requests_by_status['accepted']:
                message_parts.append(f"‚Ä¢ ID {req['id']}: {req['bike_name']} –æ—Ç {req['first_name']} `({req['description']})`")
                keyboard.append([
                    InlineKeyboardButton(f"‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–º–æ–Ω—Ç #{req['id']}", callback_data=f"complete_repair_{req['id']}")
                ])

        if requests_by_status['completed']:
            message_parts.append("\n*–û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã:*")
            for req in requests_by_status['completed']:
                message_parts.append(f"‚Ä¢ ID {req['id']}: {req['bike_name']} –æ—Ç {req['first_name']} `({req['description']})`")
                keyboard.append([
                    InlineKeyboardButton(f"üí∞ –û—Ç–º–µ—Ç–∏—Ç—å –æ–ø–ª–∞—á–µ–Ω–Ω–æ–π #{req['id']}", callback_data=f"paid_{req['id']}")
                ])

        final_message = "\n".join(message_parts)
        await message.reply_text(
            final_message,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode="Markdown"
        )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ view_repair_requests: {e}", exc_info=True)
        await message.reply_text("üö´ –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞—è–≤–æ–∫.")

# –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π –æ–¥–Ω–æ–π –∑–∞—è–≤–∫–∏
async def view_single_repair_request(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()

    request_id = int(query.data.split('_')[2])

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            cursor = await conn.execute("""
                SELECT rr.id, u.first_name, u.last_name, u.username, b.name, rr.description,
                       rr.status, rr.created_at, rr.left_at
                FROM repair_requests rr
                JOIN users u ON rr.user_id = u.id
                JOIN bikes b ON rr.bike_id = b.id
                WHERE rr.id=?
            """, (request_id,))
            request = await cursor.fetchone()

        if not request:
            await query.edit_message_text("üö´ –ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
            return

        created_date = datetime.strptime(request['created_at'], "%Y-%m-%d %H:%M:%S").strftime("%d.%m.%Y") if request['created_at'] else "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ"

        message_text = (
            f"üõ†Ô∏è *–ó–∞—è–≤–∫–∞ #{request['id']}*\n\n"
            f"üë§ *–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:* {request['first_name']} {request['last_name']} (@{request['username']})\n"
            f"üö≤ *–í–µ–ª–æ—Å–∏–ø–µ–¥:* {request['name']}\n"
            f"üìù *–û–ø–∏—Å–∞–Ω–∏–µ:* {request['description']}\n"
            f"üìä *–°—Ç–∞—Ç—É—Å:* {request['status']}\n"
            f"üìÖ *–î–∞—Ç–∞ –ø–æ–¥–∞—á–∏:* {created_date}"
        )

        keyboard = [[
            InlineKeyboardButton("‚úÖ –ü—Ä–∏–Ω—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É", callback_data=f"accept_repair_{request['id']}"),
            InlineKeyboardButton("üóëÔ∏è –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"otmena_repair_{request['id']}")
        ]]

        await query.edit_message_text(
            message_text,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode="Markdown"
        )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ view_single_repair_request: {e}", exc_info=True)
        await query.edit_message_text("üö´ –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞—è–≤–∫–∏.")



async def start_assignment_flow(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–ê–ì 0: –†–∞–∑–≤–∏–ª–∫–∞. –ó–∞–ø—É—Å–∫–∞–µ—Ç –≤–µ—Ç–∫—É –ê–†–ï–ù–î–´, –í–´–ö–£–ü–ê –∏–ª–∏ –ö–ê–°–¢–û–ú–ù–û–ô —Å–¥–µ–ª–∫–∏."""
    query = update.callback_query
    await query.answer()
    context.user_data.clear()

    booking_id = int(query.data.split('_')[1])
    context.user_data['processing_booking_id'] = booking_id
    logging.info(f"--- [–®–ê–ì 0] –í—Ö–æ–¥ –≤ start_assignment_flow. –ó–∞—è–≤–∫–∞ #{booking_id}")

    async with aiosqlite.connect(DB_FILE) as conn:
        cursor = await conn.execute("SELECT bike_id, booking_type FROM bookings WHERE id=?", (booking_id,))
        result = await cursor.fetchone()

    if not result:
        await query.message.edit_text("–û—à–∏–±–∫–∞: –∑–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
        return ConversationHandler.END

    bike_id_from_booking, booking_type = result
    context.user_data['booking_type'] = booking_type

    # –í–µ—Ç–∫–∞ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å–¥–µ–ª–∫–∏
    if bike_id_from_booking == VIRTUAL_BIKE_ID:
        logging.info(f"–ó–∞—è–≤–∫–∞ #{booking_id} - –ö–ê–°–¢–û–ú–ù–ê–Ø. –¢–∏–ø: {booking_type}.")
        await query.message.edit_text("‚úçÔ∏è –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Å–¥–µ–ª–∫–∞. –í–≤–µ–¥–∏—Ç–µ —Ä–µ–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–ø–ª–µ–∫—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–ú–æ–Ω—Å—Ç—Ä-–ì–∏–±—Ä–∏–¥ 12345 + 2 –ê–ö–ë 30Ah —Å –Ω–æ–º–µ—Ä–∞–º–∏ 312123 –∏ 312312'):")
        return AWAIT_CUSTOM_DESC

    # –í–µ—Ç–∫–∞ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –ê–†–ï–ù–î–´
    elif booking_type == 'rent':
        logging.info(f"–ó–∞—è–≤–∫–∞ #{booking_id} –Ω–∞ –ê–†–ï–ù–î–£. –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –Ω–æ–º–µ—Ä –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞.")
        await query.message.edit_text(f"‚û°Ô∏è –ó–∞—è–≤–∫–∞ –Ω–∞ –∞—Ä–µ–Ω–¥—É #{booking_id}.\n–í–≤–µ–¥–∏—Ç–µ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π –Ω–æ–º–µ—Ä –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 123321):")
        return AWAIT_BIKE_NUMBER_RENT

    # –í–µ—Ç–∫–∞ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –í–´–ö–£–ü–ê
    elif booking_type == 'buyout':
        logging.info(f"–ó–∞—è–≤–∫–∞ #{booking_id} –Ω–∞ –í–´–ö–£–ü. –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –Ω–æ–º–µ—Ä –¥–ª—è –ø—Ä–∏—Å–≤–æ–µ–Ω–∏—è.")
        await query.message.edit_text(f"‚û°Ô∏è –ó–∞—è–≤–∫–∞ –Ω–∞ –≤—ã–∫—É–ø #{booking_id}.\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø—Ä–∏—Å–≤–æ–µ–Ω —ç—Ç–æ–º—É –≤–µ–ª–æ—Å–∏–ø–µ–¥—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ ID –∫–ª–∏–µ–Ω—Ç–∞):")
        return AWAIT_BIKE_NUMBER_BUYOUT

    return ConversationHandler.END

# --- –§–£–ù–ö–¶–ò–ò –î–õ–Ø –í–ï–¢–ö–ò –°–¢–ê–ù–î–ê–†–¢–ù–û–ô –ê–†–ï–ù–î–´ ---
# <<< –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê >>>

async def repair_dashboard_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–æ–≤–æ–µ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–º–æ–Ω—Ç–∞–º–∏ —Å–æ —Å—á–µ—Ç—á–∏–∫–∞–º–∏ –∑–∞—è–≤–æ–∫.
    """
    try:
        # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫ –ø–æ –∫–∞–∂–¥–æ–º—É —Å—Ç–∞—Ç—É—Å—É
        async with aiosqlite.connect(DB_FILE) as conn:
            # –ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏
            new_cursor = await conn.execute("SELECT COUNT(*) FROM repair_requests WHERE status = 'ozhidaet'")
            new_count = (await new_cursor.fetchone())[0]
            # –í —Ä–∞–±–æ—Ç–µ
            accepted_cursor = await conn.execute("SELECT COUNT(*) FROM repair_requests WHERE status = 'accepted'")
            accepted_count = (await accepted_cursor.fetchone())[0]
            # –û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã
            completed_cursor = await conn.execute("SELECT COUNT(*) FROM repair_requests WHERE status = 'completed'")
            completed_count = (await completed_cursor.fetchone())[0]
            # –û–ø–ª–∞—á–µ–Ω–Ω—ã–µ
            paid_cursor = await conn.execute("SELECT COUNT(*) FROM repair_requests WHERE status = 'oplacheno'")
            paid_count = (await paid_cursor.fetchone())[0]

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å—á–µ—Ç–µ –∑–∞—è–≤–æ–∫ –Ω–∞ —Ä–µ–º–æ–Ω—Ç: {e}", exc_info=True)
        new_count, accepted_count, completed_count, paid_count = '?', '?', '?', '?'

    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å Reply –∫–Ω–æ–ø–∫–∞–º–∏
    keyboard = [
        [f"üÜï –ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ ({new_count})"],
        [f"üõ†Ô∏è –í —Ä–∞–±–æ—Ç–µ ({accepted_count})"],
        [f"üí≥ –û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã ({completed_count})"],
        [f"‚úÖ –û–ø–ª–∞—á–µ–Ω–Ω—ã–µ ({paid_count})"],
        ["üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

    await update.message.reply_text(
        "üõ†Ô∏è *–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–º–æ–Ω—Ç–∞–º–∏*\n\n–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:",
        reply_markup=reply_markup,
        parse_mode="Markdown"
    )

# <<< –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê >>>
async def get_bike_number_for_rent(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –®–∞–≥ 1: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–æ–º–µ—Ä –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
    –†–∞–∑–ª–∏—á–∞–µ—Ç, –¥–ª—è –∫–∞–∫–æ–π —Å–¥–µ–ª–∫–∏ (–∞—Ä–µ–Ω–¥–∞/–≤—ã–∫—É–ø) –≤–≤–æ–¥–∏—Ç—Å—è –Ω–æ–º–µ—Ä.
    """
    entered_number = update.message.text.strip()
    if not entered_number:
        await update.message.reply_text("‚ùå –ù–æ–º–µ—Ä –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.")
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ —Ç–æ –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —á—Ç–æ–±—ã –∂–¥–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤–≤–æ–¥–∞
        return AWAIT_BIKE_NUMBER_RENT

    context.user_data['entered_physical_bike_number'] = entered_number
    booking_type = context.user_data.get('booking_type')

    # ### –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í–´–ó–û–í –†–ê–ó–ù–´–• –§–ò–ù–ê–õ–¨–ù–´–• –§–£–ù–ö–¶–ò–ô ###
    if booking_type == 'rent':
        # –ï—Å–ª–∏ —ç—Ç–æ –∞—Ä–µ–Ω–¥–∞, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞—Ç–∞—Ä–µ–π
        await update.message.reply_text("üîã –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞—Ç–∞—Ä–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2):")
        return AWAIT_BATTERY_COUNT
    elif booking_type == 'buyout':
        # –ï—Å–ª–∏ —ç—Ç–æ –≤—ã–∫—É–ø, —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é
        return await finalize_buyout_assignment(update, context)
    else:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞: –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–¥–µ–ª–∫–∏. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ.")
        return ConversationHandler.END

async def get_battery_count(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 2 (–ê—Ä–µ–Ω–¥–∞): –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–æ–ª-–≤–æ –ê–ö–ë, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–æ–º–µ—Ä–∞."""
    logging.info("--- [–ê–†–ï–ù–î–ê –®–∞–≥ 2] –ü—Ä–∏–Ω—è—Ç–æ –∫–æ–ª-–≤–æ –±–∞—Ç–∞—Ä–µ–π.")
    try:
        count = int(update.message.text.strip())
        if not (0 <= count <= 5): raise ValueError
        context.user_data['battery_count'] = count
    except ValueError:
        await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 5.")
        return AWAIT_BATTERY_COUNT

    if count == 0:
        update.message.text = ""
        return await finalize_rent_assignment(update, context)

    await update.message.reply_text(f"‚úçÔ∏è –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è {count} –±–∞—Ç–∞—Ä–µ–π, –∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏.")
    return AWAIT_BATTERY_NUMS

# main.py

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã —É –≤–∞—Å –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
import aiosqlite
import json
import os
from datetime import datetime
import asyncio
import random

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£
# main.py

# ... (–≤—Å–µ –≤–∞—à–∏ –∏–º–ø–æ—Ä—Ç—ã) ...

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –ò–°–ü–†–ê–í–õ–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã —É –≤–∞—Å –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
import aiosqlite
import json
import os
from datetime import datetime
import asyncio
import random
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton, LabeledPrice
from telegram.ext import ContextTypes, ConversationHandler

# ... (–∑–¥–µ—Å—å –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∞—à–∏ –¥—Ä—É–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏, –≤–∫–ª—é—á–∞—è generate_contract_docx, create_yookassa_payment –∏ —Ç.–¥.)


# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã —É –≤–∞—Å –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
import aiosqlite
import json
import os
from datetime import datetime
import asyncio
import random
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton, LabeledPrice
from telegram.ext import ContextTypes, ConversationHandler

# ... (–∑–¥–µ—Å—å –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∞—à–∏ –¥—Ä—É–≥–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏, –≤–∫–ª—é—á–∞—è generate_contract_docx, create_yookassa_payment –∏ —Ç.–¥.)


async def finalize_assignment(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –§–ò–ù–ê–õ (–ö–∞—Å—Ç–æ–º): –°–æ–∑–¥–∞–µ—Ç —Å–¥–µ–ª–∫—É, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–æ–≥–æ–≤–æ—Ä, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
    —É—Å–ª–æ–≤–∏—è –∏ —Å—á–µ—Ç, –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Å–¥–µ–ª–∫—É.
    """
    query = update.callback_query
    await query.answer()

    await query.edit_message_text("‚è≥ –°–æ–∑–¥–∞—é —Å–¥–µ–ª–∫—É, –≥–µ–Ω–µ—Ä–∏—Ä—É—é –¥–æ–≥–æ–≤–æ—Ä –∏ –≤—ã—Å—Ç–∞–≤–ª—è—é —Å—á–µ—Ç... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.")
    logging.info("--- [–ö–ê–°–¢–û–ú –§–ò–ù–ê–õ] –í—Ö–æ–¥ –≤ finalize_assignment ---")

    deal_data = context.user_data
    booking_id = deal_data.get('processing_booking_id')
    admin_chat_id = query.message.chat_id

    try:
        # 1. –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            cursor = await conn.execute(
                "SELECT b.user_id, u.phone_number, u.passport_data, u.first_name, u.last_name, b.booking_type, b.end_date, b.booking_date "
                "FROM bookings b JOIN users u ON b.user_id = u.id WHERE b.id=?",
                (booking_id,)
            )
            user_db_data = await cursor.fetchone()

        if not user_db_data: raise ValueError(f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ –∑–∞—è–≤–∫–µ #{booking_id}")
        if not user_db_data['phone_number']: raise ValueError(f"–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID {user_db_data['user_id']} –Ω–µ —É–∫–∞–∑–∞–Ω –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.")

        user_id = user_db_data['user_id']
        price_to_pay = deal_data.get('assign_price', 0.0)
        full_description = deal_data.get('assign_full_desc', '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Ç')
        booking_type = deal_data.get('booking_type')
        parsed_data = deal_data.get('parsed_deal_data', {})

        # 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–ª–æ–≤–∞—Ä–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –¥–æ–≥–æ–≤–æ—Ä–∞
        passport_data = json.loads(user_db_data['passport_data']) if user_db_data['passport_data'] else {}
        user_data_for_doc = {
            'full_name': f"{passport_data.get('–§–∞–º–∏–ª–∏—è', '')} {passport_data.get('–ò–º—è', '')} {passport_data.get('–û—Ç—á–µ—Å—Ç–≤–æ', '')}".strip(),
            'ending': '—ã–π' if passport_data.get('–ü–æ–ª', '').upper().startswith('–ú–£–ñ') else '–∞—è',
            'passport_series': passport_data.get('–°–µ—Ä–∏—è –∏ –Ω–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞', '____ ______').split(' ')[0],
            'passport_number': passport_data.get('–°–µ—Ä–∏—è –∏ –Ω–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞', '____ ______').split(' ')[-1],
            'passport_issued_by': passport_data.get('–ö–µ–º –≤—ã–¥–∞–Ω', '_________________'),
            'address': passport_data.get('–ê–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', '_________________'),
            'initials': f"{passport_data.get('–§–∞–º–∏–ª–∏—è', ' ')} {passport_data.get('–ò–º—è', ' ')[0]}.{passport_data.get('–û—Ç—á–µ—Å—Ç–≤–æ', ' ')[0]}."
        }
        
        bike_data_for_doc = {
            'model': parsed_data.get('model_name', "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Ç"),
            'vin': parsed_data.get('bike_number', "–±/–Ω"),
            'batteries_count': str(len(parsed_data.get('batteries', [])))
        }

        deal_info_for_doc = {}
        plan_key_to_save = None
        user_notification_details = ""

        if booking_type == 'rent':
            deal_info_for_doc = {'price': int(price_to_pay)}
            start_date_obj = datetime.strptime(user_db_data['booking_date'], '%d.%m.%Y')
            end_date_obj = datetime.strptime(user_db_data['end_date'], '%d.%m.%Y')
            duration_days = (end_date_obj - start_date_obj).days
            user_notification_details = f"–ê—Ä–µ–Ω–¥–∞ –Ω–∞ {duration_days} –¥–Ω–µ–π"
        
        elif booking_type == 'buyout':
            plan_key_to_save = deal_data['selected_plan_key']
            plan_info = deal_data['generated_plans'][plan_key_to_save]
            deal_info_for_doc = {
                'total_price': int(plan_info['total_payments'] * plan_info['first_payment']),
                'weekly_payment': int(plan_info['first_payment']),
                'weeks_count': int(plan_info['total_payments']),
                'battery_ah': parsed_data.get('batteries', [{}])[0].get('capacity', '?? Ah'),
                'battery_count': len(parsed_data.get('batteries', []))
            }
            user_notification_details = f"–í—ã–∫—É–ø –ø–æ –ø–ª–∞–Ω—É: {plan_info['full_label']}"

        # 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞
        file_path = generate_contract_docx(
            booking_id=booking_id,
            deal_type=booking_type,
            deal_data=deal_info_for_doc,
            user_data=user_data_for_doc,
            bike_data=bike_data_for_doc
        )
        with open(file_path, 'rb') as doc_file:
            await context.bot.send_document(admin_chat_id, doc_file, caption=f"‚úÖ –î–æ–≥–æ–≤–æ—Ä –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å–¥–µ–ª–∫–∏ #{booking_id}")
        os.remove(file_path)

        # 4. –°–æ–∑–¥–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å—á–µ—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É
        invoice_title = f"–û–ø–ª–∞—Ç–∞: {full_description[:50]}"
        payload = f"custom_payment_{booking_id}"
        metadata = {'internal_payload': payload, 'user_id': user_id}
        items_for_receipt = [{"description": invoice_title, "quantity": "1.00", "amount": {"value": f"{price_to_pay:.2f}", "currency": "RUB"}, "vat_code": "1", "payment_subject": "service"}]
        payment_info = await create_yookassa_payment(amount=price_to_pay, description=invoice_title, metadata=metadata, items=items_for_receipt, customer_info={"phone": user_db_data['phone_number']}, payment_method='sbp')
        if not payment_info: raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É.")

        payment_url, payment_id, final_amount = payment_info['url'], payment_info['id'], payment_info['final_amount']

        user_approval_message = (
            f"‚úÖ –í–∞—à–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Å–¥–µ–ª–∫–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞!\n\n"
            f"**–°–æ—Å—Ç–∞–≤:** `{full_description}`\n"
            f"**–£—Å–ª–æ–≤–∏—è:** `{user_notification_details}`\n\n"
            "–ì–æ—Ç–æ–≤–∏–º —Å—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É..."
        )
        await context.bot.send_message(user_id, user_approval_message, parse_mode="Markdown")

        user_invoice_message = f"–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã {final_amount:.2f} ‚ÇΩ"
        keyboard = [[InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å", url=payment_url)]]
        animated_message = await context.bot.send_message(user_id, user_invoice_message, reply_markup=InlineKeyboardMarkup(keyboard))

        if 'pending_payments' not in context.bot_data: context.bot_data['pending_payments'] = {}
        stop_event = asyncio.Event()
        context.bot_data['pending_payments'][payment_id] = {'user_id': user_id, 'start_time': datetime.now(), 'payload': payload, 'amount': final_amount, 'animated_message_id': animated_message.message_id, 'url': payment_url, 'animation_sequence': random.choice(PAYMENT_ANIMATIONS), 'stop_animation_event': stop_event}
        asyncio.create_task(animate_payment_message(context, payment_id))
        context.job_queue.run_repeating(callback=check_payment_status, interval=15, first=10, name=f"payment_{payment_id}", data={'yookassa_id': payment_id})

        # 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î
        async with aiosqlite.connect(DB_FILE) as conn:
            cursor = await conn.execute("INSERT INTO bikes (name, description, available, type) VALUES (?, ?, 0, ?)", (full_description, "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Å–¥–µ–ª–∫–∞", booking_type))
            assigned_bike_id = cursor.lastrowid
            await conn.execute("UPDATE bookings SET bike_id = ?, payment_plan_key = ? WHERE id = ?", (assigned_bike_id, plan_key_to_save, booking_id))
            await conn.commit()

        await query.message.edit_text(f"‚úÖ –£—Å–ø–µ—à–Ω–æ! –ö–∞—Å—Ç–æ–º–Ω–∞—è —Å–¥–µ–ª–∫–∞ #{booking_id} —Å–æ–∑–¥–∞–Ω–∞, —Å—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.")

    except Exception as e:
        logger.error(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ finalize_assignment: {e}", exc_info=True)
        await query.message.edit_text(f"‚ùå –û–®–ò–ë–ö–ê: {e}.\n–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")

    context.user_data.clear()
    return ConversationHandler.END


# --- –§–£–ù–ö–¶–ò–ò –î–õ–Ø –í–ï–¢–ö–ò –°–¢–ê–ù–î–ê–†–¢–ù–û–ì–û –í–´–ö–£–ü–ê ---

# main.py

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
async def finalize_buyout_assignment(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –®–∞–≥ 1 (–í—ã–∫—É–ø): –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–æ–º–µ—Ä –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –∏ –ü–ï–†–ï–ù–ê–ü–†–ê–í–õ–Ø–ï–¢ –Ω–∞ —à–∞–≥ –∑–∞–ø—Ä–æ—Å–∞ –ê–ö–ë.
    """
    logging.info("--- [–í–´–ö–£–ü –®–∞–≥ 1] –ü—Ä–∏–Ω—è—Ç –Ω–æ–º–µ—Ä –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞. –ü–µ—Ä–µ—Ö–æ–∂—É –∫ –∑–∞–ø—Ä–æ—Å—É –ê–ö–ë.")

    physical_number = update.message.text.strip()
    if not physical_number:
        await update.message.reply_text("‚ùå –ù–æ–º–µ—Ä –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.")
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ —Ç–æ –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —á—Ç–æ–±—ã –∂–¥–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤–≤–æ–¥–∞
        return AWAIT_BIKE_NUMBER_BUYOUT

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–≤–µ–¥–µ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    context.user_data['entered_physical_bike_number'] = physical_number

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ—Ç –∂–µ –≤–æ–ø—Ä–æ—Å, —á—Ç–æ –∏ –¥–ª—è –∞—Ä–µ–Ω–¥—ã
    await update.message.reply_text("üîã –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞—Ç–∞—Ä–µ–π, –∏–¥—É—â–∏—Ö –≤ –∫–æ–º–ø–ª–µ–∫—Ç–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2):")

    # >>> –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï <<<
    # –í–º–µ—Å—Ç–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è, –º—ã –ø–µ—Ä–µ–≤–æ–¥–∏–º –¥–∏–∞–ª–æ–≥ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ AWAIT_BATTERY_COUNT,
    # –∫–æ—Ç–æ—Ä–æ–µ —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π get_battery_count.
    return AWAIT_BATTERY_COUNT


# --- –§–£–ù–ö–¶–ò–ò –î–õ–Ø –í–ï–¢–ö–ò –ö–ê–°–¢–û–ú–ù–û–ô –°–î–ï–õ–ö–ò ---

# main.py

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é
from passport_recognition_gemini import parse_custom_deal_with_gemini

# main.py

# –£–±–µ–¥–∏—Å—å, —á—Ç–æ —ç—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞
from passport_recognition_gemini import parse_custom_deal_with_gemini

async def get_custom_description(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –®–∞–≥ 1 (–ö–∞—Å—Ç–æ–º): –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ, –ø–∞—Ä—Å–∏—Ç –µ–≥–æ —Å –ø–æ–º–æ—â—å—é Gemini –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.
    """
    description = update.message.text.strip()

    # –°—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ, –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ
    context.user_data['assign_full_desc'] = description

    thinking_message = await update.message.reply_text("üß† –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–ø–ª–µ–∫—Ç–∞...")

    # –í—ã–∑—ã–≤–∞–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é Gemini –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
    parsed_data = parse_custom_deal_with_gemini(description)

    if not parsed_data:
        await thinking_message.edit_text("üòî –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑, –æ–ø–∏—Å–∞–≤ –∫–æ–º–ø–ª–µ–∫—Ç –±–æ–ª–µ–µ —á–µ—Ç–∫–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–ú–æ–Ω—Å—Ç—Ä 54321 + 2 –ê–ö–ë 30Ah 123, 456').")
        return AWAIT_CUSTOM_DESC # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è, —á—Ç–æ–±—ã –∞–¥–º–∏–Ω –ø–æ–ø—Ä–æ–±–æ–≤–∞–ª —Å–Ω–æ–≤–∞

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–µ —á–∞—Å—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    context.user_data['parsed_deal_data'] = parsed_data

    booking_type = context.user_data.get('booking_type')

    # –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Å–¥–µ–ª–∫–∏, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
    if booking_type == 'rent':
        await thinking_message.edit_text("–í–≤–µ–¥–∏—Ç–µ –∏—Ç–æ–≥–æ–≤—É—é –¶–ï–ù–£ –ê–†–ï–ù–î–´ –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–º–ø–ª–µ–∫—Ç–∞:")
        return AWAIT_CUSTOM_RENT_PRICE
    elif booking_type == 'buyout':
        await thinking_message.edit_text("–û–ø–∏—à–∏—Ç–µ –∂–µ–ª–∞–µ–º—ã–π –ø–ª–∞–Ω —Ä–∞—Å—Å—Ä–æ—á–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '5 –º–µ—Å—è—Ü–µ–≤ –ø–æ 10–∫ —Ä–∞–∑ –≤ –¥–≤–µ –Ω–µ–¥–µ–ª–∏'):")
        return AWAIT_CUSTOM_BUYOUT_PLAN

    return ConversationHandler.END

# main.py

async def get_custom_rent_price(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ü–µ–Ω—É, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.
    """
    try:
        price = float(update.message.text.replace(',', '.'))
        context.user_data['assign_price'] = price
    except ValueError:
        await update.message.reply_text("üö´ –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ).")
        return AWAIT_CUSTOM_RENT_PRICE
    # –°—Ä–∞–∑—É –≤—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∫–∞–∂–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    return await show_custom_deal_confirmation(update.message, context)

async def process_custom_buyout_plan(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    plan_description = update.message.text.strip()
    deal_description = context.user_data['assign_full_desc']

    thinking_message = await update.message.reply_text("ü§ñ –ì–µ–Ω–µ—Ä–∏—Ä—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω —Å –ø–æ–º–æ—â—å—é AI... üß†")

    plans = get_buyout_plans_with_gemini(deal_description, plan_description)
    if not plans:
        await thinking_message.edit_text("üòî –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–ø–∏—Å–∞—Ç—å –µ–≥–æ –ø–æ-–¥—Ä—É–≥–æ–º—É.")
        return AWAIT_CUSTOM_BUYOUT_PLAN

    context.user_data['generated_plans'] = plans
    context.user_data['selected_plan_key'] = list(plans.keys())[0]
    return await show_custom_deal_confirmation(thinking_message, context)

### –ù–ê–ß–ê–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ô –§–£–ù–ö–¶–ò–ò ###

# main.py

# main.py

# main.py

# main.py
import aiosqlite # –£–±–µ–¥–∏—Å—å, —á—Ç–æ —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ

async def show_custom_deal_confirmation(message, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å–¥–µ–ª–∫–∏, —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞—è —Å—Ä–æ–∫ –∞—Ä–µ–Ω–¥—ã –∏–∑ –ë–î.
    """
    deal_data = context.user_data
    parsed_data = deal_data.get('parsed_deal_data', {})
    booking_id = deal_data.get('processing_booking_id')

    text_parts = ["*–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å–¥–µ–ª–∫–∏:*\n"]

    # –ë–ª–æ–∫ —Å –º–æ–¥–µ–ª—å—é –∏ –ê–ö–ë (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    text_parts.append(f"‚Ä¢ –ú–æ–¥–µ–ª—å: `{parsed_data.get('model_name', '–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ')}`")
    text_parts.append(f"‚Ä¢ –ù–æ–º–µ—Ä –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞: `{parsed_data.get('bike_number', '–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω')}`")
    batteries = parsed_data.get('batteries', [])
    if not batteries:
        text_parts.append("‚Ä¢ –ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä—ã: `–Ω–µ—Ç`")
    else:
        battery_lines = [f"{i+1}) –ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä {b.get('capacity', '??Ah')} (‚Ññ {b.get('number', '–±/–Ω')})" for i, b in enumerate(batteries)]
        text_parts.append(f"‚Ä¢ –ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä—ã:\n " + "\n ".join(battery_lines))

    text_parts.append("-" * 20)

    if deal_data.get('booking_type') == 'rent':
        # <<< –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—ã –∏–∑ –ë–î, —á—Ç–æ–±—ã —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ä–æ–∫
        duration_days_text = "?? –¥–Ω–µ–π"
        try:
            async with aiosqlite.connect(DB_FILE) as conn:
                cursor = await conn.execute("SELECT booking_date, end_date FROM bookings WHERE id = ?", (booking_id,))
                dates = await cursor.fetchone()

            if dates and dates[0] and dates[1]:
                start_date = datetime.strptime(dates[0], '%d.%m.%Y')
                end_date = datetime.strptime(dates[1], '%d.%m.%Y')
                duration_days = (end_date - start_date).days
                duration_days_text = f"{duration_days} –¥–Ω–µ–π"
            else:
                raise ValueError("–î–∞—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –∑–∞—è–≤–∫–µ")

        except Exception as e:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ä–æ–∫ –∞—Ä–µ–Ω–¥—ã –¥–ª—è –∑–∞—è–≤–∫–∏ #{booking_id}: {e}")

        text_parts.append("‚Ä¢ –¢–∏–ø: –ê—Ä–µ–Ω–¥–∞")
        text_parts.append(f"‚Ä¢ –°—Ä–æ–∫: {duration_days_text}")
        text_parts.append(f"‚Ä¢ –¶–µ–Ω–∞: {deal_data.get('assign_price', 0.0):.2f} —Ä—É–±.")
        # <<< –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>
    else: # –í—ã–∫—É–ø
        # (–±–ª–æ–∫ –≤—ã–∫—É–ø–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        plan_key = deal_data.get('selected_plan_key', 'plan_1')
        plan_info = deal_data.get('generated_plans', {}).get(plan_key, {})
        text_parts.append("‚Ä¢ –¢–∏–ø: –í—ã–∫—É–ø")
        text_parts.append(f"‚Ä¢ –ü–ª–∞–Ω: {plan_info.get('full_label', '–ù–µ —É–∫–∞–∑–∞–Ω')}")
        deal_data['assign_price'] = plan_info.get('first_payment', 0)

    # (–∫–Ω–æ–ø–∫–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    keyboard = [[
        InlineKeyboardButton("‚úÖ –î–∞, —Å–æ–∑–¥–∞—Ç—å –∏ –≤—ã—Å—Ç–∞–≤–∏—Ç—å —Å—á–µ—Ç", callback_data="assign_finalize"),
        InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_assignment")
    ]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    final_text = "\n".join(text_parts)

    if message.from_user.is_bot:
        await message.edit_text(final_text, reply_markup=reply_markup, parse_mode="Markdown")
    else:
        await message.reply_text(final_text, reply_markup=reply_markup, parse_mode="Markdown")

    return AWAIT_CUSTOM_CONFIRM

### –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ô –§–£–ù–ö–¶–ò–ò ###

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞
import aiosqlite
import json
import os
from datetime import datetime
import asyncio
import random
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton, LabeledPrice
from telegram.ext import ContextTypes, ConversationHandler

# ### –ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ö–ê–°–¢–û–ú–ù–´–• –°–î–ï–õ–û–ö ###
### –ù–ê–ß–ê–õ–û –ü–û–õ–ù–û–ô –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ô –§–£–ù–ö–¶–ò–ò ###

### –ù–ê–ß–ê–õ–û –ü–û–õ–ù–û–ô –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ô –§–£–ù–ö–¶–ò–ò ###

# main.py

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã —É –≤–∞—Å –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
import aiosqlite
import json
import os
from datetime import datetime
import asyncio
import random
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton, LabeledPrice
from telegram.ext import ContextTypes, ConversationHandler

# --- –ü–û–õ–ù–ê–Ø –§–ò–ù–ê–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ö–ê–°–¢–û–ú–ù–´–• –°–î–ï–õ–û–ö ---

# main.py

# main.py

# main.py

async def finalize_assignment(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –§–ò–ù–ê–õ (–ö–∞—Å—Ç–æ–º): –°–æ–∑–¥–∞–µ—Ç —Å–¥–µ–ª–∫—É, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–æ–≥–æ–≤–æ—Ä, –û–¢–ü–†–ê–í–õ–Ø–ï–¢ –ö–õ–ò–ï–ù–¢–£
    –°–ù–ê–ß–ê–õ–ê –£–°–õ–û–í–ò–Ø, –ê –ü–û–¢–û–ú –°–ß–ï–¢, –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Å–¥–µ–ª–∫—É.
    """
    query = update.callback_query
    await query.answer()

    await query.edit_message_text("‚è≥ –°–æ–∑–¥–∞—é —Å–¥–µ–ª–∫—É, –≥–µ–Ω–µ—Ä–∏—Ä—É—é –¥–æ–≥–æ–≤–æ—Ä –∏ –≤—ã—Å—Ç–∞–≤–ª—è—é —Å—á–µ—Ç... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.")
    logging.info("--- [–ö–ê–°–¢–û–ú –§–ò–ù–ê–õ] –í—Ö–æ–¥ –≤ finalize_assignment ---")

    deal_data = context.user_data
    booking_id = deal_data.get('processing_booking_id')
    admin_chat_id = query.message.chat_id

    try:
        # 1. –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            cursor = await conn.execute(
                "SELECT b.user_id, u.phone_number, u.passport_data, u.first_name, u.last_name, b.booking_type, b.end_date, b.booking_date "
                "FROM bookings b JOIN users u ON b.user_id = u.id WHERE b.id=?",
                (booking_id,)
            )
            user_db_data = await cursor.fetchone()

        if not user_db_data: raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Å–¥–µ–ª–∫–∏.")
        if not user_db_data['phone_number']: raise ValueError("–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —É–∫–∞–∑–∞–Ω –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.")

        user_id = user_db_data['user_id']
        price_to_pay = deal_data.get('assign_price', 0.0)
        full_description = deal_data.get('assign_full_desc', '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Ç')
        booking_type = deal_data.get('booking_type')
        parsed_data = deal_data.get('parsed_deal_data', {})

        # 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        passport_data = json.loads(user_db_data['passport_data']) if user_db_data['passport_data'] else {}
        user_data_for_doc = { "full_name": f"{user_db_data['last_name'] or ''} {user_db_data['first_name'] or ''}".strip(), "phone": user_db_data['phone_number'], "passport_data": passport_data }
        batteries_list = parsed_data.get('batteries', [])
        if not batteries_list: battery_info_for_doc = "–±–µ–∑ –ê–ö–ë"
        else:
            battery_lines = [f"{b.get('capacity', '')} (‚Ññ{b.get('number', '–±/–Ω')})" for b in batteries_list]
            battery_info_for_doc = f"{len(batteries_list)} —à—Ç: " + ", ".join(battery_lines)
        bike_data_for_doc = { "model_name": parsed_data.get('model_name', "–ù–µ —É–∫–∞–∑–∞–Ω–æ"), "number": parsed_data.get('bike_number', "–±/–Ω"), "battery_info": battery_info_for_doc, "estimated_cost": "80000—Ä."}

        rental_info_for_doc = {}
        plan_key_to_save = None
        user_notification_details = ""
        duration_text = ""

        if booking_type == 'rent':
            try:
                start_date_obj = datetime.strptime(user_db_data['booking_date'], '%d.%m.%Y')
                end_date_obj = datetime.strptime(user_db_data['end_date'], '%d.%m.%Y')
                duration_days = (end_date_obj - start_date_obj).days
                if duration_days % 10 == 1 and duration_days % 100 != 11: days_word = "–¥–µ–Ω—å"
                elif 2 <= duration_days % 10 <= 4 and (duration_days % 100 < 10 or duration_days % 100 >= 20): days_word = "–¥–Ω—è"
                else: days_word = "–¥–Ω–µ–π"
                duration_text = f"{duration_days} {days_word}"
            except (ValueError, TypeError) as e:
                logging.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ä–æ–∫ –∞—Ä–µ–Ω–¥—ã: {e}")
                duration_text = "–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π —Å—Ä–æ–∫"
            rental_info_for_doc = {"type": "rent", "price_text": f"{price_to_pay:.2f} —Ä—É–±.", "duration_text": duration_text}
            user_notification_details = f"–ê—Ä–µ–Ω–¥–∞ –Ω–∞ {duration_text}"
        else: # buyout
            plan_key_to_save = deal_data['selected_plan_key']
            plan_info = deal_data['generated_plans'][plan_key_to_save]
            rental_info_for_doc = {"type": "buyout", "payment_schedule": plan_info['full_label'], "buyout_period": f"{plan_info.get('total_payments')} –ø–ª–∞—Ç–µ–∂–µ–π"}
            user_notification_details = f"–í—ã–∫—É–ø –ø–æ –ø–ª–∞–Ω—É: {plan_info['full_label']}"

        # 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        file_path = generate_contract_docx(booking_id, user_data_for_doc, bike_data_for_doc, rental_info_for_doc)
        with open(file_path, 'rb') as doc_file:
            await context.bot.send_document(admin_chat_id, doc_file, caption=f"‚úÖ –î–æ–≥–æ–≤–æ—Ä –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π —Å–¥–µ–ª–∫–∏ #{booking_id}")
        os.remove(file_path)

        # 4. –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        invoice_title = f"–û–ø–ª–∞—Ç–∞: {full_description[:50]}"
        payload = f"custom_payment_{booking_id}"
        metadata = {'internal_payload': payload, 'user_id': user_id}
        items_for_receipt = [{"description": invoice_title, "quantity": "1.00", "amount": {"value": f"{price_to_pay:.2f}", "currency": "RUB"}, "vat_code": "1", "payment_subject": "service"}]
        payment_info = await create_yookassa_payment(amount=price_to_pay, description=invoice_title, metadata=metadata, items=items_for_receipt, customer_info={"phone": user_db_data['phone_number']}, payment_method='sbp')
        if not payment_info: raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É.")

        payment_url, payment_id, final_amount = payment_info['url'], payment_info['id'], payment_info['final_amount']

        # <<< –ù–ê–ß–ê–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô: –†–∞–∑–¥–µ–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ >>>

        # –ü–ï–†–í–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É —Å —É—Å–ª–æ–≤–∏—è–º–∏ —Å–¥–µ–ª–∫–∏
        user_approval_message = (
            f"‚úÖ –í–∞—à–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Å–¥–µ–ª–∫–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞!\n\n"
            f"**–°–æ—Å—Ç–∞–≤:** `{full_description}`\n"
            f"**–£—Å–ª–æ–≤–∏—è:** `{user_notification_details}`\n\n"
            "–ì–æ—Ç–æ–≤–∏–º —Å—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É..."
        )
        await context.bot.send_message(user_id, user_approval_message, parse_mode="Markdown")

        # –í–¢–û–†–û–ï —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É —Å–æ —Å—á–µ—Ç–æ–º
        user_invoice_message = f"–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã {final_amount:.2f} ‚ÇΩ"
        keyboard = [[InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å", url=payment_url)]]
        animated_message = await context.bot.send_message(
            user_id,
            user_invoice_message,
            reply_markup=InlineKeyboardMarkup(keyboard)
        )

        # <<< –ö–û–ù–ï–¶ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô >>>

        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø–ª–∞—Ç–µ–∂–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        if 'pending_payments' not in context.bot_data: context.bot_data['pending_payments'] = {}
        stop_animation_event = asyncio.Event()
        context.bot_data['pending_payments'][payment_id] = {'user_id': user_id, 'start_time': datetime.now(), 'payload': payload, 'amount': final_amount, 'animated_message_id': animated_message.message_id, 'url': payment_url, 'animation_sequence': random.choice(PAYMENT_ANIMATIONS), 'stop_animation_event': stop_animation_event}
        asyncio.create_task(animate_payment_message(context, payment_id))
        context.job_queue.run_repeating(callback=check_payment_status, interval=15, first=10, name=f"payment_{payment_id}", data={'yookassa_id': payment_id})

        # 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        async with aiosqlite.connect(DB_FILE) as conn:
            cursor = await conn.execute("INSERT INTO bikes (name, description, available, type) VALUES (?, ?, 0, ?)",(full_description, "–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è —Å–¥–µ–ª–∫–∞", booking_type))
            assigned_bike_id = cursor.lastrowid
            await conn.execute("UPDATE bookings SET bike_id = ?, payment_plan_key = ? WHERE id = ?",(assigned_bike_id, plan_key_to_save, booking_id))
            await conn.commit()

        await query.message.edit_text(f"‚úÖ –£—Å–ø–µ—à–Ω–æ! –ö–∞—Å—Ç–æ–º–Ω–∞—è —Å–¥–µ–ª–∫–∞ #{booking_id} —Å–æ–∑–¥–∞–Ω–∞, —Å—á–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.")

    except Exception as e:
        logger.error(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ finalize_assignment: {e}", exc_info=True)
        await query.message.edit_text(f"‚ùå –û–®–ò–ë–ö–ê: {e}.\n–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")

    context.user_data.clear()
    return ConversationHandler.END

### –ö–û–ù–ï–¶ –ü–û–õ–ù–û–ô –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ô –§–£–ù–ö–¶–ò–ò ###

### –ö–û–ù–ï–¶ –ü–û–õ–ù–û–ô –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ô –§–£–ù–ö–¶–ò–ò ###


# --- –û–ë–©–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–¢–ú–ï–ù–´ ---

async def cancel_assignment(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã –¥–ª—è –≤—Å–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞."""
    if update.callback_query:
        await update.callback_query.answer()
        await update.callback_query.edit_message_text("–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    else:
        await update.message.reply_text("–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    context.user_data.clear()
    return ConversationHandler.END

# ==============================================================================
# –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –ü–û–õ–ù–û–ô –ó–ê–ú–ï–ù–´
# ==============================================================================

async def leave_bike(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ "–Ø –æ—Å—Ç–∞–≤–∏–ª(–∞) –≤–µ–ª–æ—Å–∏–ø–µ–¥ –Ω–∞ —Å–∫–ª–∞–¥–µ".
    """
    query = update.callback_query
    await query.answer()

    request_id = int(query.data.split("_")[2])
    user_id = query.from_user.id

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            cursor = await conn.execute("SELECT user_id, left_at FROM repair_requests WHERE id=?", (request_id,))
            result = await cursor.fetchone()

            if result and result['user_id'] == user_id and result['left_at'] is None:
                current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                await conn.execute("UPDATE repair_requests SET left_at=? WHERE id=?", (current_time, request_id))
                await conn.commit()

                left_date = datetime.strptime(current_time, "%Y-%m-%d %H:%M:%S").strftime("%d.%m.%Y")
                await query.edit_message_text(f"‚úÖ –í—ã –æ—Ç–º–µ—Ç–∏–ª–∏, —á—Ç–æ –æ—Å—Ç–∞–≤–∏–ª–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥ –Ω–∞ —Å–∫–ª–∞–¥–µ {left_date}.")

                # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
                cursor = await conn.execute("""
                    SELECT u.first_name, u.last_name, u.username, b.name
                    FROM repair_requests rr
                    JOIN users u ON rr.user_id = u.id
                    JOIN bikes b ON rr.bike_id = b.id
                    WHERE rr.id=?
                """, (request_id,))
                notify_data = await cursor.fetchone()
                user_name = f"{notify_data['first_name']} {notify_data['last_name'] or ''} (@{notify_data['username'] or 'no_username'})"

                notification_message = (
                    f"üöö *–í–µ–ª–æ—Å–∏–ø–µ–¥ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ —Å–∫–ª–∞–¥!*\n\n"
                    f"üë§ *–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:* {escape_markdown(user_name, 2)}\n"
                    f"üö≤ *–í–µ–ª–æ—Å–∏–ø–µ–¥:* {escape_markdown(notify_data['name'], 2)}\n"
                    f"üìå *ID –∑–∞—è–≤–∫–∏:* `{request_id}`"
                )
                for admin_id in ADMIN_IDS + MASTER_IDS:
                    await context.bot.send_message(admin_id, notification_message, parse_mode="MarkdownV2")

            elif result and result['left_at'] is not None:
                await query.answer("–í—ã —É–∂–µ –æ—Ç–º–µ—á–∞–ª–∏, —á—Ç–æ –æ—Å—Ç–∞–≤–∏–ª–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥.", show_alert=True)
            else:
                await query.answer("üö´ –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ.", show_alert=True)

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ leave_bike: {e}", exc_info=True)
        await query.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.", show_alert=True)

async def back_to_main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    user_id = update.message.from_user.id
    menu_keyboard = get_main_menu(user_id)
    await update.message.reply_text("–í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", reply_markup=menu_keyboard)
    return ConversationHandler.END

def get_accepted_repairs_count():
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*) FROM repair_requests WHERE status='accepted'")
    count = cursor.fetchone()[0]
    conn.close()
    return count

def get_completed_repairs_count():
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*) FROM repair_requests WHERE status='completed' AND status != 'oplacheno'")
    count = cursor.fetchone()[0]
    conn.close()
    return count

# –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–º–æ–Ω—Ç–∞ —Å –≤—ã–±–æ—Ä–æ–º —Ç–∏–ø–∞ (–≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π/–Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π)


#



# –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ—Ç–∫–∏ –∑–∞—è–≤–∫–∏ –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–π
# --- –ù–û–í–ê–Ø, –£–ü–†–û–©–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –ó–ê–í–ï–†–®–ï–ù–ò–Ø –†–ï–ú–û–ù–¢–ê ---

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞
(AWAIT_REPAIR_PRICE, AWAIT_DELAY_REASON) = range(2)

async def start_complete_repair(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –®–∞–≥ 1: –ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–º–æ–Ω—Ç–∞, –∑–∞–ø—Ä–∞—à–∏–≤–∞—è –∏—Ç–æ–≥–æ–≤—É—é —Ü–µ–Ω—É.
    """
    query = update.callback_query
    await query.answer()

    request_id = int(query.data.split("_")[2])
    context.user_data['completing_repair_id'] = request_id

    # –°—Ä–∞–∑—É –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ü–µ–Ω—É
    await query.edit_message_text(
        f"‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ #{request_id}.\n\n"
        "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ä–µ–º–æ–Ω—Ç–∞ –≤ —Ä—É–±–ª—è—Ö. \n"
        "–ï—Å–ª–∏ —Ä–µ–º–æ–Ω—Ç –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π, –≤–≤–µ–¥–∏—Ç–µ **0**."
    )
    return AWAIT_REPAIR_PRICE


async def process_repair_price(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –®–∞–≥ 2: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ü–µ–Ω—É, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É –∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–∏—á–∏–Ω—É –∑–∞–¥–µ—Ä–∂–∫–∏.
    """
    try:
        price = float(update.message.text.replace(',', '.'))
        if price < 0:
            raise ValueError
        context.user_data['final_repair_price'] = price
    except ValueError:
        await update.message.reply_text("üö´ –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É (—á–∏—Å–ª–æ, –º–æ–∂–Ω–æ 0).")
        return AWAIT_REPAIR_PRICE

    request_id = context.user_data['completing_repair_id']

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —Ä–µ–º–æ–Ω—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω
    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            cursor = await conn.execute("SELECT expected_completion_date FROM repair_requests WHERE id=?", (request_id,))
            result = await cursor.fetchone()

        if result and result['expected_completion_date']:
            expected_date = datetime.strptime(result['expected_completion_date'], "%d.%m.%Y").date()
            if datetime.now().date() > expected_date:
                # –†–µ–º–æ–Ω—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–∏—á–∏–Ω—É
                await update.message.reply_text(
                    f"‚ö†Ô∏è –†–µ–º–æ–Ω—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω (–ø–ª–∞–Ω. –¥–∞—Ç–∞: {expected_date.strftime('%d.%m.%Y')}).\n"
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∑–∞–¥–µ—Ä–∂–∫–∏:"
                )
                return AWAIT_DELAY_REASON
    except Exception as e:
        logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞—Ç—É –ø—Ä–æ—Å—Ä–æ—á–∫–∏ –¥–ª—è –∑–∞—è–≤–∫–∏ {request_id}: {e}")

    # –ï—Å–ª–∏ –Ω–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω, —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ñ–∏–Ω–∞–ª—É
    return await finalize_completed_repair(update, context)


# --- –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø ---
### –ù–û–í–ê–Ø –í–ï–†–°–ò–Ø, –¢–û–õ–¨–ö–û –î–õ–Ø –ê–î–ú–ò–ù–ê ###
async def finalize_completed_repair(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –§–∏–Ω–∞–ª: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ, –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç —Å—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–µ—Å–ª–∏ —Ü–µ–Ω–∞ > 0)
    –∏ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –¥–∏–∞–ª–æ–≥. –í—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ –ø—É—Ç–∏.
    """
    message_to_reply = update.message # –¢–µ–ø–µ—Ä—å –º—ã —Ç–æ—á–Ω–æ –∑–Ω–∞–µ–º, —á—Ç–æ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
    delay_reason = None

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤ –∫–∞–∫–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∏—á–∏–Ω—É –∑–∞–¥–µ—Ä–∂–∫–∏
    if 'current_state' in context.user_data and context.user_data['current_state'] == AWAIT_DELAY_REASON:
        delay_reason = message_to_reply.text

    request_id = context.user_data['completing_repair_id']
    price = context.user_data['final_repair_price']
    admin_chat_id = update.effective_chat.id

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            await conn.execute('BEGIN')

            completed_at = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            await conn.execute(
                "UPDATE repair_requests SET status='completed', estimated_price=?, completed_at=?, is_warranty=?, delay_reason=? WHERE id=?",
                (price, completed_at, 1 if price == 0 else 0, delay_reason, request_id)
            )

            cursor = await conn.execute("""
                SELECT rr.user_id, rr.bike_id, u.phone_number, b.name as bike_name
                FROM repair_requests rr
                JOIN users u ON rr.user_id = u.id
                JOIN bikes b ON rr.bike_id = b.id
                WHERE rr.id=?
            """, (request_id,))
            data = await cursor.fetchone()
            if not data: raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ –∑–∞—è–≤–∫–µ.")

            await conn.execute(
                "UPDATE repair_logs SET repair_end_date = ?, delay_reason = ? WHERE bike_id = ? AND repair_end_date IS NULL",
                (datetime.now().strftime('%d.%m.%Y'), delay_reason, data['bike_id'])
            )

            log_details = f"–†–µ–º–æ–Ω—Ç –¥–ª—è '{data['bike_name']}' –∑–∞–≤–µ—Ä—à–µ–Ω. –°—É–º–º–∞: {price} ‚ÇΩ."
            if delay_reason: log_details += f" –ü—Ä–∏—á–∏–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∏: {delay_reason}"
            await log_bike_action(conn, data['bike_id'], data['user_id'], "–†–µ–º–æ–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω", log_details, amount=price)

            await conn.commit()

        await message_to_reply.reply_text(f"‚úÖ –ó–∞—è–≤–∫–∞ #{request_id} –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –°—É–º–º–∞: {price} ‚ÇΩ.")

        if price > 0:
            if not data['phone_number']:
                 await context.bot.send_message(admin_chat_id, f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã—Å—Ç–∞–≤–∏—Ç—å —Å—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {data['user_id']} (–Ω–µ—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞).")
            else:
                description = f"–û–ø–ª–∞—Ç–∞ —Ä–µ–º–æ–Ω—Ç–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ '{data['bike_name']}' (–∑–∞—è–≤–∫–∞ #{request_id})"
                payload = f"repair_payment_{request_id}"
                metadata = {'internal_payload': payload, 'user_id': data['user_id']}
                items = [{"description": description, "quantity": "1.00", "amount": {"value": f"{price:.2f}", "currency": "RUB"}, "vat_code": "1"}]
                customer = {"phone": data['phone_number']}

                payment_info = await create_yookassa_payment(price, description, metadata, items, customer, 'sbp')
                if payment_info:
                    payment_url, payment_id, final_amount = payment_info['url'], payment_info['id'], payment_info['final_amount']
                    keyboard = [[InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å —Ä–µ–º–æ–Ω—Ç", url=payment_url)]]

                    animated_message = await context.bot.send_message(
                        data['user_id'],
                        f"üõ†Ô∏è –í–∞—à —Ä–µ–º–æ–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ: {final_amount:.2f} ‚ÇΩ. –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ–ø–ª–∞—Ç–∏—Ç—å.",
                        reply_markup=InlineKeyboardMarkup(keyboard)
                    )

                    if 'pending_payments' not in context.bot_data:
                        context.bot_data['pending_payments'] = {}
                    stop_animation_event = asyncio.Event()
                    context.bot_data['pending_payments'][payment_id] = {
                        'user_id': data['user_id'], 'start_time': datetime.now(),
                        'payload': payload, 'amount': final_amount,
                        'animated_message_id': animated_message.message_id, 'url': payment_url,
                        'animation_sequence': random.choice(PAYMENT_ANIMATIONS),
                        'stop_animation_event': stop_animation_event
                    }

                    asyncio.create_task(animate_payment_message(context, payment_id))
                    context.job_queue.run_repeating(
                        callback=check_payment_status, interval=15, first=10,
                        name=f"payment_{payment_id}", data={'yookassa_id': payment_id}
                    )
                else:
                    await context.bot.send_message(admin_chat_id, f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –∑–∞—è–≤–∫–∏ #{request_id}.")
        else:
             # –ï—Å–ª–∏ —Ä–µ–º–æ–Ω—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π, —Å—Ä–∞–∑—É –º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ "oplacheno"
             async with aiosqlite.connect(DB_FILE) as conn:
                 await conn.execute("UPDATE repair_requests SET status='oplacheno' WHERE id=?", (request_id,))
                 await conn.commit()
             await context.bot.send_message(
                data['user_id'],
                "üõ†Ô∏è –í–∞—à —Ä–µ–º–æ–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –¢–∞–∫ –∫–∞–∫ –æ–Ω –±—ã–ª –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–º, –æ–ø–ª–∞—Ç–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è. –í—ã –º–æ–∂–µ—Ç–µ –∑–∞–±—Ä–∞—Ç—å —Å–≤–æ–π –≤–µ–ª–æ—Å–∏–ø–µ–¥."
             )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ finalize_completed_repair: {e}", exc_info=True)
        await message_to_reply.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–µ–º–æ–Ω—Ç–∞.")
    finally:
        context.user_data.clear()
        return ConversationHandler.END

WAITING_FOR_TIME, WAITING_FOR_PRICE = range(2)

async def accept_repair_request(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()

    request_id = int(query.data.split("_")[2])
    context.user_data['request_id'] = request_id

    await query.edit_message_text("üïí –í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, '2 —á–∞—Å–∞' –∏–ª–∏ '1 –¥–µ–Ω—å'):")
    return WAITING_FOR_TIME

async def get_time(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–µ–º–æ–Ω—Ç–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –¥–∞—Ç—ã"""

    if 'awaiting_time_correction' not in context.user_data:
        await update.message.reply_text(
            "üïí –í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–º–æ–Ω—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì, –Ω–∞–ø—Ä–∏–º–µ—Ä:\n"
            "‚Ä¢ 17.03.2025\n"
            "‚Ä¢ 25.04.2025\n\n"
            "–õ–∏–±–æ —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä):\n"
            "‚Ä¢ 1 –¥–µ–Ω—å\n"
            "‚Ä¢ 2 –¥–Ω—è\n"
            "‚Ä¢ 5 –¥–Ω–µ–π"
        )
        context.user_data['awaiting_time_correction'] = False
        return WAITING_FOR_TIME

    time_input = update.message.text.strip()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Ñ–æ—Ä–º–∞—Ç –¥–Ω–µ–π
    days_pattern = re.compile(r'^\d+\s+(–¥–µ–Ω—å|–¥–Ω—è|–¥–Ω–µ–π)$')
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã
    date_pattern = re.compile(r'^\d{2}\.\d{2}\.\d{4}$')

    current_date = datetime.now()

    if days_pattern.match(time_input):
        # –ï—Å–ª–∏ –≤–≤–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "X –¥–Ω–µ–π"
        days = int(''.join(filter(str.isdigit, time_input)))

        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        completion_date = current_date + timedelta(days=days)
        completion_date_str = completion_date.strftime("%d.%m.%Y")

        # –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞
        context.user_data['time'] = time_input  # –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ UI
        context.user_data['expected_completion_date'] = completion_date_str  # –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î

        time_message = f"{time_input} (–¥–æ {completion_date_str})"

    elif date_pattern.match(time_input):
        # –ï—Å–ª–∏ –≤–≤–æ–¥ —É–∂–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–∞—Ç—ã
        try:
            completion_date = datetime.strptime(time_input, "%d.%m.%Y")

            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            days_diff = (completion_date - current_date).days
            if days_diff < 1:
                days_diff = 1

            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–∫–ª–æ–Ω–µ–Ω–∏–µ —Å–ª–æ–≤–∞ "–¥–µ–Ω—å"
            if days_diff % 10 == 1 and days_diff % 100 != 11:
                days_word = "–¥–µ–Ω—å"
            elif 2 <= days_diff % 10 <= 4 and (days_diff % 100 < 10 or days_diff % 100 >= 20):
                days_word = "–¥–Ω—è"
            else:
                days_word = "–¥–Ω–µ–π"

            time_string = f"{days_diff} {days_word}"

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞
            context.user_data['time'] = time_string  # –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ UI
            context.user_data['expected_completion_date'] = time_input  # –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î

            time_message = f"{time_string} (–¥–æ {time_input})"

        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç –î–î.–ú–ú.–ì–ì–ì–ì, –Ω–∞–ø—Ä–∏–º–µ—Ä 17.03.2025")
            return WAITING_FOR_TIME

    else:
        await update.message.reply_text(
            "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤ –æ–¥–Ω–æ–º –∏–∑ —Ñ–æ—Ä–º–∞—Ç–æ–≤:\n"
            "‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –¥–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 17.03.2025)\n"
            "‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5 –¥–Ω–µ–π)"
        )
        return WAITING_FOR_TIME

    # –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏
    if 'awaiting_time_correction' in context.user_data:
        del context.user_data['awaiting_time_correction']

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ä–æ–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    await update.message.reply_text(
        f"‚úÖ –ó–∞–ø–∏—Å–∞–Ω–∞ –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: {time_message}\n\n"
        f"üíµ –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–º–µ—Ä–Ω—É—é —Ü–µ–Ω—É –∑–∞ —Ä–∞–±–æ—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, '1000 —Ä—É–±–ª–µ–π'):"
    )

    return WAITING_FOR_PRICE

### –ù–û–í–ê–Ø, –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ###
async def get_price(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ü–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏"""
    price_text = update.message.text

    # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–µ–∫—Å—Ç –≤ —á–∏—Å–ª–æ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º >>>
    try:
        # –£–±–∏—Ä–∞–µ–º "—Ä—É–±–ª–µ–π" –∏ –ø—Ä–æ–±–µ–ª—ã, –∑–∞–º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—É—é –Ω–∞ —Ç–æ—á–∫—É
        cleaned_price = price_text.lower().replace("—Ä—É–±–ª–µ–π", "").replace("—Ä—É–±–ª—è", "").replace("—Ä—É–±–ª—å", "").strip()
        price_float = float(cleaned_price.replace(',', '.'))
        if price_float < 0:
            raise ValueError("–¶–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π")
    except (ValueError, TypeError):
        await update.message.reply_text("üö´ –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É (—Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä, 1500 –∏–ª–∏ 0).")
        return WAITING_FOR_PRICE # –û—Å—Ç–∞–µ–º—Å—è –≤ —Ç–æ–º –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤–≤–æ–¥–∞

    request_id = context.user_data['request_id']
    time = context.user_data['time']
    expected_completion_date = context.user_data.get('expected_completion_date', '')

    formatted_price = format_rubles(price_float) # –ò—Å–ø–æ–ª—å–∑—É–µ–º —á–∏—Å–ª–æ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute(
        """UPDATE repair_requests
           SET status='accepted', estimated_time=?, estimated_price=?, expected_completion_date=?
           WHERE id=?""",
        (time, price_float, expected_completion_date, request_id) # <<< –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∏—Å–ª–æ (price_float)
    )
    conn.commit()
    conn.close()

    time_message = f"{time} (–¥–æ {expected_completion_date})" if expected_completion_date else time

    await update.message.reply_text(
        f"‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç ID {request_id} –ø—Ä–∏–Ω—è—Ç–∞ –≤ —Ä–∞–±–æ—Ç—É.\n"
        f"üïí –í—Ä–µ–º—è: {time_message}\n"
        f"üíµ –¶–µ–Ω–∞: {formatted_price}."
    )

    user_id = get_user_id_by_request_id(request_id)
    await context.bot.send_message(
        chat_id=user_id,
        text=(
            f"üõ†Ô∏è –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç –ø—Ä–∏–Ω—è—Ç–∞ –≤ —Ä–∞–±–æ—Ç—É.\n"
            f"üïí –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {time_message}\n"
            f"üíµ –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Ü–µ–Ω–∞: {formatted_price}.\n\n"
            f"‚ùì –ü–æ –≤—Å–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É: @Desscov."
        )
    )
    await context.bot.send_sticker(
        chat_id=user_id,
        sticker="CAACAgIAAxkBAAELuQ5ni347Uj7vYpmrUlRm0hMv-OuwRwACBBoAAqJdeUtq-6Jpx5iCFjYE"
    )
    # await view_repair_requests(update, context) # –≠—Ç—É —Å—Ç—Ä–æ–∫—É –º–æ–∂–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –≤—ã–≤–æ–¥
    return ConversationHandler.END

def format_rubles(amount):
    if isinstance(amount, str):
        amount = int(''.join(filter(str.isdigit, amount)))  # –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ –∏–∑ —Å—Ç—Ä–æ–∫–∏
    last_digit = amount % 10
    last_two_digits = amount % 100

    if last_two_digits in [11, 12, 13, 14]:
        return f"{amount} —Ä—É–±–ª–µ–π"
    elif last_digit == 1:
        return f"{amount} —Ä—É–±–ª—å"
    elif last_digit in [2, 3, 4]:
        return f"{amount} —Ä—É–±–ª—è"
    else:
        return f"{amount} —Ä—É–±–ª–µ–π"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è user_id –ø–æ request_id
def get_user_id_by_request_id(request_id):
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT user_id FROM repair_requests WHERE id=?", (request_id,))
    user_id = cursor.fetchone()[0]
    conn.close()
    return user_id

async def delete_repair_request(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()

    request_id = int(query.data.split("_")[2])  # –ü–æ–ª—É—á–∞–µ–º ID –∑–∞—è–≤–∫–∏

    # –£–¥–∞–ª—è–µ–º –∑–∞—è–≤–∫—É –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("DELETE FROM repair_requests WHERE id=?", (request_id,))
    conn.commit()
    conn.close()

    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await query.edit_message_text(f"üóëÔ∏è –ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç ID {request_id} –±—ã–ª–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞.")
    await view_repair_requests(update, context)




async def leave_bike(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()

    request_id = int(query.data.split("_")[2])
    user_id = query.from_user.id

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT user_id, left_at FROM repair_requests WHERE id=?", (request_id,))
    result = cursor.fetchone()

    if result and result[0] == user_id and result[1] is None:
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è –æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        cursor.execute("UPDATE repair_requests SET left_at=? WHERE id=?", (current_time, request_id))
        conn.commit()

        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        left_at_dt = datetime.strptime(current_time, "%Y-%m-%d %H:%M:%S")
        left_date = left_at_dt.strftime("%d.%m.%Y")  # 19.03.2025

        # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        await query.edit_message_text(f"‚úÖ –í—ã –æ—Ç–º–µ—Ç–∏–ª–∏, —á—Ç–æ –æ—Å—Ç–∞–≤–∏–ª–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥ –Ω–∞ —Å–∫–ª–∞–¥–µ {left_date}.")

        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
        cursor.execute("""
            SELECT u.first_name, u.last_name, u.username, b.name, rr.description
            FROM repair_requests rr
            JOIN users u ON rr.user_id = u.id
            JOIN bikes b ON rr.bike_id = b.id
            WHERE rr.id=?
        """, (request_id,))
        user_data = cursor.fetchone()
        user_name = f"{user_data[0]} {user_data[1]}" if user_data[1] else user_data[0]
        if user_data[2]:
            user_name += f" (@{user_data[2]})"
        bike_name, description = user_data[3], user_data[4]

        notification_message = (
            f"üö¥ *–í–µ–ª–æ—Å–∏–ø–µ–¥ –æ—Å—Ç–∞–≤–ª–µ–Ω –Ω–∞ —Å–∫–ª–∞–¥–µ*\n"
            f"üë§ *–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å*: {user_name}\n"
            f"üö≤ *–í–µ–ª–æ—Å–∏–ø–µ–¥*: {bike_name}\n"
            f"üìÖ *–î–∞—Ç–∞*: {left_date}\n"  # 19.03.2025
            f"üìù *–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã*: {description}\n"
            f"üìå *ID –∑–∞—è–≤–∫–∏*: {request_id}"
        )
        for admin_id in ADMIN_IDS + MASTER_IDS:
            await context.bot.send_message(admin_id, notification_message, parse_mode='Markdown')
    else:
        await query.edit_message_text("üö´ –í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ.")

    conn.close()

async def back_to_main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    user_id = update.message.from_user.id
    menu_keyboard = get_main_menu(user_id)
    await update.message.reply_text("–í—ã –≤–µ—Ä–Ω—É–ª–∏—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", reply_markup=menu_keyboard)
    return ConversationHandler.END

def get_accepted_repairs_count():
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*) FROM repair_requests WHERE status='accepted'")
    count = cursor.fetchone()[0]
    conn.close()
    return count

def get_completed_repairs_count():
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*) FROM repair_requests WHERE status='completed' AND status != 'oplacheno'")
    count = cursor.fetchone()[0]
    conn.close()
    return count

# –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–º–æ–Ω—Ç–∞ —Å –≤—ã–±–æ—Ä–æ–º —Ç–∏–ø–∞ (–≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π/–Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π)
async def complete_repair(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–º–æ–Ω—Ç–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏"""
    query = update.callback_query
    await query.answer()

    # –ò–∑–≤–ª–µ–∫–∞–µ–º ID –∑–∞—è–≤–∫–∏ –∏–∑ callback_data
    request_id = int(query.data.split("_")[2])
    context.user_data['request_id'] = request_id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—Å—Ä–æ—á–µ–Ω –ª–∏ —Ä–µ–º–æ–Ω—Ç
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ä–µ–º–æ–Ω—Ç–µ: –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ–∂–∏–¥–∞–µ–º—É—é –¥–∞—Ç—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    cursor.execute("""
        SELECT created_at, expected_completion_date
        FROM repair_requests
        WHERE id=?
    """, (request_id,))
    result = cursor.fetchone()
    conn.close()

    # –í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ—Å—Ä–æ—á–∫–µ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
    # –≠—Ç–æ —Ä–µ—à–∏—Ç –ø—Ä–æ–±–ª–µ–º—É —Å context.user_data
    global repair_delayed_info
    repair_delayed_info = {
        'request_id': request_id,
        'is_delayed': False,
        'expected_date': "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"
    }

    if result:
        created_at, expected_completion_date = result

        print(f"DEBUG: created_at={created_at}, expected_completion_date={expected_completion_date}")

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—Ä–æ—Å—Ä–æ—á–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        if expected_completion_date:
            repair_delayed_info['expected_date'] = expected_completion_date

            try:
                # –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                current_date = datetime.now()

                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É expected_completion_date –≤ –æ–±—ä–µ–∫—Ç datetime
                expected_completion = datetime.strptime(expected_completion_date, "%d.%m.%Y")

                print(f"DEBUG: –û–∂–∏–¥–∞–µ–º–∞—è –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: {expected_completion.strftime('%d.%m.%Y')}")
                print(f"DEBUG: –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞: {current_date.strftime('%d.%m.%Y')}")

                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Å—Ä–æ—á–∫—É
                if current_date.date() > expected_completion.date():
                    repair_delayed_info['is_delayed'] = True
                    print(f"DEBUG: –†–µ–º–æ–Ω—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω! ID={request_id}, –¥–∞—Ç–∞={expected_completion_date}")
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–æ—Å—Ä–æ—á–∫–∏: {e}")

    # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤—ã–±—Ä–∞—Ç—å —Ç–∏–ø —Ä–µ–º–æ–Ω—Ç–∞ —Å –æ–±—ã—á–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º callback_data
    keyboard = [
        [InlineKeyboardButton("üõ°Ô∏è –ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç", callback_data=f"warranty_yes_{request_id}")],
        [InlineKeyboardButton("üí∞ –ù–µ –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç", callback_data=f"warranty_no_{request_id}")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–µ–º–æ–Ω—Ç–∞:",
        reply_markup=reply_markup
    )

    return CHOOSE_WARRANTY_TYPE

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ—Å—Ä–æ—á–∫–µ
repair_delayed_info = {}

async def handle_warranty_choice(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ —Ä–µ–º–æ–Ω—Ç–∞ (–≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π/–Ω–µ–≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π)"""
    query = update.callback_query
    await query.answer()

    # –†–∞–∑–±–∏—Ä–∞–µ–º callback_data –≤ —Å—Ç–∞—Ä–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
    data = query.data.split("_")
    is_warranty = data[1] == "yes"
    request_id = int(data[2])

    context.user_data['request_id'] = request_id
    context.user_data['is_warranty'] = is_warranty

    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ—Å—Ä–æ—á–∫–µ –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
    global repair_delayed_info
    is_delayed = False
    expected_date = "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö"

    if repair_delayed_info.get('request_id') == request_id:
        is_delayed = repair_delayed_info.get('is_delayed', False)
        expected_date = repair_delayed_info.get('expected_date', "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö")
        context.user_data['is_delayed'] = is_delayed
        context.user_data['expected_completion_date'] = expected_date

    print(f"DEBUG: handle_warranty_choice - is_delayed={is_delayed}, expected_date={expected_date}")

    # –ï—Å–ª–∏ —Ä–µ–º–æ–Ω—Ç –∑–∞–¥–µ—Ä–∂–∞–Ω, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–∏—á–∏–Ω—É
    if is_delayed:
        await query.edit_message_text(
            f"‚ö†Ô∏è –†–µ–º–æ–Ω—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω! –û–∂–∏–¥–∞–µ–º–∞—è –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –±—ã–ª–∞ {expected_date}.\n\n"
            f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∑–∞–¥–µ—Ä–∂–∫–∏:"
        )
        return ENTER_DELAY_REASON
    else:
        # –ï—Å–ª–∏ —Ä–µ–º–æ–Ω—Ç –Ω–µ –∑–∞–¥–µ—Ä–∂–∞–Ω, –∑–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
        return await complete_repair_final(update, context)

async def handle_delay_reason(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏—á–∏–Ω—ã –∑–∞–¥–µ—Ä–∂–∫–∏ —Ä–µ–º–æ–Ω—Ç–∞"""
    delay_reason = update.message.text
    context.user_data['delay_reason'] = delay_reason

    # –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–º–æ–Ω—Ç–∞
    return await complete_repair_final(update, context)

async def complete_repair_final(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–§–∏–Ω–∞–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–º–æ–Ω—Ç–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    request_id = context.user_data.get('request_id')
    is_warranty = context.user_data.get('is_warranty', False)
    delay_reason = context.user_data.get('delay_reason', None)

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
    current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    # –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    cursor.execute(
        """UPDATE repair_requests
           SET status='completed', completed_at=?, is_warranty=?, delay_reason=?
           WHERE id=?""",
        (current_time, 1 if is_warranty else 0, delay_reason, request_id)
    )
    conn.commit()

    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞—è–≤–∫–µ
    cursor.execute("""
        SELECT rr.user_id, rr.estimated_price, u.first_name, u.last_name, b.name
        FROM repair_requests rr
        JOIN users u ON rr.user_id = u.id
        JOIN bikes b ON rr.bike_id = b.id
        WHERE rr.id=?
    """, (request_id,))

    result = cursor.fetchone()
    if result:
        user_id, price, first_name, last_name, bike_name = result
        formatted_price = format_rubles(price) if price else "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"
    else:
        user_id, formatted_price = None, "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"

    conn.close()

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –±—ã–ª–∞ –ª–∏ –∑–∞–¥–µ—Ä–∂–∫–∞
    delay_info = f"\n‚ö†Ô∏è –ü—Ä–∏—á–∏–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∏: {delay_reason}" if delay_reason else ""

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–∏–ø–µ —Ä–µ–º–æ–Ω—Ç–∞
    warranty_info = "üõ°Ô∏è –ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç" if is_warranty else "üí∞ –ù–µ –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç"

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
    message_text = f"‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç ID {request_id} –∑–∞–≤–µ—Ä—à–µ–Ω–∞.\n{warranty_info}{delay_info}"

    if isinstance(update, Update) and update.callback_query:
        await update.callback_query.edit_message_text(message_text)
    else:
        await update.message.reply_text(message_text)

    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Ä–µ–º–æ–Ω—Ç–∞
    if user_id:
        if is_warranty:
            await context.bot.send_message(
                chat_id=user_id,
                text=(
                    "üõ†Ô∏è –†–µ–º–æ–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ!\n\n"
                    "üõ°Ô∏è –í–∞—à —Ä–µ–º–æ–Ω—Ç –±—ã–ª –≤—ã–ø–æ–ª–Ω–µ–Ω –ø–æ –≥–∞—Ä–∞–Ω—Ç–∏–∏. –û–ø–ª–∞—Ç–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.\n"
                    "‚ùì –ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ @Desscov."
                )
            )
        else:
            await context.bot.send_message(
                chat_id=user_id,
                text=(
                    "üõ†Ô∏è –†–µ–º–æ–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ!\n\n"
                    f"üí≥ –í–∞–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–ø–ª–∞—Ç–∏—Ç—å —É—Å–ª—É–≥–∏ —Ä–µ–º–æ–Ω—Ç–∞. –°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ: {formatted_price}.\n"
                    "–î–ª—è –æ–ø–ª–∞—Ç—ã –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ @BFbike."
                )
            )

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∏–∫–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        await context.bot.send_sticker(
            chat_id=user_id,
            sticker="CAACAgIAAxkBAAELXWVneZ_El-AGf8unhOmOz5K34qS0iwACJBsAAn30iEmLH9JI8jo-cjYE"
        )

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫
    if isinstance(update, Update) and update.callback_query:
        await view_repair_requests(update, context)

    return ConversationHandler.END

# –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ—Ç–∫–∏ –∑–∞—è–≤–∫–∏ –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–π
async def mark_paid(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ —Ä–µ–º–æ–Ω—Ç–∞ –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ —Å —É—á–µ—Ç–æ–º –≥–∞—Ä–∞–Ω—Ç–∏–∏"""
    query = update.callback_query
    await query.answer()

    request_id = int(query.data.split("_")[1])

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ä–µ–º–æ–Ω—Ç –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–º
    cursor.execute("SELECT is_warranty, user_id FROM repair_requests WHERE id=?", (request_id,))
    result = cursor.fetchone()
    is_warranty = result[0] if result else 0
    user_id = result[1] if result else None

    # –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ –Ω–∞ oplacheno, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–∏–ø–∞
    cursor.execute("UPDATE repair_requests SET status='oplacheno' WHERE id=?", (request_id,))
    conn.commit()

    # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
    admin_message = f"‚úÖ –ó–∞—è–≤–∫–∞ ID {request_id} –æ—Ç–º–µ—á–µ–Ω–∞ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–π."
    if is_warranty:
        admin_message += " (–ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç)"

    # –î–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∞–¥–º–∏–Ω–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
    cursor.execute("""
        SELECT
            u.first_name,
            u.last_name,
            b.name,
            rr.description,
            rr.estimated_price,
            rr.created_at,
            rr.bike_id
        FROM repair_requests rr
        JOIN users u ON rr.user_id = u.id
        JOIN bikes b ON rr.bike_id = b.id
        WHERE rr.id=?
    """, (request_id,))

    result = cursor.fetchone()
    first_name, last_name, bike_name, description, price, created_date, bike_id = result

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
    if '-' in created_date:
        date_obj = datetime.strptime(created_date, "%Y-%m-%d %H:%M:%S")
        formatted_date = date_obj.strftime("%d.%m.%y")
    else:
        formatted_date = created_date

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—É–º–º—É
    formatted_price = format_rubles(price) if price else "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"

    # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –¥–∞—Ç–æ–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YY
    action_text = "–û–ø–ª–∞—Ç–∞ —Ä–µ–º–æ–Ω—Ç–∞" + (" (–≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π)" if is_warranty else "")
    details = (
        f"üìÖ –î–∞—Ç–∞: {formatted_date}\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {first_name} {last_name}\n"
        f"üö≤ –í–µ–ª–æ—Å–∏–ø–µ–¥: {bike_name}\n"
        f"üìù –ü—Ä–æ–±–ª–µ–º–∞: {description}\n"
        f"üí≥ –°—É–º–º–∞: {formatted_price}\n"
        f"üõ°Ô∏è –ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π: {'–î–∞' if is_warranty else '–ù–µ—Ç'}"
    )

    log_bike_action(
        bike_id=bike_id,
        user_id=user_id,
        action=action_text,
        details=details
    )

    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
    await query.edit_message_text(admin_message)

    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç
    if not is_warranty and user_id:
        await context.bot.send_message(user_id, "üéâ –í—ã —É—Å–ø–µ—à–Ω–æ –æ–ø–ª–∞—Ç–∏–ª–∏ —Ä–µ–º–æ–Ω—Ç! –£–¥–∞—á–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫!")
        await context.bot.send_sticker(user_id, sticker="CAACAgIAAxkBAAELuQ5ni347Uj7vYpmrUlRm0hMv-OuwRwACBBoAAqJdeUtq-6Jpx5iCFjYE")

    await view_repair_requests(update, context)
    conn.close()

WAITING_FOR_TIME, WAITING_FOR_PRICE = range(2)

async def accept_repair_request(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()

    request_id = int(query.data.split("_")[2])
    context.user_data['request_id'] = request_id

    await query.edit_message_text("üïí –í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, '2 —á–∞—Å–∞' –∏–ª–∏ '1 –¥–µ–Ω—å'):")
    return WAITING_FOR_TIME

async def get_time(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–µ–º–æ–Ω—Ç–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –¥–∞—Ç—ã"""

    if 'awaiting_time_correction' not in context.user_data:
        await update.message.reply_text(
            "üïí –í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–º–æ–Ω—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì, –Ω–∞–ø—Ä–∏–º–µ—Ä:\n"
            "‚Ä¢ 17.03.2025\n"
            "‚Ä¢ 25.04.2025\n\n"
            "–õ–∏–±–æ —É–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä):\n"
            "‚Ä¢ 1 –¥–µ–Ω—å\n"
            "‚Ä¢ 2 –¥–Ω—è\n"
            "‚Ä¢ 5 –¥–Ω–µ–π"
        )
        context.user_data['awaiting_time_correction'] = False
        return WAITING_FOR_TIME

    time_input = update.message.text.strip()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Ñ–æ—Ä–º–∞—Ç –¥–Ω–µ–π
    days_pattern = re.compile(r'^\d+\s+(–¥–µ–Ω—å|–¥–Ω—è|–¥–Ω–µ–π)$')
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã
    date_pattern = re.compile(r'^\d{2}\.\d{2}\.\d{4}$')

    current_date = datetime.now()

    if days_pattern.match(time_input):
        # –ï—Å–ª–∏ –≤–≤–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "X –¥–Ω–µ–π"
        days = int(''.join(filter(str.isdigit, time_input)))

        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        completion_date = current_date + timedelta(days=days)
        completion_date_str = completion_date.strftime("%d.%m.%Y")

        # –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞
        context.user_data['time'] = time_input  # –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ UI
        context.user_data['expected_completion_date'] = completion_date_str  # –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î

        time_message = f"{time_input} (–¥–æ {completion_date_str})"

    elif date_pattern.match(time_input):
        # –ï—Å–ª–∏ –≤–≤–æ–¥ —É–∂–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–∞—Ç—ã
        try:
            completion_date = datetime.strptime(time_input, "%d.%m.%Y")

            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            days_diff = (completion_date - current_date).days
            if days_diff < 1:
                days_diff = 1

            # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–∫–ª–æ–Ω–µ–Ω–∏–µ —Å–ª–æ–≤–∞ "–¥–µ–Ω—å"
            if days_diff % 10 == 1 and days_diff % 100 != 11:
                days_word = "–¥–µ–Ω—å"
            elif 2 <= days_diff % 10 <= 4 and (days_diff % 100 < 10 or days_diff % 100 >= 20):
                days_word = "–¥–Ω—è"
            else:
                days_word = "–¥–Ω–µ–π"

            time_string = f"{days_diff} {days_word}"

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–∞ —Ñ–æ—Ä–º–∞—Ç–∞
            context.user_data['time'] = time_string  # –î–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ UI
            context.user_data['expected_completion_date'] = time_input  # –î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î

            time_message = f"{time_string} (–¥–æ {time_input})"

        except ValueError:
            await update.message.reply_text("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç –î–î.–ú–ú.–ì–ì–ì–ì, –Ω–∞–ø—Ä–∏–º–µ—Ä 17.03.2025")
            return WAITING_FOR_TIME

    else:
        await update.message.reply_text(
            "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –≤ –æ–¥–Ω–æ–º –∏–∑ —Ñ–æ—Ä–º–∞—Ç–æ–≤:\n"
            "‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –¥–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 17.03.2025)\n"
            "‚Ä¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5 –¥–Ω–µ–π)"
        )
        return WAITING_FOR_TIME

    # –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥ –∫–æ—Ä—Ä–µ–∫—Ü–∏–∏
    if 'awaiting_time_correction' in context.user_data:
        del context.user_data['awaiting_time_correction']

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ä–æ–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    await update.message.reply_text(
        f"‚úÖ –ó–∞–ø–∏—Å–∞–Ω–∞ –¥–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: {time_message}\n\n"
        f"üíµ –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–∏–º–µ—Ä–Ω—É—é —Ü–µ–Ω—É –∑–∞ —Ä–∞–±–æ—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, '1000 —Ä—É–±–ª–µ–π'):"
    )

    return WAITING_FOR_PRICE

async def get_price(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ü–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏"""
    price = update.message.text
    request_id = context.user_data['request_id']
    time = context.user_data['time']  # –¢–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "1 –¥–µ–Ω—å")
    expected_completion_date = context.user_data.get('expected_completion_date', '') # –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –¥–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "17.03.2025")

    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å–∫–ª–æ–Ω–µ–Ω–∏–µ–º
    formatted_price = format_rubles(price)

    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ –Ω–∞ "accepted" –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è, —Ü–µ–Ω—É –∏ –æ–∂–∏–¥–∞–µ–º—É—é –¥–∞—Ç—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute(
        """UPDATE repair_requests
           SET status='accepted', estimated_time=?, estimated_price=?, expected_completion_date=?
           WHERE id=?""",
        (time, price, expected_completion_date, request_id)
    )
    conn.commit()
    conn.close()

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ä–æ–∫–∞—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    time_message = f"{time} (–¥–æ {expected_completion_date})"

    # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    await update.message.reply_text(
        f"‚úÖ –ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç ID {request_id} –ø—Ä–∏–Ω—è—Ç–∞ –≤ —Ä–∞–±–æ—Ç—É.\n"
        f"üïí –í—Ä–µ–º—è: {time_message}\n"
        f"üíµ –¶–µ–Ω–∞: {formatted_price}."
    )

    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_id = get_user_id_by_request_id(request_id)
    await context.bot.send_message(
        chat_id=user_id,
        text=(
            f"üõ†Ô∏è –í–∞—à–∞ –∑–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç –ø—Ä–∏–Ω—è—Ç–∞ –≤ —Ä–∞–±–æ—Ç—É.\n"
            f"üïí –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {time_message}\n"
            f"üíµ –ü—Ä–∏–º–µ—Ä–Ω–∞—è —Ü–µ–Ω–∞: {formatted_price}.\n\n"
            f"‚ùì –ü–æ –≤—Å–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É: @@BFbikechat."
        )
    )
    await context.bot.send_sticker(
        chat_id=user_id,
        sticker="CAACAgIAAxkBAAELuQ5ni347Uj7vYpmrUlRm0hMv-OuwRwACBBoAAqJdeUtq-6Jpx5iCFjYE"
    )
    await view_repair_requests(update, context)
    return ConversationHandler.END

def format_rubles(amount):
    if isinstance(amount, str):
        amount = int(''.join(filter(str.isdigit, amount)))  # –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ –∏–∑ —Å—Ç—Ä–æ–∫–∏
    last_digit = amount % 10
    last_two_digits = amount % 100

    if last_two_digits in [11, 12, 13, 14]:
        return f"{amount} —Ä—É–±–ª–µ–π"
    elif last_digit == 1:
        return f"{amount} —Ä—É–±–ª—å"
    elif last_digit in [2, 3, 4]:
        return f"{amount} —Ä—É–±–ª—è"
    else:
        return f"{amount} —Ä—É–±–ª–µ–π"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è user_id –ø–æ request_id
def get_user_id_by_request_id(request_id):
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("SELECT user_id FROM repair_requests WHERE id=?", (request_id,))
    user_id = cursor.fetchone()[0]
    conn.close()
    return user_id

async def delete_repair_request(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()

    request_id = int(query.data.split("_")[2])  # –ü–æ–ª—É—á–∞–µ–º ID –∑–∞—è–≤–∫–∏

    # –£–¥–∞–ª—è–µ–º –∑–∞—è–≤–∫—É –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute("DELETE FROM repair_requests WHERE id=?", (request_id,))
    conn.commit()
    conn.close()

    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await query.edit_message_text(f"üóëÔ∏è –ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç ID {request_id} –±—ã–ª–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞.")
    await view_repair_requests(update, context)

async def pay_fine_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    fine_id = query.data.split("_")[2]
    user_id = query.from_user.id

    with sqlite3.connect(DB_FILE) as conn:
        cursor = conn.cursor()
        cursor.execute("""
            SELECT amount, reason FROM fines WHERE id = ? AND user_id = ? AND status != 'paid'
        """, (fine_id, user_id))
        fine = cursor.fetchone()

    if not fine:
        await query.message.reply_text("‚ùå –®—Ç—Ä–∞—Ñ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É–∂–µ –æ–ø–ª–∞—á–µ–Ω")
        return

    amount_rub = int(fine[0])
    reason = fine[1] if fine[1] else "–Ω–µ —É–∫–∞–∑–∞–Ω–∞"

    title = f"–®—Ç—Ä–∞—Ñ #{fine_id}"
    description = f"–û–ø–ª–∞—Ç–∞ —à—Ç—Ä–∞—Ñ–∞\n–ü—Ä–∏—á–∏–Ω–∞: {reason}\n–°—É–º–º–∞: {amount_rub}‚ÇΩ"
    payload = f"fine_{fine_id}"

    if TEST_MODE:
        keyboard = [[
            InlineKeyboardButton(
                f"–¢–µ—Å—Ç: –û–ø–ª–∞—Ç–∏—Ç—å {amount_rub} ‚ÇΩ",
                callback_data=f"mock_payment_{payload}_{amount_rub}"
            )
        ]]
        await query.message.reply_text(
            f"–¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú\n\n–¢—Ä–µ–±—É–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞ —à—Ç—Ä–∞—Ñ–∞ #{fine_id} –Ω–∞ —Å—É–º–º—É {amount_rub} ‚ÇΩ.\n–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã.",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
    else:
        prices = [LabeledPrice(label=f"–®—Ç—Ä–∞—Ñ #{fine_id}", amount=int(amount_rub * 100))]
        await context.bot.send_invoice(
            chat_id=user_id, title=title, description=description,
            payload=payload, provider_token=PROVIDER_TOKEN, currency="RUB", prices=prices,
            need_name=True, need_phone_number=True, send_phone_number_to_provider=True
        )

async def test_overdue_rental(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è —à—Ç—Ä–∞—Ñ–æ–≤.
    """
    try:
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –µ–≥–æ ID
        user = update.effective_user
        if not user or user.is_bot:
            await context.bot.send_message(
                chat_id=update.effective_chat.id,
                text="‚ùå –û—à–∏–±–∫–∞: –±–æ—Ç—ã –Ω–µ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é."
            )
            return
        user_id = user.id
        chat_id = update.effective_chat.id

        # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        with sqlite3.connect(DB_FILE) as conn:
            cursor = conn.cursor()

            # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∞—Ä–µ–Ω–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            cursor.execute("""
                SELECT b.id, b.end_date, bi.name
                FROM bookings b
                JOIN bikes bi ON b.bike_id = bi.id
                WHERE b.user_id = ? AND b.status = 'rented'
            """, (user_id,))
            rentals = cursor.fetchall()

            if not rentals:
                await context.bot.send_message(
                    chat_id=chat_id,
                    text="üö´ –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∞—Ä–µ–Ω–¥ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è."
                )
                return

            # –£–º–µ–Ω—å—à–∞–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –∞—Ä–µ–Ω–¥—ã –¥–ª—è –ø–µ—Ä–≤–æ–π –∞—Ä–µ–Ω–¥—ã
            rental_id, old_end_date, bike_name = rentals[0]
            try:
                old_end_date_obj = datetime.strptime(old_end_date, "%d.%m.%Y")
                new_end_date_obj = old_end_date_obj - timedelta(days=5)  # –£–º–µ–Ω—å—à–∞–µ–º –Ω–∞ 5 –¥–Ω–µ–π
                new_end_date = new_end_date_obj.strftime("%d.%m.%Y")

                # –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                cursor.execute("""
                    UPDATE bookings
                    SET end_date = ?
                    WHERE id = ?
                """, (new_end_date, rental_id))
                conn.commit()

                await context.bot.send_message(
                    chat_id=chat_id,
                    text=(
                        f"üö¥ –ê—Ä–µ–Ω–¥–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ '{bike_name}' –æ–±–Ω–æ–≤–ª–µ–Ω–∞.\n"
                        f"–°—Ç–∞—Ä–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: {old_end_date}\n"
                        f"–ù–æ–≤–∞—è –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: {new_end_date}"
                    )
                )
            except ValueError as e:
                await context.bot.send_message(
                    chat_id=chat_id,
                    text=f"‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞—Ç—ã: {e}"
                )
                return

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ —à—Ç—Ä–∞—Ñ–æ–≤
            await manage_bike(update, context)

    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –≤ test_overdue_rental: {str(e)}")
        await context.bot.send_message(
            chat_id=update.effective_chat.id,
            text="‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )


from datetime import datetime
from telegram import Update, ReplyKeyboardMarkup, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import CallbackContext, ConversationHandler


# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è ConversationHandler
import sqlite3
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup
from telegram.ext import ContextTypes, ConversationHandler, filters, MessageHandler, CallbackQueryHandler

# Define states
SELECTING_BIKE, SELECTING_ACTION, ENTERING_REPAIR_PERSON, ENTERING_REASON, ENTERING_WARRANTY, \
ENTERING_WARRANTY_AMOUNT, ENTERING_ESTIMATED_DATE, ENTERING_DELAY_REASON, SEARCHING = range(9)

# Database initialization
def init_db():
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS bikes (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            repair_status TEXT,
            repair_reason TEXT,
            repair_date TEXT,
            available INTEGER DEFAULT 1
        )
    ''')
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS repair_logs (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            bike_id INTEGER,
            repair_start_date TEXT,
            repair_end_date TEXT,
            repair_person TEXT,
            reason TEXT,
            is_warranty INTEGER,
            warranty_amount REAL,
            estimated_completion_date TEXT,
            delay_reason TEXT,
            FOREIGN KEY (bike_id) REFERENCES bikes(id)
        )
    ''')
    conn.commit()
    conn.close()

# Repair menu
async def repair_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    keyboard = [
        ["üîß –í–µ–ª–æ—Å–∏–ø–µ–¥—ã –≤ —Ä–µ–º–æ–Ω—Ç–µ"],
        ["üö≤ –†–∞–±–æ—á–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã"],
        ["‚ö†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º"],
        ["üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"]
    ]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    await update.message.reply_text(
        "üîß –ú–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–º–æ–Ω—Ç–æ–º:\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=reply_markup
    )

# Show bikes by status
async def show_bikes_by_status(update: Update, context: ContextTypes.DEFAULT_TYPE, status: str) -> None:
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    if status == 'in_repair':
        cursor.execute('''
            SELECT name, repair_reason, repair_date
            FROM bikes
            WHERE repair_status = 'in_repair'
            ORDER BY repair_date DESC
        ''')
        message = "üîß *–í–µ–ª–æ—Å–∏–ø–µ–¥—ã –≤ —Ä–µ–º–æ–Ω—Ç–µ:*\n\n"
    else:
        cursor.execute('''
            SELECT name
            FROM bikes
            WHERE repair_status = 'working' OR repair_status IS NULL
            ORDER BY name
        ''')
        message = "‚úÖ *–†–∞–±–æ—á–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã:*\n\n"

    bikes = cursor.fetchall()
    conn.close()

    if not bikes:
        await update.message.reply_text(
            "üìù –í –¥–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤",
            parse_mode='Markdown'
        )
        return

    for bike in bikes:
        if status == 'in_repair':
            name, reason, date = bike
            message += f"üö≤ *{name}*\nüìù –ü—Ä–∏—á–∏–Ω–∞: _{reason}_\nüìÖ –î–∞—Ç–∞: _{date}_\n\n"
        else:
            name = bike[0]
            message += f"üö≤ *{name}*\n\n"

    await update.message.reply_text(message, parse_mode='Markdown')

BIKES_PER_PAGE = 5

async def show_bike_list(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    search_query = context.user_data.get('repair_search_query', '')
    page = context.user_data.get('repair_page', 0)

    keyboard = [[InlineKeyboardButton("üîç –ü–æ–∏—Å–∫", callback_data="repair_search")]]

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    query = '''
        SELECT id, name, repair_status, repair_reason, repair_date
        FROM bikes
        WHERE name LIKE ?
        ORDER BY name
    '''
    search_pattern = f'%{search_query}%' if search_query else '%'

    cursor.execute(f"SELECT COUNT(*) FROM bikes WHERE name LIKE ?", (search_pattern,))
    total_bikes = cursor.fetchone()[0]

    cursor.execute(query + ' LIMIT ? OFFSET ?', (search_pattern, BIKES_PER_PAGE, page * BIKES_PER_PAGE))
    bikes = cursor.fetchall()
    conn.close()

    for bike in bikes:
        bike_id, name, status, reason, date = bike
        status_emoji = "üîß" if status == "in_repair" else "‚úÖ"
        keyboard.append([InlineKeyboardButton(f"{status_emoji} {name}", callback_data=f"select_bike_{bike_id}")])

    pagination_buttons = []
    if page > 0:
        pagination_buttons.append(InlineKeyboardButton("‚¨ÖÔ∏è", callback_data="remont_pagi_prev"))
    if (page + 1) * BIKES_PER_PAGE < total_bikes:
        pagination_buttons.append(InlineKeyboardButton("‚û°Ô∏è", callback_data="remont_pagi_next"))

    if pagination_buttons:
        keyboard.append(pagination_buttons)
    keyboard.append([InlineKeyboardButton("–û—Ç–º–µ–Ω–∞", callback_data="cancel_repair")])

    reply_markup = InlineKeyboardMarkup(keyboard)

    message_text = "–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–º:"
    if search_query:
        message_text = f"üîç –ü–æ–∏—Å–∫: {search_query}\n\n" + message_text
    message_text += f"\n\n–°—Ç—Ä–∞–Ω–∏—Ü–∞ {page + 1} –∏–∑ {(total_bikes + BIKES_PER_PAGE - 1) // BIKES_PER_PAGE}"

    if update.callback_query:
        await update.callback_query.edit_message_text(message_text, reply_markup=reply_markup)
    else:
        await update.message.reply_text(message_text, reply_markup=reply_markup)

    return SELECTING_BIKE

async def handle_repair_pagination(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()

    action = query.data.split('_')[2]
    current_page = context.user_data.get('repair_page', 0)

    if action == 'prev' and current_page > 0:
        context.user_data['repair_page'] = current_page - 1
    elif action == 'next':
        context.user_data['repair_page'] = current_page + 1

    await show_bike_list(update, context)
    return SELECTING_BIKE

async def start_repair_search(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()

    await query.edit_message_text(
        "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞:\n–ù–∞–ø—Ä–∏–º–µ—Ä: 00123 –∏–ª–∏ –ú–æ–Ω—Å—Ç—Ä"
    )
    return SEARCHING

async def handle_repair_search(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    search_query = update.message.text
    context.user_data['repair_search_query'] = search_query
    context.user_data['repair_page'] = 0

    await show_bike_list(update, context)
    return SELECTING_BIKE

async def bike_selected(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()

    bike_id = query.data.split('_')[2]
    context.user_data['selected_bike_id'] = bike_id

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute('SELECT name, repair_status FROM bikes WHERE id = ?', (bike_id,))
    bike_name, repair_status = cursor.fetchone()
    conn.close()

    context.user_data['selected_bike_name'] = bike_name

    keyboard = []
    if repair_status == 'in_repair':
        keyboard.append([InlineKeyboardButton("‚úÖ –£–±—Ä–∞—Ç—å –∏–∑ —Ä–µ–º–æ–Ω—Ç–∞", callback_data="set_working")])
    else:
        keyboard.append([InlineKeyboardButton("üîß –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Ä–µ–º–æ–Ω—Ç", callback_data="set_repair")])
    keyboard.append([InlineKeyboardButton("–û—Ç–º–µ–Ω–∞", callback_data="cancel_repair")])

    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(
        f"–í–µ–ª–æ—Å–∏–ø–µ–¥: *{bike_name}*\n"
        f"–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: {'üîß –í —Ä–µ–º–æ–Ω—Ç–µ' if repair_status == 'in_repair' else '‚úÖ –†–∞–±–æ—á–∏–π'}\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=reply_markup,
        parse_mode='Markdown'
    )
    return SELECTING_ACTION

async def action_selected(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()

    action = query.data
    bike_id = context.user_data['selected_bike_id']
    bike_name = context.user_data['selected_bike_name']

    if action == "set_repair":
        await query.edit_message_text("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –º–∞—Å—Ç–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π —Å—Ç–∞–≤–∏—Ç –≤–µ–ª–æ—Å–∏–ø–µ–¥ –≤ —Ä–µ–º–æ–Ω—Ç:")
        return ENTERING_REPAIR_PERSON
    elif action == "set_working":
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        cursor.execute("SELECT id, estimated_completion_date FROM repair_logs WHERE bike_id = ? AND repair_end_date IS NULL", (bike_id,))
        repair_log = cursor.fetchone()
        if repair_log:
            repair_log_id, estimated_date = repair_log
            if estimated_date:
                estimated_date_obj = datetime.strptime(estimated_date, "%d.%m.%Y")
                if datetime.now() > estimated_date_obj:
                    context.user_data['repair_log_id'] = repair_log_id
                    await query.edit_message_text("–†–µ–º–æ–Ω—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω. –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∑–∞–¥–µ—Ä–∂–∫–∏:")
                    return ENTERING_DELAY_REASON
            current_date = datetime.now().strftime("%d.%m.%Y")
            cursor.execute("UPDATE repair_logs SET repair_end_date = ? WHERE id = ?", (current_date, repair_log_id))
            cursor.execute("UPDATE bikes SET repair_status = 'working', repair_reason = NULL, repair_date = NULL, available = 1 WHERE id = ?", (bike_id,))
            conn.commit()
            conn.close()
            await query.edit_message_text(f"‚úÖ –í–µ–ª–æ—Å–∏–ø–µ–¥ *{bike_name}* —É–±—Ä–∞–Ω –∏–∑ —Ä–µ–º–æ–Ω—Ç–∞ –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∞—Ä–µ–Ω–¥—ã.", parse_mode='Markdown')
            return ConversationHandler.END
        else:
            cursor.execute("UPDATE bikes SET repair_status = 'working', repair_reason = NULL, repair_date = NULL, available = 1 WHERE id = ?", (bike_id,))
            conn.commit()
            conn.close()
            await query.edit_message_text(f"‚úÖ –í–µ–ª–æ—Å–∏–ø–µ–¥ *{bike_name}* —É–±—Ä–∞–Ω –∏–∑ —Ä–µ–º–æ–Ω—Ç–∞ –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∞—Ä–µ–Ω–¥—ã.", parse_mode='Markdown')
            return ConversationHandler.END
    return ConversationHandler.END

async def enter_repair_person(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    repair_person = update.message.text
    context.user_data['repair_person'] = repair_person
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —Ä–µ–º–æ–Ω—Ç–∞:")
    return ENTERING_REASON

async def enter_reason(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    reason = update.message.text
    context.user_data['reason'] = reason
    keyboard = [
        [InlineKeyboardButton("–î–∞", callback_data="warranty_yes")],
        [InlineKeyboardButton("–ù–µ—Ç", callback_data="warranty_no")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text("–≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç?", reply_markup=reply_markup)
    return ENTERING_WARRANTY

async def enter_warranty(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()
    if query.data == "warranty_yes":
        context.user_data['is_warranty'] = True
        await query.edit_message_text("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω–æ–≥–æ —Ä–µ–º–æ–Ω—Ç–∞:")
        return ENTERING_WARRANTY_AMOUNT
    else:
        context.user_data['is_warranty'] = False
        await query.edit_message_text("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—É—é –¥–∞—Ç—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–º–æ–Ω—Ç–∞ (—Ñ–æ—Ä–º–∞—Ç –î–î.–ú–ú.–ì–ì–ì–ì):")
        return ENTERING_ESTIMATED_DATE

async def enter_warranty_amount(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    try:
        amount = float(update.message.text)
        context.user_data['warranty_amount'] = amount
    except ValueError:
        await update.message.reply_text("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—É–º–º—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:")
        return ENTERING_WARRANTY_AMOUNT
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—É—é –¥–∞—Ç—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–º–æ–Ω—Ç–∞ (—Ñ–æ—Ä–º–∞—Ç –î–î.–ú–ú.–ì–ì–ì–ì):")
    return ENTERING_ESTIMATED_DATE

async def enter_estimated_date(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    date_str = update.message.text
    try:
        datetime.strptime(date_str, "%d.%m.%Y")
        context.user_data['estimated_completion_date'] = date_str
    except ValueError:
        await update.message.reply_text("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:")
        return ENTERING_ESTIMATED_DATE

    bike_id = context.user_data['selected_bike_id']
    repair_person = context.user_data['repair_person']
    reason = context.user_data['reason']
    is_warranty = context.user_data['is_warranty']
    warranty_amount = context.user_data.get('warranty_amount', None)
    estimated_completion_date = context.user_data['estimated_completion_date']
    current_date = datetime.now().strftime("%d.%m.%Y")

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute('''
        INSERT INTO repair_logs (bike_id, repair_start_date, repair_person, reason, is_warranty, warranty_amount, estimated_completion_date)
        VALUES (?, ?, ?, ?, ?, ?, ?)
    ''', (bike_id, current_date, repair_person, reason, 1 if is_warranty else 0, warranty_amount, estimated_completion_date))
    cursor.execute('''
        UPDATE bikes
        SET repair_status = 'in_repair',
            repair_reason = ?,
            repair_date = ?,
            available = 0
        WHERE id = ?
    ''', (reason, current_date, bike_id))
    conn.commit()
    conn.close()

    await update.message.reply_text(f"üîß –í–µ–ª–æ—Å–∏–ø–µ–¥ *{context.user_data['selected_bike_name']}* –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ —Ä–µ–º–æ–Ω—Ç.", parse_mode='Markdown')
    return ConversationHandler.END

async def enter_delay_reason(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    delay_reason = update.message.text
    repair_log_id = context.user_data['repair_log_id']
    bike_id = context.user_data['selected_bike_id']
    current_date = datetime.now().strftime("%d.%m.%Y")

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    cursor.execute('''
        UPDATE repair_logs
        SET repair_end_date = ?, delay_reason = ?
        WHERE id = ?
    ''', (current_date, delay_reason, repair_log_id))
    cursor.execute('''
        UPDATE bikes
        SET repair_status = 'working',
            repair_reason = NULL,
            repair_date = NULL,
            available = 1
        WHERE id = ?
    ''', (bike_id,))
    conn.commit()
    conn.close()

    await update.message.reply_text(f"‚úÖ –í–µ–ª–æ—Å–∏–ø–µ–¥ *{context.user_data['selected_bike_name']}* —É–±—Ä–∞–Ω –∏–∑ —Ä–µ–º–æ–Ω—Ç–∞ –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∞—Ä–µ–Ω–¥—ã. –ü—Ä–∏—á–∏–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.", parse_mode='Markdown')
    return ConversationHandler.END

async def cancel_repair(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if 'repair_search_query' in context.user_data:
        del context.user_data['repair_search_query']
    if 'repair_page' in context.user_data:
        del context.user_data['repair_page']

    query = update.callback_query
    if query:
        await query.answer()
        await query.edit_message_text("‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞")
    else:
        await update.message.reply_text("‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞")
    return ConversationHandler.END

def is_reject_reason_active(update: Update, context: ContextTypes.DEFAULT_TYPE) -> bool:
    return "reject_fine_id" in context.user_data

import random
import asyncio
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes
STICKER_START = "CAACAgIAAxkBAAEL6XZnlAkkoS8cKLZfu0mxWFBrXvZMAQACCQADiITmDeOD1Vb1d_1DNgQ"
STICKER_END = "CAACAgIAAxkBAAEL6XRnlAi4AAGUWN8UFTlrn6SQ0_E9HhEAAngAA-2rdw9CYfrbqrz0WjYE"
# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–≥—Ä—ã
GRID_SIZE = 10
CELL_EMPTY = '‚ñ™Ô∏è'
CELL_HEAD = 'üêâ'
CELL_FOOD = 'üçì'
BORDER_TOP = '‚¨õÔ∏è' * (GRID_SIZE + 2)
BORDER_SIDE = '‚¨õÔ∏è'

DIRECTIONS = {
    'up': (0, -1),
    'down': (0, 1),
    'left': (-1, 0),
    'right': (1, 0)
}

def init_game_state():
    return {
        'snake': [(GRID_SIZE//2, GRID_SIZE//2)],
        'direction': 'right',
        'food': None,
        'score': 0,
        'is_running': False,
        'message_id': None,
        'task': None,
        'reply_markup': None,
    }

def generate_food(snake):
    free_cells = [ (x,y) for x in range(GRID_SIZE)
                  for y in range(GRID_SIZE) if (x,y) not in snake]
    return random.choice(free_cells) if free_cells else None

def render_grid(snake, food):
    grid = [BORDER_TOP]
    for y in range(GRID_SIZE):
        row = [BORDER_SIDE]
        for x in range(GRID_SIZE):
            if (x, y) == food: row.append(CELL_FOOD)
            elif (x, y) == snake[0]: row.append(CELL_HEAD)
            elif (x, y) in snake: row.append('üü©' if (x+y)%2 else 'üü¢')
            else: row.append(CELL_EMPTY)
        grid.append(f'{BORDER_SIDE}{"".join(row)}{BORDER_SIDE}')
    grid.append(BORDER_TOP)
    return '\n'.join(grid)

async def start_snake(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —Å—Ç–∏–∫–µ—Ä
    await context.bot.send_sticker(
        chat_id=update.effective_chat.id,
        sticker=STICKER_START
    )

    user_data = context.user_data
    if user_data.get('snake_game', {}).get('is_running'):
        await update.message.reply_text("–ò–≥—Ä–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞! üêç")
        return

    game = init_game_state()
    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton(d, callback_data=f'snake_{d}') for d in ('up', 'down')],
        [InlineKeyboardButton(d, callback_data=f'snake_{d}') for d in ('left', 'right')],
        [InlineKeyboardButton("üíÄ –ó–∞–≤–µ—Ä—à–∏—Ç—å", callback_data='snake_exit')]
    ])
    game.update({
        'food': generate_food(game['snake']),
        'is_running': True,
        'reply_markup': keyboard
    })
    user_data['snake_game'] = game

    msg = await update.message.reply_text(
        f"–°—á–µ—Ç: 0\n{render_grid(game['snake'], game['food'])}",
        reply_markup=game['reply_markup']
    )
    game['message_id'] = msg.message_id
    game['task'] = asyncio.create_task(snake_loop(update, context))

async def snake_loop(update: Update, context: ContextTypes.DEFAULT_TYPE):
    game = context.user_data.get('snake_game')
    if not game:
        return

    chat_id = update.effective_chat.id
    message_id = game['message_id']

    while game['is_running']:
        await asyncio.sleep(0.7)  # –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏

        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –Ω–æ–≤—É—é –ø–æ–∑–∏—Ü–∏—é –≥–æ–ª–æ–≤—ã
        head = game['snake'][0]
        dx, dy = DIRECTIONS[game['direction']]
        new_head = (head[0] + dx, head[1] + dy)

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å–æ —Å—Ç–µ–Ω–æ–π –∏–ª–∏ —Å —Å–æ–±–æ–π
        if (new_head in game['snake']
            or not (0 <= new_head[0] < GRID_SIZE)
            or not (0 <= new_head[1] < GRID_SIZE)):
            await game_over(context, chat_id, message_id, "–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! üíÄ")
            return

        # –î–≤–∏–≥–∞–µ–º –∑–º–µ–π–∫—É
        game['snake'].insert(0, new_head)
        if new_head == game['food']:
            game['score'] += 1
            game['food'] = generate_food(game['snake'])
        else:
            game['snake'].pop()

        # –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        try:
            await context.bot.edit_message_text(
                chat_id=chat_id,
                message_id=message_id,
                text=f"–°—á–µ—Ç: {game['score']}\n{render_grid(game['snake'], game['food'])}",
                reply_markup=game['reply_markup']  # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
            )
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {e}")
            await game_over(context, chat_id, message_id, "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–≥—Ä—ã üò¢")
            return

async def handle_controls(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    game = context.user_data.get('snake_game')
    if not game or not game['is_running']: return

    if query.data == 'snake_exit':
        await game_over(context, query.message.chat_id, query.message.message_id, "–ò–≥—Ä–∞ –ø—Ä–µ—Ä–≤–∞–Ω–∞")
        return

    new_dir = query.data.split('_')[1]
    current = game['direction']
    opposite = {'up':'down', 'down':'up', 'left':'right', 'right':'left'}

    if new_dir != opposite[current]:
        game['direction'] = new_dir

async def game_over(context, chat_id, message_id, reason):
    game = context.user_data.get('snake_game')
    if not game:
        return

    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–≥—Ä—É
    game['is_running'] = False

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    final_text = (
        f"üèÅ {reason}\n"
        f"‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n"
        f"üèÜ –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—á–µ—Ç: {game['score']}\n"
        f"üêç –î–ª–∏–Ω–∞ –∑–º–µ–∏: {len(game['snake'])}\n"
        f"üçì –°—ä–µ–¥–µ–Ω–æ —è–≥–æ–¥: {game['score']}\n"
        f"‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n"
        "–°–ø–∞—Å–∏–±–æ –∑–∞ –∏–≥—Ä—É! üéÆ"
    )

    try:
        # –£–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∏–≥—Ä—ã
        await context.bot.edit_message_text(
            chat_id=chat_id,
            message_id=message_id,
            text=final_text,
            reply_markup=None  # –Ø–≤–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        )
    except Exception as e:
        # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
        logging.error(f"–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã: {e}")
        await context.bot.send_message(
            chat_id=chat_id,
            text=final_text,
            reply_markup=None
        )

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∏–∫–µ—Ä
    await context.bot.send_sticker(
        chat_id=chat_id,
        sticker=STICKER_END
    )

    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
    if 'snake_game' in context.user_data:
        del context.user_data['snake_game']


# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤
WAITING_FOR_TIME, WAITING_FOR_PRICE = range(2)
# –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω–æ–≥–æ —Ä–µ–º–æ–Ω—Ç–∞ –∏ –∑–∞–¥–µ—Ä–∂–∫–∏
CHOOSE_WARRANTY_TYPE, ENTER_DELAY_REASON = range(2)



async def morning_reminder(context):
    admin_id = "6493147878"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    morning_message = "–£—Ç—Ä–µ–Ω–Ω–∏–π —á–µ–∫-–ª–∏—Å—Ç:\n- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ê–ö–ë\n- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–∏—Å—Ç–æ—Ç—É —Ä–∞–±–æ—á–µ–≥–æ –º–µ—Å—Ç–∞\n- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—á–µ—Ç –±–æ—Ç–∞\n- –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤\n- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–∏—Å—Ç–æ—Ç—É –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤"
    await context.bot.send_message(chat_id=admin_id, text=morning_message)

async def evening_reminder(context):
    manager_id = "752012766"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ ID –º–µ–Ω–µ–¥–∂–µ—Ä–∞
    evening_message = "–î–æ –∫–æ–Ω—Ü–∞ —Å–º–µ–Ω—ã –æ—Å—Ç–∞–ª—Å—è —á–∞—Å. –ù–µ –∑–∞–±—É–¥—å:\n- –ó–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç–µ\n- –ü—Ä–∏–±—Ä–∞—Ç—å—Å—è –Ω–∞ —Ä–∞–±–æ—á–µ–º –º–µ—Å—Ç–µ"
    await context.bot.send_message(chat_id=manager_id, text=evening_message)

async def send_test_notification(update, context):
    chat_id = update.effective_chat.id
    test_message = "–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ! –°–∏—Å—Ç–µ–º–∞ –æ–ø–æ–≤–µ—â–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ."
    await context.bot.send_message(chat_id=chat_id, text=test_message)

    # –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ
    await update.message.reply_text("–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!")

WAITING_FOR_ADMIN_MESSAGE = 100
async def smska_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º."""
    await update.message.reply_text(
        "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º:"
    )
    return WAITING_FOR_ADMIN_MESSAGE

async def send_message_to_admins(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤–≤–µ–¥–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º."""
    message_text = update.message.text
    user = update.effective_user

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ
    admin_message = f"üì© –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.full_name} (ID: {user.id}):\n\n{message_text}"

    # –°—á–µ—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    sent_count = 0

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∂–¥–æ–º—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
    for admin_id in ADMIN_IDS:
        try:
            await context.bot.send_message(chat_id=admin_id, text=admin_message)
            sent_count += 1
        except Exception as e:
            # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –µ—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É {admin_id}: {e}")

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
    await update.message.reply_text(
        f"–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {sent_count} –∏–∑ {len(ADMIN_IDS)} –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤."
    )

    return ConversationHandler.END

# –í–°–¢–ê–í–¨–¢–ï –í–ï–°–¨ –≠–¢–û–¢ –ë–õ–û–ö –ö–û–î–ê –ù–ê –ú–ï–°–¢–û –£–î–ê–õ–ï–ù–ù–´–• –§–£–ù–ö–¶–ò–ô

# --- –ù–û–í–ê–Ø –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê –î–û–ë–ê–í–õ–ï–ù–ò–Ø –¢–û–í–ê–†–û–í ---



# ==============================================================================
# –ù–ê–ß–ê–õ–û –ë–õ–û–ö–ê: –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –ú–û–î–£–õ–¨ –î–û–ë–ê–í–õ–ï–ù–ò–Ø –¢–û–í–ê–†–û–í
# (–ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–µ add_part_handler –∏ add_product_handler)
# ==============================================================================

import sqlite3
import json
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes, ConversationHandler

# --- –ù–æ–≤—ã–µ, —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ ---
(
    SELECT_PRODUCT_TYPE, 
    ENTER_NAME, 
    ENTER_DESCRIPTION, 
    AWAIT_PHOTO, 
    ENTER_QUANTITY,
    # –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞
    ENTER_RENT_PRICES,
    ENTER_BUYOUT_TOTAL_PAYMENTS,
    ENTER_BUYOUT_PAYMENT_AMOUNT,
    ENTER_BUYOUT_PERIOD_DAYS,
    # –°—Ç–∞—Ä–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ê–ö–ë
    ENTER_BATTERY_DETAILS 
) = range(800, 810) # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

async def start_add_product(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 1: –°–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ç–∏–ø —Ç–æ–≤–∞—Ä–∞."""
    user_id = update.message.from_user.id
    if not is_admin(user_id):
        await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
        return ConversationHandler.END

    keyboard = [
        [InlineKeyboardButton("üö≤ –í–µ–ª–æ—Å–∏–ø–µ–¥", callback_data=f"add_type_{PRODUCT_TYPE_BIKE}")],
        [InlineKeyboardButton("üîã –ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä", callback_data=f"add_type_{PRODUCT_TYPE_BATTERY}")],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="add_type_cancel")]
    ]
    await update.message.reply_text("–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ç–æ–≤–∞—Ä–∞:", reply_markup=InlineKeyboardMarkup(keyboard))
    return SELECT_PRODUCT_TYPE

async def select_product_type(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 2: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–∏–ø –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ."""
    query = update.callback_query
    await query.answer()
    product_type = query.data.split('_')[-1]
    if product_type == 'cancel':
        await query.edit_message_text("–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
        context.user_data.clear()
        return ConversationHandler.END

    context.user_data['product_type'] = product_type
    type_rus = "–≤–µ–ª–æ—Å–∏–ø–µ–¥–∞" if product_type == PRODUCT_TYPE_BIKE else "–∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞"
    await query.edit_message_text(f"–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ/–º–æ–¥–µ–ª—å {type_rus}:")
    return ENTER_NAME

async def get_product_name(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 3: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ."""
    context.user_data['name'] = update.message.text
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:")
    return ENTER_DESCRIPTION

async def get_product_description(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 4: –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ–ø–∏—Å–∞–Ω–∏–µ –∏ —Ä–µ—à–∞–µ—Ç, —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ."""
    context.user_data['description'] = update.message.text
    product_type = context.user_data.get('product_type')

    if product_type == PRODUCT_TYPE_BIKE:
        await update.message.reply_text(
            "üí∞ *–¢–∞—Ä–∏—Ñ—ã –∞—Ä–µ–Ω–¥—ã*\n\n"
            "–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—ã –¥–ª—è –∞—Ä–µ–Ω–¥—ã –Ω–∞ *7, 14 –∏ 30 –¥–Ω–µ–π* —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª.\n\n"
            "*–ü—Ä–∏–º–µ—Ä:* `3500 6500 12000`",
            parse_mode="Markdown"
        )
        return ENTER_RENT_PRICES
    else: # –î–ª—è –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞
        await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ '–ù–∞–ø—Ä—è–∂–µ–Ω–∏–µ,–ï–º–∫–æ—Å—Ç—å' (–ü—Ä–∏–º–µ—Ä: 60V,21Ah):")
        return ENTER_BATTERY_DETAILS

# --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤–µ—Ç–∫–∏ –í–ï–õ–û–°–ò–ü–ï–î–ê ---

async def get_rent_prices(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 5 (–í–µ–ª–æ—Å–∏–ø–µ–¥): –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ü–µ–Ω—ã –∞—Ä–µ–Ω–¥—ã, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–ª–∞–Ω –≤—ã–∫—É–ø–∞."""
    try:
        prices = [float(p) for p in update.message.text.split()]
        if len(prices) != 3: raise ValueError
        context.user_data['rent_prices'] = prices
    except ValueError:
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞. –í–≤–µ–¥–∏—Ç–µ *3 —á–∏—Å–ª–∞* —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.", parse_mode="Markdown")
        return ENTER_RENT_PRICES

    await update.message.reply_text(
        "üí∞ *–ü–ª–∞–Ω –≤—ã–∫—É–ø–∞*\n\n"
        "–í–≤–µ–¥–∏—Ç–µ *–æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ* –ø–ª–∞—Ç–µ–∂–µ–π –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –≤—ã–∫—É–ø–∞:",
        parse_mode="Markdown"
    )
    return ENTER_BUYOUT_TOTAL_PAYMENTS

async def get_buyout_total_payments(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 6 (–í–µ–ª–æ—Å–∏–ø–µ–¥): –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–æ–ª-–≤–æ –ø–ª–∞—Ç–µ–∂–µ–π, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å—É–º–º—É."""
    try:
        context.user_data['buyout_total_payments'] = int(update.message.text)
        await update.message.reply_text("–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ *—Å—É–º–º—É –æ–¥–Ω–æ–≥–æ* –ø–ª–∞—Ç–µ–∂–∞ –≤ —Ä—É–±–ª—è—Ö:")
        return ENTER_BUYOUT_PAYMENT_AMOUNT
    except ValueError:
        await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ.")
        return ENTER_BUYOUT_TOTAL_PAYMENTS

async def get_buyout_payment_amount(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 7 (–í–µ–ª–æ—Å–∏–ø–µ–¥): –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—É–º–º—É, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å."""
    try:
        context.user_data['buyout_payment_amount'] = float(update.message.text)
        await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ *–ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å* –ø–ª–∞—Ç–µ–∂–µ–π –≤ –¥–Ω—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, `7` –¥–ª—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã—Ö):")
        return ENTER_BUYOUT_PERIOD_DAYS
    except ValueError:
        await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É.")
        return ENTER_BUYOUT_PAYMENT_AMOUNT

async def get_buyout_period(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 8 (–í–µ–ª–æ—Å–∏–ø–µ–¥): –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–µ—Ä–∏–æ–¥, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ."""
    try:
        context.user_data['buyout_period_days'] = int(update.message.text)
        await update.message.reply_text("üî¢ –û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ, —Å–∫–æ–ª—å–∫–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ —ç—Ç–æ–π –º–æ–¥–µ–ª–∏ –≤—ã –¥–æ–±–∞–≤–ª—è–µ—Ç–µ:")
        return ENTER_QUANTITY
    except ValueError:
        await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –¥–Ω–µ–π.")
        return ENTER_BUYOUT_PERIOD_DAYS

# --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤–µ—Ç–∫–∏ –ê–ö–ö–£–ú–£–õ–Ø–¢–û–†–ê ---

async def get_battery_details(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 5 (–ê–ö–ë): –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–µ—Ç–∞–ª–∏, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ."""
    try:
        voltage, capacity = update.message.text.split(',')
        context.user_data['details_json'] = json.dumps({"voltage": voltage.strip(), "capacity": capacity.strip()})
        await update.message.reply_text("üî¢ –í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä–æ–≤:")
        return ENTER_QUANTITY
    except ValueError:
        await update.message.reply_text("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ü—Ä–∏–º–µ—Ä: 60V,21Ah")
        return ENTER_BATTERY_DETAILS

# --- –û–±—â–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---

async def get_product_quantity(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–®–∞–≥ 9 (–û–±—â–∏–π): –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ñ–æ—Ç–æ."""
    try:
        quantity = int(update.message.text)
        if quantity <= 0: raise ValueError
        context.user_data['quantity'] = quantity
        await update.message.reply_text("üì∏ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –¥–ª—è —ç—Ç–æ–π –º–æ–¥–µ–ª–∏:")
        return AWAIT_PHOTO
    except ValueError:
        await update.message.reply_text("üö´ –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (—Ü–µ–ª–æ–µ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ).")
        return ENTER_QUANTITY

async def finalize_product_add(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–§–ò–ù–ê–õ: –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ñ–æ—Ç–æ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ –≤ –ë–î."""
    if not update.message.photo:
        await update.message.reply_text("üö´ –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é.")
        return AWAIT_PHOTO

    photo_id = update.message.photo[-1].file_id
    data = context.user_data
    product_type = data.get('product_type')
    quantity = data.get('quantity', 1)

    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()
    try:
        for _ in range(quantity):
            if product_type == PRODUCT_TYPE_BIKE:
                cursor.execute(
                    """INSERT INTO bikes (name, description, photo_url, type, available, 
                                       rent_price_7d, rent_price_14d, rent_price_30d, 
                                       buyout_total_payments, buyout_payment_amount, buyout_period_days)
                       VALUES (?, ?, ?, ?, 1, ?, ?, ?, ?, ?, ?)""",
                    (
                        data['name'], data['description'], photo_id, product_type,
                        data['rent_prices'][0], data['rent_prices'][1], data['rent_prices'][2],
                        data['buyout_total_payments'], data['buyout_payment_amount'], data['buyout_period_days']
                    )
                )
            else: # –ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä
                cursor.execute(
                    """INSERT INTO bikes (name, description, photo_url, type, details_json, available)
                       VALUES (?, ?, ?, ?, ?, 1)""",
                    (data['name'], data['description'], photo_id, product_type, data.get('details_json'))
                )
        conn.commit()
        type_rus = "–í–µ–ª–æ—Å–∏–ø–µ–¥—ã" if product_type == PRODUCT_TYPE_BIKE else "–ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä—ã"
        await update.message.reply_text(f"‚úÖ –£—Å–ø–µ—à–Ω–æ! {type_rus} '{data['name']}' ({quantity} —à—Ç.) –¥–æ–±–∞–≤–ª–µ–Ω—ã.")
    
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ –≤ –ë–î: {e}", exc_info=True)
        await update.message.reply_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö: {e}")
    finally:
        conn.close()
        context.user_data.clear()
        return ConversationHandler.END

async def cancel_add_product(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û—Ç–º–µ–Ω—è–µ—Ç –¥–∏–∞–ª–æ–≥."""
    if update.callback_query:
        await update.callback_query.edit_message_text("–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    else:
        await update.message.reply_text("–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    context.user_data.clear()
    return ConversationHandler.END

# ==============================================================================
# –ö–û–ù–ï–¶ –ë–õ–û–ö–ê
# ==============================================================================
def get_payment_suffix(count):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ–∫–æ–Ω—á–∞–Ω–∏–µ –¥–ª—è —Å–ª–æ–≤–∞ '–ø–ª–∞—Ç–µ–∂'."""
    if count % 10 == 1 and count % 100 != 11:
        return "–ø–ª–∞—Ç–µ–∂"
    elif 2 <= count % 10 <= 4 and (count % 100 < 10 or count % 100 >= 20):
        return "–ø–ª–∞—Ç–µ–∂–∞"
    else:
        return "–ø–ª–∞—Ç–µ–∂–µ–π"

async def abort_smska(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û—Ç–º–µ–Ω—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏—è."""
    await update.message.reply_text("–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞.")
    return ConversationHandler.END

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ admin_approve_deal –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

# –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£

# –®–ê–ì 2: –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–£ –§–£–ù–ö–¶–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ admin_approve_deal –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ admin_approve_deal –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã —É –≤–∞—Å –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞
import aiosqlite
import json
import os
from datetime import datetime
import asyncio
import random
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton, LabeledPrice
from telegram.ext import ContextTypes

# ==============================================================================
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ ADMIN_APPROVE_DEAL –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
# ==============================================================================

import aiosqlite
import json
import os
import asyncio
import random
from datetime import datetime
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, LabeledPrice
from telegram.ext import ContextTypes, ConversationHandler

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ –≤–∞—à–µ–º –∫–æ–¥–µ:
# async def generate_contract_docx(...) -> str: ...
# async def client_handle_signature(...) -> int: ...
# def parse_bike_name_and_vin(full_name: str) -> dict: ...

async def admin_approve_deal(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –ò –ü–û–õ–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –û–ë–†–ê–ë–û–¢–ö–ò –ó–ê–Ø–í–û–ö:
    1.  –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ –∫–Ω–æ–ø–∫–µ "–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞—è–≤–∫—É".
    2.  –ü–æ—à–∞–≥–æ–≤–æ –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∏ –Ω–æ–º–µ—Ä–∞—Ö –±–∞—Ç–∞—Ä–µ–π.
    3.  –ü–æ–ª—É—á–∞–µ—Ç –ò–ù–î–ò–í–ò–î–£–ê–õ–¨–ù–´–ï —Ç–∞—Ä–∏—Ñ—ã (–∞—Ä–µ–Ω–¥–∞/–≤—ã–∫—É–ø) –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞.
    4.  –§–æ—Ä–º–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ —Å—á–µ—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–∏—Ö —Ç–∞—Ä–∏—Ñ–æ–≤.
    5.  –í—ã–∑—ã–≤–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é `generate_contract_docx` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞.
    6.  –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–æ–≥–æ–≤–æ—Ä –∫–ª–∏–µ–Ω—Ç—É –Ω–∞ –ø–æ–¥–ø–∏—Å—å (–∞–∫—Ü–µ–ø—Ç).
    7.  –£–≤–µ–¥–æ–º–ª—è–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ.
    """
    user_data = context.user_data
    
    # --- –®–∞–≥ 1: –ê–¥–º–∏–Ω –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É "–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞—è–≤–∫—É" ---
    if update.callback_query:
        query = update.callback_query
        await query.answer()
        
        # –û—á–∏—â–∞–µ–º user_data –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–µ—Å—Å–∏–π
        user_data.clear()
        
        booking_id = int(query.data.split('_')[1])
        user_data['processing_booking_id'] = booking_id
        
        await query.edit_message_text(
            f"‚öôÔ∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞—è–≤–∫–∏ #{booking_id}.\n\n"
            "–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞—Ç–∞—Ä–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–¥–∞—é—Ç—Å—è —Å –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1 –∏–ª–∏ 2):"
        )
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –±–æ—Ç –æ–∂–∏–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç –∞–¥–º–∏–Ω–∞
        user_data['awaiting_admin_input'] = 'battery_count'
        return # –í—ã—Ö–æ–¥–∏–º, –∂–¥–µ–º –æ—Ç–≤–µ—Ç–∞ –∞–¥–º–∏–Ω–∞

    # --- –®–∞–≥–∏ 2 –∏ 3: –ê–¥–º–∏–Ω –ø—Ä–∏—Å–ª–∞–ª —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–ª–∏ –Ω–æ–º–µ—Ä–∞ –±–∞—Ç–∞—Ä–µ–π) ---
    elif update.message and user_data.get('awaiting_admin_input'):
        
        # –®–∞–≥ 2: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–∞—Ç–∞—Ä–µ–π
        if user_data['awaiting_admin_input'] == 'battery_count':
            try:
                count = int(update.message.text.strip())
                if not (0 <= count <= 4): raise ValueError
                user_data['battery_count'] = count
            except ValueError:
                await update.message.reply_text("‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 4.")
                return # –û—Å—Ç–∞–µ–º—Å—è –≤ —Ç–æ–º –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–∏

            if count == 0:
                user_data['battery_numbers'] = []
                await update.message.reply_text("‚è≥ –ë–∞—Ç–∞—Ä–µ–π –Ω–µ—Ç. –ì–µ–Ω–µ—Ä–∏—Ä—É—é –¥–æ–≥–æ–≤–æ—Ä –∏ —Å—á–µ—Ç...")
                del user_data['awaiting_admin_input'] # –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–ø—Ä–æ—Å
            else:
                await update.message.reply_text(f"‚úçÔ∏è –û—Ç–ª–∏—á–Ω–æ. –¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ —Å–µ—Ä–∏–π–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –¥–ª—è {count} –±–∞—Ç–∞—Ä–µ–π, –∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏:")
                user_data['awaiting_admin_input'] = 'battery_numbers'
                return # –í—ã—Ö–æ–¥–∏–º, –∂–¥–µ–º —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞

        # –®–∞–≥ 3: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –Ω–æ–º–µ—Ä–∞ –±–∞—Ç–∞—Ä–µ–π
        elif user_data['awaiting_admin_input'] == 'battery_numbers':
            battery_numbers_text = update.message.text or ""
            battery_numbers = [num.strip() for num in battery_numbers_text.strip().split('\n') if num.strip()]
            required_count = user_data.get('battery_count', 0)

            if len(battery_numbers) != required_count:
                await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞: –≤—ã –≤–≤–µ–ª–∏ {len(battery_numbers)} –Ω–æ–º–µ—Ä–æ–≤, –∞ –Ω—É–∂–Ω–æ –±—ã–ª–æ {required_count}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:")
                return # –û—Å—Ç–∞–µ–º—Å—è –≤ —Ç–æ–º –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
            
            user_data['battery_numbers'] = battery_numbers
            await update.message.reply_text("‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±—Ä–∞–Ω—ã. –ì–µ–Ω–µ—Ä–∏—Ä—É—é –¥–æ–≥–æ–≤–æ—Ä –∏ –≤—ã—Å—Ç–∞–≤–ª—è—é —Å—á–µ—Ç...")
            del user_data['awaiting_admin_input'] # –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–ø—Ä–æ—Å

    # --- –®–∞–≥ 4: –§–ò–ù–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞) ---
    # –≠—Ç–æ—Ç –±–ª–æ–∫ –∫–æ–¥–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –∞–¥–º–∏–Ω–∞ –±—É–¥—É—Ç —Å–æ–±—Ä–∞–Ω—ã
    
    booking_id = user_data.get('processing_booking_id')
    if not booking_id: 
        # –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
        return

    admin_chat_id = update.effective_chat.id
    battery_count = user_data.get('battery_count', 0)
    battery_numbers = user_data.get('battery_numbers', [])

    try:
        # --- –°–±–æ—Ä –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ë–î –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º ---
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            cursor = await conn.execute(
                """SELECT 
                       b.user_id, b.bike_id, b.end_date, b.booking_date, b.booking_type,
                       u.phone_number, u.passport_data, u.first_name, u.last_name,
                       m.name as model_name,
                       m.rent_price_7d, m.rent_price_14d, m.rent_price_30d,
                       m.buyout_total_payments, m.buyout_payment_amount, m.buyout_period_days
                   FROM bookings b
                   JOIN users u ON b.user_id = u.id
                   JOIN bikes m ON b.bike_id = m.id
                   WHERE b.id=?
                """, (booking_id,)
            )
            data = await cursor.fetchone()

        if not data: 
            raise ValueError(f"–ó–∞—è–≤–∫–∞ #{booking_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞.")

        booking_type = data['booking_type']
        
        # --- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–ª–æ–≤–∞—Ä–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ ---
        passport_data = json.loads(data['passport_data']) if data and data['passport_data'] else {}
        user_data_for_doc = {
            'full_name': f"{passport_data.get('–§–∞–º–∏–ª–∏—è', '')} {passport_data.get('–ò–º—è', '')} {passport_data.get('–û—Ç—á–µ—Å—Ç–≤–æ', '')}".strip(),
            'ending': '—ã–π' if passport_data.get('–ü–æ–ª', '').upper().startswith('–ú–£–ñ') else '–∞—è',
            'passport_series': passport_data.get('–°–µ—Ä–∏—è –∏ –Ω–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞', '____ ______').split(' ')[0],
            'passport_number': passport_data.get('–°–µ—Ä–∏—è –∏ –Ω–æ–º–µ—Ä –ø–∞—Å–ø–æ—Ä—Ç–∞', '____ ______').split(' ')[-1],
            'passport_issued_by': passport_data.get('–ö–µ–º –≤—ã–¥–∞–Ω', '_________________'),
            'address': passport_data.get('–ê–¥—Ä–µ—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', '_________________'),
            'initials': f"{passport_data.get('–§–∞–º–∏–ª–∏—è', ' ')} {passport_data.get('–ò–º—è', ' ')[0]}.{passport_data.get('–û—Ç—á–µ—Å—Ç–≤–æ', ' ')[0]}."
        }
        
        parsed_bike_info = parse_bike_name_and_vin(data['model_name'])
        bike_data_for_doc = {
            'model': parsed_bike_info['model'], 
            'vin': parsed_bike_info['vin'],
            'batteries_count': str(battery_count), 
            'battery_numbers': battery_numbers
        }
        
        deal_info_for_doc = {}

        # --- –õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–æ–≤ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –¥–∞–Ω–Ω—ã—Ö –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ ---
        if booking_type == 'rent':
            days = (datetime.strptime(data['end_date'], '%d.%m.%Y') - datetime.strptime(data['booking_date'], '%d.%m.%Y')).days
            price_to_pay = data[f'rent_price_{days}d']
            if price_to_pay is None or price_to_pay <= 0: 
                raise ValueError(f"–î–ª—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ ID {data['bike_id']} –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Ü–µ–Ω–∞ –Ω–∞ {days} –¥–Ω–µ–π.")
            deal_info_for_doc = {'price': int(price_to_pay)}

        elif booking_type == 'buyout':
            price_to_pay = data['buyout_payment_amount']
            total_payments = data['buyout_total_payments']
            if not price_to_pay or price_to_pay <= 0 or not total_payments or total_payments <= 0:
                raise ValueError(f"–î–ª—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ ID {data['bike_id']} –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø–ª–∞–Ω –≤—ã–∫—É–ø–∞.")
                
            deal_info_for_doc = {
                'total_price': int(total_payments * price_to_pay),
                'weekly_payment': int(price_to_pay),
                'weeks_count': int(total_payments),
            }
        else:
            raise ValueError(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–¥–µ–ª–∫–∏: {booking_type}")
            
        # --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ ---
        file_path = generate_contract_docx(
            booking_id=booking_id, deal_type=booking_type, deal_data=deal_info_for_doc,
            user_data=user_data_for_doc, bike_data=bike_data_for_doc
        )
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–ø–∏–∏ –∞–¥–º–∏–Ω—É
        with open(file_path, 'rb') as doc_file:
            await context.bot.send_document(admin_chat_id, doc_file, caption=f"–ö–æ–ø–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞ –¥–ª—è –∑–∞—è–≤–∫–∏ #{booking_id}")
        
        user_id = data['user_id']
        keyboard_client = [[
            InlineKeyboardButton("‚úÖ –ü—Ä–∏–Ω–∏–º–∞—é –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞—é", callback_data=f"client_sign_{booking_id}"),
            InlineKeyboardButton("‚ùå –û—Ç–∫–∞–∑–∞—Ç—å—Å—è", callback_data=f"client_decline_{booking_id}")
        ]]
        caption_for_client = (
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –¥–æ–≥–æ–≤–æ—Ä–æ–º.\n\n"
            "‚ö†Ô∏è –ù–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ ¬´–ü—Ä–∏–Ω–∏–º–∞—é –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞—é¬ª –Ω–∏–∂–µ —è–≤–ª—è–µ—Ç—Å—è –ø–æ–ª–Ω—ã–º –∏ –±–µ–∑–æ–≥–æ–≤–æ—Ä–æ—á–Ω—ã–º –ø—Ä–∏–Ω—è—Ç–∏–µ–º (–∞–∫—Ü–µ–ø—Ç–æ–º) "
            "–≤—Å–µ—Ö —É—Å–ª–æ–≤–∏–π –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ —Ä–∞–≤–Ω–æ—Å–∏–ª—å–Ω–æ –µ–≥–æ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—é."
        )
        
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ –∫–ª–∏–µ–Ω—Ç—É
        with open(file_path, 'rb') as doc_file:
            await context.bot.send_document(
                chat_id=user_id, 
                document=doc_file, 
                caption=caption_for_client, 
                reply_markup=InlineKeyboardMarkup(keyboard_client)
            )
        
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        os.remove(file_path)

        await context.bot.send_message(admin_chat_id, f"‚úÖ –î–æ–≥–æ–≤–æ—Ä –¥–ª—è –∑–∞—è–≤–∫–∏ #{booking_id} —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ —Ç–∞—Ä–∏—Ñ–∞–º–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–ª–∏–µ–Ω—Ç—É –¥–ª—è –∞–∫—Ü–µ–ø—Ç–∞.")

    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ admin_approve_deal: {e}", exc_info=True)
        await context.bot.send_message(admin_chat_id, f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞—è–≤–∫–∏: {e}")
    finally:
        # –û—á–∏—â–∞–µ–º user_data –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏
        user_data.clear()
# –®–ê–ì 3 –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô: –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ client_handle_signature –ù–ê –≠–¢–£
from telegram import BotCommand, BotCommandScopeChat, BotCommandScopeDefault

async def post_init(application: Application):
    """–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–∞–Ω–¥."""
    
    # --- –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –û–ë–´–ß–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ---
    default_commands = [
        BotCommand("start", "üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é")
    ]
    await application.bot.set_my_commands(default_commands, scope=BotCommandScopeDefault())
    logger.info("–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.")

    # --- –ö–æ–º–∞–Ω–¥—ã –¢–û–õ–¨–ö–û –î–õ–Ø –ê–î–ú–ò–ù–û–í ---
    admin_commands = [
        BotCommand("start", "üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ / –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"),
        BotCommand("cancel", "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ"), # <-- –î–û–ë–ê–í–õ–ï–ù–ê –ù–û–í–ê–Ø –ö–û–ú–ê–ù–î–ê
        BotCommand("edit_user", "üë§ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"),
        BotCommand("smska", "üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º")
    ]
    
    for admin_id in ADMIN_IDS:
        try:
            await application.bot.set_my_commands(admin_commands, scope=BotCommandScopeChat(chat_id=admin_id))
            logger.info(f"–ê–¥–º–∏–Ω—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è ID: {admin_id}")
        except Exception as e:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∞–¥–º–∏–Ω–∞ {admin_id}: {e}")

# ==============================================================================
#           –ù–û–í–´–ô –ú–û–î–£–õ–¨: –ï–ñ–ï–î–ù–ï–í–ù–´–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –û–ë –û–ü–õ–ê–¢–ï
# ==============================================================================

async def check_payment_reminders(context: ContextTypes.DEFAULT_TYPE) -> None:
    """
    –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 20:00 –ú–°–ö –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–¥–µ–ª–∫–∏:
    - –£–≤–µ–¥–æ–º–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –∞–¥–º–∏–Ω–æ–≤ –æ –ø–ª–∞—Ç–µ–∂–∞—Ö, –¥–æ –∫–æ—Ç–æ—Ä—ã—Ö –æ—Å—Ç–∞–ª–æ—Å—å <= 3 –¥–Ω—è.
    - –£–≤–µ–¥–æ–º–ª—è–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –∞–¥–º–∏–Ω–æ–≤ –æ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–∞—Ö.
    """
    logging.info("üöÄ [–ï–ñ–ï–î–ù–ï–í–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê] –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ä–æ–∫–æ–≤ –æ–ø–ª–∞—Ç—ã...")
    
    # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–∫–ª–æ–Ω–µ–Ω–∏—è —Å–ª–æ–≤–∞ "–¥–µ–Ω—å"
    def get_day_suffix(days: int) -> str:
        days = abs(days)
        if days % 10 == 1 and days % 100 != 11:
            return "–¥–µ–Ω—å"
        elif 2 <= days % 10 <= 4 and (days % 100 < 10 or days % 100 >= 20):
            return "–¥–Ω—è"
        return "–¥–Ω–µ–π"

    admin_reminders = []  # –°–ø–∏—Å–æ–∫ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω–∞–º –æ —Å–∫–æ—Ä—ã—Ö –æ–ø–ª–∞—Ç–∞—Ö
    admin_overdue = []    # –°–ø–∏—Å–æ–∫ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω–∞–º –æ –ø—Ä–æ—Å—Ä–æ—á–∫–∞—Ö

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            cursor = await conn.execute("""
                SELECT 
                    b.user_id, b.booking_type, b.end_date, b.next_payment_date,
                    u.first_name, u.last_name,
                    bk.name as bike_name
                FROM bookings b
                JOIN users u ON b.user_id = u.id
                JOIN bikes bk ON b.bike_id = bk.id
                WHERE b.status = 'rented'
            """)
            active_deals = await cursor.fetchall()
        
        logging.info(f"[–ü–†–û–í–ï–†–ö–ê] –ù–∞–π–¥–µ–Ω–æ {len(active_deals)} –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–¥–µ–ª–æ–∫.")
        today = datetime.now().date()

        for deal in active_deals:
            relevant_date_str = None
            deal_type_rus = ""
            
            if deal['booking_type'] == 'rent':
                relevant_date_str = deal['end_date']
                deal_type_rus = "–∞—Ä–µ–Ω–¥—ã"
            elif deal['booking_type'] == 'buyout':
                relevant_date_str = deal['next_payment_date']
                deal_type_rus = "–ø–ª–∞—Ç–µ–∂–∞ –ø–æ –≤—ã–∫—É–ø—É"

            if not relevant_date_str:
                continue

            try:
                payment_date = datetime.strptime(relevant_date_str, "%d.%m.%Y").date()
                days_remaining = (payment_date - today).days
                client_name = f"{deal['first_name']} {deal['last_name'] or ''}".strip()
                
                # --- –õ–æ–≥–∏–∫–∞ –¥–ª—è —Å–∫–æ—Ä—ã—Ö –æ–ø–ª–∞—Ç (3 –¥–Ω—è, 2, 1, 0) ---
                if 0 <= days_remaining <= 3:
                    time_left = "—Å–µ–≥–æ–¥–Ω—è" if days_remaining == 0 else f"—á–µ—Ä–µ–∑ {days_remaining} {get_day_suffix(days_remaining)}"
                    
                    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
                    client_message = (
                        f"üîî *–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ–± –æ–ø–ª–∞—Ç–µ*\n\n"
                        f"–£–≤–∞–∂–∞–µ–º—ã–π(–∞—è) {client_name}, –Ω–∞–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ —Å—Ä–æ–∫ –≤–∞—à–µ–π {deal_type_rus} "
                        f"–≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ ¬´{deal['bike_name']}¬ª –∏—Å—Ç–µ–∫–∞–µ—Ç *{time_left}* ({payment_date.strftime('%d.%m.%Y')}).\n\n"
                        f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–µ –∑–∞–±—É–¥—å—Ç–µ –ø—Ä–æ–¥–ª–∏—Ç—å –∞—Ä–µ–Ω–¥—É –∏–ª–∏ –≤–Ω–µ—Å—Ç–∏ –ø–ª–∞—Ç–µ–∂. –≠—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤ —Ä–∞–∑–¥–µ–ª–µ 'üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç'."
                    )
                    await context.bot.send_message(chat_id=deal['user_id'], text=client_message, parse_mode="Markdown")

                    # –ó–∞–ø–∏—Å—å –¥–ª—è –∞–¥–º–∏–Ω–∞
                    admin_reminders.append(f"‚Ä¢ {client_name} - ¬´{deal['bike_name']}¬ª - –æ–ø–ª–∞—Ç–∞ *{time_left}*")

                # --- –õ–æ–≥–∏–∫–∞ –¥–ª—è –ø—Ä–æ—Å—Ä–æ—á–µ–∫ ---
                elif days_remaining < 0:
                    overdue_days = abs(days_remaining)
                    
                    # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
                    client_message = (
                        f"üö® *–ü–†–û–°–†–û–ß–ö–ê –û–ü–õ–ê–¢–´*\n\n"
                        f"–£–≤–∞–∂–∞–µ–º—ã–π(–∞—è) {client_name}, –ø–æ –≤–∞—à–µ–π {deal_type_rus} "
                        f"–≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ ¬´{deal['bike_name']}¬ª –∏–º–µ–µ—Ç—Å—è –ø—Ä–æ—Å—Ä–æ—á–∫–∞ –Ω–∞ *{overdue_days} {get_day_suffix(overdue_days)}*.\n\n"
                        f"–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å—Ä–æ—á–Ω–æ –≤–Ω–µ—Å–∏—Ç–µ –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ 'üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç' –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π!"
                    )
                    await context.bot.send_message(chat_id=deal['user_id'], text=client_message, parse_mode="Markdown")
                    
                    # –ó–∞–ø–∏—Å—å –¥–ª—è –∞–¥–º–∏–Ω–∞
                    admin_overdue.append(f"‚Ä¢ {client_name} - ¬´{deal['bike_name']}¬ª - –ø—Ä–æ—Å—Ä–æ—á–∫–∞ *{overdue_days} {get_day_suffix(overdue_days)}*")

            except (ValueError, TypeError) as e:
                logging.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –¥–∞—Ç—É '{relevant_date_str}' –¥–ª—è user_id {deal['user_id']}: {e}")
                continue

        # --- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –∏—Ç–æ–≥–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º ---
        admin_message_parts = ["*–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å–≤–æ–¥–∫–∞ –ø–æ –ø–ª–∞—Ç–µ–∂–∞–º (20:00 –ú–°–ö)*\n"]
        
        if admin_reminders:
            admin_message_parts.append("*‚ö†Ô∏è –ë–ª–∏–∂–∞–π—à–∏–µ –æ–ø–ª–∞—Ç—ã (3 –¥–Ω—è –∏–ª–∏ –º–µ–Ω—å—à–µ):*")
            admin_message_parts.extend(admin_reminders)
        
        if admin_overdue:
            admin_message_parts.append("\n*üö® –ü–†–û–°–†–û–ß–ï–ù–ù–´–ï –ü–õ–ê–¢–ï–ñ–ò:*")
            admin_message_parts.extend(admin_overdue)
            
        if not admin_reminders and not admin_overdue:
            admin_message_parts.append("\n‚úÖ –ù–∞ —Å–µ–≥–æ–¥–Ω—è –ø—Ä–æ—Å—Ä–æ—á–µ–∫ –∏ –±–ª–∏–∂–∞–π—à–∏—Ö –æ–ø–ª–∞—Ç –Ω–µ—Ç.")
        
        final_admin_message = "\n".join(admin_message_parts)
        
        for admin_id in ADMIN_IDS:
            try:
                await context.bot.send_message(chat_id=admin_id, text=final_admin_message, parse_mode="Markdown")
            except Exception as e:
                logging.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–≤–æ–¥–∫—É –∞–¥–º–∏–Ω—É {admin_id}: {e}")
        
        logging.info("[–ü–†–û–í–ï–†–ö–ê] –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ä–æ–∫–æ–≤ –æ–ø–ª–∞—Ç—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.")

    except Exception as e:
        logging.error(f"–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –≤ `check_payment_reminders`: {e}", exc_info=True)

async def client_handle_signature(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø:
    - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–¥–ø–∏—Å—å –¥–æ–≥–æ–≤–æ—Ä–∞ –¥–ª—è —Å–¥–µ–ª–æ–∫ —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ —Ç–∞—Ä–∏—Ñ–∞–º–∏ –∏–∑ –ë–î.
    - –ü–æ–ª—É—á–∞–µ—Ç —Å—É–º–º—É –¥–ª—è –æ–ø–ª–∞—Ç—ã –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –∑–∞–ø–∏—Å–∏ –æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–µ.
    """
    query = update.callback_query
    await query.answer()

    parts = query.data.split('_')
    action = parts[1]
    booking_id = int(parts[2])
    user_id = query.from_user.id

    try:
        try:
            await query.message.delete()
        except Exception as e:
            logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–æ–≥–æ–≤–æ—Ä–æ–º (–∑–∞—è–≤–∫–∞ #{booking_id}): {e}")

        if action == 'decline':
            async with aiosqlite.connect(DB_FILE) as conn:
                await conn.execute("DELETE FROM bookings WHERE id=?", (booking_id,))
                await conn.commit()
            await context.bot.send_message(user_id, "‚ùå –í—ã –æ—Ç–∫–∞–∑–∞–ª–∏—Å—å –æ—Ç —Å–¥–µ–ª–∫–∏. –ó–∞—è–≤–∫–∞ –∞–Ω–Ω—É–ª–∏—Ä–æ–≤–∞–Ω–∞.")
            for admin_id in ADMIN_IDS:
                await context.bot.send_message(admin_id, f"üö® –ö–ª–∏–µ–Ω—Ç (ID: {user_id}) –æ—Ç–∫–∞–∑–∞–ª—Å—è –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä –ø–æ –∑–∞—è–≤–∫–µ #{booking_id}.")
            return ConversationHandler.END

        await context.bot.send_message(user_id, "‚úÖ –î–æ–≥–æ–≤–æ—Ä –ø–æ–¥–ø–∏—Å–∞–Ω! –ì–æ—Ç–æ–≤–ª—é —Å—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É...")

        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            # <<< –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô: –î–æ–±–∞–≤–ª—è–µ–º –≤ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—è —Å —Ç–∞—Ä–∏—Ñ–∞–º–∏ –∏–∑ `bikes` >>>
            cursor = await conn.execute(
                """SELECT b.bike_id, b.end_date, b.booking_date, b.booking_type,
                          u.phone_number, 
                          m.name as model_name,
                          m.rent_price_7d, m.rent_price_14d, m.rent_price_30d,
                          m.buyout_payment_amount
                   FROM bookings b 
                   JOIN users u ON b.user_id = u.id 
                   JOIN bikes m ON b.bike_id = m.id 
                   WHERE b.id=?
                """,
                (booking_id,)
            )
            data = await cursor.fetchone()

        if not data:
            raise ValueError("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–∞.")

        price = 0
        description = ""
        payload = ""

        if data['booking_type'] == 'rent':
            days = (datetime.strptime(data['end_date'], '%d.%m.%Y') - datetime.strptime(data['booking_date'], '%d.%m.%Y')).days
            # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—è `rent_price_*d`
            price = data[f'rent_price_{days}d']
            if price is None or price <= 0:
                raise ValueError(f"–¶–µ–Ω–∞ –¥–ª—è –∞—Ä–µ–Ω–¥—ã –Ω–∞ {days} –¥–Ω–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ '{data['model_name']}'.")
            description = f"–û–ø–ª–∞—Ç–∞ –∞—Ä–µ–Ω–¥—ã '{data['model_name']}' –Ω–∞ {days} –¥–Ω–µ–π"
            payload = f"rental_payment_{booking_id}"
        
        else: # buyout
            # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –ø–µ—Ä–≤–æ–≥–æ –≤–∑–Ω–æ—Å–∞ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –ø–æ–ª—è `buyout_payment_amount`
            price = data['buyout_payment_amount']
            if price is None or price <= 0:
                 raise ValueError(f"–¶–µ–Ω–∞ –¥–ª—è –≤—ã–∫—É–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ '{data['model_name']}'.")
            description = f"–ü–µ—Ä–≤—ã–π –≤–∑–Ω–æ—Å –ø–æ –≤—ã–∫—É–ø—É: {data['model_name']}"
            payload = f"buyout_payment_{booking_id}"
        # <<< –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>

        # --- –î–∞–ª—å–Ω–µ–π—à–∏–π –∫–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ---
        metadata = {'internal_payload': payload, 'user_id': user_id}
        items_for_receipt = [{"description": description, "quantity": "1.00", "amount": { "value": f"{price:.2f}", "currency": "RUB" }, "vat_code": "1", "payment_subject": "service"}]
        payment_info = await create_yookassa_payment(amount=price, description=description, metadata=metadata, items=items_for_receipt, customer_info={"phone": data['phone_number']}, payment_method='sbp')

        if not payment_info:
            await context.bot.send_message(user_id, "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ –æ–ø–ª–∞—Ç—É. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.")
            return ConversationHandler.END

        payment_url, payment_id, final_amount = payment_info['url'], payment_info['id'], payment_info['final_amount']

        keyboard = [[InlineKeyboardButton("üí≥ –û–ø–ª–∞—Ç–∏—Ç—å", url=payment_url)]]
        animated_message = await context.bot.send_message(
            user_id,
            f"–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã {final_amount:.2f} ‚ÇΩ",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )

        if 'pending_payments' not in context.bot_data: context.bot_data['pending_payments'] = {}
        stop_animation_event = asyncio.Event()
        context.bot_data['pending_payments'][payment_id] = {'user_id': user_id, 'start_time': datetime.now(), 'payload': payload, 'amount': final_amount, 'animated_message_id': animated_message.message_id, 'url': payment_url, 'animation_sequence': random.choice(PAYMENT_ANIMATIONS), 'stop_animation_event': stop_animation_event}
        asyncio.create_task(animate_payment_message(context, payment_id))
        context.job_queue.run_repeating(callback=check_payment_status, interval=15, first=10, name=f"payment_{payment_id}", data={'yookassa_id': payment_id})

        return ConversationHandler.END

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ client_handle_signature: {e}", exc_info=True)
        await context.bot.send_message(user_id, f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.")
        return ConversationHandler.END
async def edit_user_back_to_profile(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """
    –ü—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ —ç–∫—Ä–∞–Ω—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è.
    """
    query = update.callback_query
    await query.answer()

    # –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å, –∏—Å–ø–æ–ª—å–∑—É—è –¥–∞–Ω–Ω—ã–µ –∏–∑ context.user_data
    text, markup = await build_profile_for_edit(context)
    await query.edit_message_text(text, reply_markup=markup, parse_mode='Markdown')
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    return EDIT_SELECT_FIELD
async def cancel_deal(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """–û—Ç–º–µ–Ω–∞ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –∫–ª–∏–µ–Ω—Ç–∞."""
    await update.message.reply_text("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    return ConversationHandler.END

# <<< –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê –î–õ–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ò >>>
# <<< –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê –î–õ–Ø EXCEL-–û–¢–ß–ï–¢–û–í >>>
import openpyxl
from openpyxl.styles import Font, Alignment, PatternFill
from openpyxl.utils import get_column_letter

# <<< –ù–ê–ß–ê–õ–û –£–õ–£–ß–®–ï–ù–ù–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê –î–õ–Ø EXCEL-–û–¢–ß–ï–¢–û–í >>>
import openpyxl
from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
from openpyxl.utils import get_column_letter

# <<< –ù–ê–ß–ê–õ–û –§–ò–ù–ê–õ–¨–ù–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê –î–õ–Ø EXCEL-–û–¢–ß–ï–¢–û–í >>>
import openpyxl
from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
from openpyxl.utils import get_column_letter

# <<< –ù–ê–ß–ê–õ–û –§–ò–ù–ê–õ–¨–ù–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê –î–õ–Ø EXCEL-–û–¢–ß–ï–¢–û–í (–í–ï–†–°–ò–Ø 4.0 - –ò–°–¢–û–ß–ù–ò–ö –ü–†–ê–í–î–´: BIKE_HISTORY) >>>
import openpyxl
from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
from openpyxl.utils import get_column_letter

def format_excel_sheet(worksheet, currency_column_indices=[]):
    """–ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∫ –ª–∏—Å—Ç—É Excel."""
    header_font = Font(bold=True, color="FFFFFF", name='Calibri', size=11)
    header_fill = PatternFill(start_color="4F81BD", end_color="4F81BD", fill_type="solid")
    center_align = Alignment(horizontal='center', vertical='center', wrap_text=True)
    left_align = Alignment(horizontal='left', vertical='center', wrap_text=True)
    right_align = Alignment(horizontal='right', vertical='center')
    
    currency_format = '#,##0.00 ‚ÇΩ'
    thin_border = Border(left=Side(style='thin'), right=Side(style='thin'), top=Side(style='thin'), bottom=Side(style='thin'))

    for cell in worksheet[1]:
        cell.font = header_font
        cell.fill = header_fill
        cell.alignment = center_align
        cell.border = thin_border
    worksheet.row_dimensions[1].height = 25

    for i, col in enumerate(worksheet.columns, 1):
        max_length = 0
        column_letter = get_column_letter(i)
        for cell in col:
            if cell.row > 1:
                cell.border = thin_border
                cell.font = Font(name='Calibri', size=11)
                if i - 1 in currency_column_indices:
                    cell.number_format = currency_format
                    cell.alignment = right_align
                else:
                    cell.alignment = left_align
            
            try:
                if len(str(cell.value)) > max_length:
                    max_length = len(str(cell.value))
            except: pass
        
        adjusted_width = (max_length + 4) if max_length < 45 else 47
        worksheet.column_dimensions[column_letter].width = adjusted_width


# <<< –ù–ê–ß–ê–õ–û –§–ò–ù–ê–õ–¨–ù–û–ô –í–ï–†–°–ò–ò –î–õ–Ø –û–¢–ß–ï–¢–ê –ü–û –ê–†–ï–ù–î–ï (V5.0 - –†–ï–í–ï–†–°-–ò–ù–ñ–ò–ù–ò–†–ò–ù–ì –°–†–û–ö–ê) >>>

# <<< –ù–ê–ß–ê–õ–û –§–ò–ù–ê–õ–¨–ù–û–ô –í–ï–†–°–ò–ò –î–õ–Ø –û–¢–ß–ï–¢–ê –ü–û –ê–†–ï–ù–î–ï (V6.0 - –ì–ò–ë–†–ò–î–ù–´–ô –ü–û–ò–°–ö –î–ê–¢) >>>

def _find_rental_period_from_price(model_key: str, price: float) -> int | None:
    """
    –ù–∞—Ö–æ–¥–∏—Ç —Å—Ä–æ–∫ –∞—Ä–µ–Ω–¥—ã –≤ –¥–Ω—è—Ö, —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è—è –º–æ–¥–µ–ª—å –∏ —Ç–æ—á–Ω—É—é —Å—É–º–º—É –ø–ª–∞—Ç–µ–∂–∞
    —Å —Ç–∞—Ä–∏—Ñ–Ω–æ–π —Å–µ—Ç–∫–æ–π RENTAL_PRICES.
    """
    if not model_key:
        return None
    # –ò—â–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ü–µ–Ω—ã
    for key, rent_price in RENTAL_PRICES.items():
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª—é—á —Ç–∞—Ä–∏—Ñ–∞ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ –Ω–∞—à–µ–π –º–æ–¥–µ–ª–∏ –∏ —Ü–µ–Ω–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
        if model_key in key and abs(rent_price - price) < 0.01:
            try:
                # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–Ω–∏ –∏–∑ –∫–ª—é—á–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'kugoo_jl_14' -> 14)
                return int(key.split('_')[-1])
            except (ValueError, IndexError):
                continue
    return None # –ï—Å–ª–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ

def _parse_period_from_details(details: str) -> tuple[str, str] | None:
    """
    –ò—â–µ—Ç –≤ —Å—Ç—Ä–æ–∫–µ 'details' –ø–µ—Ä–∏–æ–¥ –∞—Ä–µ–Ω–¥—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì-–î–î.–ú–ú.–ì–ì–ì–ì.
    """
    if not details:
        return None
    # –ò—â–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω "–ü–µ—Ä–∏–æ–¥: –î–ê–¢–ê-–î–ê–¢–ê"
    match = re.search(r'–ø–µ—Ä–∏–æ–¥:\s*(\d{2}\.\d{2}\.\d{4})\s*-\s*(\d{2}\.\d{2}\.\d{4})', details, re.IGNORECASE)
    if match:
        start_date, end_date = match.groups()
        return start_date, end_date
    return None

# <<< –ù–ê–ß–ê–õ–û –ë–õ–û–ö–ê –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–• EXCEL-–û–¢–ß–ï–¢–û–í (–í–ï–†–°–ò–Ø "–ü–ò–ó–î–ï–¶ –ö–†–ê–°–ò–í–û") >>>
import openpyxl
from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
from openpyxl.utils import get_column_letter

# --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ ---

def _create_main_header(sheet, title: str, col_span: int):
    """–°–æ–∑–¥–∞–µ—Ç –≥–ª–∞–≤–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ—Ç—á–µ—Ç–∞."""
    HEADER_COLOR = "4F81BD" # –¢–µ–º–Ω–æ-—Å–∏–Ω–∏–π
    sheet.merge_cells(start_row=1, start_column=1, end_row=1, end_column=col_span)
    title_cell = sheet['A1']
    title_cell.value = title
    title_cell.font = Font(name='Calibri', size=16, bold=True, color='FFFFFF')
    title_cell.fill = PatternFill(start_color=HEADER_COLOR, end_color=HEADER_COLOR, fill_type='solid')
    title_cell.alignment = Alignment(horizontal='center', vertical='center')
    sheet.row_dimensions[1].height = 40

def _create_subtitle(sheet, col_span: int):
    """–°–æ–∑–¥–∞–µ—Ç –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –¥–∞—Ç–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏."""
    sheet.merge_cells(start_row=2, start_column=1, end_row=2, end_column=col_span)
    subtitle_cell = sheet['A2']
    subtitle_cell.value = f"–û—Ç—á–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω: {datetime.now().strftime('%d %B %Y –≥. –≤ %H:%M')}"
    subtitle_cell.font = Font(name='Calibri', size=10, italic=True, color='595959')
    subtitle_cell.alignment = Alignment(horizontal='center', vertical='center')
    sheet.row_dimensions[2].height = 20

def _format_table_headers(sheet, start_row: int, headers: list):
    """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã."""
    HEADER_COLOR = "4F81BD"
    for col, header in enumerate(headers, 1):
        cell = sheet.cell(row=start_row, column=col)
        cell.value = header
        cell.font = Font(name='Calibri', size=11, bold=True, color='FFFFFF')
        cell.fill = PatternFill(start_color=HEADER_COLOR, end_color=HEADER_COLOR, fill_type='solid')
        cell.alignment = Alignment(horizontal='center', vertical='center', wrap_text=True)
    sheet.row_dimensions[start_row].height = 30

def _format_data_rows_and_autofit(sheet, header_row: int, data_start_row: int, currency_columns: list):
    """
    –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏, –ø—Ä–∏–º–µ–Ω—è–µ—Ç —á–µ—Ä–µ–¥—É—é—â—É—é—Å—è –∑–∞–ª–∏–≤–∫—É –∏ –∞–≤—Ç–æ—à–∏—Ä–∏–Ω—É.
    –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω –∞–ª–≥–æ—Ä–∏—Ç–º —Ä–∞—Å—á–µ—Ç–∞ —à–∏—Ä–∏–Ω—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    –±–æ–ª—å—à–∏—Ö —á–∏—Å–µ–ª, –≤–∞–ª—é—Ç—ã –∏ —É—á–µ—Ç–∞ –¥–ª–∏–Ω—ã –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
    """
    LIGHT_FILL = "DDEBF7"
    WHITE_FILL = "FFFFFF"
    thin_border = Border(left=Side(style='thin', color='BFBFBF'), right=Side(style='thin', color='BFBFBF'),
                         top=Side(style='thin', color='BFBFBF'), bottom=Side(style='thin', color='BFBFBF'))

    column_widths = {}

    # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º —à–∏—Ä–∏–Ω—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    for col_idx, cell in enumerate(sheet[header_row], 1):
        if cell.value:
            column_widths[col_idx] = len(str(cell.value))

    # –®–∞–≥ 2: –û–±–Ω–æ–≤–ª—è–µ–º —à–∏—Ä–∏–Ω—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –æ–Ω–∏ –¥–ª–∏–Ω–Ω–µ–µ
    for r_idx, row in enumerate(sheet.iter_rows(min_row=data_start_row, max_row=sheet.max_row)):
        fill = PatternFill(start_color=LIGHT_FILL if r_idx % 2 == 0 else WHITE_FILL, fill_type='solid')
        for c_idx, cell in enumerate(row, 1):
            cell.fill = fill
            cell.border = thin_border
            cell.font = Font(name='Calibri', size=11)
            
            if c_idx in currency_columns:
                cell.number_format = '#,##0.00 ‚ÇΩ'
                cell.alignment = Alignment(horizontal='right', vertical='center')
            else:
                cell.alignment = Alignment(horizontal='left', vertical='center', wrap_text=True)
            
            if cell.value:
                # –î–ª—è —á–∏—Å–µ–ª –±–µ—Ä–µ–º –¥–ª–∏–Ω—É –∏—Ö —Å—Ç—Ä–æ–∫–æ–≤–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
                if isinstance(cell.value, (int, float)):
                    cell_len = len(f"{cell.value:,.2f}")
                else:
                    cell_len = len(str(cell.value))
                
                # –û–±–Ω–æ–≤–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É
                current_max = column_widths.get(c_idx, 0)
                if cell_len > current_max:
                    column_widths[c_idx] = cell_len

    # –®–∞–≥ 3: –ü—Ä–∏–º–µ–Ω—è–µ–º —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—É—é —à–∏—Ä–∏–Ω—É —Å –∑–∞–ø–∞—Å–æ–º
    for col_idx, width in column_widths.items():
        # –î–ª—è –∫–æ–ª–æ–Ω–æ–∫ —Å –≤–∞–ª—é—Ç–æ–π –¥–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø–∞—Å
        extra_padding = 6 if col_idx in currency_columns else 4
        sheet.column_dimensions[get_column_letter(col_idx)].width = min(width + extra_padding, 50) # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å. —à–∏—Ä–∏–Ω—É


# –®–ê–ì 1: –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ _add_summary_block –ù–ê –≠–¢–£

def _add_summary_block(sheet, total_income: float, num_operations: int, col_span: int):
    """
    –î–æ–±–∞–≤–ª—è–µ—Ç –±–ª–æ–∫ —Å –∏—Ç–æ–≥–∞–º–∏.
    –ò–°–ü–†–ê–í–õ–ï–ù–û: –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Å—Ç–æ–ª–±–µ—Ü —Å –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º–æ–π –±—É–¥–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —à–∏—Ä–æ–∫–∏–º.
    """
    summary_row = sheet.max_row + 2
    
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º —è—á–µ–π–∫–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ "–ò–¢–û–ì–û –ó–ê –ú–ï–°–Ø–¶"
    sheet.merge_cells(start_row=summary_row, start_column=1, end_row=summary_row, end_column=col_span - 1)
    summary_cell = sheet.cell(row=summary_row, column=1, value="–ò–¢–û–ì–û –ó–ê –ú–ï–°–Ø–¶:")
    summary_cell.font = Font(name='Calibri', size=14, bold=True, color="2F5597")
    summary_cell.alignment = Alignment(horizontal='right', vertical='center')
    
    # –Ø—á–µ–π–∫–∞ —Å –∏—Ç–æ–≥–æ–≤–æ–π —Å—É–º–º–æ–π
    total_cell = sheet.cell(row=summary_row, column=col_span, value=total_income)
    total_cell.font = Font(name='Calibri', size=14, bold=True)
    total_cell.number_format = '#,##0.00 ‚ÇΩ'
    total_cell.alignment = Alignment(horizontal='right', vertical='center')

    # === –ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ ===
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é —à–∏—Ä–∏–Ω—É –¥–ª—è –∏—Ç–æ–≥–æ–≤–æ–π —è—á–µ–π–∫–∏ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —à–∏—Ä–∏–Ω—É —Å—Ç–æ–ª–±—Ü–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    total_col_letter = get_column_letter(col_span)
    required_width = len(f"{total_income:,.2f} ‚ÇΩ") + 4 # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∞—Å
    if sheet.column_dimensions[total_col_letter].width < required_width:
        sheet.column_dimensions[total_col_letter].width = required_width

    # –°—Ç—Ä–æ–∫–∞ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π (—Å—Ä–µ–¥–Ω–∏–π —á–µ–∫ –∏ —Ç.–¥.)
    stats_row = summary_row + 1
    sheet.merge_cells(start_row=stats_row, start_column=1, end_row=stats_row, end_column=col_span)
    avg_check = total_income / num_operations if num_operations > 0 else 0
    stats_cell = sheet.cell(row=stats_row, column=1, value=f"–í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π: {num_operations} | –°—Ä–µ–¥–Ω–∏–π —á–µ–∫: {avg_check:,.2f} ‚ÇΩ")
    stats_cell.font = Font(name='Calibri', size=10, italic=True, color='595959')
    stats_cell.alignment = Alignment(horizontal='right')

# --- –§—É–Ω–∫—Ü–∏–∏-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –æ—Ç—á–µ—Ç–æ–≤ ---

async def generate_rent_excel_report(owner_type: str) -> str | None:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é –æ—Ç—á–µ—Ç–∞ –ø–æ –∞—Ä–µ–Ω–¥–µ.
    –ò–ó–ú–ï–ù–ï–ù–û: –ò—Å–∫–ª—é—á–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ "–¢–µ—Å—Ç –¢–µ—Å—Ç–æ–≤" –∏ "–ö–∏—Ä–∏–ª–ª –ü–∞—Ç—Ä—É—à–µ–≤" —Å –ø–æ–º–æ—â—å—é
    "—É–º–Ω–æ–≥–æ" —Ñ–∏–ª—å—Ç—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –ø—Ä–∏ –∫—Ä–∏–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î.
    """
    today = datetime.now()
    start_of_month = today.replace(day=1, hour=0, minute=0, second=0)
    
    owner_filter_sql = ""
    if owner_type == 'own': owner_filter_sql = "AND b.investor_id IS NULL"
    elif owner_type == 'investor': owner_filter_sql = "AND b.investor_id IS NOT NULL"
        
    sql_query = f"""
        SELECT u.first_name, u.last_name, b.name AS bike_name, bh.details, bh.timestamp
        FROM bike_history bh
        JOIN bikes b ON bh.bike_id = b.id
        JOIN users u ON bh.user_id = u.id
        WHERE bh.action IN ('–û–ø–ª–∞—Ç–∞ –∞—Ä–µ–Ω–¥—ã', '–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã', '–ê—Ä–µ–Ω–¥–∞ –¥–æ–ø. –ê–ö–ë', '–ê—Ä–µ–Ω–¥–∞') 
        {owner_filter_sql}
        -- === –ü–£–õ–ï–ù–ï–ü–†–û–ë–ò–í–ê–ï–ú–´–ô –§–ò–õ–¨–¢–†, –ö–û–¢–û–†–´–ô –¢–û–ß–ù–û –†–ê–ë–û–¢–ê–ï–¢ ===
        AND LOWER(TRIM(COALESCE(u.first_name, '') || ' ' || COALESCE(u.last_name, ''))) NOT IN ('—Ç–µ—Å—Ç —Ç–µ—Å—Ç–æ–≤', '–∫–∏—Ä–∏–ª–ª –ø–∞—Ç—Ä—É—à–µ–≤')
    """
    
    report_data = []
    async with aiosqlite.connect(DB_FILE) as conn:
        conn.row_factory = aiosqlite.Row
        async with conn.execute(sql_query) as cursor:
            async for row in cursor:
                try:
                    payment_date_str = row['timestamp']
                    if not payment_date_str: continue 
                    payment_date = datetime.strptime(payment_date_str, '%Y-%m-%d %H:%M:%S')
                    if payment_date < start_of_month: continue
                    
                    income = _get_income_from_details(row['details'])
                    if not income or income == 0: continue

                    start_date_str, end_date_str = 'N/A', 'N/A'
                    period = _parse_period_from_details(row['details'])
                    if period:
                        start_date_str, end_date_str = period
                    else:
                        model_key = get_bike_model_key(row['bike_name'])
                        duration_days = _find_rental_period_from_price(model_key, income)
                        if duration_days:
                            start_date_obj = payment_date
                            end_date_obj = start_date_obj + timedelta(days=duration_days)
                            start_date_str = start_date_obj.strftime('%d.%m.%Y')
                            end_date_str = end_date_obj.strftime('%d.%m.%Y')

                    report_data.append({
                        "client": f"{row['first_name'] or ''} {row['last_name'] or ''}".strip(),
                        "bike_name": row['bike_name'], "income": income, "payment_date": payment_date,
                        "start_date": start_date_str, "end_date": end_date_str,
                    })
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å—Ç—Ä–æ–∫–∏ –æ—Ç—á–µ—Ç–∞ –ø–æ –∞—Ä–µ–Ω–¥–µ: {e}, row: {dict(row)}")
    
    if not report_data: return None

    workbook = openpyxl.Workbook()
    sheet = workbook.active
    sheet.title = "–î–æ—Ö–æ–¥—ã_–ê—Ä–µ–Ω–¥–∞"
    headers = ["üë§ –ö–ª–∏–µ–Ω—Ç", "üö¥ –í–µ–ª–æ—Å–∏–ø–µ–¥", "üí∞ –°—É–º–º–∞", "üìÖ –î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞", "‚ñ∂Ô∏è –ù–∞—á–∞–ª–æ –∞—Ä–µ–Ω–¥—ã", "‚èπÔ∏è –ö–æ–Ω–µ—Ü –∞—Ä–µ–Ω–¥—ã"]
    
    owner_text = {"own": "–Ω–∞—à–∏—Ö", "investor": "–∏–Ω–≤–µ—Å—Ç–æ—Ä—Å–∫–∏—Ö", "all": "–≤—Å–µ—Ö"}
    title = f"–î–æ—Ö–æ–¥—ã –æ—Ç –ê–†–ï–ù–î–´ ({owner_text.get(owner_type, '')} –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤)"
    
    _create_main_header(sheet, title, len(headers))
    _create_subtitle(sheet, len(headers))
    _format_table_headers(sheet, 3, headers)
    
    total_income = 0
    for item in sorted(report_data, key=lambda x: x['payment_date']):
        sheet.append([
            item["client"], item["bike_name"], item["income"],
            item["payment_date"].strftime('%d.%m.%Y %H:%M'),
            item["start_date"], item["end_date"]
        ])
        total_income += item["income"]
        
    _format_data_rows_and_autofit(sheet, header_row=3, data_start_row=4, currency_columns=[3])
    _add_summary_block(sheet, total_income, len(report_data), len(headers))
    
    filename = os.path.join(REPORTS_PATH, f"rent_income_{today.strftime('%Y-%m')}_{owner_type}.xlsx")
    workbook.save(filename)
    return filename


async def generate_buyout_excel_report(owner_type: str) -> str | None:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é –æ—Ç—á–µ—Ç–∞ –ø–æ –≤—ã–∫—É–ø—É.
    –ò–ó–ú–ï–ù–ï–ù–û: –ò—Å–∫–ª—é—á–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ "–¢–µ—Å—Ç –¢–µ—Å—Ç–æ–≤" –∏ "–ö–∏—Ä–∏–ª–ª –ü–∞—Ç—Ä—É—à–µ–≤" —Å –ø–æ–º–æ—â—å—é
    "—É–º–Ω–æ–≥–æ" —Ñ–∏–ª—å—Ç—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –ø—Ä–∏ –∫—Ä–∏–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î.
    """
    today = datetime.now()
    start_of_month = today.replace(day=1, hour=0, minute=0, second=0)

    owner_filter_sql = ""
    if owner_type == 'own': owner_filter_sql = "AND b.investor_id IS NULL"
    elif owner_type == 'investor': owner_filter_sql = "AND b.investor_id IS NOT NULL"
    
    sql_query = f"""
        SELECT u.first_name, u.last_name, b.name AS bike_name, bo.id AS booking_id,
               bo.payment_plan_key, bo.payments_made, bo.next_payment_date
        FROM bookings bo
        JOIN bikes b ON bo.bike_id = b.id
        JOIN users u ON bo.user_id = u.id
        WHERE bo.booking_type = 'buyout' {owner_filter_sql}
        -- === –ü–£–õ–ï–ù–ï–ü–†–û–ë–ò–í–ê–ï–ú–´–ô –§–ò–õ–¨–¢–†, –ö–û–¢–û–†–´–ô –¢–û–ß–ù–û –†–ê–ë–û–¢–ê–ï–¢ ===
        AND LOWER(TRIM(COALESCE(u.first_name, '') || ' ' || COALESCE(u.last_name, ''))) NOT IN ('—Ç–µ—Å—Ç —Ç–µ—Å—Ç–æ–≤', '–∫–∏—Ä–∏–ª–ª –ø–∞—Ç—Ä—É—à–µ–≤')
    """
    
    deals = {}
    async with aiosqlite.connect(DB_FILE) as conn:
        conn.row_factory = aiosqlite.Row
        async with conn.execute(sql_query) as cursor:
            async for row in cursor:
                plan = BUYOUT_PLANS.get(row['payment_plan_key'])
                if not plan: continue

                payments_made = row['payments_made'] or 0
                total_payments = plan.get('total_payments', 0)
                payment_amount = plan.get('first_payment', 0)
                
                deals[row['booking_id']] = {
                    "client": f"{row['first_name'] or ''} {row['last_name'] or ''}".strip(),
                    "bike_name": row['bike_name'], "monthly_income": 0.0,
                    "next_payment": row['next_payment_date'] or '–í–´–ö–£–ü–õ–ï–ù',
                    "payments_made": payments_made, "total_payments": total_payments,
                    "payment_amount": payment_amount, "total_deal_sum": total_payments * payment_amount
                }
        
        income_cursor = await conn.execute(f"""
            SELECT bo.id as booking_id, bh.details FROM bike_history bh
            JOIN bookings bo ON bo.bike_id = bh.bike_id AND bo.user_id = bh.user_id AND bo.booking_type = 'buyout'
            WHERE bh.action IN ('–í—ã–∫—É–ø (1-–π –≤–∑–Ω–æ—Å)', '–ü–ª–∞—Ç–µ–∂ –ø–æ –≤—ã–∫—É–ø—É', '–î–æ—Å—Ä–æ—á–Ω–æ–µ –ø–æ–≥–∞—à–µ–Ω–∏–µ')
            AND bh.timestamp >= ?
        """, (start_of_month.strftime('%Y-%m-%d %H:%M:%S'),))
        
        async for income_row in income_cursor:
            if income_row['booking_id'] in deals:
                income = _get_income_from_details(income_row['details']) or 0.0
                deals[income_row['booking_id']]['monthly_income'] += income

    if not deals: return None

    workbook = openpyxl.Workbook()
    sheet = workbook.active
    sheet.title = "–î–æ—Ö–æ–¥—ã_–í—ã–∫—É–ø"
    headers = ["üë§ –ö–ª–∏–µ–Ω—Ç", "üö¥ –í–µ–ª–æ—Å–∏–ø–µ–¥", "üí∞ –î–æ—Ö–æ–¥ (–º–µ—Å.)", "üìÖ –°–ª–µ–¥. –ø–ª–∞—Ç–µ–∂", "üìä –ü—Ä–æ–≥—Ä–µ—Å—Å", "‚è≥ –û—Å—Ç–∞—Ç–æ–∫ –¥–æ–ª–≥–∞", "üéØ –°—É–º–º–∞ —Å–¥–µ–ª–∫–∏"]
    
    owner_text = {"own": "–Ω–∞—à–∏–º", "investor": "–∏–Ω–≤–µ—Å—Ç–æ—Ä—Å–∫–∏–º", "all": "–≤—Å–µ–º"}
    title = f"–î–æ—Ö–æ–¥—ã –æ—Ç –í–´–ö–£–ü–ê –ø–æ {owner_text.get(owner_type, '')} –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞–º"
    
    _create_main_header(sheet, title, len(headers))
    _create_subtitle(sheet, len(headers))
    _format_table_headers(sheet, 3, headers)
    
    total_monthly_income = 0
    for deal in sorted(deals.values(), key=lambda x: x['monthly_income'], reverse=True):
        payments_left = deal['total_payments'] - deal['payments_made']
        remaining_debt = payments_left * deal['payment_amount']
        
        sheet.append([
            deal["client"], deal["bike_name"], deal["monthly_income"],
            deal["next_payment"], f"{deal['payments_made']} –∏–∑ {deal['total_payments']}",
            remaining_debt if remaining_debt > 0 else 0,
            deal["total_deal_sum"]
        ])
        if deal["monthly_income"] > 0:
            total_monthly_income += deal["monthly_income"]

    _format_data_rows_and_autofit(sheet, header_row=3, data_start_row=4, currency_columns=[3, 6, 7])
    
    active_deals_count = sum(1 for d in deals.values() if d['monthly_income'] > 0)
    _add_summary_block(sheet, total_monthly_income, active_deals_count, len(headers))

    filename = os.path.join(REPORTS_PATH, f"buyout_income_{today.strftime('%Y-%m')}_{owner_type}.xlsx")
    workbook.save(filename)
    return filename



# <<< –ö–û–ù–ï–¶ –§–ò–ù–ê–õ–¨–ù–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê >>>

# <<< –ö–û–ù–ï–¶ –§–ò–ù–ê–õ–¨–ù–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê –î–õ–Ø EXCEL-–û–¢–ß–ï–¢–û–í (–í–ï–†–°–ò–Ø 4.0) >>>

# <<< –ö–û–ù–ï–¶ –§–ò–ù–ê–õ–¨–ù–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê –î–õ–Ø EXCEL-–û–¢–ß–ï–¢–û–í >>>

# <<< –ö–û–ù–ï–¶ –£–õ–£–ß–®–ï–ù–ù–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê –î–õ–Ø EXCEL-–û–¢–ß–ï–¢–û–í >>>


# –®–ê–ì 3.1: –í–°–¢–ê–í–¨–¢–ï –≠–¢–£ –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –î–ï–¢–ê–õ–¨–ù–û–ì–û –û–¢–ß–ï–¢–ê

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ generate_detailed_own_report –ù–ê –≠–¢–£ –ò–°–ü–†–ê–í–õ–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ

# –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø: –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ generate_detailed_own_report –ù–ê –≠–¢–£

# –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –° –°–û–†–¢–ò–†–û–í–ö–û–ô –ü–û –î–û–•–û–î–£: –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£

# --- –ù–û–í–ê–Ø –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –°–ë–û–†–ê –î–ê–ù–ù–´–• –ü–û –í–´–ö–£–ü–ê–ú ---
# –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –ù–ê –≠–¢–£

# =======================================================================================
# –§–ò–ù–ê–õ–¨–ù–´–ô –ë–õ–û–ö –ö–û–î–ê –î–õ–Ø –û–¢–ß–ï–¢–ê "–ù–ê–®–ò –í–ï–õ–û–°–ò–ü–ï–î–´" (–í–ï–†–°–ò–Ø –° –í–´–ö–£–ü–ê–ú–ò –ò –ë–ï–ó –û–®–ò–ë–û–ö)
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–ò –°–£–©–ï–°–¢–í–£–Æ–©–ò–ï –§–£–ù–ö–¶–ò–ò _get_buyout_data_for_report –ò generate_detailed_own_report –ù–ê –≠–¢–û–¢ –ö–û–î
# =======================================================================================

# –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–û–ô –§–£–ù–ö–¶–ò–ò –î–õ–Ø –í–´–ö–£–ü–û–í (–†–ê–ë–û–¢–ê–ï–¢ –ß–ï–†–ï–ó BOOKINGS)

# –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–û–ô –§–£–ù–ö–¶–ò–ò (–° –ö–õ–ò–ï–ù–¢–û–ú –ò –î–ê–¢–û–ô –ü–õ–ê–¢–ï–ñ–ê)

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ _get_buyout_data_for_report –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ _get_buyout_data_for_report –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
async def _get_buyout_data_for_report(owner_filter_sql: str, owner_filter_params: tuple):
    """
    –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–Ø: –°–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—ã–∫—É–ø–∞–º, –≤–∫–ª—é—á–∞—è –û–ë–©–ò–ô –í–ù–ï–°–ï–ù–ù–´–ô –î–û–•–û–î –∏ –¥–æ—Ö–æ–¥ –∑–∞ –º–µ—Å—è—Ü.
    """
    stats = defaultdict(lambda: {'bikes': {}})
    today = datetime.now()
    start_of_month_str = today.replace(day=1, hour=0, minute=0, second=0).strftime('%Y-%m-%d %H:%M:%S')

    async with aiosqlite.connect(DB_FILE) as conn:
        conn.row_factory = aiosqlite.Row
        
        sql_deals = f"""
            SELECT b.id as bike_id, bo.id as booking_id, b.name as bike_name, 
                   u_investor.first_name as investor_fname, u_investor.last_name as investor_lname,
                   u_client.first_name as client_fname, u_client.last_name as client_lname,
                   bo.payment_plan_key, bo.payments_made, bo.next_payment_date, b.type as item_type
            FROM bookings bo
            JOIN bikes b ON bo.bike_id = b.id
            JOIN users u_client ON bo.user_id = u_client.id
            LEFT JOIN users u_investor ON b.investor_id = u_investor.id
            WHERE bo.booking_type = 'buyout' AND bo.status = 'rented' {owner_filter_sql}
        """
        async with conn.execute(sql_deals, owner_filter_params) as cursor:
            async for deal in cursor:
                plan = _get_plan_details(deal['payment_plan_key'], deal['bike_name'], deal['item_type'])
                if not plan: continue
                
                owner_name = "–ö–æ–º–ø–∞–Ω–∏—è" if "IS NULL" in owner_filter_sql else f"{deal['investor_fname'] or ''} {deal['investor_lname'] or ''}".strip()
                parsed_info = parse_bike_name_and_vin(deal['bike_name'])
                
                payments_made = deal['payments_made'] or 0
                total_payments = plan.get('total_payments', 0)
                payment_amount = plan.get('payment_amount') or plan.get('first_payment', 0)
                
                paid_amount = payments_made * payment_amount # <-- –û–ë–©–ê–Ø –í–ù–ï–°–ï–ù–ù–ê–Ø –°–£–ú–ú–ê
                total_deal_value = total_payments * payment_amount
                monetary_progress_str = f"{paid_amount:,.0f} –∏–∑ {total_deal_value:,.0f} ‚ÇΩ".replace(",", " ")

                stats[owner_name]['bikes'][deal['bike_id']] = {
                    'id': deal['bike_id'], 'model': parsed_info['model'], 'vin': parsed_info['vin'],
                    'monthly_income': 0.0, # –î–æ—Ö–æ–¥ –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü, –ø–æ–∫–∞ 0
                    'cumulative_income': paid_amount, # <-- –ù–û–í–û–ï –ü–û–õ–ï: –û–±—â–∏–π –¥–æ—Ö–æ–¥
                    'total_deal_value': total_deal_value,
                    'progress': f"{payments_made}/{total_payments}",
                    'monetary_progress': monetary_progress_str,
                    'client_name': f"{deal['client_fname'] or ''} {deal['client_lname'] or ''}".strip(),
                    'next_payment_date': deal['next_payment_date'] or '–í–´–ö–£–ü–õ–ï–ù'
                }

        # –ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –¥–æ—Ö–æ–¥–∞ –∑–∞ –¢–ï–ö–£–©–ò–ô –ú–ï–°–Ø–¶ (–æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        sql_income = f"""
            SELECT b.id as bike_id, u_investor.first_name, u_investor.last_name, bh.details
            FROM bike_history bh
            JOIN bikes b ON bh.bike_id = b.id
            LEFT JOIN users u_investor ON b.investor_id = u_investor.id
            WHERE bh.action IN ('–í—ã–∫—É–ø (1-–π –≤–∑–Ω–æ—Å)', '–ü–ª–∞—Ç–µ–∂ –ø–æ –≤—ã–∫—É–ø—É', '–î–æ—Å—Ä–æ—á–Ω–æ–µ –ø–æ–≥–∞—à–µ–Ω–∏–µ', '–í—ã–∫—É–ø –ê–ö–ë (1-–π –≤–∑–Ω–æ—Å)', '–ü–ª–∞—Ç–µ–∂ –ø–æ –≤—ã–∫—É–ø—É (–ê–ö–ë)')
            AND bh.timestamp >= ? {owner_filter_sql}
        """
        async with conn.execute(sql_income, (start_of_month_str,) + owner_filter_params) as cursor:
            async for row in cursor:
                owner_name = "–ö–æ–º–ø–∞–Ω–∏—è" if "IS NULL" in owner_filter_sql else f"{row['first_name'] or ''} {row['last_name'] or ''}".strip()
                if owner_name in stats and row['bike_id'] in stats[owner_name]['bikes']:
                    income = _get_income_from_details(row['details'])
                    stats[owner_name]['bikes'][row['bike_id']]['monthly_income'] += income
    return stats


# –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø 1: –û–¢–ß–ï–¢ –ü–û "–ù–ê–®–ò–ú –í–ï–õ–û–°–ò–ü–ï–î–ê–ú" (–° –í–´–ö–£–ü–ê–ú–ò –ò –ö–õ–ò–ï–ù–¢–ê–ú–ò)

# –ó–ê–ú–ï–ù–ò–¢–ï –§–£–ù–ö–¶–ò–Æ generate_detailed_own_report –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ generate_detailed_own_report –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –§–£–ù–ö–¶–ò–Æ generate_detailed_own_report –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
async def generate_detailed_own_report() -> str:
    today = datetime.now()
    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            own_rent_stats, own_buyout_stats, own_rental_log = await _get_full_data_for_report("own", conn)
            total_expenses, expense_details = await _get_monthly_expense_data(conn)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞: {e}", exc_info=True)
        return None

    workbook = openpyxl.Workbook(); sheet = workbook.active; sheet.title = "–î–µ—Ç–∞–ª—å–Ω—ã–π_–æ—Ç—á–µ—Ç_–ù–∞—à–∏"
    _create_main_header(sheet, "–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞–º –∫–æ–º–ø–∞–Ω–∏–∏", 10)
    _create_subtitle(sheet, 10)
    
    current_row = 5
    # --- –¢–∞–±–ª–∏—Ü–∞ –∞—Ä–µ–Ω–¥—ã ---
    sheet.cell(row=current_row, column=1, value="–î–æ—Ö–æ–¥—ã –æ—Ç –ê—Ä–µ–Ω–¥—ã").font = Font(size=14, bold=True, color="2F5597")
    current_row +=1
    rent_headers = ["‚Ññ", "–ú–æ–¥–µ–ª—å", "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä", "–î–æ—Ö–æ–¥ –∑–∞ –º–µ—Å—è—Ü", "–î–Ω–µ–π –≤ –∞—Ä–µ–Ω–¥–µ", "–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä—ã"]
    _format_table_headers(sheet, current_row, rent_headers)
    current_row += 1
    total_rent_income = 0
    if "–ö–æ–º–ø–∞–Ω–∏—è" in own_rent_stats and own_rent_stats["–ö–æ–º–ø–∞–Ω–∏—è"]['bikes']:
        # ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –∞—Ä–µ–Ω–¥—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        for item in sorted(own_rent_stats["–ö–æ–º–ø–∞–Ω–∏—è"]['bikes'].values(), key=lambda x: -x['total_income']):
            sheet.append([item["id"], item["model"], item["vin"], item["total_income"] if item["total_income"] > 0 else 0, item["days_rented"], ", ".join(sorted(item["renters"])) if item["renters"] else "‚Äî"])
        total_rent_income = own_rent_stats["–ö–æ–º–ø–∞–Ω–∏—è"]['total_income']
        _format_data_rows_and_autofit(sheet, header_row=current_row-1, data_start_row=current_row, currency_columns=[4])
        current_row = sheet.max_row + 2
    
    # --- –¢–∞–±–ª–∏—Ü–∞ –≤—ã–∫—É–ø–∞ ---
    sheet.cell(row=current_row, column=1, value="–î–æ—Ö–æ–¥—ã –æ—Ç –í—ã–∫—É–ø–∞").font = Font(size=14, bold=True, color="2F5597")
    current_row += 1
    buyout_headers = ["‚Ññ", "–ú–æ–¥–µ–ª—å", "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä", "–ö–ª–∏–µ–Ω—Ç", "–í–Ω–µ—Å–µ–Ω–æ (‚ÇΩ)", "–ü—Ä–æ–≥—Ä–µ—Å—Å (–ø–ª.)", "–ü—Ä–æ–≥—Ä–µ—Å—Å (‚ÇΩ)", "–°–ª–µ–¥. –ø–ª–∞—Ç–µ–∂"]
    _format_table_headers(sheet, current_row, buyout_headers)
    current_row += 1
    total_buyout_monthly_income = 0
    if "–ö–æ–º–ø–∞–Ω–∏—è" in own_buyout_stats and own_buyout_stats["–ö–æ–º–ø–∞–Ω–∏—è"]['bikes']:
        # ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –≤—ã–∫—É–ø–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        for item in sorted(own_buyout_stats["–ö–æ–º–ø–∞–Ω–∏—è"]['bikes'].values(), key=lambda x: -x['monthly_income']):
            sheet.append([item["id"], item["model"], item["vin"], item["client_name"], item["cumulative_income"], item["progress"], item["monetary_progress"], item["next_payment_date"]])
        total_buyout_monthly_income = sum(b['monthly_income'] for b in own_buyout_stats["–ö–æ–º–ø–∞–Ω–∏—è"]['bikes'].values())
        _format_data_rows_and_autofit(sheet, header_row=current_row-1, data_start_row=current_row, currency_columns=[5])

    # --- –ò–¢–û–ì–ò –ò –†–ê–°–•–û–î–´ ---
    grand_total_income = total_rent_income + total_buyout_monthly_income
    _add_final_summary_with_expenses(sheet, grand_total_income, total_expenses, len(own_rental_log), len(buyout_headers))
    
    # --- –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ ---
    expense_start_row = sheet.max_row + 3
    sheet.cell(row=expense_start_row, column=1, value="–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –º–µ—Å—è—Ü").font = Font(size=14, bold=True, color="C00000")
    expense_headers = ["–î–∞—Ç–∞", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è", "–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è", "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ", "–ö–æ–ª-–≤–æ", "–°—É–º–º–∞", "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"]
    _format_table_headers(sheet, expense_start_row + 1, expense_headers)
    for exp in expense_details:
        sheet.append([exp['created_at'][:10], exp['category'], exp['subcategory'], exp['item_name'], exp['quantity'], exp['amount'], exp['comment']])
    _format_data_rows_and_autofit(sheet, header_row=expense_start_row + 1, data_start_row=expense_start_row + 2, currency_columns=[6])

    filename = os.path.join(REPORTS_PATH, f"detailed_report_own_{today.strftime('%Y-%m')}.xlsx")
    workbook.save(filename)
    return filename

# –®–ê–ì 3.2: –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ-–û–ë–†–ê–ë–û–¢–ß–ò–ö

# –®–ê–ì 4.2: –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ send_detailed_report –ù–ê –≠–¢–£

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ send_detailed_report –ù–ê –≠–¢–£ –ò–°–ü–†–ê–í–õ–ï–ù–ù–£–Æ –í–ï–†–°–ò–Æ

# –®–ê–ì 2: –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ send_detailed_report –ù–ê –≠–¢–£

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ send_detailed_report –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
async def send_detailed_report(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç –ï–î–ò–ù–´–ô –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ—Ç—á–µ—Ç–æ–≤
    –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∞–π–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. (–ò–°–ü–†–ê–í–õ–ï–ù–ê –û–®–ò–ë–ö–ê –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –°–û–û–ë–©–ï–ù–ò–Ø)
    """
    query = update.callback_query
    await query.answer()
    
    # === –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï ‚Ññ2 –ó–î–ï–°–¨ ===
    message_to_edit = query.message # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
    await message_to_edit.edit_text("‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é Excel-–æ—Ç—á–µ—Ç, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ –º–∏–Ω—É—Ç—ã...")

    try:
        parts = query.data.split('_')
        report_type = parts[2]
        
        investor_id = None
        if len(parts) > 3 and parts[3].isdigit():
            investor_id = int(parts[3])

        filename = None
        if report_type == 'expenses':
            today = datetime.now()
            start_of_month = today.replace(day=1)
            filename = generate_expense_report(start_of_month, today)
        else:
            filename = await generate_unified_report(report_type=report_type, investor_id=investor_id)

        if filename and os.path.exists(filename):
            with open(filename, 'rb') as file:
                await context.bot.send_document(
                    chat_id=query.from_user.id,
                    document=file,
                    caption="‚úÖ –í–∞—à –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –≥–æ—Ç–æ–≤."
                )
            os.remove(filename)
            await message_to_edit.delete() # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ì–µ–Ω–µ—Ä–∏—Ä—É—é..."
        else:
            await message_to_edit.edit_text("üòî –í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—á–µ—Ç–∞ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü.")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ ({query.data}): {e}", exc_info=True)
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        await message_to_edit.edit_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")

# –®–ê–ì 5.1: –í–°–¢–ê–í–¨–¢–ï –≠–¢–£ –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ

async def select_investor_for_report(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π.
    """
    query = update.callback_query
    await query.answer()

    # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏–∑ callback_data (stats_select_investor_0)
    page = int(query.data.split('_')[-1])
    PAGE_SIZE = 5 # 5 –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ –Ω–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            # –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤
            count_cursor = await conn.execute(
                "SELECT COUNT(DISTINCT investor_id) FROM bikes WHERE investor_id IS NOT NULL"
            )
            total_items = (await count_cursor.fetchone())[0]

            if total_items == 0:
                await query.edit_message_text(
                    "–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞–º–∏.",
                    reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="stats_investor_menu")]])
                )
                return

            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            cursor = await conn.execute(
                """SELECT DISTINCT b.investor_id, u.first_name, u.last_name
                   FROM bikes b
                   JOIN users u ON b.investor_id = u.id
                   WHERE b.investor_id IS NOT NULL
                   ORDER BY u.last_name, u.first_name
                   LIMIT ? OFFSET ?""",
                (PAGE_SIZE, page * PAGE_SIZE)
            )
            investors = await cursor.fetchall()

        keyboard = []
        for inv in investors:
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞
            # callback_data –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å ID –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
            keyboard.append([InlineKeyboardButton(
                f"{inv['first_name']} {inv['last_name'] or ''}",
                callback_data=f"stats_detailed_investor_{inv['investor_id']}"
            )])

        # –õ–æ–≥–∏–∫–∞ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
        total_pages = (total_items + PAGE_SIZE - 1) // PAGE_SIZE
        pagination_row = []
        if page > 0:
            pagination_row.append(InlineKeyboardButton("‚¨ÖÔ∏è", callback_data=f"stats_select_investor_{page - 1}"))
        if page < total_pages - 1:
            pagination_row.append(InlineKeyboardButton("‚û°Ô∏è", callback_data=f"stats_select_investor_{page + 1}"))
        
        if pagination_row:
            keyboard.append(pagination_row)
        
        # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –æ—Ç—á–µ—Ç–æ–≤ –ø–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º
        keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="stats_investor_menu")])

        await query.edit_message_text(
            f"–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞ –¥–ª—è –æ—Ç—á–µ—Ç–∞ (–°—Ç—Ä. {page + 1}/{total_pages}):",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ –¥–ª—è –æ—Ç—á–µ—Ç–∞: {e}", exc_info=True)
        await query.edit_message_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤.")

# <<< –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê –î–õ–Ø EXCEL-–û–¢–ß–ï–¢–û–í >>>
# –®–ê–ì 4.1: –í–°–¢–ê–í–¨–¢–ï –≠–¢–£ –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ –î–õ–Ø –û–¢–ß–ï–¢–ê –ü–û –í–°–ï–ú –ò–ù–í–ï–°–¢–û–†–ê–ú

# –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –î–õ–Ø –ò–ù–í–ï–°–¢–û–†–û–í: –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£

# –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –î–õ–Ø –ò–ù–í–ï–°–¢–û–†–û–í –° –ì–†–£–ü–ü–ò–†–û–í–ö–û–ô: –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£

# –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –î–õ–Ø –ò–ù–í–ï–°–¢–û–†–û–í –° –ì–†–£–ü–ü–ò–†–û–í–ö–û–ô –ò –ì–ê–†–ê–ù–¢–ò–†–û–í–ê–ù–ù–´–ú –°–û–ó–î–ê–ù–ò–ï–ú –§–ê–ô–õ–ê

# –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –° –ì–†–£–ü–ü–ò–†–û–í–ö–û–ô –ü–û –ò–ù–í–ï–°–¢–û–†–ê–ú: –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£

# –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø 2: –û–¢–ß–ï–¢ –ü–û –ò–ù–í–ï–°–¢–û–†–ê–ú (–° –í–´–ö–£–ü–ê–ú–ò –ò –ö–õ–ò–ï–ù–¢–ê–ú–ò)

# –ó–ê–ú–ï–ù–ò–¢–ï –§–£–ù–ö–¶–ò–Æ generate_detailed_investor_report –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –§–£–ù–ö–¶–ò–Æ generate_detailed_investor_report –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –§–£–ù–ö–¶–ò–Æ generate_detailed_investor_report –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ generate_detailed_investor_report –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
async def generate_detailed_investor_report(investor_id: int | None = None) -> str:
    today = datetime.now()
    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            investor_rent_stats, investor_buyout_stats, investor_rental_log = await _get_full_data_for_report("investor", conn, investor_id)
            total_expenses, expense_details = await _get_monthly_expense_data(conn) # –†–∞—Å—Ö–æ–¥—ã —Å—á–∏—Ç–∞—é—Ç—Å—è –æ–±—â–∏–µ
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—á–µ—Ç–∞ –ø–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º: {e}", exc_info=True)
        return None

    workbook = openpyxl.Workbook(); sheet = workbook.active
    title_text = "–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –≤—Å–µ–º –∏–Ω–≤–µ—Å—Ç–æ—Ä—Å–∫–∏–º –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞–º"
    if investor_id and (investor_rent_stats or investor_buyout_stats):
        investor_name = list(investor_rent_stats.keys())[0] if investor_rent_stats else list(investor_buyout_stats.keys())[0]
        title_text = f"–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞–º –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞: {investor_name}"
    
    _create_main_header(sheet, title_text, 12)
    _create_subtitle(sheet, 12)
    current_row = 5
    grand_total_income = 0
    
    if not investor_rent_stats and not investor_buyout_stats:
        sheet.cell(row=current_row, column=1, value="–î–∞–Ω–Ω—ã–µ –ø–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.")
    else:
        # ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü –¥–ª—è –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
        for investor_name in sorted(set(list(investor_rent_stats.keys()) + list(investor_buyout_stats.keys()))):
            sheet.merge_cells(start_row=current_row, start_column=1, end_row=current_row, end_column=8)
            group_header_cell = sheet.cell(row=current_row, column=1, value=f"–ò–Ω–≤–µ—Å—Ç–æ—Ä: {investor_name}")
            group_header_cell.font = Font(name='Calibri', size=14, bold=True, color='2F5597'); group_header_cell.fill = PatternFill(start_color="DDEBF7", fill_type='solid')
            current_row += 2
            
            if investor_name in investor_rent_stats and investor_rent_stats[investor_name]['bikes']:
                sheet.cell(row=current_row, column=1, value="–î–æ—Ö–æ–¥—ã –æ—Ç –ê—Ä–µ–Ω–¥—ã").font = Font(size=12, bold=True)
                current_row += 1
                rent_headers = ["‚Ññ", "–ú–æ–¥–µ–ª—å", "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä", "–î–æ—Ö–æ–¥ (—Ñ–∞–∫—Ç)", "–î–Ω–µ–π –≤ –∞—Ä–µ–Ω–¥–µ", "–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä—ã"]
                _format_table_headers(sheet, current_row, rent_headers)
                current_row += 1
                for item in sorted(investor_rent_stats[investor_name]['bikes'].values(), key=lambda x: -x['total_income']):
                    sheet.append([item["id"], item["model"], item["vin"], item["total_income"] if item["total_income"] > 0 else 0, item["days_rented"], ", ".join(sorted(item["renters"])) if item["renters"] else "‚Äî"])
                _format_data_rows_and_autofit(sheet, header_row=current_row - 1, data_start_row=current_row, currency_columns=[4])
                current_row = sheet.max_row + 1

            if investor_name in investor_buyout_stats and investor_buyout_stats[investor_name]['bikes']:
                sheet.cell(row=current_row, column=1, value="–î–æ—Ö–æ–¥—ã –æ—Ç –í—ã–∫—É–ø–∞").font = Font(size=12, bold=True)
                current_row += 1
                buyout_headers = ["‚Ññ", "–ú–æ–¥–µ–ª—å", "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä", "–ö–ª–∏–µ–Ω—Ç", "–í–Ω–µ—Å–µ–Ω–æ (‚ÇΩ)", "–ü—Ä–æ–≥—Ä–µ—Å—Å (–ø–ª.)", "–ü—Ä–æ–≥—Ä–µ—Å—Å (‚ÇΩ)", "–°–ª–µ–¥. –ø–ª–∞—Ç–µ–∂"]
                _format_table_headers(sheet, current_row, buyout_headers)
                current_row += 1
                for item in sorted(investor_buyout_stats[investor_name]['bikes'].values(), key=lambda x: -x['monthly_income']):
                    sheet.append([item["id"], item["model"], item["vin"], item["client_name"], item["cumulative_income"], item["progress"], item["monetary_progress"], item["next_payment_date"]])
                _format_data_rows_and_autofit(sheet, header_row=current_row - 1, data_start_row=current_row, currency_columns=[5])
                current_row = sheet.max_row + 1

            subtotal_income = investor_rent_stats[investor_name]['total_income'] + sum(b['monthly_income'] for b in investor_buyout_stats.get(investor_name, {}).get('bikes', {}).values())
            subtotal_label = sheet.cell(row=current_row, column=3, value=f"–ò—Ç–æ–≥–æ –ø–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä—É:")
            subtotal_label.font = Font(bold=True, size=12); subtotal_label.alignment = Alignment(horizontal='right')
            subtotal_value = sheet.cell(row=current_row, column=4, value=subtotal_income)
            subtotal_value.font = Font(bold=True, size=12); subtotal_value.number_format = '#,##0.00 ‚ÇΩ'
            current_row += 2
            grand_total_income += subtotal_income
    
    # --- –ò–¢–û–ì–ò –ò –†–ê–°–•–û–î–´ ---
    _add_final_summary_with_expenses(sheet, grand_total_income, total_expenses, len(investor_rental_log), 8)
    
    # --- –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ ---
    expense_start_row = sheet.max_row + 3
    sheet.cell(row=expense_start_row, column=1, value="–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—â–∏—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –º–µ—Å—è—Ü").font = Font(size=14, bold=True, color="C00000")
    expense_headers = ["–î–∞—Ç–∞", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è", "–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è", "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ", "–ö–æ–ª-–≤–æ", "–°—É–º–º–∞", "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"]
    _format_table_headers(sheet, expense_start_row + 1, expense_headers)
    for exp in expense_details:
        sheet.append([exp['created_at'][:10], exp['category'], exp['subcategory'], exp['item_name'], exp['quantity'], exp['amount'], exp['comment']])
    _format_data_rows_and_autofit(sheet, header_row=expense_start_row + 1, data_start_row=expense_start_row + 2, currency_columns=[6])

    filename = os.path.join(REPORTS_PATH, f"detailed_report_investor_{investor_id or 'all'}_{today.strftime('%Y-%m')}.xlsx")
    workbook.save(filename)
    return filename

# –®–ê–ì 1: –í–°–¢–ê–í–¨–¢–ï –≠–¢–£ –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ –î–õ–Ø –û–ë–©–ï–ì–û –û–¢–ß–ï–¢–ê

# –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –û–ë–©–ï–ì–û –û–¢–ß–ï–¢–ê: –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£

# –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –û–ë–©–ï–ì–û –û–¢–ß–ï–¢–ê: –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ –ù–ê –≠–¢–£

# –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø 3: –û–ë–©–ò–ô –û–¢–ß–ï–¢ (–° –í–´–ö–£–ü–ê–ú–ò –ò –ö–õ–ò–ï–ù–¢–ê–ú–ò)

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ generate_combined_detailed_report –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ generate_combined_detailed_report –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
async def generate_combined_detailed_report() -> str:
    """
    –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –û–ë–©–ò–ô Excel-–æ—Ç—á–µ—Ç, –æ–±—ä–µ–¥–∏–Ω—è—è –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ —Ä–∞—Å—Ö–æ–¥—ã.
    """
    today = datetime.now()
    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            own_rent_stats, own_buyout_stats, own_rental_log = await _get_full_data_for_report("own", conn)
            investor_rent_stats, investor_buyout_stats, investor_rental_log = await _get_full_data_for_report("investor", conn)
            total_expenses, expense_details = await _get_monthly_expense_data(conn)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—â–µ–≥–æ –æ—Ç—á–µ—Ç–∞: {e}", exc_info=True)
        return None

    # --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Excel ---
    workbook = openpyxl.Workbook(); sheet = workbook.active; sheet.title = "–û–±—â–∏–π_–¥–µ—Ç–∞–ª—å–Ω—ã–π_–æ—Ç—á–µ—Ç"
    _create_main_header(sheet, "–û–±—â–∏–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –≤—Å–µ–º –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞–º", 16)
    _create_subtitle(sheet, 16)
    
    # --- –°–µ–∫—Ü–∏—è 1: –ù–∞—à–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã ---
    # ... (–∫–æ–¥ –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç–∞–±–ª–∏—Ü –ø–æ "–Ω–∞—à–∏–º" –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
    offset_column_own = 1
    sheet.cell(row=4, column=offset_column_own, value="–í–µ–ª–æ—Å–∏–ø–µ–¥—ã –∫–æ–º–ø–∞–Ω–∏–∏").font = Font(size=14, bold=True, color="2F5597")
    current_row_left = 5
    sheet.cell(row=current_row_left, column=offset_column_own, value="–î–æ—Ö–æ–¥—ã –æ—Ç –ê—Ä–µ–Ω–¥—ã").font = Font(size=12, bold=True)
    current_row_left += 1
    rent_headers = ["‚Ññ", "–ú–æ–¥–µ–ª—å", "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä", "–î–æ—Ö–æ–¥ (–º–µ—Å.)", "–î–Ω–µ–π –≤ –∞—Ä–µ–Ω–¥–µ", "–ê—Ä–µ–Ω–¥–∞—Ç–æ—Ä—ã"]
    _format_table_headers(sheet, current_row_left, rent_headers)
    current_row_left += 1
    total_own_rent_income = 0
    if "–ö–æ–º–ø–∞–Ω–∏—è" in own_rent_stats and own_rent_stats["–ö–æ–º–ø–∞–Ω–∏—è"]['bikes']:
        for item in sorted(own_rent_stats["–ö–æ–º–ø–∞–Ω–∏—è"]['bikes'].values(), key=lambda x: -x['total_income']):
            sheet.append([item["id"], item["model"], item["vin"], item["total_income"] if item["total_income"] > 0 else 0, item["days_rented"], ", ".join(sorted(item["renters"])) if item["renters"] else "‚Äî"])
        total_own_rent_income = own_rent_stats["–ö–æ–º–ø–∞–Ω–∏—è"]['total_income']
        _format_data_rows_and_autofit(sheet, header_row=current_row_left - 1, data_start_row=current_row_left, currency_columns=[4])
    
    current_row_left = sheet.max_row + 2
    sheet.cell(row=current_row_left, column=offset_column_own, value="–î–æ—Ö–æ–¥—ã –æ—Ç –í—ã–∫—É–ø–∞").font = Font(size=12, bold=True)
    current_row_left += 1
    buyout_headers_own = ["‚Ññ", "–ú–æ–¥–µ–ª—å", "–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä", "–ö–ª–∏–µ–Ω—Ç", "–í–Ω–µ—Å–µ–Ω–æ (‚ÇΩ)", "–ü—Ä–æ–≥—Ä–µ—Å—Å (–ø–ª.)", "–ü—Ä–æ–≥—Ä–µ—Å—Å (‚ÇΩ)", "–°–ª–µ–¥. –ø–ª–∞—Ç–µ–∂"]
    _format_table_headers(sheet, current_row_left, buyout_headers_own)
    current_row_left += 1
    total_own_buyout_income = 0
    if "–ö–æ–º–ø–∞–Ω–∏—è" in own_buyout_stats and own_buyout_stats["–ö–æ–º–ø–∞–Ω–∏—è"]['bikes']:
        for item in sorted(own_buyout_stats["–ö–æ–º–ø–∞–Ω–∏—è"]['bikes'].values(), key=lambda x: -x['monthly_income']):
            sheet.cell(row=current_row_left, column=1, value=item["id"]); sheet.cell(row=current_row_left, column=2, value=item["model"])
            sheet.cell(row=current_row_left, column=3, value=item["vin"]); sheet.cell(row=current_row_left, column=4, value=item["client_name"])
            sheet.cell(row=current_row_left, column=5, value=item["cumulative_income"]); sheet.cell(row=current_row_left, column=6, value=item["progress"])
            sheet.cell(row=current_row_left, column=7, value=item["monetary_progress"]); sheet.cell(row=current_row_left, column=8, value=item["next_payment_date"])
            current_row_left += 1
        total_own_buyout_income = sum(b['monthly_income'] for b in own_buyout_stats["–ö–æ–º–ø–∞–Ω–∏—è"]['bikes'].values())
        _format_data_rows_and_autofit(sheet, header_row=current_row_left - 1, data_start_row=current_row_left - len(own_buyout_stats["–ö–æ–º–ø–∞–Ω–∏—è"]['bikes']), currency_columns=[5])

    # --- –°–µ–∫—Ü–∏—è 2: –ò–Ω–≤–µ—Å—Ç–æ—Ä—Å–∫–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã ---
    # ... (–∫–æ–¥ –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç–∞–±–ª–∏—Ü –ø–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
    offset_column_inv = 9
    sheet.cell(row=4, column=offset_column_inv, value="–ò–Ω–≤–µ—Å—Ç–æ—Ä—Å–∫–∏–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã").font = Font(size=14, bold=True, color="2F5597")
    current_row_right = 5
    total_investor_rent_income = 0
    total_investor_buyout_income = 0
    all_investors = sorted(set(list(investor_rent_stats.keys()) + list(investor_buyout_stats.keys())))
    for investor_name in all_investors:
        sheet.merge_cells(start_row=current_row_right, start_column=offset_column_inv, end_row=current_row_right, end_column=offset_column_inv + 7)
        group_header = sheet.cell(row=current_row_right, column=offset_column_inv, value=f"–ò–Ω–≤–µ—Å—Ç–æ—Ä: {investor_name}")
        group_header.font = Font(size=12, bold=True, color='2F5597'); group_header.fill = PatternFill(start_color="DDEBF7", fill_type='solid')
        current_row_right += 1

        if investor_name in investor_rent_stats and investor_rent_stats[investor_name]['bikes']:
            start_data_row = current_row_right
            for i, header in enumerate(rent_headers): sheet.cell(row=start_data_row, column=offset_column_inv + i, value=header)
            _format_table_headers(sheet, start_data_row, rent_headers)
            start_data_row += 1
            for item in sorted(investor_rent_stats[investor_name]['bikes'].values(), key=lambda x: -x['total_income']):
                for i, val in enumerate([item["id"], item["model"], item["vin"], item["total_income"] if item["total_income"] > 0 else 0, item["days_rented"], ", ".join(sorted(item["renters"])) if item["renters"] else "‚Äî"]):
                    sheet.cell(row=start_data_row, column=offset_column_inv + i, value=val)
                start_data_row += 1
            _format_data_rows_and_autofit(sheet, header_row=start_data_row - len(investor_rent_stats[investor_name]['bikes']) - 1, data_start_row=start_data_row - len(investor_rent_stats[investor_name]['bikes']), currency_columns=[offset_column_inv + 3])
            current_row_right = sheet.max_row + 1
            total_investor_rent_income += investor_rent_stats[investor_name]['total_income']

        if investor_name in investor_buyout_stats and investor_buyout_stats[investor_name]['bikes']:
            start_data_row = current_row_right
            for i, header in enumerate(buyout_headers_own): sheet.cell(row=start_data_row, column=offset_column_inv + i, value=header)
            _format_table_headers(sheet, start_data_row, buyout_headers_own)
            start_data_row += 1
            for item in sorted(investor_buyout_stats[investor_name]['bikes'].values(), key=lambda x: -x['monthly_income']):
                for i, val in enumerate([item["id"], item["model"], item["vin"], item["client_name"], item["cumulative_income"], item["progress"], item["monetary_progress"], item["next_payment_date"]]):
                    sheet.cell(row=start_data_row, column=offset_column_inv + i, value=val)
                start_data_row += 1
            _format_data_rows_and_autofit(sheet, header_row=start_data_row - len(investor_buyout_stats[investor_name]['bikes']) - 1, data_start_row=start_data_row - len(investor_buyout_stats[investor_name]['bikes']), currency_columns=[offset_column_inv + 4])
            current_row_right = sheet.max_row + 1
            total_investor_buyout_income += sum(b['monthly_income'] for b in investor_buyout_stats[investor_name]['bikes'].values())
        current_row_right += 1

    # --- –ò–¢–û–ì–ò –ò –†–ê–°–•–û–î–´ ---
    grand_total_income = total_own_rent_income + total_own_buyout_income + total_investor_rent_income + total_investor_buyout_income
    _add_final_summary_with_expenses(sheet, grand_total_income, total_expenses, len(own_rental_log) + len(investor_rental_log), 15)

    # --- –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ ---
    expense_start_row = sheet.max_row + 3
    sheet.cell(row=expense_start_row, column=1, value="–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—â–∏—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –º–µ—Å—è—Ü").font = Font(size=14, bold=True, color="C00000")
    expense_headers = ["–î–∞—Ç–∞", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è", "–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è", "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ", "–ö–æ–ª-–≤–æ", "–°—É–º–º–∞", "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"]
    _format_table_headers(sheet, expense_start_row + 1, expense_headers)
    for exp in expense_details:
        sheet.append([exp['created_at'][:10], exp['category'], exp['subcategory'], exp['item_name'], exp['quantity'], exp['amount'], exp['comment']])
    _format_data_rows_and_autofit(sheet, header_row=expense_start_row + 1, data_start_row=expense_start_row + 2, currency_columns=[6])
    
    filename = os.path.join(REPORTS_PATH, f"combined_detailed_report_{today.strftime('%Y-%m')}.xlsx")
    workbook.save(filename)
    return filename
# --- –ù–û–í–ê–Ø –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–ë–û–†–ê –î–ê–ù–ù–´–• ---
# –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–û–ô –§–£–ù–ö–¶–ò–ò (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø)

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ _get_full_data_for_report –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ _get_full_data_for_report –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
async def _get_full_data_for_report(owner_type: str, conn: aiosqlite.Connection, investor_id: int | None = None):
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ –∞—Ä–µ–Ω–¥–µ –∏ –≤—ã–∫—É–ø—É.
    –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î.
    """
    # <<< –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º row_factory –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ >>>
    conn.row_factory = aiosqlite.Row
    
    today = datetime.now()
    start_of_month = today.replace(day=1, hour=0, minute=0, second=0, microsecond=0)
    end_of_month = (start_of_month.replace(day=28) + timedelta(days=4)).replace(day=1) - timedelta(days=1)
    end_of_month = end_of_month.replace(hour=23, minute=59, second=59)

    stats_rent = defaultdict(lambda: {'bikes': {}, 'total_income': 0.0})
    rental_log = []
    
    owner_filter_sql = "AND b.investor_id IS NULL" if owner_type == "own" else "AND b.investor_id IS NOT NULL"
    params = []
    if investor_id:
        owner_filter_sql += " AND b.investor_id = ?"
        params.append(investor_id)

    # –¢–µ–ø–µ—Ä—å bike['name'] –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
    sql_get_bikes = f"SELECT b.id, b.name, u.first_name, u.last_name FROM bikes b LEFT JOIN users u ON b.investor_id = u.id WHERE b.type = 'bike' {owner_filter_sql}"
    cursor = await conn.execute(sql_get_bikes, params)
    for bike in await cursor.fetchall():
        owner_name = "–ö–æ–º–ø–∞–Ω–∏—è" if owner_type == 'own' else f"{bike['first_name'] or ''} {bike['last_name'] or ''}".strip()
        parsed_info = parse_bike_name_and_vin(bike['name'])
        stats_rent[owner_name]['bikes'][bike['id']] = {'id': bike['id'], 'model': parsed_info['model'], 'vin': parsed_info['vin'], 'total_income': 0.0, 'days_rented': 0, 'renters': set()}

    history_params = [start_of_month.strftime('%Y-%m-%d %H:%M:%S')]
    if investor_id: 
        history_params.append(investor_id)
        # –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º SQL –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ investor_id –≤ bike_history
        owner_filter_sql_history = "AND b.investor_id = ?"
    else:
        owner_filter_sql_history = owner_filter_sql

    sql_query_rent = f"""
        SELECT b.id AS bike_id, u_renter.first_name, u_renter.last_name, u_investor.first_name as investor_fname, u_investor.last_name as investor_lname, bh.details, bh.timestamp
        FROM bike_history bh 
        JOIN bikes b ON bh.bike_id = b.id 
        JOIN users u_renter ON bh.user_id = u_renter.id 
        LEFT JOIN users u_investor ON b.investor_id = u_investor.id
        WHERE b.type = 'bike' AND bh.action IN ('–û–ø–ª–∞—Ç–∞ –∞—Ä–µ–Ω–¥—ã', '–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã', '–ê—Ä–µ–Ω–¥–∞', '–ê—Ä–µ–Ω–¥–∞ –¥–æ–ø. –ê–ö–ë') AND bh.timestamp >= ?
        {owner_filter_sql_history} 
        AND LOWER(TRIM(COALESCE(u_renter.first_name, '') || ' ' || COALESCE(u_renter.last_name, ''))) NOT IN ('—Ç–µ—Å—Ç —Ç–µ—Å—Ç–æ–≤', '–∫–∏—Ä–∏–ª–ª –ø–∞—Ç—Ä—É—à–µ–≤')
    """
    async with conn.execute(sql_query_rent, history_params) as cursor:
        async for row in cursor:
            owner_name = "–ö–æ–º–ø–∞–Ω–∏—è" if owner_type == 'own' else f"{row['investor_fname'] or ''} {row['investor_lname'] or ''}".strip()
            bike_id = row['bike_id']
            if owner_name not in stats_rent or bike_id not in stats_rent[owner_name]['bikes']: continue
            income = _get_income_from_details(row['details'])
            stats_rent[owner_name]['bikes'][bike_id]['total_income'] += income
            stats_rent[owner_name]['total_income'] += income
            renter_name = f"{row['first_name'] or ''} {row['last_name'] or ''}".strip()
            if renter_name: stats_rent[owner_name]['bikes'][bike_id]['renters'].add(renter_name)
            payment_date = datetime.strptime(row['timestamp'], '%Y-%m-%d %H:%M:%S')
            period = _parse_period_from_details(row['details'])
            start_rent_obj, end_rent_obj = (datetime.strptime(period[0], '%d.%m.%Y'), datetime.strptime(period[1], '%d.%m.%Y')) if period else (None, None)
            if not period:
                model_key = get_bike_model_key(stats_rent[owner_name]['bikes'][bike_id]['model'] + stats_rent[owner_name]['bikes'][bike_id]['vin'])
                duration = _find_rental_period_from_price(model_key, income)
                if duration: start_rent_obj, end_rent_obj = payment_date, payment_date + timedelta(days=duration)
            if start_rent_obj and end_rent_obj:
                overlap_start, overlap_end = max(start_rent_obj, start_of_month), min(end_rent_obj, end_of_month)
                if overlap_end >= overlap_start: stats_rent[owner_name]['bikes'][bike_id]['days_rented'] += (overlap_end - overlap_start).days
            rental_log.append(1)

    buyout_filter_sql = "AND b.investor_id IS NULL" if owner_type == "own" else "AND b.investor_id IS NOT NULL"
    buyout_params = (investor_id,) if investor_id else ()
    if investor_id: buyout_filter_sql += " AND b.investor_id = ?"
    buyout_stats = await _get_buyout_data_for_report(conn, buyout_filter_sql, buyout_params)
    
    return stats_rent, buyout_stats, rental_log
# –®–ê–ì 1.1: –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ
# –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ –í –í–ê–® –ö–û–î
# –í–°–¢–ê–í–¨–¢–ï –≠–¢–û–¢ –ë–û–õ–¨–®–û–ô –ë–õ–û–ö –í–ú–ï–°–¢–û –í–°–ï–• –°–¢–ê–†–´–• –§–£–ù–ö–¶–ò–ô –ì–ï–ù–ï–†–ê–¶–ò–ò –û–¢–ß–ï–¢–û–í

# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ generate_unified_report –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ generate_unified_report –ù–ê –≠–¢–£ –§–ò–ù–ê–õ–¨–ù–£–Æ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ generate_unified_report –ù–ê –≠–¢–£ –§–ò–ù–ê–õ–¨–ù–£–Æ –í–ï–†–°–ò–Æ
def _get_expense_labels(category_key: str, subcategory_key: str) -> tuple[str, str]:
    """–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ –∫–ª—é—á–µ–π —Ä–∞—Å—Ö–æ–¥–æ–≤ –≤ —Ä—É—Å—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è."""
    try:
        cat_info = EXPENSE_CATEGORIES.get(category_key, {})
        cat_label = cat_info.get('label', category_key)
        
        sub_info = cat_info.get('subcategories', {}).get(subcategory_key)
        if isinstance(sub_info, dict):
            sub_label = sub_info.get('label', subcategory_key)
        elif isinstance(sub_info, str):
            sub_label = sub_info
        else:
            sub_label = subcategory_key
            
        return cat_label, sub_label
    except Exception:
        return category_key, subcategory_key
# –í–°–¢–ê–í–¨–¢–ï –≠–¢–û–¢ –ë–û–õ–¨–®–û–ô –ë–õ–û–ö –í–ú–ï–°–¢–û –í–°–ï–• –°–¢–ê–†–´–• –§–£–ù–ö–¶–ò–ô –ì–ï–ù–ï–†–ê–¶–ò–ò –û–¢–ß–ï–¢–û–í

# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —ç—Ç–∏ –∏–º–ø–æ—Ä—Ç—ã –µ—Å—Ç—å –≤ –Ω–∞—á–∞–ª–µ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞
import aiosqlite
import openpyxl
from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
from openpyxl.utils import get_column_letter
from datetime import datetime, timedelta
from collections import defaultdict
import os
import re
import logging

# =======================================================================================
# –ù–ê–ß–ê–õ–û –ü–û–õ–ù–û–ô –§–£–ù–ö–¶–ò–ò (—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –±–ª–æ–∫ —Ü–µ–ª–∏–∫–æ–º)
# =======================================================================================

# =======================================================================================
# –ü–û–õ–ù–ê–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø (–° –§–ò–ö–°–û–ú –®–ò–†–ò–ù–´ –°–¢–û–õ–ë–¶–û–í)
# =======================================================================================

# =======================================================================================
# –ü–û–õ–ù–ê–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø (–° –§–ò–ö–°–û–ú –®–ò–†–ò–ù–´ –°–¢–û–õ–ë–¶–û–í)
# =======================================================================================

# =======================================================================================
# –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –° –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï–ú KeyError
# =======================================================================================

# =======================================================================================
# –§–ò–ù–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –° –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï–ú KeyError (–ù–∞ —ç—Ç–æ—Ç —Ä–∞–∑ —Ç–æ—á–Ω–æ)
# =======================================================================================

# =======================================================================================
# –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –° –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï–ú KeyError
# =======================================================================================

# =======================================================================================
# –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –û–¢–ß–ï–¢–ê –° –¢–†–ï–ú–Ø –¢–ê–ë–õ–ò–¶–ê–ú–ò (–ó–ê–ú–ï–ù–ò–¢–¨ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ)
# =======================================================================================

# =======================================================================================
# –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –§–£–ù–ö–¶–ò–ò –û–¢–ß–ï–¢–ê (–ó–ê–ú–ï–ù–ò–¢–¨ –°–¢–ê–†–£–Æ)
# =======================================================================================

# =======================================================================================
# –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –§–£–ù–ö–¶–ò–ò –û–¢–ß–ï–¢–ê (–° –§–ò–ö–°–û–ú –®–ò–†–ò–ù–´ –°–¢–û–õ–ë–¶–û–í)
# =======================================================================================

# =======================================================================================
# –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–ê–Ø –í–ï–†–°–Ø –û–¢–ß–ï–¢–ê –ü–û –¢–í–û–ò–ú –¢–†–ï–ë–û–í–ê–ù–ò–Ø–ú (–° –î–ò–ê–ì–†–ê–ú–ú–û–ô)
# =======================================================================================
import openpyxl
from openpyxl.chart import PieChart, Reference
from openpyxl.chart.label import DataLabelList

# === –ù–ê–ß–ê–õ–û –ë–õ–û–ö–ê –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ===

async def generate_unified_report(report_type: str, start_date: datetime, end_date: datetime, investor_id: int | None = None) -> str | None:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π Excel-–æ—Ç—á–µ—Ç –∑–∞ –£–ö–ê–ó–ê–ù–ù–´–ô –ü–ï–†–ò–û–î.
    """
    # <<< –í–û–¢ –≠–¢–ê –°–¢–†–û–ö–ê –ë–´–õ–ê –ü–†–û–ü–£–©–ï–ù–ê >>>
    today = datetime.now()
    
    start_of_period = start_date.replace(hour=0, minute=0, second=0)
    end_of_period = end_date.replace(hour=23, minute=59, second=59)

    # --- 1. –°–ë–û–† –î–ê–ù–ù–´–• ---
    all_bikes_data = defaultdict(lambda: {
        'model': '', 'vin': '', 'investor_name': '–ö–æ–º–ø–∞–Ω–∏—è',
        'rent_income_monthly': 0.0, 'days_rented': 0, 'renters': set(),
        'buyout_monthly_income': 0.0, 'cumulative_buyout_income': 0.0,
        'total_deal_value': 0.0, 'remaining_debt': 0.0, 'progress_payments': '',
        'is_buyout': False, 'client_name': ''
    })
    total_expenses = 0.0
    expense_details = []
    occupied_bike_ids = set()

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row

            cursor = await conn.execute(
                """SELECT b.id, b.name, u.first_name, u.last_name FROM bikes b 
                   LEFT JOIN users u ON b.investor_id = u.id 
                   WHERE b.type = 'bike' AND LOWER(TRIM(b.name)) NOT LIKE 'test%'"""
            )
            for bike in await cursor.fetchall():
                parsed = parse_bike_name_and_vin(bike['name'])
                investor_name = f"{bike['first_name']} {bike['last_name'] or ''}".strip() if bike['first_name'] else '–ö–æ–º–ø–∞–Ω–∏—è'
                all_bikes_data[bike['id']]['model'] = parsed['model']
                all_bikes_data[bike['id']]['vin'] = parsed['vin']
                all_bikes_data[bike['id']]['investor_name'] = investor_name

            sql_rent = """
                SELECT b.id as bike_id, bh.details, bh.timestamp, u.first_name, u.last_name FROM bike_history bh 
                JOIN bikes b ON bh.bike_id = b.id JOIN users u ON bh.user_id = u.id
                WHERE b.type = 'bike' AND bh.action IN ('–û–ø–ª–∞—Ç–∞ –∞—Ä–µ–Ω–¥—ã', '–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã', '–ê—Ä–µ–Ω–¥–∞') 
                AND bh.timestamp BETWEEN ? AND ?
                AND LOWER(TRIM(COALESCE(u.first_name, '') || ' ' || COALESCE(u.last_name, ''))) NOT IN ('—Ç–µ—Å—Ç —Ç–µ—Å—Ç–æ–≤', '–∫–∏—Ä–∏–ª–ª –ø–∞—Ç—Ä—É—à–µ–≤')
            """
            async with conn.execute(sql_rent, (start_of_period.strftime('%Y-%m-%d %H:%M:%S'), end_of_period.strftime('%Y-%m-%d %H:%M:%S'))) as cursor:
                async for row in cursor:
                    bike_id = row['bike_id']
                    if bike_id not in all_bikes_data: continue
                    occupied_bike_ids.add(bike_id)
                    income = _get_income_from_details(row['details'])
                    all_bikes_data[bike_id]['rent_income_monthly'] += income
                    all_bikes_data[bike_id]['renters'].add(f"{row['first_name'] or ''} {row['last_name'] or ''}".strip())
                    
                    payment_date = datetime.strptime(row['timestamp'], '%Y-%m-%d %H:%M:%S')
                    period = _parse_period_from_details(row['details'])
                    start_rent, end_rent = (datetime.strptime(period[0], '%d.%m.%Y'), datetime.strptime(period[1], '%d.%m.%Y')) if period else (None, None)
                    if not period:
                        model_key = get_bike_model_key(all_bikes_data[bike_id]['model'] + all_bikes_data[bike_id]['vin'])
                        duration = _find_rental_period_from_price(model_key, income)
                        if duration: start_rent, end_rent = payment_date, payment_date + timedelta(days=duration)
                    if start_rent and end_rent:
                        overlap_start = max(start_rent.date(), start_date.date())
                        overlap_end = min(end_rent.date(), end_date.date())
                        if overlap_end >= overlap_start:
                            all_bikes_data[bike_id]['days_rented'] += (overlap_end - overlap_start).days + 1
            
            sql_buyout_deals = """
                SELECT b.id as bike_id, bo.payment_plan_key, bo.payments_made, b.name as bike_name, b.type as item_type,
                       u_client.first_name as client_fname, u_client.last_name as client_lname
                FROM bookings bo 
                JOIN bikes b ON bo.bike_id = b.id
                JOIN users u_client ON bo.user_id = u_client.id
                WHERE bo.booking_type = 'buyout' AND bo.status = 'rented'
            """
            async with conn.execute(sql_buyout_deals) as cursor:
                async for deal in cursor:
                    bike_id = deal['bike_id']
                    if bike_id not in all_bikes_data: continue
                    occupied_bike_ids.add(bike_id)
                    plan = _get_plan_details(deal['payment_plan_key'], deal['bike_name'], deal['item_type'])
                    if not plan: continue
                    
                    payments_made = deal['payments_made'] or 0
                    total_payments = plan.get('total_payments', 0)
                    payment_amount = plan.get('payment_amount') or plan.get('first_payment', 0)
                    
                    all_bikes_data[bike_id]['is_buyout'] = True
                    all_bikes_data[bike_id]['client_name'] = f"{deal['client_fname'] or ''} {deal['client_lname'] or ''}".strip()
                    all_bikes_data[bike_id]['cumulative_buyout_income'] = payments_made * payment_amount
                    all_bikes_data[bike_id]['total_deal_value'] = total_payments * payment_amount
                    all_bikes_data[bike_id]['remaining_debt'] = all_bikes_data[bike_id]['total_deal_value'] - all_bikes_data[bike_id]['cumulative_buyout_income']
                    all_bikes_data[bike_id]['progress_payments'] = f"{payments_made}/{total_payments}"
            
            total_expenses, expense_details = await _get_expense_data_for_period(conn, start_date, end_date)

    except Exception as e:
        logging.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—á–µ—Ç–∞: {e}", exc_info=True)
        return None
        
    # --- 2. –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ò –†–ê–ó–î–ï–õ–ï–ù–ò–ï –î–ê–ù–ù–´–• ---
    rent_report_items, buyout_report_items, free_bikes_report_items = [], [], []
    
    investor_name_filter = ""
    if investor_id:
        async with aiosqlite.connect(DB_FILE) as conn:
            cursor = await conn.execute("SELECT first_name, last_name FROM users WHERE id=?", (investor_id,))
            inv_user = await cursor.fetchone()
            if inv_user: investor_name_filter = f"{inv_user[0] or ''} {inv_user[1] or ''}".strip()

    for bike_id, data in all_bikes_data.items():
        passes_main_filter = False
        if report_type == 'own' and data['investor_name'] == '–ö–æ–º–ø–∞–Ω–∏—è': passes_main_filter = True
        elif report_type == 'investor' and data['investor_name'] != '–ö–æ–º–ø–∞–Ω–∏—è':
            if investor_id and data['investor_name'] == investor_name_filter: passes_main_filter = True
            elif not investor_id: passes_main_filter = True
        elif report_type == 'combined': passes_main_filter = True

        if passes_main_filter:
            if data['rent_income_monthly'] > 0:
                rent_report_items.append({'bike_id': bike_id, **data})
            if data['is_buyout']:
                buyout_report_items.append({'bike_id': bike_id, **data})
            if bike_id not in occupied_bike_ids:
                 free_bikes_report_items.append({'bike_id': bike_id, **data})

    # --- 3. –ì–ï–ù–ï–†–ê–¶–ò–Ø EXCEL –§–ê–ô–õ–ê ---
    if report_type == 'own':
        title = "–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞–º –∫–æ–º–ø–∞–Ω–∏–∏"
        filename_suffix = "own"
    elif report_type == 'investor':
        title = f"–û—Ç—á–µ—Ç –ø–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä—É: {investor_name_filter}" if investor_id else "–û—Ç—á–µ—Ç –ø–æ –≤—Å–µ–º –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º"
        filename_suffix = f"investor_{investor_id or 'all'}"
    else: # combined
        title = "–û–±—â–∏–π –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç"
        filename_suffix = "combined"

    workbook = openpyxl.Workbook()
    sheet = workbook.active
    _create_main_header(sheet, title, 8)
    _create_subtitle(sheet, 8)
    
    current_row = 5

    # --- –¢–ê–ë–õ–ò–¶–ê 1: –í–´–ö–£–ü ---
    if buyout_report_items:
        sheet.cell(row=current_row, column=1, value="–í—ã–∫—É–ø").font = Font(size=14, bold=True, color="1F497D")
        current_row += 1
        buyout_headers = ["‚Ññ", "–í–ª–∞–¥–µ–ª–µ—Ü", "–í–µ–ª–æ—Å–∏–ø–µ–¥", "–ö–ª–∏–µ–Ω—Ç", "–ü—Ä–æ–≥—Ä–µ—Å—Å (–ø–ª.)", "–ü—Ä–æ–≥—Ä–µ—Å—Å (‚ÇΩ)", "–û—Å—Ç–∞–ª–æ—Å—å –≤–Ω–µ—Å—Ç–∏ (‚ÇΩ)", "–û–±—â–∞—è —Å—É–º–º–∞"]
        _format_table_headers(sheet, current_row, buyout_headers)
        current_row += 1

        buyout_report_items.sort(key=lambda x: x.get('cumulative_buyout_income', 0.0), reverse=True)
        for item in buyout_report_items:
            progress_rub = f"{item.get('cumulative_buyout_income', 0):,.0f} / {item.get('total_deal_value', 0):,.0f} ‚ÇΩ".replace(",", " ")
            sheet.append([
                item.get("bike_id"), item.get("investor_name"), f"{item.get('model')} {item.get('vin')}",
                item.get('client_name'), item.get('progress_payments'), progress_rub,
                item.get('remaining_debt', 0.0), item.get('total_deal_value', 0.0)
            ])
        _format_data_rows_and_autofit(sheet, header_row=current_row - 1, data_start_row=current_row, currency_columns=[7, 8])
        current_row = sheet.max_row + 3

    # --- –¢–ê–ë–õ–ò–¶–ê 2: –ê–†–ï–ù–î–ê ---
    if rent_report_items:
        sheet.cell(row=current_row, column=1, value="–ê—Ä–µ–Ω–¥–∞").font = Font(size=14, bold=True, color="1F497D")
        current_row += 1
        rent_headers = ["‚Ññ", "–í–ª–∞–¥–µ–ª–µ—Ü", "–í–µ–ª–æ—Å–∏–ø–µ–¥", "–ö–ª–∏–µ–Ω—Ç", "–î–Ω–µ–π –≤ –∞—Ä–µ–Ω–¥–µ (–∑–∞ –ø–µ—Ä–∏–æ–¥)", "–û–±—â–∏–π –¥–æ—Ö–æ–¥ (—Ñ–∞–∫—Ç)"]
        _format_table_headers(sheet, current_row, rent_headers)
        current_row += 1

        rent_report_items.sort(key=lambda x: x.get('days_rented', 0), reverse=True)
        for item in rent_report_items:
            sheet.append([
                item.get("bike_id"), item.get("investor_name"), f"{item.get('model')} {item.get('vin')}",
                ", ".join(item.get('renters', {'-'})), item.get('days_rented', 0), item.get('rent_income_monthly', 0.0)
            ])
        _format_data_rows_and_autofit(sheet, header_row=current_row - 1, data_start_row=current_row, currency_columns=[6])
        current_row = sheet.max_row + 3
        
    # --- –¢–ê–ë–õ–ò–¶–ê 3: –°–í–û–ë–û–î–ù–´–ï –í–ï–õ–û–°–ò–ü–ï–î–´ ---
    if free_bikes_report_items:
        sheet.cell(row=current_row, column=1, value="–°–≤–æ–±–æ–¥–Ω—ã–µ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã").font = Font(size=14, bold=True, color="00B050")
        current_row += 1
        free_headers = ["‚Ññ", "–í–ª–∞–¥–µ–ª–µ—Ü", "–í–µ–ª–æ—Å–∏–ø–µ–¥"]
        _format_table_headers(sheet, current_row, free_headers)
        current_row += 1

        free_bikes_report_items.sort(key=lambda x: x['bike_id'])
        for item in free_bikes_report_items:
            sheet.append([
                item["bike_id"], item["investor_name"], f"{item['model']} {item['vin']}"
            ])
        _format_data_rows_and_autofit(sheet, header_row=current_row - 1, data_start_row=current_row, currency_columns=[])
        current_row = sheet.max_row + 2
    
    # --- –ò–¢–û–ì–ò –ò –†–ê–°–•–û–î–´ ---
    total_rent_monthly = sum(item.get('rent_income_monthly', 0.0) for item in rent_report_items)
    grand_total_income = total_rent_monthly
    
    _add_final_summary_with_expenses(sheet, grand_total_income, total_expenses, len(rent_report_items), 8)
    
    # --- –î–ò–ê–ì–†–ê–ú–ú–ê ---
    chart_data_row = sheet.max_row + 2
    sheet.cell(row=chart_data_row, column=1, value="–ö–∞—Ç–µ–≥–æ—Ä–∏—è")
    sheet.cell(row=chart_data_row, column=2, value="–°—É–º–º–∞")
    sheet.cell(row=chart_data_row + 1, column=1, value="–î–æ—Ö–æ–¥—ã")
    sheet.cell(row=chart_data_row + 1, column=2, value=grand_total_income)
    sheet.cell(row=chart_data_row + 2, column=1, value="–†–∞—Å—Ö–æ–¥—ã")
    sheet.cell(row=chart_data_row + 2, column=2, value=total_expenses)
    
    pie = PieChart()
    labels = Reference(sheet, min_col=1, min_row=chart_data_row + 1, max_row=chart_data_row + 2)
    data = Reference(sheet, min_col=2, min_row=chart_data_row, max_row=chart_data_row + 2)
    pie.add_data(data, titles_from_data=True)
    pie.set_categories(labels)
    pie.title = "–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –î–æ—Ö–æ–¥–æ–≤ –∏ –†–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –ü–µ—Ä–∏–æ–¥"
    pie.dataLabels = DataLabelList()
    pie.dataLabels.showPercent = True
    sheet.add_chart(pie, "J" + str(sheet.max_row - 5 if sheet.max_row > 5 else 2))
    
    # --- –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ ---
    if expense_details:
        expense_start_row = sheet.max_row + 3
        if "–î–∏–∞–≥—Ä–∞–º–º–∞" in str(sheet.cell(row=expense_start_row-1, column=1).value): # –î–æ–ø –æ—Ç—Å—Ç—É–ø –ø–æ—Å–ª–µ –¥–∏–∞–≥—Ä–∞–º–º—ã
            expense_start_row += 15 
        sheet.cell(row=expense_start_row, column=1, value="–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –ø–µ—Ä–∏–æ–¥").font = Font(size=14, bold=True, color="C00000")
        expense_headers = ["–î–∞—Ç–∞", "–ö–∞—Ç–µ–≥–æ—Ä–∏—è", "–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è", "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ", "–ö–æ–ª-–≤–æ", "–°—É–º–º–∞", "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"]
        _format_table_headers(sheet, expense_start_row + 1, expense_headers)
        for exp in expense_details:
            category_ru, subcategory_ru = _get_expense_labels(exp['category'], exp['subcategory'])
            sheet.append([exp['created_at'][:10], category_ru, subcategory_ru, exp['item_name'], exp['quantity'], exp['amount'], exp['comment']])
        _format_data_rows_and_autofit(sheet, header_row=expense_start_row + 1, data_start_row=expense_start_row + 2, currency_columns=[6])
    
    filename = os.path.join(REPORTS_PATH, f"unified_report_{filename_suffix}_{today.strftime('%Y-%m-%d')}.xlsx")
    workbook.save(filename)
    return filename

# === –ö–û–ù–ï–¶ –ë–õ–û–ö–ê 3 ===
async def _get_expense_data_for_period(conn: aiosqlite.Connection, start_date: datetime, end_date: datetime) -> tuple[float, list]:
    """–°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ —Ä–∞—Å—Ö–æ–¥—ã –∑–∞ –£–ö–ê–ó–ê–ù–ù–´–ô –ü–ï–†–ò–û–î."""
    start_date_str = start_date.strftime('%Y-%m-%d 00:00:00')
    end_date_str = end_date.strftime('%Y-%m-%d 23:59:59')
    
    cursor = await conn.execute(
        "SELECT created_at, category, subcategory, item_name, quantity, amount, comment FROM expenses WHERE created_at BETWEEN ? AND ? ORDER BY created_at", 
        (start_date_str, end_date_str)
    )
    expense_details = await cursor.fetchall()
    total_expenses = sum(row['amount'] for row in expense_details)
    return total_expenses, expense_details
# =======================================================================================
# –ö–û–ù–ï–¶ –ü–û–õ–ù–û–ô –§–£–ù–ö–¶–ò–ò
# =======================================================================================
async def start_report_generator(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ –∫–æ–º–∞–Ω–¥–µ /otchet –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –æ—Ç—á–µ—Ç–æ–≤.
    –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.
    """
    user_id = update.effective_user.id
    if not is_admin(user_id):
        await update.message.reply_text("üö´ –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.")
        return

    keyboard = [
        [InlineKeyboardButton("üìä –û—Ç—á–µ—Ç –ø–æ –Ω–∞—à–∏–º –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞–º", callback_data="report_generate_own")],
        [InlineKeyboardButton("üíº –û—Ç—á–µ—Ç –ø–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º", callback_data="report_menu_investor")],
        [InlineKeyboardButton("üåê –û–±—â–∏–π –æ—Ç—á–µ—Ç (—Å —Ä–∞—Å—Ö–æ–¥–∞–º–∏)", callback_data="report_generate_combined")],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        "üìà *–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ—Ç—á–µ—Ç–æ–≤*\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫–æ–π –æ—Ç—á–µ—Ç –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü:",
        reply_markup=reply_markup,
        parse_mode="Markdown"
    )

def _format_right_headers(sheet, start_row: int, start_col: int, headers: list):
    """–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –ø—Ä–∞–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã."""
    for i, header in enumerate(headers):
        cell = sheet.cell(row=start_row, column=start_col + i)
        cell.value = header
        cell.font = Font(name='Calibri', size=11, bold=True, color='FFFFFF')
        cell.fill = PatternFill(start_color="4F81BD", end_color="4F81BD", fill_type='solid')
        cell.alignment = Alignment(horizontal='center', vertical='center', wrap_text=True)
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ statistics_menu –ù–ê –≠–¢–£
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ statistics_menu –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
async def statistics_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Ä–∞–∑–¥–µ–ª–∞ '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', –∫–æ—Ç–æ—Ä–æ–µ —Ç–µ–ø–µ—Ä—å –∑–∞–ø—É—Å–∫–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –∑–∞–ø—Ä–æ—Å–∞ –¥–∞—Ç.
    """
    keyboard = [
        [InlineKeyboardButton("üìä –ù–∞—à–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã (–¥–µ—Ç–∞–ª—å–Ω–æ)", callback_data="stats_detailed_own")],
        [InlineKeyboardButton("üíº –í–µ–ª–∏–∫–∏ –ò–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ (–¥–µ—Ç–∞–ª—å–Ω–æ)", callback_data="stats_investor_menu")],
        [InlineKeyboardButton("üåê –û–±—â–∏–π –æ—Ç—á–µ—Ç (–¥–µ—Ç–∞–ª—å–Ω–æ)", callback_data="stats_detailed_combined")],
        [InlineKeyboardButton("üí∏ –û—Ç—á–µ—Ç –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º (–¥–µ—Ç–∞–ª—å–Ω–æ)", callback_data="stats_detailed_expenses")],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    message_text = "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ—Ç—á–µ—Ç–∞ –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è:"

    if update.callback_query:
        await update.callback_query.answer()
        await update.callback_query.edit_message_text(message_text, reply_markup=reply_markup)
    else:
        await update.message.reply_text(message_text, reply_markup=reply_markup)

# –®–ê–ì 2.1: –í–°–¢–ê–í–¨–¢–ï –≠–¢–£ –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ
async def _get_monthly_expense_data(conn: aiosqlite.Connection) -> tuple[float, list]:
    """–°–æ–±–∏—Ä–∞–µ—Ç –≤—Å–µ —Ä–∞—Å—Ö–æ–¥—ã –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü."""
    start_of_month_str = datetime.now().replace(day=1, hour=0, minute=0, second=0).strftime('%Y-%m-%d %H:%M:%S')
    cursor = await conn.execute("SELECT created_at, category, subcategory, item_name, quantity, amount, comment FROM expenses WHERE created_at >= ? ORDER BY created_at", (start_of_month_str,))
    expense_details = await cursor.fetchall()
    total_expenses = sum(row['amount'] for row in expense_details)
    return total_expenses, expense_details

def _add_final_summary_with_expenses(sheet, total_income: float, total_expenses: float, num_operations: int, col_span: int):
    """–î–æ–±–∞–≤–ª—è–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –±–ª–æ–∫ –∏—Ç–æ–≥–æ–≤ —Å –¥–æ—Ö–æ–¥–∞–º–∏, —Ä–∞—Å—Ö–æ–¥–∞–º–∏ –∏ —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª—å—é (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)."""
    summary_row = sheet.max_row + 3
    
    # --- –û–±—â–∏–π –¥–æ—Ö–æ–¥ ---
    label_cell_income = sheet.cell(row=summary_row, column=col_span - 1, value="–û–ë–©–ò–ô –î–û–•–û–î –ó–ê –ú–ï–°–Ø–¶:")
    label_cell_income.font = Font(name='Calibri', size=12, bold=True)
    label_cell_income.alignment = Alignment(horizontal='right')
    
    value_cell_income = sheet.cell(row=summary_row, column=col_span, value=total_income)
    value_cell_income.number_format = '#,##0.00 ‚ÇΩ'
    value_cell_income.font = Font(name='Calibri', size=12, bold=True)

    # --- –û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã ---
    label_cell_expense = sheet.cell(row=summary_row + 1, column=col_span - 1, value="–û–ë–©–ò–ï –†–ê–°–•–û–î–´ –ó–ê –ú–ï–°–Ø–¶:")
    label_cell_expense.font = Font(name='Calibri', size=12, bold=True, color="FF0000")
    label_cell_expense.alignment = Alignment(horizontal='right')
    
    value_cell_expense = sheet.cell(row=summary_row + 1, column=col_span, value=total_expenses)
    value_cell_expense.number_format = '#,##0.00 ‚ÇΩ'
    value_cell_expense.font = Font(name='Calibri', size=12, bold=True, color="FF0000")

    # --- –ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å ---
    net_income = total_income - total_expenses
    label_cell_net = sheet.cell(row=summary_row + 2, column=col_span - 1, value="–ß–ò–°–¢–ê–Ø –ü–†–ò–ë–´–õ–¨:")
    label_cell_net.font = Font(name='Calibri', size=14, bold=True, color="00B050")
    label_cell_net.alignment = Alignment(horizontal='right')
    
    value_cell_net = sheet.cell(row=summary_row + 2, column=col_span, value=net_income)
    value_cell_net.number_format = '#,##0.00 ‚ÇΩ'
    value_cell_net.font = Font(name='Calibri', size=14, bold=True, color="00B050")

    # === –ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ ===
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é —à–∏—Ä–∏–Ω—É –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤ —Å —Ç–µ–∫—Å—Ç–æ–º –∏ —Å —Å—É–º–º–∞–º–∏
    # –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ—ë, –µ—Å–ª–∏ –æ–Ω–∞ –±–æ–ª—å—à–µ —Ç–µ–∫—É—â–µ–π.
    
    # –®–∏—Ä–∏–Ω–∞ –¥–ª—è —Å—Ç–æ–ª–±—Ü–∞ —Å —Ç–µ–∫—Å—Ç–æ–º
    label_col_letter = get_column_letter(col_span - 1)
    required_label_width = len("–û–ë–©–ò–ô –î–û–•–û–î –ó–ê –ú–ï–°–Ø–¶:") + 2
    if sheet.column_dimensions[label_col_letter].width < required_label_width:
        sheet.column_dimensions[label_col_letter].width = required_label_width

    # –®–∏—Ä–∏–Ω–∞ –¥–ª—è —Å—Ç–æ–ª–±—Ü–∞ —Å —Å—É–º–º–∞–º–∏
    value_col_letter = get_column_letter(col_span)
    # –ù–∞—Ö–æ–¥–∏–º —Å–∞–º–æ–µ –¥–ª–∏–Ω–Ω–æ–µ —á–∏—Å–ª–æ –∏–∑ –∏—Ç–æ–≥–æ–≤
    max_value_len = max(len(f"{total_income:,.2f}"), len(f"{total_expenses:,.2f}"), len(f"{net_income:,.2f}"))
    required_value_width = max_value_len + 5 # +5 –¥–ª—è –∑–Ω–∞–∫–∞ —Ä—É–±–ª—è –∏ –æ—Ç—Å—Ç—É–ø–æ–≤
    if sheet.column_dimensions[value_col_letter].width < required_value_width:
        sheet.column_dimensions[value_col_letter].width = required_value_width
async def investor_stats_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–¥–º–µ–Ω—é –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ—Ç—á–µ—Ç–∞ –ø–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä—Å–∫–∏–º –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞–º:
    - –ü–æ –≤—Å–µ–º –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º —Å—Ä–∞–∑—É.
    - –í—ã–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞.
    """
    query = update.callback_query
    await query.answer()

    keyboard = [
        # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞ —Å—Ä–∞–∑—É –ø–æ –≤—Å–µ–º –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º
        [InlineKeyboardButton("üìä –û—Ç—á–µ—Ç –ø–æ –≤—Å–µ–º –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º", callback_data="stats_detailed_investor_all")],
        
        # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ø–∏—Å–∫—É –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ (–¥–æ–±–∞–≤–∏–º _0 –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ)
        [InlineKeyboardButton("üë§ –í—ã–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞", callback_data="stats_select_investor_0")], 
        
        # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞—Å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏", callback_data="stats_back_to_main")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.edit_message_text(
        "–û—Ç—á–µ—Ç—ã –ø–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä—Å–∫–∏–º –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞–º. –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=reply_markup
    )

async def income_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–¥–º–µ–Ω—é –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤ (–Ω–∞—à–∏, –∏–Ω–≤–µ—Å—Ç–æ—Ä—Å–∫–∏–µ, –≤—Å–µ)."""
    query = update.callback_query
    await query.answer()

    income_type = query.data.split('_')[1] # 'rent' –∏–ª–∏ 'buyout'

    keyboard = [
        [InlineKeyboardButton("üö≤ –ù–∞—à–∏", callback_data=f"stats_report_{income_type}_own")],
        [InlineKeyboardButton("üíº –ò–Ω–≤–µ—Å—Ç–æ—Ä—Å–∫–∏–µ", callback_data=f"stats_report_{income_type}_investor")],
        [InlineKeyboardButton("üåê –í—Å–µ", callback_data=f"stats_report_{income_type}_all")],
        [InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="stats_back_to_main")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    title = "–ø–æ –∞—Ä–µ–Ω–¥–µ" if income_type == "rent" else "–ø–æ –≤—ã–∫—É–ø—É"
    await query.edit_message_text(f"–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Ö–æ–¥–æ–≤ {title}. \n–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤:", reply_markup=reply_markup)


def _get_income_from_details(details: str) -> float:
    """–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—É–º–º—ã –∏–∑ —Å—Ç—Ä–æ–∫–∏ 'details'."""
    if not details:
        return 0.0
    # –ò—â–µ–º —á–∏—Å–ª–æ (—Ü–µ–ª–æ–µ –∏–ª–∏ —Å —Ç–æ—á–∫–æ–π/–∑–∞–ø—è—Ç–æ–π) –ø–æ—Å–ª–µ —Å–ª–æ–≤–∞ "—Å—É–º–º–∞:"
    match = re.search(r'—Å—É–º–º–∞:\s*([\d\.,]+)', details, re.IGNORECASE)
    if match:
        try:
            # –ó–∞–º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—É—é –Ω–∞ —Ç–æ—á–∫—É –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ float
            return float(match.group(1).replace(',', '.'))
        except (ValueError, IndexError):
            return 0.0
    return 0.0

async def show_income_report(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –í—ã–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä Excel-–æ—Ç—á–µ—Ç–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∞–π–ª.
    """
    query = update.callback_query
    await query.answer()
    await query.edit_message_text("‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é Excel-–æ—Ç—á–µ—Ç, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 30 —Å–µ–∫—É–Ω–¥...")

    try:
        parts = query.data.split('_')
        income_type = parts[2]
        owner_type = parts[3]

        filename = None
        if income_type == 'rent':
            filename = await generate_rent_excel_report(owner_type)
        else: # buyout
            filename = await generate_buyout_excel_report(owner_type)

        if filename and os.path.exists(filename):
            with open(filename, 'rb') as file:
                await context.bot.send_document(
                    chat_id=query.message.chat.id,
                    document=file,
                    caption=f"‚úÖ –í–∞—à –æ—Ç—á–µ—Ç –ø–æ –¥–æ—Ö–æ–¥–∞–º –≥–æ—Ç–æ–≤."
                )
            os.remove(filename) # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
            await query.message.delete() # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–ì–µ–Ω–µ—Ä–∏—Ä—É—é..."
        else:
            await query.edit_message_text("üòî –í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç—á–µ—Ç–∞ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü.")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Excel-–æ—Ç—á–µ—Ç–∞: {e}", exc_info=True)
        await query.edit_message_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")

# <<< –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê –ö–û–î–ê –î–õ–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ò >>>    
# =======================================================================================
# –ù–û–í–´–ô –ú–û–î–£–õ–¨ –ì–ï–ù–ï–†–ê–¶–ò–ò EXCEL-–û–¢–ß–ï–¢–û–í –° –£–ß–ï–¢–û–ú –†–ê–°–•–û–î–û–í
# =======================================================================================
# –®–ê–ì 2.1: –í–°–¢–ê–í–¨–¢–ï –≠–¢–£ –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ –î–õ–Ø –ú–ï–ù–Æ –ò–ù–í–ï–°–¢–û–†–û–í

# =======================================================================================
# –§–ò–ù–ê–õ–¨–ù–´–ô –ë–õ–û–ö –ö–û–î–ê –î–õ–Ø –ù–û–í–û–ì–û –ì–ï–ù–ï–†–ê–¢–û–†–ê –û–¢–ß–ï–¢–û–í –° –†–ê–°–•–û–î–ê–ú–ò
# –í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –±–ª–æ–∫ –≤ –≤–∞—à –∫–æ–¥.
# =======================================================================================

# --- –ù–û–í–ê–Ø –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –°–ë–û–†–ê –î–ê–ù–ù–´–• –ü–û –í–´–ö–£–ü–ê–ú (–≤–µ—Ä—Å–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞) ---
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ _get_new_buyout_data_for_report –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –°–¢–ê–†–£–Æ –§–£–ù–ö–¶–ò–Æ _get_new_buyout_data_for_report –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ _get_buyout_data_for_report –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ _get_buyout_data_for_report –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
async def _get_buyout_data_for_report(conn: aiosqlite.Connection, owner_filter_sql: str, owner_filter_params: tuple):
    stats = defaultdict(lambda: {'bikes': {}})
    today = datetime.now()
    start_of_month_str = today.replace(day=1, hour=0, minute=0, second=0).strftime('%Y-%m-%d %H:%M:%S')
    sql_deals = f"""
        SELECT b.id as bike_id, b.name as bike_name, u_investor.first_name as investor_fname, 
               u_investor.last_name as investor_lname, bo.payment_plan_key, bo.payments_made, b.type as item_type
        FROM bookings bo JOIN bikes b ON bo.bike_id = b.id LEFT JOIN users u_investor ON b.investor_id = u_investor.id
        WHERE bo.booking_type = 'buyout' AND bo.status = 'rented' {owner_filter_sql}
    """
    async with conn.execute(sql_deals, owner_filter_params) as cursor:
        async for deal in cursor:
            plan = _get_plan_details(deal['payment_plan_key'], deal['bike_name'], deal['item_type'])
            if not plan: continue
            owner_name = "–ö–æ–º–ø–∞–Ω–∏—è" if "IS NULL" in owner_filter_sql else f"{deal['first_name'] or ''} {deal['last_name'] or ''}".strip()
            payments_made = deal['payments_made'] or 0
            total_payments = plan.get('total_payments', 0)
            payment_amount = plan.get('payment_amount') or plan.get('first_payment', 0)
            paid_amount = payments_made * payment_amount
            total_deal_value = total_payments * payment_amount
            remaining_debt = total_deal_value - paid_amount # <-- –†–ê–°–ß–ï–¢ –û–°–¢–ê–¢–ö–ê –î–û–õ–ì–ê
            stats[owner_name]['bikes'][deal['bike_id']] = {
                'monthly_income': 0.0,
                'cumulative_income': paid_amount,
                'remaining_debt': remaining_debt if remaining_debt > 0 else 0, # <-- –ù–û–í–û–ï –ü–û–õ–ï
                'progress_payments': f"{payments_made}/{total_payments}"
            }
    sql_income = f"""
        SELECT b.id as bike_id, u_investor.first_name, u_investor.last_name, bh.details
        FROM bike_history bh JOIN bikes b ON bh.bike_id = b.id LEFT JOIN users u_investor ON b.investor_id = u_investor.id
        WHERE bh.action IN ('–í—ã–∫—É–ø (1-–π –≤–∑–Ω–æ—Å)', '–ü–ª–∞—Ç–µ–∂ –ø–æ –≤—ã–∫—É–ø—É', '–î–æ—Å—Ä–æ—á–Ω–æ–µ –ø–æ–≥–∞—à–µ–Ω–∏–µ', '–í—ã–∫—É–ø –ê–ö–ë (1-–π –≤–∑–Ω–æ—Å)', '–ü–ª–∞—Ç–µ–∂ –ø–æ –≤—ã–∫—É–ø—É (–ê–ö–ë)')
        AND bh.timestamp >= ? {owner_filter_sql}
    """
    async with conn.execute(sql_income, (start_of_month_str,) + owner_filter_params) as cursor:
        async for row in cursor:
            owner_name = "–ö–æ–º–ø–∞–Ω–∏—è" if "IS NULL" in owner_filter_sql else f"{row['first_name'] or ''} {row['last_name'] or ''}".strip()
            if owner_name in stats and row['bike_id'] in stats[owner_name]['bikes']:
                income = _get_income_from_details(row['details'])
                stats[owner_name]['bikes'][row['bike_id']]['monthly_income'] += income
    return stats


# --- –ù–û–í–´–ô –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –ì–ï–ù–ï–†–ê–¢–û–† –û–¢–ß–ï–¢–û–í ---
# –ó–ê–ú–ï–ù–ò–¢–ï –í–ê–®–£ –§–£–ù–ö–¶–ò–Æ generate_new_master_report –ù–ê –≠–¢–£ –í–ï–†–°–ò–Æ
async def generate_new_master_report(report_type: str, investor_id: int | None = None) -> str:
    today = datetime.now()
    start_of_month_str = today.replace(day=1, hour=0, minute=0, second=0).strftime('%Y-%m-%d %H:%M:%S')

    income_data = defaultdict(lambda: {
        'rent_income': 0.0, 
        'buyout_monthly_income': 0.0, 
        'buyout_cumulative_income': 0.0, # <-- –ù–û–í–û–ï –ü–û–õ–ï
        'bike_name': '', 
        'investor_name': '–ö–æ–º–ø–∞–Ω–∏—è'
    })
    total_expenses = 0.0

    async with aiosqlite.connect(DB_FILE) as conn:
        conn.row_factory = aiosqlite.Row
        
        # 1.1 –°–±–æ—Ä –¥–æ—Ö–æ–¥–æ–≤ –æ—Ç –ê–†–ï–ù–î–´ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        sql_rent_income = """
            SELECT b.id as bike_id, b.name as bike_name, bh.details, u_investor.first_name, u_investor.last_name, b.investor_id
            FROM bike_history bh JOIN bikes b ON bh.bike_id = b.id LEFT JOIN users u_investor ON b.investor_id = u_investor.id
            WHERE bh.action IN ('–û–ø–ª–∞—Ç–∞ –∞—Ä–µ–Ω–¥—ã', '–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥—ã', '–ê—Ä–µ–Ω–¥–∞', '–ê—Ä–µ–Ω–¥–∞ –¥–æ–ø. –ê–ö–ë') AND bh.timestamp >= ?
        """
        async with conn.execute(sql_rent_income, (start_of_month_str,)) as cursor:
            async for row in cursor:
                income = _get_income_from_details(row['details'])
                bike_id = row['bike_id']
                income_data[bike_id]['bike_name'] = row['bike_name']
                if row['investor_id']:
                    income_data[bike_id]['investor_name'] = f"{row['first_name'] or ''} {row['last_name'] or ''}".strip()
                income_data[bike_id]['rent_income'] += income

        # 1.2 –°–±–æ—Ä –¥–æ—Ö–æ–¥–æ–≤ –æ—Ç –í–´–ö–£–ü–ê (–∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é –ª–æ–≥–∏–∫—É)
        buyout_data_inv = await _get_new_buyout_data_for_report(conn, "AND b.investor_id IS NOT NULL", ())
        buyout_data_own = await _get_new_buyout_data_for_report(conn, "AND b.investor_id IS NULL", ())
        
        all_buyout_data = {**buyout_data_inv, **buyout_data_own}
        for owner, data in all_buyout_data.items():
            for bike_id, bike_data in data['bikes'].items():
                income_data[bike_id]['buyout_monthly_income'] += bike_data['monthly_income']
                income_data[bike_id]['buyout_cumulative_income'] = bike_data['cumulative_income'] # <-- –°–û–•–†–ê–ù–Ø–ï–ú –û–ë–©–ò–ô –î–û–•–û–î
                if not income_data[bike_id]['bike_name']:
                     bike_cursor = await conn.execute("SELECT name FROM bikes where id = ?", (bike_id,))
                     bike_name_row = await bike_cursor.fetchone()
                     if bike_name_row: income_data[bike_id]['bike_name'] = bike_name_row[0]
                if owner != "–ö–æ–º–ø–∞–Ω–∏—è":
                    income_data[bike_id]['investor_name'] = owner
        
        # 1.3 –°–±–æ—Ä —Ä–∞—Å—Ö–æ–¥–æ–≤ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        cursor = await conn.execute("SELECT amount FROM expenses WHERE created_at >= ?", (start_of_month_str,))
        expenses = await cursor.fetchall()
        if expenses:
            total_expenses = sum(e['amount'] for e in expenses)

    # --- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    report_items = []
    title = ""
    filename_suffix = ""
    if report_type == 'own':
        title = "–û—Ç—á–µ—Ç –ø–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞–º –∫–æ–º–ø–∞–Ω–∏–∏"
        filename_suffix = "own"
        for bike_id, data in income_data.items():
            if data['investor_name'] == '–ö–æ–º–ø–∞–Ω–∏—è':
                report_items.append({'bike_id': bike_id, **data})
    elif report_type == 'investor':
        # ... (–ª–æ–≥–∏–∫–∞ –¥–ª—è –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π)
        title = "–û—Ç—á–µ—Ç –ø–æ –≤—Å–µ–º –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º"
        filename_suffix = "investors_all"
        if investor_id:
            async with aiosqlite.connect(DB_FILE) as conn:
                cursor = await conn.execute("SELECT first_name, last_name FROM users WHERE id=?", (investor_id,))
                inv_user = await cursor.fetchone()
                investor_name_filter = f"{inv_user[0] or ''} {inv_user[1] or ''}".strip()
                title = f"–û—Ç—á–µ—Ç –ø–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä—É: {investor_name_filter}"
                filename_suffix = f"investor_{investor_id}"
            for bike_id, data in income_data.items():
                if data['investor_name'] == investor_name_filter:
                    report_items.append({'bike_id': bike_id, **data})
        else:
            for bike_id, data in income_data.items():
                if data['investor_name'] != '–ö–æ–º–ø–∞–Ω–∏—è':
                    report_items.append({'bike_id': bike_id, **data})
    elif report_type == 'combined':
        title = "–û–±—â–∏–π –æ—Ç—á–µ—Ç –ø–æ –≤—Å–µ–º –¥–æ—Ö–æ–¥–∞–º –∏ —Ä–∞—Å—Ö–æ–¥–∞–º"
        filename_suffix = "combined"
        for bike_id, data in income_data.items():
            report_items.append({'bike_id': bike_id, **data})

    # --- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Excel —Ñ–∞–π–ª–∞ ---
    workbook = openpyxl.Workbook()
    sheet = workbook.active
    headers = ["‚Ññ", "–í–ª–∞–¥–µ–ª–µ—Ü", "–í–µ–ª–æ—Å–∏–ø–µ–¥", "–î–æ—Ö–æ–¥ –æ—Ç –∞—Ä–µ–Ω–¥—ã", "–î–æ—Ö–æ–¥ –æ—Ç –≤—ã–∫—É–ø–∞", "–û–±—â–∏–π –¥–æ—Ö–æ–¥"]
    _create_main_header(sheet, title, len(headers))
    _create_subtitle(sheet, len(headers))
    _format_table_headers(sheet, 4, headers)

    total_rent = sum(item['rent_income'] for item in report_items)
    total_buyout_monthly = sum(item['buyout_monthly_income'] for item in report_items)
    
    report_items.sort(key=lambda x: x['rent_income'] + x['buyout_cumulative_income'], reverse=True)

    for item in report_items:
        # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –í –∫–æ–ª–æ–Ω–∫—É "–î–æ—Ö–æ–¥ –æ—Ç –≤—ã–∫—É–ø–∞" —Ç–µ–ø–µ—Ä—å –∏–¥–µ—Ç –û–ë–©–ê–Ø –°–£–ú–ú–ê >>>
        sheet.append([
            item["bike_id"], item["investor_name"], item["bike_name"],
            item["rent_income"],
            item["buyout_cumulative_income"], # <-- –ò–ó–ú–ï–ù–ï–ù–û
            item['rent_income'] + item['buyout_cumulative_income']
        ])
    
    _format_data_rows_and_autofit(sheet, header_row=4, data_start_row=5, currency_columns=[4, 5, 6])

    # --- –ë–ª–æ–∫ –∏—Ç–æ–≥–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–æ—Ö–æ–¥ –∑–∞ –ú–ï–°–Ø–¶) ---
    summary_row = sheet.max_row + 2
    sheet.cell(row=summary_row, column=4, value="–û–±—â–∏–π –¥–æ—Ö–æ–¥ –æ—Ç –∞—Ä–µ–Ω–¥—ã (–∑–∞ –º–µ—Å—è—Ü):").font = Font(bold=True)
    sheet.cell(row=summary_row, column=5, value=total_rent).number_format = '#,##0.00 ‚ÇΩ'
    sheet.cell(row=summary_row + 1, column=4, value="–û–±—â–∏–π –¥–æ—Ö–æ–¥ –æ—Ç –≤—ã–∫—É–ø–∞ (–∑–∞ –º–µ—Å—è—Ü):").font = Font(bold=True)
    sheet.cell(row=summary_row + 1, column=5, value=total_buyout_monthly).number_format = '#,##0.00 ‚ÇΩ'
    sheet.cell(row=summary_row + 2, column=4, value="–û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã –∑–∞ –º–µ—Å—è—Ü:").font = Font(bold=True, color="FF0000")
    sheet.cell(row=summary_row + 2, column=5, value=total_expenses).number_format = '#,##0.00 ‚ÇΩ'
    net_income = total_rent + total_buyout_monthly - total_expenses
    sheet.cell(row=summary_row + 3, column=4, value="–ß–ò–°–¢–ê–Ø –ü–†–ò–ë–´–õ–¨ (–∑–∞ –º–µ—Å—è—Ü):").font = Font(bold=True, size=14, color="00B050")
    total_cell = sheet.cell(row=summary_row + 3, column=5, value=net_income)
    total_cell.font = Font(bold=True, size=14)
    total_cell.number_format = '#,##0.00 ‚ÇΩ'

    filename = os.path.join(REPORTS_PATH, f"new_report_{filename_suffix}_{today.strftime('%Y-%m')}.xlsx")
    workbook.save(filename)
    return filename

async def send_new_generated_report(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ù–û–í–û–ô —Å–∏—Å—Ç–µ–º—ã –æ—Ç—á–µ—Ç–æ–≤.
    """
    query = update.callback_query
    await query.answer()
    
    parts = query.data.split('_')  # e.g., ['new', 'report', 'generate', 'own'] or ['new', 'report', 'generate', 'investor', '12345']
    report_type = parts[3]
    investor_id = int(parts[4]) if len(parts) > 4 and parts[4].isdigit() else None
    
    status_message = await query.edit_message_text("‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é Excel-–æ—Ç—á–µ—Ç, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ –º–∏–Ω—É—Ç—ã...")

    try:
        filename = await generate_new_master_report(report_type=report_type, investor_id=investor_id)

        if filename and os.path.exists(filename):
            with open(filename, 'rb') as file:
                await context.bot.send_document(
                    chat_id=query.from_user.id,
                    document=file,
                    caption="‚úÖ –í–∞—à —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç –≥–æ—Ç–æ–≤."
                )
            os.remove(filename)
            await status_message.delete()
        else:
            await status_message.edit_message_text("üòî –î–∞–Ω–Ω—ã—Ö –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞ ({report_type}): {e}", exc_info=True)
        await status_message.edit_message_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")

async def new_report_investor_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ù–û–í–û–ï –º–µ–Ω—é –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ—Ç—á–µ—Ç–∞ –ø–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º:
    - –ü–æ –≤—Å–µ–º –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º —Å—Ä–∞–∑—É.
    - –í—ã–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞.
    """
    query = update.callback_query
    await query.answer()

    # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –ï—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç, –Ω–∞—á–∏–Ω–∞–µ–º —Å 0.
    page = int(query.data.split('_')[-1]) if query.data.startswith('new_report_inv_list_') else 0
    PAGE_SIZE = 5

    try:
        async with aiosqlite.connect(DB_FILE) as conn:
            conn.row_factory = aiosqlite.Row
            count_cursor = await conn.execute("SELECT COUNT(DISTINCT investor_id) FROM bikes WHERE investor_id IS NOT NULL")
            total_items = (await count_cursor.fetchone())[0]

            if total_items == 0:
                await query.edit_message_text(
                    "–ù–µ –Ω–∞–π–¥–µ–Ω–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º–∏ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞–º–∏.",
                    reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="new_report_back_to_main")]])
                )
                return

            cursor = await conn.execute(
                """SELECT DISTINCT b.investor_id, u.first_name, u.last_name
                   FROM bikes b JOIN users u ON b.investor_id = u.id
                   WHERE b.investor_id IS NOT NULL ORDER BY u.last_name, u.first_name
                   LIMIT ? OFFSET ?""",
                (PAGE_SIZE, page * PAGE_SIZE)
            )
            investors = await cursor.fetchall()

        keyboard = [
            # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç—á–µ—Ç–∞ –ø–æ –≤—Å–µ–º –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º
            [InlineKeyboardButton("üìä –û—Ç—á–µ—Ç –ø–æ –≤—Å–µ–º –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º", callback_data="new_report_generate_investor_all")],
        ]
        
        # –ö–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞
        for inv in investors:
            keyboard.append([InlineKeyboardButton(
                f"{inv['first_name']} {inv['last_name'] or ''}",
                callback_data=f"new_report_generate_investor_{inv['investor_id']}"
            )])

        # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
        total_pages = (total_items + PAGE_SIZE - 1) // PAGE_SIZE
        pagination_row = []
        if page > 0:
            pagination_row.append(InlineKeyboardButton("‚¨ÖÔ∏è", callback_data=f"new_report_inv_list_{page - 1}"))
        if page < total_pages - 1:
            pagination_row.append(InlineKeyboardButton("‚û°Ô∏è", callback_data=f"new_report_inv_list_{page + 1}"))
        
        if pagination_row: keyboard.append(pagination_row)
        
        # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
        keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="new_report_back_to_main")])

        await query.edit_message_text(
            f"–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞ –¥–ª—è –æ—Ç—á–µ—Ç–∞ –∏–ª–∏ –∑–∞–ø—Ä–æ—Å–∏—Ç–µ –æ—Ç—á–µ—Ç –ø–æ –≤—Å–µ–º —Å—Ä–∞–∑—É (–°—Ç—Ä. {page + 1}/{total_pages}):",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ –¥–ª—è –Ω–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞: {e}", exc_info=True)
        await query.edit_message_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤.")
# –®–ê–ì 1.1: –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ

async def start_new_report_generator(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ –∫–æ–º–∞–Ω–¥–µ /otchet –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –æ—Ç—á–µ—Ç–æ–≤.
    –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.
    """
    user_id = update.effective_user.id
    if not is_admin(user_id):
        await update.message.reply_text("üö´ –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.")
        return

    keyboard = [
        [InlineKeyboardButton("üìä –û—Ç—á–µ—Ç –ø–æ –Ω–∞—à–∏–º –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞–º", callback_data="new_report_generate_own")],
        [InlineKeyboardButton("üíº –û—Ç—á–µ—Ç –ø–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º", callback_data="new_report_investor_menu")],
        [InlineKeyboardButton("üåê –û–±—â–∏–π –æ—Ç—á–µ—Ç", callback_data="new_report_generate_combined")],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        "üìà *–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ—Ç—á–µ—Ç–æ–≤*\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫–æ–π –æ—Ç—á–µ—Ç —Å —É—á–µ—Ç–æ–º —Ä–∞—Å—Ö–æ–¥–æ–≤ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü:",
        reply_markup=reply_markup,
        parse_mode="Markdown"
    )
# –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞

def main():
    # –°–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö üèóÔ∏è
    setup_database()
    job_queue = JobQueue()
    
    # –°–Ω–∞—á–∞–ª–∞ –æ–±—ä—è–≤–ª—è–µ–º, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è application –±—É–¥–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω–æ–π
    global application 
    
    # –ó–∞—Ç–µ–º –ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –µ–π –∑–Ω–∞—á–µ–Ω–∏–µ
    application = (
        Application.builder()
        .token("7393557373:AAFB6NTTd551raYDASM7d1XhvP9wAFlVmpY")
        .job_queue(job_queue)
        .post_init(post_init) 
        .build()
    )
    set_tariffs_from_card_handler = ConversationHandler(
    entry_points=[CallbackQueryHandler(start_set_tariffs_from_card, pattern="^set_rent_tariffs_")],
    states={
        AWAIT_RENT_TARIFFS_FROM_CARD: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_rent_tariffs_from_card)],
    },
    fallbacks=[CommandHandler("cancel", cancel_edit_bike)], # –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–º–µ–Ω—ã
)
    application.add_handler(set_tariffs_from_card_handler)
    application.add_handler(CallbackQueryHandler(request_extension, pattern=r"^auto_prolong_"))
    application.add_handler(CallbackQueryHandler(request_extension, pattern=r"^auto_prolong_7_"))
    application.add_handler(CallbackQueryHandler(accept_extension, pattern=r"^accept_extension_"))
    manage_rentals_handler = ConversationHandler(
    entry_points=[
        MessageHandler(filters.Regex("^üóìÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—Ä–µ–Ω–¥–∞–º–∏$"), manage_rentals)
    ],
    states={
        MANAGE_RENTALS_MENU: [
            CallbackQueryHandler(show_filtered_rentals, pattern="^rental_filter_"),
            CallbackQueryHandler(poisk_start, pattern="^poisk_start$"),
            # ADD THIS LINE:
            CallbackQueryHandler(handle_search_pagination, pattern="^search_page_") 
        ],
        AWAITING_POISK_INPUT: [
            MessageHandler(filters.TEXT & ~filters.COMMAND, poisk_handle)
        ],
    },
    fallbacks=[
        CommandHandler("cancel", cancel_repair), 
        CallbackQueryHandler(cancel_repair, pattern="^cancel_repair$")
    ],
    allow_reentry=True
)
    application.add_handler(manage_rentals_handler)
    application.add_handler(CallbackQueryHandler(new_report_investor_menu, pattern="^new_report_investor_menu$|^new_report_inv_list_"))
    edit_buyout_handler = ConversationHandler(
    entry_points=[CallbackQueryHandler(edit_buyout_plan_start, pattern=r"^edit_buyout_")],
    states={
        AWAIT_TOTAL_PAYMENTS: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_new_total_payments)],
        AWAIT_PAYMENT_AMOUNT: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_new_payment_amount)],
        AWAIT_PERIOD_DAYS: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_updated_buyout_plan)], # <-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
    },
    fallbacks=[CommandHandler("cancel", universal_cancel)], # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã
)
    
    application.add_handler(edit_buyout_handler)
    detailed_stats_handler = ConversationHandler(
        entry_points=[
            # –≠—Ç–æ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –∏–∑ –º–µ–Ω—é "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"
            CallbackQueryHandler(start_detailed_report_date_prompt, pattern="^stats_detailed_")
        ],
        states={
            STATS_AWAIT_DATE_RANGE: [MessageHandler(filters.TEXT & ~filters.COMMAND, process_detailed_report_dates)],
        },
        fallbacks=[CommandHandler("cancel", universal_cancel)],
        allow_reentry=True
    )
    application.add_handler(detailed_stats_handler)
    application.add_handler(edit_buyout_handler)
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥", –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –Ω–æ–≤–æ–≥–æ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞
    application.add_handler(CallbackQueryHandler(send_new_generated_report, pattern="^new_report_generate_"))
    application.add_handler(CallbackQueryHandler(start_new_report_generator, pattern="^new_report_back_to_main$"))
    application.add_handler(CallbackQueryHandler(report_investor_menu, pattern="^report_menu_investor$|^report_investor_list_"))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
    application.add_handler(CallbackQueryHandler(start_report_generator, pattern="^report_back_to_main$"))
    application.add_handler(CallbackQueryHandler(select_investor_for_report, pattern="^stats_select_investor_"))
    application.add_handler(CallbackQueryHandler(send_detailed_report, pattern="^stats_detailed_"))
    application.add_handler(CallbackQueryHandler(investor_stats_menu, pattern="^stats_investor_menu$"))
    application.add_handler(CallbackQueryHandler(statistics_menu, pattern="^stats_back_to_main$"))
    expense_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex("^üí∞ –†–∞—Å—Ö–æ–¥—ã$"), start_expense_logging)],
        states={
            # –°—Ç–∞—Ä—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –æ–±—â–∏—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤
            EXP_SELECT_CATEGORY: [CallbackQueryHandler(select_main_category, pattern="^exp_cat_")],
            EXP_SELECT_SUBCATEGORY: [CallbackQueryHandler(select_subcategory, pattern="^(exp_sub_|exp_back_to_main)")],
            EXP_AWAIT_ITEM_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_item_name)],
            EXP_AWAIT_QUANTITY: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_quantity)],
            EXP_AWAIT_AMOUNT: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_amount)],
            EXP_AWAIT_COMMENT: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, save_expense),
                CallbackQueryHandler(save_expense, pattern="^exp_skip_comment$")
            ],
            # –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã
            BEXP_AWAIT_BIKE_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_bike_name_for_expense)],
            BEXP_AWAIT_EXPENSE_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_expense_name_for_bike)],
            BEXP_AWAIT_AMOUNT: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_amount_for_bike_expense)],
            BEXP_AWAIT_COMMENT: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, save_bike_specific_expense),
                CallbackQueryHandler(save_bike_specific_expense, pattern="^bexp_skip_comment$")
            ]
        },
        fallbacks=[
            CommandHandler("cancel", cancel),
            CallbackQueryHandler(lambda u,c: u.callback_query.edit_message_text("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.") or ConversationHandler.END, pattern="^exp_cancel$"),
        ],
        allow_reentry=True
    )
    application.add_handler(expense_handler)

    # --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–∞ –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º ---
    expense_report_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex("^üìä –û—Ç—á–µ—Ç—ã –ø–æ —Ä–∞—Å—Ö–æ–¥–∞–º$"), start_report_generation)],
        states={
            AWAIT_EXPENSE_REPORT_DATES: [MessageHandler(filters.TEXT & ~filters.COMMAND, process_date_range_for_report)],
        },
        fallbacks=[
            # --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ—Ç–º–µ–Ω—ã ---
            MessageHandler(filters.Regex("^‚ùå –û—Ç–º–µ–Ω–∞$"), universal_cancel),
            CommandHandler("cancel", universal_cancel)
            # --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø ---
        ]
    )
    edit_payments_handler = ConversationHandler(
    entry_points=[CallbackQueryHandler(edit_payments_start, pattern=r"^edit_payments_")],
    states={
        AWAIT_NEW_PAYMENT_COUNT: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_new_payment_count)],
    },
    fallbacks=[CommandHandler("cancel", universal_cancel)],
)
    application.add_handler(edit_payments_handler)
    cancel_buyout_handler = ConversationHandler(
    entry_points=[CallbackQueryHandler(cancel_buyout_start, pattern=r"^cancel_buyout_")],
    states={
        CONFIRM_CANCEL_BUYOUT: [CallbackQueryHandler(cancel_buyout_confirm, pattern=r"^confirm_cancel_buyout_")],
    },
    fallbacks=[CommandHandler("cancel", universal_cancel)],
)
    application.add_handler(cancel_buyout_handler)

    application.add_handler(expense_report_handler)
    application.add_handler(expense_report_handler)
    application.add_handler(CallbackQueryHandler(admin_add_extra_day, pattern="^admin_add_day_"))
    application.add_handler(CallbackQueryHandler(admin_show_payment_history, pattern="^admin_payment_history_"))

    admin_fine_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(admin_start_fine, pattern="^admin_fine_")],
        states={
            ADMIN_AWAIT_FINE_AMOUNT: [MessageHandler(filters.TEXT & ~filters.COMMAND, admin_process_fine_amount)],
            ADMIN_AWAIT_FINE_REASON: [MessageHandler(filters.TEXT & ~filters.COMMAND, admin_process_fine_reason)],
            # –°–æ—Å—Ç–æ—è–Ω–∏–µ ADMIN_AWAIT_FINE_DUE_DATE –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω–æ
        },
        fallbacks=[CommandHandler("cancel", cancel_fine)],
    )
    application.add_handler(admin_fine_handler)

    admin_discount_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(admin_start_discount, pattern="^admin_discount_")],
        states={
            ADMIN_AWAIT_DISCOUNT_AMOUNT: [MessageHandler(filters.TEXT & ~filters.COMMAND, admin_process_discount_amount)],
            ADMIN_AWAIT_DISCOUNT_REASON: [MessageHandler(filters.TEXT & ~filters.COMMAND, admin_process_discount_reason)],
            ADMIN_AWAIT_DISCOUNT_DURATION: [MessageHandler(filters.TEXT & ~filters.COMMAND, admin_process_discount_duration)],
        },
        fallbacks=[CommandHandler("cancel", cancel_discount_process)],
    )
    application.add_handler(admin_discount_handler)
    application.add_handler(admin_discount_handler)
    application.add_handler(CallbackQueryHandler(show_filtered_rentals, pattern="^rental_filter_"))
    application.add_handler(CallbackQueryHandler(show_investor_list_details, pattern=r"^inv_list_investors_"))
    application.add_handler(CallbackQueryHandler(show_investment_stats, pattern=r"^inv_show_stats$"))
    application.add_handler(CallbackQueryHandler(investment_main_menu, pattern=r"^inv_back_to_main$"))
    application.add_handler(CallbackQueryHandler(show_filtered_bike_list, pattern="^list_bikes_category_"))
    assign_asset_handler = ConversationHandler(
    entry_points=[CallbackQueryHandler(assign_asset_start, pattern=r"^inv_assign_start$")],
    states={
        INV_AWAIT_USER_SEARCH: [MessageHandler(filters.TEXT & ~filters.COMMAND, search_user_for_assign)],
        INV_SELECT_USER: [CallbackQueryHandler(select_user_for_assign, pattern=r"^inv_assign_user_")],
        INV_AWAIT_BIKE_SEARCH: [MessageHandler(filters.TEXT & ~filters.COMMAND, search_bike_for_assign)],
        INV_SELECT_BIKE: [CallbackQueryHandler(finalize_assign, pattern=r"^inv_assign_bike_")],
    },
    fallbacks=[CommandHandler("cancel", cancel_assign)],
    allow_reentry=True
)
    application.add_handler(assign_asset_handler)
    application.add_handler(CallbackQueryHandler(list_bikes, pattern="^back_to_main_bike_list$"))
    edit_user_handler = ConversationHandler(
        entry_points=[CommandHandler("edit_user", edit_user)],
        states={
            EDIT_SELECT_USER: [
                # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï –ó–î–ï–°–¨: –®–∞–±–ª–æ–Ω —Å—Ç–∞–ª –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–º >>>
                # –¢–µ–ø–µ—Ä—å –æ–Ω —Ä–µ–∞–≥–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ 'edit_select_user_' –∏–ª–∏ 'edit_page_'
                CallbackQueryHandler(edit_user_handle_user_selection, pattern="^edit_(select_user_|page_)")
            ],
            EDIT_SELECT_FIELD: [CallbackQueryHandler(edit_user_handle_field_selection, pattern="^edit_")],
            EDIT_AWAIT_VALUE: [MessageHandler(filters.TEXT & ~filters.COMMAND, edit_user_handle_new_value)],
            EDIT_CONFIRM_DELETE: [
                CallbackQueryHandler(edit_user_delete_confirmed, pattern="^edit_confirm_delete_yes$"),
                CallbackQueryHandler(edit_user_back_to_profile, pattern="^edit_back_to_profile$")
            ]
        },
        fallbacks=[
            # –¢–µ–ø–µ—Ä—å —ç—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –±—É–¥–µ—Ç —Å—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –±–µ–∑ –ø—Ä–æ–±–ª–µ–º
            CallbackQueryHandler(edit_user_cancel, pattern="^edit_cancel$"),
            CommandHandler("cancel", edit_user_cancel)
        ],
        allow_reentry=True
    )
    application.add_handler(edit_user_handler)
    class IsAdminReplyingFilter(filters.UpdateFilter):
       def filter(self, update: Update) -> bool:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –≤–æ–æ–±—â–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if not (update.message and update.message.text):
            return False

        user_id = update.message.from_user.id
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–∏—à–µ—Ç –∞–¥–º–∏–Ω
        if not is_admin(user_id):
            return False

        # --- –ì–õ–ê–í–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï ---
        # –ü–æ–ª—É—á–∞–µ–º user_data –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç application
        # application.user_data - —ç—Ç–æ —Å–ª–æ–≤–∞—Ä—å, –≥–¥–µ –∫–ª—é—á–∏ - —ç—Ç–æ user_id
        if user_id in application.user_data:
            user_context_data = application.user_data[user_id]
            # –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–∞—à–µ–≥–æ —Ñ–ª–∞–≥–∞
            if 'awaiting_admin_input' in user_context_data:
                return True # –§–∏–ª—å—Ç—Ä —Å—Ä–∞–±–æ—Ç–∞–ª!

        return False # –ï—Å–ª–∏ —é–∑–µ—Ä–∞ –Ω–µ—Ç –≤ user_data –∏–ª–∏ –Ω–µ—Ç —Ñ–ª–∞–≥–∞
    is_admin_replying_filter = IsAdminReplyingFilter()
    stats_date_handler = ConversationHandler(
    entry_points=[CallbackQueryHandler(start_stats_date_selection, pattern="^stats_date_select$")],
    states={
        STATS_AWAIT_DATE: [
            CallbackQueryHandler(start_stats_date_selection, pattern="^stats_nav_"),
            CallbackQueryHandler(process_stats_date_selection, pattern="^stats_date_"),
        ],
    },
    fallbacks=[
        CallbackQueryHandler(lambda u, c: u.callback_query.edit_message_text("–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.") or ConversationHandler.END, pattern="^stats_cancel$"),
        CommandHandler("cancel", universal_cancel)
    ],
)
    application.add_handler(stats_date_handler)
    application.add_handler(MessageHandler(is_admin_replying_filter, admin_approve_deal))
    application.add_handler(MessageHandler(filters.Regex("^(üí∞–ê—Ä–µ–Ω–¥–∞/–í—ã–∫—É–ø|üí∞–ê—Ä–µ–Ω–¥–∞/–í—ã–∫—É–ø)$"), list_bikes))
    application.add_handler(CallbackQueryHandler(start_fine_payment_user, pattern=r"^pay_fine_"))
    client_approval_handler = ConversationHandler(
    entry_points=[CallbackQueryHandler(client_handle_signature, pattern=r"^(client_sign_|client_decline_)")],
    states={}, # –°–æ—Å—Ç–æ—è–Ω–∏—è –Ω–µ –Ω—É–∂–Ω—ã, –≤—Å–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –æ–¥–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
    fallbacks=[CommandHandler('cancel', cancel_deal)]
)
# 2. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏ (Kugoo, Wenbox, AKB) –∏
    application.add_handler(CallbackQueryHandler(auto_prolong_rental, pattern=r"^auto_prolong_7_"))
    application.add_handler(CommandHandler("otchet", start_new_report_generator))
    application.add_handler(CallbackQueryHandler(quick_rent_akb_payment, pattern=r"^quick_rent_akb_")) 
    application.add_handler(CallbackQueryHandler(list_bikes_by_model, pattern="^show_model_"))
    application.add_handler(CallbackQueryHandler(admin_approve_deal, pattern=r"^assign_"))
    application.add_handler(client_approval_handler)
# 3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    application.add_handler(CallbackQueryHandler(bike_info, pattern="^(info_|back_to_categories)"))
    application.add_handler(MessageHandler(filters.Regex("^üìã –¢–∞—Ä–∏—Ñ—ã$"), show_tariffs))
    application.add_handler(MessageHandler(filters.Regex("^üìú –ü—Ä–∞–≤–∏–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è$"), show_rules))
    application.add_handler(MessageHandler(filters.Regex("^üõ†Ô∏è –†–µ–º–æ–Ω—Ç$"), show_repair_info))
    application.add_handler(MessageHandler(filters.Regex("^üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç$"), show_profile)) # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è show_profile —É–∂–µ –µ—Å—Ç—å
    application.add_handler(MessageHandler(filters.Regex("^üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã$"), show_contacts))
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ü§ñ
    application.add_handler(CallbackQueryHandler(admin_accept_return, pattern=r"^return_accept_"))
    complete_repair_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(start_complete_repair, pattern=r"^complete_repair_")],
        states={
            AWAIT_REPAIR_PRICE: [MessageHandler(filters.TEXT & ~filters.COMMAND, process_repair_price)],
            AWAIT_DELAY_REASON: [MessageHandler(filters.TEXT & ~filters.COMMAND, finalize_completed_repair)],
        },
        fallbacks=[CommandHandler("cancel", cancel)], # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–º–µ–Ω—ã
    )
    application.add_handler(CallbackQueryHandler(mark_paid, pattern=r"^paid_"))
    application.add_handler(complete_repair_handler)
    application.add_handler(CallbackQueryHandler(view_single_repair_request, pattern=r"^view_repair_"))
    application.add_handler(CallbackQueryHandler(leave_bike, pattern="^leave_bike_"))
    application.add_handler(CallbackQueryHandler(confirm_return_item, pattern=r"^confirm_return_"))
    application.add_handler(CallbackQueryHandler(confirm_return_item, pattern=r"^cancel_return$"))
    add_product_handler = ConversationHandler(
    entry_points=[MessageHandler(filters.Regex("^‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥$"), start_add_product)],
    states={
        SELECT_PRODUCT_TYPE: [CallbackQueryHandler(select_product_type, pattern="^add_type_")],
        ENTER_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_product_name)],
        ENTER_DESCRIPTION: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_product_description)],
        
        # –í–µ—Ç–∫–∞ –í–µ–ª–æ—Å–∏–ø–µ–¥–∞
        ENTER_RENT_PRICES: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_rent_prices)],
        ENTER_BUYOUT_TOTAL_PAYMENTS: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_buyout_total_payments)],
        ENTER_BUYOUT_PAYMENT_AMOUNT: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_buyout_payment_amount)],
        ENTER_BUYOUT_PERIOD_DAYS: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_buyout_period)],

        # –í–µ—Ç–∫–∞ –ê–∫–∫—É–º—É–ª—è—Ç–æ—Ä–∞
        ENTER_BATTERY_DETAILS: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_battery_details)],
        
        # –û–±—â–∏–µ —à–∞–≥–∏
        ENTER_QUANTITY: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_product_quantity)],
        AWAIT_PHOTO: [MessageHandler(filters.PHOTO, finalize_product_add)],
    },
    fallbacks=[
        CommandHandler("cancel", cancel_add_product),
        CallbackQueryHandler(cancel_add_product, pattern="^add_type_cancel$")
    ],
)
    
    
    
    application.add_handler(add_product_handler)


    discount_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex("^üéÅ –í—ã–¥–∞—Ç—å —Å–∫–∏–¥–∫—É$"), start_discount_process)],
        states={
            SELECT_USER_FOR_DISCOUNT: [CallbackQueryHandler(handle_user_selection_for_discount, pattern="^discount_")],
            ENTER_DISCOUNT_PERCENT: [MessageHandler(filters.TEXT & ~filters.COMMAND, process_discount_percent)],
            ENTER_DISCOUNT_REASON: [MessageHandler(filters.TEXT & ~filters.COMMAND, process_discount_reason)],
            ENTER_DISCOUNT_DURATION: [MessageHandler(filters.TEXT & ~filters.COMMAND, process_discount_duration)],
        },
        fallbacks=[CommandHandler("cancel", cancel_discount_process)],
    )
    application.add_handler(discount_handler)
    
    user_custom_extension_handler = ConversationHandler(
    entry_points=[CallbackQueryHandler(start_user_custom_extension, pattern=r"^user_extend_custom_start_")],
    states={
        USER_AWAIT_CUSTOM_DAYS: [MessageHandler(filters.TEXT & ~filters.COMMAND, process_user_custom_extension)],
    },
    fallbacks=[CommandHandler("cancel", cancel)], # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è cancel
)
    application.add_handler(user_custom_extension_handler)
    complete_repair_conv_handler = ConversationHandler(
    entry_points=[CallbackQueryHandler(complete_repair, pattern=r"^complete_repair_\d+$")],
    states={
        CHOOSE_WARRANTY_TYPE: [
            CallbackQueryHandler(handle_warranty_choice, pattern=r"^warranty_(yes|no)_\d+$")
        ],
        ENTER_DELAY_REASON: [
            MessageHandler(filters.TEXT & ~filters.COMMAND, handle_delay_reason)
        ]
    },
    fallbacks=[CommandHandler("cancel", back_to_main_menu)],
    allow_reentry=True
)
    manual_extension_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(start_manual_extension, pattern=r"^manual_ext_start_")],
        states={
            AWAIT_MANUAL_DAYS: [MessageHandler(filters.TEXT & ~filters.COMMAND, process_manual_extension_days)],
        },
        fallbacks=[
            CallbackQueryHandler(cancel_manual_extension, pattern="^cancel_repair$"), # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∫–Ω–æ–ø–∫—É –æ—Ç–º–µ–Ω—ã
            CommandHandler("cancel", cancel_manual_extension)
        ],
    )
    application.add_handler(manual_extension_handler)
    application.add_handler(complete_repair_conv_handler)
    smska_handler = ConversationHandler(
        entry_points=[CommandHandler('smska', smska_command)],
        states={
            WAITING_FOR_ADMIN_MESSAGE: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, send_message_to_admins)
            ],
        },
        fallbacks=[CommandHandler('abort', abort_smska)],
    )
    application.add_handler(smska_handler)
    rental_repair_handler = ConversationHandler(
        entry_points=[
            CallbackQueryHandler(poisk_start, pattern="^poisk_start$"),
            CallbackQueryHandler(process_start_repair, pattern=r"^rental_repair_\d+$"),
            CallbackQueryHandler(view_user_rentals, pattern=r"^view_rentals_\d+$"),
            CallbackQueryHandler(accept_rental, pattern=r"^accept_bike_\d+$"),
            CallbackQueryHandler(process_accept_rental, pattern=r"^rental_accept_\d+$"),
            CallbackQueryHandler(extend_rental, pattern=r"^extend_rental_\d+$"),
            CallbackQueryHandler(handle_extension_choice, pattern=r"^extend_\d+_\d+$|^extend_custom_\d+$"),
            CallbackQueryHandler(handle_payment_confirmation, pattern=r"^payment_(yes|no)_\d+_\d+(_\d+)?$"),
            MessageHandler(filters.Regex("^–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é$"), electrobike_cancel_rental),
            CallbackQueryHandler(cancel_repair, pattern="^cancel_repair$")
        ],
        states={
            POISK_STATE: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, poisk_handle)
            ],
            RENTAL_REPAIR_REASON: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_repair_reason)
            ],
            RENTAL_REPAIR_PERSON: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_repair_person)
            ],
            RENTAL_REPAIR_WARRANTY: [
                CallbackQueryHandler(handle_warranty, pattern="^warranty_")
            ],
            RENTAL_REPAIR_WARRANTY_AMOUNT: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_warranty_amount)
            ],
            RENTAL_REPAIR_ESTIMATED_DATE: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_estimated_date)
            ],
            CUSTOM_EXTENSION: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, process_custom_extension)
            ]
        },
        # <<< –í–û–¢ –í–ê–ñ–ù–ê–Ø –ß–ê–°–¢–¨ >>>
        fallbacks=[
            CallbackQueryHandler(cancel_repair, pattern="^cancel_repair$"),
            # –≠—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –∏ –≤—ã—Ö–æ–¥–∏—Ç—å –∏–∑ –¥–∏–∞–ª–æ–≥–∞
            MessageHandler(filters.TEXT & ~filters.COMMAND, menu_handler)
        ]
    )
    application.add_handler(rental_repair_handler)

    rent_conversation_handler = ConversationHandler(
    entry_points=[
        MessageHandler(filters.Text("üö¥‚Äç –°–¥–∞—Ç—å –≤ –∞—Ä–µ–Ω–¥—É –≤–µ–ª–æ—Å–∏–ø–µ–¥"), electrobike_rent_start)
    ],
    states={
        ELECTROBIKE_SELECT_USER: [
            CallbackQueryHandler(electrobike_user_state_handler),
            # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ ---
            MessageHandler(filters.Regex(r"^üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é$"), electrobike_cancel_rental),
            MessageHandler(filters.TEXT & ~filters.COMMAND, electrobike_user_state_handler)
        ],
        ELECTROBIKE_SELECT_BIKE: [
            CallbackQueryHandler(electrobike_bike_state_handler),
            # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ ---
            MessageHandler(filters.Regex(r"^üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é$"), electrobike_cancel_rental),
            MessageHandler(filters.TEXT & ~filters.COMMAND, electrobike_bike_state_handler)
        ],
        ELECTROBIKE_SELECT_DAYS: [
            # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ ---
            MessageHandler(filters.Regex(r"^üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é$"), electrobike_cancel_rental),
            CallbackQueryHandler(electrobike_select_rental_days, pattern=r"^electrobike_rental_days_")
        ],
        ELECTROBIKE_YANDEX_PRO: [
            # --- –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–î–ï–°–¨ ---
            MessageHandler(filters.Regex(r"^üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é$"), electrobike_cancel_rental),
            CallbackQueryHandler(electrobike_yandex_pro_handler, pattern=r"^yandex_pro_")
        ]
    },
    fallbacks=[CommandHandler("cancel", lambda u, c: ConversationHandler.END)],
    map_to_parent={
        ConversationHandler.END: ConversationHandler.END
    }
)



    application.add_handler(MessageHandler(filters.Regex("^üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –¥–µ–Ω—å$"), show_daily_stats))
    rework_verification_handler = ConversationHandler(
    entry_points=[CallbackQueryHandler(start_rework_verification, pattern=r'^rework_')],
    states={
        AWAIT_REWORK_REASON: [MessageHandler(filters.TEXT & ~filters.COMMAND, send_rework_reason)],
    },
    fallbacks=[CommandHandler('cancel', cancel_admin_action)],
)

    reject_verification_handler = ConversationHandler(
    entry_points=[CallbackQueryHandler(start_reject_verification, pattern=r'^reject_verification_')],
    states={
        AWAIT_REJECT_REASON: [MessageHandler(filters.TEXT & ~filters.COMMAND, send_reject_reason)],
    },
    fallbacks=[CommandHandler('cancel', cancel_admin_action)],
)
    application.add_handler(rework_verification_handler)
    application.add_handler(reject_verification_handler)
    dispute_conversation = ConversationHandler(
    entry_points=[CallbackQueryHandler(start_dispute, pattern=r"^dispute_fine$")],
    states={
        SELECT_FINE: [CallbackQueryHandler(select_fine_for_dispute, pattern=r"^dispute_\d+$")],
        UPLOAD_MEDIA: [
            MessageHandler(
                filters.PHOTO | filters.VIDEO | filters.Document.IMAGE | filters.Document.VIDEO,
                handle_dispute_media
            ),
            MessageHandler(
                filters.ALL & ~(filters.PHOTO | filters.VIDEO | filters.Document.IMAGE | filters.Document.VIDEO | filters.COMMAND),
                lambda update, ctx: update.message.reply_text("‚ùå –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞")
            )
        ],
        ENTER_DISPUTE_COMMENT: [
            MessageHandler(filters.TEXT & ~filters.COMMAND, save_dispute_comment)
        ]
    },
    fallbacks=[
        CommandHandler("cancel", cancel_fine),
        MessageHandler(filters.Regex(r"^–û—Ç–º–µ–Ω–∞$"), cancel_fine)
    ],
    allow_reentry=True
)

    application.add_handler(CallbackQueryHandler(
    pay_fine_handler,
    pattern=r"^pay_fine_\d+$"
))

    application.add_handler(CallbackQueryHandler(
    fines_menu,
    pattern="^fines_menu$"
))
    date_edit_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(start_date_edit, pattern=r"^edit_date_")],
        states={
            AWAIT_NEW_DATE: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_new_date)],
        },
        fallbacks=[CommandHandler("cancel", universal_cancel)], # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é –æ—Ç–º–µ–Ω—É
    )
    application.add_handler(date_edit_handler)
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø—á–∞—Å—Ç–µ–π
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø—á–∞—Å—Ç–µ–π
    add_part_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex("^‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—á–∞—Å—Ç—å$"), add_part)],
        states={
            1: [MessageHandler(filters.TEXT & ~filters.COMMAND, set_part_name)],
            2: [MessageHandler(filters.TEXT & ~filters.COMMAND, set_part_description)],
            3: [MessageHandler(filters.TEXT & ~filters.COMMAND, set_part_quantity)],  # <- –ó–¥–µ—Å—å –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –Ω–æ–≤—ã–π –≤–≤–æ–¥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        4: [MessageHandler(filters.PHOTO, set_part_photo)],  # <- –ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ
    },
    fallbacks=[],
)

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—á–∞—Å—Ç–µ–π
    edit_part_conv = ConversationHandler(
    entry_points=[CallbackQueryHandler(start_editing_part, pattern=r"^edit_part_\d+$")],
    states={
        EDITING_MENU: [CallbackQueryHandler(handle_editing_menu)],
        CHANGE_STATUS: [CallbackQueryHandler(handle_status_change)],
        CHANGE_QUANTITY: [CallbackQueryHandler(handle_quantity_change)]
    },
    fallbacks=[],
    map_to_parent={ConversationHandler.END: ConversationHandler.END}
)
    
    edit_bike_tariffs_handler = ConversationHandler(
    entry_points=[MessageHandler(filters.Regex("^üõ†Ô∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–µ–ª–æ—Å–∏–ø–µ–¥—ã$"), show_bike_list_for_editing)],
    states={
        EDIT_USER_MENU: [
            CallbackQueryHandler(show_main_edit_menu, pattern="^edit_bike_"),
            CallbackQueryHandler(handle_bike_list_pagination, pattern="^edit_page_"),
            CallbackQueryHandler(request_new_value, pattern="^edit_field_(name|description)$"),
            CallbackQueryHandler(show_tariffs_menu, pattern="^edit_field_tariffs$"),
            CallbackQueryHandler(request_availability_change, pattern="^edit_field_availability$"),
            # Handler for the delete button
            CallbackQueryHandler(handle_delete_request, pattern="^edit_action_delete$"),
        ],
        EDIT_AWAIT_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_text_value)],
        EDIT_AWAIT_DESCRIPTION: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_text_value)],
        EDIT_TARIFFS_MENU: [
            CallbackQueryHandler(start_rent_edit, pattern="^tariffs_edit_rent$"),
            CallbackQueryHandler(start_buyout_edit, pattern="^tariffs_edit_buyout$"),
            CallbackQueryHandler(show_main_edit_menu, pattern="^tariffs_back_to_main$"),
        ],
        AWAIT_RENT_PRICES: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_rent_prices)],
        AWAIT_BUYOUT_PAYMENTS: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_buyout_payments)],
        AWAIT_BUYOUT_AMOUNT: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_buyout_amount)],
        AWAIT_BUYOUT_PERIOD: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_buyout_plan)],
        EDIT_AVAILABILITY: [
            CallbackQueryHandler(save_availability, pattern="^set_availability_"),
            CallbackQueryHandler(show_main_edit_menu, pattern="^back_to_edit_menu$")
        ],
        # New state and its handler for deletion confirmation
        EDIT_CONFIRM_DELETE_BIKE: [
            CallbackQueryHandler(delete_bike_confirmed, pattern="^confirm_delete_bike_")
        ]
    },
    fallbacks=[
        CallbackQueryHandler(cancel_edit_bike, pattern="^edit_cancel$"),
        CallbackQueryHandler(show_bike_list_for_editing, pattern="^edit_back_to_list$")
    ],
    allow_reentry=True
)
    application.add_handler(edit_bike_tariffs_handler)

    application.add_handler(CallbackQueryHandler(start_complete_repair_user, pattern=r"^pay_repair_"))
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤

    edit_bike_handler = ConversationHandler(
    entry_points=[
        CallbackQueryHandler(start_editing_bike, pattern=r"^edit_\d+$"),
        CallbackQueryHandler(navigate_edit_pages, pattern=r"^prev_edit_page$|^next_edit_page$|^start_search$|^reset_search$")
    ],
    states={
        EDIT_MENU: [
            # <<< –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω pattern –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è >>>
            CallbackQueryHandler(handle_edit_choice, pattern=r"^edit_(name|description|price|available|finish)$"),
            CallbackQueryHandler(handle_delete_request, pattern=r"^edit_delete$")
        ],
        EDIT_NAME: [
            MessageHandler(filters.TEXT & ~filters.COMMAND, save_name),
            CallbackQueryHandler(cancel_input, pattern="^cancel_input$")
        ],
        EDIT_DESCRIPTION: [
            MessageHandler(filters.TEXT & ~filters.COMMAND, save_description),
            CallbackQueryHandler(cancel_input, pattern="^cancel_input$")
        ],
        EDIT_PRICE: [
            MessageHandler(filters.TEXT & ~filters.COMMAND, save_price),
            CallbackQueryHandler(cancel_input, pattern="^cancel_input$")
        ],
        EDIT_AVAILABLE: [
            CallbackQueryHandler(set_availability, pattern=r"^set_available_[01]$"),
            CallbackQueryHandler(show_editing_menu, pattern="^back_to_menu$")
        ],
        EDIT_SEARCH: [
            MessageHandler(filters.TEXT & ~filters.COMMAND, handle_search_input)
        ]
    },
    fallbacks=[
        CommandHandler("cancel", cancel_edit),
        CallbackQueryHandler(cancel_edit, pattern="^edit_finish$"),
        CallbackQueryHandler(cancel_edit, pattern="^cancel_edit$")
    ],
    allow_reentry=True
)
    application.add_handler(CallbackQueryHandler(income_menu, pattern="^stats_rent_menu$"))
    application.add_handler(CallbackQueryHandler(income_menu, pattern="^stats_buyout_menu$"))
    application.add_handler(CallbackQueryHandler(statistics_menu, pattern="^stats_back_to_main$"))
    application.add_handler(CallbackQueryHandler(show_income_report, pattern="^stats_report_"))
    application.add_handler(CallbackQueryHandler(confirm_return_item, pattern=r"^confirm_return_"))
    application.add_handler(CommandHandler("otchet", generate_report_command))
    

    new_register_handler = ConversationHandler(
    entry_points=[MessageHandler(filters.Regex("^üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è$"), register)],
    states={
        REG_AWAIT_INPUT: [
            CallbackQueryHandler(handle_registration_input, pattern="^reg_input_"),
            MessageHandler(filters.TEXT | filters.CONTACT, handle_registration_input),
        ],
        REG_AWAIT_COUNTRY: [
            CallbackQueryHandler(handle_country_selection, pattern="^reg_country_"),
            CallbackQueryHandler(handle_foreigner_doc_action, pattern="^reg_action_"),
        ],
        # <-- –ù–û–í–´–ï –°–û–°–¢–û–Ø–ù–ò–Ø –ò –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò -->
        REG_AWAIT_LICENSE_CHOICE: [
            CallbackQueryHandler(handle_license_choice, pattern="^reg_license_")
        ],
        REG_AWAIT_LICENSE_PHOTO: [
            MessageHandler(filters.PHOTO, handle_license_photo)
        ],
        # <-- –ö–û–ù–ï–¶ –ù–û–í–´–• –ë–õ–û–ö–û–í -->
        REG_AWAIT_DOCS: [
            MessageHandler(filters.PHOTO, handle_document_photos)
        ],
        REG_AWAIT_VERIFICATION: [
            CallbackQueryHandler(handle_verification_result, pattern="^reg_verify_")
        ]
    },
    fallbacks=[
        CallbackQueryHandler(handle_registration_nav, pattern="^reg_nav_"),
        CommandHandler("cancel", cancel_registration),
    ],
    allow_reentry=True
)
    application.add_handler(new_register_handler)
    application.add_handler(CallbackQueryHandler(manage_bookings_panel, pattern="^refresh_bookings_panel$"))
    battery_rent_handler = ConversationHandler(
    entry_points=[CallbackQueryHandler(start_battery_rent, pattern=r"^rent_battery_")],
    states={
        BATTERY_RENT_CONFIRMATION: [CallbackQueryHandler(process_battery_rent_payment, pattern=r"^(confirm|cancel)_battery_rent$")],
    },
    fallbacks=[CommandHandler("cancel", cancel_add_product)], # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–º–µ–Ω—ã
)
    application.add_handler(battery_rent_handler)

    battery_buyout_handler = ConversationHandler(
    entry_points=[CallbackQueryHandler(start_battery_buyout, pattern=r"^buyout_battery_")],
    states={
        BATTERY_BUYOUT_SELECT_PLAN: [
            # –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏ –≤—ã–±–æ—Ä –ø–ª–∞–Ω–∞, –∏ –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
            CallbackQueryHandler(select_battery_buyout_plan, pattern=r"^select_bb_plan_"),
            # –≠—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –∫–Ω–æ–ø–∫—É "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å"
            CallbackQueryHandler(process_battery_buyout_payment, pattern=r"^confirm_battery_buyout$"),
            # –≠—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –∫–Ω–æ–ø–∫—É "–û—Ç–º–µ–Ω–∞"
            CallbackQueryHandler(cancel_add_product, pattern=r"^cancel_battery_buyout$")
        ],
        # –£–±—Ä–∞–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ BATTERY_BUYOUT_CONFIRMATION, –æ–Ω–æ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–æ
    },
    fallbacks=[CommandHandler("cancel", cancel_add_product)],
)
    application.add_handler(battery_buyout_handler)






    ask_support_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex("^üì© –ü–æ–¥–¥–µ—Ä–∂–∫–∞$"), ask_support)],
        states={
            1: [MessageHandler(filters.TEXT & ~filters.COMMAND, save_question)],
        },
        fallbacks=[],
    )

    answer_question_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(answer_question, pattern="^answer_")],
        states={
            1: [MessageHandler(filters.TEXT & ~filters.COMMAND, send_answer)],
        },
        fallbacks=[],
    )

    send_news_handler = ConversationHandler(
    entry_points=[MessageHandler(filters.Regex("^üì¢ –†–∞—Å—Å—ã–ª–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π$"), send_news)],
    states={
        1: [MessageHandler(filters.ALL, broadcast_news)],  # –ü—Ä–∏–Ω–∏–º–∞–µ–º –∏ —Ç–µ–∫—Å—Ç, –∏ —Ñ–æ—Ç–æ
    },
    fallbacks=[],
)

# –í —Ñ—É–Ω–∫—Ü–∏–∏ main()
    application.add_handler(CommandHandler("debug", debug_bikes))
    repair_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.Regex("^üõ†Ô∏è –ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç$"), request_repair)],
        states={
            WAITING_FOR_PROBLEM: [
                CallbackQueryHandler(handle_problem_selection, pattern="^repair_")
            ],
            WAITING_FOR_CUSTOM_PROBLEM: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, save_custom_problem)
            ],
        },
        fallbacks=[CommandHandler("cancel", cancel)], # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è cancel
    )

    repair_conv_handler = ConversationHandler(
    entry_points=[CallbackQueryHandler(accept_repair_request, pattern="^accept_repair_")],
    states={
        WAITING_FOR_TIME: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_time)],
        WAITING_FOR_PRICE: [MessageHandler(filters.TEXT & ~filters.COMMAND, get_price)],
    },
    fallbacks=[],
)

    get_photo_id_handler = ConversationHandler(
    entry_points=[CommandHandler('get_photo_id', get_photo_id_start)],
    states={
        AWAITING_PHOTO_FOR_ID: [MessageHandler(filters.PHOTO, receive_photo_for_id)],
    },
    fallbacks=[CommandHandler('cancel', cancel_get_id)],
)
    application.add_handler(get_photo_id_handler)

    date_selection_handler = ConversationHandler(
    entry_points=[CallbackQueryHandler(select_day, pattern=r"^select_day$")],
    states={
        SELECT_DATE: [
            MessageHandler(filters.TEXT & ~filters.COMMAND, handle_date_input),
        ],
        CHOOSE_HISTORY_TYPE: [
            CallbackQueryHandler(view_bike_history, pattern=r"^history_bike$"),
            CallbackQueryHandler(view_user_history, pattern=r"^history_user$"),
            CallbackQueryHandler(display_history, pattern=r"^history_pagination_.*"),
        ]
    },
    fallbacks=[
        CommandHandler("abort", abort_operation),
        CallbackQueryHandler(abort_operation, pattern=r"^abort$")
    ],
    allow_reentry=True
)
    poisk_handler = ConversationHandler(
    entry_points=[CallbackQueryHandler(poisk_start, pattern="^poisk_start$")],
    states={
        POISK_STATE: [MessageHandler(filters.TEXT & ~filters.COMMAND, poisk_handle)]
    },
    fallbacks=[]
)

# –î–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    application.add_handler(poisk_handler)

# –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–±—Ä–æ—Å–∞

    application.add_handler(CallbackQueryHandler(clear_date_filter, pattern=r"^clear_date$"))
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è



    fine_conversation_handler = ConversationHandler(
    entry_points=[MessageHandler(filters.Regex(r"^üí∞ –ù–∞–∑–Ω–∞—á–∏—Ç—å —à—Ç—Ä–∞—Ñ$"), assign_fine_start)],
    states={
        SELECT_USER: [CallbackQueryHandler(select_user_for_fine, pattern=r"^fine_(user|pagination)_\w+")],
        ENTER_AMOUNT: [MessageHandler(filters.TEXT & ~filters.COMMAND, process_fine_amount)],
        ENTER_REASON: [MessageHandler(filters.TEXT & ~filters.COMMAND, process_fine_reason)],
        ENTER_DUE_DATE: [MessageHandler(filters.TEXT & ~filters.COMMAND, process_due_date)]
    },
    fallbacks=[
        CommandHandler("cancel", cancel_fine),
        MessageHandler(filters.Regex(r"^–û—Ç–º–µ–Ω–∞$"), cancel_fine)
    ],
    allow_reentry=True
)

    rejecttt = ConversationHandler(
    entry_points=[
        CallbackQueryHandler(start_reject, pattern=r"^reject_\d+$")
    ],
    states={
        REJECT_REASON: [
            MessageHandler(filters.TEXT & ~filters.COMMAND, handle_reject_reason)
        ]
    },
    fallbacks=[
        CommandHandler("cancel", cancel),
        MessageHandler(filters.Regex(r"^–û—Ç–º–µ–Ω–∞$"), cancel)
    ],
    map_to_parent={ConversationHandler.END: ConversationHandler.END},
    allow_reentry=True
)

    view_fines_conversation = ConversationHandler(
    entry_points=[MessageHandler(filters.Regex(r"^üìã –°–ø–∏—Å–æ–∫ —à—Ç—Ä–∞—Ñ–æ–≤$"), view_fines_menu)],
    states={
        VIEW_FINES_CATEGORY: [CallbackQueryHandler(show_fines_category)],
        REJECT_REASON: [rejecttt]  # –¢–µ–ø–µ—Ä—å rejecttt —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω
    },
    fallbacks=[
        CommandHandler("cancel", cancel),
        MessageHandler(filters.Regex(r"^–û—Ç–º–µ–Ω–∞$"), cancel),
        CallbackQueryHandler(show_fines_category)
    ],
    allow_reentry=True
)

    application.add_handler(view_fines_conversation)
    search_handlers = [
    # –ü–æ–∏—Å–∫ –ø–æ —Ñ–∞–º–∏–ª–∏–∏
    ConversationHandler(
        entry_points=[CallbackQueryHandler(search_by_surname, pattern="^search_by_surname$")],
        states={
            INPUT_SURNAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, handle_surname_input)]
        },
        fallbacks=[CommandHandler("cancel", abort_operation)],
        map_to_parent={}
    ),

    # –ü–æ–∏—Å–∫ –ø–æ –≤–µ–ª–æ—Å–∏–ø–µ–¥—É
    ConversationHandler(
        entry_points=[CallbackQueryHandler(search_by_bike, pattern="^search_by_bike$")],
        states={
            INPUT_BIKE_NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, handle_bike_name_input)]
        },
        fallbacks=[CommandHandler("cancel", abort_operation)],
        map_to_parent={}
    ),

    ###################

    # –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º (–ù–û–í–û–ï)
    ConversationHandler(
        entry_points=[CallbackQueryHandler(search_by_keyword, pattern="^search_by_keyword$")],
        states={
            INPUT_KEYWORD: [MessageHandler(filters.TEXT & ~filters.COMMAND, handle_keyword_input)]
        },
        fallbacks=[CommandHandler("cancel", abort_operation)],
        map_to_parent={}
    ),


    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–µ—Ç–∞–ª–µ–π –¥–µ–π—Å—Ç–≤–∏—è (–ù–û–í–û–ï)
    CallbackQueryHandler(
        show_action_details,
        pattern=r"^action_detail_\d+$"
    )
]

    ###############
    buyout_handler = ConversationHandler(
    entry_points=[CallbackQueryHandler(start_buyout, pattern=r"^buyout_\d+$")],
    states={
        SELECT_BUYOUT_PLAN: [CallbackQueryHandler(select_buyout_plan, pattern=r"^select_buyout_")],
        CONFIRM_BUYOUT: [
            # –í–´–ó–´–í–ê–ï–ú –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ –î–õ–Ø –°–û–ó–î–ê–ù–ò–Ø –ó–ê–Ø–í–ö–ò
            CallbackQueryHandler(confirm_buyout_request, pattern=r"^confirm_buyout_payment$"),
            CallbackQueryHandler(start_buyout, pattern=r"^buyout_\d+$") # –ö–Ω–æ–ø–∫–∞ "–Ω–∞–∑–∞–¥"
        ]
    },
    fallbacks=[CommandHandler("cancel", cancel)], # –î–æ–±–∞–≤—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é cancel, –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç
)
    application.add_handler(buyout_handler)
    application.add_handler(CommandHandler('test_notification', send_test_notification))
    application.add_handler(CallbackQueryHandler(accept_rental, pattern=r"^accept_rental_"))
    application.add_handler(CallbackQueryHandler(
    process_accept_rental,
    pattern=r"^rental_accept_"
))
    application.add_handler(CallbackQueryHandler(
    process_start_repair,
    pattern=r"^rental_repair_"
))

    application.add_handler(CallbackQueryHandler(
    display_history,
    pattern=r"^history_pagination_(bike|user)_\d+_\d+$"
))
    application.add_handler(CallbackQueryHandler(
    navigate_edit_pages,
    pattern=r"^(prev|next)_edit_page$"
))

    application.add_handler(CallbackQueryHandler(
        view_history_menu,
        pattern="^view_history$"
    ))

    application.add_handlers(search_handlers)

    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–ò—Å—Ç–æ—Ä–∏—è –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞" –∏ "–ò—Å—Ç–æ—Ä–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
    application.add_handler(CallbackQueryHandler(show_action_details, pattern="^action_detail_"))
    application.add_handler(CallbackQueryHandler(
    handle_search_pagination,
    pattern=r"^search_(\w+)_page_(\d+)$"
))

    repar_conv_handler = ConversationHandler(
    entry_points=[
        MessageHandler(filters.Text(["‚ö†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º"]), show_bike_list)
    ],
    states={
        SELECTING_BIKE: [
            CallbackQueryHandler(bike_selected, pattern=r"^select_bike_"),
            CallbackQueryHandler(handle_repair_pagination, pattern=r"^remont_pagi_"),
            CallbackQueryHandler(start_repair_search, pattern="^repair_search$"),
            CallbackQueryHandler(cancel_repair, pattern="^cancel_repair$")
        ],
        SELECTING_ACTION: [
            CallbackQueryHandler(action_selected, pattern="^set_"),
            CallbackQueryHandler(cancel_repair, pattern="^cancel_repair$")
        ],
        ENTERING_REPAIR_PERSON: [
            MessageHandler(filters.TEXT & ~filters.COMMAND, enter_repair_person)
        ],
        ENTERING_REASON: [
            MessageHandler(filters.TEXT & ~filters.COMMAND, enter_reason)
        ],
        ENTERING_WARRANTY: [
            CallbackQueryHandler(enter_warranty, pattern="^warranty_")
        ],
        ENTERING_WARRANTY_AMOUNT: [
            MessageHandler(filters.TEXT & ~filters.COMMAND, enter_warranty_amount)
        ],
        ENTERING_ESTIMATED_DATE: [
            MessageHandler(filters.TEXT & ~filters.COMMAND, enter_estimated_date)
        ],
        ENTERING_DELAY_REASON: [
            MessageHandler(filters.TEXT & ~filters.COMMAND, enter_delay_reason)
        ],
        SEARCHING: [
            MessageHandler(filters.TEXT & ~filters.COMMAND, handle_repair_search)
        ]
    },
    fallbacks=[
        CommandHandler("cancel", cancel_repair),
        MessageHandler(filters.Text(["üè† –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"]), cancel_repair)
    ]
)
        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–æ–≤–æ–≥–æ –º–µ–Ω—é –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    user_search_handler = ConversationHandler(
        entry_points=[
            # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ - –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"
            MessageHandler(filters.Regex("^üë• –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏$"), search_users)
        ],
        states={
            # –í —ç—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –±–æ—Ç –æ–∂–∏–¥–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –ª—é–±—É—é –∏–∑ –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é
            USER_SEARCH_MENU: [
                CallbackQueryHandler(handle_user_search_menu, pattern="^user_")
            ],
            # –í —ç—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—Ç –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç, –∫–æ–≥–¥–∞ –æ–∂–∏–¥–∞–µ—Ç –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
            AWAITING_SEARCH_INPUT: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_user_search_input)
            ]
        },
        fallbacks=[
            # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–º–µ–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–∏
            CommandHandler("cancel", cancel)
        ],
        # –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤—Ö–æ–¥–∏—Ç—å –≤ —ç—Ç–æ—Ç –¥–∏–∞–ª–æ–≥
        allow_reentry=True
    )
    application.add_handler(user_search_handler)
    booking_handler = ConversationHandler(
    entry_points=[CallbackQueryHandler(book_bike, pattern="^book_")],
    states={
        # –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤—ã–±–æ—Ä–∞ –î–ê–¢–´
        SELECTING_DATE: [
            CallbackQueryHandler(calendar_callback, pattern="^select_date_")
        ],
        # –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤—ã–±–æ—Ä–∞ –í–†–ï–ú–ï–ù–ò
        SELECTING_TIME: [
            CallbackQueryHandler(time_callback, pattern="^select_time_")
        ],
        # –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø
        CONFIRMING_BOOKING: [
            CallbackQueryHandler(finalize_booking, pattern="^(accept|reject)_booking$")
        ],
    },
    # <<< –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>
    fallbacks=[
        # –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—ã–π—Ç–∏ –∏–∑ –¥–∏–∞–ª–æ–≥–∞ –ø–æ –∫–æ–º–∞–Ω–¥–µ /cancel
        CommandHandler("cancel", cancel),
        # –ì–õ–ê–í–ù–û–ï: –≠—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ "–ª–æ–≤–∏—Ç" –ª—é–±–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ,
        # –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ–º–∞–Ω–¥–æ–π, –∏ –≤—ã–∑—ã–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –º–µ–Ω—é,
        # —Ç–µ–º —Å–∞–º—ã–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤—ã—Ö–æ–¥—è –∏–∑ –¥–∏–∞–ª–æ–≥–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
        MessageHandler(filters.TEXT & ~filters.COMMAND, menu_handler)
    ],
    # –ü–æ–∑–≤–æ–ª—è–µ—Ç –±–æ—Ç—É –∑–∞–Ω–æ–≤–æ –≤–æ–π—Ç–∏ –≤ —ç—Ç–æ—Ç –¥–∏–∞–ª–æ–≥, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –±—ã–ª –ø—Ä–µ—Ä–≤–∞–Ω.
    allow_reentry=True
    # <<< –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–ô >>>
)
    application.add_handler(CallbackQueryHandler(pay_next_installment, pattern=r"^pay_next_\d+$"))
    application.add_handler(CallbackQueryHandler(pay_full_amount, pattern=r"^pay_full_\d+$"))
    application.add_handler(repar_conv_handler)
    application.add_handler(CallbackQueryHandler(view_completed_repairs, pattern="^paginate_completed_"))
    application.add_handler(CallbackQueryHandler(view_accepted_repairs, pattern="^paginate_accepted_"))
    application.add_handler(CallbackQueryHandler(view_repair_requests, pattern="^paginate_requests_"))
    application.add_handler(CallbackQueryHandler(handle_noti_button, pattern="^noti_"))
    application.add_handler(CallbackQueryHandler(view_attendance_history, pattern='^attendance_page:'))
    application.add_handler(CallbackQueryHandler(shtrafpagi, pattern="^(page:|close_pagination)"))

    application.add_handler(CallbackQueryHandler(back_to_results, pattern="^back_to_results$"))
    application.add_handler(CallbackQueryHandler(close_details, pattern="^close_details$"))
    application.add_handler(CallbackQueryHandler(close_details, pattern="^close_search$"))
    application.add_handler(CallbackQueryHandler(show_action_details, pattern="^full_history_page_"))
    application.add_handler(rent_conversation_handler)
    application.add_handler(CallbackQueryHandler(view_bike_history, pattern="^history_bike$"))
    application.add_handler(CallbackQueryHandler(view_user_history, pattern="^history_user$"))
    application.add_handler(CommandHandler("rentals", manage_rentals))
    application.add_handler(CallbackQueryHandler(view_user_rentals, pattern="^view_rentals_"))
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    application.add_handler(CallbackQueryHandler(show_bike_page, pattern=r"^bike_page_\d+$"))
    application.add_handler(CallbackQueryHandler(show_user_page, pattern=r"^user_page_\d+$"))
    application.add_handler(CallbackQueryHandler(view_history_menu, pattern="^history_"))
    application.add_handler(CallbackQueryHandler(handle_pagination, pattern="^list_"))
    application.add_handler(CommandHandler("snake", start_snake))
    application.add_handler(CallbackQueryHandler(handle_controls, pattern="^snake_"))
    application.add_handler(CommandHandler("test_overdue", test_overdue_rental))

    application.add_handler(repair_conv_handler)
    application.add_handler(date_selection_handler)
    application.add_handler(dispute_conversation)
    application.add_handler(fine_conversation_handler)
    application.add_handler(view_fines_conversation)
    application.add_handler(booking_handler)
    application.add_handler(repair_handler)
    application.add_handler(add_part_handler)
    application.add_handler(edit_bike_handler)
    application.add_handler(edit_part_conv)
    application.add_handler(rejecttt)
    application.add_handler(ask_support_handler)
    application.add_handler(answer_question_handler)
    application.add_handler(send_news_handler)
    application.add_handler(CommandHandler("start", start))
    # ============================================================
# 3. Command Handlers
# ============================================================
    application.add_handler(CallbackQueryHandler(confirm_agreement, pattern="^confirm_agreement$"))
    application.add_handler(CommandHandler("view_questions", view_questions))
    from bot_act_handler import get_act_handler
    application.add_handler(get_act_handler())

    application.add_handler(CommandHandler("notifications", show_notifications))
    application.add_handler(CommandHandler("mark_attendance", mark_attendance))
    application.add_handler(CommandHandler("history", view_history_menu))
    application.add_handler(CommandHandler("finish_attendance", finish_attendance))
    application.add_handler(CommandHandler("status", status))
    application.add_handler(CommandHandler("view_repair_requests", view_repair_requests))
    application.add_handler(CommandHandler("cancel_booking", cancel_booking_command))
    application.add_handler(CommandHandler("test_reminder", test_reminder))
    application.add_handler(CommandHandler("search", search_users))
    application.add_handler(CallbackQueryHandler(confirm_user_verification, pattern="^verify_"))
    application.add_handler(CallbackQueryHandler(part_info, pattern="^part_info_"))
    application.add_handler(CallbackQueryHandler(verify_user, pattern="^verify_"))
    application.add_handler(CallbackQueryHandler(confirm_booking_admin, pattern="^confirm_"))
    application.add_handler(CallbackQueryHandler(cancel_booking_admin, pattern="^cancel_"))
    application.add_handler(CallbackQueryHandler(bike_info, pattern="^info_"))
    application.add_handler(CallbackQueryHandler(calendar_callback, pattern="^select_date_"))
    application.add_handler(CallbackQueryHandler(calendar_callback, pattern="^prev_month_"))
    application.add_handler(CallbackQueryHandler(calendar_callback, pattern="^next_month_"))
    application.add_handler(CallbackQueryHandler(accept_rental, pattern="^accept_bike_"))
    application.add_handler(CallbackQueryHandler(return_bike, pattern=r"^return_bike_start$"))
    application.add_handler(CallbackQueryHandler(view_bike_history, pattern="^history_bike$"))
    application.add_handler(CallbackQueryHandler(view_user_history, pattern="^history_user$"))
    application.add_handler(CallbackQueryHandler(display_history, pattern="^(bike_history_|user_history_)"))
    application.add_handler(CallbackQueryHandler(request_attendance, pattern="^request_attendance$"))
    application.add_handler(CallbackQueryHandler(arenda, pattern=r"^arenda_\d+$"))
    application.add_handler(CallbackQueryHandler(select_day, pattern="^select_day$"))
    application.add_handler(CallbackQueryHandler(select_rental_period, pattern=r"^prolong_\d+_\d+$"))
    application.add_handler(CallbackQueryHandler(handle_extension_choice, pattern=r"extend_\d+_\d+"))
    application.add_handler(CallbackQueryHandler(accept_extension, pattern=r"accept_extension_[0-9]+_[0-9]+"))
    application.add_handler(CallbackQueryHandler(handle_join_queue, pattern="^join_queue$"))
    application.add_handler(CallbackQueryHandler(handle_view_queue, pattern="^view_queue$"))
    application.add_handler(CallbackQueryHandler(
    handle_admin_view_queue,
    pattern=r"^wowwow_page_\d+$"  # –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
))


# –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –ø—Ä–µ—Ñ–∏–∫—Å–æ–º wowwow_
    application.add_handler(CallbackQueryHandler(
    handle_admin_remove_user,
    pattern=r"^wowwow_remove_\d+_\d+$"  # wowwow_remove_123_2
))
    application.add_handler(CallbackQueryHandler(leave_bike, pattern="^leave_bike_"))
    application.add_handler(CommandHandler("otchet", generate_report_command))

    application.add_handler(CallbackQueryHandler(handle_prolong_rental, pattern="^prolong_rental_"))
    application.add_handler(CallbackQueryHandler(view_accepted_repairs, pattern="^view_accepted_repairs$"))
    application.add_handler(CallbackQueryHandler(view_completed_repairs, pattern="^view_completed_repairs$"))
    application.add_handler(CallbackQueryHandler(complete_repair, pattern="^complete_repair_"))
    application.add_handler(CallbackQueryHandler(delete_repair_request, pattern="^otmena_repair_"))
    application.add_handler(CallbackQueryHandler(delete_booking, pattern="^delete_"))
    application.add_handler(CallbackQueryHandler(cancel_booking, pattern="^cancel_booking_"))
    application.add_handler(CallbackQueryHandler(handle_accept, pattern='^accept_'))
    application.add_handler(CallbackQueryHandler(extend_rental, pattern=r"extend_rental_*"))

    # ============================================================
    # 5. Message Handlers (—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã)
    # ============================================================
    application.add_handler(CallbackQueryHandler(mock_payment_handler, pattern="^mock_payment_"))
    application.add_handler(MessageHandler(filters.LOCATION, receive_location))
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –∫–æ–º–∞–Ω–¥–∞–º–∏
    application.add_handler(
        MessageHandler(
            filters.TEXT & ~filters.COMMAND & filters.UpdateFilter(is_reject_reason_active),
            handle_reject_reason
        )
    )

    # –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–µ–Ω—é
    application.add_handler(
        MessageHandler(filters.TEXT & ~filters.COMMAND, menu_handler)
    )
    application.add_handler(MessageHandler(filters.Regex("^üõ†Ô∏è –ó–∞—è–≤–∫–∏ –≤ —Ä–∞–±–æ—Ç–µ"), view_accepted_repairs))
    application.add_handler(MessageHandler(filters.Regex("^üí≥ –û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã"), view_completed_repairs))
    application.add_handler(MessageHandler(filters.Text(["üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"]), back_to_main_menu))
    from datetime import datetime, time, timezone, timedelta
    import pytz
    from datetime import datetime, time



    moscow_tz = pytz.timezone('Europe/Moscow')
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ - 20:00
    target_time = time(20, 0, 0, tzinfo=moscow_tz)

    application.job_queue.run_daily(
        callback=check_payment_reminders, # <-- –ù–∞—à–∞ –Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è
        time=target_time,
        name="daily_payment_reminders_job" # –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è –¥–ª—è –∑–∞–¥–∞—á–∏
    )
    
    logging.info(f"–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ 'check_payment_reminders' –Ω–∞ {target_time.strftime('%H:%M:%S')} –ø–æ –ú–°–ö.")
    # –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥–∞
    perm_tz = pytz.timezone('Asia/Yekaterinburg')
    morning_time = perm_tz.localize(datetime.combine(datetime.today(), time(10, 0))).time()
    application.job_queue.run_daily(
    callback=morning_reminder,
    time=morning_time,
    name="daily_morning_check"
    )

    evening_time = perm_tz.localize(datetime.combine(datetime.today(), time(18, 0))).time()
    application.job_queue.run_daily(
    callback=evening_reminder,
    time=evening_time,
    name="daily_evening_check"
    )

    import pytz
    perm_tz = pytz.timezone('Asia/Yekaterinburg')
    target_time = perm_tz.localize(datetime.combine(datetime.today(), time(22, 0))).time()


    application.job_queue.run_daily(
        callback=check_rental_reminders,
        time=target_time,
        name="daily_rental_check"
    )
    # ============================================================
    # 6. –û–±—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏)
    # ===========================================================
    application.run_polling()
if __name__ == "__main__":
    main()
